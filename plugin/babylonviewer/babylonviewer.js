var S9=Object.defineProperty;var S=(s,e)=>()=>(s&&(e=s(s=0)),e);var V=(s,e)=>{for(var t in e)S9(s,t,{get:e[t],enumerable:!0})};function x(s,e,t,i){var r=arguments.length,n=r<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(s,e,t,i);else for(var o=s.length-1;o>=0;o--)(a=s[o])&&(n=(r<3?a(n):r>3?a(e,t,n):a(e,t))||n);return r>3&&n&&Object.defineProperty(e,t,n),n}var Ye=S(()=>{});function ED(s){let e=s.getClassName();return ip[e]||(ip[e]={}),ip[e]}function rp(s){let e=s.getClassName();if(tp[e])return tp[e];tp[e]={};let t=tp[e],i=s,r=e;for(;r;){let n=ip[r];for(let l in n)t[l]=n[l];let a,o=!1;do{if(a=Object.getPrototypeOf(i),!a.getClassName){o=!0;break}if(a.getClassName()!==r)break;i=a}while(a);if(o)break;r=a.getClassName(),i=a}return t}var tp,ip,AA=S(()=>{tp={},ip={}});function xs(s,e){return(t,i)=>{let r=ED(t);r[i]||(r[i]={type:s,sourceName:e})}}function E9(s,e=null){return(t,i)=>{let r=e||"_"+i;Object.defineProperty(t,i,{get:function(){return this[r]},set:function(n){typeof this[r]?.equals=="function"&&this[r].equals(n)||this[r]!==n&&(this[r]=n,t[s].apply(this))},enumerable:!0,configurable:!0})}}function z(s,e=null){return E9(s,e)}function y(s){return xs(0,s)}function He(s){return xs(1,s)}function zt(s){return xs(2,s)}function gc(s){return xs(3,s)}function vc(s){return xs(4,s)}function oi(s){return xs(5,s)}function sp(s){return xs(6,s)}function TD(s){return xs(7,s)}function np(s){return xs(8,s)}function ap(s){return xs(9,s)}function xD(s){return xs(10,s)}function RA(s){return xs(12,s)}function Ts(s,e,t,i){let r=t.value;t.value=(...n)=>{let a=r;if(typeof _native<"u"&&_native[e]){let o=_native[e];i?a=(...l)=>i(...l)?o(...l):r(...l):a=o}return s[e]=a,a(...n)}}var je=S(()=>{AA();Ts.filter=function(s){return(e,t,i)=>Ts(e,t,i,s)}});var T9,bA,CA,N,we=S(()=>{T9=typeof WeakRef<"u",bA=class{constructor(e,t=!1,i,r){this.initialize(e,t,i,r)}initialize(e,t=!1,i,r){return this.mask=e,this.skipNextObservers=t,this.target=i,this.currentTarget=r,this}},CA=class{constructor(e,t,i=null){this.callback=e,this.mask=t,this.scope=i,this._willBeUnregistered=!1,this.unregisterOnNextCall=!1,this._remove=null}remove(e=!1){this._remove&&this._remove(e)}},N=class s{static FromPromise(e,t){let i=new s;return e.then(r=>{i.notifyObservers(r)}).catch(r=>{if(t)t.notifyObservers(r);else throw r}),i}get observers(){return this._observers}constructor(e,t=!1){this.notifyIfTriggered=t,this._observers=new Array,this._numObserversMarkedAsDeleted=0,this._hasNotified=!1,this._eventState=new bA(0),e&&(this._onObserverAdded=e)}add(e,t=-1,i=!1,r=null,n=!1){if(!e)return null;let a=new CA(e,t,r);a.unregisterOnNextCall=n,i?this._observers.unshift(a):this._observers.push(a),this._onObserverAdded&&this._onObserverAdded(a),this._hasNotified&&this.notifyIfTriggered&&this._lastNotifiedValue!==void 0&&this.notifyObserver(a,this._lastNotifiedValue);let o=T9?new WeakRef(this):{deref:()=>this};return a._remove=(l=!1)=>{let c=o.deref();c&&(l?c.remove(a):c._remove(a))},a}addOnce(e){return this.add(e,void 0,void 0,void 0,!0)}remove(e){return e?(e._remove=null,this._observers.indexOf(e)!==-1?(this._deferUnregister(e),!0):!1):!1}removeCallback(e,t){for(let i=0;i<this._observers.length;i++){let r=this._observers[i];if(!r._willBeUnregistered&&r.callback===e&&(!t||t===r.scope))return this._deferUnregister(r),!0}return!1}_deferUnregister(e){e._willBeUnregistered||(this._numObserversMarkedAsDeleted++,e.unregisterOnNextCall=!1,e._willBeUnregistered=!0,setTimeout(()=>{this._remove(e)},0))}_remove(e,t=!0){if(!e)return!1;let i=this._observers.indexOf(e);return i!==-1?(t&&this._numObserversMarkedAsDeleted--,this._observers.splice(i,1),!0):!1}makeObserverTopPriority(e){this._remove(e,!1),this._observers.unshift(e)}makeObserverBottomPriority(e){this._remove(e,!1),this._observers.push(e)}notifyObservers(e,t=-1,i,r,n){if(this.notifyIfTriggered&&(this._hasNotified=!0,this._lastNotifiedValue=e),!this._observers.length)return!0;let a=this._eventState;a.mask=t,a.target=i,a.currentTarget=r,a.skipNextObservers=!1,a.lastReturnValue=e,a.userInfo=n;for(let o of this._observers)if(!o._willBeUnregistered&&(o.mask&t&&(o.unregisterOnNextCall&&this._deferUnregister(o),o.scope?a.lastReturnValue=o.callback.apply(o.scope,[e,a]):a.lastReturnValue=o.callback(e,a)),a.skipNextObservers))return!1;return!0}notifyObserver(e,t,i=-1){if(this.notifyIfTriggered&&(this._hasNotified=!0,this._lastNotifiedValue=t),e._willBeUnregistered)return;let r=this._eventState;r.mask=i,r.skipNextObservers=!1,e.unregisterOnNextCall&&this._deferUnregister(e),e.callback(t,r)}hasObservers(){return this._observers.length-this._numObserversMarkedAsDeleted>0}clear(){for(;this._observers.length;){let e=this._observers.pop();e&&(e._remove=null)}this._onObserverAdded=null,this._numObserversMarkedAsDeleted=0,this.cleanLastNotifiedState()}cleanLastNotifiedState(){this._hasNotified=!1,this._lastNotifiedValue=void 0}clone(){let e=new s;return e._observers=this._observers.slice(0),e}hasSpecificMask(e=-1){for(let t of this._observers)if(t.mask&e||t.mask===e)return!0;return!1}}});var Sc,Ec,nne,We,xr=S(()=>{Sc=.45454545454545453,Ec=2.2,nne=(1+Math.sqrt(5))/2,We=.001});function Gi(s,e){let t=[];for(let i=0;i<s;++i)t.push(e());return t}function Ws(s,e){return Gi(s,e)}function x9(s,e,t){let i=s[e];if(typeof i!="function")return null;let r=function(){let n=s.length,a=r.previous.apply(s,arguments);return t(e,n),a};return i.next=r,r.previous=i,s[e]=r,()=>{let n=r.previous;if(!n)return;let a=r.next;a?(n.next=a,a.previous=n):(n.next=void 0,s[e]=n),r.next=void 0,r.previous=void 0}}function op(s,e){let t=A9.map(i=>x9(s,i,e));return()=>{for(let i of t)i?.()}}var A9,Hs=S(()=>{A9=["push","splice","pop","shift","unshift"]});function G(s,e){AD[s]=e}function Ci(s){return AD[s]}var AD,Te=S(()=>{AD={}});var Ar,IA=S(()=>{Ar=class s{static SetMatrixPrecision(e){if(s.MatrixTrackPrecisionChange=!1,e&&!s.MatrixUse64Bits&&s.MatrixTrackedMatrices)for(let t=0;t<s.MatrixTrackedMatrices.length;++t){let i=s.MatrixTrackedMatrices[t],r=i._m;i._m=new Array(16);for(let n=0;n<16;++n)i._m[n]=r[n]}s.MatrixUse64Bits=e,s.MatrixCurrentType=s.MatrixUse64Bits?Array:Float32Array,s.MatrixTrackedMatrices=null}};Ar.MatrixUse64Bits=!1;Ar.MatrixTrackPrecisionChange=!0;Ar.MatrixCurrentType=Float32Array;Ar.MatrixTrackedMatrices=[]});var Z,gt=S(()=>{we();Z=class{static get LastCreatedEngine(){return this.Instances.length===0?null:this.Instances[this.Instances.length-1]}static get LastCreatedScene(){return this._LastCreatedScene}};Z.Instances=[];Z.OnEnginesDisposedObservable=new N;Z._LastCreatedScene=null;Z.UseFallbackTexture=!0;Z.FallbackTexture=""});var PA={};V(PA,{Clamp:()=>Fe,DeltaAngle:()=>RD,Denormalize:()=>P9,ExtractAsInt:()=>R9,Hermite:()=>yA,Hermite1stDerivative:()=>y9,HighestCommonFactor:()=>cp,ILog2:()=>bs,InverseLerp:()=>I9,Lerp:()=>As,LerpAngle:()=>C9,MoveTowards:()=>bD,MoveTowardsAngle:()=>L9,Normalize:()=>M9,NormalizeRadians:()=>MA,OutsideRange:()=>b9,PercentToRange:()=>F9,PingPong:()=>D9,RandomRange:()=>bt,RangeToPercent:()=>w9,Repeat:()=>lp,SmoothStep:()=>O9,ToHex:()=>Rs,WithinEpsilon:()=>Rt});function R9(s){return parseInt(s.toString().replace(/\W/g,""))}function Rt(s,e,t=1401298e-51){return Math.abs(s-e)<=t}function b9(s,e,t,i=1401298e-51){return s<e-i||s>t+i}function bt(s,e){return s===e?s:Math.random()*(e-s)+s}function As(s,e,t){return s+(e-s)*t}function C9(s,e,t){let i=lp(e-s,360);return i>180&&(i-=360),s+i*Fe(t)}function I9(s,e,t){let i=0;return s!=e?i=Fe((t-s)/(e-s)):i=0,i}function yA(s,e,t,i,r){let n=r*r,a=r*n,o=2*a-3*n+1,l=-2*a+3*n,c=a-2*n+r,f=a-n;return s*o+t*l+e*c+i*f}function y9(s,e,t,i,r){let n=r*r;return(n-r)*6*s+(3*n-4*r+1)*e+(-n+r)*6*t+(3*n-2*r)*i}function Fe(s,e=0,t=1){return Math.min(t,Math.max(e,s))}function MA(s){return s-=Math.PI*2*Math.floor((s+Math.PI)/(Math.PI*2)),s}function Rs(s){let e=s.toString(16);return s<=15?("0"+e).toUpperCase():e.toUpperCase()}function bs(s){if(Math.log2)return Math.floor(Math.log2(s));if(s<0)return NaN;if(s===0)return-1/0;let e=0;if(s<1){for(;s<1;)e++,s=s*2;e=-e}else if(s>1)for(;s>1;)e++,s=Math.floor(s/2);return e}function lp(s,e){return s-Math.floor(s/e)*e}function M9(s,e,t){return(s-e)/(t-e)}function P9(s,e,t){return s*(t-e)+e}function RD(s,e){let t=lp(e-s,360);return t>180&&(t-=360),t}function D9(s,e){let t=lp(s,e*2);return e-Math.abs(t-e)}function O9(s,e,t){let i=Fe(t);return i=-2*i*i*i+3*i*i,e*i+s*(1-i)}function bD(s,e,t){let i=0;return Math.abs(e-s)<=t?i=e:i=s+Math.sign(e-s)*t,i}function L9(s,e,t){let i=RD(s,e),r=0;return-t<i&&i<t?r=e:(e=s+i,r=bD(s,e,t)),r}function w9(s,e,t){return(s-e)/(t-e)}function F9(s,e,t){return(t-e)*s+e}function cp(s,e){let t=s%e;return t===0?e:cp(e,t)}var di=S(()=>{});function CD(s,e,t,i=0){let r=s.asArray(),n=e.asArray(),a=r[0],o=r[1],l=r[2],c=r[3],f=r[4],h=r[5],u=r[6],d=r[7],p=r[8],m=r[9],_=r[10],v=r[11],T=r[12],C=r[13],I=r[14],R=r[15],b=n[0],M=n[1],F=n[2],U=n[3],D=n[4],$=n[5],oe=n[6],re=n[7],se=n[8],be=n[9],Me=n[10],ke=n[11],de=n[12],Qe=n[13],Re=n[14],Ae=n[15];t[i]=a*b+o*D+l*se+c*de,t[i+1]=a*M+o*$+l*be+c*Qe,t[i+2]=a*F+o*oe+l*Me+c*Re,t[i+3]=a*U+o*re+l*ke+c*Ae,t[i+4]=f*b+h*D+u*se+d*de,t[i+5]=f*M+h*$+u*be+d*Qe,t[i+6]=f*F+h*oe+u*Me+d*Re,t[i+7]=f*U+h*re+u*ke+d*Ae,t[i+8]=p*b+m*D+_*se+v*de,t[i+9]=p*M+m*$+_*be+v*Qe,t[i+10]=p*F+m*oe+_*Me+v*Re,t[i+11]=p*U+m*re+_*ke+v*Ae,t[i+12]=T*b+C*D+I*se+R*de,t[i+13]=T*M+C*$+I*be+R*Qe,t[i+14]=T*F+C*oe+I*Me+R*Re,t[i+15]=T*U+C*re+I*ke+R*Ae}function ID(s,e,t=0){let i=s.asArray();e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e[t+9]=i[9],e[t+10]=i[10],e[t+11]=i[11],e[t+12]=i[12],e[t+13]=i[13],e[t+14]=i[14],e[t+15]=i[15]}function yD(s,e){let t=s.asArray(),i=t[0],r=t[1],n=t[2],a=t[3],o=t[4],l=t[5],c=t[6],f=t[7],h=t[8],u=t[9],d=t[10],p=t[11],m=t[12],_=t[13],v=t[14],T=t[15],C=d*T-v*p,I=u*T-_*p,R=u*v-_*d,b=h*T-m*p,M=h*v-d*m,F=h*_-m*u,U=+(l*C-c*I+f*R),D=-(o*C-c*b+f*M),$=+(o*I-l*b+f*F),oe=-(o*R-l*M+c*F),re=i*U+r*D+n*$+a*oe;if(re===0)return!1;let se=1/re,be=c*T-v*f,Me=l*T-_*f,ke=l*v-_*c,de=o*T-m*f,Qe=o*v-m*c,Re=o*_-m*l,Ae=c*p-d*f,ut=l*p-u*f,Et=l*d-u*c,Er=o*p-h*f,Tr=o*d-h*c,Le=o*u-h*l,uo=-(r*C-n*I+a*R),Qt=+(i*C-n*b+a*M),vn=-(i*I-r*b+a*F),Sn=+(i*R-r*M+n*F),En=+(r*be-n*Me+a*ke),Tn=-(i*be-n*de+a*Qe),_s=+(i*Me-r*de+a*Re),gs=-(i*ke-r*Qe+n*Re),vs=-(r*Ae-n*ut+a*Et),Ss=+(i*Ae-n*Er+a*Tr),Kd=-(i*ut-r*Er+a*Le),qd=+(i*Et-r*Tr+n*Le);return e[0]=U*se,e[1]=uo*se,e[2]=En*se,e[3]=vs*se,e[4]=D*se,e[5]=Qt*se,e[6]=Tn*se,e[7]=Ss*se,e[8]=$*se,e[9]=vn*se,e[10]=_s*se,e[11]=Kd*se,e[12]=oe*se,e[13]=Sn*se,e[14]=gs*se,e[15]=qd*se,!0}var bh,MD=S(()=>{bh=class{};bh._UpdateFlagSeed=0});var Rr,he,E,Oe,K,B,le,w,hl,ie=S(()=>{xr();Hs();Te();IA();gt();di();MD();Rr=s=>parseInt(s.toString().replace(/\W/g,"")),he=class s{constructor(e=0,t=0){this.x=e,this.y=t}toString(){return`{X: ${this.x} Y: ${this.y}}`}getClassName(){return"Vector2"}getHashCode(){let e=Rr(this.x),t=Rr(this.y),i=e;return i=i*397^t,i}toArray(e,t=0){return e[t]=this.x,e[t+1]=this.y,this}fromArray(e,t=0){return s.FromArrayToRef(e,t,this),this}asArray(){return[this.x,this.y]}copyFrom(e){return this.x=e.x,this.y=e.y,this}copyFromFloats(e,t){return this.x=e,this.y=t,this}set(e,t){return this.copyFromFloats(e,t)}setAll(e){return this.copyFromFloats(e,e)}add(e){return new s(this.x+e.x,this.y+e.y)}addToRef(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t}addInPlace(e){return this.x+=e.x,this.y+=e.y,this}addInPlaceFromFloats(e,t){return this.x+=e,this.y+=t,this}addVector3(e){return new s(this.x+e.x,this.y+e.y)}subtract(e){return new s(this.x-e.x,this.y-e.y)}subtractToRef(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this}multiplyInPlace(e){return this.x*=e.x,this.y*=e.y,this}multiply(e){return new s(this.x*e.x,this.y*e.y)}multiplyToRef(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,t}multiplyByFloats(e,t){return new s(this.x*e,this.y*t)}divide(e){return new s(this.x/e.x,this.y/e.y)}divideToRef(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,t}divideInPlace(e){return this.x=this.x/e.x,this.y=this.y/e.y,this}minimizeInPlace(e){return this.minimizeInPlaceFromFloats(e.x,e.y)}maximizeInPlace(e){return this.maximizeInPlaceFromFloats(e.x,e.y)}minimizeInPlaceFromFloats(e,t){return this.x=Math.min(e,this.x),this.y=Math.min(t,this.y),this}maximizeInPlaceFromFloats(e,t){return this.x=Math.max(e,this.x),this.y=Math.max(t,this.y),this}subtractFromFloats(e,t){return new s(this.x-e,this.y-t)}subtractFromFloatsToRef(e,t,i){return i.x=this.x-e,i.y=this.y-t,i}negate(){return new s(-this.x,-this.y)}negateInPlace(){return this.x*=-1,this.y*=-1,this}negateToRef(e){return e.x=-this.x,e.y=-this.y,e}scaleInPlace(e){return this.x*=e,this.y*=e,this}scale(e){return new s(this.x*e,this.y*e)}scaleToRef(e,t){return t.x=this.x*e,t.y=this.y*e,t}scaleAndAddToRef(e,t){return t.x+=this.x*e,t.y+=this.y*e,t}equals(e){return e&&this.x===e.x&&this.y===e.y}equalsWithEpsilon(e,t=We){return e&&Rt(this.x,e.x,t)&&Rt(this.y,e.y,t)}equalsToFloats(e,t){return this.x===e&&this.y===t}floor(){return new s(Math.floor(this.x),Math.floor(this.y))}floorToRef(e){return e.x=Math.floor(this.x),e.y=Math.floor(this.y),e}fract(){return new s(this.x-Math.floor(this.x),this.y-Math.floor(this.y))}fractToRef(e){return e.x=this.x-Math.floor(this.x),e.y=this.y-Math.floor(this.y),e}rotate(e){return this.rotateToRef(e,new s)}rotateToRef(e,t){let i=Math.cos(e),r=Math.sin(e);return t.x=i*this.x-r*this.y,t.y=r*this.x+i*this.y,t}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSquared(){return this.x*this.x+this.y*this.y}normalize(){return this.normalizeFromLength(this.length())}normalizeFromLength(e){return e===0||e===1?this:this.scaleInPlace(1/e)}normalizeToNew(){let e=new s;return this.normalizeToRef(e),e}normalizeToRef(e){let t=this.length();return t===0&&(e.x=this.x,e.y=this.y),this.scaleToRef(1/t,e)}clone(){return new s(this.x,this.y)}dot(e){return this.x*e.x+this.y*e.y}static Zero(){return new s(0,0)}static One(){return new s(1,1)}static Random(e=0,t=1){return new s(bt(e,t),bt(e,t))}static RandomToRef(e=0,t=1,i){return i.copyFromFloats(bt(e,t),bt(e,t))}static get ZeroReadOnly(){return s._ZeroReadOnly}static FromArray(e,t=0){return new s(e[t],e[t+1])}static FromArrayToRef(e,t,i){return i.x=e[t],i.y=e[t+1],i}static FromFloatsToRef(e,t,i){return i.copyFromFloats(e,t),i}static CatmullRom(e,t,i,r,n){let a=n*n,o=n*a,l=.5*(2*t.x+(-e.x+i.x)*n+(2*e.x-5*t.x+4*i.x-r.x)*a+(-e.x+3*t.x-3*i.x+r.x)*o),c=.5*(2*t.y+(-e.y+i.y)*n+(2*e.y-5*t.y+4*i.y-r.y)*a+(-e.y+3*t.y-3*i.y+r.y)*o);return new s(l,c)}static ClampToRef(e,t,i,r){return r.x=Fe(e.x,t.x,i.x),r.y=Fe(e.y,t.y,i.y),r}static Clamp(e,t,i){let r=Fe(e.x,t.x,i.x),n=Fe(e.y,t.y,i.y);return new s(r,n)}static Hermite(e,t,i,r,n){let a=n*n,o=n*a,l=2*o-3*a+1,c=-2*o+3*a,f=o-2*a+n,h=o-a,u=e.x*l+i.x*c+t.x*f+r.x*h,d=e.y*l+i.y*c+t.y*f+r.y*h;return new s(u,d)}static Hermite1stDerivative(e,t,i,r,n){return this.Hermite1stDerivativeToRef(e,t,i,r,n,new s)}static Hermite1stDerivativeToRef(e,t,i,r,n,a){let o=n*n;return a.x=(o-n)*6*e.x+(3*o-4*n+1)*t.x+(-o+n)*6*i.x+(3*o-2*n)*r.x,a.y=(o-n)*6*e.y+(3*o-4*n+1)*t.y+(-o+n)*6*i.y+(3*o-2*n)*r.y,a}static Lerp(e,t,i){return s.LerpToRef(e,t,i,new s)}static LerpToRef(e,t,i,r){return r.x=e.x+(t.x-e.x)*i,r.y=e.y+(t.y-e.y)*i,r}static Dot(e,t){return e.x*t.x+e.y*t.y}static Normalize(e){return s.NormalizeToRef(e,new s)}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Minimize(e,t){let i=e.x<t.x?e.x:t.x,r=e.y<t.y?e.y:t.y;return new s(i,r)}static Maximize(e,t){let i=e.x>t.x?e.x:t.x,r=e.y>t.y?e.y:t.y;return new s(i,r)}static Transform(e,t){return s.TransformToRef(e,t,new s)}static TransformToRef(e,t,i){let r=t.m,n=e.x*r[0]+e.y*r[4]+r[12],a=e.x*r[1]+e.y*r[5]+r[13];return i.x=n,i.y=a,i}static PointInTriangle(e,t,i,r){let n=.5*(-i.y*r.x+t.y*(-i.x+r.x)+t.x*(i.y-r.y)+i.x*r.y),a=n<0?-1:1,o=(t.y*r.x-t.x*r.y+(r.y-t.y)*e.x+(t.x-r.x)*e.y)*a,l=(t.x*i.y-t.y*i.x+(t.y-i.y)*e.x+(i.x-t.x)*e.y)*a;return o>0&&l>0&&o+l<2*n*a}static Distance(e,t){return Math.sqrt(s.DistanceSquared(e,t))}static DistanceSquared(e,t){let i=e.x-t.x,r=e.y-t.y;return i*i+r*r}static Center(e,t){return s.CenterToRef(e,t,new s)}static CenterToRef(e,t,i){return i.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2)}static DistanceOfPointFromSegment(e,t,i){let r=s.DistanceSquared(t,i);if(r===0)return s.Distance(e,t);let n=i.subtract(t),a=Math.max(0,Math.min(1,s.Dot(e.subtract(t),n)/r)),o=t.add(n.multiplyByFloats(a,a));return s.Distance(e,o)}};he._V8PerformanceHack=new he(.5,.5);he._ZeroReadOnly=he.Zero();Object.defineProperties(he.prototype,{dimension:{value:[2]},rank:{value:1}});E=class s{get x(){return this._x}set x(e){this._x=e,this._isDirty=!0}get y(){return this._y}set y(e){this._y=e,this._isDirty=!0}get z(){return this._z}set z(e){this._z=e,this._isDirty=!0}constructor(e=0,t=0,i=0){this._isDirty=!0,this._x=e,this._y=t,this._z=i}toString(){return`{X: ${this._x} Y: ${this._y} Z: ${this._z}}`}getClassName(){return"Vector3"}getHashCode(){let e=Rr(this._x),t=Rr(this._y),i=Rr(this._z),r=e;return r=r*397^t,r=r*397^i,r}asArray(){return[this._x,this._y,this._z]}toArray(e,t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,this}fromArray(e,t=0){return s.FromArrayToRef(e,t,this),this}toQuaternion(){return K.RotationYawPitchRoll(this._y,this._x,this._z)}addInPlace(e){return this._x+=e._x,this._y+=e._y,this._z+=e._z,this._isDirty=!0,this}addInPlaceFromFloats(e,t,i){return this._x+=e,this._y+=t,this._z+=i,this._isDirty=!0,this}add(e){return new s(this._x+e._x,this._y+e._y,this._z+e._z)}addToRef(e,t){return t._x=this._x+e._x,t._y=this._y+e._y,t._z=this._z+e._z,t._isDirty=!0,t}subtractInPlace(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._isDirty=!0,this}subtract(e){return new s(this._x-e._x,this._y-e._y,this._z-e._z)}subtractToRef(e,t){return this.subtractFromFloatsToRef(e._x,e._y,e._z,t)}subtractFromFloats(e,t,i){return new s(this._x-e,this._y-t,this._z-i)}subtractFromFloatsToRef(e,t,i,r){return r._x=this._x-e,r._y=this._y-t,r._z=this._z-i,r._isDirty=!0,r}negate(){return new s(-this._x,-this._y,-this._z)}negateInPlace(){return this._x*=-1,this._y*=-1,this._z*=-1,this._isDirty=!0,this}negateToRef(e){return e._x=this._x*-1,e._y=this._y*-1,e._z=this._z*-1,e._isDirty=!0,e}scaleInPlace(e){return this._x*=e,this._y*=e,this._z*=e,this._isDirty=!0,this}scale(e){return new s(this._x*e,this._y*e,this._z*e)}scaleToRef(e,t){return t._x=this._x*e,t._y=this._y*e,t._z=this._z*e,t._isDirty=!0,t}getNormalToRef(e){let t=this.length(),i=Math.acos(this._y/t),r=Math.atan2(this._z,this._x);i>Math.PI/2?i-=Math.PI/2:i+=Math.PI/2;let n=t*Math.sin(i)*Math.cos(r),a=t*Math.cos(i),o=t*Math.sin(i)*Math.sin(r);return e.set(n,a,o),e}applyRotationQuaternionToRef(e,t){let i=this._x,r=this._y,n=this._z,a=e._x,o=e._y,l=e._z,c=e._w,f=2*(o*n-l*r),h=2*(l*i-a*n),u=2*(a*r-o*i);return t._x=i+c*f+o*u-l*h,t._y=r+c*h+l*f-a*u,t._z=n+c*u+a*h-o*f,t._isDirty=!0,t}applyRotationQuaternionInPlace(e){return this.applyRotationQuaternionToRef(e,this)}applyRotationQuaternion(e){return this.applyRotationQuaternionToRef(e,new s)}scaleAndAddToRef(e,t){return t._x+=this._x*e,t._y+=this._y*e,t._z+=this._z*e,t._isDirty=!0,t}projectOnPlane(e,t){return this.projectOnPlaneToRef(e,t,new s)}projectOnPlaneToRef(e,t,i){let r=e.normal,n=e.d,a=le.Vector3[0];this.subtractToRef(t,a),a.normalize();let o=s.Dot(a,r);if(Math.abs(o)<1e-10)i.setAll(1/0);else{let l=-(s.Dot(t,r)+n)/o,c=a.scaleInPlace(l);t.addToRef(c,i)}return i}equals(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z}equalsWithEpsilon(e,t=We){return e&&Rt(this._x,e._x,t)&&Rt(this._y,e._y,t)&&Rt(this._z,e._z,t)}equalsToFloats(e,t,i){return this._x===e&&this._y===t&&this._z===i}multiplyInPlace(e){return this._x*=e._x,this._y*=e._y,this._z*=e._z,this._isDirty=!0,this}multiply(e){return this.multiplyByFloats(e._x,e._y,e._z)}multiplyToRef(e,t){return t._x=this._x*e._x,t._y=this._y*e._y,t._z=this._z*e._z,t._isDirty=!0,t}multiplyByFloats(e,t,i){return new s(this._x*e,this._y*t,this._z*i)}divide(e){return new s(this._x/e._x,this._y/e._y,this._z/e._z)}divideToRef(e,t){return t._x=this._x/e._x,t._y=this._y/e._y,t._z=this._z/e._z,t._isDirty=!0,t}divideInPlace(e){return this._x=this._x/e._x,this._y=this._y/e._y,this._z=this._z/e._z,this._isDirty=!0,this}minimizeInPlace(e){return this.minimizeInPlaceFromFloats(e._x,e._y,e._z)}maximizeInPlace(e){return this.maximizeInPlaceFromFloats(e._x,e._y,e._z)}minimizeInPlaceFromFloats(e,t,i){return e<this._x&&(this.x=e),t<this._y&&(this.y=t),i<this._z&&(this.z=i),this}maximizeInPlaceFromFloats(e,t,i){return e>this._x&&(this.x=e),t>this._y&&(this.y=t),i>this._z&&(this.z=i),this}isNonUniformWithinEpsilon(e){let t=Math.abs(this._x),i=Math.abs(this._y);if(!Rt(t,i,e))return!0;let r=Math.abs(this._z);return!Rt(t,r,e)||!Rt(i,r,e)}get isNonUniform(){let e=Math.abs(this._x),t=Math.abs(this._y);if(e!==t)return!0;let i=Math.abs(this._z);return e!==i}floorToRef(e){return e._x=Math.floor(this._x),e._y=Math.floor(this._y),e._z=Math.floor(this._z),e._isDirty=!0,e}floor(){return new s(Math.floor(this._x),Math.floor(this._y),Math.floor(this._z))}fractToRef(e){return e._x=this._x-Math.floor(this._x),e._y=this._y-Math.floor(this._y),e._z=this._z-Math.floor(this._z),e._isDirty=!0,e}fract(){return new s(this._x-Math.floor(this._x),this._y-Math.floor(this._y),this._z-Math.floor(this._z))}length(){return Math.sqrt(this.lengthSquared())}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z}get hasAZeroComponent(){return this._x*this._y*this._z===0}normalize(){return this.normalizeFromLength(this.length())}reorderInPlace(e){if(e=e.toLowerCase(),e==="xyz")return this;let t=le.Vector3[0].copyFrom(this);return this.x=t[e[0]],this.y=t[e[1]],this.z=t[e[2]],this}rotateByQuaternionToRef(e,t){return e.toRotationMatrix(le.Matrix[0]),s.TransformCoordinatesToRef(this,le.Matrix[0],t),t}rotateByQuaternionAroundPointToRef(e,t,i){return this.subtractToRef(t,le.Vector3[0]),le.Vector3[0].rotateByQuaternionToRef(e,le.Vector3[0]),t.addToRef(le.Vector3[0],i),i}cross(e){return s.CrossToRef(this,e,new s)}normalizeFromLength(e){return e===0||e===1?this:this.scaleInPlace(1/e)}normalizeToNew(){return this.normalizeToRef(new s)}normalizeToRef(e){let t=this.length();return t===0||t===1?(e._x=this._x,e._y=this._y,e._z=this._z,e._isDirty=!0,e):this.scaleToRef(1/t,e)}clone(){return new s(this._x,this._y,this._z)}copyFrom(e){return this.copyFromFloats(e._x,e._y,e._z)}copyFromFloats(e,t,i){return this._x=e,this._y=t,this._z=i,this._isDirty=!0,this}set(e,t,i){return this.copyFromFloats(e,t,i)}setAll(e){return this._x=this._y=this._z=e,this._isDirty=!0,this}static GetClipFactor(e,t,i,r){let n=s.Dot(e,i),a=s.Dot(t,i);return(n-r)/(n-a)}static GetAngleBetweenVectors(e,t,i){let r=e.normalizeToRef(le.Vector3[1]),n=t.normalizeToRef(le.Vector3[2]),a=s.Dot(r,n);a=Fe(a,-1,1);let o=Math.acos(a),l=le.Vector3[3];return s.CrossToRef(r,n,l),s.Dot(l,i)>0?isNaN(o)?0:o:isNaN(o)?-Math.PI:-Math.acos(a)}static GetAngleBetweenVectorsOnPlane(e,t,i){le.Vector3[0].copyFrom(e);let r=le.Vector3[0];le.Vector3[1].copyFrom(t);let n=le.Vector3[1];le.Vector3[2].copyFrom(i);let a=le.Vector3[2],o=le.Vector3[3],l=le.Vector3[4];r.normalize(),n.normalize(),a.normalize(),s.CrossToRef(a,r,o),s.CrossToRef(o,a,l);let c=Math.atan2(s.Dot(n,o),s.Dot(n,l));return MA(c)}static PitchYawRollToMoveBetweenPointsToRef(e,t,i){let r=w.Vector3[0];return t.subtractToRef(e,r),i._y=Math.atan2(r.x,r.z)||0,i._x=Math.atan2(Math.sqrt(r.x**2+r.z**2),r.y)||0,i._z=0,i._isDirty=!0,i}static PitchYawRollToMoveBetweenPoints(e,t){let i=s.Zero();return s.PitchYawRollToMoveBetweenPointsToRef(e,t,i)}static SlerpToRef(e,t,i,r){i=Fe(i,0,1);let n=le.Vector3[0],a=le.Vector3[1];n.copyFrom(e);let o=n.length();n.normalizeFromLength(o),a.copyFrom(t);let l=a.length();a.normalizeFromLength(l);let c=s.Dot(n,a),f,h;if(c<1-We){let u=Math.acos(c),d=1/Math.sin(u);f=Math.sin((1-i)*u)*d,h=Math.sin(i*u)*d}else f=1-i,h=i;return n.scaleInPlace(f),a.scaleInPlace(h),r.copyFrom(n).addInPlace(a),r.scaleInPlace(As(o,l,i)),r}static SmoothToRef(e,t,i,r,n){return s.SlerpToRef(e,t,r===0?1:i/r,n),n}static FromArray(e,t=0){return new s(e[t],e[t+1],e[t+2])}static FromFloatArray(e,t){return s.FromArray(e,t)}static FromArrayToRef(e,t,i){return i._x=e[t],i._y=e[t+1],i._z=e[t+2],i._isDirty=!0,i}static FromFloatArrayToRef(e,t,i){return s.FromArrayToRef(e,t,i)}static FromFloatsToRef(e,t,i,r){return r.copyFromFloats(e,t,i),r}static Zero(){return new s(0,0,0)}static One(){return new s(1,1,1)}static Up(){return new s(0,1,0)}static get UpReadOnly(){return s._UpReadOnly}static get DownReadOnly(){return s._DownReadOnly}static get RightReadOnly(){return s._RightReadOnly}static get LeftReadOnly(){return s._LeftReadOnly}static get LeftHandedForwardReadOnly(){return s._LeftHandedForwardReadOnly}static get RightHandedForwardReadOnly(){return s._RightHandedForwardReadOnly}static get LeftHandedBackwardReadOnly(){return s._LeftHandedBackwardReadOnly}static get RightHandedBackwardReadOnly(){return s._RightHandedBackwardReadOnly}static get ZeroReadOnly(){return s._ZeroReadOnly}static get OneReadOnly(){return s._OneReadOnly}static Down(){return new s(0,-1,0)}static Forward(e=!1){return new s(0,0,e?-1:1)}static Backward(e=!1){return new s(0,0,e?1:-1)}static Right(){return new s(1,0,0)}static Left(){return new s(-1,0,0)}static Random(e=0,t=1){return new s(bt(e,t),bt(e,t),bt(e,t))}static RandomToRef(e=0,t=1,i){return i.copyFromFloats(bt(e,t),bt(e,t),bt(e,t))}static TransformCoordinates(e,t){let i=s.Zero();return s.TransformCoordinatesToRef(e,t,i),i}static TransformCoordinatesToRef(e,t,i){return s.TransformCoordinatesFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformCoordinatesFromFloatsToRef(e,t,i,r,n){let a=r.m,o=e*a[0]+t*a[4]+i*a[8]+a[12],l=e*a[1]+t*a[5]+i*a[9]+a[13],c=e*a[2]+t*a[6]+i*a[10]+a[14],f=1/(e*a[3]+t*a[7]+i*a[11]+a[15]);return n._x=o*f,n._y=l*f,n._z=c*f,n._isDirty=!0,n}static TransformNormal(e,t){let i=s.Zero();return s.TransformNormalToRef(e,t,i),i}static TransformNormalToRef(e,t,i){return this.TransformNormalFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformNormalFromFloatsToRef(e,t,i,r,n){let a=r.m;return n._x=e*a[0]+t*a[4]+i*a[8],n._y=e*a[1]+t*a[5]+i*a[9],n._z=e*a[2]+t*a[6]+i*a[10],n._isDirty=!0,n}static CatmullRom(e,t,i,r,n){let a=n*n,o=n*a,l=.5*(2*t._x+(-e._x+i._x)*n+(2*e._x-5*t._x+4*i._x-r._x)*a+(-e._x+3*t._x-3*i._x+r._x)*o),c=.5*(2*t._y+(-e._y+i._y)*n+(2*e._y-5*t._y+4*i._y-r._y)*a+(-e._y+3*t._y-3*i._y+r._y)*o),f=.5*(2*t._z+(-e._z+i._z)*n+(2*e._z-5*t._z+4*i._z-r._z)*a+(-e._z+3*t._z-3*i._z+r._z)*o);return new s(l,c,f)}static Clamp(e,t,i){let r=new s;return s.ClampToRef(e,t,i,r),r}static ClampToRef(e,t,i,r){let n=e._x;n=n>i._x?i._x:n,n=n<t._x?t._x:n;let a=e._y;a=a>i._y?i._y:a,a=a<t._y?t._y:a;let o=e._z;return o=o>i._z?i._z:o,o=o<t._z?t._z:o,r.copyFromFloats(n,a,o),r}static CheckExtends(e,t,i){t.minimizeInPlace(e),i.maximizeInPlace(e)}static Hermite(e,t,i,r,n){let a=n*n,o=n*a,l=2*o-3*a+1,c=-2*o+3*a,f=o-2*a+n,h=o-a,u=e._x*l+i._x*c+t._x*f+r._x*h,d=e._y*l+i._y*c+t._y*f+r._y*h,p=e._z*l+i._z*c+t._z*f+r._z*h;return new s(u,d,p)}static Hermite1stDerivative(e,t,i,r,n){let a=new s;return this.Hermite1stDerivativeToRef(e,t,i,r,n,a),a}static Hermite1stDerivativeToRef(e,t,i,r,n,a){let o=n*n;return a._x=(o-n)*6*e._x+(3*o-4*n+1)*t._x+(-o+n)*6*i._x+(3*o-2*n)*r._x,a._y=(o-n)*6*e._y+(3*o-4*n+1)*t._y+(-o+n)*6*i._y+(3*o-2*n)*r._y,a._z=(o-n)*6*e._z+(3*o-4*n+1)*t._z+(-o+n)*6*i._z+(3*o-2*n)*r._z,a._isDirty=!0,a}static Lerp(e,t,i){let r=new s(0,0,0);return s.LerpToRef(e,t,i,r),r}static LerpToRef(e,t,i,r){return r._x=e._x+(t._x-e._x)*i,r._y=e._y+(t._y-e._y)*i,r._z=e._z+(t._z-e._z)*i,r._isDirty=!0,r}static Dot(e,t){return e._x*t._x+e._y*t._y+e._z*t._z}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z}static Cross(e,t){let i=new s;return s.CrossToRef(e,t,i),i}static CrossToRef(e,t,i){let r=e._y*t._z-e._z*t._y,n=e._z*t._x-e._x*t._z,a=e._x*t._y-e._y*t._x;return i.copyFromFloats(r,n,a),i}static Normalize(e){let t=s.Zero();return s.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Project(e,t,i,r){let n=new s;return s.ProjectToRef(e,t,i,r,n),n}static ProjectToRef(e,t,i,r,n){let a=r.width,o=r.height,l=r.x,c=r.y,f=le.Matrix[1],h=Z.LastCreatedEngine?.isNDCHalfZRange,u=h?1:.5,d=h?0:.5;B.FromValuesToRef(a/2,0,0,0,0,-o/2,0,0,0,0,u,0,l+a/2,o/2+c,d,1,f);let p=le.Matrix[0];return t.multiplyToRef(i,p),p.multiplyToRef(f,p),s.TransformCoordinatesToRef(e,p,n),n}static Reflect(e,t){return this.ReflectToRef(e,t,new s)}static ReflectToRef(e,t,i){let r=w.Vector3[0];return r.copyFrom(t).scaleInPlace(2*s.Dot(e,t)),i.copyFrom(e).subtractInPlace(r)}static UnprojectFromTransform(e,t,i,r,n){return this.Unproject(e,t,i,r,n,B.IdentityReadOnly)}static Unproject(e,t,i,r,n,a){let o=new s;return s.UnprojectToRef(e,t,i,r,n,a,o),o}static UnprojectToRef(e,t,i,r,n,a,o){return s.UnprojectFloatsToRef(e._x,e._y,e._z,t,i,r,n,a,o),o}static UnprojectFloatsToRef(e,t,i,r,n,a,o,l,c){let f=le.Matrix[0];a.multiplyToRef(o,f),f.multiplyToRef(l,f),f.invert();let h=le.Vector3[0];return h.x=e/r*2-1,h.y=-(t/n*2-1),Z.LastCreatedEngine?.isNDCHalfZRange?h.z=i:h.z=2*i-1,s.TransformCoordinatesToRef(h,f,c),c}static Minimize(e,t){let i=new s;return i.copyFrom(e),i.minimizeInPlace(t),i}static Maximize(e,t){let i=new s;return i.copyFrom(e),i.maximizeInPlace(t),i}static Distance(e,t){return Math.sqrt(s.DistanceSquared(e,t))}static DistanceSquared(e,t){let i=e._x-t._x,r=e._y-t._y,n=e._z-t._z;return i*i+r*r+n*n}static ProjectOnTriangleToRef(e,t,i,r,n){let a=le.Vector3[0],o=le.Vector3[1],l=le.Vector3[2],c=le.Vector3[3],f=le.Vector3[4];i.subtractToRef(t,a),r.subtractToRef(t,o),r.subtractToRef(i,l);let h=a.length(),u=o.length(),d=l.length();if(h<We||u<We||d<We)return n.copyFrom(t),s.Distance(e,t);e.subtractToRef(t,f),s.CrossToRef(a,o,c);let p=c.length();if(p<We)return n.copyFrom(t),s.Distance(e,t);c.normalizeFromLength(p);let m=f.length();if(m<We)return n.copyFrom(t),0;f.normalizeFromLength(m);let _=s.Dot(c,f),v=le.Vector3[5],T=le.Vector3[6];v.copyFrom(c).scaleInPlace(-m*_),T.copyFrom(e).addInPlace(v);let C=le.Vector3[4],I=le.Vector3[5],R=le.Vector3[7],b=le.Vector3[8];C.copyFrom(a).scaleInPlace(1/h),b.copyFrom(o).scaleInPlace(1/u),C.addInPlace(b).scaleInPlace(-1),I.copyFrom(a).scaleInPlace(-1/h),b.copyFrom(l).scaleInPlace(1/d),I.addInPlace(b).scaleInPlace(-1),R.copyFrom(l).scaleInPlace(-1/d),b.copyFrom(o).scaleInPlace(-1/u),R.addInPlace(b).scaleInPlace(-1);let M=le.Vector3[9],F;M.copyFrom(T).subtractInPlace(t),s.CrossToRef(C,M,b),F=s.Dot(b,c);let U=F;M.copyFrom(T).subtractInPlace(i),s.CrossToRef(I,M,b),F=s.Dot(b,c);let D=F;M.copyFrom(T).subtractInPlace(r),s.CrossToRef(R,M,b),F=s.Dot(b,c);let $=F,oe=le.Vector3[10],re,se;U>0&&D<0?(oe.copyFrom(a),re=t,se=i):D>0&&$<0?(oe.copyFrom(l),re=i,se=r):(oe.copyFrom(o).scaleInPlace(-1),re=r,se=t);let be=le.Vector3[9],Me=le.Vector3[4];if(re.subtractToRef(T,b),se.subtractToRef(T,be),s.CrossToRef(b,be,Me),!(s.Dot(Me,c)<0))return n.copyFrom(T),Math.abs(m*_);let de=le.Vector3[5];s.CrossToRef(oe,Me,de),de.normalize();let Qe=le.Vector3[9];Qe.copyFrom(re).subtractInPlace(T);let Re=Qe.length();if(Re<We)return n.copyFrom(re),s.Distance(e,re);Qe.normalizeFromLength(Re);let Ae=s.Dot(de,Qe),ut=le.Vector3[7];ut.copyFrom(T).addInPlace(de.scaleInPlace(Re*Ae)),b.copyFrom(ut).subtractInPlace(re),m=oe.length(),oe.normalizeFromLength(m);let Et=s.Dot(b,oe)/Math.max(m,We);return Et=Fe(Et,0,1),ut.copyFrom(re).addInPlace(oe.scaleInPlace(Et*m)),n.copyFrom(ut),s.Distance(e,ut)}static Center(e,t){return s.CenterToRef(e,t,s.Zero())}static CenterToRef(e,t,i){return i.copyFromFloats((e._x+t._x)/2,(e._y+t._y)/2,(e._z+t._z)/2)}static RotationFromAxis(e,t,i){let r=new s;return s.RotationFromAxisToRef(e,t,i,r),r}static RotationFromAxisToRef(e,t,i,r){let n=le.Quaternion[0];return K.RotationQuaternionFromAxisToRef(e,t,i,n),n.toEulerAnglesToRef(r),r}};E._V8PerformanceHack=new E(.5,.5,.5);E._UpReadOnly=E.Up();E._DownReadOnly=E.Down();E._LeftHandedForwardReadOnly=E.Forward(!1);E._RightHandedForwardReadOnly=E.Forward(!0);E._LeftHandedBackwardReadOnly=E.Backward(!1);E._RightHandedBackwardReadOnly=E.Backward(!0);E._RightReadOnly=E.Right();E._LeftReadOnly=E.Left();E._ZeroReadOnly=E.Zero();E._OneReadOnly=E.One();Object.defineProperties(E.prototype,{dimension:{value:[3]},rank:{value:1}});Oe=class s{get x(){return this._x}set x(e){this._x=e,this._isDirty=!0}get y(){return this._y}set y(e){this._y=e,this._isDirty=!0}get z(){return this._z}set z(e){this._z=e,this._isDirty=!0}get w(){return this._w}set w(e){this._w=e,this._isDirty=!0}constructor(e=0,t=0,i=0,r=0){this._isDirty=!0,this._x=e,this._y=t,this._z=i,this._w=r}toString(){return`{X: ${this._x} Y: ${this._y} Z: ${this._z} W: ${this._w}}`}getClassName(){return"Vector4"}getHashCode(){let e=Rr(this._x),t=Rr(this._y),i=Rr(this._z),r=Rr(this._w),n=e;return n=n*397^t,n=n*397^i,n=n*397^r,n}asArray(){return[this._x,this._y,this._z,this._w]}toArray(e,t){return t===void 0&&(t=0),e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,this}fromArray(e,t=0){return s.FromArrayToRef(e,t,this),this}addInPlace(e){return this.x+=e._x,this.y+=e._y,this.z+=e._z,this.w+=e._w,this}addInPlaceFromFloats(e,t,i,r){return this.x+=e,this.y+=t,this.z+=i,this.w+=r,this}add(e){return new s(this._x+e.x,this._y+e.y,this._z+e.z,this._w+e.w)}addToRef(e,t){return t.x=this._x+e.x,t.y=this._y+e.y,t.z=this._z+e.z,t.w=this._w+e.w,t}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subtract(e){return new s(this._x-e.x,this._y-e.y,this._z-e.z,this._w-e.w)}subtractToRef(e,t){return t.x=this._x-e.x,t.y=this._y-e.y,t.z=this._z-e.z,t.w=this._w-e.w,t}subtractFromFloats(e,t,i,r){return new s(this._x-e,this._y-t,this._z-i,this._w-r)}subtractFromFloatsToRef(e,t,i,r,n){return n.x=this._x-e,n.y=this._y-t,n.z=this._z-i,n.w=this._w-r,n}negate(){return new s(-this._x,-this._y,-this._z,-this._w)}negateInPlace(){return this.x*=-1,this.y*=-1,this.z*=-1,this.w*=-1,this}negateToRef(e){return e.x=-this._x,e.y=-this._y,e.z=-this._z,e.w=-this._w,e}scaleInPlace(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}scale(e){return new s(this._x*e,this._y*e,this._z*e,this._w*e)}scaleToRef(e,t){return t.x=this._x*e,t.y=this._y*e,t.z=this._z*e,t.w=this._w*e,t}scaleAndAddToRef(e,t){return t.x+=this._x*e,t.y+=this._y*e,t.z+=this._z*e,t.w+=this._w*e,t}equals(e){return e&&this._x===e.x&&this._y===e.y&&this._z===e.z&&this._w===e.w}equalsWithEpsilon(e,t=We){return e&&Rt(this._x,e.x,t)&&Rt(this._y,e.y,t)&&Rt(this._z,e.z,t)&&Rt(this._w,e.w,t)}equalsToFloats(e,t,i,r){return this._x===e&&this._y===t&&this._z===i&&this._w===r}multiplyInPlace(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiply(e){return new s(this._x*e.x,this._y*e.y,this._z*e.z,this._w*e.w)}multiplyToRef(e,t){return t.x=this._x*e.x,t.y=this._y*e.y,t.z=this._z*e.z,t.w=this._w*e.w,t}multiplyByFloats(e,t,i,r){return new s(this._x*e,this._y*t,this._z*i,this._w*r)}divide(e){return new s(this._x/e.x,this._y/e.y,this._z/e.z,this._w/e.w)}divideToRef(e,t){return t.x=this._x/e.x,t.y=this._y/e.y,t.z=this._z/e.z,t.w=this._w/e.w,t}divideInPlace(e){return this.divideToRef(e,this)}minimizeInPlace(e){return e.x<this._x&&(this.x=e.x),e.y<this._y&&(this.y=e.y),e.z<this._z&&(this.z=e.z),e.w<this._w&&(this.w=e.w),this}maximizeInPlace(e){return e.x>this._x&&(this.x=e.x),e.y>this._y&&(this.y=e.y),e.z>this._z&&(this.z=e.z),e.w>this._w&&(this.w=e.w),this}minimizeInPlaceFromFloats(e,t,i,r){return this.x=Math.min(e,this._x),this.y=Math.min(t,this._y),this.z=Math.min(i,this._z),this.w=Math.min(r,this._w),this}maximizeInPlaceFromFloats(e,t,i,r){return this.x=Math.max(e,this._x),this.y=Math.max(t,this._y),this.z=Math.max(i,this._z),this.w=Math.max(r,this._w),this}floorToRef(e){return e.x=Math.floor(this._x),e.y=Math.floor(this._y),e.z=Math.floor(this._z),e.w=Math.floor(this._w),e}floor(){return new s(Math.floor(this._x),Math.floor(this._y),Math.floor(this._z),Math.floor(this._w))}fractToRef(e){return e.x=this._x-Math.floor(this._x),e.y=this._y-Math.floor(this._y),e.z=this._z-Math.floor(this._z),e.w=this._w-Math.floor(this._w),e}fract(){return new s(this._x-Math.floor(this._x),this._y-Math.floor(this._y),this._z-Math.floor(this._z),this._w-Math.floor(this._w))}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}normalize(){return this.normalizeFromLength(this.length())}normalizeFromLength(e){return e===0||e===1?this:this.scaleInPlace(1/e)}normalizeToNew(){return this.normalizeToRef(new s)}normalizeToRef(e){let t=this.length();return t===0||t===1?(e.x=this._x,e.y=this._y,e.z=this._z,e.w=this._w,e):this.scaleToRef(1/t,e)}toVector3(){return new E(this._x,this._y,this._z)}clone(){return new s(this._x,this._y,this._z,this._w)}copyFrom(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}copyFromFloats(e,t,i,r){return this.x=e,this.y=t,this.z=i,this.w=r,this}set(e,t,i,r){return this.copyFromFloats(e,t,i,r)}setAll(e){return this.x=this.y=this.z=this.w=e,this}dot(e){return this._x*e.x+this._y*e.y+this._z*e.z+this._w*e.w}static FromArray(e,t){return t||(t=0),new s(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t,i){return i.x=e[t],i.y=e[t+1],i.z=e[t+2],i.w=e[t+3],i}static FromFloatArrayToRef(e,t,i){return s.FromArrayToRef(e,t,i),i}static FromFloatsToRef(e,t,i,r,n){return n.x=e,n.y=t,n.z=i,n.w=r,n}static Zero(){return new s(0,0,0,0)}static One(){return new s(1,1,1,1)}static Random(e=0,t=1){return new s(bt(e,t),bt(e,t),bt(e,t),bt(e,t))}static RandomToRef(e=0,t=1,i){return i.x=bt(e,t),i.y=bt(e,t),i.z=bt(e,t),i.w=bt(e,t),i}static Clamp(e,t,i){return s.ClampToRef(e,t,i,new s)}static ClampToRef(e,t,i,r){return r.x=Fe(e.x,t.x,i.x),r.y=Fe(e.y,t.y,i.y),r.z=Fe(e.z,t.z,i.z),r.w=Fe(e.w,t.w,i.w),r}static CheckExtends(e,t,i){t.minimizeInPlace(e),i.maximizeInPlace(e)}static get ZeroReadOnly(){return s._ZeroReadOnly}static Normalize(e){return s.NormalizeToRef(e,new s)}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Minimize(e,t){let i=new s;return i.copyFrom(e),i.minimizeInPlace(t),i}static Maximize(e,t){let i=new s;return i.copyFrom(e),i.maximizeInPlace(t),i}static Distance(e,t){return Math.sqrt(s.DistanceSquared(e,t))}static DistanceSquared(e,t){let i=e.x-t.x,r=e.y-t.y,n=e.z-t.z,a=e.w-t.w;return i*i+r*r+n*n+a*a}static Center(e,t){return s.CenterToRef(e,t,new s)}static CenterToRef(e,t,i){return i.x=(e.x+t.x)/2,i.y=(e.y+t.y)/2,i.z=(e.z+t.z)/2,i.w=(e.w+t.w)/2,i}static TransformCoordinates(e,t){return s.TransformCoordinatesToRef(e,t,new s)}static TransformCoordinatesToRef(e,t,i){return s.TransformCoordinatesFromFloatsToRef(e._x,e._y,e._z,t,i),i}static TransformCoordinatesFromFloatsToRef(e,t,i,r,n){let a=r.m,o=e*a[0]+t*a[4]+i*a[8]+a[12],l=e*a[1]+t*a[5]+i*a[9]+a[13],c=e*a[2]+t*a[6]+i*a[10]+a[14],f=e*a[3]+t*a[7]+i*a[11]+a[15];return n.x=o,n.y=l,n.z=c,n.w=f,n}static TransformNormal(e,t){return s.TransformNormalToRef(e,t,new s)}static TransformNormalToRef(e,t,i){let r=t.m,n=e.x*r[0]+e.y*r[4]+e.z*r[8],a=e.x*r[1]+e.y*r[5]+e.z*r[9],o=e.x*r[2]+e.y*r[6]+e.z*r[10];return i.x=n,i.y=a,i.z=o,i.w=e.w,i}static TransformNormalFromFloatsToRef(e,t,i,r,n,a){let o=n.m;return a.x=e*o[0]+t*o[4]+i*o[8],a.y=e*o[1]+t*o[5]+i*o[9],a.z=e*o[2]+t*o[6]+i*o[10],a.w=r,a}static FromVector3(e,t=0){return new s(e._x,e._y,e._z,t)}static Dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}};Oe._V8PerformanceHack=new Oe(.5,.5,.5,.5);Oe._ZeroReadOnly=Oe.Zero();Object.defineProperties(Oe.prototype,{dimension:{value:[4]},rank:{value:1}});K=class s{get x(){return this._x}set x(e){this._x=e,this._isDirty=!0}get y(){return this._y}set y(e){this._y=e,this._isDirty=!0}get z(){return this._z}set z(e){this._z=e,this._isDirty=!0}get w(){return this._w}set w(e){this._w=e,this._isDirty=!0}constructor(e=0,t=0,i=0,r=1){this._isDirty=!0,this._x=e,this._y=t,this._z=i,this._w=r}toString(){return`{X: ${this._x} Y: ${this._y} Z: ${this._z} W: ${this._w}}`}getClassName(){return"Quaternion"}getHashCode(){let e=Rr(this._x),t=Rr(this._y),i=Rr(this._z),r=Rr(this._w),n=e;return n=n*397^t,n=n*397^i,n=n*397^r,n}asArray(){return[this._x,this._y,this._z,this._w]}toArray(e,t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,this}fromArray(e,t=0){return s.FromArrayToRef(e,t,this)}equals(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z&&this._w===e._w}equalsWithEpsilon(e,t=We){return e&&Rt(this._x,e._x,t)&&Rt(this._y,e._y,t)&&Rt(this._z,e._z,t)&&Rt(this._w,e._w,t)}isApprox(e,t=We){return e&&(Rt(this._x,e._x,t)&&Rt(this._y,e._y,t)&&Rt(this._z,e._z,t)&&Rt(this._w,e._w,t)||Rt(this._x,-e._x,t)&&Rt(this._y,-e._y,t)&&Rt(this._z,-e._z,t)&&Rt(this._w,-e._w,t))}clone(){return new s(this._x,this._y,this._z,this._w)}copyFrom(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._w=e._w,this._isDirty=!0,this}copyFromFloats(e,t,i,r){return this._x=e,this._y=t,this._z=i,this._w=r,this._isDirty=!0,this}set(e,t,i,r){return this.copyFromFloats(e,t,i,r)}setAll(e){return this.copyFromFloats(e,e,e,e)}add(e){return new s(this._x+e._x,this._y+e._y,this._z+e._z,this._w+e._w)}addInPlace(e){return this._x+=e._x,this._y+=e._y,this._z+=e._z,this._w+=e._w,this._isDirty=!0,this}addToRef(e,t){return t._x=this._x+e._x,t._y=this._y+e._y,t._z=this._z+e._z,t._w=this._w+e._w,t._isDirty=!0,t}addInPlaceFromFloats(e,t,i,r){return this._x+=e,this._y+=t,this._z+=i,this._w+=r,this._isDirty=!0,this}subtractToRef(e,t){return t._x=this._x-e._x,t._y=this._y-e._y,t._z=this._z-e._z,t._w=this._w-e._w,t._isDirty=!0,t}subtractFromFloats(e,t,i,r){return this.subtractFromFloatsToRef(e,t,i,r,new s)}subtractFromFloatsToRef(e,t,i,r,n){return n._x=this._x-e,n._y=this._y-t,n._z=this._z-i,n._w=this._w-r,n._isDirty=!0,n}subtract(e){return new s(this._x-e._x,this._y-e._y,this._z-e._z,this._w-e._w)}subtractInPlace(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._w-=e._w,this._isDirty=!0,this}scale(e){return new s(this._x*e,this._y*e,this._z*e,this._w*e)}scaleToRef(e,t){return t._x=this._x*e,t._y=this._y*e,t._z=this._z*e,t._w=this._w*e,t._isDirty=!0,t}scaleInPlace(e){return this._x*=e,this._y*=e,this._z*=e,this._w*=e,this._isDirty=!0,this}scaleAndAddToRef(e,t){return t._x+=this._x*e,t._y+=this._y*e,t._z+=this._z*e,t._w+=this._w*e,t._isDirty=!0,t}multiply(e){let t=new s(0,0,0,1);return this.multiplyToRef(e,t),t}multiplyToRef(e,t){let i=this._x*e._w+this._y*e._z-this._z*e._y+this._w*e._x,r=-this._x*e._z+this._y*e._w+this._z*e._x+this._w*e._y,n=this._x*e._y-this._y*e._x+this._z*e._w+this._w*e._z,a=-this._x*e._x-this._y*e._y-this._z*e._z+this._w*e._w;return t.copyFromFloats(i,r,n,a),t}multiplyInPlace(e){return this.multiplyToRef(e,this)}multiplyByFloats(e,t,i,r){return this._x*=e,this._y*=t,this._z*=i,this._w*=r,this._isDirty=!0,this}divide(e){throw new ReferenceError("Can not divide a quaternion")}divideToRef(e,t){throw new ReferenceError("Can not divide a quaternion")}divideInPlace(e){throw new ReferenceError("Can not divide a quaternion")}minimizeInPlace(){throw new ReferenceError("Can not minimize a quaternion")}minimizeInPlaceFromFloats(){throw new ReferenceError("Can not minimize a quaternion")}maximizeInPlace(){throw new ReferenceError("Can not maximize a quaternion")}maximizeInPlaceFromFloats(){throw new ReferenceError("Can not maximize a quaternion")}negate(){return this.negateToRef(new s)}negateInPlace(){return this._x=-this._x,this._y=-this._y,this._z=-this._z,this._w=-this._w,this._isDirty=!0,this}negateToRef(e){return e._x=-this._x,e._y=-this._y,e._z=-this._z,e._w=-this._w,e._isDirty=!0,e}equalsToFloats(e,t,i,r){return this._x===e&&this._y===t&&this._z===i&&this._w===r}floorToRef(e){throw new ReferenceError("Can not floor a quaternion")}floor(){throw new ReferenceError("Can not floor a quaternion")}fractToRef(e){throw new ReferenceError("Can not fract a quaternion")}fract(){throw new ReferenceError("Can not fract a quaternion")}conjugateToRef(e){return e.copyFromFloats(-this._x,-this._y,-this._z,this._w),e}conjugateInPlace(){return this._x*=-1,this._y*=-1,this._z*=-1,this._isDirty=!0,this}conjugate(){return new s(-this._x,-this._y,-this._z,this._w)}invert(){let e=this.conjugate(),t=this.lengthSquared();return t==0||t==1||e.scaleInPlace(1/t),e}invertInPlace(){this.conjugateInPlace();let e=this.lengthSquared();return e==0||e==1?this:(this.scaleInPlace(1/e),this)}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this.lengthSquared())}normalize(){return this.normalizeFromLength(this.length())}normalizeFromLength(e){return e===0||e===1?this:this.scaleInPlace(1/e)}normalizeToNew(){let e=new s(0,0,0,1);return this.normalizeToRef(e),e}normalizeToRef(e){let t=this.length();return t===0||t===1?e.copyFromFloats(this._x,this._y,this._z,this._w):this.scaleToRef(1/t,e)}toEulerAngles(){let e=E.Zero();return this.toEulerAnglesToRef(e),e}toEulerAnglesToRef(e){let t=this._z,i=this._x,r=this._y,n=this._w,a=r*t-i*n,o=.4999999;if(a<-o)e._y=2*Math.atan2(r,n),e._x=Math.PI/2,e._z=0,e._isDirty=!0;else if(a>o)e._y=2*Math.atan2(r,n),e._x=-Math.PI/2,e._z=0,e._isDirty=!0;else{let l=n*n,c=t*t,f=i*i,h=r*r;e._z=Math.atan2(2*(i*r+t*n),-c-f+h+l),e._x=Math.asin(-2*a),e._y=Math.atan2(2*(t*i+r*n),c-f-h+l),e._isDirty=!0}return e}toAlphaBetaGammaToRef(e){let t=this._z,i=this._x,r=this._y,n=this._w,a=Math.sqrt(i*i+r*r),o=Math.sqrt(t*t+n*n),l=2*Math.atan2(a,o),c=2*Math.atan2(t,n),f=2*Math.atan2(r,i),h=(c+f)/2,u=(c-f)/2;return e.set(u,l,h),e}toRotationMatrix(e){return B.FromQuaternionToRef(this,e),e}fromRotationMatrix(e){return s.FromRotationMatrixToRef(e,this),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}toAxisAngle(){let e=E.Zero(),t=this.toAxisAngleToRef(e);return{axis:e,angle:t}}toAxisAngleToRef(e){let t=0,i=Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z),r=this._w;return i>0?(t=2*Math.atan2(i,r),e.set(this._x/i,this._y/i,this._z/i)):(t=0,e.set(1,0,0)),t}static FromRotationMatrix(e){let t=new s;return s.FromRotationMatrixToRef(e,t),t}static FromRotationMatrixToRef(e,t){let i=e.m,r=i[0],n=i[4],a=i[8],o=i[1],l=i[5],c=i[9],f=i[2],h=i[6],u=i[10],d=r+l+u,p;return d>0?(p=.5/Math.sqrt(d+1),t._w=.25/p,t._x=(h-c)*p,t._y=(a-f)*p,t._z=(o-n)*p,t._isDirty=!0):r>l&&r>u?(p=2*Math.sqrt(1+r-l-u),t._w=(h-c)/p,t._x=.25*p,t._y=(n+o)/p,t._z=(a+f)/p,t._isDirty=!0):l>u?(p=2*Math.sqrt(1+l-r-u),t._w=(a-f)/p,t._x=(n+o)/p,t._y=.25*p,t._z=(c+h)/p,t._isDirty=!0):(p=2*Math.sqrt(1+u-r-l),t._w=(o-n)/p,t._x=(a+f)/p,t._y=(c+h)/p,t._z=.25*p,t._isDirty=!0),t}static Dot(e,t){return e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w}static AreClose(e,t,i=.1){let r=s.Dot(e,t);return 1-r*r<=i}static SmoothToRef(e,t,i,r,n){let a=r===0?1:i/r;return a=Fe(a,0,1),s.SlerpToRef(e,t,a,n),n}static Zero(){return new s(0,0,0,0)}static Inverse(e){return new s(-e._x,-e._y,-e._z,e._w)}static InverseToRef(e,t){return t.set(-e._x,-e._y,-e._z,e._w),t}static Identity(){return new s(0,0,0,1)}static IsIdentity(e){return e&&e._x===0&&e._y===0&&e._z===0&&e._w===1}static RotationAxis(e,t){return s.RotationAxisToRef(e,t,new s)}static RotationAxisToRef(e,t,i){i._w=Math.cos(t/2);let r=Math.sin(t/2)/e.length();return i._x=e._x*r,i._y=e._y*r,i._z=e._z*r,i._isDirty=!0,i}static FromArray(e,t){return t||(t=0),new s(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t,i){return i._x=e[t],i._y=e[t+1],i._z=e[t+2],i._w=e[t+3],i._isDirty=!0,i}static FromFloatsToRef(e,t,i,r,n){return n.copyFromFloats(e,t,i,r),n}static FromEulerAngles(e,t,i){let r=new s;return s.RotationYawPitchRollToRef(t,e,i,r),r}static FromEulerAnglesToRef(e,t,i,r){return s.RotationYawPitchRollToRef(t,e,i,r),r}static FromEulerVector(e){let t=new s;return s.RotationYawPitchRollToRef(e._y,e._x,e._z,t),t}static FromEulerVectorToRef(e,t){return s.RotationYawPitchRollToRef(e._y,e._x,e._z,t),t}static FromUnitVectorsToRef(e,t,i,r=We){let n=E.Dot(e,t)+1;return n<r?Math.abs(e.x)>Math.abs(e.z)?i.set(-e.y,e.x,0,0):i.set(0,-e.z,e.y,0):(E.CrossToRef(e,t,w.Vector3[0]),i.set(w.Vector3[0].x,w.Vector3[0].y,w.Vector3[0].z,n)),i.normalize()}static RotationYawPitchRoll(e,t,i){let r=new s;return s.RotationYawPitchRollToRef(e,t,i,r),r}static RotationYawPitchRollToRef(e,t,i,r){let n=i*.5,a=t*.5,o=e*.5,l=Math.sin(n),c=Math.cos(n),f=Math.sin(a),h=Math.cos(a),u=Math.sin(o),d=Math.cos(o);return r._x=d*f*c+u*h*l,r._y=u*h*c-d*f*l,r._z=d*h*l-u*f*c,r._w=d*h*c+u*f*l,r._isDirty=!0,r}static RotationAlphaBetaGamma(e,t,i){let r=new s;return s.RotationAlphaBetaGammaToRef(e,t,i,r),r}static RotationAlphaBetaGammaToRef(e,t,i,r){let n=(i+e)*.5,a=(i-e)*.5,o=t*.5;return r._x=Math.cos(a)*Math.sin(o),r._y=Math.sin(a)*Math.sin(o),r._z=Math.sin(n)*Math.cos(o),r._w=Math.cos(n)*Math.cos(o),r._isDirty=!0,r}static RotationQuaternionFromAxis(e,t,i){let r=new s(0,0,0,0);return s.RotationQuaternionFromAxisToRef(e,t,i,r),r}static RotationQuaternionFromAxisToRef(e,t,i,r){let n=le.Matrix[0];return e=e.normalizeToRef(le.Vector3[0]),t=t.normalizeToRef(le.Vector3[1]),i=i.normalizeToRef(le.Vector3[2]),B.FromXYZAxesToRef(e,t,i,n),s.FromRotationMatrixToRef(n,r),r}static FromLookDirectionLH(e,t){let i=new s;return s.FromLookDirectionLHToRef(e,t,i),i}static FromLookDirectionLHToRef(e,t,i){let r=le.Matrix[0];return B.LookDirectionLHToRef(e,t,r),s.FromRotationMatrixToRef(r,i),i}static FromLookDirectionRH(e,t){let i=new s;return s.FromLookDirectionRHToRef(e,t,i),i}static FromLookDirectionRHToRef(e,t,i){let r=le.Matrix[0];return B.LookDirectionRHToRef(e,t,r),s.FromRotationMatrixToRef(r,i)}static Slerp(e,t,i){let r=s.Identity();return s.SlerpToRef(e,t,i,r),r}static SlerpToRef(e,t,i,r){let n,a,o=e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w,l=!1;if(o<0&&(l=!0,o=-o),o>.999999)a=1-i,n=l?-i:i;else{let c=Math.acos(o),f=1/Math.sin(c);a=Math.sin((1-i)*c)*f,n=l?-Math.sin(i*c)*f:Math.sin(i*c)*f}return r._x=a*e._x+n*t._x,r._y=a*e._y+n*t._y,r._z=a*e._z+n*t._z,r._w=a*e._w+n*t._w,r._isDirty=!0,r}static Hermite(e,t,i,r,n){let a=n*n,o=n*a,l=2*o-3*a+1,c=-2*o+3*a,f=o-2*a+n,h=o-a,u=e._x*l+i._x*c+t._x*f+r._x*h,d=e._y*l+i._y*c+t._y*f+r._y*h,p=e._z*l+i._z*c+t._z*f+r._z*h,m=e._w*l+i._w*c+t._w*f+r._w*h;return new s(u,d,p,m)}static Hermite1stDerivative(e,t,i,r,n){let a=new s;return this.Hermite1stDerivativeToRef(e,t,i,r,n,a),a}static Hermite1stDerivativeToRef(e,t,i,r,n,a){let o=n*n;return a._x=(o-n)*6*e._x+(3*o-4*n+1)*t._x+(-o+n)*6*i._x+(3*o-2*n)*r._x,a._y=(o-n)*6*e._y+(3*o-4*n+1)*t._y+(-o+n)*6*i._y+(3*o-2*n)*r._y,a._z=(o-n)*6*e._z+(3*o-4*n+1)*t._z+(-o+n)*6*i._z+(3*o-2*n)*r._z,a._w=(o-n)*6*e._w+(3*o-4*n+1)*t._w+(-o+n)*6*i._w+(3*o-2*n)*r._w,a._isDirty=!0,a}static Normalize(e){let t=s.Zero();return s.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Clamp(e,t,i){let r=new s;return s.ClampToRef(e,t,i,r),r}static ClampToRef(e,t,i,r){return r.copyFromFloats(Fe(e.x,t.x,i.x),Fe(e.y,t.y,i.y),Fe(e.z,t.z,i.z),Fe(e.w,t.w,i.w))}static Random(e=0,t=1){return new s(bt(e,t),bt(e,t),bt(e,t),bt(e,t))}static RandomToRef(e=0,t=1,i){return i.copyFromFloats(bt(e,t),bt(e,t),bt(e,t),bt(e,t))}static Minimize(){throw new ReferenceError("Quaternion.Minimize does not make sense")}static Maximize(){throw new ReferenceError("Quaternion.Maximize does not make sense")}static Distance(e,t){return Math.sqrt(s.DistanceSquared(e,t))}static DistanceSquared(e,t){let i=e.x-t.x,r=e.y-t.y,n=e.z-t.z,a=e.w-t.w;return i*i+r*r+n*n+a*a}static Center(e,t){return s.CenterToRef(e,t,s.Zero())}static CenterToRef(e,t,i){return i.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2,(e.z+t.z)/2,(e.w+t.w)/2)}};K._V8PerformanceHack=new K(.5,.5,.5,.5);Object.defineProperties(K.prototype,{dimension:{value:[4]},rank:{value:1}});B=class s{static get Use64Bits(){return Ar.MatrixUse64Bits}get m(){return this._m}markAsUpdated(){this.updateFlag=bh._UpdateFlagSeed++,this._isIdentity=!1,this._isIdentity3x2=!1,this._isIdentityDirty=!0,this._isIdentity3x2Dirty=!0}_updateIdentityStatus(e,t=!1,i=!1,r=!0){this._isIdentity=e,this._isIdentity3x2=e||i,this._isIdentityDirty=this._isIdentity?!1:t,this._isIdentity3x2Dirty=this._isIdentity3x2?!1:r}constructor(){this._isIdentity=!1,this._isIdentityDirty=!0,this._isIdentity3x2=!0,this._isIdentity3x2Dirty=!0,this.updateFlag=-1,Ar.MatrixTrackPrecisionChange&&Ar.MatrixTrackedMatrices.push(this),this._m=new Ar.MatrixCurrentType(16),this.markAsUpdated()}isIdentity(){if(this._isIdentityDirty){this._isIdentityDirty=!1;let e=this._m;this._isIdentity=e[0]===1&&e[1]===0&&e[2]===0&&e[3]===0&&e[4]===0&&e[5]===1&&e[6]===0&&e[7]===0&&e[8]===0&&e[9]===0&&e[10]===1&&e[11]===0&&e[12]===0&&e[13]===0&&e[14]===0&&e[15]===1}return this._isIdentity}isIdentityAs3x2(){return this._isIdentity3x2Dirty&&(this._isIdentity3x2Dirty=!1,this._m[0]!==1||this._m[5]!==1||this._m[15]!==1?this._isIdentity3x2=!1:this._m[1]!==0||this._m[2]!==0||this._m[3]!==0||this._m[4]!==0||this._m[6]!==0||this._m[7]!==0||this._m[8]!==0||this._m[9]!==0||this._m[10]!==0||this._m[11]!==0||this._m[12]!==0||this._m[13]!==0||this._m[14]!==0?this._isIdentity3x2=!1:this._isIdentity3x2=!0),this._isIdentity3x2}determinant(){if(this._isIdentity===!0)return 1;let e=this._m,t=e[0],i=e[1],r=e[2],n=e[3],a=e[4],o=e[5],l=e[6],c=e[7],f=e[8],h=e[9],u=e[10],d=e[11],p=e[12],m=e[13],_=e[14],v=e[15],T=u*v-_*d,C=h*v-m*d,I=h*_-m*u,R=f*v-p*d,b=f*_-u*p,M=f*m-p*h,F=+(o*T-l*C+c*I),U=-(a*T-l*R+c*b),D=+(a*C-o*R+c*M),$=-(a*I-o*b+l*M);return t*F+i*U+r*D+n*$}toString(){return`{${this.m[0]}, ${this.m[1]}, ${this.m[2]}, ${this.m[3]}
${this.m[4]}, ${this.m[5]}, ${this.m[6]}, ${this.m[7]}
${this.m[8]}, ${this.m[9]}, ${this.m[10]}, ${this.m[11]}
${this.m[12]}, ${this.m[13]}, ${this.m[14]}, ${this.m[15]}}`}toArray(e=null,t=0){if(!e)return this._m;let i=this._m;for(let r=0;r<16;r++)e[t+r]=i[r];return this}asArray(){return this._m}fromArray(e,t=0){return s.FromArrayToRef(e,t,this)}copyFromFloats(...e){return s.FromArrayToRef(e,0,this)}set(...e){let t=this._m;for(let i=0;i<16;i++)t[i]=e[i];return this.markAsUpdated(),this}setAll(e){let t=this._m;for(let i=0;i<16;i++)t[i]=e;return this.markAsUpdated(),this}invert(){return this.invertToRef(this),this}reset(){return s.FromValuesToRef(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,this),this._updateIdentityStatus(!1),this}add(e){let t=new s;return this.addToRef(e,t),t}addToRef(e,t){let i=this._m,r=t._m,n=e.m;for(let a=0;a<16;a++)r[a]=i[a]+n[a];return t.markAsUpdated(),t}addToSelf(e){let t=this._m,i=e.m;return t[0]+=i[0],t[1]+=i[1],t[2]+=i[2],t[3]+=i[3],t[4]+=i[4],t[5]+=i[5],t[6]+=i[6],t[7]+=i[7],t[8]+=i[8],t[9]+=i[9],t[10]+=i[10],t[11]+=i[11],t[12]+=i[12],t[13]+=i[13],t[14]+=i[14],t[15]+=i[15],this.markAsUpdated(),this}addInPlace(e){let t=this._m,i=e.m;for(let r=0;r<16;r++)t[r]+=i[r];return this.markAsUpdated(),this}addInPlaceFromFloats(...e){let t=this._m;for(let i=0;i<16;i++)t[i]+=e[i];return this.markAsUpdated(),this}subtract(e){let t=this._m,i=e.m;for(let r=0;r<16;r++)t[r]-=i[r];return this.markAsUpdated(),this}subtractToRef(e,t){let i=this._m,r=e.m,n=t._m;for(let a=0;a<16;a++)n[a]=i[a]-r[a];return t.markAsUpdated(),t}subtractInPlace(e){let t=this._m,i=e.m;for(let r=0;r<16;r++)t[r]-=i[r];return this.markAsUpdated(),this}subtractFromFloats(...e){return this.subtractFromFloatsToRef(...e,new s)}subtractFromFloatsToRef(...e){let t=e.pop(),i=this._m,r=t._m,n=e;for(let a=0;a<16;a++)r[a]=i[a]-n[a];return t.markAsUpdated(),t}invertToRef(e){return this._isIdentity===!0?(s.IdentityToRef(e),e):(yD(this,e.asArray())?e.markAsUpdated():e.copyFrom(this),e)}addAtIndex(e,t){return this._m[e]+=t,this.markAsUpdated(),this}multiplyAtIndex(e,t){return this._m[e]*=t,this.markAsUpdated(),this}setTranslationFromFloats(e,t,i){return this._m[12]=e,this._m[13]=t,this._m[14]=i,this.markAsUpdated(),this}addTranslationFromFloats(e,t,i){return this._m[12]+=e,this._m[13]+=t,this._m[14]+=i,this.markAsUpdated(),this}setTranslation(e){return this.setTranslationFromFloats(e._x,e._y,e._z)}getTranslation(){return new E(this._m[12],this._m[13],this._m[14])}getTranslationToRef(e){return e.x=this._m[12],e.y=this._m[13],e.z=this._m[14],e}removeRotationAndScaling(){let e=this.m;return s.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e[12],e[13],e[14],e[15],this),this._updateIdentityStatus(e[12]===0&&e[13]===0&&e[14]===0&&e[15]===1),this}copyFrom(e){e.copyToArray(this._m);let t=e;return this.updateFlag=t.updateFlag,this._updateIdentityStatus(t._isIdentity,t._isIdentityDirty,t._isIdentity3x2,t._isIdentity3x2Dirty),this}copyToArray(e,t=0){return ID(this,e,t),this}multiply(e){let t=new s;return this.multiplyToRef(e,t),t}multiplyInPlace(e){let t=this._m,i=e.m;for(let r=0;r<16;r++)t[r]*=i[r];return this.markAsUpdated(),this}multiplyByFloats(...e){let t=this._m;for(let i=0;i<16;i++)t[i]*=e[i];return this.markAsUpdated(),this}multiplyByFloatsToRef(...e){let t=e.pop(),i=this._m,r=t._m,n=e;for(let a=0;a<16;a++)r[a]=i[a]*n[a];return t.markAsUpdated(),t}multiplyToRef(e,t){return this._isIdentity?(t.copyFrom(e),t):e._isIdentity?(t.copyFrom(this),t):(this.multiplyToArray(e,t._m,0),t.markAsUpdated(),t)}multiplyToArray(e,t,i){return CD(this,e,t,i),this}divide(e){return this.divideToRef(e,new s)}divideToRef(e,t){let i=this._m,r=e.m,n=t._m;for(let a=0;a<16;a++)n[a]=i[a]/r[a];return t.markAsUpdated(),t}divideInPlace(e){let t=this._m,i=e.m;for(let r=0;r<16;r++)t[r]/=i[r];return this.markAsUpdated(),this}minimizeInPlace(e){let t=this._m,i=e.m;for(let r=0;r<16;r++)t[r]=Math.min(t[r],i[r]);return this.markAsUpdated(),this}minimizeInPlaceFromFloats(...e){let t=this._m;for(let i=0;i<16;i++)t[i]=Math.min(t[i],e[i]);return this.markAsUpdated(),this}maximizeInPlace(e){let t=this._m,i=e.m;for(let r=0;r<16;r++)t[r]=Math.min(t[r],i[r]);return this.markAsUpdated(),this}maximizeInPlaceFromFloats(...e){let t=this._m;for(let i=0;i<16;i++)t[i]=Math.min(t[i],e[i]);return this.markAsUpdated(),this}negate(){return this.negateToRef(new s)}negateInPlace(){let e=this._m;for(let t=0;t<16;t++)e[t]=-e[t];return this.markAsUpdated(),this}negateToRef(e){let t=this._m,i=e._m;for(let r=0;r<16;r++)i[r]=-t[r];return e.markAsUpdated(),e}equals(e){let t=e;if(!t)return!1;if((this._isIdentity||t._isIdentity)&&!this._isIdentityDirty&&!t._isIdentityDirty)return this._isIdentity&&t._isIdentity;let i=this.m,r=t.m;return i[0]===r[0]&&i[1]===r[1]&&i[2]===r[2]&&i[3]===r[3]&&i[4]===r[4]&&i[5]===r[5]&&i[6]===r[6]&&i[7]===r[7]&&i[8]===r[8]&&i[9]===r[9]&&i[10]===r[10]&&i[11]===r[11]&&i[12]===r[12]&&i[13]===r[13]&&i[14]===r[14]&&i[15]===r[15]}equalsWithEpsilon(e,t=0){let i=this._m,r=e.m;for(let n=0;n<16;n++)if(!Rt(i[n],r[n],t))return!1;return!0}equalsToFloats(...e){let t=this._m;for(let i=0;i<16;i++)if(t[i]!=e[i])return!1;return!0}floor(){return this.floorToRef(new s)}floorToRef(e){let t=this._m,i=e._m;for(let r=0;r<16;r++)i[r]=Math.floor(t[r]);return e.markAsUpdated(),e}fract(){return this.fractToRef(new s)}fractToRef(e){let t=this._m,i=e._m;for(let r=0;r<16;r++)i[r]=t[r]-Math.floor(t[r]);return e.markAsUpdated(),e}clone(){let e=new s;return e.copyFrom(this),e}getClassName(){return"Matrix"}getHashCode(){let e=Rr(this._m[0]);for(let t=1;t<16;t++)e=e*397^Rr(this._m[t]);return e}decomposeToTransformNode(e){return e.rotationQuaternion=e.rotationQuaternion||new K,this.decompose(e.scaling,e.rotationQuaternion,e.position)}decompose(e,t,i,r,n=!0){if(this._isIdentity)return i&&i.setAll(0),e&&e.setAll(1),t&&t.copyFromFloats(0,0,0,1),!0;let a=this._m;if(i&&i.copyFromFloats(a[12],a[13],a[14]),e=e||le.Vector3[0],e.x=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]),e.y=Math.sqrt(a[4]*a[4]+a[5]*a[5]+a[6]*a[6]),e.z=Math.sqrt(a[8]*a[8]+a[9]*a[9]+a[10]*a[10]),r){let o=(n?r.absoluteScaling.x:r.scaling.x)<0?-1:1,l=(n?r.absoluteScaling.y:r.scaling.y)<0?-1:1,c=(n?r.absoluteScaling.z:r.scaling.z)<0?-1:1;e.x*=o,e.y*=l,e.z*=c}else this.determinant()<=0&&(e.y*=-1);if(e._x===0||e._y===0||e._z===0)return t&&t.copyFromFloats(0,0,0,1),!1;if(t){let o=1/e._x,l=1/e._y,c=1/e._z;s.FromValuesToRef(a[0]*o,a[1]*o,a[2]*o,0,a[4]*l,a[5]*l,a[6]*l,0,a[8]*c,a[9]*c,a[10]*c,0,0,0,0,1,le.Matrix[0]),K.FromRotationMatrixToRef(le.Matrix[0],t)}return!0}getRow(e){if(e<0||e>3)return null;let t=e*4;return new Oe(this._m[t+0],this._m[t+1],this._m[t+2],this._m[t+3])}getRowToRef(e,t){if(e>=0&&e<=3){let i=e*4;t.x=this._m[i+0],t.y=this._m[i+1],t.z=this._m[i+2],t.w=this._m[i+3]}return t}setRow(e,t){return this.setRowFromFloats(e,t.x,t.y,t.z,t.w)}transpose(){let e=new s;return s.TransposeToRef(this,e),e}transposeToRef(e){return s.TransposeToRef(this,e),e}setRowFromFloats(e,t,i,r,n){if(e<0||e>3)return this;let a=e*4;return this._m[a+0]=t,this._m[a+1]=i,this._m[a+2]=r,this._m[a+3]=n,this.markAsUpdated(),this}scale(e){let t=new s;return this.scaleToRef(e,t),t}scaleToRef(e,t){for(let i=0;i<16;i++)t._m[i]=this._m[i]*e;return t.markAsUpdated(),t}scaleAndAddToRef(e,t){for(let i=0;i<16;i++)t._m[i]+=this._m[i]*e;return t.markAsUpdated(),t}scaleInPlace(e){let t=this._m;for(let i=0;i<16;i++)t[i]*=e;return this.markAsUpdated(),this}toNormalMatrix(e){let t=le.Matrix[0];this.invertToRef(t),t.transposeToRef(e);let i=e._m;return s.FromValuesToRef(i[0],i[1],i[2],0,i[4],i[5],i[6],0,i[8],i[9],i[10],0,0,0,0,1,e),e}getRotationMatrix(){let e=new s;return this.getRotationMatrixToRef(e),e}getRotationMatrixToRef(e){let t=le.Vector3[0];if(!this.decompose(t))return s.IdentityToRef(e),e;let i=this._m,r=1/t._x,n=1/t._y,a=1/t._z;return s.FromValuesToRef(i[0]*r,i[1]*r,i[2]*r,0,i[4]*n,i[5]*n,i[6]*n,0,i[8]*a,i[9]*a,i[10]*a,0,0,0,0,1,e),e}toggleModelMatrixHandInPlace(){let e=this._m;return e[2]*=-1,e[6]*=-1,e[8]*=-1,e[9]*=-1,e[14]*=-1,this.markAsUpdated(),this}toggleProjectionMatrixHandInPlace(){let e=this._m;return e[8]*=-1,e[9]*=-1,e[10]*=-1,e[11]*=-1,this.markAsUpdated(),this}static FromArray(e,t=0){let i=new s;return s.FromArrayToRef(e,t,i),i}static FromArrayToRef(e,t,i){for(let r=0;r<16;r++)i._m[r]=e[r+t];return i.markAsUpdated(),i}static FromFloat32ArrayToRefScaled(e,t,i,r){return r._m[0]=e[0+t]*i,r._m[1]=e[1+t]*i,r._m[2]=e[2+t]*i,r._m[3]=e[3+t]*i,r._m[4]=e[4+t]*i,r._m[5]=e[5+t]*i,r._m[6]=e[6+t]*i,r._m[7]=e[7+t]*i,r._m[8]=e[8+t]*i,r._m[9]=e[9+t]*i,r._m[10]=e[10+t]*i,r._m[11]=e[11+t]*i,r._m[12]=e[12+t]*i,r._m[13]=e[13+t]*i,r._m[14]=e[14+t]*i,r._m[15]=e[15+t]*i,r.markAsUpdated(),r}static get IdentityReadOnly(){return s._IdentityReadOnly}static FromValuesToRef(e,t,i,r,n,a,o,l,c,f,h,u,d,p,m,_,v){let T=v._m;T[0]=e,T[1]=t,T[2]=i,T[3]=r,T[4]=n,T[5]=a,T[6]=o,T[7]=l,T[8]=c,T[9]=f,T[10]=h,T[11]=u,T[12]=d,T[13]=p,T[14]=m,T[15]=_,v.markAsUpdated()}static FromValues(e,t,i,r,n,a,o,l,c,f,h,u,d,p,m,_){let v=new s,T=v._m;return T[0]=e,T[1]=t,T[2]=i,T[3]=r,T[4]=n,T[5]=a,T[6]=o,T[7]=l,T[8]=c,T[9]=f,T[10]=h,T[11]=u,T[12]=d,T[13]=p,T[14]=m,T[15]=_,v.markAsUpdated(),v}static Compose(e,t,i){let r=new s;return s.ComposeToRef(e,t,i,r),r}static ComposeToRef(e,t,i,r){let n=r._m,a=t._x,o=t._y,l=t._z,c=t._w,f=a+a,h=o+o,u=l+l,d=a*f,p=a*h,m=a*u,_=o*h,v=o*u,T=l*u,C=c*f,I=c*h,R=c*u,b=e._x,M=e._y,F=e._z;return n[0]=(1-(_+T))*b,n[1]=(p+R)*b,n[2]=(m-I)*b,n[3]=0,n[4]=(p-R)*M,n[5]=(1-(d+T))*M,n[6]=(v+C)*M,n[7]=0,n[8]=(m+I)*F,n[9]=(v-C)*F,n[10]=(1-(d+_))*F,n[11]=0,n[12]=i._x,n[13]=i._y,n[14]=i._z,n[15]=1,r.markAsUpdated(),r}static Identity(){let e=s.FromValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);return e._updateIdentityStatus(!0),e}static IdentityToRef(e){return s.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,e),e._updateIdentityStatus(!0),e}static Zero(){let e=s.FromValues(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);return e._updateIdentityStatus(!1),e}static RotationX(e){let t=new s;return s.RotationXToRef(e,t),t}static Invert(e){let t=new s;return e.invertToRef(t),t}static RotationXToRef(e,t){let i=Math.sin(e),r=Math.cos(e);return s.FromValuesToRef(1,0,0,0,0,r,i,0,0,-i,r,0,0,0,0,1,t),t._updateIdentityStatus(r===1&&i===0),t}static RotationY(e){let t=new s;return s.RotationYToRef(e,t),t}static RotationYToRef(e,t){let i=Math.sin(e),r=Math.cos(e);return s.FromValuesToRef(r,0,-i,0,0,1,0,0,i,0,r,0,0,0,0,1,t),t._updateIdentityStatus(r===1&&i===0),t}static RotationZ(e){let t=new s;return s.RotationZToRef(e,t),t}static RotationZToRef(e,t){let i=Math.sin(e),r=Math.cos(e);return s.FromValuesToRef(r,i,0,0,-i,r,0,0,0,0,1,0,0,0,0,1,t),t._updateIdentityStatus(r===1&&i===0),t}static RotationAxis(e,t){let i=new s;return s.RotationAxisToRef(e,t,i),i}static RotationAxisToRef(e,t,i){let r=Math.sin(-t),n=Math.cos(-t),a=1-n;e=e.normalizeToRef(le.Vector3[0]);let o=i._m;return o[0]=e._x*e._x*a+n,o[1]=e._x*e._y*a-e._z*r,o[2]=e._x*e._z*a+e._y*r,o[3]=0,o[4]=e._y*e._x*a+e._z*r,o[5]=e._y*e._y*a+n,o[6]=e._y*e._z*a-e._x*r,o[7]=0,o[8]=e._z*e._x*a-e._y*r,o[9]=e._z*e._y*a+e._x*r,o[10]=e._z*e._z*a+n,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,i.markAsUpdated(),i}static RotationAlignToRef(e,t,i,r=!1){let n=E.Dot(t,e),a=i._m;if(n<-1+We)a[0]=-1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=r?1:-1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=r?-1:1,a[11]=0;else{let o=E.Cross(t,e),l=1/(1+n);a[0]=o._x*o._x*l+n,a[1]=o._y*o._x*l-o._z,a[2]=o._z*o._x*l+o._y,a[3]=0,a[4]=o._x*o._y*l+o._z,a[5]=o._y*o._y*l+n,a[6]=o._z*o._y*l-o._x,a[7]=0,a[8]=o._x*o._z*l-o._y,a[9]=o._y*o._z*l+o._x,a[10]=o._z*o._z*l+n,a[11]=0}return a[12]=0,a[13]=0,a[14]=0,a[15]=1,i.markAsUpdated(),i}static RotationYawPitchRoll(e,t,i){let r=new s;return s.RotationYawPitchRollToRef(e,t,i,r),r}static RotationYawPitchRollToRef(e,t,i,r){return K.RotationYawPitchRollToRef(e,t,i,le.Quaternion[0]),le.Quaternion[0].toRotationMatrix(r),r}static Scaling(e,t,i){let r=new s;return s.ScalingToRef(e,t,i,r),r}static ScalingToRef(e,t,i,r){return s.FromValuesToRef(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1,r),r._updateIdentityStatus(e===1&&t===1&&i===1),r}static Translation(e,t,i){let r=new s;return s.TranslationToRef(e,t,i,r),r}static TranslationToRef(e,t,i,r){return s.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e,t,i,1,r),r._updateIdentityStatus(e===0&&t===0&&i===0),r}static Lerp(e,t,i){let r=new s;return s.LerpToRef(e,t,i,r),r}static LerpToRef(e,t,i,r){let n=r._m,a=e.m,o=t.m;for(let l=0;l<16;l++)n[l]=a[l]*(1-i)+o[l]*i;return r.markAsUpdated(),r}static DecomposeLerp(e,t,i){let r=new s;return s.DecomposeLerpToRef(e,t,i,r),r}static DecomposeLerpToRef(e,t,i,r){let n=le.Vector3[0],a=le.Quaternion[0],o=le.Vector3[1];e.decompose(n,a,o);let l=le.Vector3[2],c=le.Quaternion[1],f=le.Vector3[3];t.decompose(l,c,f);let h=le.Vector3[4];E.LerpToRef(n,l,i,h);let u=le.Quaternion[2];K.SlerpToRef(a,c,i,u);let d=le.Vector3[5];return E.LerpToRef(o,f,i,d),s.ComposeToRef(h,u,d,r),r}static LookAtLH(e,t,i){let r=new s;return s.LookAtLHToRef(e,t,i,r),r}static LookAtLHToRef(e,t,i,r){let n=le.Vector3[0],a=le.Vector3[1],o=le.Vector3[2];t.subtractToRef(e,o),o.normalize(),E.CrossToRef(i,o,n);let l=n.lengthSquared();l===0?n.x=1:n.normalizeFromLength(Math.sqrt(l)),E.CrossToRef(o,n,a),a.normalize();let c=-E.Dot(n,e),f=-E.Dot(a,e),h=-E.Dot(o,e);return s.FromValuesToRef(n._x,a._x,o._x,0,n._y,a._y,o._y,0,n._z,a._z,o._z,0,c,f,h,1,r),r}static LookAtRH(e,t,i){let r=new s;return s.LookAtRHToRef(e,t,i,r),r}static LookAtRHToRef(e,t,i,r){let n=le.Vector3[0],a=le.Vector3[1],o=le.Vector3[2];e.subtractToRef(t,o),o.normalize(),E.CrossToRef(i,o,n);let l=n.lengthSquared();l===0?n.x=1:n.normalizeFromLength(Math.sqrt(l)),E.CrossToRef(o,n,a),a.normalize();let c=-E.Dot(n,e),f=-E.Dot(a,e),h=-E.Dot(o,e);return s.FromValuesToRef(n._x,a._x,o._x,0,n._y,a._y,o._y,0,n._z,a._z,o._z,0,c,f,h,1,r),r}static LookDirectionLH(e,t){let i=new s;return s.LookDirectionLHToRef(e,t,i),i}static LookDirectionLHToRef(e,t,i){let r=le.Vector3[0];r.copyFrom(e),r.scaleInPlace(-1);let n=le.Vector3[1];return E.CrossToRef(t,r,n),s.FromValuesToRef(n._x,n._y,n._z,0,t._x,t._y,t._z,0,r._x,r._y,r._z,0,0,0,0,1,i),i}static LookDirectionRH(e,t){let i=new s;return s.LookDirectionRHToRef(e,t,i),i}static LookDirectionRHToRef(e,t,i){let r=le.Vector3[2];return E.CrossToRef(t,e,r),s.FromValuesToRef(r._x,r._y,r._z,0,t._x,t._y,t._z,0,e._x,e._y,e._z,0,0,0,0,1,i),i}static OrthoLH(e,t,i,r,n){let a=new s;return s.OrthoLHToRef(e,t,i,r,a,n),a}static OrthoLHToRef(e,t,i,r,n,a){let o=i,l=r,c=2/e,f=2/t,h=2/(l-o),u=-(l+o)/(l-o);return s.FromValuesToRef(c,0,0,0,0,f,0,0,0,0,h,0,0,0,u,1,n),a&&n.multiplyToRef(hl,n),n._updateIdentityStatus(c===1&&f===1&&h===1&&u===0),n}static OrthoOffCenterLH(e,t,i,r,n,a,o){let l=new s;return s.OrthoOffCenterLHToRef(e,t,i,r,n,a,l,o),l}static OrthoOffCenterLHToRef(e,t,i,r,n,a,o,l){let c=n,f=a,h=2/(t-e),u=2/(r-i),d=2/(f-c),p=-(f+c)/(f-c),m=(e+t)/(e-t),_=(r+i)/(i-r);return s.FromValuesToRef(h,0,0,0,0,u,0,0,0,0,d,0,m,_,p,1,o),l&&o.multiplyToRef(hl,o),o.markAsUpdated(),o}static ObliqueOffCenterLHToRef(e,t,i,r,n,a,o,l,c,f,h){let u=-o*Math.cos(l),d=-o*Math.sin(l);return s.TranslationToRef(0,0,-c,le.Matrix[1]),s.FromValuesToRef(1,0,0,0,0,1,0,0,u,d,1,0,0,0,0,1,le.Matrix[0]),le.Matrix[1].multiplyToRef(le.Matrix[0],le.Matrix[0]),s.TranslationToRef(0,0,c,le.Matrix[1]),le.Matrix[0].multiplyToRef(le.Matrix[1],le.Matrix[0]),s.OrthoOffCenterLHToRef(e,t,i,r,n,a,f,h),le.Matrix[0].multiplyToRef(f,f),f}static OrthoOffCenterRH(e,t,i,r,n,a,o){let l=new s;return s.OrthoOffCenterRHToRef(e,t,i,r,n,a,l,o),l}static OrthoOffCenterRHToRef(e,t,i,r,n,a,o,l){return s.OrthoOffCenterLHToRef(e,t,i,r,n,a,o,l),o._m[10]*=-1,o}static ObliqueOffCenterRHToRef(e,t,i,r,n,a,o,l,c,f,h){let u=o*Math.cos(l),d=o*Math.sin(l);return s.TranslationToRef(0,0,c,le.Matrix[1]),s.FromValuesToRef(1,0,0,0,0,1,0,0,u,d,1,0,0,0,0,1,le.Matrix[0]),le.Matrix[1].multiplyToRef(le.Matrix[0],le.Matrix[0]),s.TranslationToRef(0,0,-c,le.Matrix[1]),le.Matrix[0].multiplyToRef(le.Matrix[1],le.Matrix[0]),s.OrthoOffCenterRHToRef(e,t,i,r,n,a,f,h),le.Matrix[0].multiplyToRef(f,f),f}static PerspectiveLH(e,t,i,r,n,a=0){let o=new s,l=i,c=r,f=2*l/e,h=2*l/t,u=(c+l)/(c-l),d=-2*c*l/(c-l),p=Math.tan(a);return s.FromValuesToRef(f,0,0,0,0,h,0,p,0,0,u,1,0,0,d,0,o),n&&o.multiplyToRef(hl,o),o._updateIdentityStatus(!1),o}static PerspectiveFovLH(e,t,i,r,n,a=0,o=!1){let l=new s;return s.PerspectiveFovLHToRef(e,t,i,r,l,!0,n,a,o),l}static PerspectiveFovLHToRef(e,t,i,r,n,a=!0,o,l=0,c=!1){let f=i,h=r,u=1/Math.tan(e*.5),d=a?u/t:u,p=a?u:u*t,m=c&&f===0?-1:h!==0?(h+f)/(h-f):1,_=c&&f===0?2*h:h!==0?-2*h*f/(h-f):-2*f,v=Math.tan(l);return s.FromValuesToRef(d,0,0,0,0,p,0,v,0,0,m,1,0,0,_,0,n),o&&n.multiplyToRef(hl,n),n._updateIdentityStatus(!1),n}static PerspectiveFovReverseLHToRef(e,t,i,r,n,a=!0,o,l=0){let c=1/Math.tan(e*.5),f=a?c/t:c,h=a?c:c*t,u=Math.tan(l);return s.FromValuesToRef(f,0,0,0,0,h,0,u,0,0,-i,1,0,0,1,0,n),o&&n.multiplyToRef(hl,n),n._updateIdentityStatus(!1),n}static PerspectiveFovRH(e,t,i,r,n,a=0,o=!1){let l=new s;return s.PerspectiveFovRHToRef(e,t,i,r,l,!0,n,a,o),l}static PerspectiveFovRHToRef(e,t,i,r,n,a=!0,o,l=0,c=!1){let f=i,h=r,u=1/Math.tan(e*.5),d=a?u/t:u,p=a?u:u*t,m=c&&f===0?1:h!==0?-(h+f)/(h-f):-1,_=c&&f===0?2*h:h!==0?-2*h*f/(h-f):-2*f,v=Math.tan(l);return s.FromValuesToRef(d,0,0,0,0,p,0,v,0,0,m,-1,0,0,_,0,n),o&&n.multiplyToRef(hl,n),n._updateIdentityStatus(!1),n}static PerspectiveFovReverseRHToRef(e,t,i,r,n,a=!0,o,l=0){let c=1/Math.tan(e*.5),f=a?c/t:c,h=a?c:c*t,u=Math.tan(l);return s.FromValuesToRef(f,0,0,0,0,h,0,u,0,0,-i,-1,0,0,-1,0,n),o&&n.multiplyToRef(hl,n),n._updateIdentityStatus(!1),n}static GetFinalMatrix(e,t,i,r,n,a){let o=e.width,l=e.height,c=e.x,f=e.y,h=s.FromValues(o/2,0,0,0,0,-l/2,0,0,0,0,a-n,0,c+o/2,l/2+f,n,1),u=new s;return t.multiplyToRef(i,u),u.multiplyToRef(r,u),u.multiplyToRef(h,u)}static GetAsMatrix2x2(e){let t=e.m,i=[t[0],t[1],t[4],t[5]];return Ar.MatrixUse64Bits?i:new Float32Array(i)}static GetAsMatrix3x3(e){let t=e.m,i=[t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10]];return Ar.MatrixUse64Bits?i:new Float32Array(i)}static Transpose(e){let t=new s;return s.TransposeToRef(e,t),t}static TransposeToRef(e,t){let i=e.m,r=i[0],n=i[4],a=i[8],o=i[12],l=i[1],c=i[5],f=i[9],h=i[13],u=i[2],d=i[6],p=i[10],m=i[14],_=i[3],v=i[7],T=i[11],C=i[15],I=t._m;return I[0]=r,I[1]=n,I[2]=a,I[3]=o,I[4]=l,I[5]=c,I[6]=f,I[7]=h,I[8]=u,I[9]=d,I[10]=p,I[11]=m,I[12]=_,I[13]=v,I[14]=T,I[15]=C,t.markAsUpdated(),t._updateIdentityStatus(e._isIdentity,e._isIdentityDirty),t}static Reflection(e){let t=new s;return s.ReflectionToRef(e,t),t}static ReflectionToRef(e,t){e.normalize();let i=e.normal.x,r=e.normal.y,n=e.normal.z,a=-2*i,o=-2*r,l=-2*n;return s.FromValuesToRef(a*i+1,o*i,l*i,0,a*r,o*r+1,l*r,0,a*n,o*n,l*n+1,0,a*e.d,o*e.d,l*e.d,1,t),t}static FromXYZAxesToRef(e,t,i,r){return s.FromValuesToRef(e._x,e._y,e._z,0,t._x,t._y,t._z,0,i._x,i._y,i._z,0,0,0,0,1,r),r}static FromQuaternionToRef(e,t){let i=e._x*e._x,r=e._y*e._y,n=e._z*e._z,a=e._x*e._y,o=e._z*e._w,l=e._z*e._x,c=e._y*e._w,f=e._y*e._z,h=e._x*e._w;return t._m[0]=1-2*(r+n),t._m[1]=2*(a+o),t._m[2]=2*(l-c),t._m[3]=0,t._m[4]=2*(a-o),t._m[5]=1-2*(n+i),t._m[6]=2*(f+h),t._m[7]=0,t._m[8]=2*(l+c),t._m[9]=2*(f-h),t._m[10]=1-2*(r+i),t._m[11]=0,t._m[12]=0,t._m[13]=0,t._m[14]=0,t._m[15]=1,t.markAsUpdated(),t}};B._IdentityReadOnly=B.Identity();Object.defineProperties(B.prototype,{dimension:{value:[4,4]},rank:{value:2}});le=class{};le.Vector3=Ws(11,E.Zero);le.Matrix=Ws(2,B.Identity);le.Quaternion=Ws(3,K.Zero);w=class{};w.Vector2=Ws(3,he.Zero);w.Vector3=Ws(13,E.Zero);w.Vector4=Ws(3,Oe.Zero);w.Quaternion=Ws(3,K.Zero);w.Matrix=Ws(8,B.Identity);G("BABYLON.Vector2",he);G("BABYLON.Vector3",E);G("BABYLON.Vector4",Oe);G("BABYLON.Matrix",B);hl=B.FromValues(1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1)});function pe(s,e=!1){if(!(e&&PD[s]))return PD[s]=!0,`${s} needs to be imported before as it contains a side-effect required by your code.`}var PD,Ii=S(()=>{PD={}});var fp,DD=S(()=>{fp=class s{static Eval(e,t){return e.match(/\([^()]*\)/g)?e=e.replace(/\([^()]*\)/g,i=>(i=i.slice(1,i.length-1),s._HandleParenthesisContent(i,t))):e=s._HandleParenthesisContent(e,t),e==="true"?!0:e==="false"?!1:s.Eval(e,t)}static _HandleParenthesisContent(e,t){t=t||(n=>n==="true");let i,r=e.split("||");for(let n in r)if(Object.prototype.hasOwnProperty.call(r,n)){let a=s._SimplifyNegation(r[n].trim()),o=a.split("&&");if(o.length>1)for(let l=0;l<o.length;++l){let c=s._SimplifyNegation(o[l].trim());if(c!=="true"&&c!=="false"?c[0]==="!"?i=!t(c.substring(1)):i=t(c):i=c==="true",!i){a="false";break}}if(i||a==="true"){i=!0;break}a!=="true"&&a!=="false"?a[0]==="!"?i=!t(a.substring(1)):i=t(a):i=a==="true"}return i?"true":"false"}static _SimplifyNegation(e){return e=e.replace(/^[\s!]+/,t=>(t=t.replace(/[\s]/g,()=>""),t.length%2?"!":"")),e=e.trim(),e==="!true"?e="false":e==="!false"&&(e="true"),e}}});var st,po=S(()=>{DD();st=class s{static EnableFor(e){e._tags=e._tags||{},e.hasTags=()=>s.HasTags(e),e.addTags=t=>s.AddTagsTo(e,t),e.removeTags=t=>s.RemoveTagsFrom(e,t),e.matchesTagsQuery=t=>s.MatchesQuery(e,t)}static DisableFor(e){delete e._tags,delete e.hasTags,delete e.addTags,delete e.removeTags,delete e.matchesTagsQuery}static HasTags(e){if(!e._tags)return!1;let t=e._tags;for(let i in t)if(Object.prototype.hasOwnProperty.call(t,i))return!0;return!1}static GetTags(e,t=!0){if(!e._tags)return null;if(t){let i=[];for(let r in e._tags)Object.prototype.hasOwnProperty.call(e._tags,r)&&e._tags[r]===!0&&i.push(r);return i.join(" ")}else return e._tags}static AddTagsTo(e,t){if(!t||typeof t!="string")return;let i=t.split(" ");for(let r of i)s._AddTagTo(e,r)}static _AddTagTo(e,t){t=t.trim(),!(t===""||t==="true"||t==="false")&&(t.match(/[\s]/)||t.match(/^([!]|([|]|[&]){2})/)||(s.EnableFor(e),e._tags[t]=!0))}static RemoveTagsFrom(e,t){if(!s.HasTags(e))return;let i=t.split(" ");for(let r in i)s._RemoveTagFrom(e,i[r])}static _RemoveTagFrom(e,t){delete e._tags[t]}static MatchesQuery(e,t){return t===void 0?!0:t===""?s.HasTags(e):fp.Eval(t,i=>s.HasTags(e)&&e._tags[i])}}});function Tc(s){return Math.pow(s,Ec)}function xc(s){return s<=.04045?.0773993808*s:Math.pow(.947867299*(s+.055),2.4)}function Ac(s){return Math.pow(s,Sc)}function Rc(s){return s<=.0031308?12.92*s:1.055*Math.pow(s,.41666)-.055}var j,me,Qi,it=S(()=>{Hs();Te();xr();di();j=class s{constructor(e=0,t=0,i=0){this.r=e,this.g=t,this.b=i}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+"}"}getClassName(){return"Color3"}getHashCode(){let e=this.r*255|0;return e=e*397^(this.g*255|0),e=e*397^(this.b*255|0),e}toArray(e,t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,this}fromArray(e,t=0){return s.FromArrayToRef(e,t,this),this}toColor4(e=1){return new me(this.r,this.g,this.b,e)}asArray(){return[this.r,this.g,this.b]}toLuminance(){return this.r*.3+this.g*.59+this.b*.11}multiply(e){return new s(this.r*e.r,this.g*e.g,this.b*e.b)}multiplyToRef(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,t}multiplyInPlace(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this}multiplyByFloats(e,t,i){return new s(this.r*e,this.g*t,this.b*i)}divide(e){throw new ReferenceError("Can not divide a color")}divideToRef(e,t){throw new ReferenceError("Can not divide a color")}divideInPlace(e){throw new ReferenceError("Can not divide a color")}minimizeInPlace(e){return this.minimizeInPlaceFromFloats(e.r,e.g,e.b)}maximizeInPlace(e){return this.maximizeInPlaceFromFloats(e.r,e.g,e.b)}minimizeInPlaceFromFloats(e,t,i){return this.r=Math.min(e,this.r),this.g=Math.min(t,this.g),this.b=Math.min(i,this.b),this}maximizeInPlaceFromFloats(e,t,i){return this.r=Math.max(e,this.r),this.g=Math.max(t,this.g),this.b=Math.max(i,this.b),this}floorToRef(e){throw new ReferenceError("Can not floor a color")}floor(){throw new ReferenceError("Can not floor a color")}fractToRef(e){throw new ReferenceError("Can not fract a color")}fract(){throw new ReferenceError("Can not fract a color")}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b}equalsFloats(e,t,i){return this.equalsToFloats(e,t,i)}equalsToFloats(e,t,i){return this.r===e&&this.g===t&&this.b===i}equalsWithEpsilon(e,t=We){return Rt(this.r,e.r,t)&&Rt(this.g,e.g,t)&&Rt(this.b,e.b,t)}negate(){throw new ReferenceError("Can not negate a color")}negateInPlace(){throw new ReferenceError("Can not negate a color")}negateToRef(e){throw new ReferenceError("Can not negate a color")}scale(e){return new s(this.r*e,this.g*e,this.b*e)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this}scaleToRef(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,t}scaleAndAddToRef(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,t}clampToRef(e=0,t=1,i){return i.r=Fe(this.r,e,t),i.g=Fe(this.g,e,t),i.b=Fe(this.b,e,t),i}add(e){return new s(this.r+e.r,this.g+e.g,this.b+e.b)}addInPlace(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this}addInPlaceFromFloats(e,t,i){return this.r+=e,this.g+=t,this.b+=i,this}addToRef(e,t){return t.r=this.r+e.r,t.g=this.g+e.g,t.b=this.b+e.b,t}subtract(e){return new s(this.r-e.r,this.g-e.g,this.b-e.b)}subtractToRef(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,t}subtractInPlace(e){return this.r-=e.r,this.g-=e.g,this.b-=e.b,this}subtractFromFloats(e,t,i){return new s(this.r-e,this.g-t,this.b-i)}subtractFromFloatsToRef(e,t,i,r){return r.r=this.r-e,r.g=this.g-t,r.b=this.b-i,r}clone(){return new s(this.r,this.g,this.b)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copyFromFloats(e,t,i){return this.r=e,this.g=t,this.b=i,this}set(e,t,i){return this.copyFromFloats(e,t,i)}setAll(e){return this.r=this.g=this.b=e,this}toHexString(){let e=Math.round(this.r*255),t=Math.round(this.g*255),i=Math.round(this.b*255);return"#"+Rs(e)+Rs(t)+Rs(i)}fromHexString(e){return e.substring(0,1)!=="#"||e.length!==7?this:(this.r=parseInt(e.substring(1,3),16)/255,this.g=parseInt(e.substring(3,5),16)/255,this.b=parseInt(e.substring(5,7),16)/255,this)}toHSV(){return this.toHSVToRef(new s)}toHSVToRef(e){let t=this.r,i=this.g,r=this.b,n=Math.max(t,i,r),a=Math.min(t,i,r),o=0,l=0,c=n,f=n-a;return n!==0&&(l=f/n),n!=a&&(n==t?(o=(i-r)/f,i<r&&(o+=6)):n==i?o=(r-t)/f+2:n==r&&(o=(t-i)/f+4),o*=60),e.r=o,e.g=l,e.b=c,e}toLinearSpace(e=!1){let t=new s;return this.toLinearSpaceToRef(t,e),t}toLinearSpaceToRef(e,t=!1){return t?(e.r=xc(this.r),e.g=xc(this.g),e.b=xc(this.b)):(e.r=Tc(this.r),e.g=Tc(this.g),e.b=Tc(this.b)),this}toGammaSpace(e=!1){let t=new s;return this.toGammaSpaceToRef(t,e),t}toGammaSpaceToRef(e,t=!1){return t?(e.r=Rc(this.r),e.g=Rc(this.g),e.b=Rc(this.b)):(e.r=Ac(this.r),e.g=Ac(this.g),e.b=Ac(this.b)),this}static HSVtoRGBToRef(e,t,i,r){let n=i*t,a=e/60,o=n*(1-Math.abs(a%2-1)),l=0,c=0,f=0;a>=0&&a<=1?(l=n,c=o):a>=1&&a<=2?(l=o,c=n):a>=2&&a<=3?(c=n,f=o):a>=3&&a<=4?(c=o,f=n):a>=4&&a<=5?(l=o,f=n):a>=5&&a<=6&&(l=n,f=o);let h=i-n;return r.r=l+h,r.g=c+h,r.b=f+h,r}static FromHSV(e,t,i){let r=new s(0,0,0);return s.HSVtoRGBToRef(e,t,i,r),r}static FromHexString(e){return new s(0,0,0).fromHexString(e)}static FromArray(e,t=0){return new s(e[t],e[t+1],e[t+2])}static FromArrayToRef(e,t=0,i){i.r=e[t],i.g=e[t+1],i.b=e[t+2]}static FromInts(e,t,i){return new s(e/255,t/255,i/255)}static Lerp(e,t,i){let r=new s(0,0,0);return s.LerpToRef(e,t,i,r),r}static LerpToRef(e,t,i,r){r.r=e.r+(t.r-e.r)*i,r.g=e.g+(t.g-e.g)*i,r.b=e.b+(t.b-e.b)*i}static Hermite(e,t,i,r,n){let a=n*n,o=n*a,l=2*o-3*a+1,c=-2*o+3*a,f=o-2*a+n,h=o-a,u=e.r*l+i.r*c+t.r*f+r.r*h,d=e.g*l+i.g*c+t.g*f+r.g*h,p=e.b*l+i.b*c+t.b*f+r.b*h;return new s(u,d,p)}static Hermite1stDerivative(e,t,i,r,n){let a=s.Black();return this.Hermite1stDerivativeToRef(e,t,i,r,n,a),a}static Hermite1stDerivativeToRef(e,t,i,r,n,a){let o=n*n;a.r=(o-n)*6*e.r+(3*o-4*n+1)*t.r+(-o+n)*6*i.r+(3*o-2*n)*r.r,a.g=(o-n)*6*e.g+(3*o-4*n+1)*t.g+(-o+n)*6*i.g+(3*o-2*n)*r.g,a.b=(o-n)*6*e.b+(3*o-4*n+1)*t.b+(-o+n)*6*i.b+(3*o-2*n)*r.b}static Red(){return new s(1,0,0)}static Green(){return new s(0,1,0)}static Blue(){return new s(0,0,1)}static Black(){return new s(0,0,0)}static get BlackReadOnly(){return s._BlackReadOnly}static White(){return new s(1,1,1)}static Purple(){return new s(.5,0,.5)}static Magenta(){return new s(1,0,1)}static Yellow(){return new s(1,1,0)}static Gray(){return new s(.5,.5,.5)}static Teal(){return new s(0,1,1)}static Random(){return new s(Math.random(),Math.random(),Math.random())}};j._V8PerformanceHack=new j(.5,.5,.5);j._BlackReadOnly=j.Black();Object.defineProperties(j.prototype,{dimension:{value:[3]},rank:{value:1}});me=class s{constructor(e=0,t=0,i=0,r=1){this.r=e,this.g=t,this.b=i,this.a=r}asArray(){return[this.r,this.g,this.b,this.a]}toArray(e,t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e[t+3]=this.a,this}fromArray(e,t=0){return this.r=e[t],this.g=e[t+1],this.b=e[t+2],this.a=e[t+3],this}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a}add(e){return new s(this.r+e.r,this.g+e.g,this.b+e.b,this.a+e.a)}addToRef(e,t){return t.r=this.r+e.r,t.g=this.g+e.g,t.b=this.b+e.b,t.a=this.a+e.a,t}addInPlace(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a,this}addInPlaceFromFloats(e,t,i,r){return this.r+=e,this.g+=t,this.b+=i,this.a+=r,this}subtract(e){return new s(this.r-e.r,this.g-e.g,this.b-e.b,this.a-e.a)}subtractToRef(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,t.a=this.a-e.a,t}subtractInPlace(e){return this.r-=e.r,this.g-=e.g,this.b-=e.b,this.a-=e.a,this}subtractFromFloats(e,t,i,r){return new s(this.r-e,this.g-t,this.b-i,this.a-r)}subtractFromFloatsToRef(e,t,i,r,n){return n.r=this.r-e,n.g=this.g-t,n.b=this.b-i,n.a=this.a-r,n}scale(e){return new s(this.r*e,this.g*e,this.b*e,this.a*e)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this.a*=e,this}scaleToRef(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,t.a=this.a*e,t}scaleAndAddToRef(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,t.a+=this.a*e,t}clampToRef(e=0,t=1,i){return i.r=Fe(this.r,e,t),i.g=Fe(this.g,e,t),i.b=Fe(this.b,e,t),i.a=Fe(this.a,e,t),i}multiply(e){return new s(this.r*e.r,this.g*e.g,this.b*e.b,this.a*e.a)}multiplyToRef(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,t.a=this.a*e.a,t}multiplyInPlace(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this.a*=e.a,this}multiplyByFloats(e,t,i,r){return new s(this.r*e,this.g*t,this.b*i,this.a*r)}divide(e){throw new ReferenceError("Can not divide a color")}divideToRef(e,t){throw new ReferenceError("Can not divide a color")}divideInPlace(e){throw new ReferenceError("Can not divide a color")}minimizeInPlace(e){return this.r=Math.min(this.r,e.r),this.g=Math.min(this.g,e.g),this.b=Math.min(this.b,e.b),this.a=Math.min(this.a,e.a),this}maximizeInPlace(e){return this.r=Math.max(this.r,e.r),this.g=Math.max(this.g,e.g),this.b=Math.max(this.b,e.b),this.a=Math.max(this.a,e.a),this}minimizeInPlaceFromFloats(e,t,i,r){return this.r=Math.min(e,this.r),this.g=Math.min(t,this.g),this.b=Math.min(i,this.b),this.a=Math.min(r,this.a),this}maximizeInPlaceFromFloats(e,t,i,r){return this.r=Math.max(e,this.r),this.g=Math.max(t,this.g),this.b=Math.max(i,this.b),this.a=Math.max(r,this.a),this}floorToRef(e){throw new ReferenceError("Can not floor a color")}floor(){throw new ReferenceError("Can not floor a color")}fractToRef(e){throw new ReferenceError("Can not fract a color")}fract(){throw new ReferenceError("Can not fract a color")}negate(){throw new ReferenceError("Can not negate a color")}negateInPlace(){throw new ReferenceError("Can not negate a color")}negateToRef(e){throw new ReferenceError("Can not negate a color")}equalsWithEpsilon(e,t=We){return Rt(this.r,e.r,t)&&Rt(this.g,e.g,t)&&Rt(this.b,e.b,t)&&Rt(this.a,e.a,t)}equalsToFloats(e,t,i,r){return this.r===e&&this.g===t&&this.b===i&&this.a===r}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+" A:"+this.a+"}"}getClassName(){return"Color4"}getHashCode(){let e=this.r*255|0;return e=e*397^(this.g*255|0),e=e*397^(this.b*255|0),e=e*397^(this.a*255|0),e}clone(){return new s().copyFrom(this)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this}copyFromFloats(e,t,i,r){return this.r=e,this.g=t,this.b=i,this.a=r,this}set(e,t,i,r){return this.copyFromFloats(e,t,i,r)}setAll(e){return this.r=this.g=this.b=this.a=e,this}toHexString(e=!1){let t=Math.round(this.r*255),i=Math.round(this.g*255),r=Math.round(this.b*255);if(e)return"#"+Rs(t)+Rs(i)+Rs(r);let n=Math.round(this.a*255);return"#"+Rs(t)+Rs(i)+Rs(r)+Rs(n)}fromHexString(e){return e.substring(0,1)!=="#"||e.length!==9&&e.length!==7?this:(this.r=parseInt(e.substring(1,3),16)/255,this.g=parseInt(e.substring(3,5),16)/255,this.b=parseInt(e.substring(5,7),16)/255,e.length===9&&(this.a=parseInt(e.substring(7,9),16)/255),this)}toLinearSpace(e=!1){let t=new s;return this.toLinearSpaceToRef(t,e),t}toLinearSpaceToRef(e,t=!1){return t?(e.r=xc(this.r),e.g=xc(this.g),e.b=xc(this.b)):(e.r=Tc(this.r),e.g=Tc(this.g),e.b=Tc(this.b)),e.a=this.a,this}toGammaSpace(e=!1){let t=new s;return this.toGammaSpaceToRef(t,e),t}toGammaSpaceToRef(e,t=!1){return t?(e.r=Rc(this.r),e.g=Rc(this.g),e.b=Rc(this.b)):(e.r=Ac(this.r),e.g=Ac(this.g),e.b=Ac(this.b)),e.a=this.a,this}static FromHexString(e){return e.substring(0,1)!=="#"||e.length!==9&&e.length!==7?new s(0,0,0,0):new s(0,0,0,1).fromHexString(e)}static Lerp(e,t,i){return s.LerpToRef(e,t,i,new s)}static LerpToRef(e,t,i,r){return r.r=e.r+(t.r-e.r)*i,r.g=e.g+(t.g-e.g)*i,r.b=e.b+(t.b-e.b)*i,r.a=e.a+(t.a-e.a)*i,r}static Hermite(e,t,i,r,n){let a=n*n,o=n*a,l=2*o-3*a+1,c=-2*o+3*a,f=o-2*a+n,h=o-a,u=e.r*l+i.r*c+t.r*f+r.r*h,d=e.g*l+i.g*c+t.g*f+r.g*h,p=e.b*l+i.b*c+t.b*f+r.b*h,m=e.a*l+i.a*c+t.a*f+r.a*h;return new s(u,d,p,m)}static Hermite1stDerivative(e,t,i,r,n){let a=new s;return this.Hermite1stDerivativeToRef(e,t,i,r,n,a),a}static Hermite1stDerivativeToRef(e,t,i,r,n,a){let o=n*n;a.r=(o-n)*6*e.r+(3*o-4*n+1)*t.r+(-o+n)*6*i.r+(3*o-2*n)*r.r,a.g=(o-n)*6*e.g+(3*o-4*n+1)*t.g+(-o+n)*6*i.g+(3*o-2*n)*r.g,a.b=(o-n)*6*e.b+(3*o-4*n+1)*t.b+(-o+n)*6*i.b+(3*o-2*n)*r.b,a.a=(o-n)*6*e.a+(3*o-4*n+1)*t.a+(-o+n)*6*i.a+(3*o-2*n)*r.a}static FromColor3(e,t=1){return new s(e.r,e.g,e.b,t)}static FromArray(e,t=0){return new s(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t=0,i){i.r=e[t],i.g=e[t+1],i.b=e[t+2],i.a=e[t+3]}static FromInts(e,t,i,r){return new s(e/255,t/255,i/255,r/255)}static CheckColors4(e,t){if(e.length===t*3){let i=[];for(let r=0;r<e.length;r+=3){let n=r/3*4;i[n]=e[r],i[n+1]=e[r+1],i[n+2]=e[r+2],i[n+3]=1}return i}return e}};me._V8PerformanceHack=new me(.5,.5,.5,.5);Object.defineProperties(me.prototype,{dimension:{value:[4]},rank:{value:1}});Qi=class{};Qi.Color3=Gi(3,j.Black);Qi.Color4=Gi(3,()=>new me(0,0,0,0));G("BABYLON.Color3",j);G("BABYLON.Color4",me)});var OD,_e,ei=S(()=>{Ii();po();it();ie();AA();OD=function(s,e,t,i={}){let r=s();st&&st.HasTags(e)&&st.AddTagsTo(r,st.GetTags(e,!0));let n=rp(r),a={};for(let o in n){let l=n[o],c=e[o],f=l.type;if(c!=null&&(o!=="uniqueId"||_e.AllowLoadingUniqueId))switch(f){case 0:case 6:case 9:case 11:r[o]=c;break;case 1:i.cloneTexturesOnlyOnce&&a[c.uniqueId]?r[o]=a[c.uniqueId]:(r[o]=t||c.isRenderTarget?c:c.clone(),a[c.uniqueId]=r[o]);break;case 2:case 3:case 4:case 5:case 7:case 8:case 10:case 12:r[o]=t?c:c.clone();break}}return r},_e=class s{static AppendSerializedAnimations(e,t){if(e.animations){t.animations=[];for(let i=0;i<e.animations.length;i++){let r=e.animations[i];t.animations.push(r.serialize())}}}static Serialize(e,t){t||(t={}),st&&(t.tags=st.GetTags(e));let i=rp(e);for(let r in i){let n=i[r],a=n.sourceName||r,o=n.type,l=e[r];if(l!=null&&(r!=="uniqueId"||s.AllowLoadingUniqueId))switch(o){case 0:Array.isArray(l)?t[a]=l.slice():t[a]=l;break;case 1:t[a]=l.serialize();break;case 2:t[a]=l.asArray();break;case 3:t[a]=l.serialize();break;case 4:t[a]=l.asArray();break;case 5:t[a]=l.asArray();break;case 6:t[a]=l.id;break;case 7:t[a]=l.serialize();break;case 8:t[a]=l.asArray();break;case 9:t[a]=l.serialize();break;case 10:t[a]=l.asArray();break;case 11:t[a]=l.id;break;case 12:t[a]=l.asArray();break}}return t}static ParseProperties(e,t,i,r){r||(r="");let n=rp(t);for(let a in n){let o=n[a],l=e[o.sourceName||a],c=o.type;if(l!=null&&(a!=="uniqueId"||s.AllowLoadingUniqueId)){let f=t;switch(c){case 0:f[a]=l;break;case 1:i&&(f[a]=s._TextureParser(l,i,r));break;case 2:f[a]=j.FromArray(l);break;case 3:f[a]=s._FresnelParametersParser(l);break;case 4:f[a]=he.FromArray(l);break;case 5:f[a]=E.FromArray(l);break;case 6:i&&(f[a]=i.getLastMeshById(l));break;case 7:f[a]=s._ColorCurvesParser(l);break;case 8:f[a]=me.FromArray(l);break;case 9:f[a]=s._ImageProcessingConfigurationParser(l);break;case 10:f[a]=K.FromArray(l);break;case 11:i&&(f[a]=i.getCameraById(l));break;case 12:f[a]=B.FromArray(l);break}}}}static Parse(e,t,i,r=null){let n=e();return st&&st.AddTagsTo(n,t.tags),s.ParseProperties(t,n,i,r),n}static Clone(e,t,i={}){return OD(e,t,!1,i)}static Instanciate(e,t){return OD(e,t,!0)}};_e.AllowLoadingUniqueId=!1;_e._ImageProcessingConfigurationParser=s=>{throw pe("ImageProcessingConfiguration")};_e._FresnelParametersParser=s=>{throw pe("FresnelParameters")};_e._ColorCurvesParser=s=>{throw pe("ColorCurves")};_e._TextureParser=(s,e,t)=>{throw pe("Texture")}});var DA,_t,rs=S(()=>{Ye();ie();je();we();gt();Ii();ei();DA=class{constructor(){this._doNotSerialize=!1,this._isDisposed=!1,this._sceneRootNodesIndex=-1,this._isEnabled=!0,this._isParentEnabled=!0,this._isReady=!0,this._onEnabledStateChangedObservable=new N,this._onClonedObservable=new N}},_t=class s{static AddNodeConstructor(e,t){this._NodeConstructors[e]=t}static Construct(e,t,i,r){let n=this._NodeConstructors[e];return n?n(t,i,r):null}set accessibilityTag(e){this._accessibilityTag=e,this.onAccessibilityTagChangedObservable.notifyObservers(e)}get accessibilityTag(){return this._accessibilityTag}get doNotSerialize(){return this._nodeDataStorage._doNotSerialize?!0:this._parentNode?this._parentNode.doNotSerialize:!1}set doNotSerialize(e){this._nodeDataStorage._doNotSerialize=e}isDisposed(){return this._nodeDataStorage._isDisposed}set parent(e){if(this._parentNode===e)return;let t=this._parentNode;if(this._parentNode&&this._parentNode._children!==void 0&&this._parentNode._children!==null){let i=this._parentNode._children.indexOf(this);i!==-1&&this._parentNode._children.splice(i,1),!e&&!this._nodeDataStorage._isDisposed&&this._addToSceneRootNodes()}this._parentNode=e,this._isDirty=!0,this._parentNode&&((this._parentNode._children===void 0||this._parentNode._children===null)&&(this._parentNode._children=new Array),this._parentNode._children.push(this),t||this._removeFromSceneRootNodes()),this._syncParentEnabledState()}get parent(){return this._parentNode}_serializeAsParent(e){e.parentId=this.uniqueId}_addToSceneRootNodes(){this._nodeDataStorage._sceneRootNodesIndex===-1&&(this._nodeDataStorage._sceneRootNodesIndex=this._scene.rootNodes.length,this._scene.rootNodes.push(this))}_removeFromSceneRootNodes(){if(this._nodeDataStorage._sceneRootNodesIndex!==-1){let e=this._scene.rootNodes,t=e.length-1;e[this._nodeDataStorage._sceneRootNodesIndex]=e[t],e[this._nodeDataStorage._sceneRootNodesIndex]._nodeDataStorage._sceneRootNodesIndex=this._nodeDataStorage._sceneRootNodesIndex,this._scene.rootNodes.pop(),this._nodeDataStorage._sceneRootNodesIndex=-1}}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}getClassName(){return"Node"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get onEnabledStateChangedObservable(){return this._nodeDataStorage._onEnabledStateChangedObservable}get onClonedObservable(){return this._nodeDataStorage._onClonedObservable}constructor(e,t=null,i=!0){this._isDirty=!1,this._nodeDataStorage=new DA,this.state="",this.metadata=null,this.reservedDataStore=null,this._accessibilityTag=null,this.onAccessibilityTagChangedObservable=new N,this._parentContainer=null,this.animations=[],this._ranges={},this.onReady=null,this._currentRenderId=-1,this._parentUpdateId=-1,this._childUpdateId=-1,this._waitingParentId=null,this._waitingParentInstanceIndex=null,this._waitingParsedUniqueId=null,this._cache={},this._parentNode=null,this._children=null,this._worldMatrix=B.Identity(),this._worldMatrixDeterminant=0,this._worldMatrixDeterminantIsDirty=!0,this._animationPropertiesOverride=null,this._isNode=!0,this.onDisposeObservable=new N,this._onDisposeObserver=null,this._behaviors=new Array,this.name=e,this.id=e,this._scene=t||Z.LastCreatedScene,this.uniqueId=this._scene.getUniqueId(),this._initCache(),i&&this._addToSceneRootNodes()}getScene(){return this._scene}getEngine(){return this._scene.getEngine()}addBehavior(e,t=!1){return this._behaviors.indexOf(e)!==-1?this:(e.init(),this._scene.isLoading&&!t?this._scene.onDataLoadedObservable.addOnce(()=>{e.attach(this)}):e.attach(this),this._behaviors.push(e),this)}removeBehavior(e){let t=this._behaviors.indexOf(e);return t===-1?this:(this._behaviors[t].detach(),this._behaviors.splice(t,1),this)}get behaviors(){return this._behaviors}getBehaviorByName(e){for(let t of this._behaviors)if(t.name===e)return t;return null}getWorldMatrix(){return this._currentRenderId!==this._scene.getRenderId()&&this.computeWorldMatrix(),this._worldMatrix}_getWorldMatrixDeterminant(){return this._worldMatrixDeterminantIsDirty&&(this._worldMatrixDeterminantIsDirty=!1,this._worldMatrixDeterminant=this._worldMatrix.determinant()),this._worldMatrixDeterminant}get worldMatrixFromCache(){return this._worldMatrix}_initCache(){this._cache={}}updateCache(e){!e&&this.isSynchronized()||this._updateCache()}_getActionManagerForTrigger(e,t=!0){return this.parent?this.parent._getActionManagerForTrigger(e,!1):null}_updateCache(e){}_isSynchronized(){return!0}_markSyncedWithParent(){this._parentNode&&(this._parentUpdateId=this._parentNode._childUpdateId)}isSynchronizedWithParent(){return this._parentNode?this._parentNode._isDirty||this._parentUpdateId!==this._parentNode._childUpdateId?!1:this._parentNode.isSynchronized():!0}isSynchronized(){return this._parentNode&&!this.isSynchronizedWithParent()?!1:this._isSynchronized()}isReady(e=!1){return this._nodeDataStorage._isReady}markAsDirty(e){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this}isEnabled(e=!0){return e===!1?this._nodeDataStorage._isEnabled:this._nodeDataStorage._isEnabled?this._nodeDataStorage._isParentEnabled:!1}_syncParentEnabledState(){if(this._nodeDataStorage._isParentEnabled=this._parentNode?this._parentNode.isEnabled():!0,this._children)for(let e of this._children)e._syncParentEnabledState()}setEnabled(e){this._nodeDataStorage._isEnabled!==e&&(this._nodeDataStorage._isEnabled=e,this._syncParentEnabledState(),this._nodeDataStorage._onEnabledStateChangedObservable.notifyObservers(e))}isDescendantOf(e){return this.parent?this.parent===e?!0:this.parent.isDescendantOf(e):!1}_getDescendants(e,t=!1,i){if(this._children)for(let r=0;r<this._children.length;r++){let n=this._children[r];(!i||i(n))&&e.push(n),t||n._getDescendants(e,!1,i)}}getDescendants(e,t){let i=[];return this._getDescendants(i,e,t),i}getChildMeshes(e,t){let i=[];return this._getDescendants(i,e,r=>(!t||t(r))&&r.cullingStrategy!==void 0),i}getChildren(e,t=!0){return this.getDescendants(t,e)}_setReady(e){if(e!==this._nodeDataStorage._isReady){if(!e){this._nodeDataStorage._isReady=!1;return}this.onReady&&this.onReady(this),this._nodeDataStorage._isReady=!0}}getAnimationByName(e){for(let t=0;t<this.animations.length;t++){let i=this.animations[t];if(i.name===e)return i}return null}createAnimationRange(e,t,i){if(!this._ranges[e]){this._ranges[e]=s._AnimationRangeFactory(e,t,i);for(let r=0,n=this.animations.length;r<n;r++)this.animations[r]&&this.animations[r].createRange(e,t,i)}}deleteAnimationRange(e,t=!0){for(let i=0,r=this.animations.length;i<r;i++)this.animations[i]&&this.animations[i].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}clone(e,t,i){let r=_e.Clone(()=>new s(e,this.getScene()),this);if(t&&(r.parent=t),!i){let n=this.getDescendants(!0);for(let a=0;a<n.length;a++){let o=n[a];o.clone(e+"."+o.name,r)}}return r}getAnimationRanges(){let e=[],t;for(t in this._ranges)e.push(this._ranges[t]);return e}beginAnimation(e,t,i,r){let n=this.getAnimationRange(e);return n?this._scene.beginAnimation(this,n.from,n.to,t,i,r):null}serializeAnimationRanges(){let e=[];for(let t in this._ranges){let i=this._ranges[t];if(!i)continue;let r={};r.name=t,r.from=i.from,r.to=i.to,e.push(r)}return e}computeWorldMatrix(e){return this._worldMatrix||(this._worldMatrix=B.Identity()),this._worldMatrix}dispose(e,t=!1){if(this._nodeDataStorage._isDisposed=!0,!e){let i=this.getDescendants(!0);for(let r of i)r.dispose(e,t)}this.parent?this.parent=null:this._removeFromSceneRootNodes(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onEnabledStateChangedObservable.clear(),this.onClonedObservable.clear();for(let i of this._behaviors)i.detach();this._behaviors.length=0,this.metadata=null}static ParseAnimationRanges(e,t,i){if(t.ranges)for(let r=0;r<t.ranges.length;r++){let n=t.ranges[r];e.createAnimationRange(n.name,n.from,n.to)}}getHierarchyBoundingVectors(e=!0,t=null){this.getScene().incrementRenderId(),this.computeWorldMatrix(!0);let i,r,n=this;if(n.getBoundingInfo&&n.subMeshes){let a=n.getBoundingInfo();i=a.boundingBox.minimumWorld.clone(),r=a.boundingBox.maximumWorld.clone()}else i=new E(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),r=new E(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);if(e){let a=this.getDescendants(!1);for(let o of a){let l=o;if(l.computeWorldMatrix(!0),t&&!t(l)||!l.getBoundingInfo||l.getTotalVertices()===0)continue;let f=l.getBoundingInfo().boundingBox,h=f.minimumWorld,u=f.maximumWorld;E.CheckExtends(h,i,r),E.CheckExtends(u,i,r)}}return{min:i,max:r}}};_t._AnimationRangeFactory=(s,e,t)=>{throw pe("AnimationRange")};_t._NodeConstructors={};x([y()],_t.prototype,"name",void 0);x([y()],_t.prototype,"id",void 0);x([y()],_t.prototype,"uniqueId",void 0);x([y()],_t.prototype,"state",void 0);x([y()],_t.prototype,"metadata",void 0)});function jt(){return typeof window<"u"}function ca(){return typeof navigator<"u"}function mo(){return typeof document<"u"}function hp(s){let e="",t=s.firstChild;for(;t;)t.nodeType===3&&(e+=t.textContent),t=t.nextSibling;return e}var Cs=S(()=>{});var P,Ee=S(()=>{P=class s{static _CheckLimit(e,t){let i=s._LogLimitOutputs[e];return i?i.current++:(i={limit:t,current:1},s._LogLimitOutputs[e]=i),i.current<=i.limit}static _GenerateLimitMessage(e,t=1){let i=s._LogLimitOutputs[e];if(!i||!s.MessageLimitReached)return;let r=this._Levels[t];i.current===i.limit&&s[r.name](s.MessageLimitReached.replace(/%LIMIT%/g,""+i.limit).replace(/%TYPE%/g,r.name??""))}static _AddLogEntry(e){s._LogCache=e+s._LogCache,s.OnNewCacheEntry&&s.OnNewCacheEntry(e)}static _FormatMessage(e){let t=r=>r<10?"0"+r:""+r,i=new Date;return"["+t(i.getHours())+":"+t(i.getMinutes())+":"+t(i.getSeconds())+"]: "+e}static _LogDisabled(e,t){}static _LogEnabled(e=1,t,i){let r=Array.isArray(t)?t[0]:t;if(i!==void 0&&!s._CheckLimit(r,i))return;let n=s._FormatMessage(r),a=this._Levels[e],o=Array.isArray(t)?t.slice(1):[];a.logFunc&&a.logFunc("BJS - "+n,...o);let l=`<div style='color:${a.color}'>${n}</div><br>`;s._AddLogEntry(l),s._GenerateLimitMessage(r,e)}static get LogCache(){return s._LogCache}static ClearLogCache(){s._LogCache="",s._LogLimitOutputs={},s.errorsCount=0}static set LogLevels(e){s.Log=s._LogDisabled,s.Warn=s._LogDisabled,s.Error=s._LogDisabled;let t=[s.MessageLogLevel,s.WarningLogLevel,s.ErrorLogLevel];for(let i of t)if((e&i)===i){let r=this._Levels[i];s[r.name]=s._LogEnabled.bind(s,i)}}};P.NoneLogLevel=0;P.MessageLogLevel=1;P.WarningLogLevel=2;P.ErrorLogLevel=4;P.AllLogLevel=7;P.MessageLimitReached="Too many %TYPE%s (%LIMIT%), no more %TYPE%s will be reported for this message.";P._LogCache="";P._LogLimitOutputs={};P._Levels=[{},{color:"white",logFunc:console.log,name:"Log"},{color:"orange",logFunc:console.warn,name:"Warn"},{},{color:"red",logFunc:console.error,name:"Error"}];P.errorsCount=0;P.Log=P._LogEnabled.bind(P,P.MessageLogLevel);P.Warn=P._LogEnabled.bind(P,P.WarningLogLevel);P.Error=P._LogEnabled.bind(P,P.ErrorLogLevel)});function N9(s){let e=[];do{let t=Object.getOwnPropertyNames(s);for(let i of t)e.indexOf(i)===-1&&e.push(i)}while(s=Object.getPrototypeOf(s));return e}var LD,xn,Ch=S(()=>{Ee();LD=(s,e,t)=>!s||s.getClassName&&s.getClassName()==="Mesh"?null:s.getClassName&&(s.getClassName()==="SubMesh"||s.getClassName()==="PhysicsBody")?s.clone(e):s.clone?s.clone():Array.isArray(s)?s.slice():t&&typeof s=="object"?{...s}:null;xn=class{static DeepCopy(e,t,i,r,n=!1){let a=N9(e);for(let o of a){if(o[0]==="_"&&(!r||r.indexOf(o)===-1)||o.endsWith("Observable")||i&&i.indexOf(o)!==-1)continue;let l=e[o],c=typeof l;if(c!=="function")try{if(c==="object")if(l instanceof Uint8Array)t[o]=Uint8Array.from(l);else if(l instanceof Array){if(t[o]=[],l.length>0)if(typeof l[0]=="object")for(let f=0;f<l.length;f++){let h=LD(l[f],t,n);t[o].indexOf(h)===-1&&t[o].push(h)}else t[o]=l.slice(0)}else t[o]=LD(l,t,n);else t[o]=l}catch(f){P.Warn(f.message)}}}}});var Zt,zs=S(()=>{Cs();Zt=class{static get Now(){return jt()&&window.performance&&window.performance.now?window.performance.now():Date.now()}}});function B9(){return typeof _native<"u"&&_native.XMLHttpRequest?new _native.XMLHttpRequest:new XMLHttpRequest}var gi,bc=S(()=>{gi=class s{constructor(){this._xhr=B9(),this._requestURL=""}static get IsCustomRequestAvailable(){return Object.keys(s.CustomRequestHeaders).length>0||s.CustomRequestModifiers.length>0}get requestURL(){return this._requestURL}_injectCustomRequestHeaders(){if(!this._shouldSkipRequestModifications(this._requestURL))for(let e in s.CustomRequestHeaders){let t=s.CustomRequestHeaders[e];t&&this._xhr.setRequestHeader(e,t)}}_shouldSkipRequestModifications(e){return s.SkipRequestModificationForBabylonCDN&&(e.includes("preview.babylonjs.com")||e.includes("cdn.babylonjs.com"))}get onprogress(){return this._xhr.onprogress}set onprogress(e){this._xhr.onprogress=e}get readyState(){return this._xhr.readyState}get status(){return this._xhr.status}get statusText(){return this._xhr.statusText}get response(){return this._xhr.response}get responseURL(){return this._xhr.responseURL}get responseText(){return this._xhr.responseText}get responseType(){return this._xhr.responseType}set responseType(e){this._xhr.responseType=e}get timeout(){return this._xhr.timeout}set timeout(e){this._xhr.timeout=e}addEventListener(e,t,i){this._xhr.addEventListener(e,t,i)}removeEventListener(e,t,i){this._xhr.removeEventListener(e,t,i)}abort(){this._xhr.abort()}send(e){s.CustomRequestHeaders&&this._injectCustomRequestHeaders(),this._xhr.send(e)}open(e,t){for(let i of s.CustomRequestModifiers){if(this._shouldSkipRequestModifications(t))return;t=i(this._xhr,t)||t}t=t.replace("file:http:","http:"),t=t.replace("file:https:","https:"),this._requestURL=t,this._xhr.open(e,t,!0)}setRequestHeader(e,t){this._xhr.setRequestHeader(e,t)}getResponseHeader(e){return this._xhr.getResponseHeader(e)}};gi.CustomRequestHeaders={};gi.CustomRequestModifiers=new Array;gi.SkipRequestModificationForBabylonCDN=!0});var _o,wD=S(()=>{_o=class{};_o.FilesToLoad={}});var up,FD=S(()=>{up=class{static ExponentialBackoff(e=3,t=500){return(i,r,n)=>r.status!==0||n>=e||i.indexOf("file:")!==-1?-1:Math.pow(2,n)*t}}});var Xs,Is,Nr,Br,Cc=S(()=>{Xs=class extends Error{};Xs._setPrototypeOf=Object.setPrototypeOf||((s,e)=>(s.__proto__=e,s));Is={MeshInvalidPositionsError:0,UnsupportedTextureError:1e3,GLTFLoaderUnexpectedMagicError:2e3,SceneLoaderError:3e3,LoadFileError:4e3,RequestFileError:4001,ReadFileError:4002},Nr=class s extends Xs{constructor(e,t,i){super(e),this.errorCode=t,this.innerError=i,this.name="RuntimeError",Xs._setPrototypeOf(this,s.prototype)}},Br=class s extends Xs{constructor(e="Operation aborted"){super(e),this.name="AbortError",Xs._setPrototypeOf(this,s.prototype)}}});var ND,dp,OA,BD,pp=S(()=>{ND=s=>{if(typeof TextDecoder<"u")return new TextDecoder().decode(s);let e="";for(let t=0;t<s.byteLength;t++)e+=String.fromCharCode(s[t]);return e},dp=s=>{let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",t="",i,r,n,a,o,l,c,f=0,h=ArrayBuffer.isView(s)?new Uint8Array(s.buffer,s.byteOffset,s.byteLength):new Uint8Array(s);for(;f<h.length;)i=h[f++],r=f<h.length?h[f++]:Number.NaN,n=f<h.length?h[f++]:Number.NaN,a=i>>2,o=(i&3)<<4|r>>4,l=(r&15)<<2|n>>6,c=n&63,isNaN(r)?l=c=64:isNaN(n)&&(c=64),t+=e.charAt(a)+e.charAt(o)+e.charAt(l)+e.charAt(c);return t},OA=s=>atob(s),BD=s=>{let e=OA(s),t=e.length,i=new Uint8Array(new ArrayBuffer(t));for(let r=0;r<t;r++)i[r]=e.charCodeAt(r);return i.buffer}});var U9,G9,An,mp=S(()=>{U9="attribute",G9="varying",An=class{constructor(){this.children=[]}isValid(e){return!0}process(e,t,i){let r="";if(this.line){let n=this.line,a=t.processor;if(a){a.lineProcessor&&(n=a.lineProcessor(n,t.isFragment,t.processingContext));let o=t.processor?.attributeKeywordName??U9,l=t.isFragment&&t.processor?.varyingFragmentKeywordName?t.processor?.varyingFragmentKeywordName:!t.isFragment&&t.processor?.varyingVertexKeywordName?t.processor?.varyingVertexKeywordName:G9;!t.isFragment&&a.attributeProcessor&&this.line.startsWith(o)?n=a.attributeProcessor(this.line,e,t.processingContext):a.varyingProcessor&&(a.varyingCheck?.(this.line,t.isFragment)||!a.varyingCheck&&this.line.startsWith(l))?n=a.varyingProcessor(this.line,t.isFragment,e,t.processingContext):a.uniformProcessor&&a.uniformRegexp&&a.uniformRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(n=a.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):a.uniformBufferProcessor&&a.uniformBufferRegexp&&a.uniformBufferRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(n=a.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0):a.textureProcessor&&a.textureRegexp&&a.textureRegexp.test(this.line)?n=a.textureProcessor(this.line,t.isFragment,e,t.processingContext):(a.uniformProcessor||a.uniformBufferProcessor)&&this.line.startsWith("uniform")&&!t.lookForClosingBracketForUniformBuffer&&(/uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/.test(this.line)?a.uniformProcessor&&(n=a.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):a.uniformBufferProcessor&&(n=a.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0)),t.lookForClosingBracketForUniformBuffer&&this.line.indexOf("}")!==-1&&(t.lookForClosingBracketForUniformBuffer=!1,a.endOfUniformBufferProcessor&&(n=a.endOfUniformBufferProcessor(this.line,t.isFragment,t.processingContext)))}r+=n+`
`}for(let n of this.children)r+=n.process(e,t,i);return this.additionalDefineKey&&(e[this.additionalDefineKey]=this.additionalDefineValue||"true",i[this.additionalDefineKey]=e[this.additionalDefineKey]),r}}});var _p,UD=S(()=>{_p=class{constructor(){this._lines=[]}get currentLine(){return this._lines[this.lineIndex]}get canRead(){return this.lineIndex<this._lines.length-1}set lines(e){this._lines.length=0;for(let t of e){if(!t||t==="\r")continue;if(t[0]==="#"){this._lines.push(t);continue}let i=t.trim();if(!i)continue;if(i.startsWith("//")){this._lines.push(t);continue}let r=i.indexOf(";");if(r===-1)this._lines.push(i);else if(r===i.length-1)i.length>1&&this._lines.push(i);else{let n=t.split(";");for(let a=0;a<n.length;a++){let o=n[a];o&&(o=o.trim(),o&&this._lines.push(o+(a!==n.length-1?";":"")))}}}}}});var Ic,GD=S(()=>{mp();Ic=class extends An{process(e,t,i){for(let r=0;r<this.children.length;r++){let n=this.children[r];if(n.isValid(e))return n.process(e,t,i)}return""}}});var gp,VD=S(()=>{mp();gp=class extends An{isValid(e){return this.testExpression.isTrue(e)}}});var ji,yc=S(()=>{ji=class s{isTrue(e){return!0}static postfixToInfix(e){let t=[];for(let i of e)if(s._OperatorPriority[i]===void 0)t.push(i);else{let r=t[t.length-1],n=t[t.length-2];t.length-=2,t.push(`(${n}${i}${r})`)}return t[t.length-1]}static infixToPostfix(e){let t=s._InfixToPostfixCache.get(e);if(t)return t.accessTime=Date.now(),t.result;if(!e.includes("&&")&&!e.includes("||")&&!e.includes(")")&&!e.includes("("))return[e];let i=[],r=-1,n=()=>{f=f.trim(),f!==""&&(i.push(f),f="")},a=h=>{r<s._Stack.length-1&&(s._Stack[++r]=h)},o=()=>s._Stack[r],l=()=>r===-1?"!!INVALID EXPRESSION!!":s._Stack[r--],c=0,f="";for(;c<e.length;){let h=e.charAt(c),u=c<e.length-1?e.substring(c,2+c):"";if(h==="(")f="",a(h);else if(h===")"){for(n();r!==-1&&o()!=="(";)i.push(l());l()}else if(s._OperatorPriority[u]>1){for(n();r!==-1&&s._OperatorPriority[o()]>=s._OperatorPriority[u];)i.push(l());a(u),c++}else f+=h;c++}for(n();r!==-1;)o()==="("?l():i.push(l());return s._InfixToPostfixCache.size>=s.InfixToPostfixCacheLimitSize&&s.ClearCache(),s._InfixToPostfixCache.set(e,{result:i,accessTime:Date.now()}),i}static ClearCache(){let e=Array.from(s._InfixToPostfixCache.entries()).sort((t,i)=>t[1].accessTime-i[1].accessTime);for(let t=0;t<s.InfixToPostfixCacheCleanupSize;t++)s._InfixToPostfixCache.delete(e[t][0])}};ji.InfixToPostfixCacheLimitSize=5e4;ji.InfixToPostfixCacheCleanupSize=25e3;ji._InfixToPostfixCache=new Map;ji._OperatorPriority={")":0,"(":1,"||":2,"&&":3};ji._Stack=["","","","","","","","","","","","","","","","","","","",""]});var ul,kD=S(()=>{yc();ul=class extends ji{constructor(e,t=!1){super(),this.define=e,this.not=t}isTrue(e){let t=e[this.define]!==void 0;return this.not&&(t=!t),t}}});var vp,WD=S(()=>{yc();vp=class extends ji{isTrue(e){return this.leftOperand.isTrue(e)||this.rightOperand.isTrue(e)}}});var Sp,HD=S(()=>{yc();Sp=class extends ji{isTrue(e){return this.leftOperand.isTrue(e)&&this.rightOperand.isTrue(e)}}});var Ep,zD=S(()=>{yc();Ep=class extends ji{constructor(e,t,i){super(),this.define=e,this.operand=t,this.testValue=i}toString(){return`${this.define} ${this.operand} ${this.testValue}`}isTrue(e){let t=!1,i=parseInt(e[this.define]!=null?e[this.define]:this.define),r=parseInt(e[this.testValue]!=null?e[this.testValue]:this.testValue);if(isNaN(i)||isNaN(r))return!1;switch(this.operand){case">":t=i>r;break;case"<":t=i<r;break;case"<=":t=i<=r;break;case">=":t=i>=r;break;case"==":t=i===r;break;case"!=":t=i!==r;break}return t}}});function Tp(s,e,t=""){return t+(e?e+`
`:"")+s}function xp(s,e,t,i,r,n,a){let o=a||Mc.loadFile;if(o)return o(s,e,t,i,r,n);throw pe("FileTools")}function Ap(s,e,t,i){if(s){e?s.IS_NDC_HALF_ZRANGE="":delete s.IS_NDC_HALF_ZRANGE,t?s.USE_REVERSE_DEPTHBUFFER="":delete s.USE_REVERSE_DEPTHBUFFER,i?s.USE_EXACT_SRGB_CONVERSIONS="":delete s.USE_EXACT_SRGB_CONVERSIONS;return}else{let r="";return e&&(r+="#define IS_NDC_HALF_ZRANGE"),t&&(r&&(r+=`
`),r+="#define USE_REVERSE_DEPTHBUFFER"),i&&(r&&(r+=`
`),r+="#define USE_EXACT_SRGB_CONVERSIONS"),r}}function Ih(s,e,t=!1,i){switch(s){case 3:{let n=e instanceof ArrayBuffer?new Int8Array(e):new Int8Array(e);return i&&n.set(new Int8Array(i)),n}case 0:{let n=e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e);return i&&n.set(new Uint8Array(i)),n}case 4:{let n=e instanceof ArrayBuffer?new Int16Array(e):new Int16Array(t?e/2:e);return i&&n.set(new Int16Array(i)),n}case 5:case 8:case 9:case 10:case 2:{let n=e instanceof ArrayBuffer?new Uint16Array(e):new Uint16Array(t?e/2:e);return i&&n.set(new Uint16Array(i)),n}case 6:{let n=e instanceof ArrayBuffer?new Int32Array(e):new Int32Array(t?e/4:e);return i&&n.set(new Int32Array(i)),n}case 7:case 11:case 12:case 13:case 14:case 15:{let n=e instanceof ArrayBuffer?new Uint32Array(e):new Uint32Array(t?e/4:e);return i&&n.set(new Uint32Array(i)),n}case 1:{let n=e instanceof ArrayBuffer?new Float32Array(e):new Float32Array(t?e/4:e);return i&&n.set(new Float32Array(i)),n}}let r=e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e);return i&&r.set(new Uint8Array(i)),r}var Mc,fa=S(()=>{Ii();Cs();Mc={}});function Cp(s){s.processor&&s.processor.initializeShaders&&s.processor.initializeShaders(s.processingContext)}function Pc(s,e,t,i){e.processor?.preProcessShaderCode&&(s=e.processor.preProcessShaderCode(s,e.isFragment)),yh(s,e,r=>{e.processCodeAfterIncludes&&(r=e.processCodeAfterIncludes(e.isFragment?"fragment":"vertex",r,e.defines));let n=q9(r,e,i);t(n,r)})}function Ip(s,e,t){return!t.processor||!t.processor.finalizeShaders?{vertexCode:s,fragmentCode:e}:t.processor.finalizeShaders(s,e,t.processingContext)}function z9(s,e){if(e.processor?.noPrecision)return s;let t=e.shouldUseHighPrecisionShader;return s.indexOf("precision highp float")===-1?t?s=`precision highp float;
`+s:s=`precision mediump float;
`+s:t||(s=s.replace("precision highp float","precision mediump float")),s}function wA(s){let t=/defined\((.+)\)/.exec(s);if(t&&t.length)return new ul(t[1].trim(),s[0]==="!");let i=["==","!=",">=","<=","<",">"],r="",n=0;for(r of i)if(n=s.indexOf(r),n>-1)break;if(n===-1)return new ul(s);let a=s.substring(0,n).trim(),o=s.substring(n+r.length).trim();return new Ep(a,r,o)}function X9(s){s=s.replace(V9,"defined[$1]");let e=ji.infixToPostfix(s),t=[];for(let r of e)if(r!=="||"&&r!=="&&")t.push(r);else if(t.length>=2){let n=t[t.length-1],a=t[t.length-2];t.length-=2;let o=r=="&&"?new Sp:new vp;typeof n=="string"&&(n=n.replace(LA,"defined($1)")),typeof a=="string"&&(a=a.replace(LA,"defined($1)")),o.leftOperand=typeof a=="string"?wA(a):a,o.rightOperand=typeof n=="string"?wA(n):n,t.push(o)}let i=t[t.length-1];return typeof i=="string"&&(i=i.replace(LA,"defined($1)")),typeof i=="string"?wA(i):i}function bp(s,e){let t=new gp,i=s.substring(0,e),r=s.substring(e);return r=r.substring(0,(r.indexOf("//")+1||r.length+1)-1).trim(),i==="#ifdef"?t.testExpression=new ul(r):i==="#ifndef"?t.testExpression=new ul(r,!0):t.testExpression=X9(r),t}function FA(s,e,t,i){let r=s.currentLine;for(;NA(s,t,i);){r=s.currentLine;let n=r.substring(0,5).toLowerCase();if(n==="#else"){let a=new An;e.children.push(a),NA(s,a,i);return}else if(n==="#elif"){let a=bp(r,5);e.children.push(a),t=a}}}function NA(s,e,t){for(;s.canRead;){s.lineIndex++;let i=s.currentLine;if(i.indexOf("#")>=0){let n=H9.exec(i);if(n&&n.length){switch(n[0]){case"#ifdef":{let o=new Ic;e.children.push(o);let l=bp(i,6);o.children.push(l),FA(s,o,l,t);break}case"#else":case"#elif":return!0;case"#endif":return!1;case"#ifndef":{let o=new Ic;e.children.push(o);let l=bp(i,7);o.children.push(l),FA(s,o,l,t);break}case"#if":{let o=new Ic,l=bp(i,3);e.children.push(o),o.children.push(l),FA(s,o,l,t);break}}continue}}let r=new An;if(r.line=i,e.children.push(r),i[0]==="#"&&i[1]==="d"){let n=i.replace(";","").split(" ");r.additionalDefineKey=n[1],n.length===3&&(r.additionalDefineValue=n[2])}}return!1}function Y9(s,e,t,i){let r=new An,n=new _p;return n.lineIndex=-1,n.lines=s.split(`
`),NA(n,r,i),r.process(e,t,i)}function K9(s,e){let t=s.defines,i={};for(let r of t){let a=r.replace("#define","").replace(";","").trim().split(" ");i[a[0]]=a.length>1?a[1]:""}return s.processor?.shaderLanguage===0&&(i.GL_ES="true"),i.__VERSION__=s.version,i[s.platformName]="true",Ap(i,e?.isNDCHalfZRange,e?.useReverseDepthBuffer,e?.useExactSrgbConversions),i}function q9(s,e,t){let i=z9(s,e);if(!e.processor||e.processor.shaderLanguage===0&&i.indexOf("#version 3")!==-1&&(i=i.replace("#version 300 es",""),!e.processor.parseGLES3))return i;let r=e.defines,n=K9(e,t);e.processor.preProcessor&&(i=e.processor.preProcessor(i,r,n,e.isFragment,e.processingContext));let a={};return i=Y9(i,n,e,a),e.processor.postProcessor&&(i=e.processor.postProcessor(i,r,e.isFragment,e.processingContext,t?{drawBuffersExtensionDisabled:!t.getCaps().drawBuffersExtension}:{},n,a)),t?._features.needShaderCodeInlining&&(i=t.inlineShaderCode(i)),i}function yh(s,e,t){Rp.length=0;let i;for(;(i=k9.exec(s))!==null;)Rp.push(i);let r=String(s),n=[s],a=!1;for(let o of Rp){let l=o[1];if(l.indexOf("__decl__")!==-1&&(l=l.replace(W9,""),e.supportsUniformBuffers&&(l=l.replace("Vertex","Ubo").replace("Fragment","Ubo")),l=l+"Declaration"),e.includesShadersStore[l]){let c=e.includesShadersStore[l];if(o[2]){let h=o[3].split(",");for(let u=0;u<h.length;u+=2){let d=new RegExp(h[u],"g"),p=h[u+1];c=c.replace(d,p)}}if(o[4]){let h=o[5];if(h.indexOf("..")!==-1){let u=h.split(".."),d=parseInt(u[0]),p=parseInt(u[1]),m=c.slice(0);c="",isNaN(p)&&(p=e.indexParameters[u[1]]);for(let _=d;_<p;_++)e.supportsUniformBuffers||(m=m.replace(XD,(v,T)=>T+"{X}")),c+=m.replace(YD,_.toString())+`
`}else e.supportsUniformBuffers||(c=c.replace(XD,(u,d)=>d+"{X}")),c=c.replace(YD,h)}let f=[];for(let h of n){let u=h.split(o[0]);for(let d=0;d<u.length-1;d++)f.push(u[d]),f.push(c);f.push(u[u.length-1])}n=f,a=a||c.indexOf("#include<")>=0||c.indexOf("#include <")>=0}else{let c=e.shadersRepository+"ShadersInclude/"+l+".fx";BA.loadFile(c,f=>{e.includesShadersStore[l]=f,yh(n.join(""),e,t)});return}}Rp.length=0,r=n.join(""),a?yh(r.toString(),e,t):t(r)}var V9,LA,k9,W9,XD,YD,Rp,H9,BA,Mh=S(()=>{mp();UD();GD();VD();kD();WD();HD();yc();zD();Ii();fa();V9=/defined\s*?\((.+?)\)/g,LA=/defined\s*?\[(.+?)\]/g,k9=/#include\s?<(.+)>(\((.*)\))*(\[(.*)\])*/g,W9=/__decl__/,XD=/light\{X\}.(\w*)/g,YD=/\{X\}/g,Rp=[],H9=/(#ifdef)|(#else)|(#elif)|(#endif)|(#ifndef)|(#if)/;BA={loadFile:(s,e,t,i,r,n)=>{throw pe("FileTools")}}});function KD(s,e,t){try{if(s())return e(),!0}catch(i){return t?.(i),!0}return!1}var yp,Ys,br,ys=S(()=>{yp=[],Ys=class{static SetImmediate(e){yp.length===0&&setTimeout(()=>{let t=yp;yp=[];for(let i of t)i()},1),yp.push(e)}};br=(s,e,t,i=16,r=3e4,n=!0,a)=>{if(n&&KD(s,e,t))return null;let o=setInterval(()=>{KD(s,e,t)?clearInterval(o):(r-=i,r<0&&(clearInterval(o),t?.(new Error("Operation timed out after maximum retries. "+(a||"")),!0)))},i);return()=>clearInterval(o)}});var g,O=S(()=>{g=class s{static GetShadersRepository(e=0){return e===0?s.ShadersRepository:s.ShadersRepositoryWGSL}static GetShadersStore(e=0){return e===0?s.ShadersStore:s.ShadersStoreWGSL}static GetIncludesShadersStore(e=0){return e===0?s.IncludesShadersStore:s.IncludesShadersStoreWGSL}};g.ShadersRepository="src/Shaders/";g.ShadersStore={};g.IncludesShadersStore={};g.ShadersRepositoryWGSL="src/ShadersWGSL/";g.ShadersStoreWGSL={};g.IncludesShadersStoreWGSL={}});var Mp,qD=S(()=>{Mp=class{constructor(){this._valueCache={},this.vertexCompilationError=null,this.fragmentCompilationError=null,this.programLinkError=null,this.programValidationError=null,this._isDisposed=!1}get isAsync(){return this.isParallelCompiled}get isReady(){return this.program?this.isParallelCompiled?this.engine._isRenderingStateCompiled(this):!0:!1}_handlesSpectorRebuildCallback(e){e&&this.program&&e(this.program)}setEngine(e){this.engine=e}_fillEffectInformation(e,t,i,r,n,a,o,l){let c=this.engine;if(c.supportsUniformBuffers)for(let u in t)e.bindUniformBlock(u,t[u]);this.engine.getUniforms(this,i).forEach((u,d)=>{r[i[d]]=u}),this._uniforms=r;let h;for(h=0;h<n.length;h++)e.getUniform(n[h])==null&&(n.splice(h,1),h--);n.forEach((u,d)=>{a[u]=d});for(let u of c.getAttributes(this,o))l.push(u)}dispose(){this._uniforms={},this._isDisposed=!0}_cacheMatrix(e,t){let i=this._valueCache[e],r=t.updateFlag;return i!==void 0&&i===r?!1:(this._valueCache[e]=r,!0)}_cacheFloat2(e,t,i){let r=this._valueCache[e];if(!r||r.length!==2)return r=[t,i],this._valueCache[e]=r,!0;let n=!1;return r[0]!==t&&(r[0]=t,n=!0),r[1]!==i&&(r[1]=i,n=!0),n}_cacheFloat3(e,t,i,r){let n=this._valueCache[e];if(!n||n.length!==3)return n=[t,i,r],this._valueCache[e]=n,!0;let a=!1;return n[0]!==t&&(n[0]=t,a=!0),n[1]!==i&&(n[1]=i,a=!0),n[2]!==r&&(n[2]=r,a=!0),a}_cacheFloat4(e,t,i,r,n){let a=this._valueCache[e];if(!a||a.length!==4)return a=[t,i,r,n],this._valueCache[e]=a,!0;let o=!1;return a[0]!==t&&(a[0]=t,o=!0),a[1]!==i&&(a[1]=i,o=!0),a[2]!==r&&(a[2]=r,o=!0),a[3]!==n&&(a[3]=n,o=!0),o}setInt(e,t){let i=this._valueCache[e];i!==void 0&&i===t||this.engine.setInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setInt3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&(this.engine.setInt3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null))}setInt4(e,t,i,r,n){this._cacheFloat4(e,t,i,r,n)&&(this.engine.setInt4(this._uniforms[e],t,i,r,n)||(this._valueCache[e]=null))}setIntArray(e,t){this._valueCache[e]=null,this.engine.setIntArray(this._uniforms[e],t)}setIntArray2(e,t){this._valueCache[e]=null,this.engine.setIntArray2(this._uniforms[e],t)}setIntArray3(e,t){this._valueCache[e]=null,this.engine.setIntArray3(this._uniforms[e],t)}setIntArray4(e,t){this._valueCache[e]=null,this.engine.setIntArray4(this._uniforms[e],t)}setUInt(e,t){let i=this._valueCache[e];i!==void 0&&i===t||this.engine.setUInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setUInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setUInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setUInt3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&(this.engine.setUInt3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null))}setUInt4(e,t,i,r,n){this._cacheFloat4(e,t,i,r,n)&&(this.engine.setUInt4(this._uniforms[e],t,i,r,n)||(this._valueCache[e]=null))}setUIntArray(e,t){this._valueCache[e]=null,this.engine.setUIntArray(this._uniforms[e],t)}setUIntArray2(e,t){this._valueCache[e]=null,this.engine.setUIntArray2(this._uniforms[e],t)}setUIntArray3(e,t){this._valueCache[e]=null,this.engine.setUIntArray3(this._uniforms[e],t)}setUIntArray4(e,t){this._valueCache[e]=null,this.engine.setUIntArray4(this._uniforms[e],t)}setArray(e,t){this._valueCache[e]=null,this.engine.setArray(this._uniforms[e],t)}setArray2(e,t){this._valueCache[e]=null,this.engine.setArray2(this._uniforms[e],t)}setArray3(e,t){this._valueCache[e]=null,this.engine.setArray3(this._uniforms[e],t)}setArray4(e,t){this._valueCache[e]=null,this.engine.setArray4(this._uniforms[e],t)}setMatrices(e,t){t&&(this._valueCache[e]=null,this.engine.setMatrices(this._uniforms[e],t))}setMatrix(e,t){this._cacheMatrix(e,t)&&(this.engine.setMatrices(this._uniforms[e],t.asArray())||(this._valueCache[e]=null))}setMatrix3x3(e,t){this._valueCache[e]=null,this.engine.setMatrix3x3(this._uniforms[e],t)}setMatrix2x2(e,t){this._valueCache[e]=null,this.engine.setMatrix2x2(this._uniforms[e],t)}setFloat(e,t){let i=this._valueCache[e];i!==void 0&&i===t||this.engine.setFloat(this._uniforms[e],t)&&(this._valueCache[e]=t)}setVector2(e,t){this._cacheFloat2(e,t.x,t.y)&&(this.engine.setFloat2(this._uniforms[e],t.x,t.y)||(this._valueCache[e]=null))}setFloat2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setFloat2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setVector3(e,t){this._cacheFloat3(e,t.x,t.y,t.z)&&(this.engine.setFloat3(this._uniforms[e],t.x,t.y,t.z)||(this._valueCache[e]=null))}setFloat3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&(this.engine.setFloat3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null))}setVector4(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setQuaternion(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setFloat4(e,t,i,r,n){this._cacheFloat4(e,t,i,r,n)&&(this.engine.setFloat4(this._uniforms[e],t,i,r,n)||(this._valueCache[e]=null))}setColor3(e,t){this._cacheFloat3(e,t.r,t.g,t.b)&&(this.engine.setFloat3(this._uniforms[e],t.r,t.g,t.b)||(this._valueCache[e]=null))}setColor4(e,t,i){this._cacheFloat4(e,t.r,t.g,t.b,i)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,i)||(this._valueCache[e]=null))}setDirectColor4(e,t){this._cacheFloat4(e,t.r,t.g,t.b,t.a)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,t.a)||(this._valueCache[e]=null))}_getVertexShaderCode(){return this.vertexShader?this.engine._getShaderSource(this.vertexShader):null}_getFragmentShaderCode(){return this.fragmentShader?this.engine._getShaderSource(this.fragmentShader):null}}});function ir(s){let e=UA.get(s);if(!e){if(!s)return Q9;e={_webGLVersion:s.TEXTURE_BINDING_3D?2:1,_context:s,parallelShaderCompile:s.getExtension("KHR_parallel_shader_compile")||void 0,cachedPipelines:{}},UA.set(s,e)}return e}function Pp(s){UA.delete(s)}function VA(s,e,t,i,r,n){let a=ir(i);n||(n=a._createShaderProgramInjection??Dp);let o=GA(e,"vertex",i,a._contextWasLost),l=GA(t,"fragment",i,a._contextWasLost);return n(s,o,l,i,r,a.validateShaderPrograms)}function kA(s,e,t,i,r,n=null,a){let o=ir(r);a||(a=o._createShaderProgramInjection??Dp);let l=o._webGLVersion>1?`#version 300 es
#define WEBGL2 
`:"",c=QD(e,"vertex",i,l,r,o._contextWasLost),f=QD(t,"fragment",i,l,r,o._contextWasLost);return a(s,c,f,r,n,o.validateShaderPrograms)}function jD(s,e){let t=new Mp,i=ir(s);return i.parallelShaderCompile&&!i.disableParallelShaderCompile&&(t.isParallelCompiled=!0),t.context=i._context,t}function Dp(s,e,t,i,r=null,n){let a=i.createProgram();if(s.program=a,!a)throw new Error("Unable to create program");return i.attachShader(a,e),i.attachShader(a,t),i.linkProgram(a),s.context=i,s.vertexShader=e,s.fragmentShader=t,s.isParallelCompiled||Op(s,i,n),a}function ZD(s,e,t){let i=s;if(i._isDisposed)return!1;let r=ir(e);return r&&r.parallelShaderCompile&&r.parallelShaderCompile.COMPLETION_STATUS_KHR&&i.program&&e.getProgramParameter(i.program,r.parallelShaderCompile.COMPLETION_STATUS_KHR)?(Op(i,e,t),!0):!1}function Op(s,e,t){let i=s.context,r=s.vertexShader,n=s.fragmentShader,a=s.program;if(!i.getProgramParameter(a,i.LINK_STATUS)){if(!e.getShaderParameter(r,e.COMPILE_STATUS)){let c=e.getShaderInfoLog(r);if(c)throw s.vertexCompilationError=c,new Error("VERTEX SHADER "+c)}if(!e.getShaderParameter(n,e.COMPILE_STATUS)){let c=e.getShaderInfoLog(n);if(c)throw s.fragmentCompilationError=c,new Error("FRAGMENT SHADER "+c)}let l=i.getProgramInfoLog(a);if(l)throw s.programLinkError=l,new Error(l)}if(t&&(i.validateProgram(a),!i.getProgramParameter(a,i.VALIDATE_STATUS))){let c=i.getProgramInfoLog(a);if(c)throw s.programValidationError=c,new Error(c)}i.deleteShader(r),i.deleteShader(n),s.vertexShader=void 0,s.fragmentShader=void 0,s.onCompiled&&(s.onCompiled(),s.onCompiled=void 0)}function JD(s,e,t,i,r,n,a,o,l,c="",f,h,u){let d=ir(s.context);h||(h=d.createRawShaderProgramInjection??VA),u||(u=d.createShaderProgramInjection??kA);let p=s;i?p.program=h(p,e,t,p.context,l):p.program=u(p,e,t,o,p.context,l),p.program.__SPECTOR_rebuildProgram=a,f()}function QD(s,e,t,i,r,n){return GA(Tp(s,t,i),e,r,n)}function GA(s,e,t,i){let r=t.createShader(e==="vertex"?t.VERTEX_SHADER:t.FRAGMENT_SHADER);if(!r){let n=t.NO_ERROR,a=t.NO_ERROR;for(;(a=t.getError())!==t.NO_ERROR;)n=a;throw new Error(`Something went wrong while creating a gl ${e} shader object. gl error=${n}, gl isContextLost=${t.isContextLost()}, _contextWasLost=${i}`)}return t.shaderSource(r,s),t.compileShader(r),r}function $D(s,e){e.useProgram(s)}function eO(s,e){let t=s;if(!t.isParallelCompiled){e(s);return}let i=t.onCompiled;t.onCompiled=()=>{i?.(),e(s)}}var UA,Q9,WA=S(()=>{qD();fa();UA=new WeakMap,Q9={_webGLVersion:2,cachedPipelines:{}}});function iO(s,e){return ir(e).cachedPipelines[s]}function Dc(s){let e=s._name,t=s.context;if(e&&t){let i=ir(t);i.cachedPipelines[e]?.dispose(),delete i.cachedPipelines[e]}}function rO(s,e,t,i,r,n,a){let o,l,c=jt()?n?.getHostDocument():null;typeof e=="string"?o=e:e.vertexSource?o="source:"+e.vertexSource:e.vertexElement?o=c?.getElementById(e.vertexElement)||e.vertexElement:o=e.vertex||e,typeof e=="string"?l=e:e.fragmentSource?l="source:"+e.fragmentSource:e.fragmentElement?l=c?.getElementById(e.fragmentElement)||e.fragmentElement:l=e.fragment||e;let f=[void 0,void 0],h=()=>{if(f[0]&&f[1]){s.isFragment=!0;let[u,d]=f;Pc(d,s,(p,m)=>{a&&(a._fragmentSourceCodeBeforeMigration=m),t&&(p=t("fragment",p));let _=Ip(u,p,s);s=null;let v=j9(_.vertexCode,_.fragmentCode,e,r);i?.(v.vertexSourceCode,v.fragmentSourceCode)},n)}};tO(o,"Vertex","",u=>{Cp(s),Pc(u,s,(d,p)=>{a&&(a._rawVertexSourceCode=u,a._vertexSourceCodeBeforeMigration=p),t&&(d=t("vertex",d)),f[0]=d,h()},n)},r),tO(l,"Fragment","Pixel",u=>{a&&(a._rawFragmentSourceCode=u),f[1]=u,h()},r)}function tO(s,e,t,i,r,n){if(typeof HTMLElement<"u"&&s instanceof HTMLElement){let l=hp(s);i(l);return}if(s.substring(0,7)==="source:"){i(s.substring(7));return}if(s.substring(0,7)==="base64:"){let l=window.atob(s.substring(7));i(l);return}let a=g.GetShadersStore(r);if(a[s+e+"Shader"]){i(a[s+e+"Shader"]);return}if(t&&a[s+t+"Shader"]){i(a[s+t+"Shader"]);return}let o;if(s[0]==="."||s[0]==="/"||s.indexOf("http")>-1?o=s:o=g.GetShadersRepository(r)+s,n=n||xp,!n)throw new Error("loadFileInjection is not defined");n(o+"."+e.toLowerCase()+".fx",i)}function j9(s,e,t,i){if(t){let r=t.vertexElement||t.vertex||t.spectorName||t,n=t.fragmentElement||t.fragment||t.spectorName||t;return{vertexSourceCode:(i===1?"//":"")+"#define SHADER_NAME vertex:"+r+`
`+s,fragmentSourceCode:(i===1?"//":"")+"#define SHADER_NAME fragment:"+n+`
`+e}}else return{vertexSourceCode:s,fragmentSourceCode:e}}var sO,Lp=S(()=>{Cs();WA();O();Ee();Mh();fa();sO=(s,e,t,i)=>{try{let r=s.context?ir(s.context):null;r&&(r.disableParallelShaderCompile=s.disableParallelCompilation);let n=s.existingPipelineContext||e(s.shaderProcessingContext);return n._name=s.name,s.name&&r&&(r.cachedPipelines[s.name]=n),t(n,s.vertex,s.fragment,!!s.createAsRaw,"","",s.rebuildRebind,s.defines,s.transformFeedbackVaryings,"",()=>{i(n,()=>{s.onRenderingStateCompiled?.(n)})}),n}catch(r){throw P.Error("Error compiling effect"),r}}});var li,dl=S(()=>{we();Ee();O();Lp();ys();li=class s{static get ShadersRepository(){return g.ShadersRepository}static set ShadersRepository(e){g.ShadersRepository=e}get isDisposed(){return this._isDisposed}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new N),this._onBindObservable}get shaderLanguage(){return this._shaderLanguage}constructor(e,t,i,r=null,n,a=null,o=null,l=null,c=null,f,h="",u=0,d){this.defines="",this.onCompiled=null,this.onError=null,this.onBind=null,this.uniqueId=0,this.onCompileObservable=new N,this.onErrorObservable=new N,this._onBindObservable=null,this._isDisposed=!1,this._refCount=1,this._bonesComputationForcedToCPU=!1,this._uniformBuffersNames={},this._multiTarget=!1,this._samplers={},this._isReady=!1,this._compilationError="",this._allFallbacksProcessed=!1,this._uniforms={},this._key="",this._fallbacks=null,this._vertexSourceCodeOverride="",this._fragmentSourceCodeOverride="",this._transformFeedbackVaryings=null,this._disableParallelShaderCompilation=!1,this._pipelineContext=null,this._vertexSourceCode="",this._fragmentSourceCode="",this._vertexSourceCodeBeforeMigration="",this._fragmentSourceCodeBeforeMigration="",this._rawVertexSourceCode="",this._rawFragmentSourceCode="",this._processCodeAfterIncludes=void 0,this._processFinalCode=null,this.name=e,this._key=h;let p=this._key.replace(/\r/g,"").replace(/\n/g,"|"),m;if(t.attributes){let _=t;if(this._engine=i,this._attributesNames=_.attributes,this._uniformsNames=_.uniformsNames.concat(_.samplers),this._samplerList=_.samplers.slice(),this.defines=_.defines,this.onError=_.onError,this.onCompiled=_.onCompiled,this._fallbacks=_.fallbacks,this._indexParameters=_.indexParameters,this._transformFeedbackVaryings=_.transformFeedbackVaryings||null,this._multiTarget=!!_.multiTarget,this._shaderLanguage=_.shaderLanguage??0,this._disableParallelShaderCompilation=!!_.disableParallelShaderCompilation,_.uniformBuffersNames){this._uniformBuffersNamesList=_.uniformBuffersNames.slice();for(let v=0;v<_.uniformBuffersNames.length;v++)this._uniformBuffersNames[_.uniformBuffersNames[v]]=v}this._processFinalCode=_.processFinalCode??null,this._processCodeAfterIncludes=_.processCodeAfterIncludes??void 0,d=_.extraInitializationsAsync,m=_.existingPipelineContext}else this._engine=n,this.defines=a??"",this._uniformsNames=i.concat(r),this._samplerList=r?r.slice():[],this._attributesNames=t,this._uniformBuffersNamesList=[],this._shaderLanguage=u,this.onError=c,this.onCompiled=l,this._indexParameters=f,this._fallbacks=o;this._engine.shaderPlatformName==="WEBGL2"&&(m=iO(p,this._engine._gl)??m),this._attributeLocationByName={},this.uniqueId=s._UniqueIdSeed++,m?(this._pipelineContext=m,this._pipelineContext.setEngine(this._engine),this._onRenderingStateCompiled(this._pipelineContext),this._pipelineContext.program&&(this._pipelineContext.program.__SPECTOR_rebuildProgram=this._rebuildProgram.bind(this))):this._processShaderCodeAsync(null,!1,null,d),this._engine.onReleaseEffectsObservable.addOnce(()=>{this.isDisposed||this.dispose(!0)})}async _processShaderCodeAsync(e=null,t=!1,i=null,r){r&&await r(),this._processingContext=i||this._engine._getShaderProcessingContext(this._shaderLanguage,!1);let n={defines:this.defines.split(`
`),indexParameters:this._indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:e??this._engine._getShaderProcessor(this._shaderLanguage),supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:g.GetShadersRepository(this._shaderLanguage),includesShadersStore:g.GetIncludesShadersStore(this._shaderLanguage),version:(this._engine.version*100).toString(),platformName:this._engine.shaderPlatformName,processingContext:this._processingContext,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:this._processCodeAfterIncludes};rO(n,this.name,this._processFinalCode,(a,o)=>{this._vertexSourceCode=a,this._fragmentSourceCode=o,this._prepareEffect(t)},this._shaderLanguage,this._engine,this)}get key(){return this._key}isReady(){try{return this._isReadyInternal()}catch{return!1}}_isReadyInternal(){return this._engine.isDisposed||this._isReady?!0:this._pipelineContext?this._pipelineContext.isReady:!1}getEngine(){return this._engine}getPipelineContext(){return this._pipelineContext}getAttributesNames(){return this._attributesNames}getAttributeLocation(e){return this._attributes[e]}getAttributeLocationByName(e){return this._attributeLocationByName[e]}getAttributesCount(){return this._attributes.length}getUniformIndex(e){return this._uniformsNames.indexOf(e)}getUniform(e){return this._uniforms[e]}getSamplers(){return this._samplerList}getUniformNames(){return this._uniformsNames}getUniformBuffersNames(){return this._uniformBuffersNamesList}getIndexParameters(){return this._indexParameters}getCompilationError(){return this._compilationError}allFallbacksProcessed(){return this._allFallbacksProcessed}async whenCompiledAsync(){return await new Promise(e=>{this.executeWhenCompiled(e)})}executeWhenCompiled(e){if(this.isReady()){e(this);return}this.onCompileObservable.add(t=>{e(t)}),(!this._pipelineContext||this._pipelineContext.isAsync)&&this._checkIsReady(null)}_checkIsReady(e){br(()=>this._isReadyInternal()||this._isDisposed,()=>{},t=>{this._processCompilationErrors(t,e)},16,12e4,!0,` - Effect: ${typeof this.name=="string"?this.name:this.key}`)}get vertexSourceCode(){return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._vertexSourceCodeOverride:this._pipelineContext?._getVertexShaderCode()??this._vertexSourceCode}get fragmentSourceCode(){return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._fragmentSourceCodeOverride:this._pipelineContext?._getFragmentShaderCode()??this._fragmentSourceCode}get vertexSourceCodeBeforeMigration(){return this._vertexSourceCodeBeforeMigration}get fragmentSourceCodeBeforeMigration(){return this._fragmentSourceCodeBeforeMigration}get rawVertexSourceCode(){return this._rawVertexSourceCode}get rawFragmentSourceCode(){return this._rawFragmentSourceCode}getPipelineGenerationOptions(){return{platformName:this._engine.shaderPlatformName,shaderLanguage:this._shaderLanguage,shaderNameOrContent:this.name,key:this._key,defines:this.defines.split(`
`),addGlobalDefines:!1,extendedProcessingOptions:{indexParameters:this._indexParameters,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,supportsUniformBuffers:this._engine.supportsUniformBuffers},extendedCreatePipelineOptions:{transformFeedbackVaryings:this._transformFeedbackVaryings,createAsRaw:!!(this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride)}}}_rebuildProgram(e,t,i,r){this._isReady=!1,this._vertexSourceCodeOverride=e,this._fragmentSourceCodeOverride=t,this.onError=(n,a)=>{r&&r(a)},this.onCompiled=()=>{let n=this.getEngine().scenes;if(n)for(let a=0;a<n.length;a++)n[a].markAllMaterialsAsDirty(127);this._pipelineContext._handlesSpectorRebuildCallback?.(i)},this._fallbacks=null,this._prepareEffect()}_onRenderingStateCompiled(e){if(this._pipelineContext=e,this._pipelineContext.setEngine(this._engine),this._attributes=[],this._pipelineContext._fillEffectInformation(this,this._uniformBuffersNames,this._uniformsNames,this._uniforms,this._samplerList,this._samplers,this._attributesNames,this._attributes),this._attributesNames)for(let t=0;t<this._attributesNames.length;t++){let i=this._attributesNames[t];this._attributeLocationByName[i]=this._attributes[t]}this._engine.bindSamplers(this),this._compilationError="",this._isReady=!0,this.onCompiled&&this.onCompiled(this),this.onCompileObservable.notifyObservers(this),this.onCompileObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh(),s.AutomaticallyClearCodeCache&&this.clearCodeCache()}_prepareEffect(e=!1){let t=this._pipelineContext;this._isReady=!1;try{let i=!!(this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride),r=i?null:this.defines,n=i?this._vertexSourceCodeOverride:this._vertexSourceCode,a=i?this._fragmentSourceCodeOverride:this._fragmentSourceCode,o=this._engine;this._pipelineContext=sO({existingPipelineContext:e?t:null,vertex:n,fragment:a,context:o.shaderPlatformName==="WEBGL2"||o.shaderPlatformName==="WEBGL1"?o._gl:void 0,rebuildRebind:(l,c,f,h)=>this._rebuildProgram(l,c,f,h),defines:r,transformFeedbackVaryings:this._transformFeedbackVaryings,name:this._key.replace(/\r/g,"").replace(/\n/g,"|"),createAsRaw:i,disableParallelCompilation:this._disableParallelShaderCompilation,shaderProcessingContext:this._processingContext,onRenderingStateCompiled:l=>{t&&!e&&this._engine._deletePipelineContext(t),l&&this._onRenderingStateCompiled(l)}},this._engine.createPipelineContext.bind(this._engine),this._engine._preparePipelineContextAsync.bind(this._engine),this._engine._executeWhenRenderingStateIsCompiled.bind(this._engine)),this._pipelineContext.isAsync&&this._checkIsReady(t)}catch(i){this._processCompilationErrors(i,t)}}_getShaderCodeAndErrorLine(e,t,i){let r=i?/FRAGMENT SHADER ERROR: 0:(\d+?):/:/VERTEX SHADER ERROR: 0:(\d+?):/,n=null;if(t&&e){let a=t.match(r);if(a&&a.length===2){let o=parseInt(a[1]),l=e.split(`
`,-1);l.length>=o&&(n=`Offending line [${o}] in ${i?"fragment":"vertex"} code: ${l[o-1]}`)}}return[e,n]}_processCompilationErrors(e,t=null){this._compilationError=e.message;let i=this._attributesNames,r=this._fallbacks;if(P.Error("Unable to compile effect:"),P.Error(`Uniforms: ${this._uniformsNames.join(" ")}`),P.Error(`Attributes: ${i.join(" ")}`),P.Error(`Defines:
`+this.defines),s.LogShaderCodeOnCompilationError){let a=null,o=null,l=null;this._pipelineContext?._getVertexShaderCode()&&([l,a]=this._getShaderCodeAndErrorLine(this._pipelineContext._getVertexShaderCode(),this._compilationError,!1),l&&(P.Error("Vertex code:"),P.Error(l))),this._pipelineContext?._getFragmentShaderCode()&&([l,o]=this._getShaderCodeAndErrorLine(this._pipelineContext?._getFragmentShaderCode(),this._compilationError,!0),l&&(P.Error("Fragment code:"),P.Error(l))),a&&P.Error(a),o&&P.Error(o)}P.Error("Error: "+this._compilationError);let n=()=>{this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this),this._engine.onEffectErrorObservable.notifyObservers({effect:this,errors:this._compilationError})};t&&(this._pipelineContext=t,this._isReady=!0,n()),r?(this._pipelineContext=null,r.hasMoreFallbacks?(this._allFallbacksProcessed=!1,P.Error("Trying next fallback."),this.defines=r.reduce(this.defines,this),this._prepareEffect()):(this._allFallbacksProcessed=!0,n(),this.onErrorObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh())):(this._allFallbacksProcessed=!0,t||n())}get isSupported(){return this._compilationError===""}_bindTexture(e,t){this._engine._bindTexture(this._samplers[e],t,e)}setTexture(e,t){this._engine.setTexture(this._samplers[e],this._uniforms[e],t,e)}setTextureArray(e,t){let i=e+"Ex";if(this._samplerList.indexOf(i+"0")===-1){let r=this._samplerList.indexOf(e);for(let a=1;a<t.length;a++){let o=i+(a-1).toString();this._samplerList.splice(r+a,0,o)}let n=0;for(let a of this._samplerList)this._samplers[a]=n,n+=1}this._engine.setTextureArray(this._samplers[e],this._uniforms[e],t,e)}bindUniformBuffer(e,t){let i=this._uniformBuffersNames[t];i===void 0||s._BaseCache[i]===e&&this._engine._features.useUBOBindingCache||(s._BaseCache[i]=e,this._engine.bindUniformBufferBase(e,i,t))}bindUniformBlock(e,t){this._engine.bindUniformBlock(this._pipelineContext,e,t)}setInt(e,t){return this._pipelineContext.setInt(e,t),this}setInt2(e,t,i){return this._pipelineContext.setInt2(e,t,i),this}setInt3(e,t,i,r){return this._pipelineContext.setInt3(e,t,i,r),this}setInt4(e,t,i,r,n){return this._pipelineContext.setInt4(e,t,i,r,n),this}setIntArray(e,t){return this._pipelineContext.setIntArray(e,t),this}setIntArray2(e,t){return this._pipelineContext.setIntArray2(e,t),this}setIntArray3(e,t){return this._pipelineContext.setIntArray3(e,t),this}setIntArray4(e,t){return this._pipelineContext.setIntArray4(e,t),this}setUInt(e,t){return this._pipelineContext.setUInt(e,t),this}setUInt2(e,t,i){return this._pipelineContext.setUInt2(e,t,i),this}setUInt3(e,t,i,r){return this._pipelineContext.setUInt3(e,t,i,r),this}setUInt4(e,t,i,r,n){return this._pipelineContext.setUInt4(e,t,i,r,n),this}setUIntArray(e,t){return this._pipelineContext.setUIntArray(e,t),this}setUIntArray2(e,t){return this._pipelineContext.setUIntArray2(e,t),this}setUIntArray3(e,t){return this._pipelineContext.setUIntArray3(e,t),this}setUIntArray4(e,t){return this._pipelineContext.setUIntArray4(e,t),this}setFloatArray(e,t){return this._pipelineContext.setArray(e,t),this}setFloatArray2(e,t){return this._pipelineContext.setArray2(e,t),this}setFloatArray3(e,t){return this._pipelineContext.setArray3(e,t),this}setFloatArray4(e,t){return this._pipelineContext.setArray4(e,t),this}setArray(e,t){return this._pipelineContext.setArray(e,t),this}setArray2(e,t){return this._pipelineContext.setArray2(e,t),this}setArray3(e,t){return this._pipelineContext.setArray3(e,t),this}setArray4(e,t){return this._pipelineContext.setArray4(e,t),this}setMatrices(e,t){return this._pipelineContext.setMatrices(e,t),this}setMatrix(e,t){return this._pipelineContext.setMatrix(e,t),this}setMatrix3x3(e,t){return this._pipelineContext.setMatrix3x3(e,t),this}setMatrix2x2(e,t){return this._pipelineContext.setMatrix2x2(e,t),this}setFloat(e,t){return this._pipelineContext.setFloat(e,t),this}setBool(e,t){return this._pipelineContext.setInt(e,t?1:0),this}setVector2(e,t){return this._pipelineContext.setVector2(e,t),this}setFloat2(e,t,i){return this._pipelineContext.setFloat2(e,t,i),this}setVector3(e,t){return this._pipelineContext.setVector3(e,t),this}setFloat3(e,t,i,r){return this._pipelineContext.setFloat3(e,t,i,r),this}setVector4(e,t){return this._pipelineContext.setVector4(e,t),this}setQuaternion(e,t){return this._pipelineContext.setQuaternion(e,t),this}setFloat4(e,t,i,r,n){return this._pipelineContext.setFloat4(e,t,i,r,n),this}setColor3(e,t){return this._pipelineContext.setColor3(e,t),this}setColor4(e,t,i){return this._pipelineContext.setColor4(e,t,i),this}setDirectColor4(e,t){return this._pipelineContext.setDirectColor4(e,t),this}clearCodeCache(){this._vertexSourceCode="",this._fragmentSourceCode="",this._fragmentSourceCodeBeforeMigration="",this._vertexSourceCodeBeforeMigration=""}dispose(e=!1){if(e)this._refCount=0;else{if(s.PersistentMode)return;this._refCount--}this._refCount>0||this._isDisposed||(this._pipelineContext&&Dc(this._pipelineContext),this._engine._releaseEffect(this),this.clearCodeCache(),this._isDisposed=!0)}static RegisterShader(e,t,i,r=0){t&&(g.GetShadersStore(r)[`${e}PixelShader`]=t),i&&(g.GetShadersStore(r)[`${e}VertexShader`]=i)}static ResetCache(){s._BaseCache={}}};li.LogShaderCodeOnCompilationError=!0;li.PersistentMode=!1;li.AutomaticallyClearCodeCache=!1;li._UniqueIdSeed=0;li._BaseCache={};li.ShadersStore=g.ShadersStore;li.IncludesShadersStore=g.IncludesShadersStore});var Oc,HA=S(()=>{Oc=class{constructor(e=!0){this._isDepthTestDirty=!1,this._isDepthMaskDirty=!1,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!1,this._isFrontFaceDirty=!1,e&&this.reset()}get isDirty(){return this._isDepthFuncDirty||this._isDepthTestDirty||this._isDepthMaskDirty||this._isCullFaceDirty||this._isCullDirty||this._isZOffsetDirty||this._isFrontFaceDirty}get zOffset(){return this._zOffset}set zOffset(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0)}get zOffsetUnits(){return this._zOffsetUnits}set zOffsetUnits(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=!0)}get cullFace(){return this._cullFace}set cullFace(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0)}get cull(){return this._cull}set cull(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0)}get depthFunc(){return this._depthFunc}set depthFunc(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0)}get depthMask(){return this._depthMask}set depthMask(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0)}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0)}get frontFace(){return this._frontFace}set frontFace(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0)}reset(){this._depthMask=!0,this._depthTest=!0,this._depthFunc=null,this._cullFace=null,this._cull=null,this._zOffset=0,this._zOffsetUnits=0,this._frontFace=null,this._isDepthTestDirty=!0,this._isDepthMaskDirty=!0,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!0,this._isFrontFaceDirty=!1}apply(e){this.isDirty&&(this._isCullDirty&&(this.cull?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),this._isCullDirty=!1),this._isCullFaceDirty&&(e.cullFace(this.cullFace),this._isCullFaceDirty=!1),this._isDepthMaskDirty&&(e.depthMask(this.depthMask),this._isDepthMaskDirty=!1),this._isDepthTestDirty&&(this.depthTest?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this._isDepthTestDirty=!1),this._isDepthFuncDirty&&(e.depthFunc(this.depthFunc),this._isDepthFuncDirty=!1),this._isZOffsetDirty&&(this.zOffset||this.zOffsetUnits?(e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(this.zOffset,this.zOffsetUnits)):e.disable(e.POLYGON_OFFSET_FILL),this._isZOffsetDirty=!1),this._isFrontFaceDirty&&(e.frontFace(this.frontFace),this._isFrontFaceDirty=!1))}}});var Lc,zA=S(()=>{Lc=class{get isDirty(){return this._isStencilTestDirty||this._isStencilMaskDirty||this._isStencilFuncDirty||this._isStencilOpDirty}get func(){return this._func}set func(e){this._func!==e&&(this._func=e,this._isStencilFuncDirty=!0)}get backFunc(){return this._func}set backFunc(e){this._backFunc!==e&&(this._backFunc=e,this._isStencilFuncDirty=!0)}get funcRef(){return this._funcRef}set funcRef(e){this._funcRef!==e&&(this._funcRef=e,this._isStencilFuncDirty=!0)}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask!==e&&(this._funcMask=e,this._isStencilFuncDirty=!0)}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._isStencilOpDirty=!0)}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._isStencilOpDirty=!0)}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._isStencilOpDirty=!0)}get backOpStencilFail(){return this._backOpStencilFail}set backOpStencilFail(e){this._backOpStencilFail!==e&&(this._backOpStencilFail=e,this._isStencilOpDirty=!0)}get backOpDepthFail(){return this._backOpDepthFail}set backOpDepthFail(e){this._backOpDepthFail!==e&&(this._backOpDepthFail=e,this._isStencilOpDirty=!0)}get backOpStencilDepthPass(){return this._backOpStencilDepthPass}set backOpStencilDepthPass(e){this._backOpStencilDepthPass!==e&&(this._backOpStencilDepthPass=e,this._isStencilOpDirty=!0)}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._isStencilMaskDirty=!0)}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this._isStencilTestDirty=!0)}constructor(e=!0){this._isStencilTestDirty=!1,this._isStencilMaskDirty=!1,this._isStencilFuncDirty=!1,this._isStencilOpDirty=!1,this.useStencilGlobalOnly=!1,e&&this.reset()}reset(){this.stencilMaterial=void 0,this.stencilGlobal?.reset(),this._isStencilTestDirty=!0,this._isStencilMaskDirty=!0,this._isStencilFuncDirty=!0,this._isStencilOpDirty=!0}apply(e){if(!e)return;let t=!this.useStencilGlobalOnly&&!!this.stencilMaterial?.enabled;this.enabled=t?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.func=t?this.stencilMaterial.func:this.stencilGlobal.func,this.backFunc=t?this.stencilMaterial.backFunc:this.stencilGlobal.backFunc,this.funcRef=t?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=t?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.opStencilFail=t?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=t?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=t?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.backOpStencilFail=t?this.stencilMaterial.backOpStencilFail:this.stencilGlobal.backOpStencilFail,this.backOpDepthFail=t?this.stencilMaterial.backOpDepthFail:this.stencilGlobal.backOpDepthFail,this.backOpStencilDepthPass=t?this.stencilMaterial.backOpStencilDepthPass:this.stencilGlobal.backOpStencilDepthPass,this.mask=t?this.stencilMaterial.mask:this.stencilGlobal.mask,this.isDirty&&(this._isStencilTestDirty&&(this.enabled?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this._isStencilTestDirty=!1),this._isStencilMaskDirty&&(e.stencilMask(this.mask),this._isStencilMaskDirty=!1),this._isStencilFuncDirty&&(e.stencilFuncSeparate(e.FRONT,this.func,this.funcRef,this.funcMask),e.stencilFuncSeparate(e.BACK,this.backFunc,this.funcRef,this.funcMask),this._isStencilFuncDirty=!1),this._isStencilOpDirty&&(e.stencilOpSeparate(e.FRONT,this.opStencilFail,this.opDepthFail,this.opStencilDepthPass),e.stencilOpSeparate(e.BACK,this.backOpStencilFail,this.backOpDepthFail,this.backOpStencilDepthPass),this._isStencilOpDirty=!1))}}});var pl,nO=S(()=>{pl=class s{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.funcRef=1,this.funcMask=255,this.func=s.ALWAYS,this.opStencilFail=s.KEEP,this.opDepthFail=s.KEEP,this.opStencilDepthPass=s.REPLACE,this.backFunc=s.ALWAYS,this.backOpStencilFail=s.KEEP,this.backOpDepthFail=s.KEEP,this.backOpStencilDepthPass=s.REPLACE}get stencilFunc(){return this.func}set stencilFunc(e){this.func=e}get stencilBackFunc(){return this.backFunc}set stencilBackFunc(e){this.backFunc=e}get stencilFuncRef(){return this.funcRef}set stencilFuncRef(e){this.funcRef=e}get stencilFuncMask(){return this.funcMask}set stencilFuncMask(e){this.funcMask=e}get stencilOpStencilFail(){return this.opStencilFail}set stencilOpStencilFail(e){this.opStencilFail=e}get stencilOpDepthFail(){return this.opDepthFail}set stencilOpDepthFail(e){this.opDepthFail=e}get stencilOpStencilDepthPass(){return this.opStencilDepthPass}set stencilOpStencilDepthPass(e){this.opStencilDepthPass=e}get stencilBackOpStencilFail(){return this.backOpStencilFail}set stencilBackOpStencilFail(e){this.backOpStencilFail=e}get stencilBackOpDepthFail(){return this.backOpDepthFail}set stencilBackOpDepthFail(e){this.backOpDepthFail=e}get stencilBackOpStencilDepthPass(){return this.backOpStencilDepthPass}set stencilBackOpStencilDepthPass(e){this.backOpStencilDepthPass=e}get stencilMask(){return this.mask}set stencilMask(e){this.mask=e}get stencilTest(){return this.enabled}set stencilTest(e){this.enabled=e}};pl.ALWAYS=519;pl.KEEP=7680;pl.REPLACE=7681});var go,wp=S(()=>{go=class{constructor(e){this._supportBlendParametersPerTarget=e,this._blendFunctionParameters=new Array(32),this._blendEquationParameters=new Array(16),this._blendConstants=new Array(4),this._isBlendConstantsDirty=!1,this._alphaBlend=Array(8).fill(!1),this._numTargetEnabled=0,this._isAlphaBlendDirty=!1,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this.reset()}get isDirty(){return this._isAlphaBlendDirty||this._isBlendFunctionParametersDirty||this._isBlendEquationParametersDirty}get alphaBlend(){return this._numTargetEnabled>0}setAlphaBlend(e,t=0){this._alphaBlend[t]!==e&&(e?this._numTargetEnabled++:this._numTargetEnabled--,this._alphaBlend[t]=e,this._isAlphaBlendDirty=!0)}setAlphaBlendConstants(e,t,i,r){this._blendConstants[0]===e&&this._blendConstants[1]===t&&this._blendConstants[2]===i&&this._blendConstants[3]===r||(this._blendConstants[0]=e,this._blendConstants[1]=t,this._blendConstants[2]=i,this._blendConstants[3]=r,this._isBlendConstantsDirty=!0)}setAlphaBlendFunctionParameters(e,t,i,r,n=0){let a=n*4;this._blendFunctionParameters[a+0]===e&&this._blendFunctionParameters[a+1]===t&&this._blendFunctionParameters[a+2]===i&&this._blendFunctionParameters[a+3]===r||(this._blendFunctionParameters[a+0]=e,this._blendFunctionParameters[a+1]=t,this._blendFunctionParameters[a+2]=i,this._blendFunctionParameters[a+3]=r,this._isBlendFunctionParametersDirty=!0)}setAlphaEquationParameters(e,t,i=0){let r=i*2;this._blendEquationParameters[r+0]===e&&this._blendEquationParameters[r+1]===t||(this._blendEquationParameters[r+0]=e,this._blendEquationParameters[r+1]=t,this._isBlendEquationParametersDirty=!0)}reset(){this._alphaBlend.fill(!1),this._numTargetEnabled=0,this._blendFunctionParameters.fill(null),this._blendEquationParameters.fill(null),this._blendConstants[0]=null,this._blendConstants[1]=null,this._blendConstants[2]=null,this._blendConstants[3]=null,this._isAlphaBlendDirty=!0,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this._isBlendConstantsDirty=!1}apply(e,t=1){if(!this.isDirty)return;if(this._isBlendConstantsDirty&&(e.blendColor(this._blendConstants[0],this._blendConstants[1],this._blendConstants[2],this._blendConstants[3]),this._isBlendConstantsDirty=!1),t===1||!this._supportBlendParametersPerTarget){this._isAlphaBlendDirty&&(this._alphaBlend[0]?e.enable(e.BLEND):e.disable(e.BLEND),this._isAlphaBlendDirty=!1),this._isBlendFunctionParametersDirty&&(e.blendFuncSeparate(this._blendFunctionParameters[0],this._blendFunctionParameters[1],this._blendFunctionParameters[2],this._blendFunctionParameters[3]),this._isBlendFunctionParametersDirty=!1),this._isBlendEquationParametersDirty&&(e.blendEquationSeparate(this._blendEquationParameters[0],this._blendEquationParameters[1]),this._isBlendEquationParametersDirty=!1);return}let i=e;if(this._isAlphaBlendDirty){for(let r=0;r<t;r++){let n=r<this._numTargetEnabled?r:0;this._alphaBlend[n]?i.enableIndexed(e.BLEND,r):i.disableIndexed(e.BLEND,r)}this._isAlphaBlendDirty=!1}if(this._isBlendFunctionParametersDirty){for(let r=0;r<t;r++){let n=r<this._numTargetEnabled?r*4:0;i.blendFuncSeparateIndexed(r,this._blendFunctionParameters[n+0],this._blendFunctionParameters[n+1],this._blendFunctionParameters[n+2],this._blendFunctionParameters[n+3])}this._isBlendFunctionParametersDirty=!1}if(this._isBlendEquationParametersDirty){for(let r=0;r<t;r++){let n=r<this._numTargetEnabled?r*2:0;i.blendEquationSeparateIndexed(r,this._blendEquationParameters[n+0],this._blendEquationParameters[n+1])}this._isBlendEquationParametersDirty=!1}}setAlphaMode(e,t){let i=32774;switch(e){case 0:break;case 7:this.setAlphaBlendFunctionParameters(1,771,1,1,t);break;case 8:this.setAlphaBlendFunctionParameters(1,771,1,771,t);break;case 2:this.setAlphaBlendFunctionParameters(770,771,1,1,t);break;case 6:this.setAlphaBlendFunctionParameters(1,1,0,1,t);break;case 1:this.setAlphaBlendFunctionParameters(770,1,0,1,t);break;case 3:this.setAlphaBlendFunctionParameters(0,769,1,1,t),i=32778;break;case 4:this.setAlphaBlendFunctionParameters(774,0,1,1,t);break;case 5:this.setAlphaBlendFunctionParameters(770,769,1,1,t);break;case 9:this.setAlphaBlendFunctionParameters(32769,32770,32771,32772,t);break;case 10:this.setAlphaBlendFunctionParameters(1,769,1,771,t);break;case 11:this.setAlphaBlendFunctionParameters(1,1,1,1,t);break;case 12:this.setAlphaBlendFunctionParameters(772,1,0,0,t);break;case 13:this.setAlphaBlendFunctionParameters(775,769,773,771,t);break;case 14:this.setAlphaBlendFunctionParameters(1,771,1,771,t);break;case 15:this.setAlphaBlendFunctionParameters(1,1,1,0,t);break;case 16:this.setAlphaBlendFunctionParameters(775,769,0,1,t);break;case 17:this.setAlphaBlendFunctionParameters(770,771,1,771,t);break;case 18:this.setAlphaBlendFunctionParameters(1,1,1,1,t),i=32775;break;case 19:this.setAlphaBlendFunctionParameters(1,1,1,1,t),i=32776;break;case 20:this.setAlphaBlendFunctionParameters(1,35065,0,1,t);break}this.setAlphaEquationParameters(i,i,t)}}});var Fp,aO=S(()=>{Fp=class{get wrapU(){return this._cachedWrapU}set wrapU(e){this._cachedWrapU=e}get wrapV(){return this._cachedWrapV}set wrapV(e){this._cachedWrapV=e}get wrapR(){return this._cachedWrapR}set wrapR(e){this._cachedWrapR=e}get anisotropicFilteringLevel(){return this._cachedAnisotropicFilteringLevel}set anisotropicFilteringLevel(e){this._cachedAnisotropicFilteringLevel=e}get comparisonFunction(){return this._comparisonFunction}set comparisonFunction(e){this._comparisonFunction=e}get useMipMaps(){return this._useMipMaps}set useMipMaps(e){this._useMipMaps=e}constructor(){this.samplingMode=-1,this._useMipMaps=!0,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this._comparisonFunction=0}setParameters(e=1,t=1,i=1,r=1,n=2,a=0){return this._cachedWrapU=e,this._cachedWrapV=t,this._cachedWrapR=i,this._cachedAnisotropicFilteringLevel=r,this.samplingMode=n,this._comparisonFunction=a,this}compareSampler(e){return this._cachedWrapU===e._cachedWrapU&&this._cachedWrapV===e._cachedWrapV&&this._cachedWrapR===e._cachedWrapR&&this._cachedAnisotropicFilteringLevel===e._cachedAnisotropicFilteringLevel&&this.samplingMode===e.samplingMode&&this._comparisonFunction===e._comparisonFunction&&this._useMipMaps===e._useMipMaps}}});var oO,Je,vi=S(()=>{we();aO();(function(s){s[s.Unknown=0]="Unknown",s[s.Url=1]="Url",s[s.Temp=2]="Temp",s[s.Raw=3]="Raw",s[s.Dynamic=4]="Dynamic",s[s.RenderTarget=5]="RenderTarget",s[s.MultiRenderTarget=6]="MultiRenderTarget",s[s.Cube=7]="Cube",s[s.CubeRaw=8]="CubeRaw",s[s.CubePrefiltered=9]="CubePrefiltered",s[s.Raw3D=10]="Raw3D",s[s.Raw2DArray=11]="Raw2DArray",s[s.DepthStencil=12]="DepthStencil",s[s.CubeRawRGBD=13]="CubeRawRGBD",s[s.Depth=14]="Depth"})(oO||(oO={}));Je=class s extends Fp{get useMipMaps(){return this.generateMipMaps}set useMipMaps(e){this.generateMipMaps=e}get uniqueId(){return this._uniqueId}_setUniqueId(e){this._uniqueId=e}getEngine(){return this._engine}get source(){return this._source}constructor(e,t,i=!1){super(),this.isReady=!1,this.isCube=!1,this.is3D=!1,this.is2DArray=!1,this.isMultiview=!1,this.url="",this.generateMipMaps=!1,this.samples=0,this.type=-1,this.format=-1,this.onLoadedObservable=new N,this.onErrorObservable=new N,this.onRebuildCallback=null,this.width=0,this.height=0,this.depth=0,this.baseWidth=0,this.baseHeight=0,this.baseDepth=0,this.invertY=!1,this._invertVScale=!1,this._associatedChannel=-1,this._source=0,this._buffer=null,this._bufferView=null,this._bufferViewArray=null,this._bufferViewArrayArray=null,this._size=0,this._extension="",this._files=null,this._workingCanvas=null,this._workingContext=null,this._cachedCoordinatesMode=null,this._isDisabled=!1,this._compression=null,this._sphericalPolynomial=null,this._sphericalPolynomialPromise=null,this._sphericalPolynomialComputed=!1,this._lodGenerationScale=0,this._lodGenerationOffset=0,this._useSRGBBuffer=!1,this._creationFlags=0,this._lodTextureHigh=null,this._lodTextureMid=null,this._lodTextureLow=null,this._isRGBD=!1,this._linearSpecularLOD=!1,this._irradianceTexture=null,this._hardwareTexture=null,this._maxLodLevel=null,this._references=1,this._gammaSpace=null,this._premulAlpha=!1,this._dynamicTextureSource=null,this._autoMSAAManagement=!1,this._engine=e,this._source=t,this._uniqueId=s._Counter++,i||(this._hardwareTexture=e._createHardwareTexture())}incrementReferences(){this._references++}updateSize(e,t,i=1){this._engine.updateTextureDimensions(this,e,t,i),this.width=e,this.height=t,this.depth=i,this.baseWidth=e,this.baseHeight=t,this.baseDepth=i,this._size=e*t*i}_rebuild(){if(this.isReady=!1,this._cachedCoordinatesMode=null,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this.onRebuildCallback){let t=this.onRebuildCallback(this),i=r=>{r._swapAndDie(this,!1),this.isReady=t.isReady};t.isAsync?t.proxy.then(i):i(t.proxy);return}let e;switch(this.source){case 2:break;case 1:e=this._engine.createTexture(this._originalUrl??this.url,!this.generateMipMaps,this.invertY,null,this.samplingMode,t=>{t._swapAndDie(this,!1),this.isReady=!0},null,this._buffer,void 0,this.format,this._extension,void 0,void 0,void 0,this._useSRGBBuffer);return;case 3:e=this._engine.createRawTexture(this._bufferView,this.baseWidth,this.baseHeight,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type,this._creationFlags,this._useSRGBBuffer),e._swapAndDie(this,!1),this.isReady=!0;break;case 10:e=this._engine.createRawTexture3D(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),e._swapAndDie(this,!1),this.isReady=!0;break;case 11:e=this._engine.createRawTexture2DArray(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),e._swapAndDie(this,!1),this.isReady=!0;break;case 4:e=this._engine.createDynamicTexture(this.baseWidth,this.baseHeight,this.generateMipMaps,this.samplingMode),e._swapAndDie(this,!1),this._dynamicTextureSource&&this._engine.updateDynamicTexture(this,this._dynamicTextureSource,this.invertY,this._premulAlpha,this.format,!0);break;case 7:e=this._engine.createCubeTexture(this.url,null,this._files,!this.generateMipMaps,()=>{e._swapAndDie(this,!1),this.isReady=!0},null,this.format,this._extension,!1,0,0,null,void 0,this._useSRGBBuffer,ArrayBuffer.isView(this._buffer)?this._buffer:null);return;case 8:e=this._engine.createRawCubeTexture(this._bufferViewArray,this.width,this._originalFormat??this.format,this.type,this.generateMipMaps,this.invertY,this.samplingMode,this._compression),e._swapAndDie(this,!1),this.isReady=!0;break;case 13:return;case 9:e=this._engine.createPrefilteredCubeTexture(this.url,null,this._lodGenerationScale,this._lodGenerationOffset,t=>{t&&t._swapAndDie(this,!1),this.isReady=!0},null,this.format,this._extension),e._sphericalPolynomial=this._sphericalPolynomial;return;case 12:case 14:break}}_swapAndDie(e,t=!0){this._hardwareTexture?.setUsage(e._source,this.generateMipMaps,this.is2DArray,this.isCube,this.is3D,this.width,this.height,this.depth),e._hardwareTexture=this._hardwareTexture,t&&(e._isRGBD=this._isRGBD),this._lodTextureHigh&&(e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureHigh=this._lodTextureHigh),this._lodTextureMid&&(e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureMid=this._lodTextureMid),this._lodTextureLow&&(e._lodTextureLow&&e._lodTextureLow.dispose(),e._lodTextureLow=this._lodTextureLow),this._irradianceTexture&&(e._irradianceTexture&&e._irradianceTexture.dispose(),e._irradianceTexture=this._irradianceTexture);let i=this._engine.getLoadedTexturesCache(),r=i.indexOf(this);r!==-1&&i.splice(r,1),r=i.indexOf(e),r===-1&&i.push(e)}dispose(){this._references--,this._references===0&&(this.onLoadedObservable.clear(),this.onErrorObservable.clear(),this._engine._releaseTexture(this),this._hardwareTexture=null,this._dynamicTextureSource=null)}};Je._Counter=0});function YA(s){return s.split(" ").filter(e=>e!=="").map(e=>parseFloat(e))}function XA(s,e,t){for(;t.length!==e;){let i=YA(s.lines[s.index++]);t.push(...i)}}function Z9(s,e,t){let i=0,r=0,n=0,a=0,o=0,l=0;for(let v=0;v<s.numberOfHorizontalAngles-1;v++)if(t<s.horizontalAngles[v+1]||v===s.numberOfHorizontalAngles-2){r=v,n=s.horizontalAngles[v],a=s.horizontalAngles[v+1];break}for(let v=0;v<s.numberOfVerticalAngles-1;v++)if(e<s.verticalAngles[v+1]||v===s.numberOfVerticalAngles-2){i=v,o=s.verticalAngles[v],l=s.verticalAngles[v+1];break}let c=a-n,f=l-o;if(f===0)return 0;let h=c===0?0:(t-n)/c,u=(e-o)/f,d=c===0?r:r+1,p=As(s.candelaValues[r][i],s.candelaValues[d][i],h),m=As(s.candelaValues[r][i+1],s.candelaValues[d][i+1],h);return As(p,m,u)}function lO(s){let i={lines:new TextDecoder("utf-8").decode(s).split(`
`),index:0},r={version:i.lines[0],candelaValues:[],horizontalAngles:[],verticalAngles:[],numberOfHorizontalAngles:0,numberOfVerticalAngles:0};for(i.index=1;i.lines.length>0&&!i.lines[i.index].includes("TILT=");)i.index++;i.lines[i.index].includes("INCLUDE"),i.index++;let n=YA(i.lines[i.index++]);r.numberOfLights=n[0],r.lumensPerLamp=n[1],r.candelaMultiplier=n[2],r.numberOfVerticalAngles=n[3],r.numberOfHorizontalAngles=n[4],r.photometricType=n[5],r.unitsType=n[6],r.width=n[7],r.length=n[8],r.height=n[9];let a=YA(i.lines[i.index++]);r.ballastFactor=a[0],r.fileGenerationType=a[1],r.inputWatts=a[2];for(let p=0;p<r.numberOfHorizontalAngles;p++)r.candelaValues[p]=[];XA(i,r.numberOfVerticalAngles,r.verticalAngles),XA(i,r.numberOfHorizontalAngles,r.horizontalAngles);for(let p=0;p<r.numberOfHorizontalAngles;p++)XA(i,r.numberOfVerticalAngles,r.candelaValues[p]);let o=-1;for(let p=0;p<r.numberOfHorizontalAngles;p++)for(let m=0;m<r.numberOfVerticalAngles;m++)r.candelaValues[p][m]*=r.candelaValues[p][m]*r.candelaMultiplier*r.ballastFactor*r.fileGenerationType,o=Math.max(o,r.candelaValues[p][m]);if(o>0)for(let p=0;p<r.numberOfHorizontalAngles;p++)for(let m=0;m<r.numberOfVerticalAngles;m++)r.candelaValues[p][m]/=o;let l=180,c=l*2,f=c*l,h=new Float32Array(c*l),u=r.horizontalAngles[0],d=r.horizontalAngles[r.numberOfHorizontalAngles-1];for(let p=0;p<f;p++){let m=p%c,_=Math.floor(p/c);d-u!==0&&(m<u||m>=d)&&(m%=d*2,m>d&&(m=d*2-m)),h[_+m*l]=Z9(r,_,m)}return{width:c/2,height:1,data:h}}var cO=S(()=>{di()});var fO={};V(fO,{_IESTextureLoader:()=>KA});var KA,hO=S(()=>{cO();KA=class{constructor(){this.supportCascades=!1}loadCubeData(){throw".ies not supported in Cube."}loadData(e,t,i){let r=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),n=lO(r);i(n.width,n.height,t.useMipMaps,!1,()=>{let a=t.getEngine();t.type=1,t.format=6,t._gammaSpace=!1,a._uploadDataToTextureDirectly(t,n.data)})}}});var uO,Ms,dO,Ph=S(()=>{ie();(function(s){s[s.LOCAL=0]="LOCAL",s[s.WORLD=1]="WORLD",s[s.BONE=2]="BONE"})(uO||(uO={}));Ms=class{};Ms.X=new E(1,0,0);Ms.Y=new E(0,1,0);Ms.Z=new E(0,0,1);(function(s){s[s.X=0]="X",s[s.Y=1]="Y",s[s.Z=2]="Z"})(dO||(dO={}))});var Ks,wc=S(()=>{ie();Ks=class s{constructor(e,t,i,r){this.normal=new E(e,t,i),this.d=r}asArray(){return[this.normal.x,this.normal.y,this.normal.z,this.d]}clone(){return new s(this.normal.x,this.normal.y,this.normal.z,this.d)}getClassName(){return"Plane"}getHashCode(){let e=this.normal.getHashCode();return e=e*397^(this.d|0),e}normalize(){let e=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z),t=0;return e!==0&&(t=1/e),this.normal.x*=t,this.normal.y*=t,this.normal.z*=t,this.d*=t,this}transform(e){let t=s._TmpMatrix;e.invertToRef(t);let i=t.m,r=this.normal.x,n=this.normal.y,a=this.normal.z,o=this.d,l=r*i[0]+n*i[1]+a*i[2]+o*i[3],c=r*i[4]+n*i[5]+a*i[6]+o*i[7],f=r*i[8]+n*i[9]+a*i[10]+o*i[11],h=r*i[12]+n*i[13]+a*i[14]+o*i[15];return new s(l,c,f,h)}dotCoordinate(e){return this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z+this.d}copyFromPoints(e,t,i){let r=t.x-e.x,n=t.y-e.y,a=t.z-e.z,o=i.x-e.x,l=i.y-e.y,c=i.z-e.z,f=n*c-a*l,h=a*o-r*c,u=r*l-n*o,d=Math.sqrt(f*f+h*h+u*u),p;return d!==0?p=1/d:p=0,this.normal.x=f*p,this.normal.y=h*p,this.normal.z=u*p,this.d=-(this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z),this}isFrontFacingTo(e,t){return E.Dot(this.normal,e)<=t}signedDistanceTo(e){return E.Dot(e,this.normal)+this.d}static FromArray(e){return new s(e[0],e[1],e[2],e[3])}static FromPoints(e,t,i){let r=new s(0,0,0,0);return r.copyFromPoints(e,t,i),r}static FromPositionAndNormal(e,t){let i=new s(0,0,0,0);return this.FromPositionAndNormalToRef(e,t,i)}static FromPositionAndNormalToRef(e,t,i){return i.normal.copyFrom(t),i.normal.normalize(),i.d=-e.dot(i.normal),i}static SignedDistanceToPlaneFromPositionAndNormal(e,t,i){let r=-(t.x*e.x+t.y*e.y+t.z*e.z);return E.Dot(i,t)+r}};Ks._TmpMatrix=B.Identity()});var vo,Np=S(()=>{wc();vo=class s{static GetPlanes(e){let t=[];for(let i=0;i<6;i++)t.push(new Ks(0,0,0,0));return s.GetPlanesToRef(e,t),t}static GetNearPlaneToRef(e,t){let i=e.m;t.normal.x=i[3]+i[2],t.normal.y=i[7]+i[6],t.normal.z=i[11]+i[10],t.d=i[15]+i[14],t.normalize()}static GetFarPlaneToRef(e,t){let i=e.m;t.normal.x=i[3]-i[2],t.normal.y=i[7]-i[6],t.normal.z=i[11]-i[10],t.d=i[15]-i[14],t.normalize()}static GetLeftPlaneToRef(e,t){let i=e.m;t.normal.x=i[3]+i[0],t.normal.y=i[7]+i[4],t.normal.z=i[11]+i[8],t.d=i[15]+i[12],t.normalize()}static GetRightPlaneToRef(e,t){let i=e.m;t.normal.x=i[3]-i[0],t.normal.y=i[7]-i[4],t.normal.z=i[11]-i[8],t.d=i[15]-i[12],t.normalize()}static GetTopPlaneToRef(e,t){let i=e.m;t.normal.x=i[3]-i[1],t.normal.y=i[7]-i[5],t.normal.z=i[11]-i[9],t.d=i[15]-i[13],t.normalize()}static GetBottomPlaneToRef(e,t){let i=e.m;t.normal.x=i[3]+i[1],t.normal.y=i[7]+i[5],t.normal.z=i[11]+i[9],t.d=i[15]+i[13],t.normalize()}static GetPlanesToRef(e,t){s.GetNearPlaneToRef(e,t[0]),s.GetFarPlaneToRef(e,t[1]),s.GetLeftPlaneToRef(e,t[2]),s.GetRightPlaneToRef(e,t[3]),s.GetTopPlaneToRef(e,t[4]),s.GetBottomPlaneToRef(e,t[5])}static IsPointInFrustum(e,t){for(let i=0;i<6;i++)if(t[i].dotCoordinate(e)<0)return!1;return!0}}});var pO,Bp,qA=S(()=>{di();ie();xr();(function(s){s[s.CW=0]="CW",s[s.CCW=1]="CCW"})(pO||(pO={}));Bp=class{static Interpolate(e,t,i,r,n){if(e===0)return 0;let a=1-3*r+3*t,o=3*r-6*t,l=3*t,c=e;for(let f=0;f<5;f++){let h=c*c,u=h*c,d=a*u+o*h+l*c,p=1/(3*a*h+2*o*c+l);c-=(d-e)*p,c=Math.min(1,Math.max(0,c))}return 3*Math.pow(1-c,2)*c*i+3*(1-c)*Math.pow(c,2)*n+Math.pow(c,3)}}});var ha,Up=S(()=>{ha=class s{constructor(e,t){this.width=e,this.height=t}toString(){return`{W: ${this.width}, H: ${this.height}}`}getClassName(){return"Size"}getHashCode(){let e=this.width|0;return e=e*397^(this.height|0),e}copyFrom(e){this.width=e.width,this.height=e.height}copyFromFloats(e,t){return this.width=e,this.height=t,this}set(e,t){return this.copyFromFloats(e,t)}multiplyByFloats(e,t){return new s(this.width*e,this.height*t)}clone(){return new s(this.width,this.height)}equals(e){return e?this.width===e.width&&this.height===e.height:!1}get surface(){return this.width*this.height}static Zero(){return new s(0,0)}add(e){return new s(this.width+e.width,this.height+e.height)}subtract(e){return new s(this.width-e.width,this.height-e.height)}scale(e){return new s(this.width*e,this.height*e)}static Lerp(e,t,i){let r=e.width+(t.width-e.width)*i,n=e.height+(t.height-e.height)*i;return new s(r,n)}}});var mO=S(()=>{ie()});var So,Dh=S(()=>{So=class s{constructor(e,t,i,r){this.x=e,this.y=t,this.width=i,this.height=r}toGlobal(e,t){return new s(this.x*e,this.y*t,this.width*e,this.height*t)}toGlobalToRef(e,t,i){return i.x=this.x*e,i.y=this.y*t,i.width=this.width*e,i.height=this.height*t,this}clone(){return new s(this.x,this.y,this.width,this.height)}}});var ml=S(()=>{Ph();it();xr();Np();qA();wc();Up();ie();mO();Dh()});var Rn,J9,ua,da,_l,Ur,gl=S(()=>{ie();ml();Rn=[Math.sqrt(1/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(3/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(15/(4*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(5/(16*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(15/(16*Math.PI))],J9=[()=>1,s=>s.y,s=>s.z,s=>s.x,s=>s.x*s.y,s=>s.y*s.z,s=>3*s.z*s.z-1,s=>s.x*s.z,s=>s.x*s.x-s.y*s.y],ua=(s,e)=>Rn[s]*J9[s](e),da=[Math.PI,2*Math.PI/3,2*Math.PI/3,2*Math.PI/3,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4],_l=class s{constructor(){this.preScaled=!1,this.l00=E.Zero(),this.l1_1=E.Zero(),this.l10=E.Zero(),this.l11=E.Zero(),this.l2_2=E.Zero(),this.l2_1=E.Zero(),this.l20=E.Zero(),this.l21=E.Zero(),this.l22=E.Zero()}addLight(e,t,i){w.Vector3[0].set(t.r,t.g,t.b);let r=w.Vector3[0],n=w.Vector3[1];r.scaleToRef(i,n),n.scaleToRef(ua(0,e),w.Vector3[2]),this.l00.addInPlace(w.Vector3[2]),n.scaleToRef(ua(1,e),w.Vector3[2]),this.l1_1.addInPlace(w.Vector3[2]),n.scaleToRef(ua(2,e),w.Vector3[2]),this.l10.addInPlace(w.Vector3[2]),n.scaleToRef(ua(3,e),w.Vector3[2]),this.l11.addInPlace(w.Vector3[2]),n.scaleToRef(ua(4,e),w.Vector3[2]),this.l2_2.addInPlace(w.Vector3[2]),n.scaleToRef(ua(5,e),w.Vector3[2]),this.l2_1.addInPlace(w.Vector3[2]),n.scaleToRef(ua(6,e),w.Vector3[2]),this.l20.addInPlace(w.Vector3[2]),n.scaleToRef(ua(7,e),w.Vector3[2]),this.l21.addInPlace(w.Vector3[2]),n.scaleToRef(ua(8,e),w.Vector3[2]),this.l22.addInPlace(w.Vector3[2])}scaleInPlace(e){this.l00.scaleInPlace(e),this.l1_1.scaleInPlace(e),this.l10.scaleInPlace(e),this.l11.scaleInPlace(e),this.l2_2.scaleInPlace(e),this.l2_1.scaleInPlace(e),this.l20.scaleInPlace(e),this.l21.scaleInPlace(e),this.l22.scaleInPlace(e)}convertIncidentRadianceToIrradiance(){this.l00.scaleInPlace(da[0]),this.l1_1.scaleInPlace(da[1]),this.l10.scaleInPlace(da[2]),this.l11.scaleInPlace(da[3]),this.l2_2.scaleInPlace(da[4]),this.l2_1.scaleInPlace(da[5]),this.l20.scaleInPlace(da[6]),this.l21.scaleInPlace(da[7]),this.l22.scaleInPlace(da[8])}convertIrradianceToLambertianRadiance(){this.scaleInPlace(1/Math.PI)}preScaleForRendering(){this.preScaled=!0,this.l00.scaleInPlace(Rn[0]),this.l1_1.scaleInPlace(Rn[1]),this.l10.scaleInPlace(Rn[2]),this.l11.scaleInPlace(Rn[3]),this.l2_2.scaleInPlace(Rn[4]),this.l2_1.scaleInPlace(Rn[5]),this.l20.scaleInPlace(Rn[6]),this.l21.scaleInPlace(Rn[7]),this.l22.scaleInPlace(Rn[8])}updateFromArray(e){return E.FromArrayToRef(e[0],0,this.l00),E.FromArrayToRef(e[1],0,this.l1_1),E.FromArrayToRef(e[2],0,this.l10),E.FromArrayToRef(e[3],0,this.l11),E.FromArrayToRef(e[4],0,this.l2_2),E.FromArrayToRef(e[5],0,this.l2_1),E.FromArrayToRef(e[6],0,this.l20),E.FromArrayToRef(e[7],0,this.l21),E.FromArrayToRef(e[8],0,this.l22),this}updateFromFloatsArray(e){return E.FromFloatsToRef(e[0],e[1],e[2],this.l00),E.FromFloatsToRef(e[3],e[4],e[5],this.l1_1),E.FromFloatsToRef(e[6],e[7],e[8],this.l10),E.FromFloatsToRef(e[9],e[10],e[11],this.l11),E.FromFloatsToRef(e[12],e[13],e[14],this.l2_2),E.FromFloatsToRef(e[15],e[16],e[17],this.l2_1),E.FromFloatsToRef(e[18],e[19],e[20],this.l20),E.FromFloatsToRef(e[21],e[22],e[23],this.l21),E.FromFloatsToRef(e[24],e[25],e[26],this.l22),this}static FromArray(e){return new s().updateFromArray(e)}static FromPolynomial(e){let t=new s;return t.l00=e.xx.scale(.376127).add(e.yy.scale(.376127)).add(e.zz.scale(.376126)),t.l1_1=e.y.scale(.977204),t.l10=e.z.scale(.977204),t.l11=e.x.scale(.977204),t.l2_2=e.xy.scale(1.16538),t.l2_1=e.yz.scale(1.16538),t.l20=e.zz.scale(1.34567).subtract(e.xx.scale(.672834)).subtract(e.yy.scale(.672834)),t.l21=e.zx.scale(1.16538),t.l22=e.xx.scale(1.16538).subtract(e.yy.scale(1.16538)),t.l1_1.scaleInPlace(-1),t.l11.scaleInPlace(-1),t.l2_1.scaleInPlace(-1),t.l21.scaleInPlace(-1),t.scaleInPlace(Math.PI),t}},Ur=class s{constructor(){this.x=E.Zero(),this.y=E.Zero(),this.z=E.Zero(),this.xx=E.Zero(),this.yy=E.Zero(),this.zz=E.Zero(),this.xy=E.Zero(),this.yz=E.Zero(),this.zx=E.Zero()}get preScaledHarmonics(){return this._harmonics||(this._harmonics=_l.FromPolynomial(this)),this._harmonics.preScaled||this._harmonics.preScaleForRendering(),this._harmonics}addAmbient(e){w.Vector3[0].copyFromFloats(e.r,e.g,e.b);let t=w.Vector3[0];this.xx.addInPlace(t),this.yy.addInPlace(t),this.zz.addInPlace(t)}scaleInPlace(e){this.x.scaleInPlace(e),this.y.scaleInPlace(e),this.z.scaleInPlace(e),this.xx.scaleInPlace(e),this.yy.scaleInPlace(e),this.zz.scaleInPlace(e),this.yz.scaleInPlace(e),this.zx.scaleInPlace(e),this.xy.scaleInPlace(e)}updateFromHarmonics(e){return this._harmonics=e,this.x.copyFrom(e.l11),this.x.scaleInPlace(1.02333).scaleInPlace(-1),this.y.copyFrom(e.l1_1),this.y.scaleInPlace(1.02333).scaleInPlace(-1),this.z.copyFrom(e.l10),this.z.scaleInPlace(1.02333),this.xx.copyFrom(e.l00),w.Vector3[0].copyFrom(e.l20).scaleInPlace(.247708),w.Vector3[1].copyFrom(e.l22).scaleInPlace(.429043),this.xx.scaleInPlace(.886277).subtractInPlace(w.Vector3[0]).addInPlace(w.Vector3[1]),this.yy.copyFrom(e.l00),this.yy.scaleInPlace(.886277).subtractInPlace(w.Vector3[0]).subtractInPlace(w.Vector3[1]),this.zz.copyFrom(e.l00),w.Vector3[0].copyFrom(e.l20).scaleInPlace(.495417),this.zz.scaleInPlace(.886277).addInPlace(w.Vector3[0]),this.yz.copyFrom(e.l2_1),this.yz.scaleInPlace(.858086).scaleInPlace(-1),this.zx.copyFrom(e.l21),this.zx.scaleInPlace(.858086).scaleInPlace(-1),this.xy.copyFrom(e.l2_2),this.xy.scaleInPlace(.858086),this.scaleInPlace(1/Math.PI),this}static FromHarmonics(e){return new s().updateFromHarmonics(e)}static FromArray(e){let t=new s;return E.FromArrayToRef(e[0],0,t.x),E.FromArrayToRef(e[1],0,t.y),E.FromArrayToRef(e[2],0,t.z),E.FromArrayToRef(e[3],0,t.xx),E.FromArrayToRef(e[4],0,t.yy),E.FromArrayToRef(e[5],0,t.zz),E.FromArrayToRef(e[6],0,t.yz),E.FromArrayToRef(e[7],0,t.zx),E.FromArrayToRef(e[8],0,t.xy),t}}});var Eo,qs,Gp=S(()=>{ie();di();gl();xr();it();Eo=class{constructor(e,t,i,r){this.name=e,this.worldAxisForNormal=t,this.worldAxisForFileX=i,this.worldAxisForFileY=r}},qs=class{static ConvertCubeMapTextureToSphericalPolynomial(e){if(!e.isCube)return null;e.getScene()?.getEngine().flushFramebuffer();let t=e.getSize().width,i=e.readPixels(0,void 0,void 0,!1),r=e.readPixels(1,void 0,void 0,!1),n,a;e.isRenderTarget?(n=e.readPixels(3,void 0,void 0,!1),a=e.readPixels(2,void 0,void 0,!1)):(n=e.readPixels(2,void 0,void 0,!1),a=e.readPixels(3,void 0,void 0,!1));let o=e.readPixels(4,void 0,void 0,!1),l=e.readPixels(5,void 0,void 0,!1),c=e.gammaSpace,f=5,h=0;return(e.textureType==1||e.textureType==2)&&(h=1),new Promise(u=>{Promise.all([r,i,n,a,o,l]).then(([d,p,m,_,v,T])=>{let C={size:t,right:p,left:d,up:m,down:_,front:v,back:T,format:f,type:h,gammaSpace:c};u(this.ConvertCubeMapToSphericalPolynomial(C))})})}static _AreaElement(e,t){return Math.atan2(e*t,Math.sqrt(e*e+t*t+1))}static ConvertCubeMapToSphericalPolynomial(e){let t=new _l,i=0,r=2/e.size,n=r,a=.5*r,o=a-1;for(let u=0;u<6;u++){let d=this._FileFaces[u],p=e[d.name],m=o,_=e.format===5?4:3;for(let v=0;v<e.size;v++){let T=o;for(let C=0;C<e.size;C++){let I=d.worldAxisForFileX.scale(T).add(d.worldAxisForFileY.scale(m)).add(d.worldAxisForNormal);I.normalize();let R=this._AreaElement(T-a,m-a)-this._AreaElement(T-a,m+a)-this._AreaElement(T+a,m-a)+this._AreaElement(T+a,m+a),b=p[v*e.size*_+C*_+0],M=p[v*e.size*_+C*_+1],F=p[v*e.size*_+C*_+2];isNaN(b)&&(b=0),isNaN(M)&&(M=0),isNaN(F)&&(F=0),e.type===0&&(b/=255,M/=255,F/=255),e.gammaSpace&&(b=Math.pow(Fe(b),Ec),M=Math.pow(Fe(M),Ec),F=Math.pow(Fe(F),Ec));let U=this.MAX_HDRI_VALUE;if(this.PRESERVE_CLAMPED_COLORS){let $=Math.max(b,M,F);if($>U){let oe=U/$;b*=oe,M*=oe,F*=oe}}else b=Fe(b,0,U),M=Fe(M,0,U),F=Fe(F,0,U);let D=new j(b,M,F);t.addLight(I,D,R),i+=R,T+=r}m+=n}}let h=4*Math.PI*6/6/i;return t.scaleInPlace(h),t.convertIncidentRadianceToIrradiance(),t.convertIrradianceToLambertianRadiance(),Ur.FromHarmonics(t)}};qs._FileFaces=[new Eo("right",new E(1,0,0),new E(0,0,-1),new E(0,-1,0)),new Eo("left",new E(-1,0,0),new E(0,0,1),new E(0,-1,0)),new Eo("up",new E(0,1,0),new E(1,0,0),new E(0,0,1)),new Eo("down",new E(0,-1,0),new E(1,0,0),new E(0,0,-1)),new Eo("front",new E(0,0,1),new E(1,0,0),new E(0,-1,0)),new Eo("back",new E(0,0,-1),new E(-1,0,0),new E(0,-1,0))];qs.MAX_HDRI_VALUE=4096;qs.PRESERVE_CLAMPED_COLORS=!1});function Vi(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{let e=Math.random()*16|0;return(s==="x"?e:e&3|8).toString(16)})}var pa=S(()=>{});var Vp,_O=S(()=>{Up();Vp=class s{get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e}get coordinatesMode(){return 0}get isCube(){return this._texture?this._texture.isCube:!1}set isCube(e){this._texture&&(this._texture.isCube=e)}get is3D(){return this._texture?this._texture.is3D:!1}set is3D(e){this._texture&&(this._texture.is3D=e)}get is2DArray(){return this._texture?this._texture.is2DArray:!1}set is2DArray(e){this._texture&&(this._texture.is2DArray=e)}getClassName(){return"ThinTexture"}static _IsRenderTargetWrapper(e){return e?.shareDepth!==void 0}constructor(e){this._wrapU=1,this._wrapV=1,this.wrapR=1,this.anisotropicFilteringLevel=4,this.delayLoadState=0,this._texture=null,this._engine=null,this._cachedSize=ha.Zero(),this._cachedBaseSize=ha.Zero(),this._initialSamplingMode=2,this._texture=s._IsRenderTargetWrapper(e)?e.texture:e,this._texture&&(this._engine=this._texture.getEngine(),this.wrapU=this._texture._cachedWrapU??this.wrapU,this.wrapV=this._texture._cachedWrapV??this.wrapV,this.wrapR=this._texture._cachedWrapR??this.wrapR)}isReady(){return this.delayLoadState===4?(this.delayLoad(),!1):this._texture?this._texture.isReady:!1}delayLoad(){}getInternalTexture(){return this._texture}getSize(){if(this._texture){if(this._texture.width)return this._cachedSize.width=this._texture.width,this._cachedSize.height=this._texture.height,this._cachedSize;if(this._texture._size)return this._cachedSize.width=this._texture._size,this._cachedSize.height=this._texture._size,this._cachedSize}return this._cachedSize}getBaseSize(){return!this.isReady()||!this._texture?(this._cachedBaseSize.width=0,this._cachedBaseSize.height=0,this._cachedBaseSize):this._texture._size?(this._cachedBaseSize.width=this._texture._size,this._cachedBaseSize.height=this._texture._size,this._cachedBaseSize):(this._cachedBaseSize.width=this._texture.baseWidth,this._cachedBaseSize.height=this._texture.baseHeight,this._cachedBaseSize)}get samplingMode(){return this._texture?this._texture.samplingMode:this._initialSamplingMode}updateSamplingMode(e,t=!1){this._texture&&this._engine&&this._engine.updateTextureSamplingMode(e,this._texture,this._texture.generateMipMaps&&t)}releaseInternalTexture(){this._texture&&(this._texture.dispose(),this._texture=null)}dispose(){this._texture&&(this.releaseInternalTexture(),this._engine=null)}}});var nt,ma=S(()=>{Ye();je();we();ie();gt();pa();To();_O();ei();nt=class s extends Vp{set hasAlpha(e){this._hasAlpha!==e&&(this._hasAlpha=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get hasAlpha(){return this._hasAlpha}set getAlphaFromRGB(e){this._getAlphaFromRGB!==e&&(this._getAlphaFromRGB=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get getAlphaFromRGB(){return this._getAlphaFromRGB}set coordinatesIndex(e){this._coordinatesIndex!==e&&(this._coordinatesIndex=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get coordinatesIndex(){return this._coordinatesIndex}set coordinatesMode(e){this._coordinatesMode!==e&&(this._coordinatesMode=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get coordinatesMode(){return this._coordinatesMode}get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e}get isCube(){return this._texture?this._texture.isCube:this._isCube}set isCube(e){this._texture?this._texture.isCube=e:this._isCube=e}get is3D(){return this._texture?this._texture.is3D:!1}set is3D(e){this._texture&&(this._texture.is3D=e)}get is2DArray(){return this._texture?this._texture.is2DArray:!1}set is2DArray(e){this._texture&&(this._texture.is2DArray=e)}get gammaSpace(){if(this._texture)this._texture._gammaSpace===null&&(this._texture._gammaSpace=this._gammaSpace);else return this._gammaSpace;return this._texture._gammaSpace&&!this._texture._useSRGBBuffer}set gammaSpace(e){if(this._texture){if(this._texture._gammaSpace===e)return;this._texture._gammaSpace=e}else{if(this._gammaSpace===e)return;this._gammaSpace=e}this.getScene()?.markAllMaterialsAsDirty(1,t=>t.hasTexture(this))}get isRGBD(){return this._texture!=null&&this._texture._isRGBD}set isRGBD(e){e!==this.isRGBD&&(this._texture&&(this._texture._isRGBD=e),this.getScene()?.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get noMipmap(){return!1}get lodGenerationOffset(){return this._texture?this._texture._lodGenerationOffset:0}set lodGenerationOffset(e){this._texture&&(this._texture._lodGenerationOffset=e)}get lodGenerationScale(){return this._texture?this._texture._lodGenerationScale:0}set lodGenerationScale(e){this._texture&&(this._texture._lodGenerationScale=e)}get linearSpecularLOD(){return this._texture?this._texture._linearSpecularLOD:!1}set linearSpecularLOD(e){this._texture&&(this._texture._linearSpecularLOD=e)}get irradianceTexture(){return this._texture?this._texture._irradianceTexture:null}set irradianceTexture(e){this._texture&&(this._texture._irradianceTexture=e)}get uid(){return this._uid||(this._uid=Vi()),this._uid}toString(){return this.name}getClassName(){return"BaseTexture"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get isBlocking(){return!0}get loadingError(){return this._loadingError}get errorObject(){return this._errorObject}constructor(e,t=null){super(null),this.metadata=null,this.reservedDataStore=null,this._hasAlpha=!1,this._getAlphaFromRGB=!1,this.level=1,this._coordinatesIndex=0,this.optimizeUVAllocation=!0,this._coordinatesMode=0,this.wrapR=1,this.anisotropicFilteringLevel=s.DEFAULT_ANISOTROPIC_FILTERING_LEVEL,this._isCube=!1,this._gammaSpace=!0,this.invertZ=!1,this.lodLevelInAlpha=!1,this._dominantDirection=null,this.isRenderTarget=!1,this._prefiltered=!1,this._forceSerialize=!1,this.animations=[],this.onDisposeObservable=new N,this._onDisposeObserver=null,this._scene=null,this._uid=null,this._parentContainer=null,this._loadingError=!1,e?s._IsScene(e)?this._scene=e:this._engine=e:this._scene=Z.LastCreatedScene,this._scene&&(this.uniqueId=this._scene.getUniqueId(),this._scene.addTexture(this),this._engine=this._scene.getEngine()),this._texture=t,this._uid=null}getScene(){return this._scene}_getEngine(){return this._engine}getTextureMatrix(){return B.IdentityReadOnly}getReflectionTextureMatrix(){return B.IdentityReadOnly}getRefractionTextureMatrix(){return this.getReflectionTextureMatrix()}isReadyOrNotBlocking(){return!this.isBlocking||this.isReady()||this.loadingError}scale(e){}get canRescale(){return!1}_getFromCache(e,t,i,r,n,a){let o=this._getEngine();if(!o)return null;let l=o._getUseSRGBBuffer(!!n,t),c=o.getLoadedTexturesCache();for(let f=0;f<c.length;f++){let h=c[f];if((n===void 0||l===h._useSRGBBuffer)&&(r===void 0||r===h.invertY)&&h.url===e&&h.generateMipMaps===!t&&(!i||i===h.samplingMode)&&(a===void 0||a===h.isCube))return h.incrementReferences(),h}return null}_rebuild(e=!1){}clone(){return null}get textureType(){return this._texture&&this._texture.type!==void 0?this._texture.type:0}get textureFormat(){return this._texture&&this._texture.format!==void 0?this._texture.format:5}_markAllSubMeshesAsTexturesDirty(){let e=this.getScene();e&&e.markAllMaterialsAsDirty(1)}readPixels(e=0,t=0,i=null,r=!0,n=!1,a=0,o=0,l=Number.MAX_VALUE,c=Number.MAX_VALUE){if(!this._texture)return null;let f=this._getEngine();if(!f)return null;let h=this.getSize(),u=h.width,d=h.height;t!==0&&(u=u/Math.pow(2,t),d=d/Math.pow(2,t),u=Math.round(u),d=Math.round(d)),l=Math.min(u,l),c=Math.min(d,c);try{return this._texture.isCube?f._readTexturePixels(this._texture,l,c,e,t,i,r,n,a,o):f._readTexturePixels(this._texture,l,c,-1,t,i,r,n,a,o)}catch{return null}}_readPixelsSync(e=0,t=0,i=null,r=!0,n=!1){if(!this._texture)return null;let a=this.getSize(),o=a.width,l=a.height,c=this._getEngine();if(!c)return null;t!=0&&(o=o/Math.pow(2,t),l=l/Math.pow(2,t),o=Math.round(o),l=Math.round(l));try{return this._texture.isCube?c._readTexturePixelsSync(this._texture,o,l,e,t,i,r,n):c._readTexturePixelsSync(this._texture,o,l,-1,t,i,r,n)}catch{return null}}get _lodTextureHigh(){return this._texture?this._texture._lodTextureHigh:null}get _lodTextureMid(){return this._texture?this._texture._lodTextureMid:null}get _lodTextureLow(){return this._texture?this._texture._lodTextureLow:null}dispose(){if(this._scene){this._scene.stopAnimation&&this._scene.stopAnimation(this),this._scene.removePendingData(this);let e=this._scene.textures.indexOf(this);if(e>=0&&this._scene.textures.splice(e,1),this._scene.onTextureRemovedObservable.notifyObservers(this),this._scene=null,this._parentContainer){let t=this._parentContainer.textures.indexOf(this);t>-1&&this._parentContainer.textures.splice(t,1),this._parentContainer=null}}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.metadata=null,super.dispose()}serialize(e=!1){if(!this.name&&!e)return null;let t=_e.Serialize(this);return _e.AppendSerializedAnimations(this,t),t}static WhenAllReady(e,t){let i=e.length;if(i===0){t();return}for(let r=0;r<e.length;r++){let n=e[r];if(n.isReady())--i===0&&t();else{let a=n.onLoadObservable;a?a.addOnce(()=>{--i===0&&t()}):--i===0&&t()}}}static _IsScene(e){return e.getClassName()==="Scene"}};nt.DEFAULT_ANISOTROPIC_FILTERING_LEVEL=4;x([y()],nt.prototype,"uniqueId",void 0);x([y()],nt.prototype,"name",void 0);x([y()],nt.prototype,"displayName",void 0);x([y()],nt.prototype,"metadata",void 0);x([y("hasAlpha")],nt.prototype,"_hasAlpha",void 0);x([y("getAlphaFromRGB")],nt.prototype,"_getAlphaFromRGB",void 0);x([y()],nt.prototype,"level",void 0);x([y("coordinatesIndex")],nt.prototype,"_coordinatesIndex",void 0);x([y()],nt.prototype,"optimizeUVAllocation",void 0);x([y("coordinatesMode")],nt.prototype,"_coordinatesMode",void 0);x([y()],nt.prototype,"wrapU",null);x([y()],nt.prototype,"wrapV",null);x([y()],nt.prototype,"wrapR",void 0);x([y()],nt.prototype,"anisotropicFilteringLevel",void 0);x([y()],nt.prototype,"isCube",null);x([y()],nt.prototype,"is3D",null);x([y()],nt.prototype,"is2DArray",null);x([y()],nt.prototype,"gammaSpace",null);x([y()],nt.prototype,"invertZ",void 0);x([y()],nt.prototype,"lodLevelInAlpha",void 0);x([y()],nt.prototype,"lodGenerationOffset",null);x([y()],nt.prototype,"lodGenerationScale",null);x([y()],nt.prototype,"linearSpecularLOD",null);x([He()],nt.prototype,"irradianceTexture",null);x([y()],nt.prototype,"isRenderTarget",void 0)});var _a,QA=S(()=>{Ee();Te();_a=class{static Instantiate(e){if(this.RegisteredExternalClasses&&this.RegisteredExternalClasses[e])return this.RegisteredExternalClasses[e];let t=Ci(e);if(t)return t;P.Warn(e+" not found, you may have missed an import.");let i=e.split("."),r=window||this;for(let n=0,a=i.length;n<a;n++)r=r[i[n]];return typeof r!="function"?null:r}};_a.RegisteredExternalClasses={}});function gO(s,e,t=!1){let i=e.width,r=e.height;if(s instanceof Float32Array){let c=s.byteLength/s.BYTES_PER_ELEMENT,f=new Uint8Array(c);for(;--c>=0;){let h=s[c];h<0?h=0:h>1&&(h=1),f[c]=h*255}s=f}let n=document.createElement("canvas");n.width=i,n.height=r;let a=n.getContext("2d");if(!a)return null;let o=a.createImageData(i,r);if(o.data.set(s),a.putImageData(o,0,0),t){let c=document.createElement("canvas");c.width=i,c.height=r;let f=c.getContext("2d");return f?(f.translate(0,r),f.scale(1,-1),f.drawImage(n,0,0),c.toDataURL("image/png")):null}return n.toDataURL("image/png")}function vO(s,e=0,t=0){let i=s.getInternalTexture();if(!i)return null;let r=s._readPixelsSync(e,t);return r?gO(r,s.getSize(),i.invertY):null}async function SO(s,e=0,t=0){let i=s.getInternalTexture();if(!i)return null;let r=await s.readPixels(e,t);return r?gO(r,s.getSize(),i.invertY):null}var EO=S(()=>{});var Si,Fc=S(()=>{Si=!1});var H,Ut=S(()=>{Ye();je();we();ie();ma();Te();Ii();ys();QA();wc();pp();EO();Fc();ei();H=class s extends nt{static _CreateVideoTexture(e,t,i,r=!1,n=!1,a=s.TRILINEAR_SAMPLINGMODE,o={},l,c=5){throw pe("VideoTexture")}get noMipmap(){return this._noMipmap}get mimeType(){return this._mimeType}set isBlocking(e){this._isBlocking=e}get isBlocking(){return this._isBlocking}get invertY(){return this._invertY}constructor(e,t,i,r,n=s.TRILINEAR_SAMPLINGMODE,a=null,o=null,l=null,c=!1,f,h,u,d,p){super(t),this.url=null,this.uOffset=0,this.vOffset=0,this.uScale=1,this.vScale=1,this.uAng=0,this.vAng=0,this.wAng=0,this.uRotationCenter=.5,this.vRotationCenter=.5,this.wRotationCenter=.5,this.homogeneousRotationInUVTransform=!1,this.inspectableCustomProperties=null,this._noMipmap=!1,this._invertY=!1,this._rowGenerationMatrix=null,this._cachedTextureMatrix=null,this._projectionModeMatrix=null,this._t0=null,this._t1=null,this._t2=null,this._cachedUOffset=-1,this._cachedVOffset=-1,this._cachedUScale=0,this._cachedVScale=0,this._cachedUAng=-1,this._cachedVAng=-1,this._cachedWAng=-1,this._cachedReflectionProjectionMatrixId=-1,this._cachedURotationCenter=-1,this._cachedVRotationCenter=-1,this._cachedWRotationCenter=-1,this._cachedHomogeneousRotationInUVTransform=!1,this._cachedIdentity3x2=!0,this._cachedReflectionTextureMatrix=null,this._cachedReflectionUOffset=-1,this._cachedReflectionVOffset=-1,this._cachedReflectionUScale=0,this._cachedReflectionVScale=0,this._cachedReflectionCoordinatesMode=-1,this._buffer=null,this._deleteBuffer=!1,this._format=null,this._delayedOnLoad=null,this._delayedOnError=null,this.onLoadObservable=new N,this._isBlocking=!0,this.name=e||"",this.url=e;let m,_=!1,v=null,T=!0;typeof i=="object"&&i!==null?(m=i.noMipmap??!1,r=i.invertY??!Si,n=i.samplingMode??s.TRILINEAR_SAMPLINGMODE,a=i.onLoad??null,o=i.onError??null,l=i.buffer??null,c=i.deleteBuffer??!1,f=i.format,h=i.mimeType,u=i.loaderOptions,d=i.creationFlags,_=i.useSRGBBuffer??!1,v=i.internalTexture??null,T=i.gammaSpace??T,p=i.forcedExtension??p):m=!!i,this._gammaSpace=T,this._noMipmap=m,this._invertY=r===void 0?!Si:r,this._initialSamplingMode=n,this._buffer=l,this._deleteBuffer=c,this._mimeType=h,this._loaderOptions=u,this._creationFlags=d,this._useSRGBBuffer=_,this._forcedExtension=p,f!==void 0&&(this._format=f);let C=this.getScene(),I=this._getEngine();if(!I)return;I.onBeforeTextureInitObservable.notifyObservers(this);let R=()=>{this._texture&&(this._texture._invertVScale&&(this.vScale*=-1,this.vOffset+=1),this._texture._cachedWrapU!==null&&(this.wrapU=this._texture._cachedWrapU,this._texture._cachedWrapU=null),this._texture._cachedWrapV!==null&&(this.wrapV=this._texture._cachedWrapV,this._texture._cachedWrapV=null),this._texture._cachedWrapR!==null&&(this.wrapR=this._texture._cachedWrapR,this._texture._cachedWrapR=null)),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this),a&&a(),!this.isBlocking&&C&&C.resetCachedMaterial()},b=(M,F)=>{this._loadingError=!0,this._errorObject={message:M,exception:F},o&&o(M,F),s.OnTextureLoadErrorObservable.notifyObservers(this)};if(!this.url&&!v){this._delayedOnLoad=R,this._delayedOnError=b;return}if(this._texture=v??this._getFromCache(this.url,m,n,this._invertY,_,this.isCube),this._texture)if(this._texture.isReady)Ys.SetImmediate(()=>R());else{let M=this._texture.onLoadedObservable.add(R);this._texture.onErrorObservable.add(F=>{b(F.message,F.exception),this._texture?.onLoadedObservable.remove(M)})}else if(!C||!C.useDelayedTextureLoading){try{this._texture=I.createTexture(this.url,m,this._invertY,C,n,R,b,this._buffer,void 0,this._format,this._forcedExtension,h,u,d,_)}catch(M){throw b("error loading",M),M}c&&(this._buffer=null)}else this.delayLoadState=4,this._delayedOnLoad=R,this._delayedOnError=b}updateURL(e,t=null,i,r){this.url&&(this.releaseInternalTexture(),this.getScene().markAllMaterialsAsDirty(1,n=>n.hasTexture(this))),(!this.name||this.name.startsWith("data:"))&&(this.name=e),this.url=e,this._buffer=t,this._forcedExtension=r,this.delayLoadState=4,i&&(this._delayedOnLoad=i),this.delayLoad()}delayLoad(){if(this.delayLoadState!==4)return;let e=this.getScene();e&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap,this.samplingMode,this._invertY,this._useSRGBBuffer,this.isCube),this._texture?this._delayedOnLoad&&(this._texture.isReady?Ys.SetImmediate(this._delayedOnLoad):this._texture.onLoadedObservable.add(this._delayedOnLoad)):(this._texture=e.getEngine().createTexture(this.url,this._noMipmap,this._invertY,e,this.samplingMode,this._delayedOnLoad,this._delayedOnError,this._buffer,null,this._format,this._forcedExtension,this._mimeType,this._loaderOptions,this._creationFlags,this._useSRGBBuffer),this._deleteBuffer&&(this._buffer=null)),this._delayedOnLoad=null,this._delayedOnError=null)}_prepareRowForTextureGeneration(e,t,i,r){e*=this._cachedUScale,t*=this._cachedVScale,e-=this.uRotationCenter*this._cachedUScale,t-=this.vRotationCenter*this._cachedVScale,i-=this.wRotationCenter,E.TransformCoordinatesFromFloatsToRef(e,t,i,this._rowGenerationMatrix,r),r.x+=this.uRotationCenter*this._cachedUScale+this._cachedUOffset,r.y+=this.vRotationCenter*this._cachedVScale+this._cachedVOffset,r.z+=this.wRotationCenter}getTextureMatrix(e=1){if(this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale*e===this._cachedUScale&&this.vScale===this._cachedVScale&&this.uAng===this._cachedUAng&&this.vAng===this._cachedVAng&&this.wAng===this._cachedWAng&&this.uRotationCenter===this._cachedURotationCenter&&this.vRotationCenter===this._cachedVRotationCenter&&this.wRotationCenter===this._cachedWRotationCenter&&this.homogeneousRotationInUVTransform===this._cachedHomogeneousRotationInUVTransform)return this._cachedTextureMatrix;this._cachedUOffset=this.uOffset,this._cachedVOffset=this.vOffset,this._cachedUScale=this.uScale*e,this._cachedVScale=this.vScale,this._cachedUAng=this.uAng,this._cachedVAng=this.vAng,this._cachedWAng=this.wAng,this._cachedURotationCenter=this.uRotationCenter,this._cachedVRotationCenter=this.vRotationCenter,this._cachedWRotationCenter=this.wRotationCenter,this._cachedHomogeneousRotationInUVTransform=this.homogeneousRotationInUVTransform,(!this._cachedTextureMatrix||!this._rowGenerationMatrix)&&(this._cachedTextureMatrix=B.Zero(),this._rowGenerationMatrix=new B,this._t0=E.Zero(),this._t1=E.Zero(),this._t2=E.Zero()),B.RotationYawPitchRollToRef(this.vAng,this.uAng,this.wAng,this._rowGenerationMatrix),this.homogeneousRotationInUVTransform?(B.TranslationToRef(-this._cachedURotationCenter,-this._cachedVRotationCenter,-this._cachedWRotationCenter,w.Matrix[0]),B.TranslationToRef(this._cachedURotationCenter,this._cachedVRotationCenter,this._cachedWRotationCenter,w.Matrix[1]),B.ScalingToRef(this._cachedUScale,this._cachedVScale,0,w.Matrix[2]),B.TranslationToRef(this._cachedUOffset,this._cachedVOffset,0,w.Matrix[3]),w.Matrix[0].multiplyToRef(this._rowGenerationMatrix,this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(w.Matrix[1],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(w.Matrix[2],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(w.Matrix[3],this._cachedTextureMatrix),this._cachedTextureMatrix.setRowFromFloats(2,this._cachedTextureMatrix.m[12],this._cachedTextureMatrix.m[13],this._cachedTextureMatrix.m[14],1)):(this._prepareRowForTextureGeneration(0,0,0,this._t0),this._prepareRowForTextureGeneration(1,0,0,this._t1),this._prepareRowForTextureGeneration(0,1,0,this._t2),this._t1.subtractInPlace(this._t0),this._t2.subtractInPlace(this._t0),B.FromValuesToRef(this._t1.x,this._t1.y,this._t1.z,0,this._t2.x,this._t2.y,this._t2.z,0,this._t0.x,this._t0.y,this._t0.z,0,0,0,0,1,this._cachedTextureMatrix));let t=this.getScene();if(!t)return this._cachedTextureMatrix;let i=this._cachedIdentity3x2;return this._cachedIdentity3x2=this._cachedTextureMatrix.isIdentityAs3x2(),this.optimizeUVAllocation&&i!==this._cachedIdentity3x2&&t.markAllMaterialsAsDirty(1,r=>r.hasTexture(this)),this._cachedTextureMatrix}getReflectionTextureMatrix(){let e=this.getScene();if(!e)return this._cachedReflectionTextureMatrix;if(this.uOffset===this._cachedReflectionUOffset&&this.vOffset===this._cachedReflectionVOffset&&this.uScale===this._cachedReflectionUScale&&this.vScale===this._cachedReflectionVScale&&this.coordinatesMode===this._cachedReflectionCoordinatesMode)if(this.coordinatesMode===s.PROJECTION_MODE){if(this._cachedReflectionProjectionMatrixId===e.getProjectionMatrix().updateFlag)return this._cachedReflectionTextureMatrix}else return this._cachedReflectionTextureMatrix;this._cachedReflectionTextureMatrix||(this._cachedReflectionTextureMatrix=B.Zero()),this._projectionModeMatrix||(this._projectionModeMatrix=B.Zero());let t=this._cachedReflectionCoordinatesMode!==this.coordinatesMode;switch(this._cachedReflectionUOffset=this.uOffset,this._cachedReflectionVOffset=this.vOffset,this._cachedReflectionUScale=this.uScale,this._cachedReflectionVScale=this.vScale,this._cachedReflectionCoordinatesMode=this.coordinatesMode,this.coordinatesMode){case s.PLANAR_MODE:{B.IdentityToRef(this._cachedReflectionTextureMatrix),this._cachedReflectionTextureMatrix[0]=this.uScale,this._cachedReflectionTextureMatrix[5]=this.vScale,this._cachedReflectionTextureMatrix[12]=this.uOffset,this._cachedReflectionTextureMatrix[13]=this.vOffset;break}case s.PROJECTION_MODE:{B.FromValuesToRef(.5,0,0,0,0,-.5,0,0,0,0,0,0,.5,.5,1,1,this._projectionModeMatrix);let i=e.getProjectionMatrix();this._cachedReflectionProjectionMatrixId=i.updateFlag,i.multiplyToRef(this._projectionModeMatrix,this._cachedReflectionTextureMatrix);break}default:B.IdentityToRef(this._cachedReflectionTextureMatrix);break}return t&&e.markAllMaterialsAsDirty(1,i=>i.hasTexture(this)),this._cachedReflectionTextureMatrix}clone(){let e={noMipmap:this._noMipmap,invertY:this._invertY,samplingMode:this.samplingMode,onLoad:void 0,onError:void 0,buffer:this._texture?this._texture._buffer:void 0,deleteBuffer:this._deleteBuffer,format:this.textureFormat,mimeType:this.mimeType,loaderOptions:this._loaderOptions,creationFlags:this._creationFlags,useSRGBBuffer:this._useSRGBBuffer};return _e.Clone(()=>new s(this._texture?this._texture.url:null,this.getScene(),e),this)}serialize(){let e=this.name;s.SerializeBuffers||this.name.startsWith("data:")&&(this.name=""),this.name.startsWith("data:")&&this.url===this.name&&(this.url="");let t=super.serialize(s._SerializeInternalTextureUniqueId);if(!t)return null;if(s.SerializeBuffers||s.ForceSerializeBuffers)if(typeof this._buffer=="string"&&this._buffer.startsWith("data:"))t.base64String=this._buffer,t.name=t.name.replace("data:","");else if(this.url&&this.url.startsWith("data:")&&this._buffer instanceof Uint8Array){let i=this.mimeType||"image/png";t.base64String=`data:${i};base64,${dp(this._buffer)}`}else(s.ForceSerializeBuffers||this.url&&this.url.startsWith("blob:")||this._forceSerialize)&&(t.base64String=!this._engine||this._engine._features.supportSyncTextureRead?vO(this):SO(this));return t.invertY=this._invertY,t.samplingMode=this.samplingMode,t._creationFlags=this._creationFlags,t._useSRGBBuffer=this._useSRGBBuffer,s._SerializeInternalTextureUniqueId&&(t.internalTextureUniqueId=this._texture?.uniqueId),t.internalTextureLabel=this._texture?.label,t.noMipmap=this._noMipmap,this.name=e,t}getClassName(){return"Texture"}dispose(){super.dispose(),this.onLoadObservable.clear(),this._delayedOnLoad=null,this._delayedOnError=null,this._buffer=null}static Parse(e,t,i){if(e.customType){let c=_a.Instantiate(e.customType).Parse(e,t,i);return e.samplingMode&&c.updateSamplingMode&&c._samplingMode&&c._samplingMode!==e.samplingMode&&c.updateSamplingMode(e.samplingMode),c}if(e.isCube&&!e.isRenderTarget)return s._CubeTextureParser(e,t,i);let r=e.internalTextureUniqueId!==void 0;if(!e.name&&!e.isRenderTarget&&!r)return null;let n;if(r){let l=t.getEngine().getLoadedTexturesCache();for(let c of l)if(c.uniqueId===e.internalTextureUniqueId){n=c;break}}let a=l=>{if(l&&l._texture&&(l._texture._cachedWrapU=null,l._texture._cachedWrapV=null,l._texture._cachedWrapR=null),e.samplingMode){let c=e.samplingMode;l&&l.samplingMode!==c&&l.updateSamplingMode(c)}if(l&&e.animations)for(let c=0;c<e.animations.length;c++){let f=e.animations[c],h=Ci("BABYLON.Animation");h&&l.animations.push(h.Parse(f))}l&&l._texture&&(r&&!n&&l._texture._setUniqueId(e.internalTextureUniqueId),l._texture.label=e.internalTextureLabel)};return _e.Parse(()=>{let l=!0;if(e.noMipmap&&(l=!1),e.mirrorPlane){let c=s._CreateMirror(e.name,e.renderTargetSize,t,l);return c._waitingRenderList=e.renderList,c.mirrorPlane=Ks.FromArray(e.mirrorPlane),a(c),c}else if(e.isRenderTarget&&!e.base64String){let c=null;if(e.isCube){if(t.reflectionProbes)for(let f=0;f<t.reflectionProbes.length;f++){let h=t.reflectionProbes[f];if(h.name===e.name)return h.cubeTexture}}else c=s._CreateRenderTargetTexture(e.name,e.renderTargetSize,t,l,e._creationFlags??0),c._waitingRenderList=e.renderList;return a(c),c}else if(e.isVideo){let c=s._CreateVideoTexture(i+(e.url||e.name),i+(e.src||e.url),t,l,e.invertY,e.samplingMode,e.settings||{});return a(c),c}else{let c;if(e.base64String&&!n)c=s.CreateFromBase64String(e.base64String,e.base64String,t,!l,e.invertY,e.samplingMode,()=>{a(c)},e._creationFlags??0,e._useSRGBBuffer??!1),c.name=e.name;else{let f;e.name&&(e.name.indexOf("://")>0||e.name.startsWith("data:"))?f=e.name:f=i+e.name,e.url&&(e.url.startsWith("data:")||s.UseSerializedUrlIfAny)&&(f=e.url);let h={noMipmap:!l,invertY:e.invertY,samplingMode:e.samplingMode,onLoad:()=>{a(c)},internalTexture:n};c=new s(f,t,h)}return c}},e,t)}static CreateFromBase64String(e,t,i,r,n,a=s.TRILINEAR_SAMPLINGMODE,o=null,l=null,c=5,f,h){return new s("data:"+t,i,r,n,a,o,l,e,!1,c,void 0,void 0,f,h)}static LoadFromDataString(e,t,i,r=!1,n,a=!0,o=s.TRILINEAR_SAMPLINGMODE,l=null,c=null,f=5,h,u){return e.substring(0,5)!=="data:"&&(e="data:"+e),new s(e,i,n,a,o,l,c,t,r,f,void 0,void 0,h,u)}};H.SerializeBuffers=!0;H.ForceSerializeBuffers=!1;H.OnTextureLoadErrorObservable=new N;H._SerializeInternalTextureUniqueId=!1;H._CubeTextureParser=(s,e,t)=>{throw pe("CubeTexture")};H._CreateMirror=(s,e,t,i)=>{throw pe("MirrorTexture")};H._CreateRenderTargetTexture=(s,e,t,i,r)=>{throw pe("RenderTargetTexture")};H.NEAREST_SAMPLINGMODE=1;H.NEAREST_NEAREST_MIPLINEAR=8;H.BILINEAR_SAMPLINGMODE=2;H.LINEAR_LINEAR_MIPNEAREST=11;H.TRILINEAR_SAMPLINGMODE=3;H.LINEAR_LINEAR_MIPLINEAR=3;H.NEAREST_NEAREST_MIPNEAREST=4;H.NEAREST_LINEAR_MIPNEAREST=5;H.NEAREST_LINEAR_MIPLINEAR=6;H.NEAREST_LINEAR=7;H.NEAREST_NEAREST=1;H.LINEAR_NEAREST_MIPNEAREST=9;H.LINEAR_NEAREST_MIPLINEAR=10;H.LINEAR_LINEAR=2;H.LINEAR_NEAREST=12;H.EXPLICIT_MODE=0;H.SPHERICAL_MODE=1;H.PLANAR_MODE=2;H.CUBIC_MODE=3;H.PROJECTION_MODE=4;H.SKYBOX_MODE=5;H.INVCUBIC_MODE=6;H.EQUIRECTANGULAR_MODE=7;H.FIXED_EQUIRECTANGULAR_MODE=8;H.FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9;H.CLAMP_ADDRESSMODE=0;H.WRAP_ADDRESSMODE=1;H.MIRROR_ADDRESSMODE=2;H.UseSerializedUrlIfAny=!1;x([y()],H.prototype,"url",void 0);x([y()],H.prototype,"uOffset",void 0);x([y()],H.prototype,"vOffset",void 0);x([y()],H.prototype,"uScale",void 0);x([y()],H.prototype,"vScale",void 0);x([y()],H.prototype,"uAng",void 0);x([y()],H.prototype,"vAng",void 0);x([y()],H.prototype,"wAng",void 0);x([y()],H.prototype,"uRotationCenter",void 0);x([y()],H.prototype,"vRotationCenter",void 0);x([y()],H.prototype,"wRotationCenter",void 0);x([y()],H.prototype,"homogeneousRotationInUVTransform",void 0);x([y()],H.prototype,"isBlocking",null);G("BABYLON.Texture",H);_e._TextureParser=H.Parse});var ga,kp=S(()=>{ga=class s{get underlyingResource(){return null}constructor(){this.references=0,this.capacity=0,this.is32Bits=!1,this.uniqueId=s._Counter++}};ga._Counter=0});function $9(s,e,t,i){switch(e){case 5120:{let r=s.getInt8(t);return i&&(r=Math.max(r/127,-1)),r}case 5121:{let r=s.getUint8(t);return i&&(r=r/255),r}case 5122:{let r=s.getInt16(t,!0);return i&&(r=Math.max(r/32767,-1)),r}case 5123:{let r=s.getUint16(t,!0);return i&&(r=r/65535),r}case 5124:return s.getInt32(t,!0);case 5125:return s.getUint32(t,!0);case 5126:return s.getFloat32(t,!0);default:throw new Error(`Invalid component type ${e}`)}}function eq(s,e,t,i,r){switch(e){case 5120:{i&&(r=Math.round(r*127)),s.setInt8(t,r);break}case 5121:{i&&(r=Math.round(r*255)),s.setUint8(t,r);break}case 5122:{i&&(r=Math.round(r*32767)),s.setInt16(t,r,!0);break}case 5123:{i&&(r=Math.round(r*65535)),s.setUint16(t,r,!0);break}case 5124:{s.setInt32(t,r,!0);break}case 5125:{s.setUint32(t,r,!0);break}case 5126:{s.setFloat32(t,r,!0);break}default:throw new Error(`Invalid component type ${e}`)}}function Qs(s){switch(s){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5124:case 5125:case 5126:return 4;default:throw new Error(`Invalid type '${s}'`)}}function TO(s){switch(s){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:throw new Error(`Invalid component type '${s}'`)}}function vl(s,e,t,i,r,n,a,o){let l=new Array(i),c=new Array(i);if(s instanceof Array){let f=e/4,h=t/4;for(let u=0;u<n;u+=i){for(let d=0;d<i;d++)l[d]=c[d]=s[f+d];o(c,u);for(let d=0;d<i;d++)l[d]!==c[d]&&(s[f+d]=c[d]);f+=h}}else{let f=ArrayBuffer.isView(s)?new DataView(s.buffer,s.byteOffset,s.byteLength):new DataView(s),h=Qs(r);for(let u=0;u<n;u+=i){for(let d=0,p=e;d<i;d++,p+=h)l[d]=c[d]=$9(f,r,p,a);o(c,u);for(let d=0,p=e;d<i;d++,p+=h)l[d]!==c[d]&&eq(f,r,p,a,c[d]);e+=t}}}function jA(s,e,t,i,r,n,a,o){let l=e*Qs(t),c=a*e;if(t!==5126||r!==l){let f=new Float32Array(c);return vl(s,i,r,e,t,c,n,(h,u)=>{for(let d=0;d<e;d++)f[u+d]=h[d]}),f}if(!(s instanceof Array||s instanceof Float32Array)||i!==0||s.length!==c)if(s instanceof Array){let f=i/4;return s.slice(f,f+c)}else{if(s instanceof ArrayBuffer)return new Float32Array(s,i,c);{let f=s.byteOffset+i;return(f&3)!==0&&(P.Warn("Float array must be aligned to 4-bytes border"),o=!0),o?new Float32Array(s.buffer.slice(f,f+c*Float32Array.BYTES_PER_ELEMENT)):new Float32Array(s.buffer,f,c)}}return o?s.slice():s}function xO(s,e,t,i,r,n,a,o){let l=e*Qs(t),c=a*e;if(o.length!==c)throw new Error("Output length is not valid");if(t!==5126||r!==l){vl(s,i,r,e,t,c,n,(f,h)=>{for(let u=0;u<e;u++)o[h+u]=f[u]});return}if(s instanceof Array){let f=i/4;o.set(s,f)}else if(s instanceof ArrayBuffer){let f=new Float32Array(s,i,c);o.set(f)}else{let f=s.byteOffset+i;if((f&3)!==0){P.Warn("Float array must be aligned to 4-bytes border"),o.set(new Float32Array(s.buffer.slice(f,f+c*Float32Array.BYTES_PER_ELEMENT)));return}let h=new Float32Array(s.buffer,f,c);o.set(h)}}var Nc=S(()=>{Ee()});var Gr,A,yt=S(()=>{kp();Ee();Nc();Gr=class{get isDisposed(){return this._isDisposed}constructor(e,t,i,r=0,n=!1,a=!1,o=!1,l,c){this._isAlreadyOwned=!1,this._isDisposed=!1,e&&e.getScene?this._engine=e.getScene().getEngine():this._engine=e,this._updatable=i,this._instanced=a,this._divisor=l||1,this._label=c,t instanceof ga?(this._data=null,this._buffer=t):(this._data=t,this._buffer=null),this.byteStride=o?r:r*Float32Array.BYTES_PER_ELEMENT,n||this.create()}createVertexBuffer(e,t,i,r,n,a=!1,o){let l=a?t:t*Float32Array.BYTES_PER_ELEMENT,c=r?a?r:r*Float32Array.BYTES_PER_ELEMENT:this.byteStride;return new A(this._engine,this,e,this._updatable,!0,c,n===void 0?this._instanced:n,l,i,void 0,void 0,!0,this._divisor||o)}isUpdatable(){return this._updatable}getData(){return this._data}getBuffer(){return this._buffer}getStrideSize(){return this.byteStride/Float32Array.BYTES_PER_ELEMENT}create(e=null){!e&&this._buffer||(e=e||this._data,e&&(this._buffer?this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e),this._data=e):this._updatable?(this._buffer=this._engine.createDynamicVertexBuffer(e,this._label),this._data=e):this._buffer=this._engine.createVertexBuffer(e,void 0,this._label)))}_rebuild(){if(this._data)this._buffer=null,this.create(this._data);else{if(!this._buffer)return;if(this._buffer.capacity>0){this._updatable?this._buffer=this._engine.createDynamicVertexBuffer(this._buffer.capacity,this._label):this._buffer=this._engine.createVertexBuffer(this._buffer.capacity,void 0,this._label);return}P.Warn(`Missing data for buffer "${this._label}" ${this._buffer?"(uniqueId: "+this._buffer.uniqueId+")":""}. Buffer reconstruction failed.`),this._buffer=null}}update(e){this.create(e)}updateDirectly(e,t,i,r=!1){this._buffer&&this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e,r?t:t*Float32Array.BYTES_PER_ELEMENT,i?i*this.byteStride:void 0),t===0&&i===void 0?this._data=e:this._data=null)}_increaseReferences(){if(this._buffer){if(!this._isAlreadyOwned){this._isAlreadyOwned=!0;return}this._buffer.references++}}dispose(){this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._isDisposed=!0,this._data=null,this._buffer=null)}},A=class s{get isDisposed(){return this._isDisposed}get instanceDivisor(){return this._instanceDivisor}set instanceDivisor(e){let t=e!=0;this._instanceDivisor=e,t!==this._instanced&&(this._instanced=t,this._computeHashCode())}get _maxVerticesCount(){let e=this.getData();return e?Array.isArray(e)?e.length/(this.byteStride/4)-this.byteOffset/4:(e.byteLength-this.byteOffset)/this.byteStride:0}constructor(e,t,i,r,n,a,o,l,c,f,h=!1,u=!1,d=1,p=!1){this._isDisposed=!1;let m=!1;if(this.engine=e,typeof r=="object"&&r!==null?(m=r.updatable??!1,n=r.postponeInternalCreation,a=r.stride,o=r.instanced,l=r.offset,c=r.size,f=r.type,h=r.normalized??!1,u=r.useBytes??!1,d=r.divisor??1,p=r.takeBufferOwnership??!1,this._label=r.label):m=!!r,t instanceof Gr?(this._buffer=t,this._ownsBuffer=p):(this._buffer=new Gr(e,t,m,a,n,o,u,d,this._label),this._ownsBuffer=!0),this.uniqueId=s._Counter++,this._kind=i,f===void 0){let v=this.getData();this.type=v?s.GetDataType(v):s.FLOAT}else this.type=f;let _=Qs(this.type);u?(this._size=c||(a?a/_:s.DeduceStride(i)),this.byteStride=a||this._buffer.byteStride||this._size*_,this.byteOffset=l||0):(this._size=c||a||s.DeduceStride(i),this.byteStride=a?a*_:this._buffer.byteStride||this._size*_,this.byteOffset=(l||0)*_),this.normalized=h,this._instanced=o!==void 0?o:!1,this._instanceDivisor=o?d:0,this._alignBuffer(),this._computeHashCode()}_computeHashCode(){this.hashCode=(this.type-5120<<0)+((this.normalized?1:0)<<3)+(this._size<<4)+((this._instanced?1:0)<<6)+(this.byteStride<<12)}_rebuild(){this._buffer?._rebuild()}getKind(){return this._kind}isUpdatable(){return this._buffer.isUpdatable()}getData(){return this._buffer.getData()}getFloatData(e,t){let i=this.getData();return i?jA(i,this._size,this.type,this.byteOffset,this.byteStride,this.normalized,e,t):null}getBuffer(){return this._buffer.getBuffer()}getWrapperBuffer(){return this._buffer}getStrideSize(){return this.byteStride/Qs(this.type)}getOffset(){return this.byteOffset/Qs(this.type)}getSize(e=!1){return e?this._size*Qs(this.type):this._size}getIsInstanced(){return this._instanced}getInstanceDivisor(){return this._instanceDivisor}create(e){this._buffer.create(e),this._alignBuffer()}update(e){this._buffer.update(e),this._alignBuffer()}updateDirectly(e,t,i=!1){this._buffer.updateDirectly(e,t,void 0,i),this._alignBuffer()}dispose(){this._ownsBuffer&&this._buffer.dispose(),this._isDisposed=!0}forEach(e,t){vl(this._buffer.getData(),this.byteOffset,this.byteStride,this._size,this.type,e,this.normalized,(i,r)=>{for(let n=0;n<this._size;n++)t(i[n],r+n)})}_alignBuffer(){}static DeduceStride(e){switch(e){case s.UVKind:case s.UV2Kind:case s.UV3Kind:case s.UV4Kind:case s.UV5Kind:case s.UV6Kind:return 2;case s.NormalKind:case s.PositionKind:return 3;case s.ColorKind:case s.ColorInstanceKind:case s.MatricesIndicesKind:case s.MatricesIndicesExtraKind:case s.MatricesWeightsKind:case s.MatricesWeightsExtraKind:case s.TangentKind:return 4;default:throw new Error("Invalid kind '"+e+"'")}}static GetDataType(e){return e instanceof Int8Array?s.BYTE:e instanceof Uint8Array?s.UNSIGNED_BYTE:e instanceof Int16Array?s.SHORT:e instanceof Uint16Array?s.UNSIGNED_SHORT:e instanceof Int32Array?s.INT:e instanceof Uint32Array?s.UNSIGNED_INT:s.FLOAT}static GetTypeByteLength(e){return Qs(e)}static ForEach(e,t,i,r,n,a,o,l){vl(e,t,i,r,n,a,o,(c,f)=>{for(let h=0;h<r;h++)l(c[h],f+h)})}static GetFloatData(e,t,i,r,n,a,o,l){return jA(e,t,i,r,n,a,o,l)}};A._Counter=0;A.BYTE=5120;A.UNSIGNED_BYTE=5121;A.SHORT=5122;A.UNSIGNED_SHORT=5123;A.INT=5124;A.UNSIGNED_INT=5125;A.FLOAT=5126;A.PositionKind="position";A.NormalKind="normal";A.TangentKind="tangent";A.UVKind="uv";A.UV2Kind="uv2";A.UV3Kind="uv3";A.UV4Kind="uv4";A.UV5Kind="uv5";A.UV6Kind="uv6";A.ColorKind="color";A.ColorInstanceKind="instanceColor";A.MatricesIndicesKind="matricesIndices";A.MatricesWeightsKind="matricesWeights";A.MatricesIndicesExtraKind="matricesIndicesExtra";A.MatricesWeightsExtraKind="matricesWeightsExtra"});var va,Wp=S(()=>{yt();we();va=class{constructor(e){this._vertexBuffers={},this.onBeforeRenderObservable=new N,this._scene=e}_prepareBuffers(){if(this._vertexBuffers[A.PositionKind])return;let e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1),this._vertexBuffers[A.PositionKind]=new A(this._scene.getEngine(),e,A.PositionKind,!1,!1,2),this._buildIndexBuffer()}_buildIndexBuffer(){let e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(e)}_rebuild(){let e=this._vertexBuffers[A.PositionKind];e&&(e._rebuild(),this._buildIndexBuffer())}_prepareFrame(e=null,t=null){let i=this._scene.activeCamera;return!i||(t=t||i._postProcesses.filter(r=>r!=null),!t||t.length===0||!this._scene.postProcessesEnabled)?!1:(t[0].activate(i,e,t!=null),!0)}directRender(e,t=null,i=!1,r=0,n=0,a=!1,o=e.length){let l=this._scene.getEngine();for(let c=0;c<o;c++){c<e.length-1?e[c+1].activate(this._scene.activeCamera||this._scene,t?.texture):(t?l.bindFramebuffer(t,r,void 0,void 0,i,n):a||l.restoreDefaultFramebuffer(),l._debugInsertMarker?.(`post process ${e[c].name} output`));let f=e[c],h=f.apply();h&&(f.onBeforeRenderObservable.notifyObservers(h),this._prepareBuffers(),l.bindBuffers(this._vertexBuffers,this._indexBuffer,h),l.drawElementsType(0,0,6),f.onAfterRenderObservable.notifyObservers(h))}l.setDepthBuffer(!0),l.setDepthWrite(!0)}_finalizeFrame(e,t,i,r,n=!1){let a=this._scene.activeCamera;if(!a||(this.onBeforeRenderObservable.notifyObservers(this),r=r||a._postProcesses.filter(l=>l!=null),r.length===0||!this._scene.postProcessesEnabled))return;let o=this._scene.getEngine();for(let l=0,c=r.length;l<c;l++){let f=r[l];if(l<c-1?f._outputTexture=r[l+1].activate(a,t?.texture):(t?(o.bindFramebuffer(t,i,void 0,void 0,n),f._outputTexture=t):(o.restoreDefaultFramebuffer(),f._outputTexture=null),o._debugInsertMarker?.(`post process ${r[l].name} output`)),e)break;let h=f.apply();h&&(f.onBeforeRenderObservable.notifyObservers(h),this._prepareBuffers(),o.bindBuffers(this._vertexBuffers,this._indexBuffer,h),o.drawElementsType(0,0,6),f.onAfterRenderObservable.notifyObservers(h))}o.setDepthBuffer(!0),o.setDepthWrite(!0),o.setAlphaMode(0)}dispose(){let e=this._vertexBuffers[A.PositionKind];e&&(e.dispose(),this._vertexBuffers[A.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null)}}});function Sl(s){let e=1;do e*=2;while(e<s);return e===s}function Oh(s,e,t){return s*(1-t)+e*t}function ZA(s){let e=AO(s),t=Hp(s);return e-s>s-t?t:e}function AO(s){return s--,s|=s>>1,s|=s>>2,s|=s>>4,s|=s>>8,s|=s>>16,s++,s}function Hp(s){return s=s|s>>1,s=s|s>>2,s=s|s>>4,s=s|s>>8,s=s|s>>16,s-(s>>1)}function xo(s,e,t=2){let i;switch(t){case 1:i=Hp(s);break;case 2:i=ZA(s);break;case 3:default:i=AO(s);break}return Math.min(i,e)}var Ao=S(()=>{});var wt,js,bn=S(()=>{wt=class s{constructor(e){this.length=0,this.data=new Array(e),this._id=s._GlobalId++}push(e){this.data[this.length++]=e,this.length>this.data.length&&(this.data.length*=2)}forEach(e){for(let t=0;t<this.length;t++)e(this.data[t])}sort(e){this.data.sort(e)}reset(){this.length=0}dispose(){this.reset(),this.data&&(this.data.length=0)}concat(e){if(e.length!==0){this.length+e.length>this.data.length&&(this.data.length=(this.length+e.length)*2);for(let t=0;t<e.length;t++)this.data[this.length++]=(e.data||e)[t]}}indexOf(e){let t=this.data.indexOf(e);return t>=this.length?-1:t}contains(e){return this.indexOf(e)!==-1}};wt._GlobalId=0;js=class extends wt{constructor(){super(...arguments),this._duplicateId=0}push(e){super.push(e),e.__smartArrayFlags||(e.__smartArrayFlags={}),e.__smartArrayFlags[this._id]=this._duplicateId}pushNoDuplicate(e){return e.__smartArrayFlags&&e.__smartArrayFlags[this._id]===this._duplicateId?!1:(this.push(e),!0)}reset(){super.reset(),this._duplicateId++}concatWithNoDuplicate(e){if(e.length!==0){this.length+e.length>this.data.length&&(this.data.length=(this.length+e.length)*2);for(let t=0;t<e.length;t++){let i=(e.data||e)[t];this.pushNoDuplicate(i)}}}}});var Lh,RO=S(()=>{bn();ie();Lh=class s{set opaqueSortCompareFn(e){e?this._opaqueSortCompareFn=e:this._opaqueSortCompareFn=s.PainterSortCompare,this._renderOpaque=this._renderOpaqueSorted}set alphaTestSortCompareFn(e){e?this._alphaTestSortCompareFn=e:this._alphaTestSortCompareFn=s.PainterSortCompare,this._renderAlphaTest=this._renderAlphaTestSorted}set transparentSortCompareFn(e){e?this._transparentSortCompareFn=e:this._transparentSortCompareFn=s.defaultTransparentSortCompare,this._renderTransparent=this._renderTransparentSorted}constructor(e,t,i=null,r=null,n=null){this.index=e,this._opaqueSubMeshes=new wt(256),this._transparentSubMeshes=new wt(256),this._alphaTestSubMeshes=new wt(256),this._depthOnlySubMeshes=new wt(256),this._particleSystems=new wt(256),this._spriteManagers=new wt(256),this._empty=!0,this._edgesRenderers=new js(16),this.disableDepthPrePass=!1,this._scene=t,this.opaqueSortCompareFn=i,this.alphaTestSortCompareFn=r,this.transparentSortCompareFn=n}render(e,t,i,r){if(e){e(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,this._depthOnlySubMeshes);return}let n=this._scene.getEngine();this._depthOnlySubMeshes.length!==0&&(n.setColorWrite(!1),this._renderAlphaTest(this._depthOnlySubMeshes),n.setColorWrite(!0)),this._opaqueSubMeshes.length!==0&&this._renderOpaque(this._opaqueSubMeshes),this._alphaTestSubMeshes.length!==0&&this._renderAlphaTest(this._alphaTestSubMeshes);let a=n.getStencilBuffer();if(n.setStencilBuffer(!1),t&&this._renderSprites(),i&&this._renderParticles(r),this.onBeforeTransparentRendering&&this.onBeforeTransparentRendering(),this._transparentSubMeshes.length!==0||this._scene.useOrderIndependentTransparency){if(n.setStencilBuffer(a),this._scene.useOrderIndependentTransparency){let o=this._scene.depthPeelingRenderer.render(this._transparentSubMeshes);o.length&&this._renderTransparent(o)}else this._renderTransparent(this._transparentSubMeshes);n.setAlphaMode(0)}if(n.setStencilBuffer(!1),this._edgesRenderers.length){for(let o=0;o<this._edgesRenderers.length;o++)this._edgesRenderers.data[o].render();n.setAlphaMode(0)}n.setStencilBuffer(a)}_renderOpaqueSorted(e){s._RenderSorted(e,this._opaqueSortCompareFn,this._scene.activeCamera,!1,this.disableDepthPrePass)}_renderAlphaTestSorted(e){s._RenderSorted(e,this._alphaTestSortCompareFn,this._scene.activeCamera,!1,this.disableDepthPrePass)}_renderTransparentSorted(e){s._RenderSorted(e,this._transparentSortCompareFn,this._scene.activeCamera,!0,this.disableDepthPrePass)}static _RenderSorted(e,t,i,r,n){let a=0,o,l=i?i.globalPosition:s._ZeroVector;if(r)for(;a<e.length;a++)o=e.data[a],o._alphaIndex=o.getMesh().alphaIndex,o._distanceToCamera=E.Distance(o.getBoundingInfo().boundingSphere.centerWorld,l);let c=e.length===e.data.length?e.data:e.data.slice(0,e.length);t&&c.sort(t);let f=c[0].getMesh().getScene();for(a=0;a<c.length;a++)if(o=c[a],!(f._activeMeshesFrozenButKeepClipping&&!o.isInFrustum(f._frustumPlanes))){if(r){let h=o.getMaterial();if(h&&h.needDepthPrePass&&!n){let u=h.getScene().getEngine();u.setColorWrite(!1),u.setAlphaMode(0),o.render(!1),u.setColorWrite(!0)}}o.render(r)}}static defaultTransparentSortCompare(e,t){return e._alphaIndex>t._alphaIndex?1:e._alphaIndex<t._alphaIndex?-1:s.backToFrontSortCompare(e,t)}static backToFrontSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?1:e._distanceToCamera>t._distanceToCamera?-1:0}static frontToBackSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?-1:e._distanceToCamera>t._distanceToCamera?1:0}static PainterSortCompare(e,t){let i=e.getMesh(),r=t.getMesh();return i.material&&r.material?i.material.uniqueId-r.material.uniqueId:i.uniqueId-r.uniqueId}prepare(){this._opaqueSubMeshes.reset(),this._transparentSubMeshes.reset(),this._alphaTestSubMeshes.reset(),this._depthOnlySubMeshes.reset(),this._particleSystems.reset(),this.prepareSprites(),this._edgesRenderers.reset(),this._empty=!0}prepareSprites(){this._spriteManagers.reset()}dispose(){this._opaqueSubMeshes.dispose(),this._transparentSubMeshes.dispose(),this._alphaTestSubMeshes.dispose(),this._depthOnlySubMeshes.dispose(),this._particleSystems.dispose(),this._spriteManagers.dispose(),this._edgesRenderers.dispose()}dispatch(e,t,i){t===void 0&&(t=e.getMesh()),i===void 0&&(i=e.getMaterial()),i!=null&&(i.needAlphaBlendingForMesh(t)?this._transparentSubMeshes.push(e):i.needAlphaTestingForMesh(t)?(i.needDepthPrePass&&!this.disableDepthPrePass&&this._depthOnlySubMeshes.push(e),this._alphaTestSubMeshes.push(e)):(i.needDepthPrePass&&!this.disableDepthPrePass&&this._depthOnlySubMeshes.push(e),this._opaqueSubMeshes.push(e)),t._renderingGroup=this,t._edgesRenderer&&t.isEnabled()&&t.isVisible&&t._edgesRenderer.isEnabled&&this._edgesRenderers.pushNoDuplicate(t._edgesRenderer),this._empty=!1)}dispatchSprites(e){this._spriteManagers.push(e),this._empty=!1}dispatchParticles(e){this._particleSystems.push(e),this._empty=!1}_renderParticles(e){if(this._particleSystems.length===0)return;let t=this._scene.activeCamera;this._scene.onBeforeParticlesRenderingObservable.notifyObservers(this._scene);for(let i=0;i<this._particleSystems.length;i++){let r=this._particleSystems.data[i];if((t&&t.layerMask&r.layerMask)===0)continue;let n=r.emitter;(!n.position||!e||e.indexOf(n)!==-1)&&this._scene._activeParticles.addCount(r.render(),!1)}this._scene.onAfterParticlesRenderingObservable.notifyObservers(this._scene)}_renderSprites(){if(!this._scene.spritesEnabled||this._spriteManagers.length===0)return;let e=this._scene.activeCamera;this._scene.onBeforeSpritesRenderingObservable.notifyObservers(this._scene);for(let t=0;t<this._spriteManagers.length;t++){let i=this._spriteManagers.data[t];(e&&e.layerMask&i.layerMask)!==0&&i.render()}this._scene.onAfterSpritesRenderingObservable.notifyObservers(this._scene)}};Lh._ZeroVector=E.Zero()});var JA,Ps,zp=S(()=>{RO();JA=class{},Ps=class s{get disableDepthPrePass(){return this._disableDepthPrePass}set disableDepthPrePass(e){this._disableDepthPrePass=e;for(let t of this._renderingGroups)t.disableDepthPrePass=e}get maintainStateBetweenFrames(){return this._maintainStateBetweenFrames}set maintainStateBetweenFrames(e){e!==this._maintainStateBetweenFrames&&(this._maintainStateBetweenFrames=e,this._maintainStateBetweenFrames||this.restoreDispachedFlags())}restoreDispachedFlags(){for(let e of this._scene.meshes)if(e.subMeshes)for(let t of e.subMeshes)t._wasDispatched=!1;if(this._scene.spriteManagers)for(let e of this._scene.spriteManagers)e._wasDispatched=!1;for(let e of this._scene.particleSystems)e._wasDispatched=!1}constructor(e){this._useSceneAutoClearSetup=!1,this._disableDepthPrePass=!1,this._renderingGroups=new Array,this._autoClearDepthStencil={},this._customOpaqueSortCompareFn={},this._customAlphaTestSortCompareFn={},this._customTransparentSortCompareFn={},this._renderingGroupInfo=new JA,this._maintainStateBetweenFrames=!1,this._scene=e;for(let t=s.MIN_RENDERINGGROUPS;t<s.MAX_RENDERINGGROUPS;t++)this._autoClearDepthStencil[t]={autoClear:!0,depth:!0,stencil:!0}}getRenderingGroup(e){let t=e||0;return this._prepareRenderingGroup(t),this._renderingGroups[t]}_clearDepthStencilBuffer(e=!0,t=!0){this._depthStencilBufferAlreadyCleaned||(this._scene.getEngine().clear(null,!1,e,t),this._depthStencilBufferAlreadyCleaned=!0)}render(e,t,i,r){let n=this._renderingGroupInfo;if(n.scene=this._scene,n.camera=this._scene.activeCamera,n.renderingManager=this,this._scene.spriteManagers&&r)for(let a=0;a<this._scene.spriteManagers.length;a++){let o=this._scene.spriteManagers[a];this.dispatchSprites(o)}for(let a=s.MIN_RENDERINGGROUPS;a<s.MAX_RENDERINGGROUPS;a++){this._depthStencilBufferAlreadyCleaned=a===s.MIN_RENDERINGGROUPS;let o=this._renderingGroups[a];if(!o||o._empty)continue;let l=1<<a;if(n.renderingGroupId=a,this._scene.onBeforeRenderingGroupObservable.notifyObservers(n,l),s.AUTOCLEAR){let c=this._useSceneAutoClearSetup?this._scene.getAutoClearDepthStencilSetup(a):this._autoClearDepthStencil[a];c&&c.autoClear&&this._clearDepthStencilBuffer(c.depth,c.stencil)}for(let c of this._scene._beforeRenderingGroupDrawStage)c.action(a);o.render(e,r,i,t);for(let c of this._scene._afterRenderingGroupDrawStage)c.action(a);this._scene.onAfterRenderingGroupObservable.notifyObservers(n,l)}}reset(){if(!this.maintainStateBetweenFrames)for(let e=s.MIN_RENDERINGGROUPS;e<s.MAX_RENDERINGGROUPS;e++){let t=this._renderingGroups[e];t&&t.prepare()}}resetSprites(){if(!this.maintainStateBetweenFrames)for(let e=s.MIN_RENDERINGGROUPS;e<s.MAX_RENDERINGGROUPS;e++){let t=this._renderingGroups[e];t&&t.prepareSprites()}}dispose(){this.freeRenderingGroups(),this._renderingGroups.length=0,this._renderingGroupInfo=null}freeRenderingGroups(){for(let e=s.MIN_RENDERINGGROUPS;e<s.MAX_RENDERINGGROUPS;e++){let t=this._renderingGroups[e];t&&t.dispose()}}_prepareRenderingGroup(e){this._renderingGroups[e]===void 0&&(this._renderingGroups[e]=new Lh(e,this._scene,this._customOpaqueSortCompareFn[e],this._customAlphaTestSortCompareFn[e],this._customTransparentSortCompareFn[e]),this._renderingGroups[e].disableDepthPrePass=this._disableDepthPrePass)}dispatchSprites(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchSprites(e))}dispatchParticles(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchParticles(e))}dispatch(e,t,i){t===void 0&&(t=e.getMesh()),!(this.maintainStateBetweenFrames&&e._wasDispatched)&&(e._wasDispatched=!0,this.getRenderingGroup(t.renderingGroupId).dispatch(e,t,i))}setRenderingOrder(e,t=null,i=null,r=null){if(this._customOpaqueSortCompareFn[e]=t,this._customAlphaTestSortCompareFn[e]=i,this._customTransparentSortCompareFn[e]=r,this._renderingGroups[e]){let n=this._renderingGroups[e];n.opaqueSortCompareFn=this._customOpaqueSortCompareFn[e],n.alphaTestSortCompareFn=this._customAlphaTestSortCompareFn[e],n.transparentSortCompareFn=this._customTransparentSortCompareFn[e]}}setRenderingAutoClearDepthStencil(e,t,i=!0,r=!0){this._autoClearDepthStencil[e]={autoClear:t,depth:i,stencil:r}}getAutoClearDepthStencilSetup(e){return this._autoClearDepthStencil[e]}};Ps.MAX_RENDERINGGROUPS=4;Ps.MIN_RENDERINGGROUPS=0;Ps.AUTOCLEAR=!0});var rr,wh=S(()=>{we();zp();Hs();ys();Ee();bn();rr=class s{get renderList(){return this._renderList}set renderList(e){this._renderList!==e&&(this._unObserveRenderList&&(this._unObserveRenderList(),this._unObserveRenderList=null),e&&(this._unObserveRenderList=op(e,this._renderListHasChanged)),this._renderList=e)}get disableImageProcessing(){return this._disableImageProcessing}set disableImageProcessing(e){e!==this._disableImageProcessing&&(this._disableImageProcessing=e,this._scene.markAllMaterialsAsDirty(64))}get disableDepthPrePass(){return this._disableDepthPrePass}set disableDepthPrePass(e){this._disableDepthPrePass=e,this._renderingManager.disableDepthPrePass=e}get name(){return this._name}set name(e){if(this._name!==e){if(this._name=e,this._sceneUBOs)for(let t=0;t<this._sceneUBOs.length;++t)this._sceneUBOs[t].name=`Scene ubo #${t} for ${this.name}`;if(this._scene)for(let t=0;t<this._renderPassIds.length;++t){let i=this._renderPassIds[t];this._engine._renderPassNames[i]=`${this._name}#${t}`}}}get renderPassIds(){return this._renderPassIds}get currentRefreshId(){return this._currentRefreshId}getActiveMeshes(){return this._activeMeshes}setMaterialForRendering(e,t){let i;Array.isArray(e)?i=e:i=[e];for(let r=0;r<i.length;++r)for(let n=0;n<this.options.numPasses;++n){let a=i[r];i[r].isAnInstance&&(a=i[r].sourceMesh),a.setMaterialForRenderPass(this._renderPassIds[n],t!==void 0?Array.isArray(t)?t[n]:t:void 0)}}_freezeActiveMeshes(e){this._freezeActiveMeshesCancel=br(()=>this._checkReadiness(),()=>{if(this._freezeActiveMeshesCancel=null,e)for(let t=0;t<this._activeMeshes.length;t++)this._activeMeshes.data[t]._freeze();this._prepareRenderingManager(0,!0),this._isFrozen=!0},(t,i)=>{this._freezeActiveMeshesCancel=null,i?(P.Error("ObjectRenderer: Timeout while waiting for the renderer to be ready."),t&&P.Error(t)):(P.Error("ObjectRenderer: An unexpected error occurred while waiting for the renderer to be ready."),t&&(P.Error(t),t.stack&&P.Error(t.stack)))})}_unfreezeActiveMeshes(){this._freezeActiveMeshesCancel?.(),this._freezeActiveMeshesCancel=null;for(let e=0;e<this._activeMeshes.length;e++)this._activeMeshes.data[e]._unFreeze();this._isFrozen=!1}constructor(e,t,i){this._unObserveRenderList=null,this._renderListHasChanged=(r,n)=>{let a=this._renderList?this._renderList.length:0;if(n===0&&a>0||a===0)for(let o of this._scene.meshes)o._markSubMeshesAsLightDirty()},this.particleSystemList=null,this.getCustomRenderList=null,this.renderParticles=!0,this.renderSprites=!1,this.forceLayerMaskCheck=!1,this.enableBoundingBoxRendering=!1,this.enableOutlineRendering=!0,this._disableImageProcessing=!1,this.dontSetTransformationMatrix=!1,this._disableDepthPrePass=!1,this.onBeforeRenderObservable=new N,this.onAfterRenderObservable=new N,this.onBeforeRenderingManagerRenderObservable=new N,this.onAfterRenderingManagerRenderObservable=new N,this.onInitRenderingObservable=new N,this.onFinishRenderingObservable=new N,this.onFastPathRenderObservable=new N,this._currentRefreshId=-1,this._refreshRate=1,this._currentApplyByPostProcessSetting=!1,this._activeMeshes=new wt(256),this._activeBoundingBoxes=new wt(32),this._currentFrameId=-1,this._currentSceneUBOIndex=0,this._isFrozen=!1,this._freezeActiveMeshesCancel=null,this._currentSceneCamera=null,this.name=e,this._scene=t,this._engine=this._scene.getEngine(),this._useUBO=this._engine.supportsUniformBuffers,this._useUBO&&(this._sceneUBOs=[],this._createSceneUBO()),this.renderList=[],this._renderPassIds=[],this.options={numPasses:1,doNotChangeAspectRatio:!0,...i},this._createRenderPassId(),this.renderPassId=this._renderPassIds[0],this._renderingManager=new Ps(t),this._renderingManager._useSceneAutoClearSetup=!0,this._scene.addObjectRenderer(this)}_releaseRenderPassId(){for(let e=0;e<this.options.numPasses;++e)this._engine.releaseRenderPassId(this._renderPassIds[e]);this._renderPassIds.length=0}_createRenderPassId(){this._releaseRenderPassId();for(let e=0;e<this.options.numPasses;++e)this._renderPassIds[e]=this._engine.createRenderPassId(`${this.name}#${e}`)}_createSceneUBO(){let e=this._sceneUBOs.length;this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene ubo #${e} for ${this.name}`,!1))}_getSceneUBO(){return this._currentFrameId!==this._engine.frameId&&(this._currentSceneUBOIndex=0,this._currentFrameId=this._engine.frameId),this._currentSceneUBOIndex>=this._sceneUBOs.length&&this._createSceneUBO(),this._sceneUBOs[this._currentSceneUBOIndex++]}resetRefreshCounter(){this._currentRefreshId=-1}get refreshRate(){return this._refreshRate}set refreshRate(e){this._refreshRate=e,this.resetRefreshCounter()}shouldRender(){return this._currentRefreshId===-1?(this._currentRefreshId=1,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)}isReadyForRendering(e,t){this.prepareRenderList(),this.initRender(e,t);let i=this._checkReadiness();return this.finishRender(),i}prepareRenderList(){let e=this._scene;if(this._waitingRenderList){if(!this.renderListPredicate){this.renderList=[];for(let t=0;t<this._waitingRenderList.length;t++){let i=this._waitingRenderList[t],r=e.getMeshById(i);r&&this.renderList.push(r)}}this._waitingRenderList=void 0}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];let t=this._scene.meshes;for(let i=0;i<t.length;i++){let r=t[i];this.renderListPredicate(r)&&this.renderList.push(r)}}this._currentApplyByPostProcessSetting=this._scene.imageProcessingConfiguration.applyByPostProcess,this._disableImageProcessing&&(this._scene.imageProcessingConfiguration._applyByPostProcess=this._disableImageProcessing)}initRender(e,t){let i=this.activeCamera??this._scene.activeCamera;this._currentSceneCamera=this._scene.activeCamera,this._useUBO&&(this._currentSceneUBO=this._scene.getSceneUniformBuffer(),this._currentSceneUBO.unbindEffect(),this._scene.setSceneUniformBuffer(this._getSceneUBO())),this.onInitRenderingObservable.notifyObservers(this),i&&(this.dontSetTransformationMatrix||this._scene.setTransformMatrix(i.getViewMatrix(),i.getProjectionMatrix(!0)),this._scene.activeCamera=i,this._engine.setViewport(i.rigParent?i.rigParent.viewport:i.viewport,e,t)),this._useUBO&&this._scene.finalizeSceneUbo(),this._defaultRenderListPrepared=!1}finishRender(){let e=this._scene;this._useUBO&&this._scene.setSceneUniformBuffer(this._currentSceneUBO),this._disableImageProcessing&&(e.imageProcessingConfiguration._applyByPostProcess=this._currentApplyByPostProcessSetting),e.activeCamera=this._currentSceneCamera,this._currentSceneCamera&&(this.activeCamera&&this.activeCamera!==e.activeCamera&&e.setTransformMatrix(this._currentSceneCamera.getViewMatrix(),this._currentSceneCamera.getProjectionMatrix(!0)),this._engine.setViewport(this._currentSceneCamera.viewport)),e.resetCachedMaterial(),this.onFinishRenderingObservable.notifyObservers(this)}render(e=0,t=!1){let i=this._engine.currentRenderPassId;if(this._engine.currentRenderPassId=this._renderPassIds[e],this.onBeforeRenderObservable.notifyObservers(e),this._engine.snapshotRendering&&this._engine.snapshotRenderingMode===1)this.onFastPathRenderObservable.notifyObservers(e);else{let n=this._prepareRenderingManager(e),a=this._scene.getOutlineRenderer?.(),o=a?.enabled;a&&(a.enabled=this.enableOutlineRendering),this.onBeforeRenderingManagerRenderObservable.notifyObservers(e),this._renderingManager.render(this.customRenderFunction,n,this.renderParticles,this.renderSprites),this.onAfterRenderingManagerRenderObservable.notifyObservers(e),a&&(a.enabled=o)}t||this.onAfterRenderObservable.notifyObservers(e),this._engine.currentRenderPassId=i}_checkReadiness(){let e=this._scene,t=this._engine.currentRenderPassId,i=!0;e.getViewMatrix()||e.updateTransformMatrix();let r=this.options.numPasses;for(let a=0;a<r&&i;a++){let o=null,l=this.renderList?this.renderList:e.frameGraph?e.meshes:e.getActiveMeshes().data,c=this.renderList?this.renderList.length:e.frameGraph?e.meshes.length:e.getActiveMeshes().length;this._engine.currentRenderPassId=this._renderPassIds[a],this.onBeforeRenderObservable.notifyObservers(a),this.getCustomRenderList&&(o=this.getCustomRenderList(a,l,c)),o||(o=l),this.options.doNotChangeAspectRatio||e.updateTransformMatrix(!0);for(let f=0;f<o.length&&i;++f){let h=o[f];if(!(!h.isEnabled()||h.isBlocked||!h.isVisible||!h.subMeshes)){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(h,this.refreshRate,!0)){i=!1;continue}}else if(!h.isReady(!0)){i=!1;continue}}}this.onAfterRenderObservable.notifyObservers(a),r>1&&(e.incrementRenderId(),e.resetCachedMaterial())}let n=this.particleSystemList||e.particleSystems;for(let a of n)a.isReady()||(i=!1);return this._engine.currentRenderPassId=t,i}_prepareRenderingManager(e=0,t=!1){let i=this._scene,r=null,n=0,a=!1,o=this.renderList?this.renderList:i.frameGraph?i.meshes:i.getActiveMeshes().data,l=this.renderList?this.renderList.length:i.frameGraph?i.meshes.length:i.getActiveMeshes().length;if(this.getCustomRenderList&&(r=this.getCustomRenderList(e,o,l)),r)n=r.length,a=this.forceLayerMaskCheck;else{if(this._defaultRenderListPrepared&&!t)return o;this._defaultRenderListPrepared=!0,r=o,n=l,a=!this.renderList||this.forceLayerMaskCheck}let c=i.activeCamera,f=this.cameraForLOD??c,h=i.getBoundingBoxRenderer?.();if(i._activeMeshesFrozen&&this._isFrozen){if(this._renderingManager.resetSprites(),this.enableBoundingBoxRendering&&h){h.reset();for(let p=0;p<this._activeBoundingBoxes.length;p++){let m=this._activeBoundingBoxes.data[p];h.renderList.push(m)}}return r}this._renderingManager.reset(),this._activeMeshes.reset(),this._activeBoundingBoxes.reset(),h&&h.reset();let u=i.getRenderId(),d=i.getFrameId();for(let p=0;p<n;p++){let m=r[p];if(m&&!m.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(m,this.refreshRate,!1)){this.resetRefreshCounter();continue}}else if(!m.isReady(this.refreshRate===0)){this.resetRefreshCounter();continue}let _=null;if(f){let T=m._internalAbstractMeshDataInfo._currentLOD.get(f);!T||T[1]!==d?(_=i.customLODSelector?i.customLODSelector(m,f):m.getLOD(f),T?(T[0]=_,T[1]=d):m._internalAbstractMeshDataInfo._currentLOD.set(f,[_,d])):_=T[0]}else _=m;if(!_)continue;_!==m&&_.billboardMode!==0&&_.computeWorldMatrix(),_._preActivateForIntermediateRendering(u);let v;if(a&&c?v=(m.layerMask&c.layerMask)===0:v=!1,m.isEnabled()&&m.isVisible&&m.subMeshes&&!v){if(this._activeMeshes.push(m),_._internalAbstractMeshDataInfo._wasActiveLastFrame=!0,_!==m&&_._activate(u,!0),this.enableBoundingBoxRendering&&h&&h._preActiveMesh(m),m._activate(u,!0)&&m.subMeshes.length){m.isAnInstance?m._internalAbstractMeshDataInfo._actAsRegularMesh&&(_=m):_._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!1,_._internalAbstractMeshDataInfo._isActiveIntermediate=!0,i._prepareSkeleton(_);for(let T=0;T<_.subMeshes.length;T++){let C=_.subMeshes[T];this.enableBoundingBoxRendering&&h&&h._evaluateSubMesh(m,C),this._renderingManager.dispatch(C,_)}}m._postActivate()}}}if(this.enableBoundingBoxRendering&&h&&t)for(let p=0;p<h.renderList.length;p++){let m=h.renderList.data[p];this._activeBoundingBoxes.push(m)}if(this._scene.particlesEnabled){this._scene.onBeforeParticlesRenderingObservable.notifyObservers(this._scene);let p=this.particleSystemList||i.particleSystems;for(let m=0;m<p.length;m++){let _=p[m],v=_.emitter;!_.isStarted()||!v||v.position&&!v.isEnabled()||this._renderingManager.dispatchParticles(_)}this._scene.onAfterParticlesRenderingObservable.notifyObservers(this._scene)}return r}get renderingManager(){return this._renderingManager}setRenderingOrder(e,t=null,i=null,r=null){this._renderingManager.setRenderingOrder(e,t,i,r)}setRenderingAutoClearDepthStencil(e,t,i=!0,r=!0){this._renderingManager.setRenderingAutoClearDepthStencil(e,t,i,r),this._renderingManager._useSceneAutoClearSetup=!1}clone(){let e=new s(this.name,this._scene,this.options);return this.renderList&&(e.renderList=this.renderList.slice(0)),e}dispose(){let e=this.renderList?this.renderList:this._scene.getActiveMeshes().data,t=this.renderList?this.renderList.length:this._scene.getActiveMeshes().length;for(let i=0;i<t;i++){let r=e[i];r&&r.getMaterialForRenderPass(this.renderPassId)!==void 0&&r.setMaterialForRenderPass(this.renderPassId,void 0)}if(this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderingManagerRenderObservable.clear(),this.onAfterRenderingManagerRenderObservable.clear(),this.onFastPathRenderObservable.clear(),this._releaseRenderPassId(),this.renderList=null,this._sceneUBOs)for(let i of this._sceneUBOs)i.dispose();this._sceneUBOs=void 0,this._scene.removeObjectRenderer(this)}_rebuild(){this.refreshRate===s.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=s.REFRESHRATE_RENDER_ONCE)}freeRenderingGroups(){this._renderingManager&&this._renderingManager.freeRenderingGroups()}};rr.REFRESHRATE_RENDER_ONCE=0;rr.REFRESHRATE_RENDER_ONEVERYFRAME=1;rr.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2});var Vr,El=S(()=>{ys();Vr=class{static GetEffect(e){return e.getPipelineContext===void 0?e.effect:e}constructor(e,t=!0){this._wasPreviouslyReady=!1,this._forceRebindOnNextCall=!0,this._wasPreviouslyUsingInstances=null,this.effect=null,this.defines=null,this.drawContext=e.createDrawContext(),t&&(this.materialContext=e.createMaterialContext())}setEffect(e,t,i=!0){this.effect=e,t!==void 0&&(this.defines=t),i&&this.drawContext?.reset()}dispose(e=!1){if(this.effect){let t=this.effect;e?t.dispose():Ys.SetImmediate(()=>{t.getEngine().onEndFrameObservable.addOnce(()=>{t.dispose()})}),this.effect=null}this.drawContext?.dispose()}}});var eR={};V(eR,{postprocessVertexShader:()=>tq});var $A,bO,tq,Xp=S(()=>{O();$A="postprocessVertexShader",bO=`attribute vec2 position;uniform vec2 scale;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vUV=(position*madd+madd)*scale;gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;g.ShadersStore[$A]||(g.ShadersStore[$A]=bO);tq={name:$A,shader:bO}});var iR={};V(iR,{postprocessVertexShaderWGSL:()=>iq});var tR,CO,iq,rR=S(()=>{O();tR="postprocessVertexShader",CO=`attribute position: vec2<f32>;uniform scale: vec2<f32>;varying vUV: vec2<f32>;const madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
vertexOutputs.vUV=(vertexInputs.position*madd+madd)*uniforms.scale;vertexOutputs.position=vec4(vertexInputs.position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}
`;g.ShadersStoreWGSL[tR]||(g.ShadersStoreWGSL[tR]=CO);iq={name:tR,shader:CO}});var sR,Cn,ti,In=S(()=>{yt();Dh();we();dl();El();Xp();sR={positions:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]},Cn=class{constructor(e,t=sR){this._fullscreenViewport=new So(0,0,1,1);let i=t.positions??sR.positions,r=t.indices??sR.indices;this.engine=e,this._vertexBuffers={[A.PositionKind]:new A(e,i,A.PositionKind,!1,!1,2)},this._indexBuffer=e.createIndexBuffer(r),this._indexBufferLength=r.length,this._onContextRestoredObserver=e.onContextRestoredObservable.add(()=>{this._indexBuffer=e.createIndexBuffer(r);for(let n in this._vertexBuffers)this._vertexBuffers[n]._rebuild()})}setViewport(e=this._fullscreenViewport){this.engine.setViewport(e)}bindBuffers(e){this.engine.bindBuffers(this._vertexBuffers,this._indexBuffer,e)}applyEffectWrapper(e,t=!1,i=!1){this.engine.setState(!0),this.engine.depthCullingState.depthTest=t,this.engine.stencilState.stencilTest=i,this.engine.enableEffect(e.drawWrapper),this.bindBuffers(e.effect),e.onApplyObservable.notifyObservers({})}saveStates(){this._savedStateDepthTest=this.engine.depthCullingState.depthTest,this._savedStateStencilTest=this.engine.stencilState.stencilTest}restoreStates(){this.engine.depthCullingState.depthTest=this._savedStateDepthTest,this.engine.stencilState.stencilTest=this._savedStateStencilTest}draw(){this.engine.drawElementsType(0,0,this._indexBufferLength)}_isRenderTargetTexture(e){return e.renderTarget!==void 0}render(e,t=null){if(!e.effect.isReady())return;this.saveStates(),this.setViewport();let i=t===null?null:this._isRenderTargetTexture(t)?t.renderTarget:t;i&&this.engine.bindFramebuffer(i),this.applyEffectWrapper(e),this.draw(),i&&this.engine.unBindFramebuffer(i),this.restoreStates()}dispose(){let e=this._vertexBuffers[A.PositionKind];e&&(e.dispose(),delete this._vertexBuffers[A.PositionKind]),this._indexBuffer&&this.engine._releaseBuffer(this._indexBuffer),this._onContextRestoredObserver&&(this.engine.onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}},ti=class s{static RegisterShaderCodeProcessing(e,t){if(!t){delete s._CustomShaderCodeProcessing[e??""];return}s._CustomShaderCodeProcessing[e??""]=t}static _GetShaderCodeProcessing(e){return s._CustomShaderCodeProcessing[e]??s._CustomShaderCodeProcessing[""]}get name(){return this.options.name}set name(e){this.options.name=e}isReady(){return this._drawWrapper.effect?.isReady()??!1}get drawWrapper(){return this._drawWrapper}get effect(){return this._drawWrapper.effect}set effect(e){this._drawWrapper.effect=e}constructor(e){this.alphaMode=0,this.onEffectCreatedObservable=new N(void 0,!0),this.onApplyObservable=new N,this._shadersLoaded=!1,this._webGPUReady=!1,this._importPromises=[],this.options={...e,name:e.name||"effectWrapper",engine:e.engine,uniforms:e.uniforms||e.uniformNames||[],uniformNames:void 0,samplers:e.samplers||e.samplerNames||[],samplerNames:void 0,attributeNames:e.attributeNames||["position"],uniformBuffers:e.uniformBuffers||[],defines:e.defines||"",useShaderStore:e.useShaderStore||!1,vertexUrl:e.vertexUrl||e.vertexShader||"postprocess",vertexShader:void 0,fragmentShader:e.fragmentShader||"pass",indexParameters:e.indexParameters,blockCompilation:e.blockCompilation||!1,shaderLanguage:e.shaderLanguage||0,onCompiled:e.onCompiled||void 0,extraInitializations:e.extraInitializations||void 0,extraInitializationsAsync:e.extraInitializationsAsync||void 0,useAsPostProcess:e.useAsPostProcess??!1,allowEmptySourceTexture:e.allowEmptySourceTexture??!1},this.options.uniformNames=this.options.uniforms,this.options.samplerNames=this.options.samplers,this.options.vertexShader=this.options.vertexUrl,this.options.useAsPostProcess&&(!this.options.allowEmptySourceTexture&&this.options.samplers.indexOf("textureSampler")===-1&&this.options.samplers.push("textureSampler"),this.options.uniforms.indexOf("scale")===-1&&this.options.uniforms.push("scale")),e.vertexUrl||e.vertexShader?this._shaderPath={vertexSource:this.options.vertexShader}:(this.options.useAsPostProcess||(this.options.uniforms.push("scale"),this.onApplyObservable.add(()=>{this.effect.setFloat2("scale",1,1)})),this._shaderPath={vertex:this.options.vertexShader}),this._shaderPath.fragmentSource=this.options.fragmentShader,this._shaderPath.spectorName=this.options.name,this.options.useShaderStore&&(this._shaderPath.fragment=this._shaderPath.fragmentSource,this._shaderPath.vertex||(this._shaderPath.vertex=this._shaderPath.vertexSource),delete this._shaderPath.fragmentSource,delete this._shaderPath.vertexSource),this.onApplyObservable.add(()=>{this.bind()}),this.options.useShaderStore||(this._onContextRestoredObserver=this.options.engine.onContextRestoredObservable.add(()=>{this.effect._pipelineContext=null,this.effect._prepareEffect()})),this._drawWrapper=new Vr(this.options.engine),this._webGPUReady=this.options.shaderLanguage===1;let t=Array.isArray(this.options.defines)?this.options.defines.join(`
`):this.options.defines;this._postConstructor(this.options.blockCompilation,t,this.options.extraInitializations)}_gatherImports(e=!1,t){this.options.useAsPostProcess&&(e&&this._webGPUReady?t.push(Promise.all([Promise.resolve().then(()=>(rR(),iR))])):t.push(Promise.all([Promise.resolve().then(()=>(Xp(),eR))])))}_postConstructor(e,t=null,i,r){this._importPromises.length=0,r&&this._importPromises.push(...r);let n=this.options.engine.isWebGPU&&!s.ForceGLSL;this._gatherImports(n,this._importPromises),i!==void 0&&i(n,this._importPromises),n&&this._webGPUReady&&(this.options.shaderLanguage=1),e||this.updateEffect(t)}updateEffect(e=null,t=null,i=null,r,n,a,o,l){let c=s._GetShaderCodeProcessing(this.name);if(c?.defineCustomBindings){let u=t?.slice()??[];u.push(...this.options.uniforms);let d=i?.slice()??[];d.push(...this.options.samplers),e=c.defineCustomBindings(this.name,e,u,d),t=u,i=d}this.options.defines=e||"";let f=this._shadersLoaded||this._importPromises.length===0?void 0:async()=>{await Promise.all(this._importPromises),this._shadersLoaded=!0},h;this.options.extraInitializationsAsync?h=async()=>{f?.(),await this.options.extraInitializationsAsync()}:h=f,this.options.useShaderStore?this._drawWrapper.effect=this.options.engine.createEffect({vertex:o??this._shaderPath.vertex,fragment:l??this._shaderPath.fragment},{attributes:this.options.attributeNames,uniformsNames:t||this.options.uniforms,uniformBuffersNames:this.options.uniformBuffers,samplers:i||this.options.samplers,defines:e!==null?e:"",fallbacks:null,onCompiled:n??this.options.onCompiled,onError:a??null,indexParameters:r||this.options.indexParameters,processCodeAfterIncludes:c?.processCodeAfterIncludes?(u,d)=>c.processCodeAfterIncludes(this.name,u,d):null,processFinalCode:c?.processFinalCode?(u,d)=>c.processFinalCode(this.name,u,d):null,shaderLanguage:this.options.shaderLanguage,extraInitializationsAsync:h},this.options.engine):this._drawWrapper.effect=new li(this._shaderPath,this.options.attributeNames,t||this.options.uniforms,i||this.options.samplerNames,this.options.engine,e,void 0,n||this.options.onCompiled,void 0,void 0,void 0,this.options.shaderLanguage,h),this.onEffectCreatedObservable.notifyObservers(this._drawWrapper.effect)}bind(e=!1){this.options.useAsPostProcess&&!e&&(this.options.engine.setAlphaMode(this.alphaMode),this.drawWrapper.effect.setFloat2("scale",1,1)),s._GetShaderCodeProcessing(this.name)?.bindCustomBindings?.(this.name,this._drawWrapper.effect)}dispose(e=!1){this._onContextRestoredObserver&&(this.effect.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null),this.onEffectCreatedObservable.clear(),this._drawWrapper.dispose(!0)}};ti.ForceGLSL=!1;ti._CustomShaderCodeProcessing={}});function Bc(s){return s.getPipelineContext===void 0}var Yp=S(()=>{});var Kp,IO=S(()=>{Kp=class{constructor(){this.shaderLanguage=0}postProcessor(e,t,i,r,n){if(n.drawBuffersExtensionDisabled){let a=/#extension.+GL_EXT_draw_buffers.+(enable|require)/g;e=e.replace(a,"")}return e}}});var rq,qp,yO=S(()=>{rq=/(flat\s)?\s*varying\s*.*/,qp=class{constructor(){this.shaderLanguage=0}attributeProcessor(e){return e.replace("attribute","in")}varyingCheck(e,t){return rq.test(e)}varyingProcessor(e,t){return e.replace("varying",t?"in":"out")}postProcessor(e,t,i){let r=e.search(/#extension.+GL_EXT_draw_buffers.+require/)!==-1,n=/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g;if(e=e.replace(n,""),e=e.replace(/texture2D\s*\(/g,"texture("),i){let a=e.search(/layout *\(location *= *0\) *out/g)!==-1,o=t.indexOf("#define DUAL_SOURCE_BLENDING")!==-1,l=o?`layout(location = 0, index = 0) out vec4 glFragColor;
layout(location = 0, index = 1) out vec4 glFragColor2;
`:`layout(location = 0) out vec4 glFragColor;
`;o&&(e=`#extension GL_EXT_blend_func_extended : require
`+e),e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCubeLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCube\s*\(/g,"texture("),e=e.replace(/gl_FragDepthEXT/g,"gl_FragDepth"),e=e.replace(/gl_FragColor/g,"glFragColor"),e=e.replace(/gl_FragData/g,"glFragData"),e=e.replace(/void\s+?main\s*\(/g,(r||a?"":l)+"void main(")}else if(t.indexOf("#define VERTEXOUTPUT_INVARIANT")>=0&&(e=`invariant gl_Position;
`+e),t.indexOf("#define MULTIVIEW")!==-1)return`#extension GL_OVR_multiview2 : require
layout (num_views = 2) in;
`+e;return e}}});var yn,Qp=S(()=>{kp();yn=class extends ga{constructor(e){super(),this._buffer=e}get underlyingResource(){return this._buffer}}});var Uc,nR=S(()=>{Uc=class{get underlyingResource(){return this._webGLTexture}constructor(e=null,t){if(this._MSAARenderBuffers=null,this._context=t,!e&&(e=t.createTexture(),!e))throw new Error("Unable to create webGL texture");this.set(e)}setUsage(){}set(e){this._webGLTexture=e}reset(){this._webGLTexture=null,this._MSAARenderBuffers=null}addMSAARenderBuffer(e){this._MSAARenderBuffers||(this._MSAARenderBuffers=[]),this._MSAARenderBuffers.push(e)}releaseMSAARenderBuffers(){if(this._MSAARenderBuffers){for(let e of this._MSAARenderBuffers)this._context.deleteRenderbuffer(e);this._MSAARenderBuffers=null}}getMSAARenderBuffer(e=0){return this._MSAARenderBuffers?.[e]??null}release(){this.releaseMSAARenderBuffers(),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()}}});function Fh(s){return s===13||s===14||s===15||s===16||s===17||s===18||s===19}function jp(s){switch(s){case 13:case 17:case 18:case 14:case 16:return 1;case 15:return 5;case 19:return 0}return 0}function ss(s){return s===13||s===17||s===18||s===19}var Tl=S(()=>{});var MO={};V(MO,{ThinEngine:()=>Ne});var aR,Ne,kr=S(()=>{WA();Yp();Ee();Cs();IO();yO();Qp();Ao();Jt();nR();vi();dl();fa();Lp();Tl();wp();aR=class{},Ne=class s extends k{get name(){return this._name}set name(e){this._name=e}get version(){return this._webGLVersion}static get ShadersRepository(){return li.ShadersRepository}static set ShadersRepository(e){li.ShadersRepository=e}get supportsUniformBuffers(){return this.webGLVersion>1&&!this.disableUniformBuffers}get needPOTTextures(){return this._webGLVersion<2||this.forcePOTTextures}get _supportsHardwareTextureRescaling(){return!1}set framebufferDimensionsObject(e){this._framebufferDimensionsObject=e}snapshotRenderingReset(){this.snapshotRendering=!1}constructor(e,t,i,r){if(i=i||{},super(t??i.antialias,i,r),this._name="WebGL",this.forcePOTTextures=!1,this.validateShaderPrograms=!1,this.disableUniformBuffers=!1,this._webGLVersion=1,this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._maxMSAASamplesOverride=null,this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._boundUniforms={},!e)return;let n=null;if(e.getContext){if(n=e,i.preserveDrawingBuffer===void 0&&(i.preserveDrawingBuffer=!1),i.xrCompatible===void 0&&(i.xrCompatible=!1),navigator&&navigator.userAgent){this._setupMobileChecks();let l=navigator.userAgent;for(let c of s.ExceptionList){let f=c.key,h=c.targets;if(new RegExp(f).test(l)){if(c.capture&&c.captureConstraint){let d=c.capture,p=c.captureConstraint,_=new RegExp(d).exec(l);if(_&&_.length>0&&parseInt(_[_.length-1])>=p)continue}for(let d of h)switch(d){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0;break;case"antialias":i.antialias=!1;break;case"maxMSAASamples":this._maxMSAASamplesOverride=1;break}}}}if(this._doNotHandleContextLost?this._onContextLost=()=>{Pp(this._gl)}:(this._onContextLost=l=>{l.preventDefault(),this._contextWasLost=!0,Pp(this._gl),P.Warn("WebGL context lost."),this.onContextLostObservable.notifyObservers(this)},this._onContextRestored=()=>{this._restoreEngineAfterContextLost(()=>this._initGLContext())},n.addEventListener("webglcontextrestored",this._onContextRestored,!1),i.powerPreference=i.powerPreference||"high-performance"),n.addEventListener("webglcontextlost",this._onContextLost,!1),this._badDesktopOS&&(i.xrCompatible=!1),!i.disableWebGL2Support)try{this._gl=n.getContext("webgl2",i)||n.getContext("experimental-webgl2",i),this._gl&&(this._webGLVersion=2,this._shaderPlatformName="WEBGL2",this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName="WEBGL1"))}catch{}if(!this._gl){if(!n)throw new Error("The provided canvas is null or undefined.");try{this._gl=n.getContext("webgl",i)||n.getContext("experimental-webgl",i)}catch{throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else{this._gl=e,n=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName="WEBGL2"):this._shaderPlatformName="WEBGL1";let l=this._gl.getContextAttributes();l&&(i.stencil=l.stencil)}this._sharedInit(n),this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),i.useHighPrecisionFloats!==void 0&&(this._highPrecisionShadersAllowed=i.useHighPrecisionFloats),this.resize(),this._initGLContext(),this._initFeatures();for(let l=0;l<this._caps.maxVertexAttribs;l++)this._currentBufferPointers[l]=new aR;this._shaderProcessor=this.webGLVersion>1?new qp:new Kp;let a=`Babylon.js v${s.Version}`;P.Log(a+` - ${this.description}`),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute("data-engine",a);let o=ir(this._gl);o.validateShaderPrograms=this.validateShaderPrograms,o.parallelShaderCompile=this._caps.parallelShaderCompile}_clearEmptyResources(){this._dummyFramebuffer=null,super._clearEmptyResources()}_getShaderProcessingContext(e){return null}areAllEffectsReady(){for(let e in this._compiledEffects)if(!this._compiledEffects[e].isReady())return!1;return!0}_initGLContext(){this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),shaderFloatPrecision:0,parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:this._webGLVersion>1||this._gl.getExtension("OES_standard_derivatives")!==null,maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this._gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this._webGLVersion>1||this._gl.getExtension("OES_element_index_uint")!==null,fragmentDepthSupported:this._webGLVersion>1||this._gl.getExtension("EXT_frag_depth")!==null,highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:this._webGLVersion>1,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float")),blendFloat:this._gl.getExtension("EXT_float_blend")!==null,supportFloatTexturesResolve:!1,rg11b10ufColorRenderable:!1,colorBufferHalfFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_half_float")),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),texelFetch:this._webGLVersion!==1,blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1,canUseGLInstanceID:this._webGLVersion>1,canUseGLVertexID:this._webGLVersion>1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:this._webGLVersion>1,textureMaxLevel:this._webGLVersion>1,texture2DArrayMaxLayerCount:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_ARRAY_TEXTURE_LAYERS):128,disableMorphTargetTexture:!1,textureNorm16:!!this._gl.getExtension("EXT_texture_norm16"),blendParametersPerTarget:!1,dualSourceBlending:!1},this._caps.supportFloatTexturesResolve=this._caps.colorBufferFloat,this._caps.rg11b10ufColorRenderable=this._caps.colorBufferFloat,this._glVersion=this._gl.getParameter(this._gl.VERSION);let e=this._gl.getExtension("WEBGL_debug_renderer_info");e!=null&&(this._glRenderer=this._gl.getParameter(e.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(e.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor=this._gl.getParameter(this._gl.VENDOR)||"Unknown vendor"),this._glRenderer||(this._glRenderer=this._gl.getParameter(this._gl.RENDERER)||"Unknown renderer"),this._gl.HALF_FLOAT_OES!==36193&&(this._gl.HALF_FLOAT_OES=36193),this._gl.RGBA16F!==34842&&(this._gl.RGBA16F=34842),this._gl.RGBA32F!==34836&&(this._gl.RGBA32F=34836),this._gl.DEPTH24_STENCIL8!==35056&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(this._webGLVersion===1&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=(this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT)??0)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!!(this._caps.textureFloat&&this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!!(this._caps.textureFloat&&this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._caps.textureNorm16&&(this._gl.R16_EXT=33322,this._gl.RG16_EXT=33324,this._gl.RGB16_EXT=32852,this._gl.RGBA16_EXT=32859,this._gl.R16_SNORM_EXT=36760,this._gl.RG16_SNORM_EXT=36761,this._gl.RGB16_SNORM_EXT=36762,this._gl.RGBA16_SNORM_EXT=36763);let t=this._gl.getExtension("OES_draw_buffers_indexed");if(this._caps.blendParametersPerTarget=!!t,this._alphaState=new go(this._caps.blendParametersPerTarget),t&&(this._gl.blendEquationSeparateIndexed=t.blendEquationSeparateiOES.bind(t),this._gl.blendEquationIndexed=t.blendEquationiOES.bind(t),this._gl.blendFuncSeparateIndexed=t.blendFuncSeparateiOES.bind(t),this._gl.blendFuncIndexed=t.blendFunciOES.bind(t),this._gl.colorMaskIndexed=t.colorMaskiOES.bind(t),this._gl.disableIndexed=t.disableiOES.bind(t),this._gl.enableIndexed=t.enableiOES.bind(t)),this._caps.dualSourceBlending=!!this._gl.getExtension("WEBGL_blend_func_extended"),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),this._webGLVersion>1&&this._gl.HALF_FLOAT_OES!==5131&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=this._maxMSAASamplesOverride!==null?this._maxMSAASamplesOverride:this._gl.getParameter(this._gl.MAX_SAMPLES),this._caps.maxDrawBuffers=this._gl.getParameter(this._gl.MAX_DRAW_BUFFERS);else{let i=this._gl.getExtension("WEBGL_draw_buffers");if(i!==null){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=i.drawBuffersWEBGL.bind(i),this._caps.maxDrawBuffers=this._gl.getParameter(i.MAX_DRAW_BUFFERS_WEBGL),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(let r=0;r<16;r++)this._gl["COLOR_ATTACHMENT"+r+"_WEBGL"]=i["COLOR_ATTACHMENT"+r+"_WEBGL"]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{let i=this._gl.getExtension("WEBGL_depth_texture");i!=null&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=i.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{let i=this._gl.getExtension("OES_vertex_array_object");i!=null&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=i.createVertexArrayOES.bind(i),this._gl.bindVertexArray=i.bindVertexArrayOES.bind(i),this._gl.deleteVertexArray=i.deleteVertexArrayOES.bind(i))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{let i=this._gl.getExtension("ANGLE_instanced_arrays");i!=null?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=i.drawArraysInstancedANGLE.bind(i),this._gl.drawElementsInstanced=i.drawElementsInstancedANGLE.bind(i),this._gl.vertexAttribDivisor=i.vertexAttribDivisorANGLE.bind(i)):this._caps.instancedArrays=!1}if(this._gl.getShaderPrecisionFormat){let i=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),r=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);if(i&&r&&(this._caps.highPrecisionShaderSupported=i.precision!==0&&r.precision!==0,this._caps.shaderFloatPrecision=Math.min(i.precision,r.precision)),!this._shouldUseHighPrecisionShader){let n=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.MEDIUM_FLOAT),a=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.MEDIUM_FLOAT);n&&a&&(this._caps.shaderFloatPrecision=Math.min(n.precision,a.precision))}this._caps.shaderFloatPrecision<10&&(this._caps.shaderFloatPrecision=10)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{let i=this._gl.getExtension("EXT_blend_minmax");i!=null&&(this._caps.blendMinMax=!0,this._gl.MAX=i.MAX_EXT,this._gl.MIN=i.MIN_EXT)}if(!this._caps.supportSRGBBuffers){if(this._webGLVersion>1)this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:WebGL2RenderingContext.SRGB,SRGB8:WebGL2RenderingContext.SRGB8,SRGB8_ALPHA8:WebGL2RenderingContext.SRGB8_ALPHA8};else{let i=this._gl.getExtension("EXT_sRGB");i!=null&&(this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:i.SRGB_EXT,SRGB8:i.SRGB_ALPHA_EXT,SRGB8_ALPHA8:i.SRGB_ALPHA_EXT})}if(this._creationOptions){let i=this._creationOptions.forceSRGBBufferSupportState;i!==void 0&&(this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&i)}}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(let i=0;i<this._maxSimultaneousTextures;i++)this._nextFreeTextureSlots.push(i);this._glRenderer==="Mali-G72"&&(this._caps.disableMorphTargetTexture=!0)}_initFeatures(){this._features={forceBitmapOverHTMLImageElement:typeof HTMLImageElement>"u",supportRenderAndCopyToLodForFloatTextures:this._webGLVersion!==1,supportDepthStencilTexture:this._webGLVersion!==1,supportShadowSamplers:this._webGLVersion!==1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:this._webGLVersion!==1,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:this._webGLVersion!==1,basisNeedsPOT:this._webGLVersion===1,support3DTextures:this._webGLVersion!==1,needTypeSuffixInShaderConstants:this._webGLVersion!==1,supportMSAA:this._webGLVersion!==1,supportSSAO2:this._webGLVersion!==1,supportIBLShadows:this._webGLVersion!==1,supportExtendedTextureFormats:this._webGLVersion!==1,supportSwitchCaseInShader:this._webGLVersion!==1,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,supportSpriteInstancing:!0,forceVertexBufferStrideAndOffsetMultiple4Bytes:!1,_checkNonFloatVertexBuffersDontRecreatePipelineContext:!1,_collectUbosUpdatedInFrame:!1}}get webGLVersion(){return this._webGLVersion}getClassName(){return"ThinEngine"}_prepareWorkingCanvas(){if(this._workingCanvas)return;this._workingCanvas=this.createCanvas(1,1);let e=this._workingCanvas.getContext("2d");e&&(this._workingContext=e)}getInfo(){return this.getGlInfo()}getGlInfo(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}}extractDriverInfo(){let e=this.getGlInfo();return e&&e.renderer?e.renderer:""}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight}clear(e,t,i,r=!1,n=0){let a=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=a;let o=0;if(t&&e){let l=!0;if(this._currentRenderTarget){let c=this._currentRenderTarget.texture?.format;if(c===8||c===9||c===10||c===11){let f=this._currentRenderTarget.texture?.type;f===7||f===5?(s._TempClearColorUint32[0]=e.r*255,s._TempClearColorUint32[1]=e.g*255,s._TempClearColorUint32[2]=e.b*255,s._TempClearColorUint32[3]=e.a*255,this._gl.clearBufferuiv(this._gl.COLOR,0,s._TempClearColorUint32),l=!1):(s._TempClearColorInt32[0]=e.r*255,s._TempClearColorInt32[1]=e.g*255,s._TempClearColorInt32[2]=e.b*255,s._TempClearColorInt32[3]=e.a*255,this._gl.clearBufferiv(this._gl.COLOR,0,s._TempClearColorInt32),l=!1)}}l&&(this._gl.clearColor(e.r,e.g,e.b,e.a!==void 0?e.a:1),o|=this._gl.COLOR_BUFFER_BIT)}i&&(this.useReverseDepthBuffer?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),o|=this._gl.DEPTH_BUFFER_BIT),r&&(this._gl.clearStencil(n),o|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(o)}_viewport(e,t,i,r){(e!==this._viewportCached.x||t!==this._viewportCached.y||i!==this._viewportCached.z||r!==this._viewportCached.w)&&(this._viewportCached.x=e,this._viewportCached.y=t,this._viewportCached.z=i,this._viewportCached.w=r,this._gl.viewport(e,t,i,r))}endFrame(){super.endFrame(),this._badOS&&this.flushFramebuffer()}get performanceMonitor(){throw new Error("Not Supported by ThinEngine")}bindFramebuffer(e,t=0,i,r,n,a=0,o=0){let l=e;this._currentRenderTarget&&this._resolveAndGenerateMipMapsFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,this._bindUnboundFramebuffer(l._framebuffer);let c=this._gl;e.isMulti||(e.is2DArray||e.is3D?(c.framebufferTextureLayer(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,e.texture._hardwareTexture?.underlyingResource,a,o),l._currentLOD=a):e.isCube?c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_CUBE_MAP_POSITIVE_X+t,e.texture._hardwareTexture?.underlyingResource,a):l._currentLOD!==a&&(c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,e.texture._hardwareTexture?.underlyingResource,a),l._currentLOD=a));let f=e._depthStencilTexture;if(f){e.is3D&&(e.texture.width!==f.width||e.texture.height!==f.height||e.texture.depth!==f.depth)&&P.Warn("Depth/Stencil attachment for 3D target must have same dimensions as color attachment");let h=e._depthStencilTextureWithStencil?c.DEPTH_STENCIL_ATTACHMENT:c.DEPTH_ATTACHMENT;e.is2DArray||e.is3D?c.framebufferTextureLayer(c.FRAMEBUFFER,h,f._hardwareTexture?.underlyingResource,a,o):e.isCube?c.framebufferTexture2D(c.FRAMEBUFFER,h,c.TEXTURE_CUBE_MAP_POSITIVE_X+t,f._hardwareTexture?.underlyingResource,a):c.framebufferTexture2D(c.FRAMEBUFFER,h,c.TEXTURE_2D,f._hardwareTexture?.underlyingResource,a)}l._MSAAFramebuffer&&this._bindUnboundFramebuffer(l._MSAAFramebuffer),this._cachedViewport&&!n?this.setViewport(this._cachedViewport,i,r):(i||(i=e.width,a&&(i=i/Math.pow(2,a))),r||(r=e.height,a&&(r=r/Math.pow(2,a))),this._viewport(0,0,i,r)),this.wipeCaches()}setStateCullFaceType(e,t){let i=this.cullBackFaces??e??!0?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==i||t)&&(this._depthCullingState.cullFace=i)}setState(e,t=0,i,r=!1,n,a,o=0){(this._depthCullingState.cull!==e||i)&&(this._depthCullingState.cull=e),this.setStateCullFaceType(n,i),this.setZOffset(t),this.setZOffsetUnits(o);let l=r?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==l||i)&&(this._depthCullingState.frontFace=l),this._stencilStateComposer.stencilMaterial=a}_resolveAndGenerateMipMapsFramebuffer(e,t=!1){e.disableAutomaticMSAAResolve||(e.isMulti?this.resolveMultiFramebuffer(e):this.resolveFramebuffer(e)),t||(e.isMulti?this.generateMipMapsMultiFramebuffer(e):this.generateMipMapsFramebuffer(e))}_bindUnboundFramebuffer(e){this._currentFramebuffer!==e&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,e),this._currentFramebuffer=e)}_currentFrameBufferIsDefaultFrameBuffer(){return this._currentFramebuffer===null}generateMipmaps(e){let t=this._getTextureTarget(e);this._bindTextureDirectly(t,e,!0),this._gl.generateMipmap(t),this._bindTextureDirectly(t,null)}unBindFramebuffer(e,t,i){let r=e;this._currentRenderTarget=null,this._resolveAndGenerateMipMapsFramebuffer(e,t),i&&(r._MSAAFramebuffer&&this._bindUnboundFramebuffer(r._framebuffer),i()),this._bindUnboundFramebuffer(null)}generateMipMapsFramebuffer(e){!e.isMulti&&e.texture?.generateMipMaps&&!e.isCube&&this.generateMipmaps(e.texture)}resolveFramebuffer(e){let t=e,i=this._gl;if(!t._MSAAFramebuffer||t.isMulti)return;let r=t.resolveMSAAColors?i.COLOR_BUFFER_BIT:0;r|=t._generateDepthBuffer&&t.resolveMSAADepth?i.DEPTH_BUFFER_BIT:0,r|=t._generateStencilBuffer&&t.resolveMSAAStencil?i.STENCIL_BUFFER_BIT:0,i.bindFramebuffer(i.READ_FRAMEBUFFER,t._MSAAFramebuffer),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,t._framebuffer),i.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,r,i.NEAREST)}flushFramebuffer(){this._gl.flush()}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_resetVertexBufferBinding(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null}createVertexBuffer(e,t,i){return this._createVertexBuffer(e,this._gl.STATIC_DRAW)}_createVertexBuffer(e,t){let i=this._gl.createBuffer();if(!i)throw new Error("Unable to create vertex buffer");let r=new yn(i);return this.bindArrayBuffer(r),typeof e!="number"?e instanceof Array?(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(e),t),r.capacity=e.length*4):(this._gl.bufferData(this._gl.ARRAY_BUFFER,e,t),r.capacity=e.byteLength):(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Uint8Array(e),t),r.capacity=e),this._resetVertexBufferBinding(),r.references=1,r}createDynamicVertexBuffer(e,t){return this._createVertexBuffer(e,this._gl.DYNAMIC_DRAW)}_resetIndexBufferBinding(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null}createIndexBuffer(e,t,i){let r=this._gl.createBuffer(),n=new yn(r);if(!r)throw new Error("Unable to create index buffer");this.bindIndexBuffer(n);let a=this._normalizeIndexData(e);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,a,t?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),n.references=1,n.is32Bits=a.BYTES_PER_ELEMENT===4,n}_normalizeIndexData(e){if(e.BYTES_PER_ELEMENT===2)return e;if(this._caps.uintIndices){if(e instanceof Uint32Array)return e;for(let i=0;i<e.length;i++)if(e[i]>=65535)return new Uint32Array(e);return new Uint16Array(e)}return new Uint16Array(e)}bindArrayBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ARRAY_BUFFER)}bindUniformBlock(e,t,i){let r=e.program,n=this._gl.getUniformBlockIndex(r,t);this._gl.uniformBlockBinding(r,n,i)}bindIndexBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ELEMENT_ARRAY_BUFFER)}_bindBuffer(e,t){(this._vaoRecordInProgress||this._currentBoundBuffer[t]!==e)&&(this._gl.bindBuffer(t,e?e.underlyingResource:null),this._currentBoundBuffer[t]=e)}updateArrayBuffer(e){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)}_vertexAttribPointer(e,t,i,r,n,a,o){let l=this._currentBufferPointers[t];if(!l)return;let c=!1;l.active?(l.buffer!==e&&(l.buffer=e,c=!0),l.size!==i&&(l.size=i,c=!0),l.type!==r&&(l.type=r,c=!0),l.normalized!==n&&(l.normalized=n,c=!0),l.stride!==a&&(l.stride=a,c=!0),l.offset!==o&&(l.offset=o,c=!0)):(c=!0,l.active=!0,l.index=t,l.size=i,l.type=r,l.normalized=n,l.stride=a,l.offset=o,l.buffer=e),(c||this._vaoRecordInProgress)&&(this.bindArrayBuffer(e),r===this._gl.UNSIGNED_INT||r===this._gl.INT?this._gl.vertexAttribIPointer(t,i,r,a,o):this._gl.vertexAttribPointer(t,i,r,n,a,o))}_bindIndexBufferWithCache(e){e!=null&&this._cachedIndexBuffer!==e&&(this._cachedIndexBuffer=e,this.bindIndexBuffer(e),this._uintIndicesCurrentlySet=e.is32Bits)}_bindVertexBuffersAttributes(e,t,i){let r=t.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(let n=0;n<r.length;n++){let a=t.getAttributeLocation(n);if(a>=0){let o=r[n],l=null;if(i&&(l=i[o]),l||(l=e[o]),!l)continue;this._gl.enableVertexAttribArray(a),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[a]=!0);let c=l.getBuffer();c&&(this._vertexAttribPointer(c,a,l.getSize(),l.type,l.normalized,l.byteStride,l.byteOffset),l.getIsInstanced()&&(this._gl.vertexAttribDivisor(a,l.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(a),this._currentInstanceBuffers.push(c))))}}}recordVertexArrayObject(e,t,i,r){let n=this._gl.createVertexArray();if(!n)throw new Error("Unable to create VAO");return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(n),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(e,i,r),this.bindIndexBuffer(t),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),n}bindVertexArrayObject(e,t){this._cachedVertexArrayObject!==e&&(this._cachedVertexArrayObject=e,this._gl.bindVertexArray(e),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=t!=null&&t.is32Bits,this._mustWipeVertexAttributes=!0)}bindBuffersDirectly(e,t,i,r,n){if(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==n){this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=n;let a=n.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();let o=0;for(let l=0;l<a;l++)if(l<i.length){let c=n.getAttributeLocation(l);c>=0&&(this._gl.enableVertexAttribArray(c),this._vertexAttribArraysEnabled[c]=!0,this._vertexAttribPointer(e,c,i[l],this._gl.FLOAT,!1,r,o)),o+=i[l]*4}}this._bindIndexBufferWithCache(t)}_unbindVertexArrayObject(){this._cachedVertexArrayObject&&(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))}bindBuffers(e,t,i,r){(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==i)&&(this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=i,this._bindVertexBuffersAttributes(e,i,r)),this._bindIndexBufferWithCache(t)}unbindInstanceAttributes(){let e;for(let t=0,i=this._currentInstanceLocations.length;t<i;t++){let r=this._currentInstanceBuffers[t];e!=r&&r.references&&(e=r,this.bindArrayBuffer(r));let n=this._currentInstanceLocations[t];this._gl.vertexAttribDivisor(n,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0}releaseVertexArrayObject(e){this._gl.deleteVertexArray(e)}_releaseBuffer(e){return e.references--,e.references===0?(this._deleteBuffer(e),!0):!1}_deleteBuffer(e){this._gl.deleteBuffer(e.underlyingResource)}updateAndBindInstancesBuffer(e,t,i){if(this.bindArrayBuffer(e),t&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t),i[0].index!==void 0)this.bindInstancesBuffer(e,i,!0);else for(let r=0;r<4;r++){let n=i[r];this._vertexAttribArraysEnabled[n]||(this._gl.enableVertexAttribArray(n),this._vertexAttribArraysEnabled[n]=!0),this._vertexAttribPointer(e,n,4,this._gl.FLOAT,!1,64,r*16),this._gl.vertexAttribDivisor(n,1),this._currentInstanceLocations.push(n),this._currentInstanceBuffers.push(e)}}bindInstancesBuffer(e,t,i=!0){this.bindArrayBuffer(e);let r=0;if(i)for(let n=0;n<t.length;n++){let a=t[n];r+=a.attributeSize*4}for(let n=0;n<t.length;n++){let a=t[n];a.index===void 0&&(a.index=this._currentEffect.getAttributeLocationByName(a.attributeName)),!(a.index<0)&&(this._vertexAttribArraysEnabled[a.index]||(this._gl.enableVertexAttribArray(a.index),this._vertexAttribArraysEnabled[a.index]=!0),this._vertexAttribPointer(e,a.index,a.attributeSize,a.attributeType||this._gl.FLOAT,a.normalized||!1,r,a.offset),this._gl.vertexAttribDivisor(a.index,a.divisor===void 0?1:a.divisor),this._currentInstanceLocations.push(a.index),this._currentInstanceBuffers.push(e))}}disableInstanceAttributeByName(e){if(!this._currentEffect)return;let t=this._currentEffect.getAttributeLocationByName(e);this.disableInstanceAttribute(t)}disableInstanceAttribute(e){let t=!1,i;for(;(i=this._currentInstanceLocations.indexOf(e))!==-1;)this._currentInstanceLocations.splice(i,1),this._currentInstanceBuffers.splice(i,1),t=!0,i=this._currentInstanceLocations.indexOf(e);t&&(this._gl.vertexAttribDivisor(e,0),this.disableAttributeByIndex(e))}disableAttributeByIndex(e){this._gl.disableVertexAttribArray(e),this._vertexAttribArraysEnabled[e]=!1,this._currentBufferPointers[e].active=!1}draw(e,t,i,r){this.drawElementsType(e?0:1,t,i,r)}drawPointClouds(e,t,i){this.drawArraysType(2,e,t,i)}drawUnIndexed(e,t,i,r){this.drawArraysType(e?0:1,t,i,r)}drawElementsType(e,t,i,r){this.applyStates(),this._reportDrawCall();let n=this._drawMode(e),a=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,o=this._uintIndicesCurrentlySet?4:2;r?this._gl.drawElementsInstanced(n,i,a,t*o,r):this._gl.drawElements(n,i,a,t*o)}drawArraysType(e,t,i,r){this.applyStates(),this._reportDrawCall();let n=this._drawMode(e);r?this._gl.drawArraysInstanced(n,t,i,r):this._gl.drawArrays(n,t,i)}_drawMode(e){switch(e){case 0:return this._gl.TRIANGLES;case 2:return this._gl.POINTS;case 1:return this._gl.LINES;case 3:return this._gl.POINTS;case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN;default:return this._gl.TRIANGLES}}_releaseEffect(e){this._compiledEffects[e._key]&&delete this._compiledEffects[e._key];let t=e.getPipelineContext();t&&this._deletePipelineContext(t)}_deletePipelineContext(e){let t=e;t&&t.program&&(t.program.__SPECTOR_rebuildProgram=null,Dc(t),this._gl&&(this._currentProgram===t.program&&this._setProgram(null),this._gl.deleteProgram(t.program)))}_getGlobalDefines(e){return Ap(e,this.isNDCHalfZRange,this.useReverseDepthBuffer,this.useExactSrgbConversions)}createEffect(e,t,i,r,n,a,o,l,c,f=0,h){let u=typeof e=="string"?e:e.vertexToken||e.vertexSource||e.vertexElement||e.vertex,d=typeof e=="string"?e:e.fragmentToken||e.fragmentSource||e.fragmentElement||e.fragment,p=this._getGlobalDefines(),m=t.attributes!==void 0,_=n??t.defines??"";p&&(_+=p);let v=u+"+"+d+"@"+_;if(this._compiledEffects[v]){let C=this._compiledEffects[v];return o&&C.isReady()&&o(C),C._refCount++,C}this._gl&&ir(this._gl);let T=new li(e,t,m?this:i,r,this,n,a,o,l,c,v,t.shaderLanguage??f,t.extraInitializationsAsync??h);return this._compiledEffects[v]=T,T}_getShaderSource(e){return this._gl.getShaderSource(e)}createRawShaderProgram(e,t,i,r,n=null){let a=ir(this._gl);return a._contextWasLost=this._contextWasLost,a.validateShaderPrograms=this.validateShaderPrograms,VA(e,t,i,r||this._gl,n)}createShaderProgram(e,t,i,r,n,a=null){let o=ir(this._gl);return o._contextWasLost=this._contextWasLost,o.validateShaderPrograms=this.validateShaderPrograms,kA(e,t,i,r,n||this._gl,a)}inlineShaderCode(e){return e}createPipelineContext(e){if(this._gl){let i=ir(this._gl);i.parallelShaderCompile=this._caps.parallelShaderCompile}let t=jD(this._gl,e);return t.engine=this,t}createMaterialContext(){}createDrawContext(){}_finalizePipelineContext(e){return Op(e,this._gl,this.validateShaderPrograms)}_preparePipelineContextAsync(e,t,i,r,n,a,o,l,c,f,h){let u=ir(this._gl);return u._contextWasLost=this._contextWasLost,u.validateShaderPrograms=this.validateShaderPrograms,u._createShaderProgramInjection=this._createShaderProgram.bind(this),u.createRawShaderProgramInjection=this.createRawShaderProgram.bind(this),u.createShaderProgramInjection=this.createShaderProgram.bind(this),u.loadFileInjection=this._loadFile.bind(this),JD(e,t,i,r,n,a,o,l,c,f,h)}_createShaderProgram(e,t,i,r,n=null){return Dp(e,t,i,r,n)}_isRenderingStateCompiled(e){return this._isDisposed?!1:ZD(e,this._gl,this.validateShaderPrograms)}_executeWhenRenderingStateIsCompiled(e,t){eO(e,t)}getUniforms(e,t){let i=new Array,r=e;for(let n=0;n<t.length;n++)i.push(this._gl.getUniformLocation(r.program,t[n]));return i}getAttributes(e,t){let i=[],r=e;for(let n=0;n<t.length;n++)try{i.push(this._gl.getAttribLocation(r.program,t[n]))}catch{i.push(-1)}return i}enableEffect(e){e=e!==null&&Bc(e)?e.effect:e,!(!e||e===this._currentEffect)&&(this._stencilStateComposer.stencilMaterial=void 0,this.bindSamplers(e),this._currentEffect=e,e.onBind&&e.onBind(e),e._onBindObservable&&e._onBindObservable.notifyObservers(e))}setInt(e,t){return e?(this._gl.uniform1i(e,t),!0):!1}setInt2(e,t,i){return e?(this._gl.uniform2i(e,t,i),!0):!1}setInt3(e,t,i,r){return e?(this._gl.uniform3i(e,t,i,r),!0):!1}setInt4(e,t,i,r,n){return e?(this._gl.uniform4i(e,t,i,r,n),!0):!1}setIntArray(e,t){return e?(this._gl.uniform1iv(e,t),!0):!1}setIntArray2(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2iv(e,t),!0)}setIntArray3(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3iv(e,t),!0)}setIntArray4(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4iv(e,t),!0)}setUInt(e,t){return e?(this._gl.uniform1ui(e,t),!0):!1}setUInt2(e,t,i){return e?(this._gl.uniform2ui(e,t,i),!0):!1}setUInt3(e,t,i,r){return e?(this._gl.uniform3ui(e,t,i,r),!0):!1}setUInt4(e,t,i,r,n){return e?(this._gl.uniform4ui(e,t,i,r,n),!0):!1}setUIntArray(e,t){return e?(this._gl.uniform1uiv(e,t),!0):!1}setUIntArray2(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2uiv(e,t),!0)}setUIntArray3(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3uiv(e,t),!0)}setUIntArray4(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4uiv(e,t),!0)}setArray(e,t){return!e||t.length<1?!1:(this._gl.uniform1fv(e,t),!0)}setArray2(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2fv(e,t),!0)}setArray3(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3fv(e,t),!0)}setArray4(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4fv(e,t),!0)}setMatrices(e,t){return e?(this._gl.uniformMatrix4fv(e,!1,t),!0):!1}setMatrix3x3(e,t){return e?(this._gl.uniformMatrix3fv(e,!1,t),!0):!1}setMatrix2x2(e,t){return e?(this._gl.uniformMatrix2fv(e,!1,t),!0):!1}setFloat(e,t){return e?(this._gl.uniform1f(e,t),!0):!1}setFloat2(e,t,i){return e?(this._gl.uniform2f(e,t,i),!0):!1}setFloat3(e,t,i,r){return e?(this._gl.uniform3f(e,t,i,r),!0):!1}setFloat4(e,t,i,r,n){return e?(this._gl.uniform4f(e,t,i,r,n),!0):!1}applyStates(){if(this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl,this._currentRenderTarget&&this._currentRenderTarget.textures?this._currentRenderTarget.textures.length:1),this._colorWriteChanged){this._colorWriteChanged=!1;let e=this._colorWrite;this._gl.colorMask(e,e,e,e)}}wipeCaches(e){this.preventCacheWipeBetweenFrames&&!e||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),e&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._resetAlphaMode(),this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))}_getSamplingParameters(e,t){let i=this._gl,r=i.NEAREST,n=i.NEAREST,a=!1;switch(e){case 11:r=i.LINEAR,t?n=i.LINEAR_MIPMAP_NEAREST:n=i.LINEAR;break;case 3:r=i.LINEAR,a=!0,t?n=i.LINEAR_MIPMAP_LINEAR:n=i.LINEAR;break;case 8:a=!0,r=i.NEAREST,t?n=i.NEAREST_MIPMAP_LINEAR:n=i.NEAREST;break;case 4:r=i.NEAREST,t?n=i.NEAREST_MIPMAP_NEAREST:n=i.NEAREST;break;case 5:r=i.NEAREST,t?n=i.LINEAR_MIPMAP_NEAREST:n=i.LINEAR;break;case 6:a=!0,r=i.NEAREST,t?n=i.LINEAR_MIPMAP_LINEAR:n=i.LINEAR;break;case 7:r=i.NEAREST,n=i.LINEAR;break;case 1:r=i.NEAREST,n=i.NEAREST;break;case 9:r=i.LINEAR,t?n=i.NEAREST_MIPMAP_NEAREST:n=i.NEAREST;break;case 10:a=!0,r=i.LINEAR,t?n=i.NEAREST_MIPMAP_LINEAR:n=i.NEAREST;break;case 2:r=i.LINEAR,n=i.LINEAR;break;case 12:r=i.LINEAR,n=i.NEAREST;break}return{min:n,mag:r,hasMipMaps:a}}_createTexture(){let e=this._gl.createTexture();if(!e)throw new Error("Unable to create texture");return e}_createHardwareTexture(){return new Uc(this._createTexture(),this._gl)}_createInternalTexture(e,t,i=!0,r=0){let n=!1,a=!1,o=0,l=3,c=5,f=!1,h=1,u,d=!1,p=0;t!==void 0&&typeof t=="object"?(n=!!t.generateMipMaps,a=!!t.createMipMaps,o=t.type===void 0?0:t.type,l=t.samplingMode===void 0?3:t.samplingMode,c=t.format===void 0?5:t.format,f=t.useSRGBBuffer===void 0?!1:t.useSRGBBuffer,h=t.samples??1,u=t.label,d=!!t.createMSAATexture,p=t.comparisonFunction||0):n=!!t,f&&(f=this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU)),(o===1&&!this._caps.textureFloatLinearFiltering||o===2&&!this._caps.textureHalfFloatLinearFiltering)&&(l=1),o===1&&!this._caps.textureFloat&&(o=0,P.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));let m=Fh(c),_=ss(c),v=this._gl,T=new Je(this,r),C=e.width||e,I=e.height||e,R=e.depth||0,b=e.layers||0,M=this._getSamplingParameters(l,(n||a)&&!m),F=b!==0?v.TEXTURE_2D_ARRAY:R!==0?v.TEXTURE_3D:v.TEXTURE_2D,U=m?this._getInternalFormatFromDepthTextureFormat(c,!0,_):this._getRGBABufferInternalSizedFormat(o,c,f),D=m?_?v.DEPTH_STENCIL:v.DEPTH_COMPONENT:this._getInternalFormat(c),$=m?this._getWebGLTextureTypeFromDepthTextureFormat(c):this._getWebGLTextureType(o);if(this._bindTextureDirectly(F,T),b!==0?(T.is2DArray=!0,v.texImage3D(F,0,U,C,I,b,0,D,$,null)):R!==0?(T.is3D=!0,v.texImage3D(F,0,U,C,I,R,0,D,$,null)):v.texImage2D(F,0,U,C,I,0,D,$,null),v.texParameteri(F,v.TEXTURE_MAG_FILTER,M.mag),v.texParameteri(F,v.TEXTURE_MIN_FILTER,M.min),v.texParameteri(F,v.TEXTURE_WRAP_S,v.CLAMP_TO_EDGE),v.texParameteri(F,v.TEXTURE_WRAP_T,v.CLAMP_TO_EDGE),m&&this.webGLVersion>1&&(p===0?(v.texParameteri(F,v.TEXTURE_COMPARE_FUNC,515),v.texParameteri(F,v.TEXTURE_COMPARE_MODE,v.NONE)):(v.texParameteri(F,v.TEXTURE_COMPARE_FUNC,p),v.texParameteri(F,v.TEXTURE_COMPARE_MODE,v.COMPARE_REF_TO_TEXTURE))),(n||a)&&this._gl.generateMipmap(F),this._bindTextureDirectly(F,null),T._useSRGBBuffer=f,T.baseWidth=C,T.baseHeight=I,T.width=C,T.height=I,T.depth=b||R,T.isReady=!0,T.samples=h,T.generateMipMaps=n,T.samplingMode=l,T.type=o,T.format=c,T.label=u,T.comparisonFunction=p,this._internalTexturesCache.push(T),d){let oe=null;if(Fh(T.format)?oe=this._setupFramebufferDepthAttachments(ss(T.format),T.format!==19,T.width,T.height,h,T.format,!0):oe=this._createRenderBuffer(T.width,T.height,h,-1,this._getRGBABufferInternalSizedFormat(T.type,T.format,T._useSRGBBuffer),-1),!oe)throw new Error("Unable to create render buffer");T._autoMSAAManagement=!0;let re=T._hardwareTexture;re||(re=T._hardwareTexture=this._createHardwareTexture()),re.addMSAARenderBuffer(oe)}return T}_getUseSRGBBuffer(e,t){return e&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||t)}createTexture(e,t,i,r,n=3,a=null,o=null,l=null,c=null,f=null,h=null,u,d,p,m){return this._createTextureBase(e,t,i,r,n,a,o,(..._)=>this._prepareWebGLTexture(..._,f),(_,v,T,C,I,R)=>{let b=this._gl,M=T.width===_&&T.height===v;I._creationFlags=p??0;let F=this._getTexImageParametersForCreateTexture(I.format,I._useSRGBBuffer);if(M)return b.texImage2D(b.TEXTURE_2D,0,F.internalFormat,F.format,F.type,T),!1;let U=this._caps.maxTextureSize;if(T.width>U||T.height>U||!this._supportsHardwareTextureRescaling)return this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext||(this._workingCanvas.width=_,this._workingCanvas.height=v,this._workingContext.drawImage(T,0,0,T.width,T.height,0,0,_,v),b.texImage2D(b.TEXTURE_2D,0,F.internalFormat,F.format,F.type,this._workingCanvas),I.width=_,I.height=v),!1;{let D=new Je(this,2);this._bindTextureDirectly(b.TEXTURE_2D,D,!0),b.texImage2D(b.TEXTURE_2D,0,F.internalFormat,F.format,F.type,T),this._rescaleTexture(D,I,r,F.format,()=>{this._releaseTexture(D),this._bindTextureDirectly(b.TEXTURE_2D,I,!0),R()})}return!0},l,c,f,h,u,d,m)}_getTexImageParametersForCreateTexture(e,t){let i,r;return this.webGLVersion===1?(i=this._getInternalFormat(e,t),r=i):(i=this._getInternalFormat(e,!1),r=this._getRGBABufferInternalSizedFormat(0,e,t)),{internalFormat:r,format:i,type:this._gl.UNSIGNED_BYTE}}_rescaleTexture(e,t,i,r,n){}_unpackFlipY(e){this._unpackFlipYCached!==e&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,e?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=e))}_getUnpackAlignement(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)}_getTextureTarget(e){return e.isCube?this._gl.TEXTURE_CUBE_MAP:e.is3D?this._gl.TEXTURE_3D:e.is2DArray||e.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D}updateTextureSamplingMode(e,t,i=!1){let r=this._getTextureTarget(t),n=this._getSamplingParameters(e,t.useMipMaps||i);this._setTextureParameterInteger(r,this._gl.TEXTURE_MAG_FILTER,n.mag,t),this._setTextureParameterInteger(r,this._gl.TEXTURE_MIN_FILTER,n.min),i&&n.hasMipMaps&&(t.generateMipMaps=!0,this._gl.generateMipmap(r)),this._bindTextureDirectly(r,null),t.samplingMode=e}updateTextureDimensions(e,t,i,r=1){}updateTextureWrappingMode(e,t,i=null,r=null){let n=this._getTextureTarget(e);t!==null&&(this._setTextureParameterInteger(n,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t),e),e._cachedWrapU=t),i!==null&&(this._setTextureParameterInteger(n,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(i),e),e._cachedWrapV=i),(e.is2DArray||e.is3D)&&r!==null&&(this._setTextureParameterInteger(n,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(r),e),e._cachedWrapR=r),this._bindTextureDirectly(n,null)}_uploadCompressedDataToTextureDirectly(e,t,i,r,n,a=0,o=0){let l=this._gl,c=l.TEXTURE_2D;if(e.isCube&&(c=l.TEXTURE_CUBE_MAP_POSITIVE_X+a),e._useSRGBBuffer)switch(t){case 37492:case 36196:this._caps.etc2?t=l.COMPRESSED_SRGB8_ETC2:e._useSRGBBuffer=!1;break;case 37496:this._caps.etc2?t=l.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:e._useSRGBBuffer=!1;break;case 36492:t=l.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:t=l.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?t=l.COMPRESSED_SRGB_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33777:this._caps.s3tc_srgb?t=l.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?t=l.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:e._useSRGBBuffer=!1;break;default:e._useSRGBBuffer=!1;break}if(e.generateMipMaps){let f=e._hardwareTexture;f.memoryAllocated||(l.texStorage2D(l.TEXTURE_2D,Math.floor(Math.log2(Math.max(i,r)))+1,t,e.width,e.height),f.memoryAllocated=!0),this._gl.compressedTexSubImage2D(c,o,0,0,i,r,t,n)}else this._gl.compressedTexImage2D(c,o,t,i,r,0,n)}_uploadDataToTextureDirectly(e,t,i=0,r=0,n,a=!1){let o=this._gl,l=this._getWebGLTextureType(e.type),c=this._getInternalFormat(e.format),f=n===void 0?this._getRGBABufferInternalSizedFormat(e.type,e.format,e._useSRGBBuffer):this._getInternalFormat(n,e._useSRGBBuffer);this._unpackFlipY(e.invertY);let h=o.TEXTURE_2D;e.isCube&&(h=o.TEXTURE_CUBE_MAP_POSITIVE_X+i);let u=Math.round(Math.log(e.width)*Math.LOG2E),d=Math.round(Math.log(e.height)*Math.LOG2E),p=a?e.width:Math.pow(2,Math.max(u-r,0)),m=a?e.height:Math.pow(2,Math.max(d-r,0));o.texImage2D(h,r,f,p,m,0,c,l,t)}updateTextureData(e,t,i,r,n,a,o=0,l=0,c=!1){let f=this._gl,h=this._getWebGLTextureType(e.type),u=this._getInternalFormat(e.format);this._unpackFlipY(e.invertY);let d=f.TEXTURE_2D,p=f.TEXTURE_2D;e.isCube&&(p=f.TEXTURE_CUBE_MAP_POSITIVE_X+o,d=f.TEXTURE_CUBE_MAP),this._bindTextureDirectly(d,e,!0),f.texSubImage2D(p,l,i,r,n,a,u,h,t),c&&this._gl.generateMipmap(p),this._bindTextureDirectly(d,null)}_uploadArrayBufferViewToTexture(e,t,i=0,r=0){let n=this._gl,a=e.isCube?n.TEXTURE_CUBE_MAP:n.TEXTURE_2D;this._bindTextureDirectly(a,e,!0),this._uploadDataToTextureDirectly(e,t,i,r),this._bindTextureDirectly(a,null,!0)}_prepareWebGLTextureContinuation(e,t,i,r,n){let a=this._gl;if(!a)return;let o=this._getSamplingParameters(n,!i);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,o.mag),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,o.min),!i&&!r&&a.generateMipmap(a.TEXTURE_2D),this._bindTextureDirectly(a.TEXTURE_2D,null),t&&t.removePendingData(e),e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear()}_prepareWebGLTexture(e,t,i,r,n,a,o,l,c,f){let h=this.getCaps().maxTextureSize,u=Math.min(h,this.needPOTTextures?xo(r.width,h):r.width),d=Math.min(h,this.needPOTTextures?xo(r.height,h):r.height),p=this._gl;if(p){if(!e._hardwareTexture){i&&i.removePendingData(e);return}this._bindTextureDirectly(p.TEXTURE_2D,e,!0),this._unpackFlipY(n===void 0?!0:!!n),e.baseWidth=r.width,e.baseHeight=r.height,e.width=u,e.height=d,e.isReady=!0,e.type=e.type!==-1?e.type:0,e.format=e.format!==-1?e.format:f??(t===".jpg"&&!e._useSRGBBuffer?4:5),!l(u,d,r,t,e,()=>{this._prepareWebGLTextureContinuation(e,i,a,o,c)})&&this._prepareWebGLTextureContinuation(e,i,a,o,c)}}_getInternalFormatFromDepthTextureFormat(e,t,i){let r=this._gl;if(!t)return r.STENCIL_INDEX8;let a=i?r.DEPTH_STENCIL:r.DEPTH_COMPONENT;return this.webGLVersion>1?e===15?a=r.DEPTH_COMPONENT16:e===16?a=r.DEPTH_COMPONENT24:e===17||e===13?a=i?r.DEPTH24_STENCIL8:r.DEPTH_COMPONENT24:e===14?a=r.DEPTH_COMPONENT32F:e===18&&(a=i?r.DEPTH32F_STENCIL8:r.DEPTH_COMPONENT32F):a=r.DEPTH_COMPONENT16,a}_getWebGLTextureTypeFromDepthTextureFormat(e){let t=this._gl,i=t.UNSIGNED_INT;return e===15?i=t.UNSIGNED_SHORT:e===17||e===13?i=t.UNSIGNED_INT_24_8:e===14?i=t.FLOAT:e===18?i=t.FLOAT_32_UNSIGNED_INT_24_8_REV:e===19&&(i=t.UNSIGNED_BYTE),i}_setupFramebufferDepthAttachments(e,t,i,r,n=1,a,o=!1){let l=this._gl;a=a??(e?13:14);let c=this._getInternalFormatFromDepthTextureFormat(a,t,e);return e&&t?this._createRenderBuffer(i,r,n,l.DEPTH_STENCIL,c,o?-1:l.DEPTH_STENCIL_ATTACHMENT):t?this._createRenderBuffer(i,r,n,c,c,o?-1:l.DEPTH_ATTACHMENT):e?this._createRenderBuffer(i,r,n,c,c,o?-1:l.STENCIL_ATTACHMENT):null}_createRenderBuffer(e,t,i,r,n,a,o=!0){let c=this._gl.createRenderbuffer();return this._updateRenderBuffer(c,e,t,i,r,n,a,o)}_updateRenderBuffer(e,t,i,r,n,a,o,l=!0){let c=this._gl;return c.bindRenderbuffer(c.RENDERBUFFER,e),r>1&&c.renderbufferStorageMultisample?c.renderbufferStorageMultisample(c.RENDERBUFFER,r,a,t,i):c.renderbufferStorage(c.RENDERBUFFER,n,t,i),o!==-1&&c.framebufferRenderbuffer(c.FRAMEBUFFER,o,c.RENDERBUFFER,e),l&&c.bindRenderbuffer(c.RENDERBUFFER,null),e}_releaseTexture(e){this._deleteTexture(e._hardwareTexture),this.unbindAllTextures();let t=this._internalTexturesCache.indexOf(e);t!==-1&&this._internalTexturesCache.splice(t,1),e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureLow&&e._lodTextureLow.dispose(),e._irradianceTexture&&e._irradianceTexture.dispose()}_deleteTexture(e){e?.release()}_setProgram(e){this._currentProgram!==e&&($D(e,this._gl),this._currentProgram=e)}bindSamplers(e){let t=e.getPipelineContext();this._setProgram(t.program);let i=e.getSamplers();for(let r=0;r<i.length;r++){let n=e.getUniform(i[r]);n&&(this._boundUniforms[r]=n)}this._currentEffect=null}_activateCurrentTexture(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)}_bindTextureDirectly(e,t,i=!1,r=!1){let n=!1,a=t&&t._associatedChannel>-1;if(i&&a&&(this._activeChannel=t._associatedChannel),this._boundTexturesCache[this._activeChannel]!==t||r){if(this._activateCurrentTexture(),t&&t.isMultiview)throw P.Error(["_bindTextureDirectly called with a multiview texture!",e,t]),"_bindTextureDirectly called with a multiview texture!";this._gl.bindTexture(e,t?._hardwareTexture?.underlyingResource??null),this._boundTexturesCache[this._activeChannel]=t,t&&(t._associatedChannel=this._activeChannel)}else i&&(n=!0,this._activateCurrentTexture());return a&&!i&&this._bindSamplerUniformToChannel(t._associatedChannel,this._activeChannel),n}_bindTexture(e,t,i){if(e===void 0)return;t&&(t._associatedChannel=e),this._activeChannel=e;let r=t?this._getTextureTarget(t):this._gl.TEXTURE_2D;this._bindTextureDirectly(r,t)}unbindAllTextures(){for(let e=0;e<this._maxSimultaneousTextures;e++)this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))}setTexture(e,t,i,r){e!==void 0&&(t&&(this._boundUniforms[e]=t),this._setTexture(e,i))}_bindSamplerUniformToChannel(e,t){let i=this._boundUniforms[e];!i||i._currentState===t||(this._gl.uniform1i(i,t),i._currentState=t)}_getTextureWrapMode(e){switch(e){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT}_setTexture(e,t,i=!1,r=!1,n=""){if(!t)return this._boundTexturesCache[e]!=null&&(this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(t.video){this._activeChannel=e;let c=t.getInternalTexture();c&&(c._associatedChannel=e),t.update()}else if(t.delayLoadState===4)return t.delayLoad(),!1;let a;r?a=t.depthStencilTexture:t.isReady()?a=t.getInternalTexture():t.isCube?a=this.emptyCubeTexture:t.is3D?a=this.emptyTexture3D:t.is2DArray?a=this.emptyTexture2DArray:a=this.emptyTexture,!i&&a&&(a._associatedChannel=e);let o=!0;this._boundTexturesCache[e]===a&&(i||this._bindSamplerUniformToChannel(a._associatedChannel,e),o=!1),this._activeChannel=e;let l=this._getTextureTarget(a);if(o&&this._bindTextureDirectly(l,a,i),a&&!a.isMultiview){if(a.isCube&&a._cachedCoordinatesMode!==t.coordinatesMode){a._cachedCoordinatesMode=t.coordinatesMode;let c=t.coordinatesMode!==3&&t.coordinatesMode!==5?1:0;t.wrapU=c,t.wrapV=c}a._cachedWrapU!==t.wrapU&&(a._cachedWrapU=t.wrapU,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t.wrapU),a)),a._cachedWrapV!==t.wrapV&&(a._cachedWrapV=t.wrapV,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(t.wrapV),a)),a.is3D&&a._cachedWrapR!==t.wrapR&&(a._cachedWrapR=t.wrapR,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(t.wrapR),a)),this._setAnisotropicLevel(l,a,t.anisotropicFilteringLevel)}return!0}setTextureArray(e,t,i,r){if(!(e===void 0||!t)){(!this._textureUnits||this._textureUnits.length!==i.length)&&(this._textureUnits=new Int32Array(i.length));for(let n=0;n<i.length;n++){let a=i[n].getInternalTexture();a?(this._textureUnits[n]=e+n,a._associatedChannel=e+n):this._textureUnits[n]=-1}this._gl.uniform1iv(t,this._textureUnits);for(let n=0;n<i.length;n++)this._setTexture(this._textureUnits[n],i[n],!0)}}_setAnisotropicLevel(e,t,i){let r=this._caps.textureAnisotropicFilterExtension;t.samplingMode!==11&&t.samplingMode!==3&&t.samplingMode!==2&&(i=1),r&&t._cachedAnisotropicFilteringLevel!==i&&(this._setTextureParameterFloat(e,r.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(i,this._caps.maxAnisotropy),t),t._cachedAnisotropicFilteringLevel=i)}_setTextureParameterFloat(e,t,i,r){this._bindTextureDirectly(e,r,!0,!0),this._gl.texParameterf(e,t,i)}_setTextureParameterInteger(e,t,i,r){r&&this._bindTextureDirectly(e,r,!0,!0),this._gl.texParameteri(e,t,i)}unbindAllAttributes(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(let e=0;e<this._caps.maxVertexAttribs;e++)this.disableAttributeByIndex(e);return}for(let e=0,t=this._vertexAttribArraysEnabled.length;e<t;e++)e>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[e]||this.disableAttributeByIndex(e)}releaseEffects(){this._compiledEffects={},this.onReleaseEffectsObservable.notifyObservers(this)}dispose(){jt()&&this._renderingCanvas&&(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._onContextRestored&&this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored)),super.dispose(),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.unbindAllAttributes(),this._boundUniforms={},this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers.length=0,this._currentProgram=null,this._creationOptions.loseContextOnDispose&&this._gl.getExtension("WEBGL_lose_context")?.loseContext(),Pp(this._gl)}attachContextLostEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",e,!1)}attachContextRestoredEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",e,!1)}getError(){return this._gl.getError()}_canRenderToFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)}_canRenderToHalfFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)}_canRenderToFramebuffer(e){let t=this._gl;for(;t.getError()!==t.NO_ERROR;);let i=!0,r=t.createTexture();t.bindTexture(t.TEXTURE_2D,r),t.texImage2D(t.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(e),1,1,0,t.RGBA,this._getWebGLTextureType(e),null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST);let n=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,n),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,r,0);let a=t.checkFramebufferStatus(t.FRAMEBUFFER);if(i=i&&a===t.FRAMEBUFFER_COMPLETE,i=i&&t.getError()===t.NO_ERROR,i&&(t.clear(t.COLOR_BUFFER_BIT),i=i&&t.getError()===t.NO_ERROR),i){t.bindFramebuffer(t.FRAMEBUFFER,null);let o=t.RGBA,l=t.UNSIGNED_BYTE,c=new Uint8Array(4);t.readPixels(0,0,1,1,o,l,c),i=i&&t.getError()===t.NO_ERROR}for(t.deleteTexture(r),t.deleteFramebuffer(n),t.bindFramebuffer(t.FRAMEBUFFER,null);!i&&t.getError()!==t.NO_ERROR;);return i}_getWebGLTextureType(e){if(this._webGLVersion===1){switch(e){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(e){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE}_getInternalFormat(e,t=!1){let i=t?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;switch(e){case 0:i=this._gl.ALPHA;break;case 1:i=this._gl.LUMINANCE;break;case 2:i=this._gl.LUMINANCE_ALPHA;break;case 6:case 33322:case 36760:i=this._gl.RED;break;case 7:case 33324:case 36761:i=this._gl.RG;break;case 4:case 32852:case 36762:i=t?this._glSRGBExtensionValues.SRGB:this._gl.RGB;break;case 5:case 32859:case 36763:i=t?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;break}if(this._webGLVersion>1)switch(e){case 8:i=this._gl.RED_INTEGER;break;case 9:i=this._gl.RG_INTEGER;break;case 10:i=this._gl.RGB_INTEGER;break;case 11:i=this._gl.RGBA_INTEGER;break}return i}_getRGBABufferInternalSizedFormat(e,t,i=!1){if(this._webGLVersion===1){if(t!==void 0)switch(t){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return i?this._glSRGBExtensionValues.SRGB:this._gl.RGB}return this._gl.RGBA}switch(e){case 3:switch(t){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(t){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return i?this._glSRGBExtensionValues.SRGB8:this._gl.RGB8;case 5:return i?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(t){case 8:return this._gl.R16I;case 36760:return this._gl.R16_SNORM_EXT;case 36761:return this._gl.RG16_SNORM_EXT;case 36762:return this._gl.RGB16_SNORM_EXT;case 36763:return this._gl.RGBA16_SNORM_EXT;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;case 11:return this._gl.RGBA16I;default:return this._gl.RGBA16I}case 5:switch(t){case 8:return this._gl.R16UI;case 33322:return this._gl.R16_EXT;case 33324:return this._gl.RG16_EXT;case 32852:return this._gl.RGB16_EXT;case 32859:return this._gl.RGBA16_EXT;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;case 11:return this._gl.RGBA16UI;default:return this._gl.RGBA16UI}case 6:switch(t){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;case 11:return this._gl.RGBA32I;default:return this._gl.RGBA32I}case 7:switch(t){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;case 11:return this._gl.RGBA32UI;default:return this._gl.RGBA32UI}case 1:switch(t){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;case 5:return this._gl.RGBA32F;default:return this._gl.RGBA32F}case 2:switch(t){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;case 5:return this._gl.RGBA16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(t){case 5:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI;default:return this._gl.RGB10_A2}}return i?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8}readPixels(e,t,i,r,n=!0,a=!0,o=null){let l=n?4:3,c=n?this._gl.RGBA:this._gl.RGB,f=i*r*l;if(!o)o=new Uint8Array(f);else if(o.length<f)return P.Error(`Data buffer is too small to store the read pixels (${o.length} should be more than ${f})`),Promise.resolve(o);return a&&this.flushFramebuffer(),this._gl.readPixels(e,t,i,r,c,this._gl.UNSIGNED_BYTE,o),Promise.resolve(o)}static get IsSupportedAsync(){return Promise.resolve(this.isSupported())}static get IsSupported(){return this.isSupported()}static isSupported(){if(this._HasMajorPerformanceCaveat!==null)return!this._HasMajorPerformanceCaveat;if(this._IsSupported===null)try{let e=k._CreateCanvas(1,1),t=e.getContext("webgl")||e.getContext("experimental-webgl");this._IsSupported=t!=null&&!!window.WebGLRenderingContext}catch{this._IsSupported=!1}return this._IsSupported}static get HasMajorPerformanceCaveat(){if(this._HasMajorPerformanceCaveat===null)try{let e=k._CreateCanvas(1,1),t=e.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||e.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!t}catch{this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat}};Ne._TempClearColorUint32=new Uint32Array(4);Ne._TempClearColorInt32=new Int32Array(4);Ne.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/12\\d\\..+?Mobile",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:".*AppleWebKit.*(15.4).*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]},{key:".*(15.4).*AppleWebKit.*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]}];Ne._ConcatenateShader=Tp;Ne._IsSupported=null;Ne._HasMajorPerformanceCaveat=null});var Nh={};V(Nh,{passPixelShader:()=>sq});var oR,PO,sq,Bh=S(()=>{O();oR="passPixelShader",PO=`varying vec2 vUV;uniform sampler2D textureSampler;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{gl_FragColor=texture2D(textureSampler,vUV);}`;g.ShadersStore[oR]||(g.ShadersStore[oR]=PO);sq={name:oR,shader:PO}});var DO={};V(DO,{Dispose:()=>cR,DumpData:()=>Zp,DumpDataAsync:()=>Uh,DumpFramebuffer:()=>lR,DumpTools:()=>oq});async function nq(){let s=Z.LastCreatedEngine?.createCanvas(100,100)??new OffscreenCanvas(100,100);s instanceof OffscreenCanvas&&P.Warn("DumpData: OffscreenCanvas will be used for dumping data. This may result in lossy alpha values.");let{ThinEngine:e}=await Promise.resolve().then(()=>(kr(),MO));if(!e.IsSupported){if(!s.getContext("bitmaprenderer"))throw new Error("DumpData: No WebGL or bitmap rendering context available. Cannot dump data.");return{canvas:s}}let t={preserveDrawingBuffer:!0,depth:!1,stencil:!1,alpha:!0,premultipliedAlpha:!1,antialias:!1,failIfMajorPerformanceCaveat:!1},i=new e(s,!1,t);Z.Instances.pop(),Z.OnEnginesDisposedObservable.add(o=>{i&&o!==i&&!i.isDisposed&&Z.Instances.length===0&&cR()}),i.getCaps().parallelShaderCompile=void 0;let r=new Cn(i),{passPixelShader:n}=await Promise.resolve().then(()=>(Bh(),Nh)),a=new ti({engine:i,name:n.name,fragmentShader:n.shader,samplerNames:["textureSampler"]});return{canvas:s,dumpEngine:{engine:i,renderer:r,wrapper:a}}}async function aq(){return Gc||(Gc=nq()),await Gc}async function lR(s,e,t,i,r="image/png",n,a){let o=await t.readPixels(0,0,s,e),l=new Uint8Array(o.buffer);Zp(s,e,l,i,r,n,!0,void 0,a)}async function Uh(s,e,t,i="image/png",r,n=!1,a=!1,o){if(t instanceof Float32Array){let c=new Uint8Array(t.length),f=t.length;for(;f--;){let h=t[f];c[f]=Math.round(Fe(h)*255)}t=c}let l=await aq();return await new Promise(async c=>{if(l.dumpEngine){let f=l.dumpEngine;f.engine.setSize(s,e,!0);let h=f.engine.createRawTexture(t,s,e,5,!1,!n,1);f.renderer.setViewport(),f.renderer.applyEffectWrapper(f.wrapper),f.wrapper.effect._bindTexture("textureSampler",h),f.renderer.draw(),h.dispose()}else{let f=l.canvas.getContext("bitmaprenderer");l.canvas.width=s,l.canvas.height=e;let h=new ImageData(s,e);h.data.set(t);let u=await createImageBitmap(h,{premultiplyAlpha:"none",imageOrientation:n?"flipY":"from-image"});f.transferFromImageBitmap(u)}W.ToBlob(l.canvas,f=>{if(!f)throw new Error("DumpData: Failed to convert canvas to blob.");r!==void 0&&W.DownloadBlob(f,r);let h=new FileReader;h.onload=u=>{let d=u.target.result;c(d)},a?h.readAsArrayBuffer(f):h.readAsDataURL(f)},i,o)})}function Zp(s,e,t,i,r="image/png",n,a=!1,o=!1,l){n===void 0&&!i&&(n=""),Uh(s,e,t,r,n,a,o,l).then(c=>{i&&i(c)})}function cR(){Gc&&(Gc?.then(s=>{s.canvas instanceof HTMLCanvasElement&&s.canvas.remove(),s.dumpEngine&&(s.dumpEngine.engine.dispose(),s.dumpEngine.renderer.dispose(),s.dumpEngine.wrapper.dispose())}),Gc=null)}var Gc,oq,lq,fR=S(()=>{In();$e();di();gt();Ee();Gc=null;oq={DumpData:Zp,DumpDataAsync:Uh,DumpFramebuffer:lR,Dispose:cR},lq=()=>{W.DumpData=Zp,W.DumpDataAsync=Uh,W.DumpFramebuffer=lR};lq()});var OO={};V(OO,{RenderTargetTexture:()=>Gt});var Gt,Mn=S(()=>{we();ie();Ut();Wp();Ao();dl();Ee();wh();li.prototype.setDepthStencilTexture=function(s,e){this._engine.setDepthStencilTexture(this._samplers[s],this._uniforms[s],e,s)};Gt=class s extends H{get renderListPredicate(){return this._objectRenderer.renderListPredicate}set renderListPredicate(e){this._objectRenderer.renderListPredicate=e}get renderList(){return this._objectRenderer.renderList}set renderList(e){this._objectRenderer.renderList=e}get particleSystemList(){return this._objectRenderer.particleSystemList}set particleSystemList(e){this._objectRenderer.particleSystemList=e}get getCustomRenderList(){return this._objectRenderer.getCustomRenderList}set getCustomRenderList(e){this._objectRenderer.getCustomRenderList=e}get renderParticles(){return this._objectRenderer.renderParticles}set renderParticles(e){this._objectRenderer.renderParticles=e}get renderSprites(){return this._objectRenderer.renderSprites}set renderSprites(e){this._objectRenderer.renderSprites=e}get enableBoundingBoxRendering(){return this._objectRenderer.enableBoundingBoxRendering}set enableBoundingBoxRendering(e){this._objectRenderer.enableBoundingBoxRendering=e}get enableOutlineRendering(){return this._objectRenderer.enableOutlineRendering}set enableOutlineRendering(e){this._objectRenderer.enableOutlineRendering=e}get forceLayerMaskCheck(){return this._objectRenderer.forceLayerMaskCheck}set forceLayerMaskCheck(e){this._objectRenderer.forceLayerMaskCheck=e}get activeCamera(){return this._objectRenderer.activeCamera}set activeCamera(e){this._objectRenderer.activeCamera=e}get cameraForLOD(){return this._objectRenderer.cameraForLOD}set cameraForLOD(e){this._objectRenderer.cameraForLOD=e}get disableImageProcessing(){return this._objectRenderer.disableImageProcessing}set disableImageProcessing(e){this._objectRenderer.disableImageProcessing=e}get customIsReadyFunction(){return this._objectRenderer.customIsReadyFunction}set customIsReadyFunction(e){this._objectRenderer.customIsReadyFunction=e}get customRenderFunction(){return this._objectRenderer.customRenderFunction}set customRenderFunction(e){this._objectRenderer.customRenderFunction=e}get postProcesses(){return this._postProcesses}get _prePassEnabled(){return!!this._prePassRenderTarget&&this._prePassRenderTarget.enabled}set onAfterUnbind(e){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(e)}get onBeforeRenderObservable(){return this._objectRenderer.onBeforeRenderObservable}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}get onAfterRenderObservable(){return this._objectRenderer.onAfterRenderObservable}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}set onClear(e){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(e)}get _waitingRenderList(){return this._objectRenderer._waitingRenderList}set _waitingRenderList(e){this._objectRenderer._waitingRenderList=e}get renderPassId(){return this._objectRenderer.renderPassId}get renderPassIds(){return this._objectRenderer.renderPassIds}get currentRefreshId(){return this._objectRenderer.currentRefreshId}setMaterialForRendering(e,t){this._objectRenderer.setMaterialForRendering(e,t)}get isMulti(){return this._renderTarget?.isMulti??!1}get renderTargetOptions(){return this._renderTargetOptions}get renderTarget(){return this._renderTarget}_onRatioRescale(){this._sizeRatio&&this.resize(this._initialSizeParameter)}set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;let t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}get depthStencilTexture(){return this._renderTarget?._depthStencilTexture??null}constructor(e,t,i,r=!1,n=!0,a=0,o=!1,l=H.TRILINEAR_SAMPLINGMODE,c=!0,f=!1,h=!1,u=5,d=!1,p,m,_=!1,v=!1){let T,C=!0,I;if(typeof r=="object"){let b=r;r=!!b.generateMipMaps,n=b.doNotChangeAspectRatio??!0,a=b.type??0,o=!!b.isCube,l=b.samplingMode??H.TRILINEAR_SAMPLINGMODE,c=b.generateDepthBuffer??!0,f=!!b.generateStencilBuffer,h=!!b.isMulti,u=b.format??5,d=!!b.delayAllocation,p=b.samples,m=b.creationFlags,_=!!b.noColorAttachment,v=!!b.useSRGBBuffer,T=b.colorAttachment,C=b.gammaSpace??C,I=b.existingObjectRenderer}if(super(null,i,!r,void 0,l,void 0,void 0,void 0,void 0,u),this.ignoreCameraViewport=!1,this.onBeforeBindObservable=new N,this.onAfterUnbindObservable=new N,this.onClearObservable=new N,this.onResizeObservable=new N,this._cleared=!1,this.skipInitialClear=!1,this._samples=1,this._canRescale=!0,this._renderTarget=null,this._dontDisposeObjectRenderer=!1,this.boundingBoxPosition=E.Zero(),this._disableEngineStages=!1,this._dumpToolsLoading=!1,i=this.getScene(),!i)return;let R=this.getScene().getEngine();this._gammaSpace=C,this._coordinatesMode=H.PROJECTION_MODE,this.name=e,this.isRenderTarget=!0,this._initialSizeParameter=t,this._dontDisposeObjectRenderer=!!I,this._processSizeParameter(t),this._objectRenderer=I??new rr(e,i,{numPasses:o?6:this.getRenderLayers()||1,doNotChangeAspectRatio:n}),this._onBeforeRenderingManagerRenderObserver=this._objectRenderer.onBeforeRenderingManagerRenderObservable.add(()=>{if(!this._disableEngineStages)for(let b of this._scene._beforeRenderTargetClearStage)b.action(this,this._currentFaceIndex,this._currentLayer);if(this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(R):this.skipInitialClear||R.clear(this.clearColor||this._scene.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||this._scene.updateTransformMatrix(!0),!this._disableEngineStages)for(let b of this._scene._beforeRenderTargetDrawStage)b.action(this,this._currentFaceIndex,this._currentLayer)}),this._onAfterRenderingManagerRenderObserver=this._objectRenderer.onAfterRenderingManagerRenderObservable.add(()=>{if(!this._disableEngineStages)for(let M of this._scene._afterRenderTargetDrawStage)M.action(this,this._currentFaceIndex,this._currentLayer);let b=this._texture?.generateMipMaps??!1;if(this._texture&&(this._texture.generateMipMaps=!1),this._postProcessManager?this._postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,this._currentFaceIndex,this._postProcesses,this.ignoreCameraViewport):this._currentUseCameraPostProcess&&this._scene.postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,this._currentFaceIndex),!this._disableEngineStages)for(let M of this._scene._afterRenderTargetPostProcessStage)M.action(this,this._currentFaceIndex,this._currentLayer);this._texture&&(this._texture.generateMipMaps=b),this._doNotChangeAspectRatio||this._scene.updateTransformMatrix(!0),this._currentDumpForDebug&&(this._dumpTools?this._dumpTools.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),R):P.Error("dumpTools module is still being loaded. To speed up the process import dump tools directly in your project"))}),this._onFastPathRenderObserver=this._objectRenderer.onFastPathRenderObservable.add(()=>{this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(R):this.skipInitialClear||R.clear(this.clearColor||this._scene.clearColor,!0,!0,!0)}),this._resizeObserver=R.onResizeObservable.add(()=>{}),this._generateMipMaps=!!r,this._doNotChangeAspectRatio=n,!h&&(this._renderTargetOptions={generateMipMaps:r,type:a,format:this._format??void 0,samplingMode:this.samplingMode,generateDepthBuffer:c,generateStencilBuffer:f,samples:p,creationFlags:m,noColorAttachment:_,useSRGBBuffer:v,colorAttachment:T,label:this.name},this.samplingMode===H.NEAREST_SAMPLINGMODE&&(this.wrapU=H.CLAMP_ADDRESSMODE,this.wrapV=H.CLAMP_ADDRESSMODE),d||(o?(this._renderTarget=i.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions),this.coordinatesMode=H.INVCUBIC_MODE,this._textureMatrix=B.Identity()):this._renderTarget=i.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,p!==void 0&&(this.samples=p)))}createDepthStencilTexture(e=0,t=!0,i=!1,r=1,n=14,a){this._renderTarget?.createDepthStencilTexture(e,t,i,r,n,a)}_processSizeParameter(e){if(e.ratio){this._sizeRatio=e.ratio;let t=this._getEngine();this._size={width:this._bestReflectionRenderTargetDimension(t.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(t.getRenderHeight(),this._sizeRatio)}}else this._size=e}get samples(){return this._renderTarget?.samples??this._samples}set samples(e){this._renderTarget&&(this._samples=this._renderTarget.setSamples(e))}addPostProcess(e){if(!this._postProcessManager){let t=this.getScene();if(!t)return;this._postProcessManager=new va(t),this._postProcesses=new Array}this._postProcesses.push(e),this._postProcesses[0].autoClear=!1}clearPostProcesses(e=!1){if(this._postProcesses){if(e)for(let t of this._postProcesses)t.dispose();this._postProcesses=[]}}removePostProcess(e){if(!this._postProcesses)return;let t=this._postProcesses.indexOf(e);t!==-1&&(this._postProcesses.splice(t,1),this._postProcesses.length>0&&(this._postProcesses[0].autoClear=!1))}resetRefreshCounter(){this._objectRenderer.resetRefreshCounter()}get refreshRate(){return this._objectRenderer.refreshRate}set refreshRate(e){this._objectRenderer.refreshRate=e}_shouldRender(){return this._objectRenderer.shouldRender()}getRenderSize(){return this.getRenderWidth()}getRenderWidth(){return this._size.width?this._size.width:this._size}getRenderHeight(){return this._size.width?this._size.height:this._size}getRenderLayers(){let e=this._size.layers;if(e)return e;let t=this._size.depth;return t||0}disableRescaling(){this._canRescale=!1}get canRescale(){return this._canRescale}scale(e){let t=Math.max(1,this.getRenderSize()*e);this.resize(t)}getReflectionTextureMatrix(){return this.isCube?this._textureMatrix:super.getReflectionTextureMatrix()}resize(e){let t=this.isCube;this._renderTarget?.dispose(),this._renderTarget=null;let i=this.getScene();i&&(this._processSizeParameter(e),t?this._renderTarget=i.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):this._renderTarget=i.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,this._renderTargetOptions.samples!==void 0&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))}render(e=!1,t=!1){this._render(e,t)}isReadyForRendering(){this._dumpToolsLoading||(this._dumpToolsLoading=!0,Promise.resolve().then(()=>(fR(),DO)).then(t=>this._dumpTools=t)),this._objectRenderer.prepareRenderList(),this.onBeforeBindObservable.notifyObservers(this),this._objectRenderer.initRender(this.getRenderWidth(),this.getRenderHeight());let e=this._objectRenderer._checkReadiness();return this.onAfterUnbindObservable.notifyObservers(this),this._objectRenderer.finishRender(),e}_render(e=!1,t=!1){let i=this.getScene();if(i){if(this.useCameraPostProcesses!==void 0&&(e=this.useCameraPostProcesses),this._objectRenderer.prepareRenderList(),this.onBeforeBindObservable.notifyObservers(this),this._objectRenderer.initRender(this.getRenderWidth(),this.getRenderHeight()),(this.is2DArray||this.is3D)&&!this.isMulti)for(let r=0;r<this.getRenderLayers();r++)this._renderToTarget(0,e,t,r),i.incrementRenderId(),i.resetCachedMaterial();else if(this.isCube&&!this.isMulti)for(let r=0;r<6;r++)this._renderToTarget(r,e,t),i.incrementRenderId(),i.resetCachedMaterial();else this._renderToTarget(0,e,t);this.onAfterUnbindObservable.notifyObservers(this),this._objectRenderer.finishRender()}}_bestReflectionRenderTargetDimension(e,t){let r=e*t,n=ZA(r+16384/(128+r));return Math.min(Hp(e),n)}_bindFrameBuffer(e=0,t=0){let i=this.getScene();if(!i)return;let r=i.getEngine();this._renderTarget&&r.bindFramebuffer(this._renderTarget,this.isCube?e:void 0,void 0,void 0,this.ignoreCameraViewport,0,t)}_unbindFrameBuffer(e,t){this._renderTarget&&e.unBindFramebuffer(this._renderTarget,this.isCube,()=>{this.onAfterRenderObservable.notifyObservers(t)})}_prepareFrame(e,t,i,r){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses)||this._bindFrameBuffer(t,i):(!r||!e.postProcessManager._prepareFrame(this._texture))&&this._bindFrameBuffer(t,i)}_renderToTarget(e,t,i,r=0){let n=this.getScene();if(!n)return;let a=n.getEngine();this._currentFaceIndex=e,this._currentLayer=r,this._currentUseCameraPostProcess=t,this._currentDumpForDebug=i,this._prepareFrame(n,e,r,t),a._debugPushGroup?.(`render to face #${e} layer #${r}`,2),this._objectRenderer.render(e+r,!0),a._debugPopGroup?.(2),this._unbindFrameBuffer(a,e),this._texture&&this.isCube&&e===5&&a.generateMipMapsForCubemap(this._texture,!0)}setRenderingOrder(e,t=null,i=null,r=null){this._objectRenderer.setRenderingOrder(e,t,i,r)}setRenderingAutoClearDepthStencil(e,t){this._objectRenderer.setRenderingAutoClearDepthStencil(e,t)}clone(){let e=this.getSize(),t=new s(this.name,e,this.getScene(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,this.renderList&&(t.renderList=this.renderList.slice(0)),t}serialize(){if(!this.name)return null;let e=super.serialize();if(e.renderTargetSize=this.getRenderSize(),e.renderList=[],this.renderList)for(let t=0;t<this.renderList.length;t++)e.renderList.push(this.renderList[t].id);return e}disposeFramebufferObjects(){this._renderTarget?.dispose(!0)}releaseInternalTexture(){this._renderTarget?.releaseTextures(),this._texture=null}dispose(){this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this._objectRenderer.onBeforeRenderingManagerRenderObservable.remove(this._onBeforeRenderingManagerRenderObserver),this._objectRenderer.onAfterRenderingManagerRenderObservable.remove(this._onAfterRenderingManagerRenderObserver),this._objectRenderer.onFastPathRenderObservable.remove(this._onFastPathRenderObserver),this._dontDisposeObjectRenderer||this._objectRenderer.dispose(),this.clearPostProcesses(!0),this._resizeObserver&&(this.getScene().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null);let e=this.getScene();if(!e)return;let t=e.customRenderTargets.indexOf(this);t>=0&&e.customRenderTargets.splice(t,1);for(let i of e.cameras)t=i.customRenderTargets.indexOf(this),t>=0&&i.customRenderTargets.splice(t,1);this._renderTarget?.dispose(),this._renderTarget=null,this._texture=null,super.dispose()}_rebuild(){this._objectRenderer._rebuild(),this._postProcessManager&&this._postProcessManager._rebuild()}freeRenderingGroups(){this._objectRenderer.freeRenderingGroups()}getViewCount(){return 1}};Gt.REFRESHRATE_RENDER_ONCE=rr.REFRESHRATE_RENDER_ONCE;Gt.REFRESHRATE_RENDER_ONEVERYFRAME=rr.REFRESHRATE_RENDER_ONEVERYFRAME;Gt.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=rr.REFRESHRATE_RENDER_ONEVERYTWOFRAMES;H._CreateRenderTargetTexture=(s,e,t,i,r)=>new Gt(s,e,t,i)});var at,Wr=S(()=>{Ye();bn();we();ie();dl();je();ei();Te();Jt();Ao();In();k.prototype.setTextureFromPostProcess=function(s,e,t){let i=null;e&&(e._forcedOutputTexture?i=e._forcedOutputTexture:e._textures.data[e._currentRenderTextureInd]&&(i=e._textures.data[e._currentRenderTextureInd])),this._bindTexture(s,i?.texture??null,t)};k.prototype.setTextureFromPostProcessOutput=function(s,e,t){this._bindTexture(s,e?._outputTexture?.texture??null,t)};li.prototype.setTextureFromPostProcess=function(s,e){this._engine.setTextureFromPostProcess(this._samplers[s],e,s)};li.prototype.setTextureFromPostProcessOutput=function(s,e){this._engine.setTextureFromPostProcessOutput(this._samplers[s],e,s)};at=class s{static get ForceGLSL(){return ti.ForceGLSL}static set ForceGLSL(e){ti.ForceGLSL=e}static RegisterShaderCodeProcessing(e,t){ti.RegisterShaderCodeProcessing(e,t)}get name(){return this._effectWrapper.name}set name(e){this._effectWrapper.name=e}get alphaMode(){return this._effectWrapper.alphaMode}set alphaMode(e){this._effectWrapper.alphaMode=e}get samples(){return this._samples}set samples(e){this._samples=Math.min(e,this._engine.getCaps().maxMSAASamples),this._textures.forEach(t=>{t.setSamples(this._samples)})}get shaderLanguage(){return this._shaderLanguage}getEffectName(){return this._fragmentUrl}set onActivate(e){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),e&&(this._onActivateObserver=this.onActivateObservable.add(e))}set onSizeChanged(e){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(e)}set onApply(e){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}get inputTexture(){return this._textures.data[this._currentRenderTextureInd]}set inputTexture(e){this._forcedOutputTexture=e}restoreDefaultInputTexture(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty())}getCamera(){return this._camera}get texelSize(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.copyFromFloats(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)}constructor(e,t,i,r,n,a,o=1,l,c,f=null,h=0,u="postprocess",d,p=!1,m=5,_,v){this._parentContainer=null,this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.autoClear=!0,this.forceAutoClearInAlphaMode=!1,this.animations=[],this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._webGPUReady=!1,this._reusable=!1,this._renderId=0,this.externalTextureSamplerBinding=!1,this._textures=new wt(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new he(1,1),this._texelSize=he.Zero(),this.onActivateObservable=new N,this.onSizeChangedObservable=new N,this.onApplyObservable=new N,this.onBeforeRenderObservable=new N,this.onAfterRenderObservable=new N,this.onDisposeObservable=new N;let T=1,C=null,I;if(i&&!Array.isArray(i)){let R=i;i=R.uniforms??null,r=R.samplers??null,T=R.size??1,a=R.camera??null,o=R.samplingMode??1,l=R.engine,c=R.reusable,f=Array.isArray(R.defines)?R.defines.join(`
`):R.defines??null,h=R.textureType??0,u=R.vertexUrl??"postprocess",d=R.indexParameters,p=R.blockCompilation??!1,m=R.textureFormat??5,_=R.shaderLanguage??0,C=R.uniformBuffers??null,v=R.extraInitializations,I=R.effectWrapper}else n&&(typeof n=="number"?T=n:T={width:n.width,height:n.height});if(this._useExistingThinPostProcess=!!I,this._effectWrapper=I??new ti({name:e,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:t,engine:l||a?.getScene().getEngine(),uniforms:i,samplers:r,uniformBuffers:C,defines:f,vertexUrl:u,indexParameters:d,blockCompilation:!0,shaderLanguage:_,extraInitializations:void 0}),this.name=e,this.onEffectCreatedObservable=this._effectWrapper.onEffectCreatedObservable,a!=null?(this._camera=a,this._scene=a.getScene(),a.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.addPostProcess(this),this.uniqueId=this._scene.getUniqueId()):l&&(this._engine=l,this._engine.postProcesses.push(this)),this._options=T,this.renderTargetSamplingMode=o||1,this._reusable=c||!1,this._textureType=h,this._textureFormat=m,this._shaderLanguage=_||0,this._samplers=r||[],this._samplers.indexOf("textureSampler")===-1&&this._samplers.push("textureSampler"),this._fragmentUrl=t,this._vertexUrl=u,this._parameters=i||[],this._parameters.indexOf("scale")===-1&&this._parameters.push("scale"),this._uniformBuffers=C||[],this._indexParameters=d,!this._useExistingThinPostProcess){this._webGPUReady=this._shaderLanguage===1;let R=[];this._gatherImports(this._engine.isWebGPU&&!s.ForceGLSL,R),this._effectWrapper._webGPUReady=this._webGPUReady,this._effectWrapper._postConstructor(p,f,v,R)}}_gatherImports(e=!1,t){e&&this._webGPUReady?t.push(Promise.all([Promise.resolve().then(()=>(rR(),iR))])):t.push(Promise.all([Promise.resolve().then(()=>(Xp(),eR))]))}getClassName(){return"PostProcess"}getEngine(){return this._engine}getEffect(){return this._effectWrapper.drawWrapper.effect}shareOutputWith(e){return this._disposeTextures(),this._shareOutputWithPostProcess=e,this}useOwnOutput(){this._textures.length==0&&(this._textures=new wt(2)),this._shareOutputWithPostProcess=null}updateEffect(e=null,t=null,i=null,r,n,a,o,l){this._effectWrapper.updateEffect(e,t,i,r,n,a,o,l),this._postProcessDefines=Array.isArray(this._effectWrapper.options.defines)?this._effectWrapper.options.defines.join(`
`):this._effectWrapper.options.defines}isReusable(){return this._reusable}markTextureDirty(){this.width=-1}_createRenderTargetTexture(e,t,i=0){for(let n=0;n<this._textureCache.length;n++)if(this._textureCache[n].texture.width===e.width&&this._textureCache[n].texture.height===e.height&&this._textureCache[n].postProcessChannel===i&&this._textureCache[n].texture._generateDepthBuffer===t.generateDepthBuffer&&this._textureCache[n].texture.samples===t.samples)return this._textureCache[n].texture;let r=this._engine.createRenderTargetTexture(e,t);return this._textureCache.push({texture:r,postProcessChannel:i,lastUsedRenderId:-1}),r}_flushTextureCache(){let e=this._renderId;for(let t=this._textureCache.length-1;t>=0;t--)if(e-this._textureCache[t].lastUsedRenderId>100){let i=!1;for(let r=0;r<this._textures.length;r++)if(this._textures.data[r]===this._textureCache[t].texture){i=!0;break}i||(this._textureCache[t].texture.dispose(),this._textureCache.splice(t,1))}}resize(e,t,i=null,r=!1,n=!1){this._textures.length>0&&this._textures.reset(),this.width=e,this.height=t;let a=null;if(i){for(let c=0;c<i._postProcesses.length;c++)if(i._postProcesses[c]!==null){a=i._postProcesses[c];break}}let o={width:this.width,height:this.height},l={generateMipMaps:r,generateDepthBuffer:n||a===this,generateStencilBuffer:(n||a===this)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType,format:this._textureFormat,samples:this._samples,label:"PostProcessRTT-"+this.name};this._textures.push(this._createRenderTargetTexture(o,l,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(o,l,1)),this._texelSize.copyFromFloats(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)}_getTarget(){let e;if(this._shareOutputWithPostProcess)e=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)e=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else{e=this.inputTexture;let t;for(let i=0;i<this._textureCache.length;i++)if(this._textureCache[i].texture===e){t=this._textureCache[i];break}t&&(t.lastUsedRenderId=this._renderId)}return e}activate(e,t=null,i){let r=e===null||e.cameraRigMode!==void 0?e||this._camera:null,n=r?.getScene()??e,a=n.getEngine(),o=a.getCaps().maxTextureSize,l=(t?t.width:this._engine.getRenderWidth(!0))*this._options|0,c=(t?t.height:this._engine.getRenderHeight(!0))*this._options|0,f=this._options.width||l,h=this._options.height||c,u=this.renderTargetSamplingMode!==7&&this.renderTargetSamplingMode!==1&&this.renderTargetSamplingMode!==2,d=null;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){let p=a.currentViewport;p&&(f*=p.width,h*=p.height)}(u||this.alwaysForcePOT)&&(this._options.width||(f=a.needPOTTextures?xo(f,o,this.scaleMode):f),this._options.height||(h=a.needPOTTextures?xo(h,o,this.scaleMode):h)),(this.width!==f||this.height!==h||!(d=this._getTarget()))&&this.resize(f,h,r,u,i),this._textures.forEach(p=>{p.samples!==this.samples&&this._engine.updateRenderTargetTextureSampleCount(p,this.samples)}),this._flushTextureCache(),this._renderId++}return d||(d=this._getTarget()),this.enablePixelPerfectMode?(this._scaleRatio.copyFromFloats(l/f,c/h),this._engine.bindFramebuffer(d,0,l,c,this.forceFullscreenViewport)):(this._scaleRatio.copyFromFloats(1,1),this._engine.bindFramebuffer(d,0,void 0,void 0,this.forceFullscreenViewport)),this._engine._debugInsertMarker?.(`post process ${this.name} input`),this.onActivateObservable.notifyObservers(r),this.autoClear&&(this.alphaMode===0||this.forceAutoClearInAlphaMode)&&this._engine.clear(this.clearColor?this.clearColor:n.clearColor,n._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),d}get isSupported(){return this._effectWrapper.drawWrapper.effect.isSupported}get aspectRatio(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height}isReady(){return this._effectWrapper.isReady()}apply(){if(!this._effectWrapper.isReady())return null;this._engine.enableEffect(this._effectWrapper.drawWrapper),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a),this._engine.setAlphaMode(this.alphaMode);let e;return this._shareOutputWithPostProcess?e=this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?e=this._forcedOutputTexture:e=this.inputTexture,this.externalTextureSamplerBinding||this._effectWrapper.drawWrapper.effect._bindTexture("textureSampler",e?.texture),this._effectWrapper.drawWrapper.effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._effectWrapper.drawWrapper.effect),this._effectWrapper.bind(!0),this._effectWrapper.drawWrapper.effect}_disposeTextures(){if(this._shareOutputWithPostProcess||this._forcedOutputTexture){this._disposeTextureCache();return}this._disposeTextureCache(),this._textures.dispose()}_disposeTextureCache(){for(let e=this._textureCache.length-1;e>=0;e--)this._textureCache[e].texture.dispose();this._textureCache.length=0}setPrePassRenderer(e){return this._prePassEffectConfiguration?(this._prePassEffectConfiguration=e.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=!0,!0):!1}dispose(e){e=e||this._camera,this._useExistingThinPostProcess||this._effectWrapper.dispose(),this._disposeTextures();let t;if(this._scene&&(t=this._scene.removePostProcess(this)),this._parentContainer){let i=this._parentContainer.postProcesses.indexOf(this);i>-1&&this._parentContainer.postProcesses.splice(i,1),this._parentContainer=null}if(t=this._engine.postProcesses.indexOf(this),t!==-1&&this._engine.postProcesses.splice(t,1),this.onDisposeObservable.notifyObservers(),!!e){if(e.detachPostProcess(this),t=e._postProcesses.indexOf(this),t===0&&e._postProcesses.length>0){let i=this._camera._getFirstPostProcess();i&&i.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear(),this.onEffectCreatedObservable.clear()}}serialize(){let e=_e.Serialize(this),t=this.getCamera()||this._scene&&this._scene.activeCamera;return e.customType="BABYLON."+this.getClassName(),e.cameraId=t?t.id:null,e.reusable=this._reusable,e.textureType=this._textureType,e.fragmentUrl=this._fragmentUrl,e.parameters=this._parameters,e.samplers=this._samplers,e.uniformBuffers=this._uniformBuffers,e.options=this._options,e.defines=this._postProcessDefines,e.textureFormat=this._textureFormat,e.vertexUrl=this._vertexUrl,e.indexParameters=this._indexParameters,e}clone(){let e=this.serialize();e._engine=this._engine,e.cameraId=null;let t=s.Parse(e,this._scene,"");return t?(t.onActivateObservable=this.onActivateObservable.clone(),t.onSizeChangedObservable=this.onSizeChangedObservable.clone(),t.onApplyObservable=this.onApplyObservable.clone(),t.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),t.onAfterRenderObservable=this.onAfterRenderObservable.clone(),t._prePassEffectConfiguration=this._prePassEffectConfiguration,t):null}static Parse(e,t,i){let r=Ci(e.customType);if(!r||!r._Parse)return null;let n=t?t.getCameraById(e.cameraId):null;return r._Parse(e,n,t,i)}static _Parse(e,t,i,r){return _e.Parse(()=>new s(e.name,e.fragmentUrl,e.parameters,e.samplers,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable,e.defines,e.textureType,e.vertexUrl,e.indexParameters,!1,e.textureFormat),e,i,r)}};x([y()],at.prototype,"uniqueId",void 0);x([y()],at.prototype,"name",null);x([y()],at.prototype,"width",void 0);x([y()],at.prototype,"height",void 0);x([y()],at.prototype,"renderTargetSamplingMode",void 0);x([np()],at.prototype,"clearColor",void 0);x([y()],at.prototype,"autoClear",void 0);x([y()],at.prototype,"forceAutoClearInAlphaMode",void 0);x([y()],at.prototype,"alphaMode",null);x([y()],at.prototype,"alphaConstants",void 0);x([y()],at.prototype,"enablePixelPerfectMode",void 0);x([y()],at.prototype,"forceFullscreenViewport",void 0);x([y()],at.prototype,"scaleMode",void 0);x([y()],at.prototype,"alwaysForcePOT",void 0);x([y("samples")],at.prototype,"_samples",void 0);x([y()],at.prototype,"adaptScaleToCurrentViewport",void 0);G("BABYLON.PostProcess",at)});var Vc,hR,uR=S(()=>{zs();Vc=class{constructor(e=30){this._enabled=!0,this._rollingFrameTime=new hR(e)}sampleFrame(e=Zt.Now){if(this._enabled){if(this._lastFrameTimeMs!=null){let t=e-this._lastFrameTimeMs;this._rollingFrameTime.add(t)}this._lastFrameTimeMs=e}}get averageFrameTime(){return this._rollingFrameTime.average}get averageFrameTimeVariance(){return this._rollingFrameTime.variance}get instantaneousFrameTime(){return this._rollingFrameTime.history(0)}get averageFPS(){return 1e3/this._rollingFrameTime.average}get instantaneousFPS(){let e=this._rollingFrameTime.history(0);return e===0?0:1e3/e}get isSaturated(){return this._rollingFrameTime.isSaturated()}enable(){this._enabled=!0}disable(){this._enabled=!1,this._lastFrameTimeMs=null}get isEnabled(){return this._enabled}reset(){this._lastFrameTimeMs=null,this._rollingFrameTime.reset()}},hR=class{constructor(e){this._samples=new Array(e),this.reset()}add(e){let t;if(this.isSaturated()){let i=this._samples[this._pos];t=i-this.average,this.average-=t/(this._sampleCount-1),this._m2-=t*(i-this.average)}else this._sampleCount++;t=e-this.average,this.average+=t/this._sampleCount,this._m2+=t*(e-this.average),this.variance=this._m2/(this._sampleCount-1),this._samples[this._pos]=e,this._pos++,this._pos%=this._samples.length}history(e){if(e>=this._sampleCount||e>=this._samples.length)return 0;let t=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(t-e)]}isSaturated(){return this._sampleCount>=this._samples.length}reset(){this.average=0,this.variance=0,this._sampleCount=0,this._pos=0,this._m2=0}_wrapPosition(e){let t=this._samples.length;return(e%t+t)%t}}});var LO=S(()=>{kr();Ne.prototype.setAlphaMode=function(s,e=!1,t=0){if(this._alphaMode[t]===s){if(!e){let r=s===0;this.depthCullingState.depthMask!==r&&(this.depthCullingState.depthMask=r)}return}let i=s===0;this._alphaState.setAlphaBlend(!i,t),this._alphaState.setAlphaMode(s,t),e||(this.depthCullingState.depthMask=i),this._alphaMode[t]=s}});function wO(s,e,t,i){let r,n=1;i===1?r=new Float32Array(e*t*4):i===2?(r=new Uint16Array(e*t*4),n=15360):i===7?r=new Uint32Array(e*t*4):r=new Uint8Array(e*t*4);for(let a=0;a<e;a++)for(let o=0;o<t;o++){let l=(o*e+a)*3,c=(o*e+a)*4;r[c+0]=s[l+0],r[c+1]=s[l+1],r[c+2]=s[l+2],r[c+3]=n}return r}function FO(s){return function(e,t,i,r,n,a,o,l,c=null,f=0){let h=s?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,u=s?10:11,d=new Je(this,u);d.baseWidth=t,d.baseHeight=i,d.baseDepth=r,d.width=t,d.height=i,d.depth=r,d.format=n,d.type=f,d.generateMipMaps=a,d.samplingMode=l,s?d.is3D=!0:d.is2DArray=!0,this._doNotHandleContextLost||(d._bufferView=e),s?this.updateRawTexture3D(d,e,n,o,c,f):this.updateRawTexture2DArray(d,e,n,o,c,f),this._bindTextureDirectly(h,d,!0);let p=this._getSamplingParameters(l,a);return this._gl.texParameteri(h,this._gl.TEXTURE_MAG_FILTER,p.mag),this._gl.texParameteri(h,this._gl.TEXTURE_MIN_FILTER,p.min),a&&this._gl.generateMipmap(h),this._bindTextureDirectly(h,null),this._internalTexturesCache.push(d),d}}function NO(s){return function(e,t,i,r,n=null,a=0){let o=s?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,l=this._getWebGLTextureType(a),c=this._getInternalFormat(i),f=this._getRGBABufferInternalSizedFormat(a,i);this._bindTextureDirectly(o,e,!0),this._unpackFlipY(r===void 0?!0:!!r),this._doNotHandleContextLost||(e._bufferView=t,e.format=i,e.invertY=r,e._compression=n),e.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),n&&t?this._gl.compressedTexImage3D(o,0,this.getCaps().s3tc[n],e.width,e.height,e.depth,0,t):this._gl.texImage3D(o,0,f,e.width,e.height,e.depth,0,c,l,t),e.generateMipMaps&&this._gl.generateMipmap(o),this._bindTextureDirectly(o,null),e.isReady=!0}}var BO=S(()=>{vi();Ee();kr();Ao();Ne.prototype.updateRawTexture=function(s,e,t,i,r=null,n=0,a=!1){if(!s)return;let o=this._getRGBABufferInternalSizedFormat(n,t,a),l=this._getInternalFormat(t),c=this._getWebGLTextureType(n);this._bindTextureDirectly(this._gl.TEXTURE_2D,s,!0),this._unpackFlipY(i===void 0?!0:!!i),this._doNotHandleContextLost||(s._bufferView=e,s.format=t,s.type=n,s.invertY=i,s._compression=r),s.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),r&&e?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[r],s.width,s.height,0,e):this._gl.texImage2D(this._gl.TEXTURE_2D,0,o,s.width,s.height,0,l,c,e),s.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),s.isReady=!0};Ne.prototype.createRawTexture=function(s,e,t,i,r,n,a,o=null,l=0,c=0,f=!1){let h=new Je(this,3);h.baseWidth=e,h.baseHeight=t,h.width=e,h.height=t,h.format=i,h.generateMipMaps=r,h.samplingMode=a,h.invertY=n,h._compression=o,h.type=l,h._useSRGBBuffer=this._getUseSRGBBuffer(f,!r),this._doNotHandleContextLost||(h._bufferView=s),this.updateRawTexture(h,s,i,n,o,l,h._useSRGBBuffer),this._bindTextureDirectly(this._gl.TEXTURE_2D,h,!0);let u=this._getSamplingParameters(a,r);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,u.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,u.min),r&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(h),h};Ne.prototype.createRawCubeTexture=function(s,e,t,i,r,n,a,o=null){let l=this._gl,c=new Je(this,8);c.isCube=!0,c.format=t,c.type=i,this._doNotHandleContextLost||(c._bufferViewArray=s);let f=this._getWebGLTextureType(i),h=this._getInternalFormat(t);h===l.RGB&&(h=l.RGBA),f===l.FLOAT&&!this._caps.textureFloatLinearFiltering?(r=!1,a=1,P.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):f===this._gl.HALF_FLOAT_OES&&!this._caps.textureHalfFloatLinearFiltering?(r=!1,a=1,P.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):f===l.FLOAT&&!this._caps.textureFloatRender?(r=!1,P.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):f===l.HALF_FLOAT&&!this._caps.colorBufferFloat&&(r=!1,P.Warn("Render to half float textures is not supported. Mipmap generation forced to false."));let u=e,d=u;if(c.width=u,c.height=d,c.invertY=n,c._compression=o,!this.needPOTTextures||Sl(c.width)&&Sl(c.height)||(r=!1),s)this.updateRawCubeTexture(c,s,t,i,n,o);else{let _=this._getRGBABufferInternalSizedFormat(i),v=0;this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,c,!0);for(let T=0;T<6;T++)o?l.compressedTexImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+T,v,this.getCaps().s3tc[o],c.width,c.height,0,void 0):l.texImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+T,v,_,c.width,c.height,0,h,f,null);this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)}this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,c,!0),s&&r&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP);let m=this._getSamplingParameters(a,r);return l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MAG_FILTER,m.mag),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MIN_FILTER,m.min),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,null),c.generateMipMaps=r,c.samplingMode=a,c.isReady=!0,c};Ne.prototype.updateRawCubeTexture=function(s,e,t,i,r,n=null,a=0){s._bufferViewArray=e,s.format=t,s.type=i,s.invertY=r,s._compression=n;let o=this._gl,l=this._getWebGLTextureType(i),c=this._getInternalFormat(t),f=this._getRGBABufferInternalSizedFormat(i),h=!1;c===o.RGB&&(c=o.RGBA,h=!0),this._bindTextureDirectly(o.TEXTURE_CUBE_MAP,s,!0),this._unpackFlipY(r===void 0?!0:!!r),s.width%4!==0&&o.pixelStorei(o.UNPACK_ALIGNMENT,1);for(let d=0;d<6;d++){let p=e[d];n?o.compressedTexImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+d,a,this.getCaps().s3tc[n],s.width,s.height,0,p):(h&&(p=wO(p,s.width,s.height,i)),o.texImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+d,a,f,s.width,s.height,0,c,l,p))}(!this.needPOTTextures||Sl(s.width)&&Sl(s.height))&&s.generateMipMaps&&a===0&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),s.isReady=!0};Ne.prototype.createRawCubeTextureFromUrl=function(s,e,t,i,r,n,a,o,l=null,c=null,f=3,h=!1){let u=this._gl,d=this.createRawCubeTexture(null,t,i,r,!n,h,f,null);e?.addPendingData(d),d.url=s,d.isReady=!1,this._internalTexturesCache.push(d);let p=(_,v)=>{e?.removePendingData(d),c&&_&&c(_.status+" "+_.statusText,v)},m=async _=>{if(!d._hardwareTexture)return;let v=a(_);if(!v)return;let T=v instanceof Promise?await v:v,C=d.width;if(o){let I=this._getWebGLTextureType(r),R=this._getInternalFormat(i),b=this._getRGBABufferInternalSizedFormat(r),M=!1;R===u.RGB&&(R=u.RGBA,M=!0),this._bindTextureDirectly(u.TEXTURE_CUBE_MAP,d,!0),this._unpackFlipY(!1);let F=o(T);for(let U=0;U<F.length;U++){let D=C>>U;for(let $=0;$<6;$++){let oe=F[U][$];M&&(oe=wO(oe,D,D,r)),u.texImage2D($,U,b,D,D,0,R,I,oe)}}this._bindTextureDirectly(u.TEXTURE_CUBE_MAP,null)}else this.updateRawCubeTexture(d,T,i,r,h);d.isReady=!0,e?.removePendingData(d),d.onLoadedObservable.notifyObservers(d),d.onLoadedObservable.clear(),l&&l()};return this._loadFile(s,_=>{m(_).catch(v=>{p(void 0,v)})},void 0,e?.offlineProvider,!0,p),d};Ne.prototype.createRawTexture2DArray=FO(!1);Ne.prototype.createRawTexture3D=FO(!0);Ne.prototype.updateRawTexture2DArray=NO(!1);Ne.prototype.updateRawTexture3D=NO(!0)});var UO=S(()=>{kr();fa();Ne.prototype._readTexturePixelsSync=function(s,e,t,i=-1,r=0,n=null,a=!0,o=!1,l=0,c=0){let f=this._gl;if(!f)throw new Error("Engine does not have gl rendering context.");if(!this._dummyFramebuffer){let u=f.createFramebuffer();if(!u)throw new Error("Unable to create dummy framebuffer");this._dummyFramebuffer=u}f.bindFramebuffer(f.FRAMEBUFFER,this._dummyFramebuffer),i>-1?f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_CUBE_MAP_POSITIVE_X+i,s._hardwareTexture?.underlyingResource,r):f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_2D,s._hardwareTexture?.underlyingResource,r);let h=s.type!==void 0?this._getWebGLTextureType(s.type):f.UNSIGNED_BYTE;if(o)n||(n=Ih(s.type,4*e*t));else switch(h){case f.UNSIGNED_BYTE:n||(n=new Uint8Array(4*e*t)),h=f.UNSIGNED_BYTE;break;default:n||(n=new Float32Array(4*e*t)),h=f.FLOAT;break}return a&&this.flushFramebuffer(),f.readPixels(l,c,e,t,f.RGBA,h,n),f.bindFramebuffer(f.FRAMEBUFFER,this._currentFramebuffer),n};Ne.prototype._readTexturePixels=function(s,e,t,i=-1,r=0,n=null,a=!0,o=!1,l=0,c=0){return Promise.resolve(this._readTexturePixelsSync(s,e,t,i,r,n,a,o,l,c))}});var GO=S(()=>{kr();Ne.prototype.updateDynamicIndexBuffer=function(s,e,t=0){this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(s);let i;s.is32Bits?i=e instanceof Uint32Array?e:new Uint32Array(e):i=e instanceof Uint16Array?e:new Uint16Array(e),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,i,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()};Ne.prototype.updateDynamicVertexBuffer=function(s,e,t,i){this.bindArrayBuffer(s),t===void 0&&(t=0);let r=e.byteLength||e.length;i===void 0||i>=r&&t===0?e instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,new Float32Array(e)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,e):e instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,new Float32Array(e).subarray(0,i/4)):(e instanceof ArrayBuffer?e=new Uint8Array(e,0,i):e=new Uint8Array(e.buffer,e.byteOffset,i),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,e)),this._resetVertexBufferBinding()}});var VO=S(()=>{kr();vi();Ee();Ao();Ne.prototype._createDepthStencilCubeTexture=function(s,e){let t=new Je(this,12);if(t.isCube=!0,this.webGLVersion===1)return P.Error("Depth cube texture is not supported by WebGL 1."),t;let i={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...e},r=this._gl;this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,t,!0),this._setupDepthStencilTexture(t,s,i.bilinearFiltering,i.comparisonFunction);for(let n=0;n<6;n++)i.generateStencil?r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+n,0,r.DEPTH24_STENCIL8,s,s,0,r.DEPTH_STENCIL,r.UNSIGNED_INT_24_8,null):r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+n,0,r.DEPTH_COMPONENT24,s,s,0,r.DEPTH_COMPONENT,r.UNSIGNED_INT,null);return this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,null),this._internalTexturesCache.push(t),t};Ne.prototype._setCubeMapTextureParams=function(s,e,t){let i=this._gl;i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MIN_FILTER,e?i.LINEAR_MIPMAP_LINEAR:i.LINEAR),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),s.samplingMode=e?3:2,e&&this.getCaps().textureMaxLevel&&t!==void 0&&t>0&&(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MAX_LEVEL,t),s._maxLodLevel=t),this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,null)};Ne.prototype.createCubeTexture=function(s,e,t,i,r=null,n=null,a,o=null,l=!1,c=0,f=0,h=null,u,d=!1,p=null){let m=this._gl;return this.createCubeTextureBase(s,e,t,!!i,r,n,a,o,l,c,f,h,_=>this._bindTextureDirectly(m.TEXTURE_CUBE_MAP,_,!0),(_,v)=>{let T=this.needPOTTextures?xo(v[0].width,this._caps.maxCubemapTextureSize):v[0].width,C=T,I=[m.TEXTURE_CUBE_MAP_POSITIVE_X,m.TEXTURE_CUBE_MAP_POSITIVE_Y,m.TEXTURE_CUBE_MAP_POSITIVE_Z,m.TEXTURE_CUBE_MAP_NEGATIVE_X,m.TEXTURE_CUBE_MAP_NEGATIVE_Y,m.TEXTURE_CUBE_MAP_NEGATIVE_Z];this._bindTextureDirectly(m.TEXTURE_CUBE_MAP,_,!0),this._unpackFlipY(!1);let R=a?this._getInternalFormat(a,_._useSRGBBuffer):_._useSRGBBuffer?this._glSRGBExtensionValues.SRGB8_ALPHA8:m.RGBA,b=a?this._getInternalFormat(a):m.RGBA;_._useSRGBBuffer&&this.webGLVersion===1&&(b=R);for(let M=0;M<I.length;M++)if(v[M].width!==T||v[M].height!==C){if(this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext){P.Warn("Cannot create canvas to resize texture.");return}this._workingCanvas.width=T,this._workingCanvas.height=C,this._workingContext.drawImage(v[M],0,0,v[M].width,v[M].height,0,0,T,C),m.texImage2D(I[M],0,R,b,m.UNSIGNED_BYTE,this._workingCanvas)}else m.texImage2D(I[M],0,R,b,m.UNSIGNED_BYTE,v[M]);i||m.generateMipmap(m.TEXTURE_CUBE_MAP),this._setCubeMapTextureParams(_,!i),_.width=T,_.height=C,_.isReady=!0,a&&(_.format=a),_.onLoadedObservable.notifyObservers(_),_.onLoadedObservable.clear(),r&&r()},!!d,p)};Ne.prototype.generateMipMapsForCubemap=function(s,e=!0){if(s.generateMipMaps){let t=this._gl;this._bindTextureDirectly(t.TEXTURE_CUBE_MAP,s,!0),t.generateMipmap(t.TEXTURE_CUBE_MAP),e&&this._bindTextureDirectly(t.TEXTURE_CUBE_MAP,null)}}});var kc,dR=S(()=>{Tl();kc=class{get depthStencilTexture(){return this._depthStencilTexture}setDepthStencilTexture(e,t=!0){t&&this._depthStencilTexture&&this._depthStencilTexture.dispose(),this._depthStencilTexture=e,this._generateDepthBuffer=this._generateStencilBuffer=this._depthStencilTextureWithStencil=!1,e&&(this._generateDepthBuffer=!0,this._generateStencilBuffer=this._depthStencilTextureWithStencil=ss(e.format))}get depthStencilTextureWithStencil(){return this._depthStencilTextureWithStencil}get isCube(){return this._isCube}get isMulti(){return this._isMulti}get is2DArray(){return this.layers>0}get is3D(){return this.depth>0}get size(){return this.width}get width(){return this._size.width??this._size}get height(){return this._size.height??this._size}get layers(){return this._size.layers||0}get depth(){return this._size.depth||0}get texture(){return this._textures?.[0]??null}get textures(){return this._textures}get faceIndices(){return this._faceIndices}get layerIndices(){return this._layerIndices}getBaseArrayLayer(e){if(!this._textures)return-1;let t=this._textures[e],i=this._layerIndices?.[e]??0,r=this._faceIndices?.[e]??0;return t.isCube?i*6+r:t.is3D?0:i}get samples(){return this._samples}setSamples(e,t=!0,i=!1){if(this.samples===e&&!i)return e;let r=this._isMulti?this._engine.updateMultipleRenderTargetTextureSampleCount(this,e,t):this._engine.updateRenderTargetTextureSampleCount(this,e);return this._samples=e,r}resolveMSAATextures(){this.isMulti?this._engine.resolveMultiFramebuffer(this):this._engine.resolveFramebuffer(this)}generateMipMaps(){this._engine._currentRenderTarget===this&&this._engine.unBindFramebuffer(this,!0),this.isMulti?this._engine.generateMipMapsMultiFramebuffer(this):this._engine.generateMipMapsFramebuffer(this)}constructor(e,t,i,r,n){this._textures=null,this._faceIndices=null,this._layerIndices=null,this._samples=1,this._attachments=null,this._generateStencilBuffer=!1,this._generateDepthBuffer=!1,this._depthStencilTextureWithStencil=!1,this.disableAutomaticMSAAResolve=!1,this.resolveMSAAColors=!0,this.resolveMSAADepth=!1,this.resolveMSAAStencil=!1,this.depthReadOnly=!1,this.stencilReadOnly=!1,this._isMulti=e,this._isCube=t,this._size=i,this._engine=r,this._depthStencilTexture=null,this.label=n}setTextures(e){Array.isArray(e)?this._textures=e:e?this._textures=[e]:this._textures=null}setTexture(e,t=0,i=!0){this._textures||(this._textures=[]),this._textures[t]!==e&&(this._textures[t]&&i&&this._textures[t].dispose(),this._textures[t]=e)}setLayerAndFaceIndices(e,t){this._layerIndices=e,this._faceIndices=t}setLayerAndFaceIndex(e=0,t,i){this._layerIndices||(this._layerIndices=[]),this._faceIndices||(this._faceIndices=[]),t!==void 0&&t>=0&&(this._layerIndices[e]=t),i!==void 0&&i>=0&&(this._faceIndices[e]=i)}createDepthStencilTexture(e=0,t=!0,i=!1,r=1,n=14,a){return this._depthStencilTexture?.dispose(),this._depthStencilTextureWithStencil=i,this._depthStencilTextureLabel=a,this._depthStencilTexture=this._engine.createDepthStencilTexture(this._size,{bilinearFiltering:t,comparisonFunction:e,generateStencil:i,isCube:this._isCube,samples:r,depthTextureFormat:n,label:a},this),this._depthStencilTexture}_shareDepth(e){this.shareDepth(e)}shareDepth(e){this._depthStencilTexture&&(e._depthStencilTexture&&e._depthStencilTexture.dispose(),e._depthStencilTexture=this._depthStencilTexture,e._depthStencilTextureWithStencil=this._depthStencilTextureWithStencil,this._depthStencilTexture.incrementReferences())}_swapAndDie(e){this.texture&&this.texture._swapAndDie(e),this._textures=null,this.dispose(!0)}_cloneRenderTargetWrapper(){let e=null;if(this._isMulti){let t=this.textures;if(t&&t.length>0){let i=!1,r=t.length,n=-1,a=t[t.length-1]._source;(a===14||a===12)&&(i=!0,n=t[t.length-1].format,r--);let o=[],l=[],c=[],f=[],h=[],u=[],d=[],p={};for(let v=0;v<r;++v){let T=t[v];o.push(T.samplingMode),l.push(T.type),c.push(T.format),p[T.uniqueId]!==void 0?(f.push(-1),d.push(0)):(p[T.uniqueId]=v,T.is2DArray?(f.push(35866),d.push(T.depth)):T.isCube?(f.push(34067),d.push(0)):T.is3D?(f.push(32879),d.push(T.depth)):(f.push(3553),d.push(0))),this._faceIndices&&h.push(this._faceIndices[v]??0),this._layerIndices&&u.push(this._layerIndices[v]??0)}let m={samplingModes:o,generateMipMaps:t[0].generateMipMaps,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:this._generateStencilBuffer,generateDepthTexture:i,depthTextureFormat:n,types:l,formats:c,textureCount:r,targetTypes:f,faceIndex:h,layerIndex:u,layerCounts:d,label:this.label},_={width:this.width,height:this.height,depth:this.depth};e=this._engine.createMultipleRenderTarget(_,m);for(let v=0;v<r;++v){if(f[v]!==-1)continue;let T=p[t[v].uniqueId];e.setTexture(e.textures[T],v)}}}else{let t={};if(t.generateDepthBuffer=this._generateDepthBuffer,t.generateMipMaps=this.texture?.generateMipMaps??!1,t.generateStencilBuffer=this._generateStencilBuffer,t.samplingMode=this.texture?.samplingMode,t.type=this.texture?.type,t.format=this.texture?.format,t.noColorAttachment=!this._textures,t.label=this.label,this.isCube)e=this._engine.createRenderTargetCubeTexture(this.width,t);else{let i={width:this.width,height:this.height,layers:this.is2DArray||this.is3D?this.texture?.depth:void 0};e=this._engine.createRenderTargetTexture(i,t)}e.texture&&(e.texture.isReady=!0)}return e}_swapRenderTargetWrapper(e){if(this._textures&&e._textures)for(let t=0;t<this._textures.length;++t)this._textures[t]._swapAndDie(e._textures[t],!1),e._textures[t].isReady=!0;this._depthStencilTexture&&e._depthStencilTexture&&(this._depthStencilTexture._swapAndDie(e._depthStencilTexture),e._depthStencilTexture.isReady=!0),this._textures=null,this._depthStencilTexture=null}_rebuild(){let e=this._cloneRenderTargetWrapper();if(e){if(this._depthStencilTexture){let t=this._depthStencilTexture.samplingMode,i=this._depthStencilTexture.format,r=t===2||t===3||t===11;e.createDepthStencilTexture(this._depthStencilTexture._comparisonFunction,r,this._depthStencilTextureWithStencil,this._depthStencilTexture.samples,i,this._depthStencilTextureLabel)}this.samples>1&&e.setSamples(this.samples),e._swapRenderTargetWrapper(this),e.dispose()}}releaseTextures(){if(this._textures)for(let e=0;e<this._textures.length;++e)this._textures[e].dispose();this._textures=null}dispose(e=!1){e||(this._depthStencilTexture?.dispose(),this._depthStencilTexture=null,this.releaseTextures()),this._engine._releaseRenderTargetWrapper(this)}}});var Jp,kO=S(()=>{dR();Tl();Jp=class extends kc{setDepthStencilTexture(e,t=!0){if(super.setDepthStencilTexture(e,t),!e)return;let i=this._engine,r=this._context,n=e._hardwareTexture;if(n&&e._autoMSAAManagement&&this._MSAAFramebuffer){let a=i._currentFramebuffer;i._bindUnboundFramebuffer(this._MSAAFramebuffer),r.framebufferRenderbuffer(r.FRAMEBUFFER,ss(e.format)?r.DEPTH_STENCIL_ATTACHMENT:r.DEPTH_ATTACHMENT,r.RENDERBUFFER,n.getMSAARenderBuffer()),i._bindUnboundFramebuffer(a)}}constructor(e,t,i,r,n){super(e,t,i,r),this._framebuffer=null,this._depthStencilBuffer=null,this._MSAAFramebuffer=null,this._colorTextureArray=null,this._depthStencilTextureArray=null,this._disposeOnlyFramebuffers=!1,this._currentLOD=0,this._context=n}_cloneRenderTargetWrapper(){let e=null;return this._colorTextureArray&&this._depthStencilTextureArray?(e=this._engine.createMultiviewRenderTargetTexture(this.width,this.height),e.texture.isReady=!0):e=super._cloneRenderTargetWrapper(),e}_swapRenderTargetWrapper(e){super._swapRenderTargetWrapper(e),e._framebuffer=this._framebuffer,e._depthStencilBuffer=this._depthStencilBuffer,e._MSAAFramebuffer=this._MSAAFramebuffer,e._colorTextureArray=this._colorTextureArray,e._depthStencilTextureArray=this._depthStencilTextureArray,this._framebuffer=this._depthStencilBuffer=this._MSAAFramebuffer=this._colorTextureArray=this._depthStencilTextureArray=null}createDepthStencilTexture(e=0,t=!0,i=!1,r=1,n=14,a){if(this._depthStencilBuffer){let o=this._engine,l=o._currentFramebuffer,c=this._context;o._bindUnboundFramebuffer(this._framebuffer),c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_STENCIL_ATTACHMENT,c.RENDERBUFFER,null),c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.RENDERBUFFER,null),c.framebufferRenderbuffer(c.FRAMEBUFFER,c.STENCIL_ATTACHMENT,c.RENDERBUFFER,null),o._bindUnboundFramebuffer(l),c.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null}return super.createDepthStencilTexture(e,t,i,r,n,a)}shareDepth(e){super.shareDepth(e);let t=this._context,i=this._depthStencilBuffer,r=e._MSAAFramebuffer||e._framebuffer,n=this._engine;e._depthStencilBuffer&&e._depthStencilBuffer!==i&&t.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=i;let a=e._generateStencilBuffer?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;n._bindUnboundFramebuffer(r),t.framebufferRenderbuffer(t.FRAMEBUFFER,a,t.RENDERBUFFER,i),n._bindUnboundFramebuffer(null)}_bindTextureRenderTarget(e,t=0,i,r=0){let n=e._hardwareTexture;if(!n)return;let a=this._framebuffer,o=this._engine,l=o._currentFramebuffer;o._bindUnboundFramebuffer(a);let c;if(o.webGLVersion>1){let f=this._context;c=f["COLOR_ATTACHMENT"+t],e.is2DArray||e.is3D?(i=i??this.layerIndices?.[t]??0,f.framebufferTextureLayer(f.FRAMEBUFFER,c,n.underlyingResource,r,i)):e.isCube?(i=i??this.faceIndices?.[t]??0,f.framebufferTexture2D(f.FRAMEBUFFER,c,f.TEXTURE_CUBE_MAP_POSITIVE_X+i,n.underlyingResource,r)):f.framebufferTexture2D(f.FRAMEBUFFER,c,f.TEXTURE_2D,n.underlyingResource,r)}else{let f=this._context;c=f["COLOR_ATTACHMENT"+t+"_WEBGL"];let h=i!==void 0?f.TEXTURE_CUBE_MAP_POSITIVE_X+i:f.TEXTURE_2D;f.framebufferTexture2D(f.FRAMEBUFFER,c,h,n.underlyingResource,r)}if(e._autoMSAAManagement&&this._MSAAFramebuffer){let f=this._context;o._bindUnboundFramebuffer(this._MSAAFramebuffer),f.framebufferRenderbuffer(f.FRAMEBUFFER,c,f.RENDERBUFFER,n.getMSAARenderBuffer())}o._bindUnboundFramebuffer(l)}setTexture(e,t=0,i=!0){super.setTexture(e,t,i),this._bindTextureRenderTarget(e,t)}setLayerAndFaceIndices(e,t){if(super.setLayerAndFaceIndices(e,t),!this.textures||!this.layerIndices||!this.faceIndices)return;let i=this._attachments?.length??this.textures.length;for(let r=0;r<i;r++){let n=this.textures[r];n&&(n.is2DArray||n.is3D?this._bindTextureRenderTarget(n,r,this.layerIndices[r]):n.isCube?this._bindTextureRenderTarget(n,r,this.faceIndices[r]):this._bindTextureRenderTarget(n,r))}}setLayerAndFaceIndex(e=0,t,i){if(super.setLayerAndFaceIndex(e,t,i),!this.textures||!this.layerIndices||!this.faceIndices)return;let r=this.textures[e];r.is2DArray||r.is3D?this._bindTextureRenderTarget(this.textures[e],e,this.layerIndices[e]):r.isCube&&this._bindTextureRenderTarget(this.textures[e],e,this.faceIndices[e])}resolveMSAATextures(){let e=this._engine,t=e._currentFramebuffer;e._bindUnboundFramebuffer(this._MSAAFramebuffer),super.resolveMSAATextures(),e._bindUnboundFramebuffer(t)}dispose(e=this._disposeOnlyFramebuffers){let t=this._context;e||(this._colorTextureArray&&(this._context.deleteTexture(this._colorTextureArray),this._colorTextureArray=null),this._depthStencilTextureArray&&(this._context.deleteTexture(this._depthStencilTextureArray),this._depthStencilTextureArray=null)),this._framebuffer&&(t.deleteFramebuffer(this._framebuffer),this._framebuffer=null),this._depthStencilBuffer&&(t.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null),this._MSAAFramebuffer&&(t.deleteFramebuffer(this._MSAAFramebuffer),this._MSAAFramebuffer=null),super.dispose(e)}}});var $p=S(()=>{Jt();k.prototype.createDepthStencilTexture=function(s,e,t){if(e.isCube){let i=s.width||s;return this._createDepthStencilCubeTexture(i,e)}else return this._createDepthStencilTexture(s,e,t)}});var WO=S(()=>{vi();Ee();kr();kO();Tl();$p();Ne.prototype._createHardwareRenderTargetWrapper=function(s,e,t){let i=new Jp(s,e,t,this,this._gl);return this._renderTargetWrapperCache.push(i),i};Ne.prototype.createRenderTargetTexture=function(s,e){let t=this._createHardwareRenderTargetWrapper(!1,!1,s),i=!0,r=!1,n=!1,a,o=1,l;e!==void 0&&typeof e=="object"&&(i=e.generateDepthBuffer??!0,r=!!e.generateStencilBuffer,n=!!e.noColorAttachment,a=e.colorAttachment,o=e.samples??1,l=e.label);let c=a||(n?null:this._createInternalTexture(s,e,!0,5)),f=s.width||s,h=s.height||s,u=this._currentFramebuffer,d=this._gl,p=d.createFramebuffer();if(this._bindUnboundFramebuffer(p),t._depthStencilBuffer=this._setupFramebufferDepthAttachments(r,i,f,h),c&&!c.is2DArray&&!c.is3D&&d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_2D,c._hardwareTexture.underlyingResource,0),this._bindUnboundFramebuffer(u),t.label=l??"RenderTargetWrapper",t._framebuffer=p,t._generateDepthBuffer=i,t._generateStencilBuffer=r,t.setTextures(c),!a)this.updateRenderTargetTextureSampleCount(t,o);else if(t._samples=a.samples,a.samples>1){let m=a._hardwareTexture.getMSAARenderBuffer(0);t._MSAAFramebuffer=d.createFramebuffer(),this._bindUnboundFramebuffer(t._MSAAFramebuffer),d.framebufferRenderbuffer(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.RENDERBUFFER,m),this._bindUnboundFramebuffer(null)}return t};Ne.prototype._createDepthStencilTexture=function(s,e,t){let i=this._gl,r=s.layers||0,n=s.depth||0,a=i.TEXTURE_2D;r!==0?a=i.TEXTURE_2D_ARRAY:n!==0&&(a=i.TEXTURE_3D);let o=new Je(this,12);if(o.label=e.label,!this._caps.depthTextureExtension)return P.Error("Depth texture is not supported by your browser or hardware."),o;let l={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...e};if(this._bindTextureDirectly(a,o,!0),this._setupDepthStencilTexture(o,s,l.comparisonFunction===0?!1:l.bilinearFiltering,l.comparisonFunction,l.samples),l.depthTextureFormat!==void 0){if(l.depthTextureFormat!==15&&l.depthTextureFormat!==16&&l.depthTextureFormat!==17&&l.depthTextureFormat!==13&&l.depthTextureFormat!==14&&l.depthTextureFormat!==18)return P.Error(`Depth texture ${l.depthTextureFormat} format is not supported.`),o;o.format=l.depthTextureFormat}else o.format=l.generateStencil?13:16;let c=ss(o.format),f=this._getWebGLTextureTypeFromDepthTextureFormat(o.format),h=c?i.DEPTH_STENCIL:i.DEPTH_COMPONENT,u=this._getInternalFormatFromDepthTextureFormat(o.format,!0,c);return o.is2DArray?i.texImage3D(a,0,u,o.width,o.height,r,0,h,f,null):o.is3D?i.texImage3D(a,0,u,o.width,o.height,n,0,h,f,null):i.texImage2D(a,0,u,o.width,o.height,0,h,f,null),this._bindTextureDirectly(a,null),this._internalTexturesCache.push(o),t._depthStencilBuffer&&(i.deleteRenderbuffer(t._depthStencilBuffer),t._depthStencilBuffer=null),this._bindUnboundFramebuffer(t._MSAAFramebuffer??t._framebuffer),t._generateStencilBuffer=c,t._depthStencilTextureWithStencil=c,t._depthStencilBuffer=this._setupFramebufferDepthAttachments(t._generateStencilBuffer,t._generateDepthBuffer,t.width,t.height,t.samples,o.format),this._bindUnboundFramebuffer(null),o};Ne.prototype.updateRenderTargetTextureSampleCount=function(s,e){if(this.webGLVersion<2||!s)return 1;if(s.samples===e)return e;let t=this._gl;e=Math.min(e,this.getCaps().maxMSAASamples),s._depthStencilBuffer&&(t.deleteRenderbuffer(s._depthStencilBuffer),s._depthStencilBuffer=null),s._MSAAFramebuffer&&(t.deleteFramebuffer(s._MSAAFramebuffer),s._MSAAFramebuffer=null);let i=s.texture?._hardwareTexture;if(i?.releaseMSAARenderBuffers(),s.texture&&e>1&&typeof t.renderbufferStorageMultisample=="function"){let n=t.createFramebuffer();if(!n)throw new Error("Unable to create multi sampled framebuffer");s._MSAAFramebuffer=n,this._bindUnboundFramebuffer(s._MSAAFramebuffer);let a=this._createRenderBuffer(s.texture.width,s.texture.height,e,-1,this._getRGBABufferInternalSizedFormat(s.texture.type,s.texture.format,s.texture._useSRGBBuffer),t.COLOR_ATTACHMENT0,!1);if(!a)throw new Error("Unable to create multi sampled framebuffer");i?.addMSAARenderBuffer(a)}this._bindUnboundFramebuffer(s._MSAAFramebuffer??s._framebuffer),s.texture&&(s.texture.samples=e),s._samples=e;let r=s._depthStencilTexture?s._depthStencilTexture.format:void 0;return s._depthStencilBuffer=this._setupFramebufferDepthAttachments(s._generateStencilBuffer,s._generateDepthBuffer,s.width,s.height,e,r),this._bindUnboundFramebuffer(null),e};Ne.prototype._setupDepthStencilTexture=function(s,e,t,i,r=1){let n=e.width??e,a=e.height??e,o=e.layers||0,l=e.depth||0;s.baseWidth=n,s.baseHeight=a,s.width=n,s.height=a,s.is2DArray=o>0,s.depth=o||l,s.isReady=!0,s.samples=r,s.generateMipMaps=!1,s.samplingMode=t?2:1,s.type=0,s._comparisonFunction=i;let c=this._gl,f=this._getTextureTarget(s),h=this._getSamplingParameters(s.samplingMode,!1);c.texParameteri(f,c.TEXTURE_MAG_FILTER,h.mag),c.texParameteri(f,c.TEXTURE_MIN_FILTER,h.min),c.texParameteri(f,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(f,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE),this.webGLVersion>1&&(i===0?(c.texParameteri(f,c.TEXTURE_COMPARE_FUNC,515),c.texParameteri(f,c.TEXTURE_COMPARE_MODE,c.NONE)):(c.texParameteri(f,c.TEXTURE_COMPARE_FUNC,i),c.texParameteri(f,c.TEXTURE_COMPARE_MODE,c.COMPARE_REF_TO_TEXTURE)))}});var HO=S(()=>{kr();Ne.prototype.setDepthStencilTexture=function(s,e,t,i){s!==void 0&&(e&&(this._boundUniforms[s]=e),!t||!t.depthStencilTexture?this._setTexture(s,null,void 0,void 0,i):this._setTexture(s,t,!1,!0,i))}});var zO=S(()=>{vi();Ee();kr();Ne.prototype.createRenderTargetCubeTexture=function(s,e){let t=this._createHardwareRenderTargetWrapper(!1,!0,s),i={generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,...e};i.generateStencilBuffer=i.generateDepthBuffer&&i.generateStencilBuffer,(i.type===1&&!this._caps.textureFloatLinearFiltering||i.type===2&&!this._caps.textureHalfFloatLinearFiltering)&&(i.samplingMode=1);let r=this._gl,n=new Je(this,5);this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,n,!0);let a=this._getSamplingParameters(i.samplingMode,i.generateMipMaps);i.type===1&&!this._caps.textureFloat&&(i.type=0,P.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MAG_FILTER,a.mag),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MIN_FILTER,a.min),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE);for(let l=0;l<6;l++)r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,0,this._getRGBABufferInternalSizedFormat(i.type,i.format),s,s,0,this._getInternalFormat(i.format),this._getWebGLTextureType(i.type),null);let o=r.createFramebuffer();return this._bindUnboundFramebuffer(o),t._depthStencilBuffer=this._setupFramebufferDepthAttachments(i.generateStencilBuffer,i.generateDepthBuffer,s,s),i.generateMipMaps&&r.generateMipmap(r.TEXTURE_CUBE_MAP),this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,null),this._bindUnboundFramebuffer(null),t._framebuffer=o,t._generateDepthBuffer=i.generateDepthBuffer,t._generateStencilBuffer=i.generateStencilBuffer,n.width=s,n.height=s,n.isReady=!0,n.isCube=!0,n.samples=1,n.generateMipMaps=i.generateMipMaps,n.samplingMode=i.samplingMode,n.type=i.type,n.format=i.format,this._internalTexturesCache.push(n),t.setTextures(n),t}});var XO=S(()=>{kr();vi();Ee();gl();ma();Ne.prototype.createPrefilteredCubeTexture=function(s,e,t,i,r=null,n=null,a,o=null,l=!0){let c=async f=>{if(!f){r&&r(null);return}let h=f.texture;if(l?f.info.sphericalPolynomial&&(h._sphericalPolynomial=f.info.sphericalPolynomial):h._sphericalPolynomial=new Ur,h._source=9,this.getCaps().textureLOD){r&&r(h);return}let u=3,d=this._gl,p=f.width;if(!p)return;let{DDSTools:m}=await Promise.resolve().then(()=>(pR(),YO)),_=[];for(let v=0;v<u;v++){let C=1-v/(u-1),I=i,R=Math.log2(p)*t+i,b=I+(R-I)*C,M=Math.round(Math.min(Math.max(b,0),R)),F=new Je(this,2);if(F.type=h.type,F.format=h.format,F.width=Math.pow(2,Math.max(Math.log2(p)-M,0)),F.height=F.width,F.isCube=!0,F._cachedWrapU=0,F._cachedWrapV=0,this._bindTextureDirectly(d.TEXTURE_CUBE_MAP,F,!0),F.samplingMode=2,d.texParameteri(d.TEXTURE_CUBE_MAP,d.TEXTURE_MAG_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_CUBE_MAP,d.TEXTURE_MIN_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_CUBE_MAP,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_CUBE_MAP,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),f.isDDS){let D=f.info,$=f.data;this._unpackFlipY(D.isCompressed),m.UploadDDSLevels(this,F,$,D,!0,6,M)}else P.Warn("DDS is the only prefiltered cube map supported so far.");this._bindTextureDirectly(d.TEXTURE_CUBE_MAP,null);let U=new nt(e);U._isCube=!0,U._texture=F,F.isReady=!0,_.push(U)}h._lodTextureHigh=_[2],h._lodTextureMid=_[1],h._lodTextureLow=_[0],r&&r(h)};return this.createCubeTexture(s,e,null,!1,c,n,a,o,l,t,i)}});var KO=S(()=>{kr();Qp();Ne.prototype.createUniformBuffer=function(s,e){let t=this._gl.createBuffer();if(!t)throw new Error("Unable to create uniform buffer");let i=new yn(t);return this.bindUniformBuffer(i),s instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,s,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(s),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),i.references=1,i};Ne.prototype.createDynamicUniformBuffer=function(s,e){let t=this._gl.createBuffer();if(!t)throw new Error("Unable to create dynamic uniform buffer");let i=new yn(t);return this.bindUniformBuffer(i),s instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,s,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(s),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),i.references=1,i};Ne.prototype.updateUniformBuffer=function(s,e,t,i){this.bindUniformBuffer(s),t===void 0&&(t=0),i===void 0?e instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,t,e):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,t,new Float32Array(e)):e instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,e.subarray(t,t+i)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(e).subarray(t,t+i)),this.bindUniformBuffer(null)};Ne.prototype.bindUniformBuffer=function(s){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,s?s.underlyingResource:null)};Ne.prototype.bindUniformBufferBase=function(s,e,t){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,e,s?s.underlyingResource:null)};Ne.prototype.bindUniformBlock=function(s,e,t){let i=s.program,r=this._gl.getUniformBlockIndex(i,e);r!==4294967295&&this._gl.uniformBlockBinding(i,r,t)}});var mR=S(()=>{Cs();Jt();k.prototype.displayLoadingUI=function(){if(!jt())return;let s=this.loadingScreen;s&&s.displayLoadingUI()};k.prototype.hideLoadingUI=function(){if(!jt())return;let s=this._loadingScreen;s&&s.hideLoadingUI()};Object.defineProperty(k.prototype,"loadingScreen",{get:function(){return!this._loadingScreen&&this._renderingCanvas&&(this._loadingScreen=k.DefaultLoadingScreenFactory(this._renderingCanvas)),this._loadingScreen},set:function(s){this._loadingScreen=s},enumerable:!0,configurable:!0});Object.defineProperty(k.prototype,"loadingUIText",{set:function(s){this.loadingScreen.loadingUIText=s},enumerable:!0,configurable:!0});Object.defineProperty(k.prototype,"loadingUIBackgroundColor",{set:function(s){this.loadingScreen.loadingUIBackgroundColor=s},enumerable:!0,configurable:!0})});var _R=S(()=>{Jt();k.prototype.getInputElement=function(){return this._renderingCanvas};k.prototype.getRenderingCanvasClientRect=function(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null};k.prototype.getInputElementClientRect=function(){return this._renderingCanvas?this.getInputElement().getBoundingClientRect():null};k.prototype.getAspectRatio=function(s,e=!1){let t=s.viewport;return this.getRenderWidth(e)*t.width/(this.getRenderHeight(e)*t.height)};k.prototype.getScreenAspectRatio=function(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)};k.prototype._verifyPointerLock=function(){this._onPointerLockChange?.()}});var em=S(()=>{Jt();k.prototype.setAlphaEquation=function(s,e=0){if(this._alphaEquation[e]!==s){switch(s){case 0:this._alphaState.setAlphaEquationParameters(32774,32774,e);break;case 1:this._alphaState.setAlphaEquationParameters(32778,32778,e);break;case 2:this._alphaState.setAlphaEquationParameters(32779,32779,e);break;case 3:this._alphaState.setAlphaEquationParameters(32776,32776,e);break;case 4:this._alphaState.setAlphaEquationParameters(32775,32775,e);break;case 5:this._alphaState.setAlphaEquationParameters(32775,32774,e);break}this._alphaEquation[e]=s}}});var gR=S(()=>{Jt();em();k.prototype.getInputElement=function(){return this._renderingCanvas};k.prototype.getDepthFunction=function(){return this._depthCullingState.depthFunc};k.prototype.setDepthFunction=function(s){this._depthCullingState.depthFunc=s};k.prototype.setDepthFunctionToGreater=function(){this.setDepthFunction(516)};k.prototype.setDepthFunctionToGreaterOrEqual=function(){this.setDepthFunction(518)};k.prototype.setDepthFunctionToLess=function(){this.setDepthFunction(513)};k.prototype.setDepthFunctionToLessOrEqual=function(){this.setDepthFunction(515)};k.prototype.getDepthWrite=function(){return this._depthCullingState.depthMask};k.prototype.setDepthWrite=function(s){this._depthCullingState.depthMask=s};k.prototype.setAlphaConstants=function(s,e,t,i){this._alphaState.setAlphaBlendConstants(s,e,t,i)};k.prototype.getAlphaMode=function(s=0){return this._alphaMode[s]};k.prototype.getAlphaEquation=function(s=0){return this._alphaEquation[s]}});var vR=S(()=>{Jt();em();k.prototype.getStencilBuffer=function(){return this._stencilState.stencilTest};k.prototype.setStencilBuffer=function(s){this._stencilState.stencilTest=s};k.prototype.getStencilMask=function(){return this._stencilState.stencilMask};k.prototype.setStencilMask=function(s){this._stencilState.stencilMask=s};k.prototype.getStencilFunction=function(){return this._stencilState.stencilFunc};k.prototype.getStencilBackFunction=function(){return this._stencilState.stencilBackFunc};k.prototype.getStencilFunctionReference=function(){return this._stencilState.stencilFuncRef};k.prototype.getStencilFunctionMask=function(){return this._stencilState.stencilFuncMask};k.prototype.setStencilFunction=function(s){this._stencilState.stencilFunc=s};k.prototype.setStencilBackFunction=function(s){this._stencilState.stencilBackFunc=s};k.prototype.setStencilFunctionReference=function(s){this._stencilState.stencilFuncRef=s};k.prototype.setStencilFunctionMask=function(s){this._stencilState.stencilFuncMask=s};k.prototype.getStencilOperationFail=function(){return this._stencilState.stencilOpStencilFail};k.prototype.getStencilBackOperationFail=function(){return this._stencilState.stencilBackOpStencilFail};k.prototype.getStencilOperationDepthFail=function(){return this._stencilState.stencilOpDepthFail};k.prototype.getStencilBackOperationDepthFail=function(){return this._stencilState.stencilBackOpDepthFail};k.prototype.getStencilOperationPass=function(){return this._stencilState.stencilOpStencilDepthPass};k.prototype.getStencilBackOperationPass=function(){return this._stencilState.stencilBackOpStencilDepthPass};k.prototype.setStencilOperationFail=function(s){this._stencilState.stencilOpStencilFail=s};k.prototype.setStencilBackOperationFail=function(s){this._stencilState.stencilBackOpStencilFail=s};k.prototype.setStencilOperationDepthFail=function(s){this._stencilState.stencilOpDepthFail=s};k.prototype.setStencilBackOperationDepthFail=function(s){this._stencilState.stencilBackOpDepthFail=s};k.prototype.setStencilOperationPass=function(s){this._stencilState.stencilOpStencilDepthPass=s};k.prototype.setStencilBackOperationPass=function(s){this._stencilState.stencilBackOpStencilDepthPass=s};k.prototype.cacheStencilState=function(){this._cachedStencilBuffer=this.getStencilBuffer(),this._cachedStencilFunction=this.getStencilFunction(),this._cachedStencilMask=this.getStencilMask(),this._cachedStencilOperationPass=this.getStencilOperationPass(),this._cachedStencilOperationFail=this.getStencilOperationFail(),this._cachedStencilOperationDepthFail=this.getStencilOperationDepthFail(),this._cachedStencilReference=this.getStencilFunctionReference()};k.prototype.restoreStencilState=function(){this.setStencilFunction(this._cachedStencilFunction),this.setStencilMask(this._cachedStencilMask),this.setStencilBuffer(this._cachedStencilBuffer),this.setStencilOperationPass(this._cachedStencilOperationPass),this.setStencilOperationFail(this._cachedStencilOperationFail),this.setStencilOperationDepthFail(this._cachedStencilOperationDepthFail),this.setStencilFunctionReference(this._cachedStencilReference)}});var SR=S(()=>{Jt();k.prototype.getRenderPassNames=function(){return this._renderPassNames};k.prototype.getCurrentRenderPassName=function(){return this._renderPassNames[this.currentRenderPassId]};k.prototype.createRenderPassId=function(s){let e=++k._RenderPassIdCounter;return this._renderPassNames[e]=s??"NONAME",e};k.prototype.releaseRenderPassId=function(s){this._renderPassNames[s]=void 0;for(let e=0;e<this.scenes.length;++e){let t=this.scenes[e];for(let i=0;i<t.meshes.length;++i){let r=t.meshes[i];if(r.subMeshes)for(let n=0;n<r.subMeshes.length;++n)r.subMeshes[n]._removeDrawWrapper(s)}}}});function cq(s){!s||!s.setAttribute||(s.setAttribute("touch-action","none"),s.style.touchAction="none",s.style.webkitTapHighlightColor="transparent")}function tm(s,e,t){s._onCanvasFocus=()=>{s.onCanvasFocusObservable.notifyObservers(s)},s._onCanvasBlur=()=>{s.onCanvasBlurObservable.notifyObservers(s)},s._onCanvasContextMenu=r=>{s.disableContextMenu&&r.preventDefault()},e.addEventListener("focus",s._onCanvasFocus),e.addEventListener("blur",s._onCanvasBlur),e.addEventListener("contextmenu",s._onCanvasContextMenu),s._onBlur=()=>{s.disablePerformanceMonitorInBackground&&s.performanceMonitor.disable(),s._windowIsBackground=!0},s._onFocus=()=>{s.disablePerformanceMonitorInBackground&&s.performanceMonitor.enable(),s._windowIsBackground=!1},s._onCanvasPointerOut=r=>{document.elementFromPoint(r.clientX,r.clientY)!==e&&s.onCanvasPointerOutObservable.notifyObservers(r)};let i=s.getHostWindow();i&&typeof i.addEventListener=="function"&&(i.addEventListener("blur",s._onBlur),i.addEventListener("focus",s._onFocus)),e.addEventListener("pointerout",s._onCanvasPointerOut),t.doNotHandleTouchAction||cq(e),!k.audioEngine&&t.audioEngine&&k.AudioEngineFactory&&(k.audioEngine=k.AudioEngineFactory(s.getRenderingCanvas(),s.getAudioContext(),s.getAudioDestination())),mo()&&(s._onFullscreenChange=()=>{s.isFullscreen=!!document.fullscreenElement,s.isFullscreen&&s._pointerLockRequested&&e&&Gh(e)},document.addEventListener("fullscreenchange",s._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",s._onFullscreenChange,!1),s._onPointerLockChange=()=>{s.isPointerLock=document.pointerLockElement===e},document.addEventListener("pointerlockchange",s._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",s._onPointerLockChange,!1)),s.enableOfflineSupport=k.OfflineProviderFactory!==void 0,s._deterministicLockstep=!!t.deterministicLockstep,s._lockstepMaxSteps=t.lockstepMaxSteps||0,s._timeStep=t.timeStep||1/60}function im(s,e){Z.Instances.length===1&&k.audioEngine&&(k.audioEngine.dispose(),k.audioEngine=null);let t=s.getHostWindow();t&&typeof t.removeEventListener=="function"&&(t.removeEventListener("blur",s._onBlur),t.removeEventListener("focus",s._onFocus)),e&&(e.removeEventListener("focus",s._onCanvasFocus),e.removeEventListener("blur",s._onCanvasBlur),e.removeEventListener("pointerout",s._onCanvasPointerOut),e.removeEventListener("contextmenu",s._onCanvasContextMenu)),mo()&&(document.removeEventListener("fullscreenchange",s._onFullscreenChange),document.removeEventListener("mozfullscreenchange",s._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",s._onFullscreenChange),document.removeEventListener("msfullscreenchange",s._onFullscreenChange),document.removeEventListener("pointerlockchange",s._onPointerLockChange),document.removeEventListener("mspointerlockchange",s._onPointerLockChange),document.removeEventListener("mozpointerlockchange",s._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",s._onPointerLockChange))}function rm(s){let e=document.createElement("span");e.textContent="Hg",e.style.font=s;let t=document.createElement("div");t.style.display="inline-block",t.style.width="1px",t.style.height="0px",t.style.verticalAlign="bottom";let i=document.createElement("div");i.style.whiteSpace="nowrap",i.appendChild(e),i.appendChild(t),document.body.appendChild(i);let r=0,n=0;try{n=t.getBoundingClientRect().top-e.getBoundingClientRect().top,t.style.verticalAlign="baseline",r=t.getBoundingClientRect().top-e.getBoundingClientRect().top}finally{document.body.removeChild(i)}return{ascent:r,height:n,descent:n-r}}async function sm(s,e,t){return await new Promise((i,r)=>{let n=new Image;n.onload=()=>{n.decode().then(()=>{s.createImageBitmap(n,t).then(a=>{i(a)})})},n.onerror=()=>{r(`Error loading image ${n.src}`)},n.src=e})}function nm(s,e,t,i){let n=s.createCanvas(t,i).getContext("2d");if(!n)throw new Error("Unable to get 2d context for resizeImageBitmap");return n.drawImage(e,0,0),n.getImageData(0,0,t,i).data}function am(s){let e=s.requestFullscreen||s.webkitRequestFullscreen;e&&e.call(s)}function om(){let s=document;document.exitFullscreen?document.exitFullscreen():s.webkitCancelFullScreen&&s.webkitCancelFullScreen()}function Gh(s){if(s.requestPointerLock){let e=s.requestPointerLock();e instanceof Promise?e.then(()=>{s.focus()}).catch(()=>{}):s.focus()}}function lm(){document.exitPointerLock&&document.exitPointerLock()}var ER=S(()=>{Cs();Jt();gt()});var sr,Wc=S(()=>{zs();sr=class s{get min(){return this._min}get max(){return this._max}get average(){return this._average}get lastSecAverage(){return this._lastSecAverage}get current(){return this._current}get total(){return this._totalAccumulated}get count(){return this._totalValueCount}constructor(){this._startMonitoringTime=0,this._min=0,this._max=0,this._average=0,this._lastSecAverage=0,this._current=0,this._totalValueCount=0,this._totalAccumulated=0,this._lastSecAccumulated=0,this._lastSecTime=0,this._lastSecValueCount=0}fetchNewFrame(){this._totalValueCount++,this._current=0,this._lastSecValueCount++}addCount(e,t){s.Enabled&&(this._current+=e,t&&this._fetchResult())}beginMonitoring(){s.Enabled&&(this._startMonitoringTime=Zt.Now)}endMonitoring(e=!0){if(!s.Enabled)return;e&&this.fetchNewFrame();let t=Zt.Now;this._current=t-this._startMonitoringTime,e&&this._fetchResult()}endFrame(){this._fetchResult()}_fetchResult(){this._totalAccumulated+=this._current,this._lastSecAccumulated+=this._current,this._min=Math.min(this._min,this._current),this._max=Math.max(this._max,this._current),this._average=this._totalAccumulated/this._totalValueCount;let e=Zt.Now;e-this._lastSecTime>1e3&&(this._lastSecAverage=this._lastSecAccumulated/this._lastSecValueCount,this._lastSecTime=e,this._lastSecAccumulated=0,this._lastSecValueCount=0)}};sr.Enabled=!0});var qO={};V(qO,{Engine:()=>ee});var ee,Sa=S(()=>{vi();gt();kr();uR();Qp();Ee();nR();LO();BO();UO();GO();VO();WO();HO();zO();XO();KO();mR();_R();gR();vR();SR();$p();Jt();ER();Wc();ys();ee=class s extends Ne{static get NpmPackage(){return k.NpmPackage}static get Version(){return k.Version}static get Instances(){return Z.Instances}static get LastCreatedEngine(){return Z.LastCreatedEngine}static get LastCreatedScene(){return Z.LastCreatedScene}static DefaultLoadingScreenFactory(e){return k.DefaultLoadingScreenFactory(e)}get _supportsHardwareTextureRescaling(){return!!s._RescalePostProcessFactory}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}get performanceMonitor(){return this._performanceMonitor}constructor(e,t,i,r=!1){super(e,t,i,r),this.customAnimationFrameRequester=null,this._performanceMonitor=new Vc,this._drawCalls=new sr,e&&(this._features.supportRenderPasses=!0,i=this._creationOptions)}_initGLContext(){super._initGLContext(),this._rescalePostProcess=null}_sharedInit(e){super._sharedInit(e),tm(this,e,this._creationOptions)}resizeImageBitmap(e,t,i){return nm(this,e,t,i)}async _createImageBitmapFromSource(e,t){return await sm(this,e,t)}switchFullscreen(e){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(e)}enterFullscreen(e){this.isFullscreen||(this._pointerLockRequested=e,this._renderingCanvas&&am(this._renderingCanvas))}exitFullscreen(){this.isFullscreen&&om()}setDitheringState(e){e?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)}setRasterizerState(e){e?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)}setDirectViewport(e,t,i,r){let n=this._cachedViewport;return this._cachedViewport=null,this._viewport(e,t,i,r),n}scissorClear(e,t,i,r,n){this.enableScissor(e,t,i,r),this.clear(n,!0,!0,!0),this.disableScissor()}enableScissor(e,t,i,r){let n=this._gl;n.enable(n.SCISSOR_TEST),n.scissor(e,t,i,r)}disableScissor(){let e=this._gl;e.disable(e.SCISSOR_TEST)}async _loadFileAsync(e,t,i){return await new Promise((r,n)=>{this._loadFile(e,a=>{r(a)},void 0,t,i,(a,o)=>{n(o)})})}getVertexShaderSource(e){let t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[0]):null}getFragmentShaderSource(e){let t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[1]):null}set framebufferDimensionsObject(e){this._framebufferDimensionsObject=e,this._framebufferDimensionsObject&&this.onResizeObservable.notifyObservers(this)}_rebuildBuffers(){for(let e of this.scenes)e.resetCachedMaterial(),e._rebuildGeometries();for(let e of this._virtualScenes)e.resetCachedMaterial(),e._rebuildGeometries();super._rebuildBuffers()}getFontOffset(e){return rm(e)}_cancelFrame(){if(this.customAnimationFrameRequester){if(this._frameHandler!==0){this._frameHandler=0;let{cancelAnimationFrame:e}=this.customAnimationFrameRequester;e&&e(this.customAnimationFrameRequester.requestID)}}else super._cancelFrame()}_renderLoop(e){this._processFrame(e),this._activeRenderLoops.length>0&&this._frameHandler===0&&(this.customAnimationFrameRequester?(this.customAnimationFrameRequester.requestID=this._queueNewFrame(this.customAnimationFrameRequester.renderFunction||this._boundRenderFunction,this.customAnimationFrameRequester),this._frameHandler=this.customAnimationFrameRequester.requestID):this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()))}enterPointerlock(){this._renderingCanvas&&Gh(this._renderingCanvas)}exitPointerlock(){lm()}beginFrame(){this._measureFps(),super.beginFrame()}_deletePipelineContext(e){let t=e;t&&t.program&&t.transformFeedback&&(this.deleteTransformFeedback(t.transformFeedback),t.transformFeedback=null),super._deletePipelineContext(e)}createShaderProgram(e,t,i,r,n,a=null){n=n||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);let o=super.createShaderProgram(e,t,i,r,n,a);return this.onAfterShaderCompilationObservable.notifyObservers(this),o}_createShaderProgram(e,t,i,r,n=null){let a=r.createProgram();if(e.program=a,!a)throw new Error("Unable to create program");if(r.attachShader(a,t),r.attachShader(a,i),this.webGLVersion>1&&n){let o=this.createTransformFeedback();this.bindTransformFeedback(o),this.setTranformFeedbackVaryings(a,n),e.transformFeedback=o}return r.linkProgram(a),this.webGLVersion>1&&n&&this.bindTransformFeedback(null),e.context=r,e.vertexShader=t,e.fragmentShader=i,e.isParallelCompiled||this._finalizePipelineContext(e),a}_releaseTexture(e){super._releaseTexture(e)}_releaseRenderTargetWrapper(e){super._releaseRenderTargetWrapper(e);for(let t of this.scenes){for(let i of t.postProcesses)i._outputTexture===e&&(i._outputTexture=null);for(let i of t.cameras)for(let r of i._postProcesses)r&&r._outputTexture===e&&(r._outputTexture=null)}}_rescaleTexture(e,t,i,r,n){this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);let a=this.createRenderTargetTexture({width:t.width,height:t.height},{generateMipMaps:!1,type:0,samplingMode:2,generateDepthBuffer:!1,generateStencilBuffer:!1});if(!this._rescalePostProcess&&s._RescalePostProcessFactory&&(this._rescalePostProcess=s._RescalePostProcessFactory(this)),this._rescalePostProcess){this._rescalePostProcess.externalTextureSamplerBinding=!0;let o=()=>{this._rescalePostProcess.onApply=function(f){f._bindTexture("textureSampler",e)};let c=i;c||(c=this.scenes[this.scenes.length-1]),c.postProcessManager.directRender([this._rescalePostProcess],a,!0),this._bindTextureDirectly(this._gl.TEXTURE_2D,t,!0),this._gl.copyTexImage2D(this._gl.TEXTURE_2D,0,r,0,0,t.width,t.height,0),this.unBindFramebuffer(a),a.dispose(),n&&n()},l=this._rescalePostProcess.getEffect();l?l.executeWhenCompiled(o):this._rescalePostProcess.onEffectCreatedObservable.addOnce(c=>{c.executeWhenCompiled(o)})}}wrapWebGLTexture(e,t=!1,i=3,r=0,n=0){let a=new Uc(e,this._gl),o=new Je(this,0,!0);return o._hardwareTexture=a,o.baseWidth=r,o.baseHeight=n,o.width=r,o.height=n,o.isReady=!0,o.useMipMaps=t,this.updateTextureSamplingMode(i,o),o}_uploadImageToTexture(e,t,i=0,r=0){let n=this._gl,a=this._getWebGLTextureType(e.type),o=this._getInternalFormat(e.format),l=this._getRGBABufferInternalSizedFormat(e.type,o),c=e.isCube?n.TEXTURE_CUBE_MAP:n.TEXTURE_2D;this._bindTextureDirectly(c,e,!0),this._unpackFlipY(e.invertY);let f=n.TEXTURE_2D;e.isCube&&(f=n.TEXTURE_CUBE_MAP_POSITIVE_X+i),n.texImage2D(f,r,l,o,a,t),this._bindTextureDirectly(c,null,!0)}updateTextureComparisonFunction(e,t){if(this.webGLVersion===1){P.Error("WebGL 1 does not support texture comparison.");return}let i=this._gl;e.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,e,!0),t===0?(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_FUNC,515),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_MODE,i.NONE)):(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_FUNC,t),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),t===0?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_FUNC,515),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_MODE,i.NONE)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_FUNC,t),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),e._comparisonFunction=t}createInstancesBuffer(e){let t=this._gl.createBuffer();if(!t)throw new Error("Unable to create instance buffer");let i=new yn(t);return i.capacity=e,this.bindArrayBuffer(i),this._gl.bufferData(this._gl.ARRAY_BUFFER,e,this._gl.DYNAMIC_DRAW),i.references=1,i}deleteInstancesBuffer(e){this._gl.deleteBuffer(e)}async _clientWaitAsync(e,t=0,i=10){let r=this._gl;return await new Promise((n,a)=>{br(()=>{let o=r.clientWaitSync(e,t,0);if(o==r.WAIT_FAILED)throw new Error("clientWaitSync failed");return o!=r.TIMEOUT_EXPIRED},n,a,i)})}_readPixelsAsync(e,t,i,r,n,a,o){if(this._webGLVersion<2)throw new Error("_readPixelsAsync only work on WebGL2+");let l=this._gl,c=l.createBuffer();l.bindBuffer(l.PIXEL_PACK_BUFFER,c),l.bufferData(l.PIXEL_PACK_BUFFER,o.byteLength,l.STREAM_READ),l.readPixels(e,t,i,r,n,a,0),l.bindBuffer(l.PIXEL_PACK_BUFFER,null);let f=l.fenceSync(l.SYNC_GPU_COMMANDS_COMPLETE,0);return f?(l.flush(),this._clientWaitAsync(f,0,10).then(()=>(l.deleteSync(f),l.bindBuffer(l.PIXEL_PACK_BUFFER,c),l.getBufferSubData(l.PIXEL_PACK_BUFFER,0,o),l.bindBuffer(l.PIXEL_PACK_BUFFER,null),l.deleteBuffer(c),o))):null}dispose(){this.hideLoadingUI(),this._rescalePostProcess&&this._rescalePostProcess.dispose(),im(this,this._renderingCanvas),super.dispose()}};ee.ALPHA_DISABLE=0;ee.ALPHA_ADD=1;ee.ALPHA_COMBINE=2;ee.ALPHA_SUBTRACT=3;ee.ALPHA_MULTIPLY=4;ee.ALPHA_MAXIMIZED=5;ee.ALPHA_ONEONE=6;ee.ALPHA_PREMULTIPLIED=7;ee.ALPHA_PREMULTIPLIED_PORTERDUFF=8;ee.ALPHA_INTERPOLATE=9;ee.ALPHA_SCREENMODE=10;ee.DELAYLOADSTATE_NONE=0;ee.DELAYLOADSTATE_LOADED=1;ee.DELAYLOADSTATE_LOADING=2;ee.DELAYLOADSTATE_NOTLOADED=4;ee.NEVER=512;ee.ALWAYS=519;ee.LESS=513;ee.EQUAL=514;ee.LEQUAL=515;ee.GREATER=516;ee.GEQUAL=518;ee.NOTEQUAL=517;ee.KEEP=7680;ee.REPLACE=7681;ee.INCR=7682;ee.DECR=7683;ee.INVERT=5386;ee.INCR_WRAP=34055;ee.DECR_WRAP=34056;ee.TEXTURE_CLAMP_ADDRESSMODE=0;ee.TEXTURE_WRAP_ADDRESSMODE=1;ee.TEXTURE_MIRROR_ADDRESSMODE=2;ee.TEXTUREFORMAT_ALPHA=0;ee.TEXTUREFORMAT_LUMINANCE=1;ee.TEXTUREFORMAT_LUMINANCE_ALPHA=2;ee.TEXTUREFORMAT_RGB=4;ee.TEXTUREFORMAT_RGBA=5;ee.TEXTUREFORMAT_RED=6;ee.TEXTUREFORMAT_R=6;ee.TEXTUREFORMAT_R16_UNORM=33322;ee.TEXTUREFORMAT_RG16_UNORM=33324;ee.TEXTUREFORMAT_RGB16_UNORM=32852;ee.TEXTUREFORMAT_RGBA16_UNORM=32859;ee.TEXTUREFORMAT_R16_SNORM=36760;ee.TEXTUREFORMAT_RG16_SNORM=36761;ee.TEXTUREFORMAT_RGB16_SNORM=36762;ee.TEXTUREFORMAT_RGBA16_SNORM=36763;ee.TEXTUREFORMAT_RG=7;ee.TEXTUREFORMAT_RED_INTEGER=8;ee.TEXTUREFORMAT_R_INTEGER=8;ee.TEXTUREFORMAT_RG_INTEGER=9;ee.TEXTUREFORMAT_RGB_INTEGER=10;ee.TEXTUREFORMAT_RGBA_INTEGER=11;ee.TEXTURETYPE_UNSIGNED_BYTE=0;ee.TEXTURETYPE_UNSIGNED_INT=0;ee.TEXTURETYPE_FLOAT=1;ee.TEXTURETYPE_HALF_FLOAT=2;ee.TEXTURETYPE_BYTE=3;ee.TEXTURETYPE_SHORT=4;ee.TEXTURETYPE_UNSIGNED_SHORT=5;ee.TEXTURETYPE_INT=6;ee.TEXTURETYPE_UNSIGNED_INTEGER=7;ee.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8;ee.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9;ee.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10;ee.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11;ee.TEXTURETYPE_UNSIGNED_INT_24_8=12;ee.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13;ee.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14;ee.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15;ee.TEXTURE_NEAREST_SAMPLINGMODE=1;ee.TEXTURE_BILINEAR_SAMPLINGMODE=2;ee.TEXTURE_TRILINEAR_SAMPLINGMODE=3;ee.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8;ee.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11;ee.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3;ee.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4;ee.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5;ee.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6;ee.TEXTURE_NEAREST_LINEAR=7;ee.TEXTURE_NEAREST_NEAREST=1;ee.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9;ee.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10;ee.TEXTURE_LINEAR_LINEAR=2;ee.TEXTURE_LINEAR_NEAREST=12;ee.TEXTURE_EXPLICIT_MODE=0;ee.TEXTURE_SPHERICAL_MODE=1;ee.TEXTURE_PLANAR_MODE=2;ee.TEXTURE_CUBIC_MODE=3;ee.TEXTURE_PROJECTION_MODE=4;ee.TEXTURE_SKYBOX_MODE=5;ee.TEXTURE_INVCUBIC_MODE=6;ee.TEXTURE_EQUIRECTANGULAR_MODE=7;ee.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8;ee.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9;ee.SCALEMODE_FLOOR=1;ee.SCALEMODE_NEAREST=2;ee.SCALEMODE_CEILING=3});var cm={};V(cm,{passPixelShaderWGSL:()=>fq});var TR,QO,fq,fm=S(()=>{O();TR="passPixelShader",QO=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,input.vUV);}`;g.ShadersStoreWGSL[TR]||(g.ShadersStoreWGSL[TR]=QO);fq={name:TR,shader:QO}});var ZO={};V(ZO,{passCubePixelShaderWGSL:()=>hq});var xR,jO,hq,JO=S(()=>{O();xR="passCubePixelShader",jO=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_cube<f32>;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var uv: vec2f=input.vUV*2.0-1.0;
#ifdef POSITIVEX
fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(1.001,uv.y,uv.x));
#endif
#ifdef NEGATIVEX
fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(-1.001,uv.y,uv.x));
#endif
#ifdef POSITIVEY
fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(uv.y,1.001,uv.x));
#endif
#ifdef NEGATIVEY
fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(uv.y,-1.001,uv.x));
#endif
#ifdef POSITIVEZ
fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(uv,1.001));
#endif
#ifdef NEGATIVEZ
fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(uv,-1.001));
#endif
}`;g.ShadersStoreWGSL[xR]||(g.ShadersStoreWGSL[xR]=jO);hq={name:xR,shader:jO}});var eL={};V(eL,{passCubePixelShader:()=>uq});var AR,$O,uq,tL=S(()=>{O();AR="passCubePixelShader",$O=`varying vec2 vUV;uniform samplerCube textureSampler;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{vec2 uv=vUV*2.0-1.0;
#ifdef POSITIVEX
gl_FragColor=textureCube(textureSampler,vec3(1.001,uv.y,uv.x));
#endif
#ifdef NEGATIVEX
gl_FragColor=textureCube(textureSampler,vec3(-1.001,uv.y,uv.x));
#endif
#ifdef POSITIVEY
gl_FragColor=textureCube(textureSampler,vec3(uv.y,1.001,uv.x));
#endif
#ifdef NEGATIVEY
gl_FragColor=textureCube(textureSampler,vec3(uv.y,-1.001,uv.x));
#endif
#ifdef POSITIVEZ
gl_FragColor=textureCube(textureSampler,vec3(uv,1.001));
#endif
#ifdef NEGATIVEZ
gl_FragColor=textureCube(textureSampler,vec3(uv,-1.001));
#endif
}`;g.ShadersStore[AR]||(g.ShadersStore[AR]=$O);uq={name:AR,shader:$O}});var xl,Vh,iL=S(()=>{In();Sa();xl=class s extends ti{_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(()=>(fm(),cm))]))):t.push(Promise.all([Promise.resolve().then(()=>(Bh(),Nh))])),super._gatherImports(e,t)}constructor(e,t=null,i){let r={name:e,engine:t||ee.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:s.FragmentUrl,...i};r.engine||(r.engine=ee.LastCreatedEngine),super(r)}};xl.FragmentUrl="pass";Vh=class s extends ti{_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(()=>(JO(),ZO))]))):t.push(Promise.all([Promise.resolve().then(()=>(tL(),eL))])),super._gatherImports(e,t)}constructor(e,t=null,i){super({...i,name:e,engine:t||ee.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:s.FragmentUrl,defines:"#define POSITIVEX"}),this._face=0}get face(){return this._face}set face(e){if(!(e<0||e>5))switch(this._face=e,this._face){case 0:this.updateEffect("#define POSITIVEX");break;case 1:this.updateEffect("#define NEGATIVEX");break;case 2:this.updateEffect("#define POSITIVEY");break;case 3:this.updateEffect("#define NEGATIVEY");break;case 4:this.updateEffect("#define POSITIVEZ");break;case 5:this.updateEffect("#define NEGATIVEZ");break}}};Vh.FragmentUrl="passCube"});var kh,RR,rL=S(()=>{Ye();Wr();Jt();Te();ei();iL();je();kh=class s extends at{getClassName(){return"PassPostProcess"}constructor(e,t,i=null,r,n,a,o=0,l=!1){let c={size:typeof t=="number"?t:void 0,camera:i,samplingMode:r,engine:n,reusable:a,textureType:o,blockCompilation:l,...t};super(e,xl.FragmentUrl,{effectWrapper:typeof t=="number"||!t.effectWrapper?new xl(e,n,c):void 0,...c})}static _Parse(e,t,i,r){return _e.Parse(()=>new s(e.name,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable),e,i,r)}};G("BABYLON.PassPostProcess",kh);RR=class s extends at{get face(){return this._effectWrapper.face}set face(e){this._effectWrapper.face=e}getClassName(){return"PassCubePostProcess"}constructor(e,t,i=null,r,n,a,o=0,l=!1){let c={size:typeof t=="number"?t:void 0,camera:i,samplingMode:r,engine:n,reusable:a,textureType:o,blockCompilation:l,...t};super(e,xl.FragmentUrl,{effectWrapper:typeof t=="number"||!t.effectWrapper?new Vh(e,n,c):void 0,...c})}static _Parse(e,t,i,r){return _e.Parse(()=>new s(e.name,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable),e,i,r)}};x([y()],RR.prototype,"face",null);k._RescalePostProcessFactory=s=>new kh("rescale",1,null,2,s,!1,0)});function nL(s,e,t,i,r,n,a,o){let l=e.getEngine();return e.isReady=!1,r=r??e.samplingMode,i=i??e.type,n=n??e.format,a=a??e.width,o=o??e.height,i===-1&&(i=0),new Promise(c=>{let f=new at("postprocess",s,null,null,1,null,r,l,!1,void 0,i,void 0,null,!1,n);f.externalTextureSamplerBinding=!0;let h=l.createRenderTargetTexture({width:a,height:o},{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:r,type:i,format:n});f.onEffectCreatedObservable.addOnce(u=>{u.executeWhenCompiled(()=>{f.onApply=d=>{d._bindTexture("textureSampler",e),d.setFloat2("scale",1,1)},t.postProcessManager.directRender([f],h,!0),l.restoreDefaultFramebuffer(),l._releaseTexture(e),f&&f.dispose(),h._swapAndDie(e),e.type=i,e.format=5,e.isReady=!0,c(e)})})})}function ki(s){hm||(hm=new Float32Array(1),sL=new Int32Array(hm.buffer)),hm[0]=s;let e=sL[0],t=e>>16&32768,i=e>>12&2047,r=e>>23&255;return r<103?t:r>142?(t|=31744,t|=(r==255?0:1)&&e&8388607,t):r<113?(i|=2048,t|=(i>>114-r)+(i>>113-r&1),t):(t|=r-112<<10|i>>1,t+=i&1,t)}function Zs(s){let e=(s&32768)>>15,t=(s&31744)>>10,i=s&1023;return t===0?(e?-1:1)*Math.pow(2,-14)*(i/Math.pow(2,10)):t==31?i?NaN:(e?-1:1)*(1/0):(e?-1:1)*Math.pow(2,t-15)*(1+i/Math.pow(2,10))}var hm,sL,Hc=S(()=>{Ut();Mn();rL();Wr();di()});function um(s){let e=s.split("?")[0],t=e.lastIndexOf(".");return t>-1?e.substring(t).toLowerCase():""}var bR=S(()=>{});var CR=S(()=>{vi();Ee();To();pa();Jt();IR();bR();k.prototype._partialLoadFile=function(s,e,t,i,r=null){let n=o=>{t[e]=o,t._internalCount++,t._internalCount===6&&i(t)},a=(o,l)=>{r&&o&&r(o.status+" "+o.statusText,l)};this._loadFile(s,n,void 0,void 0,!0,a)};k.prototype._cascadeLoadFiles=function(s,e,t,i=null){let r=[];r._internalCount=0;for(let n=0;n<6;n++)this._partialLoadFile(t[n],n,r,e,i)};k.prototype._cascadeLoadImgs=function(s,e,t,i,r=null,n){let a=[];a._internalCount=0;for(let o=0;o<6;o++)this._partialLoadImg(i[o],o,a,s,e,t,r,n)};k.prototype._partialLoadImg=function(s,e,t,i,r,n,a=null,o){let l=Vi();zc(s,h=>{t[e]=h,t._internalCount++,i&&i.removePendingData(l),t._internalCount===6&&n&&n(r,t)},(h,u)=>{i&&i.removePendingData(l),a&&a(h,u)},i?i.offlineProvider:null,o),i&&i.addPendingData(l)};k.prototype.createCubeTextureBase=function(s,e,t,i,r=null,n=null,a,o=null,l=!1,c=0,f=0,h=null,u=null,d=null,p=!1,m=null){let _=h||new Je(this,7);_.isCube=!0,_.url=s,_.generateMipMaps=!i,_._lodGenerationScale=c,_._lodGenerationOffset=f,_._useSRGBBuffer=!!p&&this._caps.supportSRGBBuffers&&(this.version>1||this.isWebGPU||!!i),_!==h&&(_.label=s.substring(0,60)),this._doNotHandleContextLost||(_._extension=o,_._files=t,_._buffer=m);let v=s;this._transformTextureUrl&&!h&&(s=this._transformTextureUrl(s));let T=o??um(s),C=dm(T),I=(b,M)=>{_.dispose(),n?n(b,M):b&&P.Warn(b)},R=(b,M)=>{s===v?b&&I(b.status+" "+b.statusText,M):(P.Warn(`Failed to load ${s}, falling back to the ${v}`),this.createCubeTextureBase(v,e,t,!!i,r,I,a,o,l,c,f,_,u,d,p,m))};if(C)C.then(b=>{let M=F=>{u&&u(_,F),b.loadCubeData(F,_,l,r,(U,D)=>{I(U,D)})};m?M(m):t&&t.length===6?b.supportCascades?this._cascadeLoadFiles(e,F=>M(F.map(U=>new Uint8Array(U))),t,I):I("Textures type does not support cascades."):this._loadFile(s,F=>M(new Uint8Array(F)),void 0,e?e.offlineProvider||null:void 0,!0,R)});else{if(!t||t.length===0)throw new Error("Cannot load cubemap because files were not defined, or the correct loader was not found.");this._cascadeLoadImgs(e,_,(b,M)=>{d&&d(b,M)},t,I)}return this._internalTexturesCache.push(_),_}});var YO={};V(YO,{DDSTools:()=>Js});function pm(s){return s.charCodeAt(0)+(s.charCodeAt(1)<<8)+(s.charCodeAt(2)<<16)+(s.charCodeAt(3)<<24)}function pq(s){return String.fromCharCode(s&255,s>>8&255,s>>16&255,s>>24&255)}var dq,aL,oL,lL,cL,fL,hL,uL,dL,yR,pL,mL,_L,gL,mq,MR,_q,gq,vL,SL,PR,EL,DR,TL,vq,Sq,Eq,Tq,xq,Aq,Rq,Js,pR=S(()=>{di();Ee();Gp();Hc();CR();dq=542327876,aL=131072,oL=512,lL=4,cL=64,fL=131072;hL=pm("DXT1"),uL=pm("DXT3"),dL=pm("DXT5"),yR=pm("DX10"),pL=113,mL=116,_L=2,gL=10,mq=88,MR=31,_q=0,gq=1,vL=2,SL=3,PR=4,EL=7,DR=20,TL=21,vq=22,Sq=23,Eq=24,Tq=25,xq=26,Aq=28,Rq=32,Js=class s{static GetDDSInfo(e){let t=new Int32Array(e.buffer,e.byteOffset,MR),i=new Int32Array(e.buffer,e.byteOffset,MR+4),r=1;t[vL]&aL&&(r=Math.max(1,t[EL]));let n=t[TL],a=n===yR?i[Rq]:0,o=0;switch(n){case pL:o=2;break;case mL:o=1;break;case yR:if(a===gL){o=2;break}if(a===_L){o=1;break}}return{width:t[PR],height:t[SL],mipmapCount:r,isFourCC:(t[DR]&lL)===lL,isRGB:(t[DR]&cL)===cL,isLuminance:(t[DR]&fL)===fL,isCube:(t[Aq]&oL)===oL,isCompressed:n===hL||n===uL||n===dL,dxgiFormat:a,textureType:o}}static _GetHalfFloatAsFloatRGBAArrayBuffer(e,t,i,r,n,a){let o=new Float32Array(r),l=new Uint16Array(n,i),c=0;for(let f=0;f<t;f++)for(let h=0;h<e;h++){let u=(h+f*e)*4;o[c]=Zs(l[u]),o[c+1]=Zs(l[u+1]),o[c+2]=Zs(l[u+2]),s.StoreLODInAlphaChannel?o[c+3]=a:o[c+3]=Zs(l[u+3]),c+=4}return o}static _GetHalfFloatRGBAArrayBuffer(e,t,i,r,n,a){if(s.StoreLODInAlphaChannel){let o=new Uint16Array(r),l=new Uint16Array(n,i),c=0;for(let f=0;f<t;f++)for(let h=0;h<e;h++){let u=(h+f*e)*4;o[c]=l[u],o[c+1]=l[u+1],o[c+2]=l[u+2],o[c+3]=ki(a),c+=4}return o}return new Uint16Array(n,i,r)}static _GetFloatRGBAArrayBuffer(e,t,i,r,n,a){if(s.StoreLODInAlphaChannel){let o=new Float32Array(r),l=new Float32Array(n,i),c=0;for(let f=0;f<t;f++)for(let h=0;h<e;h++){let u=(h+f*e)*4;o[c]=l[u],o[c+1]=l[u+1],o[c+2]=l[u+2],o[c+3]=a,c+=4}return o}return new Float32Array(n,i,r)}static _GetFloatAsHalfFloatRGBAArrayBuffer(e,t,i,r,n,a){let o=new Uint16Array(r),l=new Float32Array(n,i),c=0;for(let f=0;f<t;f++)for(let h=0;h<e;h++)o[c]=ki(l[c]),o[c+1]=ki(l[c+1]),o[c+2]=ki(l[c+2]),s.StoreLODInAlphaChannel?o[c+3]=ki(a):o[c+3]=ki(l[c+3]),c+=4;return o}static _GetFloatAsUIntRGBAArrayBuffer(e,t,i,r,n,a){let o=new Uint8Array(r),l=new Float32Array(n,i),c=0;for(let f=0;f<t;f++)for(let h=0;h<e;h++){let u=(h+f*e)*4;o[c]=Fe(l[u])*255,o[c+1]=Fe(l[u+1])*255,o[c+2]=Fe(l[u+2])*255,s.StoreLODInAlphaChannel?o[c+3]=a:o[c+3]=Fe(l[u+3])*255,c+=4}return o}static _GetHalfFloatAsUIntRGBAArrayBuffer(e,t,i,r,n,a){let o=new Uint8Array(r),l=new Uint16Array(n,i),c=0;for(let f=0;f<t;f++)for(let h=0;h<e;h++){let u=(h+f*e)*4;o[c]=Fe(Zs(l[u]))*255,o[c+1]=Fe(Zs(l[u+1]))*255,o[c+2]=Fe(Zs(l[u+2]))*255,s.StoreLODInAlphaChannel?o[c+3]=a:o[c+3]=Fe(Zs(l[u+3]))*255,c+=4}return o}static _GetRGBAArrayBuffer(e,t,i,r,n,a,o,l,c){let f=new Uint8Array(r),h=new Uint8Array(n,i),u=0;for(let d=0;d<t;d++)for(let p=0;p<e;p++){let m=(p+d*e)*4;f[u]=h[m+a],f[u+1]=h[m+o],f[u+2]=h[m+l],f[u+3]=h[m+c],u+=4}return f}static _ExtractLongWordOrder(e){return e===0||e===255||e===-16777216?0:1+s._ExtractLongWordOrder(e>>8)}static _GetRGBArrayBuffer(e,t,i,r,n,a,o,l){let c=new Uint8Array(r),f=new Uint8Array(n,i),h=0;for(let u=0;u<t;u++)for(let d=0;d<e;d++){let p=(d+u*e)*3;c[h]=f[p+a],c[h+1]=f[p+o],c[h+2]=f[p+l],h+=3}return c}static _GetLuminanceArrayBuffer(e,t,i,r,n){let a=new Uint8Array(r),o=new Uint8Array(n,i),l=0;for(let c=0;c<t;c++)for(let f=0;f<e;f++){let h=f+c*e;a[l]=o[h],l++}return a}static UploadDDSLevels(e,t,i,r,n,a,o=-1,l,c=!0){let f=null;r.sphericalPolynomial&&(f=[]);let h=!!e.getCaps().s3tc;t.generateMipMaps=n;let u=new Int32Array(i.buffer,i.byteOffset,MR),d,p,m,_=0,v,T,C,I,R=0,b=1;if(u[_q]!==dq){P.Error("Invalid magic number in DDS header");return}if(!r.isFourCC&&!r.isRGB&&!r.isLuminance){P.Error("Unsupported format, must contain a FourCC, RGB or LUMINANCE code");return}if(r.isCompressed&&!h){P.Error("Compressed textures are not supported on this platform.");return}let M=u[vq];v=u[gq]+4;let F=!1;if(r.isFourCC)switch(d=u[TL],d){case hL:b=8,R=33777;break;case uL:b=16,R=33778;break;case dL:b=16,R=33779;break;case pL:F=!0,M=64;break;case mL:F=!0,M=128;break;case yR:{v+=20;let be=!1;switch(r.dxgiFormat){case gL:F=!0,M=64,be=!0;break;case _L:F=!0,M=128,be=!0;break;case mq:r.isRGB=!0,r.isFourCC=!1,M=32,be=!0;break}if(be)break}default:P.Error(["Unsupported FourCC code:",pq(d)]);return}let U=s._ExtractLongWordOrder(u[Sq]),D=s._ExtractLongWordOrder(u[Eq]),$=s._ExtractLongWordOrder(u[Tq]),oe=s._ExtractLongWordOrder(u[xq]);F&&(R=e._getRGBABufferInternalSizedFormat(r.textureType)),C=1,u[vL]&aL&&n!==!1&&(C=Math.max(1,u[EL]));let re=l||0,se=e.getCaps();for(let be=re;be<a;be++){for(p=u[PR],m=u[SL],I=0;I<C;++I){if(o===-1||o===I){let Me=o===-1?I:0;if(!r.isCompressed&&r.isFourCC){t.format=5,_=p*m*4;let ke=null;if(e._badOS||e._badDesktopOS||!se.textureHalfFloat&&!se.textureFloat)M===128?(ke=s._GetFloatAsUIntRGBAArrayBuffer(p,m,i.byteOffset+v,_,i.buffer,Me),f&&Me==0&&f.push(s._GetFloatRGBAArrayBuffer(p,m,i.byteOffset+v,_,i.buffer,Me))):M===64&&(ke=s._GetHalfFloatAsUIntRGBAArrayBuffer(p,m,i.byteOffset+v,_,i.buffer,Me),f&&Me==0&&f.push(s._GetHalfFloatAsFloatRGBAArrayBuffer(p,m,i.byteOffset+v,_,i.buffer,Me))),t.type=0;else{let de=se.textureFloat&&(c&&se.textureFloatLinearFiltering||!c),Qe=se.textureHalfFloat&&(c&&se.textureHalfFloatLinearFiltering||!c),Re=(M===128||M===64&&!Qe)&&de?1:(M===64||M===128&&!de)&&Qe?2:0,Ae,ut=null;switch(M){case 128:{switch(Re){case 1:Ae=s._GetFloatRGBAArrayBuffer,ut=null;break;case 2:Ae=s._GetFloatAsHalfFloatRGBAArrayBuffer,ut=s._GetFloatRGBAArrayBuffer;break;case 0:Ae=s._GetFloatAsUIntRGBAArrayBuffer,ut=s._GetFloatRGBAArrayBuffer;break}break}default:{switch(Re){case 1:Ae=s._GetHalfFloatAsFloatRGBAArrayBuffer,ut=null;break;case 2:Ae=s._GetHalfFloatRGBAArrayBuffer,ut=s._GetHalfFloatAsFloatRGBAArrayBuffer;break;case 0:Ae=s._GetHalfFloatAsUIntRGBAArrayBuffer,ut=s._GetHalfFloatAsFloatRGBAArrayBuffer;break}break}}t.type=Re,ke=Ae(p,m,i.byteOffset+v,_,i.buffer,Me),f&&Me==0&&f.push(ut?ut(p,m,i.byteOffset+v,_,i.buffer,Me):ke)}ke&&e._uploadDataToTextureDirectly(t,ke,be,Me)}else if(r.isRGB)t.type=0,M===24?(t.format=4,_=p*m*3,T=s._GetRGBArrayBuffer(p,m,i.byteOffset+v,_,i.buffer,U,D,$),e._uploadDataToTextureDirectly(t,T,be,Me)):(t.format=5,_=p*m*4,T=s._GetRGBAArrayBuffer(p,m,i.byteOffset+v,_,i.buffer,U,D,$,oe),e._uploadDataToTextureDirectly(t,T,be,Me));else if(r.isLuminance){let ke=e._getUnpackAlignement(),de=p;_=Math.floor((p+ke-1)/ke)*ke*(m-1)+de,T=s._GetLuminanceArrayBuffer(p,m,i.byteOffset+v,_,i.buffer),t.format=1,t.type=0,e._uploadDataToTextureDirectly(t,T,be,Me)}else _=Math.max(4,p)/4*Math.max(4,m)/4*b,T=new Uint8Array(i.buffer,i.byteOffset+v,_),t.type=0,e._uploadCompressedDataToTextureDirectly(t,R,p,m,T,be,Me)}v+=M?p*m*(M/8):_,p*=.5,m*=.5,p=Math.max(1,p),m=Math.max(1,m)}if(l!==void 0)break}f&&f.length>0?r.sphericalPolynomial=qs.ConvertCubeMapToSphericalPolynomial({size:u[PR],right:f[0],left:f[1],up:f[2],down:f[3],front:f[4],back:f[5],format:5,type:1,gammaSpace:!1}):r.sphericalPolynomial=void 0}};Js.StoreLODInAlphaChannel=!1});var xL={};V(xL,{_DDSTextureLoader:()=>OR});var OR,AL=S(()=>{gl();pR();OR=class{constructor(){this.supportCascades=!0}loadCubeData(e,t,i,r){let n=t.getEngine(),a,o=!1,l=1e3;if(Array.isArray(e))for(let c=0;c<e.length;c++){let f=e[c];a=Js.GetDDSInfo(f),t.width=a.width,t.height=a.height,o=(a.isRGB||a.isLuminance||a.mipmapCount>1)&&t.generateMipMaps,n._unpackFlipY(a.isCompressed),Js.UploadDDSLevels(n,t,f,a,o,6,-1,c),!a.isFourCC&&a.mipmapCount===1?n.generateMipMapsForCubemap(t):l=a.mipmapCount-1}else{let c=e;a=Js.GetDDSInfo(c),t.width=a.width,t.height=a.height,i&&(a.sphericalPolynomial=new Ur),o=(a.isRGB||a.isLuminance||a.mipmapCount>1)&&t.generateMipMaps,n._unpackFlipY(a.isCompressed),Js.UploadDDSLevels(n,t,c,a,o,6),!a.isFourCC&&a.mipmapCount===1?n.generateMipMapsForCubemap(t,!1):l=a.mipmapCount-1}n._setCubeMapTextureParams(t,o,l),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),r&&r({isDDS:!0,width:t.width,info:a,data:e,texture:t})}loadData(e,t,i){let r=Js.GetDDSInfo(e),n=(r.isRGB||r.isLuminance||r.mipmapCount>1)&&t.generateMipMaps&&Math.max(r.width,r.height)>>r.mipmapCount-1===1;i(r.width,r.height,n,r.isFourCC,()=>{Js.UploadDDSLevels(t.getEngine(),t,e,r,n,1)})}}});function RL(){let s={cTFETC1:0,cTFETC2:1,cTFBC1:2,cTFBC3:3,cTFBC4:4,cTFBC5:5,cTFBC7:6,cTFPVRTC1_4_RGB:8,cTFPVRTC1_4_RGBA:9,cTFASTC_4x4:10,cTFATC_RGB:11,cTFATC_RGBA_INTERPOLATED_ALPHA:12,cTFRGBA32:13,cTFRGB565:14,cTFBGR565:15,cTFRGBA4444:16,cTFFXT1_RGB:17,cTFPVRTC2_4_RGB:18,cTFPVRTC2_4_RGBA:19,cTFETC2_EAC_R11:20,cTFETC2_EAC_RG11:21},e=null;onmessage=a=>{if(a.data.action==="init"){if(a.data.url)try{importScripts(a.data.url)}catch(o){postMessage({action:"error",error:o})}e||(e=BASIS({wasmBinary:a.data.wasmBinary})),e!==null&&e.then(o=>{BASIS=o,o.initializeBasis(),postMessage({action:"init"})})}else if(a.data.action==="transcode"){let o=a.data.config,l=a.data.imageData,c=new BASIS.BasisFile(l),f=i(c),h=a.data.ignoreSupportedFormats?null:t(a.data.config,f),u=!1;h===null&&(u=!0,h=f.hasAlpha?s.cTFBC3:s.cTFBC1);let d=!0;c.startTranscoding()||(d=!1);let p=[];for(let m=0;m<f.images.length&&d;m++){let _=f.images[m];if(o.loadSingleImage===void 0||o.loadSingleImage===m){let v=_.levels.length;o.loadMipmapLevels===!1&&(v=1);for(let T=0;T<v;T++){let C=_.levels[T],I=r(c,m,T,h,u);if(!I){d=!1;break}C.transcodedPixels=I,p.push(C.transcodedPixels.buffer)}}}c.close(),c.delete(),u&&(h=-1),d?postMessage({action:"transcode",success:d,id:a.data.id,fileInfo:f,format:h},p):postMessage({action:"transcode",success:d,id:a.data.id})}};function t(a,o){let l=null;return a.supportedCompressionFormats&&(a.supportedCompressionFormats.astc?l=s.cTFASTC_4x4:a.supportedCompressionFormats.bc7?l=s.cTFBC7:a.supportedCompressionFormats.s3tc?l=o.hasAlpha?s.cTFBC3:s.cTFBC1:a.supportedCompressionFormats.pvrtc?l=o.hasAlpha?s.cTFPVRTC1_4_RGBA:s.cTFPVRTC1_4_RGB:a.supportedCompressionFormats.etc2?l=s.cTFETC2:a.supportedCompressionFormats.etc1?l=s.cTFETC1:l=s.cTFRGB565),l}function i(a){let o=a.getHasAlpha(),l=a.getNumImages(),c=[];for(let h=0;h<l;h++){let u={levels:[]},d=a.getNumLevels(h);for(let p=0;p<d;p++){let m={width:a.getImageWidth(h,p),height:a.getImageHeight(h,p)};u.levels.push(m)}c.push(u)}return{hasAlpha:o,images:c}}function r(a,o,l,c,f){let h=a.getImageTranscodedSizeInBytes(o,l,c),u=new Uint8Array(h);if(!a.transcodeImage(u,o,l,c,1,0))return null;if(f){let d=a.getImageWidth(o,l)+3&-4,p=a.getImageHeight(o,l)+3&-4;u=n(u,0,d,p)}return u}function n(a,o,l,c){let f=new Uint16Array(4),h=new Uint16Array(l*c),u=l/4,d=c/4;for(let p=0;p<d;p++)for(let m=0;m<u;m++){let _=o+8*(p*u+m);f[0]=a[_]|a[_+1]<<8,f[1]=a[_+2]|a[_+3]<<8,f[2]=(2*(f[0]&31)+1*(f[1]&31))/3|(2*(f[0]&2016)+1*(f[1]&2016))/3&2016|(2*(f[0]&63488)+1*(f[1]&63488))/3&63488,f[3]=(2*(f[1]&31)+1*(f[0]&31))/3|(2*(f[1]&2016)+1*(f[0]&2016))/3&2016|(2*(f[1]&63488)+1*(f[0]&63488))/3&63488;for(let v=0;v<4;v++){let T=a[_+4+v],C=(p*4+v)*l+m*4;h[C++]=f[T&3],h[C++]=f[T>>2&3],h[C++]=f[T>>4&3],h[C++]=f[T>>6&3]}}return h}}async function bL(s,e,t){return await new Promise((i,r)=>{let n=a=>{a.data.action==="init"?(s.removeEventListener("message",n),i(s)):a.data.action==="error"&&r(a.data.error||"error initializing worker")};s.addEventListener("message",n),s.postMessage({action:"init",url:t?W.GetBabylonScriptURL(t):void 0,wasmBinary:e},[e])})}var CL=S(()=>{$e()});var Ea,Ro,bq,LR,Al,Cq,Iq,yq,_m,mm,gm,wR,IL=S(()=>{$e();Ut();vi();CL();(function(s){s[s.cTFETC1=0]="cTFETC1",s[s.cTFETC2=1]="cTFETC2",s[s.cTFBC1=2]="cTFBC1",s[s.cTFBC3=3]="cTFBC3",s[s.cTFBC4=4]="cTFBC4",s[s.cTFBC5=5]="cTFBC5",s[s.cTFBC7=6]="cTFBC7",s[s.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",s[s.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",s[s.cTFASTC_4x4=10]="cTFASTC_4x4",s[s.cTFATC_RGB=11]="cTFATC_RGB",s[s.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",s[s.cTFRGBA32=13]="cTFRGBA32",s[s.cTFRGB565=14]="cTFRGB565",s[s.cTFBGR565=15]="cTFBGR565",s[s.cTFRGBA4444=16]="cTFRGBA4444",s[s.cTFFXT1_RGB=17]="cTFFXT1_RGB",s[s.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",s[s.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",s[s.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",s[s.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"})(Ea||(Ea={}));Ro={JSModuleURL:`${W._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${W._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`},bq=(s,e)=>{let t;switch(s){case Ea.cTFETC1:t=36196;break;case Ea.cTFBC1:t=33776;break;case Ea.cTFBC4:t=33779;break;case Ea.cTFASTC_4x4:t=37808;break;case Ea.cTFETC2:t=37496;break;case Ea.cTFBC7:t=36492;break}if(t===void 0)throw"The chosen Basis transcoder format is not currently supported";return t},LR=null,Al=null,Cq=0,Iq=!1,yq=async()=>(LR||(LR=new Promise((s,e)=>{Al?s(Al):W.LoadFileAsync(W.GetBabylonScriptURL(Ro.WasmModuleURL)).then(t=>{if(typeof URL!="function")return e("Basis transcoder requires an environment with a URL constructor");let i=URL.createObjectURL(new Blob([`(${RL})()`],{type:"application/javascript"}));Al=new Worker(i),bL(Al,t,Ro.JSModuleURL).then(s,e)}).catch(e)})),await LR),_m=async(s,e)=>{let t=s instanceof ArrayBuffer?new Uint8Array(s):s;return await new Promise((i,r)=>{yq().then(()=>{let n=Cq++,a=l=>{l.data.action==="transcode"&&l.data.id===n&&(Al.removeEventListener("message",a),l.data.success?i(l.data):r("Transcode is not supported on this device"))};Al.addEventListener("message",a);let o=new Uint8Array(t.byteLength);o.set(new Uint8Array(t.buffer,t.byteOffset,t.byteLength)),Al.postMessage({action:"transcode",id:n,imageData:o,config:e,ignoreSupportedFormats:Iq},[o.buffer])},n=>{r(n)})})},mm=(s,e)=>{let t=e._gl?.TEXTURE_2D;s.isCube&&(t=e._gl?.TEXTURE_CUBE_MAP),e._bindTextureDirectly(t,s,!0)},gm=(s,e)=>{let t=s.getEngine();for(let i=0;i<e.fileInfo.images.length;i++){let r=e.fileInfo.images[i].levels[0];if(s._invertVScale=s.invertY,e.format===-1||e.format===Ea.cTFRGB565)if(s.type=10,s.format=4,t._features.basisNeedsPOT&&(Math.log2(r.width)%1!==0||Math.log2(r.height)%1!==0)){let n=new Je(t,2);s._invertVScale=s.invertY,n.type=10,n.format=4,n.width=r.width+3&-4,n.height=r.height+3&-4,mm(n,t),t._uploadDataToTextureDirectly(n,new Uint16Array(r.transcodedPixels.buffer),i,0,4,!0),t._rescaleTexture(n,s,t.scenes[0],t._getInternalFormat(4),()=>{t._releaseTexture(n),mm(s,t)})}else s._invertVScale=!s.invertY,s.width=r.width+3&-4,s.height=r.height+3&-4,s.samplingMode=2,mm(s,t),t._uploadDataToTextureDirectly(s,new Uint16Array(r.transcodedPixels.buffer),i,0,4,!0);else{s.width=r.width,s.height=r.height,s.generateMipMaps=e.fileInfo.images[i].levels.length>1;let n=wR.GetInternalFormatFromBasisFormat(e.format,t);s.format=n,mm(s,t);let a=e.fileInfo.images[i].levels;for(let o=0;o<a.length;o++){let l=a[o];t._uploadCompressedDataToTextureDirectly(s,n,l.width,l.height,l.transcodedPixels,i,o)}t._features.basisNeedsPOT&&(Math.log2(s.width)%1!==0||Math.log2(s.height)%1!==0)&&(W.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),s._cachedWrapU=H.CLAMP_ADDRESSMODE,s._cachedWrapV=H.CLAMP_ADDRESSMODE)}}},wR={JSModuleURL:Ro.JSModuleURL,WasmModuleURL:Ro.WasmModuleURL,GetInternalFormatFromBasisFormat:bq,TranscodeAsync:_m,LoadTextureFromTranscodeResult:gm};Object.defineProperty(wR,"JSModuleURL",{get:function(){return Ro.JSModuleURL},set:function(s){Ro.JSModuleURL=s}});Object.defineProperty(wR,"WasmModuleURL",{get:function(){return Ro.WasmModuleURL},set:function(s){Ro.WasmModuleURL=s}})});var yL={};V(yL,{_BasisTextureLoader:()=>FR});var FR,ML=S(()=>{IL();$e();FR=class{constructor(){this.supportCascades=!1}loadCubeData(e,t,i,r,n){if(Array.isArray(e))return;let a=t.getEngine().getCaps(),o={supportedCompressionFormats:{etc1:!!a.etc1,s3tc:!!a.s3tc,pvrtc:!!a.pvrtc,etc2:!!a.etc2,astc:!!a.astc,bc7:!!a.bptc}};_m(e,o).then(l=>{let c=l.fileInfo.images[0].levels.length>1&&t.generateMipMaps;gm(t,l),t.getEngine()._setCubeMapTextureParams(t,c),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),r&&r()}).catch(l=>{W.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),t.isReady=!0,n&&n(l)})}loadData(e,t,i){let r=t.getEngine().getCaps(),n={supportedCompressionFormats:{etc1:!!r.etc1,s3tc:!!r.s3tc,pvrtc:!!r.pvrtc,etc2:!!r.etc2,astc:!!r.astc,bc7:!!r.bptc}};_m(e,n).then(a=>{let o=a.fileInfo.images[0].levels[0],l=a.fileInfo.images[0].levels.length>1&&t.generateMipMaps;i(o.width,o.height,l,a.format!==-1,()=>{gm(t,a)})}).catch(a=>{W.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),W.Warn(`Failed to transcode Basis file: ${a}`),i(0,0,!1,!1,()=>{},!0)})}}});var Wh,PL=S(()=>{Wh=class{constructor(){this._count=0,this._data={}}copyFrom(e){this.clear(),e.forEach((t,i)=>this.add(t,i))}get(e){let t=this._data[e];if(t!==void 0)return t}getOrAddWithFactory(e,t){let i=this.get(e);return i!==void 0||(i=t(e),i&&this.add(e,i)),i}getOrAdd(e,t){let i=this.get(e);return i!==void 0?i:(this.add(e,t),t)}contains(e){return this._data[e]!==void 0}add(e,t){return this._data[e]!==void 0?!1:(this._data[e]=t,++this._count,!0)}set(e,t){return this._data[e]===void 0?!1:(this._data[e]=t,!0)}getAndRemove(e){let t=this.get(e);return t!==void 0?(delete this._data[e],--this._count,t):null}remove(e){return this.contains(e)?(delete this._data[e],--this._count,!0):!1}clear(){this._data={},this._count=0}get count(){return this._count}forEach(e){for(let t in this._data){let i=this._data[t];e(t,i)}}first(e){for(let t in this._data){let i=this._data[t],r=e(t,i);if(r)return r}return null}}});function vm(s){s.push("vCameraColorCurveNeutral","vCameraColorCurvePositive","vCameraColorCurveNegative")}var NR=S(()=>{});var yi,DL=S(()=>{Ye();je();it();ei();NR();yi=class s{constructor(){this._dirty=!0,this._tempColor=new me(0,0,0,0),this._globalCurve=new me(0,0,0,0),this._highlightsCurve=new me(0,0,0,0),this._midtonesCurve=new me(0,0,0,0),this._shadowsCurve=new me(0,0,0,0),this._positiveCurve=new me(0,0,0,0),this._negativeCurve=new me(0,0,0,0),this._globalHue=30,this._globalDensity=0,this._globalSaturation=0,this._globalExposure=0,this._highlightsHue=30,this._highlightsDensity=0,this._highlightsSaturation=0,this._highlightsExposure=0,this._midtonesHue=30,this._midtonesDensity=0,this._midtonesSaturation=0,this._midtonesExposure=0,this._shadowsHue=30,this._shadowsDensity=0,this._shadowsSaturation=0,this._shadowsExposure=0}get globalHue(){return this._globalHue}set globalHue(e){this._globalHue=e,this._dirty=!0}get globalDensity(){return this._globalDensity}set globalDensity(e){this._globalDensity=e,this._dirty=!0}get globalSaturation(){return this._globalSaturation}set globalSaturation(e){this._globalSaturation=e,this._dirty=!0}get globalExposure(){return this._globalExposure}set globalExposure(e){this._globalExposure=e,this._dirty=!0}get highlightsHue(){return this._highlightsHue}set highlightsHue(e){this._highlightsHue=e,this._dirty=!0}get highlightsDensity(){return this._highlightsDensity}set highlightsDensity(e){this._highlightsDensity=e,this._dirty=!0}get highlightsSaturation(){return this._highlightsSaturation}set highlightsSaturation(e){this._highlightsSaturation=e,this._dirty=!0}get highlightsExposure(){return this._highlightsExposure}set highlightsExposure(e){this._highlightsExposure=e,this._dirty=!0}get midtonesHue(){return this._midtonesHue}set midtonesHue(e){this._midtonesHue=e,this._dirty=!0}get midtonesDensity(){return this._midtonesDensity}set midtonesDensity(e){this._midtonesDensity=e,this._dirty=!0}get midtonesSaturation(){return this._midtonesSaturation}set midtonesSaturation(e){this._midtonesSaturation=e,this._dirty=!0}get midtonesExposure(){return this._midtonesExposure}set midtonesExposure(e){this._midtonesExposure=e,this._dirty=!0}get shadowsHue(){return this._shadowsHue}set shadowsHue(e){this._shadowsHue=e,this._dirty=!0}get shadowsDensity(){return this._shadowsDensity}set shadowsDensity(e){this._shadowsDensity=e,this._dirty=!0}get shadowsSaturation(){return this._shadowsSaturation}set shadowsSaturation(e){this._shadowsSaturation=e,this._dirty=!0}get shadowsExposure(){return this._shadowsExposure}set shadowsExposure(e){this._shadowsExposure=e,this._dirty=!0}getClassName(){return"ColorCurves"}static Bind(e,t,i="vCameraColorCurvePositive",r="vCameraColorCurveNeutral",n="vCameraColorCurveNegative"){e._dirty&&(e._dirty=!1,e._getColorGradingDataToRef(e._globalHue,e._globalDensity,e._globalSaturation,e._globalExposure,e._globalCurve),e._getColorGradingDataToRef(e._highlightsHue,e._highlightsDensity,e._highlightsSaturation,e._highlightsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._highlightsCurve),e._getColorGradingDataToRef(e._midtonesHue,e._midtonesDensity,e._midtonesSaturation,e._midtonesExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._midtonesCurve),e._getColorGradingDataToRef(e._shadowsHue,e._shadowsDensity,e._shadowsSaturation,e._shadowsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._shadowsCurve),e._highlightsCurve.subtractToRef(e._midtonesCurve,e._positiveCurve),e._midtonesCurve.subtractToRef(e._shadowsCurve,e._negativeCurve)),t&&(t.setFloat4(i,e._positiveCurve.r,e._positiveCurve.g,e._positiveCurve.b,e._positiveCurve.a),t.setFloat4(r,e._midtonesCurve.r,e._midtonesCurve.g,e._midtonesCurve.b,e._midtonesCurve.a),t.setFloat4(n,e._negativeCurve.r,e._negativeCurve.g,e._negativeCurve.b,e._negativeCurve.a))}_getColorGradingDataToRef(e,t,i,r,n){e!=null&&(e=s._Clamp(e,0,360),t=s._Clamp(t,-100,100),i=s._Clamp(i,-100,100),r=s._Clamp(r,-100,100),t=s._ApplyColorGradingSliderNonlinear(t),t*=.5,r=s._ApplyColorGradingSliderNonlinear(r),t<0&&(t*=-1,e=(e+180)%360),s._FromHSBToRef(e,t,50+.25*r,n),n.scaleToRef(2,n),n.a=1+.01*i)}static _ApplyColorGradingSliderNonlinear(e){e/=100;let t=Math.abs(e);return t=Math.pow(t,2),e<0&&(t*=-1),t*=100,t}static _FromHSBToRef(e,t,i,r){let n=s._Clamp(e,0,360),a=s._Clamp(t/100,0,1),o=s._Clamp(i/100,0,1);if(a===0)r.r=o,r.g=o,r.b=o;else{n/=60;let l=Math.floor(n),c=n-l,f=o*(1-a),h=o*(1-a*c),u=o*(1-a*(1-c));switch(l){case 0:r.r=o,r.g=u,r.b=f;break;case 1:r.r=h,r.g=o,r.b=f;break;case 2:r.r=f,r.g=o,r.b=u;break;case 3:r.r=f,r.g=h,r.b=o;break;case 4:r.r=u,r.g=f,r.b=o;break;default:r.r=o,r.g=f,r.b=h;break}}r.a=1}static _Clamp(e,t,i){return Math.min(Math.max(e,t),i)}clone(){return _e.Clone(()=>new s,this)}serialize(){return _e.Serialize(this)}static Parse(e){return _e.Parse(()=>new s,e,null,null)}};yi.PrepareUniforms=vm;x([y()],yi.prototype,"_globalHue",void 0);x([y()],yi.prototype,"_globalDensity",void 0);x([y()],yi.prototype,"_globalSaturation",void 0);x([y()],yi.prototype,"_globalExposure",void 0);x([y()],yi.prototype,"_highlightsHue",void 0);x([y()],yi.prototype,"_highlightsDensity",void 0);x([y()],yi.prototype,"_highlightsSaturation",void 0);x([y()],yi.prototype,"_highlightsExposure",void 0);x([y()],yi.prototype,"_midtonesHue",void 0);x([y()],yi.prototype,"_midtonesDensity",void 0);x([y()],yi.prototype,"_midtonesSaturation",void 0);x([y()],yi.prototype,"_midtonesExposure",void 0);_e._ColorCurvesParser=yi.Parse});function OL(s,e){e.EXPOSURE&&s.push("exposureLinear"),e.CONTRAST&&s.push("contrast"),e.COLORGRADING&&s.push("colorTransformSettings"),(e.VIGNETTE||e.DITHER)&&s.push("vInverseScreenSize"),e.VIGNETTE&&(s.push("vignetteSettings1"),s.push("vignetteSettings2")),e.COLORCURVES&&vm(s),e.DITHER&&s.push("ditherIntensity")}function LL(s,e){e.COLORGRADING&&s.push("txColorTransform")}var wL=S(()=>{NR()});var Ve,Xc=S(()=>{Ye();je();we();it();DL();Ao();ei();wL();Te();Ve=class s{constructor(){this.colorCurves=new yi,this._colorCurvesEnabled=!1,this._colorGradingEnabled=!1,this._colorGradingWithGreenDepth=!0,this._colorGradingBGR=!0,this._exposure=1,this._toneMappingEnabled=!1,this._toneMappingType=s.TONEMAPPING_STANDARD,this._contrast=1,this.vignetteStretch=0,this.vignetteCenterX=0,this.vignetteCenterY=0,this.vignetteWeight=1.5,this.vignetteColor=new me(0,0,0,0),this.vignetteCameraFov=.5,this._vignetteBlendMode=s.VIGNETTEMODE_MULTIPLY,this._vignetteEnabled=!1,this._ditheringEnabled=!1,this._ditheringIntensity=1/255,this._skipFinalColorClamp=!1,this._applyByPostProcess=!1,this._isEnabled=!0,this.outputTextureWidth=0,this.outputTextureHeight=0,this.onUpdateParameters=new N}get colorCurvesEnabled(){return this._colorCurvesEnabled}set colorCurvesEnabled(e){this._colorCurvesEnabled!==e&&(this._colorCurvesEnabled=e,this._updateParameters())}get colorGradingTexture(){return this._colorGradingTexture}set colorGradingTexture(e){this._colorGradingTexture!==e&&(this._colorGradingTexture=e,this._updateParameters())}get colorGradingEnabled(){return this._colorGradingEnabled}set colorGradingEnabled(e){this._colorGradingEnabled!==e&&(this._colorGradingEnabled=e,this._updateParameters())}get colorGradingWithGreenDepth(){return this._colorGradingWithGreenDepth}set colorGradingWithGreenDepth(e){this._colorGradingWithGreenDepth!==e&&(this._colorGradingWithGreenDepth=e,this._updateParameters())}get colorGradingBGR(){return this._colorGradingBGR}set colorGradingBGR(e){this._colorGradingBGR!==e&&(this._colorGradingBGR=e,this._updateParameters())}get exposure(){return this._exposure}set exposure(e){this._exposure!==e&&(this._exposure=e,this._updateParameters())}get toneMappingEnabled(){return this._toneMappingEnabled}set toneMappingEnabled(e){this._toneMappingEnabled!==e&&(this._toneMappingEnabled=e,this._updateParameters())}get toneMappingType(){return this._toneMappingType}set toneMappingType(e){this._toneMappingType!==e&&(this._toneMappingType=e,this._updateParameters())}get contrast(){return this._contrast}set contrast(e){this._contrast!==e&&(this._contrast=e,this._updateParameters())}get vignetteCentreY(){return this.vignetteCenterY}set vignetteCentreY(e){this.vignetteCenterY=e}get vignetteCentreX(){return this.vignetteCenterX}set vignetteCentreX(e){this.vignetteCenterX=e}get vignetteBlendMode(){return this._vignetteBlendMode}set vignetteBlendMode(e){this._vignetteBlendMode!==e&&(this._vignetteBlendMode=e,this._updateParameters())}get vignetteEnabled(){return this._vignetteEnabled}set vignetteEnabled(e){this._vignetteEnabled!==e&&(this._vignetteEnabled=e,this._updateParameters())}get ditheringEnabled(){return this._ditheringEnabled}set ditheringEnabled(e){this._ditheringEnabled!==e&&(this._ditheringEnabled=e,this._updateParameters())}get ditheringIntensity(){return this._ditheringIntensity}set ditheringIntensity(e){this._ditheringIntensity!==e&&(this._ditheringIntensity=e,this._updateParameters())}get skipFinalColorClamp(){return this._skipFinalColorClamp}set skipFinalColorClamp(e){this._skipFinalColorClamp!==e&&(this._skipFinalColorClamp=e,this._updateParameters())}get applyByPostProcess(){return this._applyByPostProcess}set applyByPostProcess(e){this._applyByPostProcess!==e&&(this._applyByPostProcess=e,this._updateParameters())}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,this._updateParameters())}_updateParameters(){this.onUpdateParameters.notifyObservers(this)}getClassName(){return"ImageProcessingConfiguration"}prepareDefines(e,t=!1){if(t!==this.applyByPostProcess||!this._isEnabled){e.VIGNETTE=!1,e.TONEMAPPING=0,e.CONTRAST=!1,e.EXPOSURE=!1,e.COLORCURVES=!1,e.COLORGRADING=!1,e.COLORGRADING3D=!1,e.DITHER=!1,e.IMAGEPROCESSING=!1,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess&&this._isEnabled;return}if(e.VIGNETTE=this.vignetteEnabled,e.VIGNETTEBLENDMODEMULTIPLY=this.vignetteBlendMode===s._VIGNETTEMODE_MULTIPLY,e.VIGNETTEBLENDMODEOPAQUE=!e.VIGNETTEBLENDMODEMULTIPLY,!this._toneMappingEnabled)e.TONEMAPPING=0;else switch(this._toneMappingType){case s.TONEMAPPING_KHR_PBR_NEUTRAL:e.TONEMAPPING=3;break;case s.TONEMAPPING_ACES:e.TONEMAPPING=2;break;default:e.TONEMAPPING=1;break}e.CONTRAST=this.contrast!==1,e.EXPOSURE=this.exposure!==1,e.COLORCURVES=this.colorCurvesEnabled&&!!this.colorCurves,e.COLORGRADING=this.colorGradingEnabled&&!!this.colorGradingTexture,e.COLORGRADING?e.COLORGRADING3D=this.colorGradingTexture.is3D:e.COLORGRADING3D=!1,e.SAMPLER3DGREENDEPTH=this.colorGradingWithGreenDepth,e.SAMPLER3DBGRMAP=this.colorGradingBGR,e.DITHER=this._ditheringEnabled,e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,e.IMAGEPROCESSING=e.VIGNETTE||!!e.TONEMAPPING||e.CONTRAST||e.EXPOSURE||e.COLORCURVES||e.COLORGRADING||e.DITHER}isReady(){return!this.colorGradingEnabled||!this.colorGradingTexture||this.colorGradingTexture.isReady()}bind(e,t){if(this._colorCurvesEnabled&&this.colorCurves&&yi.Bind(this.colorCurves,e),this._vignetteEnabled||this._ditheringEnabled){let i=1/(this.outputTextureWidth||e.getEngine().getRenderWidth()),r=1/(this.outputTextureHeight||e.getEngine().getRenderHeight());if(e.setFloat2("vInverseScreenSize",i,r),this._ditheringEnabled&&e.setFloat("ditherIntensity",.5*this._ditheringIntensity),this._vignetteEnabled){let n=t??r/i,a=Math.tan(this.vignetteCameraFov*.5),o=a*n,l=Math.sqrt(o*a);o=Oh(o,l,this.vignetteStretch),a=Oh(a,l,this.vignetteStretch),e.setFloat4("vignetteSettings1",o,a,-o*this.vignetteCenterX,-a*this.vignetteCenterY);let c=-2*this.vignetteWeight;e.setFloat4("vignetteSettings2",this.vignetteColor.r,this.vignetteColor.g,this.vignetteColor.b,c)}}if(e.setFloat("exposureLinear",this.exposure),e.setFloat("contrast",this.contrast),this.colorGradingTexture){e.setTexture("txColorTransform",this.colorGradingTexture);let i=this.colorGradingTexture.getSize().height;e.setFloat4("colorTransformSettings",(i-1)/i,.5/i,i,this.colorGradingTexture.level)}}clone(){return _e.Clone(()=>new s,this)}serialize(){return _e.Serialize(this)}static Parse(e){let t=_e.Parse(()=>new s,e,null,null);return e.vignetteCentreX!==void 0&&(t.vignetteCenterX=e.vignetteCentreX),e.vignetteCentreY!==void 0&&(t.vignetteCenterY=e.vignetteCentreY),t}static get VIGNETTEMODE_MULTIPLY(){return this._VIGNETTEMODE_MULTIPLY}static get VIGNETTEMODE_OPAQUE(){return this._VIGNETTEMODE_OPAQUE}};Ve.TONEMAPPING_STANDARD=0;Ve.TONEMAPPING_ACES=1;Ve.TONEMAPPING_KHR_PBR_NEUTRAL=2;Ve.PrepareUniforms=OL;Ve.PrepareSamplers=LL;Ve._VIGNETTEMODE_MULTIPLY=0;Ve._VIGNETTEMODE_OPAQUE=1;x([TD()],Ve.prototype,"colorCurves",void 0);x([y()],Ve.prototype,"_colorCurvesEnabled",void 0);x([He("colorGradingTexture")],Ve.prototype,"_colorGradingTexture",void 0);x([y()],Ve.prototype,"_colorGradingEnabled",void 0);x([y()],Ve.prototype,"_colorGradingWithGreenDepth",void 0);x([y()],Ve.prototype,"_colorGradingBGR",void 0);x([y()],Ve.prototype,"_exposure",void 0);x([y()],Ve.prototype,"_toneMappingEnabled",void 0);x([y()],Ve.prototype,"_toneMappingType",void 0);x([y()],Ve.prototype,"_contrast",void 0);x([y()],Ve.prototype,"vignetteStretch",void 0);x([y()],Ve.prototype,"vignetteCenterX",void 0);x([y()],Ve.prototype,"vignetteCenterY",void 0);x([y()],Ve.prototype,"vignetteWeight",void 0);x([np()],Ve.prototype,"vignetteColor",void 0);x([y()],Ve.prototype,"vignetteCameraFov",void 0);x([y()],Ve.prototype,"_vignetteBlendMode",void 0);x([y()],Ve.prototype,"_vignetteEnabled",void 0);x([y()],Ve.prototype,"_ditheringEnabled",void 0);x([y()],Ve.prototype,"_ditheringIntensity",void 0);x([y()],Ve.prototype,"_skipFinalColorClamp",void 0);x([y()],Ve.prototype,"_applyByPostProcess",void 0);x([y()],Ve.prototype,"_isEnabled",void 0);x([y()],Ve.prototype,"outputTextureWidth",void 0);x([y()],Ve.prototype,"outputTextureHeight",void 0);_e._ImageProcessingConfigurationParser=Ve.Parse;G("BABYLON.ImageProcessingConfiguration",Ve)});var ii,Rl=S(()=>{Ee();$e();ii=class s{constructor(e,t,i=!1,r,n=!1,a){this._uniformNames=[],this._valueCache={},this._engine=e,this._noUBO=!e.supportsUniformBuffers||n,this._dynamic=i,this._name=r??"no-name",this._data=t||[],this._uniformLocations={},this._uniformSizes={},this._uniformArraySizes={},this._uniformLocationPointer=0,this._needSync=!1,this._trackUBOsInFrame=!1,(a===void 0&&this._engine._features.trackUbosInFrame||a===!0)&&(this._buffers=[],this._bufferIndex=-1,this._createBufferOnWrite=!1,this._currentFrameId=0,this._trackUBOsInFrame=!0),this._noUBO?(this.updateMatrix3x3=this._updateMatrix3x3ForEffect,this.updateMatrix2x2=this._updateMatrix2x2ForEffect,this.updateFloat=this._updateFloatForEffect,this.updateFloat2=this._updateFloat2ForEffect,this.updateFloat3=this._updateFloat3ForEffect,this.updateFloat4=this._updateFloat4ForEffect,this.updateFloatArray=this._updateFloatArrayForEffect,this.updateArray=this._updateArrayForEffect,this.updateIntArray=this._updateIntArrayForEffect,this.updateUIntArray=this._updateUIntArrayForEffect,this.updateMatrix=this._updateMatrixForEffect,this.updateMatrices=this._updateMatricesForEffect,this.updateVector3=this._updateVector3ForEffect,this.updateVector4=this._updateVector4ForEffect,this.updateColor3=this._updateColor3ForEffect,this.updateColor4=this._updateColor4ForEffect,this.updateDirectColor4=this._updateDirectColor4ForEffect,this.updateInt=this._updateIntForEffect,this.updateInt2=this._updateInt2ForEffect,this.updateInt3=this._updateInt3ForEffect,this.updateInt4=this._updateInt4ForEffect,this.updateUInt=this._updateUIntForEffect,this.updateUInt2=this._updateUInt2ForEffect,this.updateUInt3=this._updateUInt3ForEffect,this.updateUInt4=this._updateUInt4ForEffect):(this._engine._uniformBuffers.push(this),this.updateMatrix3x3=this._updateMatrix3x3ForUniform,this.updateMatrix2x2=this._updateMatrix2x2ForUniform,this.updateFloat=this._updateFloatForUniform,this.updateFloat2=this._updateFloat2ForUniform,this.updateFloat3=this._updateFloat3ForUniform,this.updateFloat4=this._updateFloat4ForUniform,this.updateFloatArray=this._updateFloatArrayForUniform,this.updateArray=this._updateArrayForUniform,this.updateIntArray=this._updateIntArrayForUniform,this.updateUIntArray=this._updateUIntArrayForUniform,this.updateMatrix=this._updateMatrixForUniform,this.updateMatrices=this._updateMatricesForUniform,this.updateVector3=this._updateVector3ForUniform,this.updateVector4=this._updateVector4ForUniform,this.updateColor3=this._updateColor3ForUniform,this.updateColor4=this._updateColor4ForUniform,this.updateDirectColor4=this._updateDirectColor4ForUniform,this.updateInt=this._updateIntForUniform,this.updateInt2=this._updateInt2ForUniform,this.updateInt3=this._updateInt3ForUniform,this.updateInt4=this._updateInt4ForUniform,this.updateUInt=this._updateUIntForUniform,this.updateUInt2=this._updateUInt2ForUniform,this.updateUInt3=this._updateUInt3ForUniform,this.updateUInt4=this._updateUInt4ForUniform)}get useUbo(){return!this._noUBO}get isSync(){return!this._needSync}isDynamic(){return this._dynamic}getData(){return this._bufferData}getBuffer(){return this._buffer}getUniformNames(){return this._uniformNames}_fillAlignment(e){let t;if(e<=2?t=e:t=4,this._uniformLocationPointer%t!==0){let i=this._uniformLocationPointer;this._uniformLocationPointer+=t-this._uniformLocationPointer%t;let r=this._uniformLocationPointer-i;for(let n=0;n<r;n++)this._data.push(0)}}addUniform(e,t,i=0){if(i>0&&typeof t=="number"&&(this._uniformArraySizes[e]={strideSize:t,arraySize:i}),this._uniformLocations[e]!==void 0||(this._uniformNames.push(e),this._noUBO))return;let r;if(i>0){if(t instanceof Array)throw"addUniform should not be use with Array in UBO: "+e;if(this._fillAlignment(4),t==16)t=t*i;else{let a=(4-t)*i;t=t*i+a}r=[];for(let n=0;n<t;n++)r.push(0)}else{if(t instanceof Array)r=t,t=r.length;else{r=[];for(let n=0;n<t;n++)r.push(0)}this._fillAlignment(t)}this._uniformSizes[e]=t,this._uniformLocations[e]=this._uniformLocationPointer,this._uniformLocationPointer+=t;for(let n=0;n<t;n++)this._data.push(r[n]);this._needSync=!0}addMatrix(e,t){this.addUniform(e,Array.prototype.slice.call(t.asArray()))}addFloat2(e,t,i){let r=[t,i];this.addUniform(e,r)}addFloat3(e,t,i,r){let n=[t,i,r];this.addUniform(e,n)}addColor3(e,t){let i=[t.r,t.g,t.b];this.addUniform(e,i)}addColor4(e,t,i){let r=[t.r,t.g,t.b,i];this.addUniform(e,r)}addVector3(e,t){let i=[t.x,t.y,t.z];this.addUniform(e,i)}addMatrix3x3(e){this.addUniform(e,12)}addMatrix2x2(e){this.addUniform(e,8)}create(){this._noUBO||this._buffer||(this._fillAlignment(4),this._bufferData=new Float32Array(this._data),this._rebuild(),this._needSync=!0)}_getNamesDebug(){let e=[],t=0;for(let i in this._uniformLocations)if(e.push(i),++t===10)break;return e.join(",")}_rebuild(){this._noUBO||!this._bufferData||(this._dynamic?this._buffer=this._engine.createDynamicUniformBuffer(this._bufferData,this._name+"_UniformList:"+this._getNamesDebug()):this._buffer=this._engine.createUniformBuffer(this._bufferData,this._name+"_UniformList:"+this._getNamesDebug()),this._trackUBOsInFrame&&(this._buffers.push([this._buffer,this._engine._features.checkUbosContentBeforeUpload?this._bufferData.slice():void 0]),this._bufferIndex=this._buffers.length-1,this._createBufferOnWrite=!1))}_rebuildAfterContextLost(){this._trackUBOsInFrame&&(this._buffers=[],this._currentFrameId=0),this._rebuild()}get _numBuffers(){return this._buffers.length}get _indexBuffer(){return this._bufferIndex}get name(){return this._name}set name(e){this._name=e}get currentEffect(){return this._currentEffect}_buffersEqual(e,t){for(let i=0;i<e.length;++i)if(e[i]!==t[i])return!1;return!0}_copyBuffer(e,t){for(let i=0;i<e.length;++i)t[i]=e[i]}update(){if(!this._noUBO){if(this.bindUniformBuffer(),!this._buffer){this.create();return}if(!this._dynamic&&!this._needSync){this._createBufferOnWrite=this._trackUBOsInFrame;return}if(this._buffers&&this._buffers.length>1&&this._buffers[this._bufferIndex][1])if(this._buffersEqual(this._bufferData,this._buffers[this._bufferIndex][1])){this._needSync=!1,this._createBufferOnWrite=this._trackUBOsInFrame;return}else this._copyBuffer(this._bufferData,this._buffers[this._bufferIndex][1]);this._engine.updateUniformBuffer(this._buffer,this._bufferData),this._engine._features._collectUbosUpdatedInFrame&&(s._UpdatedUbosInFrame[this._name]||(s._UpdatedUbosInFrame[this._name]=0),s._UpdatedUbosInFrame[this._name]++),this._needSync=!1,this._createBufferOnWrite=this._trackUBOsInFrame}}_createNewBuffer(){this._bufferIndex+1<this._buffers.length?(this._bufferIndex++,this._buffer=this._buffers[this._bufferIndex][0],this._createBufferOnWrite=!1,this._needSync=!0):this._rebuild()}_checkNewFrame(){this._trackUBOsInFrame&&this._currentFrameId!==this._engine.frameId&&(this._currentFrameId=this._engine.frameId,this._createBufferOnWrite=!1,this._buffers&&this._buffers.length>0?(this._needSync=this._bufferIndex!==0,this._bufferIndex=0,this._buffer=this._buffers[this._bufferIndex][0]):this._bufferIndex=-1)}updateUniform(e,t,i){this._checkNewFrame();let r=this._uniformLocations[e];if(r===void 0){if(this._buffer){P.Error("Cannot add an uniform after UBO has been created. uniformName="+e);return}this.addUniform(e,i),r=this._uniformLocations[e]}if(this._buffer||this.create(),this._dynamic)for(let n=0;n<i;n++)this._bufferData[r+n]=t[n];else{let n=!1;for(let a=0;a<i;a++)(i===16&&!this._engine._features.uniformBufferHardCheckMatrix||this._bufferData[r+a]!==Math.fround(t[a]))&&(n=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[r+a]=t[a]);this._needSync=this._needSync||n}}updateUniformArray(e,t,i){this._checkNewFrame();let r=this._uniformLocations[e];if(r===void 0){P.Error("Cannot add an uniform Array dynamically. Please, add it using addUniform and make sure that uniform buffers are supported by the current engine.");return}this._buffer||this.create();let n=this._uniformArraySizes[e];if(this._dynamic)for(let a=0;a<i;a++)this._bufferData[r+a]=t[a];else{let a=!1,o=0,l=0;for(let c=0;c<i;c++)if(this._bufferData[r+l*4+o]!==W.FloatRound(t[c])&&(a=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[r+l*4+o]=t[c]),o++,o===n.strideSize){for(;o<4;o++)this._bufferData[r+l*4+o]=0;o=0,l++}this._needSync=this._needSync||a}}_cacheMatrix(e,t){this._checkNewFrame();let i=this._valueCache[e],r=t.updateFlag;return i!==void 0&&i===r?!1:(this._valueCache[e]=r,!0)}_updateMatrix3x3ForUniform(e,t){for(let i=0;i<3;i++)s._TempBuffer[i*4]=t[i*3],s._TempBuffer[i*4+1]=t[i*3+1],s._TempBuffer[i*4+2]=t[i*3+2],s._TempBuffer[i*4+3]=0;this.updateUniform(e,s._TempBuffer,12)}_updateMatrix3x3ForEffect(e,t){this._currentEffect.setMatrix3x3(e,t)}_updateMatrix2x2ForEffect(e,t){this._currentEffect.setMatrix2x2(e,t)}_updateMatrix2x2ForUniform(e,t){for(let i=0;i<2;i++)s._TempBuffer[i*4]=t[i*2],s._TempBuffer[i*4+1]=t[i*2+1],s._TempBuffer[i*4+2]=0,s._TempBuffer[i*4+3]=0;this.updateUniform(e,s._TempBuffer,8)}_updateFloatForEffect(e,t,i=""){this._currentEffect.setFloat(e+i,t)}_updateFloatForUniform(e,t){s._TempBuffer[0]=t,this.updateUniform(e,s._TempBuffer,1)}_updateFloat2ForEffect(e,t,i,r=""){this._currentEffect.setFloat2(e+r,t,i)}_updateFloat2ForUniform(e,t,i){s._TempBuffer[0]=t,s._TempBuffer[1]=i,this.updateUniform(e,s._TempBuffer,2)}_updateFloat3ForEffect(e,t,i,r,n=""){this._currentEffect.setFloat3(e+n,t,i,r)}_updateFloat3ForUniform(e,t,i,r){s._TempBuffer[0]=t,s._TempBuffer[1]=i,s._TempBuffer[2]=r,this.updateUniform(e,s._TempBuffer,3)}_updateFloat4ForEffect(e,t,i,r,n,a=""){this._currentEffect.setFloat4(e+a,t,i,r,n)}_updateFloat4ForUniform(e,t,i,r,n){s._TempBuffer[0]=t,s._TempBuffer[1]=i,s._TempBuffer[2]=r,s._TempBuffer[3]=n,this.updateUniform(e,s._TempBuffer,4)}_updateFloatArrayForEffect(e,t,i=""){switch(this._uniformArraySizes[e]?.strideSize){case 2:this._currentEffect.setFloatArray2(e+i,t);break;case 3:this._currentEffect.setFloatArray3(e+i,t);break;case 4:this._currentEffect.setFloatArray4(e+i,t);break;default:this._currentEffect.setFloatArray(e+i,t);break}}_updateFloatArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateArrayForEffect(e,t){this._currentEffect.setArray(e,t)}_updateArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateIntArrayForEffect(e,t){this._currentEffect.setIntArray(e,t)}_updateIntArrayForUniform(e,t){s._TempBufferInt32View.set(t),this.updateUniformArray(e,s._TempBuffer,t.length)}_updateUIntArrayForEffect(e,t){this._currentEffect.setUIntArray(e,t)}_updateUIntArrayForUniform(e,t){s._TempBufferUInt32View.set(t),this.updateUniformArray(e,s._TempBuffer,t.length)}_updateMatrixForEffect(e,t){this._currentEffect.setMatrix(e,t)}_updateMatrixForUniform(e,t){this._cacheMatrix(e,t)&&this.updateUniform(e,t.asArray(),16)}_updateMatricesForEffect(e,t){this._currentEffect.setMatrices(e,t)}_updateMatricesForUniform(e,t){this.updateUniform(e,t,t.length)}_updateVector3ForEffect(e,t){this._currentEffect.setVector3(e,t)}_updateVector3ForUniform(e,t){s._TempBuffer[0]=t.x,s._TempBuffer[1]=t.y,s._TempBuffer[2]=t.z,this.updateUniform(e,s._TempBuffer,3)}_updateVector4ForEffect(e,t){this._currentEffect.setVector4(e,t)}_updateVector4ForUniform(e,t){s._TempBuffer[0]=t.x,s._TempBuffer[1]=t.y,s._TempBuffer[2]=t.z,s._TempBuffer[3]=t.w,this.updateUniform(e,s._TempBuffer,4)}_updateColor3ForEffect(e,t,i=""){this._currentEffect.setColor3(e+i,t)}_updateColor3ForUniform(e,t){s._TempBuffer[0]=t.r,s._TempBuffer[1]=t.g,s._TempBuffer[2]=t.b,this.updateUniform(e,s._TempBuffer,3)}_updateColor4ForEffect(e,t,i,r=""){this._currentEffect.setColor4(e+r,t,i)}_updateDirectColor4ForEffect(e,t,i=""){this._currentEffect.setDirectColor4(e+i,t)}_updateColor4ForUniform(e,t,i){s._TempBuffer[0]=t.r,s._TempBuffer[1]=t.g,s._TempBuffer[2]=t.b,s._TempBuffer[3]=i,this.updateUniform(e,s._TempBuffer,4)}_updateDirectColor4ForUniform(e,t){s._TempBuffer[0]=t.r,s._TempBuffer[1]=t.g,s._TempBuffer[2]=t.b,s._TempBuffer[3]=t.a,this.updateUniform(e,s._TempBuffer,4)}_updateIntForEffect(e,t,i=""){this._currentEffect.setInt(e+i,t)}_updateIntForUniform(e,t){s._TempBufferInt32View[0]=t,this.updateUniform(e,s._TempBuffer,1)}_updateInt2ForEffect(e,t,i,r=""){this._currentEffect.setInt2(e+r,t,i)}_updateInt2ForUniform(e,t,i){s._TempBufferInt32View[0]=t,s._TempBufferInt32View[1]=i,this.updateUniform(e,s._TempBuffer,2)}_updateInt3ForEffect(e,t,i,r,n=""){this._currentEffect.setInt3(e+n,t,i,r)}_updateInt3ForUniform(e,t,i,r){s._TempBufferInt32View[0]=t,s._TempBufferInt32View[1]=i,s._TempBufferInt32View[2]=r,this.updateUniform(e,s._TempBuffer,3)}_updateInt4ForEffect(e,t,i,r,n,a=""){this._currentEffect.setInt4(e+a,t,i,r,n)}_updateInt4ForUniform(e,t,i,r,n){s._TempBufferInt32View[0]=t,s._TempBufferInt32View[1]=i,s._TempBufferInt32View[2]=r,s._TempBufferInt32View[3]=n,this.updateUniform(e,s._TempBuffer,4)}_updateUIntForEffect(e,t,i=""){this._currentEffect.setUInt(e+i,t)}_updateUIntForUniform(e,t){s._TempBufferUInt32View[0]=t,this.updateUniform(e,s._TempBuffer,1)}_updateUInt2ForEffect(e,t,i,r=""){this._currentEffect.setUInt2(e+r,t,i)}_updateUInt2ForUniform(e,t,i){s._TempBufferUInt32View[0]=t,s._TempBufferUInt32View[1]=i,this.updateUniform(e,s._TempBuffer,2)}_updateUInt3ForEffect(e,t,i,r,n=""){this._currentEffect.setUInt3(e+n,t,i,r)}_updateUInt3ForUniform(e,t,i,r){s._TempBufferUInt32View[0]=t,s._TempBufferUInt32View[1]=i,s._TempBufferUInt32View[2]=r,this.updateUniform(e,s._TempBuffer,3)}_updateUInt4ForEffect(e,t,i,r,n,a=""){this._currentEffect.setUInt4(e+a,t,i,r,n)}_updateUInt4ForUniform(e,t,i,r,n){s._TempBufferUInt32View[0]=t,s._TempBufferUInt32View[1]=i,s._TempBufferUInt32View[2]=r,s._TempBufferUInt32View[3]=n,this.updateUniform(e,s._TempBuffer,4)}setTexture(e,t){this._currentEffect.setTexture(e,t)}setTextureArray(e,t){this._currentEffect.setTextureArray(e,t)}bindTexture(e,t){this._currentEffect._bindTexture(e,t)}updateUniformDirectly(e,t){this.updateUniform(e,t,t.length),this.update()}bindToEffect(e,t){this._currentEffect=e,this._currentEffectName=t}bindUniformBuffer(){!this._noUBO&&this._buffer&&this._currentEffect&&this._currentEffect.bindUniformBuffer(this._buffer,this._currentEffectName)}unbindEffect(){this._currentEffect=void 0,this._currentEffectName=void 0}setDataBuffer(e){if(!this._buffers)return this._buffer===e;for(let t=0;t<this._buffers.length;++t)if(this._buffers[t][0]===e)return this._bufferIndex=t,this._buffer=e,this._createBufferOnWrite=!1,this._currentEffect=void 0,this._buffers.length>1&&this._buffers[t][1]&&this._bufferData.set(this._buffers[t][1]),this._valueCache={},this._currentFrameId=this._engine.frameId,!0;return!1}has(e){return this._uniformLocations[e]!==void 0}dispose(){if(this._noUBO)return;let e=this._engine._uniformBuffers,t=e.indexOf(this);if(t!==-1&&(e[t]=e[e.length-1],e.pop()),this._trackUBOsInFrame&&this._buffers)for(let i=0;i<this._buffers.length;++i){let r=this._buffers[i][0];this._engine._releaseBuffer(r)}else this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null)}};ii._UpdatedUbosInFrame={};ii._MAX_UNIFORM_SIZE=256;ii._TempBuffer=new Float32Array(ii._MAX_UNIFORM_SIZE);ii._TempBufferInt32View=new Int32Array(ii._TempBuffer.buffer);ii._TempBufferUInt32View=new Uint32Array(ii._TempBuffer.buffer)});var Zi,Yc=S(()=>{ie();yt();Zi=class{constructor(){this.hit=!1,this.distance=0,this.pickedPoint=null,this.pickedMesh=null,this.bu=0,this.bv=0,this.faceId=-1,this.subMeshFaceId=-1,this.subMeshId=0,this.pickedSprite=null,this.thinInstanceIndex=-1,this.ray=null,this.originMesh=null,this.aimTransform=null,this.gripTransform=null}getNormal(e=!1,t=!0){if(!this.pickedMesh||t&&!this.pickedMesh.isVerticesDataPresent(A.NormalKind))return null;let i=this.pickedMesh.getIndices();i?.length===0&&(i=null);let r,n=w.Vector3[0],a=w.Vector3[1],o=w.Vector3[2];if(t){let c=this.pickedMesh.getVerticesData(A.NormalKind),f=i?E.FromArrayToRef(c,i[this.faceId*3]*3,n):n.copyFromFloats(c[this.faceId*3*3],c[this.faceId*3*3+1],c[this.faceId*3*3+2]),h=i?E.FromArrayToRef(c,i[this.faceId*3+1]*3,a):a.copyFromFloats(c[(this.faceId*3+1)*3],c[(this.faceId*3+1)*3+1],c[(this.faceId*3+1)*3+2]),u=i?E.FromArrayToRef(c,i[this.faceId*3+2]*3,o):o.copyFromFloats(c[(this.faceId*3+2)*3],c[(this.faceId*3+2)*3+1],c[(this.faceId*3+2)*3+2]);f=f.scale(this.bu),h=h.scale(this.bv),u=u.scale(1-this.bu-this.bv),r=new E(f.x+h.x+u.x,f.y+h.y+u.y,f.z+h.z+u.z)}else{let c=this.pickedMesh.getVerticesData(A.PositionKind),f=i?E.FromArrayToRef(c,i[this.faceId*3]*3,n):n.copyFromFloats(c[this.faceId*3*3],c[this.faceId*3*3+1],c[this.faceId*3*3+2]),h=i?E.FromArrayToRef(c,i[this.faceId*3+1]*3,a):a.copyFromFloats(c[(this.faceId*3+1)*3],c[(this.faceId*3+1)*3+1],c[(this.faceId*3+1)*3+2]),u=i?E.FromArrayToRef(c,i[this.faceId*3+2]*3,o):o.copyFromFloats(c[(this.faceId*3+2)*3],c[(this.faceId*3+2)*3+1],c[(this.faceId*3+2)*3+2]),d=f.subtract(h),p=u.subtract(h);r=E.Cross(d,p)}let l=(c,f)=>{if(this.thinInstanceIndex!==-1){let u=c.thinInstanceGetWorldMatrices()[this.thinInstanceIndex];u&&E.TransformNormalToRef(f,u,f)}let h=c.getWorldMatrix();c.nonUniformScaling&&(w.Matrix[0].copyFrom(h),h=w.Matrix[0],h.setTranslationFromFloats(0,0,0),h.invert(),h.transposeToRef(w.Matrix[1]),h=w.Matrix[1]),E.TransformNormalToRef(f,h,f)};if(e&&l(this.pickedMesh,r),this.ray){let c=w.Vector3[0].copyFrom(r);e||l(this.pickedMesh,c),E.Dot(c,this.ray.direction)>0&&r.negateInPlace()}return r.normalize(),r}getTextureCoordinates(e=A.UVKind){if(!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(e))return null;let t=this.pickedMesh.getIndices();if(!t)return null;let i=this.pickedMesh.getVerticesData(e);if(!i)return null;let r=he.FromArray(i,t[this.faceId*3]*2),n=he.FromArray(i,t[this.faceId*3+1]*2),a=he.FromArray(i,t[this.faceId*3+2]*2);return r=r.scale(this.bu),n=n.scale(this.bv),a=a.scale(1-this.bu-this.bv),new he(r.x+n.x+a.x,r.y+n.y+a.y)}}});var Mi,BR=S(()=>{Mi=class s{constructor(e,t,i,r,n,a){this.source=e,this.pointerX=t,this.pointerY=i,this.meshUnderPointer=r,this.sourceEvent=n,this.additionalData=a}static CreateNew(e,t,i){let r=e.getScene();return new s(e,r.pointerX,r.pointerY,r.meshUnderPointer||e,t,i)}static CreateNewFromSprite(e,t,i,r){return new s(e,t.pointerX,t.pointerY,t.meshUnderPointer,i,r)}static CreateNewFromScene(e,t){return new s(null,e.pointerX,e.pointerY,e.meshUnderPointer,t)}static CreateNewFromPrimitive(e,t,i,r){return new s(e,t.x,t.y,null,i,r)}}});var ne,$t,Pn=S(()=>{ne=class{};ne.NAME_EFFECTLAYER="EffectLayer";ne.NAME_LAYER="Layer";ne.NAME_LENSFLARESYSTEM="LensFlareSystem";ne.NAME_BOUNDINGBOXRENDERER="BoundingBoxRenderer";ne.NAME_PARTICLESYSTEM="ParticleSystem";ne.NAME_GAMEPAD="Gamepad";ne.NAME_SIMPLIFICATIONQUEUE="SimplificationQueue";ne.NAME_GEOMETRYBUFFERRENDERER="GeometryBufferRenderer";ne.NAME_PREPASSRENDERER="PrePassRenderer";ne.NAME_DEPTHRENDERER="DepthRenderer";ne.NAME_DEPTHPEELINGRENDERER="DepthPeelingRenderer";ne.NAME_POSTPROCESSRENDERPIPELINEMANAGER="PostProcessRenderPipelineManager";ne.NAME_SPRITE="Sprite";ne.NAME_SUBSURFACE="SubSurface";ne.NAME_OUTLINERENDERER="Outline";ne.NAME_PROCEDURALTEXTURE="ProceduralTexture";ne.NAME_SHADOWGENERATOR="ShadowGenerator";ne.NAME_OCTREE="Octree";ne.NAME_PHYSICSENGINE="PhysicsEngine";ne.NAME_AUDIO="Audio";ne.NAME_FLUIDRENDERER="FluidRenderer";ne.NAME_IBLCDFGENERATOR="iblCDFGenerator";ne.NAME_CLUSTEREDLIGHTING="ClusteredLighting";ne.STEP_ISREADYFORMESH_EFFECTLAYER=0;ne.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER=0;ne.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER=0;ne.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER=0;ne.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER=1;ne.STEP_BEFORECAMERADRAW_PREPASS=0;ne.STEP_BEFORECAMERADRAW_EFFECTLAYER=1;ne.STEP_BEFORECAMERADRAW_LAYER=2;ne.STEP_BEFORERENDERTARGETDRAW_PREPASS=0;ne.STEP_BEFORERENDERTARGETDRAW_LAYER=1;ne.STEP_BEFORERENDERINGMESH_PREPASS=0;ne.STEP_BEFORERENDERINGMESH_OUTLINE=1;ne.STEP_AFTERRENDERINGMESH_PREPASS=0;ne.STEP_AFTERRENDERINGMESH_OUTLINE=1;ne.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW=0;ne.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER=1;ne.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE=0;ne.STEP_BEFORECLEAR_PROCEDURALTEXTURE=0;ne.STEP_BEFORECLEAR_PREPASS=1;ne.STEP_BEFORERENDERTARGETCLEAR_PREPASS=0;ne.STEP_AFTERRENDERTARGETDRAW_PREPASS=0;ne.STEP_AFTERRENDERTARGETDRAW_LAYER=1;ne.STEP_AFTERCAMERADRAW_PREPASS=0;ne.STEP_AFTERCAMERADRAW_EFFECTLAYER=1;ne.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM=2;ne.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW=3;ne.STEP_AFTERCAMERADRAW_LAYER=4;ne.STEP_AFTERCAMERADRAW_FLUIDRENDERER=5;ne.STEP_AFTERCAMERAPOSTPROCESS_LAYER=0;ne.STEP_AFTERRENDERTARGETPOSTPROCESS_LAYER=0;ne.STEP_AFTERRENDER_AUDIO=0;ne.STEP_GATHERRENDERTARGETS_DEPTHRENDERER=0;ne.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER=1;ne.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR=2;ne.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER=3;ne.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER=0;ne.STEP_GATHERACTIVECAMERARENDERTARGETS_FLUIDRENDERER=1;ne.STEP_GATHERACTIVECAMERARENDERTARGETS_CLUSTEREDLIGHTING=2;ne.STEP_POINTERMOVE_SPRITE=0;ne.STEP_POINTERDOWN_SPRITE=0;ne.STEP_POINTERUP_SPRITE=0;$t=class s extends Array{constructor(e){super(...e)}static Create(){return Object.create(s.prototype)}registerStep(e,t,i){let r=0,n=Number.MAX_VALUE;for(;r<this.length&&(n=this[r].index,!(e<n));r++);this.splice(r,0,{index:e,component:t,action:i.bind(t)})}clear(){this.length=0}}});var ce,Sm,Em,nr,ns=S(()=>{ie();ce=class{};ce.POINTERDOWN=1;ce.POINTERUP=2;ce.POINTERMOVE=4;ce.POINTERWHEEL=8;ce.POINTERPICK=16;ce.POINTERTAP=32;ce.POINTERDOUBLETAP=64;Sm=class{constructor(e,t){this.type=e,this.event=t}},Em=class extends Sm{constructor(e,t,i,r){super(e,t),this.ray=null,this.originalPickingInfo=null,this.skipOnPointerObservable=!1,this.localPosition=new he(i,r)}},nr=class extends Sm{get pickInfo(){return this._pickInfo||this._generatePickInfo(),this._pickInfo}constructor(e,t,i,r=null){super(e,t),this._pickInfo=i,this._inputManager=r}_generatePickInfo(){this._inputManager&&(this._pickInfo=this._inputManager._pickMove(this.event),this._inputManager._setRayOnPointerInfo(this._pickInfo,this.event),this._inputManager=null)}}});var Ta,FL=S(()=>{Ta=class s{constructor(){this.hoverCursor="",this.actions=[],this.isRecursive=!1,this.disposeWhenUnowned=!0}static get HasTriggers(){for(let e in s.Triggers)if(Object.prototype.hasOwnProperty.call(s.Triggers,e))return!0;return!1}static get HasPickTriggers(){for(let e in s.Triggers)if(Object.prototype.hasOwnProperty.call(s.Triggers,e)){let t=parseInt(e);if(t>=1&&t<=7)return!0}return!1}static HasSpecificTrigger(e){for(let t in s.Triggers)if(Object.prototype.hasOwnProperty.call(s.Triggers,t)&&parseInt(t)===e)return!0;return!1}};Ta.Triggers={}});var $s,Kc,Hh,Tm=S(()=>{$s=class{};$s.KEYDOWN=1;$s.KEYUP=2;Kc=class{constructor(e,t){this.type=e,this.event=t}},Hh=class extends Kc{get skipOnPointerObservable(){return this.skipOnKeyboardObservable}set skipOnPointerObservable(e){this.skipOnKeyboardObservable=e}constructor(e,t){super(e,t),this.type=e,this.event=t,this.skipOnKeyboardObservable=!1}}});var ge,Ie,NL,BL,UL,GL,VL,bl=S(()=>{(function(s){s[s.Generic=0]="Generic",s[s.Keyboard=1]="Keyboard",s[s.Mouse=2]="Mouse",s[s.Touch=3]="Touch",s[s.DualShock=4]="DualShock",s[s.Xbox=5]="Xbox",s[s.Switch=6]="Switch",s[s.DualSense=7]="DualSense"})(ge||(ge={}));(function(s){s[s.Horizontal=0]="Horizontal",s[s.Vertical=1]="Vertical",s[s.LeftClick=2]="LeftClick",s[s.MiddleClick=3]="MiddleClick",s[s.RightClick=4]="RightClick",s[s.BrowserBack=5]="BrowserBack",s[s.BrowserForward=6]="BrowserForward",s[s.MouseWheelX=7]="MouseWheelX",s[s.MouseWheelY=8]="MouseWheelY",s[s.MouseWheelZ=9]="MouseWheelZ",s[s.Move=12]="Move"})(Ie||(Ie={}));(function(s){s[s.Horizontal=0]="Horizontal",s[s.Vertical=1]="Vertical",s[s.LeftClick=2]="LeftClick",s[s.MiddleClick=3]="MiddleClick",s[s.RightClick=4]="RightClick",s[s.BrowserBack=5]="BrowserBack",s[s.BrowserForward=6]="BrowserForward",s[s.MouseWheelX=7]="MouseWheelX",s[s.MouseWheelY=8]="MouseWheelY",s[s.MouseWheelZ=9]="MouseWheelZ",s[s.DeltaHorizontal=10]="DeltaHorizontal",s[s.DeltaVertical=11]="DeltaVertical"})(NL||(NL={}));(function(s){s[s.Cross=0]="Cross",s[s.Circle=1]="Circle",s[s.Square=2]="Square",s[s.Triangle=3]="Triangle",s[s.L1=4]="L1",s[s.R1=5]="R1",s[s.L2=6]="L2",s[s.R2=7]="R2",s[s.Share=8]="Share",s[s.Options=9]="Options",s[s.L3=10]="L3",s[s.R3=11]="R3",s[s.DPadUp=12]="DPadUp",s[s.DPadDown=13]="DPadDown",s[s.DPadLeft=14]="DPadLeft",s[s.DPadRight=15]="DPadRight",s[s.Home=16]="Home",s[s.TouchPad=17]="TouchPad",s[s.LStickXAxis=18]="LStickXAxis",s[s.LStickYAxis=19]="LStickYAxis",s[s.RStickXAxis=20]="RStickXAxis",s[s.RStickYAxis=21]="RStickYAxis"})(BL||(BL={}));(function(s){s[s.Cross=0]="Cross",s[s.Circle=1]="Circle",s[s.Square=2]="Square",s[s.Triangle=3]="Triangle",s[s.L1=4]="L1",s[s.R1=5]="R1",s[s.L2=6]="L2",s[s.R2=7]="R2",s[s.Create=8]="Create",s[s.Options=9]="Options",s[s.L3=10]="L3",s[s.R3=11]="R3",s[s.DPadUp=12]="DPadUp",s[s.DPadDown=13]="DPadDown",s[s.DPadLeft=14]="DPadLeft",s[s.DPadRight=15]="DPadRight",s[s.Home=16]="Home",s[s.TouchPad=17]="TouchPad",s[s.LStickXAxis=18]="LStickXAxis",s[s.LStickYAxis=19]="LStickYAxis",s[s.RStickXAxis=20]="RStickXAxis",s[s.RStickYAxis=21]="RStickYAxis"})(UL||(UL={}));(function(s){s[s.A=0]="A",s[s.B=1]="B",s[s.X=2]="X",s[s.Y=3]="Y",s[s.LB=4]="LB",s[s.RB=5]="RB",s[s.LT=6]="LT",s[s.RT=7]="RT",s[s.Back=8]="Back",s[s.Start=9]="Start",s[s.LS=10]="LS",s[s.RS=11]="RS",s[s.DPadUp=12]="DPadUp",s[s.DPadDown=13]="DPadDown",s[s.DPadLeft=14]="DPadLeft",s[s.DPadRight=15]="DPadRight",s[s.Home=16]="Home",s[s.LStickXAxis=17]="LStickXAxis",s[s.LStickYAxis=18]="LStickYAxis",s[s.RStickXAxis=19]="RStickXAxis",s[s.RStickYAxis=20]="RStickYAxis"})(GL||(GL={}));(function(s){s[s.B=0]="B",s[s.A=1]="A",s[s.Y=2]="Y",s[s.X=3]="X",s[s.L=4]="L",s[s.R=5]="R",s[s.ZL=6]="ZL",s[s.ZR=7]="ZR",s[s.Minus=8]="Minus",s[s.Plus=9]="Plus",s[s.LS=10]="LS",s[s.RS=11]="RS",s[s.DPadUp=12]="DPadUp",s[s.DPadDown=13]="DPadDown",s[s.DPadLeft=14]="DPadLeft",s[s.DPadRight=15]="DPadRight",s[s.Home=16]="Home",s[s.Capture=17]="Capture",s[s.LStickXAxis=18]="LStickXAxis",s[s.LStickYAxis=19]="LStickYAxis",s[s.RStickXAxis=20]="RStickXAxis",s[s.RStickYAxis=21]="RStickYAxis"})(VL||(VL={}))});var kL,en,xm=S(()=>{(function(s){s[s.PointerMove=0]="PointerMove",s[s.PointerDown=1]="PointerDown",s[s.PointerUp=2]="PointerUp"})(kL||(kL={}));en=class{};en.DOM_DELTA_PIXEL=0;en.DOM_DELTA_LINE=1;en.DOM_DELTA_PAGE=2});var tn,UR=S(()=>{xm();bl();tn=class{static CreateDeviceEvent(e,t,i,r,n,a,o){switch(e){case ge.Keyboard:return this._CreateKeyboardEvent(i,r,n,a);case ge.Mouse:if(i===Ie.MouseWheelX||i===Ie.MouseWheelY||i===Ie.MouseWheelZ)return this._CreateWheelEvent(e,t,i,r,n,a);case ge.Touch:return this._CreatePointerEvent(e,t,i,r,n,a,o);default:throw`Unable to generate event for device ${ge[e]}`}}static _CreatePointerEvent(e,t,i,r,n,a,o){let l=this._CreateMouseEvent(e,t,i,r,n,a);e===ge.Mouse?(l.deviceType=ge.Mouse,l.pointerId=1,l.pointerType="mouse"):(l.deviceType=ge.Touch,l.pointerId=o??t,l.pointerType="touch");let c=0;return c+=n.pollInput(e,t,Ie.LeftClick),c+=n.pollInput(e,t,Ie.RightClick)*2,c+=n.pollInput(e,t,Ie.MiddleClick)*4,l.buttons=c,i===Ie.Move?l.type="pointermove":i>=Ie.LeftClick&&i<=Ie.RightClick&&(l.type=r===1?"pointerdown":"pointerup",l.button=i-2),l}static _CreateWheelEvent(e,t,i,r,n,a){let o=this._CreateMouseEvent(e,t,i,r,n,a);switch(o.pointerId=1,o.type="wheel",o.deltaMode=en.DOM_DELTA_PIXEL,o.deltaX=0,o.deltaY=0,o.deltaZ=0,i){case Ie.MouseWheelX:o.deltaX=r;break;case Ie.MouseWheelY:o.deltaY=r;break;case Ie.MouseWheelZ:o.deltaZ=r;break}return o}static _CreateMouseEvent(e,t,i,r,n,a){let o=this._CreateEvent(a),l=n.pollInput(e,t,Ie.Horizontal),c=n.pollInput(e,t,Ie.Vertical);return a?(o.movementX=0,o.movementY=0,o.offsetX=o.movementX-a.getBoundingClientRect().x,o.offsetY=o.movementY-a.getBoundingClientRect().y):(o.movementX=n.pollInput(e,t,10),o.movementY=n.pollInput(e,t,11),o.offsetX=0,o.offsetY=0),this._CheckNonCharacterKeys(o,n),o.clientX=l,o.clientY=c,o.x=l,o.y=c,o.deviceType=e,o.deviceSlot=t,o.inputIndex=i,o}static _CreateKeyboardEvent(e,t,i,r){let n=this._CreateEvent(r);return this._CheckNonCharacterKeys(n,i),n.deviceType=ge.Keyboard,n.deviceSlot=0,n.inputIndex=e,n.type=t===1?"keydown":"keyup",n.key=String.fromCharCode(e),n.keyCode=e,n}static _CheckNonCharacterKeys(e,t){let i=t.isDeviceAvailable(ge.Keyboard),r=i&&t.pollInput(ge.Keyboard,0,18)===1,n=i&&t.pollInput(ge.Keyboard,0,17)===1,a=i&&(t.pollInput(ge.Keyboard,0,91)===1||t.pollInput(ge.Keyboard,0,92)===1||t.pollInput(ge.Keyboard,0,93)===1),o=i&&t.pollInput(ge.Keyboard,0,16)===1;e.altKey=r,e.ctrlKey=n,e.metaKey=a,e.shiftKey=o}static _CreateEvent(e){let t={};return t.preventDefault=()=>{},t.target=e,t}}});var Am,WL=S(()=>{UR();bl();Am=class{constructor(e,t,i){this._nativeInput=_native.DeviceInputSystem?new _native.DeviceInputSystem(e,t,(r,n,a,o)=>{let l=tn.CreateDeviceEvent(r,n,a,o,this);i(r,n,l)}):this._createDummyNativeInput()}pollInput(e,t,i){return this._nativeInput.pollInput(e,t,i)}isDeviceAvailable(e){return e===ge.Mouse||e===ge.Touch}dispose(){this._nativeInput.dispose()}_createDummyNativeInput(){return{pollInput:()=>0,isDeviceAvailable:()=>!1,dispose:()=>{}}}}});var HL,zL,Rm,XL=S(()=>{Cs();$e();UR();bl();HL=255,zL=Object.keys(Ie).length/2,Rm=class{constructor(e,t,i,r){this._inputs=[],this._keyboardActive=!1,this._pointerActive=!1,this._usingSafari=W.IsSafari(),this._usingMacOs=ca()&&/(Mac|iPhone|iPod|iPad)/i.test(navigator.platform),this._keyboardDownEvent=n=>{},this._keyboardUpEvent=n=>{},this._keyboardBlurEvent=n=>{},this._pointerMoveEvent=n=>{},this._pointerDownEvent=n=>{},this._pointerUpEvent=n=>{},this._pointerCancelEvent=n=>{},this._pointerCancelTouch=n=>{},this._pointerLeaveEvent=n=>{},this._pointerWheelEvent=n=>{},this._pointerBlurEvent=n=>{},this._pointerMacOsChromeOutEvent=n=>{},this._eventsAttached=!1,this._mouseId=-1,this._isUsingFirefox=ca()&&navigator.userAgent&&navigator.userAgent.indexOf("Firefox")!==-1,this._isUsingChromium=ca()&&navigator.userAgent&&navigator.userAgent.indexOf("Chrome")!==-1,this._maxTouchPoints=0,this._pointerInputClearObserver=null,this._gamepadConnectedEvent=n=>{},this._gamepadDisconnectedEvent=n=>{},this._eventPrefix=W.GetPointerPrefix(e),this._engine=e,this._onDeviceConnected=t,this._onDeviceDisconnected=i,this._onInputChanged=r,this._mouseId=this._isUsingFirefox?0:1,this._enableEvents(),this._usingMacOs&&(this._metaKeys=[]),this._engine._onEngineViewChanged||(this._engine._onEngineViewChanged=()=>{this._enableEvents()})}pollInput(e,t,i){let r=this._inputs[e][t];if(!r)throw`Unable to find device ${ge[e]}`;e>=ge.DualShock&&e<=ge.DualSense&&this._updateDevice(e,t,i);let n=r[i];if(n===void 0)throw`Unable to find input ${i} for device ${ge[e]} in slot ${t}`;return i===Ie.Move&&W.Warn("Unable to provide information for PointerInput.Move.  Try using PointerInput.Horizontal or PointerInput.Vertical for move data."),n}isDeviceAvailable(e){return this._inputs[e]!==void 0}dispose(){this._onDeviceConnected=()=>{},this._onDeviceDisconnected=()=>{},this._onInputChanged=()=>{},delete this._engine._onEngineViewChanged,this._elementToAttachTo&&this._disableEvents()}_enableEvents(){let e=this?._engine.getInputElement();if(e&&(!this._eventsAttached||this._elementToAttachTo!==e)){if(this._disableEvents(),this._inputs){for(let t of this._inputs)if(t)for(let i in t){let r=+i,n=t[r];if(n)for(let a=0;a<n.length;a++)n[a]=0}}this._elementToAttachTo=e,this._elementToAttachTo.tabIndex=this._elementToAttachTo.tabIndex!==-1?this._elementToAttachTo.tabIndex:this._engine.canvasTabIndex,this._handleKeyActions(),this._handlePointerActions(),this._handleGamepadActions(),this._eventsAttached=!0,this._checkForConnectedDevices()}}_disableEvents(){this._elementToAttachTo&&(this._elementToAttachTo.removeEventListener("blur",this._keyboardBlurEvent),this._elementToAttachTo.removeEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.removeEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.removeEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"leave",this._pointerLeaveEvent),this._elementToAttachTo.removeEventListener(this._wheelEventName,this._pointerWheelEvent),this._usingMacOs&&this._isUsingChromium&&this._elementToAttachTo.removeEventListener("lostpointercapture",this._pointerMacOsChromeOutEvent),window.removeEventListener("gamepadconnected",this._gamepadConnectedEvent),window.removeEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)),this._pointerInputClearObserver&&this._engine.onEndFrameObservable.remove(this._pointerInputClearObserver),this._eventsAttached=!1}_checkForConnectedDevices(){if(navigator.getGamepads){let e=navigator.getGamepads();for(let t of e)t&&this._addGamePad(t)}typeof matchMedia=="function"&&matchMedia("(pointer:fine)").matches&&this._addPointerDevice(ge.Mouse,0,0,0)}_addGamePad(e){let t=this._getGamepadDeviceType(e.id),i=e.index;this._gamepads=this._gamepads||new Array(e.index+1),this._registerDevice(t,i,e.buttons.length+e.axes.length),this._gamepads[i]=t}_addPointerDevice(e,t,i,r){this._pointerActive||(this._pointerActive=!0),this._registerDevice(e,t,zL);let n=this._inputs[e][t];n[0]=i,n[1]=r}_registerDevice(e,t,i){if(t===void 0)throw`Unable to register device ${ge[e]} to undefined slot.`;if(this._inputs[e]||(this._inputs[e]={}),!this._inputs[e][t]){let r=new Array(i);r.fill(0),this._inputs[e][t]=r,this._onDeviceConnected(e,t)}}_unregisterDevice(e,t){this._inputs[e][t]&&(delete this._inputs[e][t],this._onDeviceDisconnected(e,t))}_handleKeyActions(){this._keyboardDownEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(ge.Keyboard,0,HL));let t=this._inputs[ge.Keyboard][0];if(t){t[e.keyCode]=1;let i=e;i.inputIndex=e.keyCode,this._usingMacOs&&e.metaKey&&e.key!=="Meta"&&(this._metaKeys.includes(e.keyCode)||this._metaKeys.push(e.keyCode)),this._onInputChanged(ge.Keyboard,0,i)}},this._keyboardUpEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(ge.Keyboard,0,HL));let t=this._inputs[ge.Keyboard][0];if(t){t[e.keyCode]=0;let i=e;if(i.inputIndex=e.keyCode,this._usingMacOs&&e.key==="Meta"&&this._metaKeys.length>0){for(let r of this._metaKeys){let n=tn.CreateDeviceEvent(ge.Keyboard,0,r,0,this,this._elementToAttachTo);t[r]=0,this._onInputChanged(ge.Keyboard,0,n)}this._metaKeys.splice(0,this._metaKeys.length)}this._onInputChanged(ge.Keyboard,0,i)}},this._keyboardBlurEvent=()=>{if(this._keyboardActive){let e=this._inputs[ge.Keyboard][0];for(let t=0;t<e.length;t++)if(e[t]!==0){e[t]=0;let i=tn.CreateDeviceEvent(ge.Keyboard,0,t,0,this,this._elementToAttachTo);this._onInputChanged(ge.Keyboard,0,i)}this._usingMacOs&&this._metaKeys.splice(0,this._metaKeys.length)}},this._elementToAttachTo.addEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.addEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.addEventListener("blur",this._keyboardBlurEvent)}_handlePointerActions(){this._maxTouchPoints=ca()&&navigator.maxTouchPoints||2,this._activeTouchIds||(this._activeTouchIds=new Array(this._maxTouchPoints));for(let i=0;i<this._maxTouchPoints;i++)this._activeTouchIds[i]=-1;this._pointerMoveEvent=i=>{let r=this._getPointerType(i),n=r===ge.Mouse?0:this._activeTouchIds.indexOf(i.pointerId);if(r===ge.Touch&&n===-1){let o=this._activeTouchIds.indexOf(-1);if(o>=0)n=o,this._activeTouchIds[o]=i.pointerId,this._onDeviceConnected(r,n);else{W.Warn(`Max number of touches exceeded.  Ignoring touches in excess of ${this._maxTouchPoints}`);return}}this._inputs[r]||(this._inputs[r]={}),this._inputs[r][n]||this._addPointerDevice(r,n,i.clientX,i.clientY);let a=this._inputs[r][n];if(a){let o=i;o.inputIndex=Ie.Move,a[Ie.Horizontal]=i.clientX,a[Ie.Vertical]=i.clientY,r===ge.Touch&&a[Ie.LeftClick]===0&&(a[Ie.LeftClick]=1),i.pointerId===void 0&&(i.pointerId=this._mouseId),this._onInputChanged(r,n,o),!this._usingSafari&&i.button!==-1&&(o.inputIndex=i.button+2,a[i.button+2]=a[i.button+2]?0:1,this._onInputChanged(r,n,o))}},this._pointerDownEvent=i=>{let r=this._getPointerType(i),n=r===ge.Mouse?0:i.pointerId;if(r===ge.Touch){let o=this._activeTouchIds.indexOf(i.pointerId);if(o===-1&&(o=this._activeTouchIds.indexOf(-1)),o>=0)n=o,this._activeTouchIds[o]=i.pointerId;else{W.Warn(`Max number of touches exceeded.  Ignoring touches in excess of ${this._maxTouchPoints}`);return}}this._inputs[r]||(this._inputs[r]={}),this._inputs[r][n]?r===ge.Touch&&this._onDeviceConnected(r,n):this._addPointerDevice(r,n,i.clientX,i.clientY);let a=this._inputs[r][n];if(a){let o=a[Ie.Horizontal],l=a[Ie.Vertical];if(r===ge.Mouse){if(i.pointerId===void 0&&(i.pointerId=this._mouseId),!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(this._mouseId)}catch{}}else if(i.pointerId&&!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(i.pointerId)}catch{}a[Ie.Horizontal]=i.clientX,a[Ie.Vertical]=i.clientY,a[i.button+2]=1;let c=i;c.inputIndex=i.button+2,this._onInputChanged(r,n,c),(o!==i.clientX||l!==i.clientY)&&(c.inputIndex=Ie.Move,this._onInputChanged(r,n,c))}},this._pointerUpEvent=i=>{let r=this._getPointerType(i),n=r===ge.Mouse?0:this._activeTouchIds.indexOf(i.pointerId);if(r===ge.Touch){if(n===-1)return;this._activeTouchIds[n]=-1}let a=this._inputs[r]?.[n],o=i.button,l=a&&a[o+2]!==0;if(!l&&this._isUsingFirefox&&this._usingMacOs&&a&&(o=o===2?0:2,l=a[o+2]!==0),l){let c=a[Ie.Horizontal],f=a[Ie.Vertical];a[Ie.Horizontal]=i.clientX,a[Ie.Vertical]=i.clientY,a[o+2]=0;let h=i;i.pointerId===void 0&&(i.pointerId=this._mouseId),(c!==i.clientX||f!==i.clientY)&&(h.inputIndex=Ie.Move,this._onInputChanged(r,n,h)),h.inputIndex=o+2,r===ge.Mouse&&this._mouseId>=0&&this._elementToAttachTo.hasPointerCapture?.(this._mouseId)?this._elementToAttachTo.releasePointerCapture(this._mouseId):i.pointerId&&this._elementToAttachTo.hasPointerCapture?.(i.pointerId)&&this._elementToAttachTo.releasePointerCapture(i.pointerId),this._onInputChanged(r,n,h),r===ge.Touch&&this._onDeviceDisconnected(r,n)}},this._pointerCancelTouch=i=>{let r=this._activeTouchIds.indexOf(i);if(r===-1)return;this._elementToAttachTo.hasPointerCapture?.(i)&&this._elementToAttachTo.releasePointerCapture(i),this._inputs[ge.Touch][r][Ie.LeftClick]=0;let n=tn.CreateDeviceEvent(ge.Touch,r,Ie.LeftClick,0,this,this._elementToAttachTo,i);this._onInputChanged(ge.Touch,r,n),this._activeTouchIds[r]=-1,this._onDeviceDisconnected(ge.Touch,r)},this._pointerCancelEvent=i=>{if(i.pointerType==="mouse"){let r=this._inputs[ge.Mouse][0];this._mouseId>=0&&this._elementToAttachTo.hasPointerCapture?.(this._mouseId)&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let n=Ie.LeftClick;n<=Ie.BrowserForward;n++)if(r[n]===1){r[n]=0;let a=tn.CreateDeviceEvent(ge.Mouse,0,n,0,this,this._elementToAttachTo);this._onInputChanged(ge.Mouse,0,a)}}else this._pointerCancelTouch(i.pointerId)},this._pointerLeaveEvent=i=>{i.pointerType==="pen"&&this._pointerCancelTouch(i.pointerId)},this._wheelEventName="onwheel"in document.createElement("div")?"wheel":document.onmousewheel!==void 0?"mousewheel":"DOMMouseScroll";let e=!1,t=function(){};try{let i=Object.defineProperty({},"passive",{get:function(){e=!0}});this._elementToAttachTo.addEventListener("test",t,i),this._elementToAttachTo.removeEventListener("test",t,i)}catch{}this._pointerBlurEvent=()=>{if(this.isDeviceAvailable(ge.Mouse)){let i=this._inputs[ge.Mouse][0];this._mouseId>=0&&this._elementToAttachTo.hasPointerCapture?.(this._mouseId)&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let r=Ie.LeftClick;r<=Ie.BrowserForward;r++)if(i[r]===1){i[r]=0;let n=tn.CreateDeviceEvent(ge.Mouse,0,r,0,this,this._elementToAttachTo);this._onInputChanged(ge.Mouse,0,n)}}if(this.isDeviceAvailable(ge.Touch)){let i=this._inputs[ge.Touch];for(let r=0;r<this._activeTouchIds.length;r++){let n=this._activeTouchIds[r];if(this._elementToAttachTo.hasPointerCapture?.(n)&&this._elementToAttachTo.releasePointerCapture(n),n!==-1&&i[r]?.[Ie.LeftClick]===1){i[r][Ie.LeftClick]=0;let a=tn.CreateDeviceEvent(ge.Touch,r,Ie.LeftClick,0,this,this._elementToAttachTo,n);this._onInputChanged(ge.Touch,r,a),this._activeTouchIds[r]=-1,this._onDeviceDisconnected(ge.Touch,r)}}}},this._pointerWheelEvent=i=>{let r=ge.Mouse,n=0;this._inputs[r]||(this._inputs[r]=[]),this._inputs[r][n]||(this._pointerActive=!0,this._registerDevice(r,n,zL));let a=this._inputs[r][n];if(a){a[Ie.MouseWheelX]=i.deltaX||0,a[Ie.MouseWheelY]=i.deltaY||i.wheelDelta||0,a[Ie.MouseWheelZ]=i.deltaZ||0;let o=i;i.pointerId===void 0&&(i.pointerId=this._mouseId),a[Ie.MouseWheelX]!==0&&(o.inputIndex=Ie.MouseWheelX,this._onInputChanged(r,n,o)),a[Ie.MouseWheelY]!==0&&(o.inputIndex=Ie.MouseWheelY,this._onInputChanged(r,n,o)),a[Ie.MouseWheelZ]!==0&&(o.inputIndex=Ie.MouseWheelZ,this._onInputChanged(r,n,o))}},this._usingMacOs&&this._isUsingChromium&&(this._pointerMacOsChromeOutEvent=i=>{i.buttons>1&&this._pointerCancelEvent(i)},this._elementToAttachTo.addEventListener("lostpointercapture",this._pointerMacOsChromeOutEvent)),this._elementToAttachTo.addEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"leave",this._pointerLeaveEvent),this._elementToAttachTo.addEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.addEventListener(this._wheelEventName,this._pointerWheelEvent,e?{passive:!1}:!1),this._pointerInputClearObserver=this._engine.onEndFrameObservable.add(()=>{if(this.isDeviceAvailable(ge.Mouse)){let i=this._inputs[ge.Mouse][0];i[Ie.MouseWheelX]=0,i[Ie.MouseWheelY]=0,i[Ie.MouseWheelZ]=0}})}_handleGamepadActions(){this._gamepadConnectedEvent=e=>{this._addGamePad(e.gamepad)},this._gamepadDisconnectedEvent=e=>{if(this._gamepads){let t=this._getGamepadDeviceType(e.gamepad.id),i=e.gamepad.index;this._unregisterDevice(t,i),delete this._gamepads[i]}},window.addEventListener("gamepadconnected",this._gamepadConnectedEvent),window.addEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)}_updateDevice(e,t,i){let r=navigator.getGamepads()[t];if(r&&e===this._gamepads[t]){let n=this._inputs[e][t];i>=r.buttons.length?n[i]=r.axes[i-r.buttons.length].valueOf():n[i]=r.buttons[i].value}}_getGamepadDeviceType(e){return e.indexOf("054c")!==-1?e.indexOf("0ce6")!==-1?ge.DualSense:ge.DualShock:e.indexOf("Xbox One")!==-1||e.search("Xbox 360")!==-1||e.search("xinput")!==-1?ge.Xbox:e.indexOf("057e")!==-1?ge.Switch:ge.Generic}_getPointerType(e){let t=ge.Mouse;return(e.pointerType==="touch"||e.pointerType==="pen"||e.touches)&&(t=ge.Touch),t}}});var zh,YL=S(()=>{we();zh=class{constructor(e,t,i=0){this.deviceType=t,this.deviceSlot=i,this.onInputChangedObservable=new N,this._deviceInputSystem=e}getInput(e){return this._deviceInputSystem.pollInput(this.deviceType,this.deviceSlot,e)}}});var bm,KL=S(()=>{bl();WL();XL();YL();bm=class{constructor(e){this._registeredManagers=new Array,this._refCount=0,this.registerManager=a=>{for(let o=0;o<this._devices.length;o++){let l=this._devices[o];for(let c in l){let f=+c;a._addDevice(new zh(this._deviceInputSystem,o,f))}}this._registeredManagers.push(a)},this.unregisterManager=a=>{let o=this._registeredManagers.indexOf(a);o>-1&&this._registeredManagers.splice(o,1)};let t=Object.keys(ge).length/2;this._devices=new Array(t);let i=(a,o)=>{this._devices[a]||(this._devices[a]=new Array),this._devices[a][o]||(this._devices[a][o]=o);for(let l of this._registeredManagers){let c=new zh(this._deviceInputSystem,a,o);l._addDevice(c)}},r=(a,o)=>{this._devices[a]?.[o]&&delete this._devices[a][o];for(let l of this._registeredManagers)l._removeDevice(a,o)},n=(a,o,l)=>{if(l)for(let c of this._registeredManagers)c._onInputChanged(a,o,l)};typeof _native<"u"?this._deviceInputSystem=new Am(i,r,n):this._deviceInputSystem=new Rm(e,i,r,n)}dispose(){this._deviceInputSystem.dispose()}}});var Cm,qL=S(()=>{bl();we();KL();Cm=class{getDeviceSource(e,t){if(t===void 0){if(this._firstDevice[e]===void 0)return null;t=this._firstDevice[e]}return!this._devices[e]||this._devices[e][t]===void 0?null:this._devices[e][t]}getDeviceSources(e){return this._devices[e]?this._devices[e].filter(t=>!!t):[]}constructor(e){let t=Object.keys(ge).length/2;this._devices=new Array(t),this._firstDevice=new Array(t),this._engine=e,this._engine._deviceSourceManager||(this._engine._deviceSourceManager=new bm(e)),this._engine._deviceSourceManager._refCount++,this.onDeviceConnectedObservable=new N(i=>{for(let r of this._devices)if(r)for(let n of r)n&&this.onDeviceConnectedObservable.notifyObserver(i,n)}),this.onDeviceDisconnectedObservable=new N,this._engine._deviceSourceManager.registerManager(this),this._onDisposeObserver=e.onDisposeObservable.add(()=>{this.dispose()})}dispose(){this.onDeviceConnectedObservable.clear(),this.onDeviceDisconnectedObservable.clear(),this._engine._deviceSourceManager&&(this._engine._deviceSourceManager.unregisterManager(this),--this._engine._deviceSourceManager._refCount<1&&(this._engine._deviceSourceManager.dispose(),delete this._engine._deviceSourceManager)),this._engine.onDisposeObservable.remove(this._onDisposeObserver)}_addDevice(e){this._devices[e.deviceType]||(this._devices[e.deviceType]=[]),this._devices[e.deviceType][e.deviceSlot]||(this._devices[e.deviceType][e.deviceSlot]=e,this._updateFirstDevices(e.deviceType)),this.onDeviceConnectedObservable.notifyObservers(e)}_removeDevice(e,t){let i=this._devices[e]?.[t];this.onDeviceDisconnectedObservable.notifyObservers(i),this._devices[e]?.[t]&&delete this._devices[e][t],this._updateFirstDevices(e)}_onInputChanged(e,t,i){this._devices[e]?.[t]?.onInputChangedObservable.notifyObservers(i)}_updateFirstDevices(e){switch(e){case ge.Keyboard:case ge.Mouse:this._firstDevice[e]=0;break;case ge.Touch:case ge.DualSense:case ge.DualShock:case ge.Xbox:case ge.Switch:case ge.Generic:{delete this._firstDevice[e];let t=this._devices[e];if(t){for(let i=0;i<t.length;i++)if(t[i]){this._firstDevice[e]=i;break}}break}}}}});var Cl,GR=S(()=>{Cl=class{};Cl._IsPickingAvailable=!1});var Im,ar,QL=S(()=>{ns();FL();Yc();ie();BR();Tm();bl();qL();gt();GR();Im=class{constructor(){this._singleClick=!1,this._doubleClick=!1,this._hasSwiped=!1,this._ignore=!1}get singleClick(){return this._singleClick}get doubleClick(){return this._doubleClick}get hasSwiped(){return this._hasSwiped}get ignore(){return this._ignore}set singleClick(e){this._singleClick=e}set doubleClick(e){this._doubleClick=e}set hasSwiped(e){this._hasSwiped=e}set ignore(e){this._ignore=e}},ar=class s{constructor(e){this._alreadyAttached=!1,this._meshPickProceed=!1,this._currentPickResult=null,this._previousPickResult=null,this._activePointerIds=new Array,this._activePointerIdsCount=0,this._doubleClickOccured=!1,this._isSwiping=!1,this._swipeButtonPressed=-1,this._skipPointerTap=!1,this._isMultiTouchGesture=!1,this._pointerX=0,this._pointerY=0,this._startingPointerPosition=new he(0,0),this._previousStartingPointerPosition=new he(0,0),this._startingPointerTime=0,this._previousStartingPointerTime=0,this._pointerCaptures={},this._meshUnderPointerId={},this._movePointerInfo=null,this._cameraObserverCount=0,this._delayedClicks=[null,null,null,null,null],this._deviceSourceManager=null,this._scene=e||Z.LastCreatedScene,this._scene}get meshUnderPointer(){return this._movePointerInfo&&(this._movePointerInfo._generatePickInfo(),this._movePointerInfo=null),this._pointerOverMesh}getMeshUnderPointerByPointerId(e){return this._meshUnderPointerId[e]||null}get unTranslatedPointer(){return new he(this._unTranslatedPointerX,this._unTranslatedPointerY)}get pointerX(){return this._pointerX}set pointerX(e){this._pointerX=e}get pointerY(){return this._pointerY}set pointerY(e){this._pointerY=e}_updatePointerPosition(e){let t=this._scene.getEngine().getInputElementClientRect();t&&(this._pointerX=e.clientX-t.left,this._pointerY=e.clientY-t.top,this._unTranslatedPointerX=this._pointerX,this._unTranslatedPointerY=this._pointerY)}_processPointerMove(e,t){let i=this._scene,r=i.getEngine(),n=r.getInputElement();n&&(n.tabIndex=r.canvasTabIndex,i.doNotHandleCursors||(n.style.cursor=i.defaultCursor)),this._setCursorAndPointerOverMesh(e,t,i);for(let l of i._pointerMoveStage){e=e||this._pickMove(t);let c=!!e?.pickedMesh;e=l.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,c,n)}let a=t.inputIndex>=Ie.MouseWheelX&&t.inputIndex<=Ie.MouseWheelZ?ce.POINTERWHEEL:ce.POINTERMOVE;i.onPointerMove&&(e=e||this._pickMove(t),i.onPointerMove(t,e,a));let o;e?(o=new nr(a,t,e),this._setRayOnPointerInfo(e,t)):(o=new nr(a,t,null,this),this._movePointerInfo=o),i.onPointerObservable.hasObservers()&&i.onPointerObservable.notifyObservers(o,a)}_setRayOnPointerInfo(e,t){let i=this._scene;e&&Cl._IsPickingAvailable&&(e.ray||(e.ray=i.createPickingRay(t.offsetX,t.offsetY,B.Identity(),i.activeCamera)))}_addCameraPointerObserver(e,t){return this._cameraObserverCount++,this._scene.onPointerObservable.add(e,t)}_removeCameraPointerObserver(e){return this._cameraObserverCount--,this._scene.onPointerObservable.remove(e)}_checkForPicking(){return!!(this._scene.onPointerObservable.observers.length>this._cameraObserverCount||this._scene.onPointerPick)}_checkPrePointerObservable(e,t,i){let r=this._scene,n=new Em(i,t,this._unTranslatedPointerX,this._unTranslatedPointerY);return e&&(n.originalPickingInfo=e,n.ray=e.ray,t.pointerType==="xr-near"&&e.originMesh&&(n.nearInteractionPickingInfo=e)),r.onPrePointerObservable.notifyObservers(n,i),!!n.skipOnPointerObservable}_pickMove(e){let t=this._scene,i=t.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,t.pointerMovePredicate,t.pointerMoveFastCheck,t.cameraToUseForPointers,t.pointerMoveTrianglePredicate);return this._setCursorAndPointerOverMesh(i,e,t),i}_setCursorAndPointerOverMesh(e,t,i){let n=i.getEngine().getInputElement();if(e?.pickedMesh){if(this.setPointerOverMesh(e.pickedMesh,t.pointerId,e,t),!i.doNotHandleCursors&&n&&this._pointerOverMesh){let a=this._pointerOverMesh._getActionManagerForTrigger();a&&a.hasPointerTriggers&&(n.style.cursor=a.hoverCursor||i.hoverCursor)}}else this.setPointerOverMesh(null,t.pointerId,e,t)}simulatePointerMove(e,t){let i=new PointerEvent("pointermove",t);i.inputIndex=Ie.Move,!this._checkPrePointerObservable(e,i,ce.POINTERMOVE)&&this._processPointerMove(e,i)}simulatePointerDown(e,t){let i=new PointerEvent("pointerdown",t);i.inputIndex=i.button+2,!this._checkPrePointerObservable(e,i,ce.POINTERDOWN)&&this._processPointerDown(e,i)}_processPointerDown(e,t){let i=this._scene;if(e?.pickedMesh){this._pickedDownMesh=e.pickedMesh;let a=e.pickedMesh._getActionManagerForTrigger();if(a){if(a.hasPickTriggers)switch(a.processTrigger(5,new Mi(e.pickedMesh,i.pointerX,i.pointerY,e.pickedMesh,t,e)),t.button){case 0:a.processTrigger(2,new Mi(e.pickedMesh,i.pointerX,i.pointerY,e.pickedMesh,t,e));break;case 1:a.processTrigger(4,new Mi(e.pickedMesh,i.pointerX,i.pointerY,e.pickedMesh,t,e));break;case 2:a.processTrigger(3,new Mi(e.pickedMesh,i.pointerX,i.pointerY,e.pickedMesh,t,e));break}a.hasSpecificTrigger(8)&&window.setTimeout(()=>{let o=i.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,l=>l.isPickable&&l.isVisible&&l.isReady()&&l.actionManager&&l.actionManager.hasSpecificTrigger(8)&&l===this._pickedDownMesh,!1,i.cameraToUseForPointers);o?.pickedMesh&&a&&this._activePointerIdsCount!==0&&Date.now()-this._startingPointerTime>s.LongPressDelay&&!this._isPointerSwiping()&&(this._startingPointerTime=0,a.processTrigger(8,Mi.CreateNew(o.pickedMesh,t)))},s.LongPressDelay)}}else for(let a of i._pointerDownStage)e=a.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,t,!1);let r,n=ce.POINTERDOWN;e?(i.onPointerDown&&i.onPointerDown(t,e,n),r=new nr(n,t,e),this._setRayOnPointerInfo(e,t)):r=new nr(n,t,null,this),i.onPointerObservable.hasObservers()&&i.onPointerObservable.notifyObservers(r,n)}_isPointerSwiping(){return this._isSwiping}simulatePointerUp(e,t,i){let r=new PointerEvent("pointerup",t);r.inputIndex=Ie.Move;let n=new Im;i?n.doubleClick=!0:n.singleClick=!0,!this._checkPrePointerObservable(e,r,ce.POINTERUP)&&this._processPointerUp(e,r,n)}_processPointerUp(e,t,i){let r=this._scene;if(e?.pickedMesh){if(this._pickedUpMesh=e.pickedMesh,this._pickedDownMesh===this._pickedUpMesh&&(r.onPointerPick&&r.onPointerPick(t,e),i.singleClick&&!i.ignore&&r.onPointerObservable.observers.length>this._cameraObserverCount)){let a=ce.POINTERPICK,o=new nr(a,t,e);this._setRayOnPointerInfo(e,t),r.onPointerObservable.notifyObservers(o,a)}let n=e.pickedMesh._getActionManagerForTrigger();if(n&&!i.ignore){n.processTrigger(7,Mi.CreateNew(e.pickedMesh,t,e)),!i.hasSwiped&&i.singleClick&&n.processTrigger(1,Mi.CreateNew(e.pickedMesh,t,e));let a=e.pickedMesh._getActionManagerForTrigger(6);i.doubleClick&&a&&a.processTrigger(6,Mi.CreateNew(e.pickedMesh,t,e))}}else if(!i.ignore)for(let n of r._pointerUpStage)e=n.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,t,i.doubleClick);if(this._pickedDownMesh&&this._pickedDownMesh!==this._pickedUpMesh){let n=this._pickedDownMesh._getActionManagerForTrigger(16);n&&n.processTrigger(16,Mi.CreateNew(this._pickedDownMesh,t))}if(!i.ignore){let n=new nr(ce.POINTERUP,t,e);if(this._setRayOnPointerInfo(e,t),r.onPointerObservable.notifyObservers(n,ce.POINTERUP),r.onPointerUp&&r.onPointerUp(t,e,ce.POINTERUP),!i.hasSwiped&&!this._skipPointerTap&&!this._isMultiTouchGesture){let a=0;if(i.singleClick?a=ce.POINTERTAP:i.doubleClick&&(a=ce.POINTERDOUBLETAP),a){let o=new nr(a,t,e);r.onPointerObservable.hasObservers()&&r.onPointerObservable.hasSpecificMask(a)&&r.onPointerObservable.notifyObservers(o,a)}}}}isPointerCaptured(e=0){return this._pointerCaptures[e]}attachControl(e=!0,t=!0,i=!0,r=null){let n=this._scene,a=n.getEngine();r||(r=a.getInputElement()),this._alreadyAttached&&this.detachControl(),r&&(this._alreadyAttachedTo=r),this._deviceSourceManager=new Cm(a),this._initActionManager=o=>{if(!this._meshPickProceed){let l=n.skipPointerUpPicking||n._registeredActions===0&&!this._checkForPicking()&&!n.onPointerUp?null:n.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,n.pointerUpPredicate,n.pointerUpFastCheck,n.cameraToUseForPointers,n.pointerUpTrianglePredicate);this._currentPickResult=l,l&&(o=l.hit&&l.pickedMesh?l.pickedMesh._getActionManagerForTrigger():null),this._meshPickProceed=!0}return o},this._delayedSimpleClick=(o,l,c)=>{if((Date.now()-this._previousStartingPointerTime>s.DoubleClickDelay&&!this._doubleClickOccured||o!==this._previousButtonPressed)&&(this._doubleClickOccured=!1,l.singleClick=!0,l.ignore=!1,this._delayedClicks[o])){let f=this._delayedClicks[o].evt,h=ce.POINTERTAP,u=new nr(h,f,this._currentPickResult);n.onPointerObservable.hasObservers()&&n.onPointerObservable.hasSpecificMask(h)&&n.onPointerObservable.notifyObservers(u,h),this._delayedClicks[o]=null}},this._initClickEvent=(o,l,c,f)=>{let h=new Im;this._currentPickResult=null;let u=null,d=o.hasSpecificMask(ce.POINTERPICK)||l.hasSpecificMask(ce.POINTERPICK)||o.hasSpecificMask(ce.POINTERTAP)||l.hasSpecificMask(ce.POINTERTAP)||o.hasSpecificMask(ce.POINTERDOUBLETAP)||l.hasSpecificMask(ce.POINTERDOUBLETAP);!d&&Ta&&(u=this._initActionManager(u,h),u&&(d=u.hasPickTriggers));let p=!1;if(d=d&&!this._isMultiTouchGesture,d){let m=c.button;if(h.hasSwiped=this._isPointerSwiping(),!h.hasSwiped){let _=!s.ExclusiveDoubleClickMode;if(_||(_=!o.hasSpecificMask(ce.POINTERDOUBLETAP)&&!l.hasSpecificMask(ce.POINTERDOUBLETAP),_&&!Ta.HasSpecificTrigger(6)&&(u=this._initActionManager(u,h),u&&(_=!u.hasSpecificTrigger(6)))),_)(Date.now()-this._previousStartingPointerTime>s.DoubleClickDelay||m!==this._previousButtonPressed)&&(h.singleClick=!0,f(h,this._currentPickResult),p=!0);else{let T={evt:c,clickInfo:h,timeoutId:window.setTimeout(this._delayedSimpleClick.bind(this,m,h,f),s.DoubleClickDelay)};this._delayedClicks[m]=T}let v=o.hasSpecificMask(ce.POINTERDOUBLETAP)||l.hasSpecificMask(ce.POINTERDOUBLETAP);!v&&Ta.HasSpecificTrigger(6)&&(u=this._initActionManager(u,h),u&&(v=u.hasSpecificTrigger(6))),v&&(m===this._previousButtonPressed&&Date.now()-this._previousStartingPointerTime<s.DoubleClickDelay&&!this._doubleClickOccured?(!h.hasSwiped&&!this._isPointerSwiping()?(this._previousStartingPointerTime=0,this._doubleClickOccured=!0,h.doubleClick=!0,h.ignore=!1,s.ExclusiveDoubleClickMode&&this._delayedClicks[m]&&(clearTimeout(this._delayedClicks[m]?.timeoutId),this._delayedClicks[m]=null),f(h,this._currentPickResult)):(this._doubleClickOccured=!1,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=m,s.ExclusiveDoubleClickMode?(this._delayedClicks[m]&&(clearTimeout(this._delayedClicks[m]?.timeoutId),this._delayedClicks[m]=null),f(h,this._previousPickResult)):f(h,this._currentPickResult)),p=!0):(this._doubleClickOccured=!1,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=m))}}p||f(h,this._currentPickResult)},this._onPointerMove=o=>{if(this._updatePointerPosition(o),!this._isSwiping&&this._swipeButtonPressed!==-1&&(this._isSwiping=Math.abs(this._startingPointerPosition.x-this._pointerX)>s.DragMovementThreshold||Math.abs(this._startingPointerPosition.y-this._pointerY)>s.DragMovementThreshold),a.isPointerLock&&a._verifyPointerLock(),this._checkPrePointerObservable(null,o,o.inputIndex>=Ie.MouseWheelX&&o.inputIndex<=Ie.MouseWheelZ?ce.POINTERWHEEL:ce.POINTERMOVE)||!n.cameraToUseForPointers&&!n.activeCamera)return;if(n.skipPointerMovePicking){this._processPointerMove(new Zi,o);return}n.pointerMovePredicate||(n.pointerMovePredicate=c=>c.isPickable&&c.isVisible&&c.isReady()&&c.isEnabled()&&(c.enablePointerMoveEvents||n.constantlyUpdateMeshUnderPointer||c._getActionManagerForTrigger()!==null)&&(!n.cameraToUseForPointers||(n.cameraToUseForPointers.layerMask&c.layerMask)!==0));let l=n._registeredActions>0||n.constantlyUpdateMeshUnderPointer?this._pickMove(o):null;this._processPointerMove(l,o)},this._onPointerDown=o=>{let l=this._activePointerIds.indexOf(-1);if(l===-1?this._activePointerIds.push(o.pointerId):this._activePointerIds[l]=o.pointerId,this._activePointerIdsCount++,this._pickedDownMesh=null,this._meshPickProceed=!1,s.ExclusiveDoubleClickMode){for(let f=0;f<this._delayedClicks.length;f++)if(this._delayedClicks[f])if(o.button===f)clearTimeout(this._delayedClicks[f]?.timeoutId);else{let h=this._delayedClicks[f].clickInfo;this._doubleClickOccured=!1,h.singleClick=!0,h.ignore=!1;let u=this._delayedClicks[f].evt,d=ce.POINTERTAP,p=new nr(d,u,this._currentPickResult);n.onPointerObservable.hasObservers()&&n.onPointerObservable.hasSpecificMask(d)&&n.onPointerObservable.notifyObservers(p,d),this._delayedClicks[f]=null}}if(this._updatePointerPosition(o),this._swipeButtonPressed===-1&&(this._swipeButtonPressed=o.button),n.preventDefaultOnPointerDown&&r&&(o.preventDefault(),r.focus()),this._startingPointerPosition.x=this._pointerX,this._startingPointerPosition.y=this._pointerY,this._startingPointerTime=Date.now(),this._checkPrePointerObservable(null,o,ce.POINTERDOWN)||!n.cameraToUseForPointers&&!n.activeCamera)return;this._pointerCaptures[o.pointerId]=!0,n.pointerDownPredicate||(n.pointerDownPredicate=f=>f.isPickable&&f.isVisible&&f.isReady()&&f.isEnabled()&&(!n.cameraToUseForPointers||(n.cameraToUseForPointers.layerMask&f.layerMask)!==0)),this._pickedDownMesh=null;let c;n.skipPointerDownPicking||n._registeredActions===0&&!this._checkForPicking()&&!n.onPointerDown?c=new Zi:c=n.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,n.pointerDownPredicate,n.pointerDownFastCheck,n.cameraToUseForPointers,n.pointerDownTrianglePredicate),this._processPointerDown(c,o)},this._onPointerUp=o=>{let l=this._activePointerIds.indexOf(o.pointerId);l!==-1&&(this._activePointerIds[l]=-1,this._activePointerIdsCount--,this._pickedUpMesh=null,this._meshPickProceed=!1,this._updatePointerPosition(o),n.preventDefaultOnPointerUp&&r&&(o.preventDefault(),r.focus()),this._initClickEvent(n.onPrePointerObservable,n.onPointerObservable,o,(c,f)=>{if(n.onPrePointerObservable.hasObservers()&&(this._skipPointerTap=!1,!c.ignore)){if(this._checkPrePointerObservable(null,o,ce.POINTERUP)){this._swipeButtonPressed===o.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1),o.buttons===0&&(this._pointerCaptures[o.pointerId]=!1);return}c.hasSwiped||(c.singleClick&&n.onPrePointerObservable.hasSpecificMask(ce.POINTERTAP)&&this._checkPrePointerObservable(null,o,ce.POINTERTAP)&&(this._skipPointerTap=!0),c.doubleClick&&n.onPrePointerObservable.hasSpecificMask(ce.POINTERDOUBLETAP)&&this._checkPrePointerObservable(null,o,ce.POINTERDOUBLETAP)&&(this._skipPointerTap=!0))}if(!this._pointerCaptures[o.pointerId]){this._swipeButtonPressed===o.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1);return}o.buttons===0&&(this._pointerCaptures[o.pointerId]=!1),!(!n.cameraToUseForPointers&&!n.activeCamera)&&(n.pointerUpPredicate||(n.pointerUpPredicate=h=>h.isPickable&&h.isVisible&&h.isReady()&&h.isEnabled()&&(!n.cameraToUseForPointers||(n.cameraToUseForPointers.layerMask&h.layerMask)!==0)),!this._meshPickProceed&&(Ta&&Ta.HasTriggers||this._checkForPicking()||n.onPointerUp)&&this._initActionManager(null,c),f||(f=this._currentPickResult),this._processPointerUp(f,o,c),this._previousPickResult=this._currentPickResult,this._swipeButtonPressed===o.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1))}))},this._onKeyDown=o=>{let l=$s.KEYDOWN;if(n.onPreKeyboardObservable.hasObservers()){let c=new Hh(l,o);if(n.onPreKeyboardObservable.notifyObservers(c,l),c.skipOnKeyboardObservable)return}if(n.onKeyboardObservable.hasObservers()){let c=new Kc(l,o);n.onKeyboardObservable.notifyObservers(c,l)}n.actionManager&&n.actionManager.processTrigger(14,Mi.CreateNewFromScene(n,o))},this._onKeyUp=o=>{let l=$s.KEYUP;if(n.onPreKeyboardObservable.hasObservers()){let c=new Hh(l,o);if(n.onPreKeyboardObservable.notifyObservers(c,l),c.skipOnKeyboardObservable)return}if(n.onKeyboardObservable.hasObservers()){let c=new Kc(l,o);n.onKeyboardObservable.notifyObservers(c,l)}n.actionManager&&n.actionManager.processTrigger(15,Mi.CreateNewFromScene(n,o))},this._deviceSourceManager.onDeviceConnectedObservable.add(o=>{o.deviceType===ge.Mouse?o.onInputChangedObservable.add(l=>{this._originMouseEvent=l,l.inputIndex===Ie.LeftClick||l.inputIndex===Ie.MiddleClick||l.inputIndex===Ie.RightClick||l.inputIndex===Ie.BrowserBack||l.inputIndex===Ie.BrowserForward?t&&o.getInput(l.inputIndex)===1?this._onPointerDown(l):e&&o.getInput(l.inputIndex)===0&&this._onPointerUp(l):i&&(l.inputIndex===Ie.Move?this._onPointerMove(l):(l.inputIndex===Ie.MouseWheelX||l.inputIndex===Ie.MouseWheelY||l.inputIndex===Ie.MouseWheelZ)&&this._onPointerMove(l))}):o.deviceType===ge.Touch?o.onInputChangedObservable.add(l=>{l.inputIndex===Ie.LeftClick&&(t&&o.getInput(l.inputIndex)===1?(this._onPointerDown(l),this._activePointerIdsCount>1&&(this._isMultiTouchGesture=!0)):e&&o.getInput(l.inputIndex)===0&&(this._onPointerUp(l),this._activePointerIdsCount===0&&(this._isMultiTouchGesture=!1))),i&&l.inputIndex===Ie.Move&&this._onPointerMove(l)}):o.deviceType===ge.Keyboard&&o.onInputChangedObservable.add(l=>{l.type==="keydown"?this._onKeyDown(l):l.type==="keyup"&&this._onKeyUp(l)})}),this._alreadyAttached=!0}detachControl(){this._alreadyAttached&&(this._deviceSourceManager.dispose(),this._deviceSourceManager=null,this._alreadyAttachedTo&&!this._scene.doNotHandleCursors&&(this._alreadyAttachedTo.style.cursor=this._scene.defaultCursor),this._alreadyAttached=!1,this._alreadyAttachedTo=null)}setPointerOverMesh(e,t=0,i,r){if(this._meshUnderPointerId[t]===e&&(!e||!e._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting))return;let n=this._meshUnderPointerId[t],a;n&&(a=n._getActionManagerForTrigger(10),a&&a.processTrigger(10,new Mi(n,this._pointerX,this._pointerY,e,r,{pointerId:t}))),e?(this._meshUnderPointerId[t]=e,this._pointerOverMesh=e,a=e._getActionManagerForTrigger(9),a&&a.processTrigger(9,new Mi(e,this._pointerX,this._pointerY,e,r,{pointerId:t,pickResult:i}))):(delete this._meshUnderPointerId[t],this._pointerOverMesh=null),this._scene.onMeshUnderPointerUpdatedObservable.hasObservers()&&this._scene.onMeshUnderPointerUpdatedObservable.notifyObservers({mesh:e,pointerId:t})}getPointerOverMesh(){return this.meshUnderPointer}_invalidateMesh(e){this._pointerOverMesh===e&&(this._pointerOverMesh=null),this._pickedDownMesh===e&&(this._pickedDownMesh=null),this._pickedUpMesh===e&&(this._pickedUpMesh=null);for(let t in this._meshUnderPointerId)this._meshUnderPointerId[t]===e&&delete this._meshUnderPointerId[t]}};ar.DragMovementThreshold=10;ar.LongPressDelay=500;ar.DoubleClickDelay=300;ar.ExclusiveDoubleClickMode=!1});var xa,ym=S(()=>{xa=class{static get UniqueId(){let e=this._UniqueIdCounter;return this._UniqueIdCounter++,e}};xa._UniqueIdCounter=1});var ot,Mm=S(()=>{ot=class{static CompareLightsPriority(e,t){return e.shadowEnabled!==t.shadowEnabled?(t.shadowEnabled?1:0)-(e.shadowEnabled?1:0):t.renderPriority-e.renderPriority}};ot.FALLOFF_DEFAULT=0;ot.FALLOFF_PHYSICAL=1;ot.FALLOFF_GLTF=2;ot.FALLOFF_STANDARD=3;ot.LIGHTMAP_DEFAULT=0;ot.LIGHTMAP_SPECULAR=1;ot.LIGHTMAP_SHADOWSONLY=2;ot.INTENSITYMODE_AUTOMATIC=0;ot.INTENSITYMODE_LUMINOUSPOWER=1;ot.INTENSITYMODE_LUMINOUSINTENSITY=2;ot.INTENSITYMODE_ILLUMINANCE=3;ot.INTENSITYMODE_LUMINANCE=4;ot.LIGHTTYPEID_POINTLIGHT=0;ot.LIGHTTYPEID_DIRECTIONALLIGHT=1;ot.LIGHTTYPEID_SPOTLIGHT=2;ot.LIGHTTYPEID_HEMISPHERICLIGHT=3;ot.LIGHTTYPEID_RECT_AREALIGHT=4;ot.LIGHTTYPEID_CLUSTERED_CONTAINER=5});var Pm,jL=S(()=>{Pm=class{constructor(){this.pointerDownFastCheck=!1,this.pointerUpFastCheck=!1,this.pointerMoveFastCheck=!1,this.skipPointerMovePicking=!1,this.skipPointerDownPicking=!1,this.skipPointerUpPicking=!1}}});var Xh=S(()=>{});var qc,VR=S(()=>{qc=class{constructor(e,t,i){this.name=e,this._parentTask=t,this._context=i,this.disabled=!1}setExecuteFunc(e){this._executeFunc=e}_execute(){this.disabled||this._executeFunc(this._context)}_isValid(){return this._executeFunc!==void 0?null:"Execute function is not set (call setExecuteFunc to set it)"}}});var Yh,ZL=S(()=>{VR();Yh=class extends qc{static IsCullPass(e){return e.setObjectList!==void 0}get objectList(){return this._objectList}setObjectList(e){this._objectList=e}constructor(e,t,i,r){super(e,t,i),this._engine=r}_isValid(){let e=super._isValid();return e||(this._objectList!==void 0?null:"Object list is not set (call setObjectList to set it)")}}});var Il,kR=S(()=>{VR();Il=class extends qc{static IsRenderPass(e){return e.setRenderTarget!==void 0}get renderTarget(){return this._renderTarget}get renderTargetDepth(){return this._renderTargetDepth}constructor(e,t,i,r){super(e,t,i),this._dependencies=new Set,this.depthReadOnly=!1,this.stencilReadOnly=!1,this._engine=r}setRenderTarget(e){this._renderTarget=e}setRenderTargetDepth(e){this._renderTargetDepth=e}addDependencies(e){if(e)if(Array.isArray(e))for(let t of e)this._dependencies.add(t);else this._dependencies.add(e)}collectDependencies(e){let t=this._dependencies.keys();for(let i=t.next();i.done!==!0;i=t.next())e.add(i.value);if(this._renderTarget)if(Array.isArray(this._renderTarget))for(let i of this._renderTarget)i!==void 0&&e.add(i);else e.add(this._renderTarget);this._renderTargetDepth&&e.add(this._renderTargetDepth)}_execute(){this._frameGraphRenderTarget=this._frameGraphRenderTarget||this._context.createRenderTarget(this.name,this._renderTarget,this._renderTargetDepth,this.depthReadOnly,this.stencilReadOnly),this._context.bindRenderTarget(this._frameGraphRenderTarget,`frame graph render pass - ${this.name}`),super._execute(),this._context._flushDebugMessages()}_isValid(){let e=super._isValid();return e||(this._renderTarget!==void 0||this.renderTargetDepth!==void 0?null:"Render target and render target depth cannot both be undefined.")}}});var Wi,Aa=S(()=>{ZL();kR();we();Wi=class{get name(){return this._name}set name(e){this._name=e}get disabled(){return this._disabled}set disabled(e){this._disabled=e}get passes(){return this._passes}get passesDisabled(){return this._passesDisabled}isReady(){return!0}dispose(){this._reset(),this.onTexturesAllocatedObservable.clear()}constructor(e,t){this._passes=[],this._passesDisabled=[],this._disabled=!1,this.onTexturesAllocatedObservable=new N,this.name=e,this._frameGraph=t,this._reset()}_reset(){this._passes.length=0,this._passesDisabled.length=0}_addPass(e,t){t?this._passesDisabled.push(e):this._passes.push(e)}_checkTask(){let e=null,t=null,i;for(let l of this._passes){let c=l._isValid();if(c)throw new Error(`Pass "${l.name}" is not valid. ${c}`);if(Il.IsRenderPass(l)){let f=Array.isArray(l.renderTarget)?l.renderTarget:[l.renderTarget];e=[];for(let h of f)h!==void 0&&e.push(this._frameGraph.textureManager.getTextureFromHandle(h));t=l.renderTargetDepth!==void 0?this._frameGraph.textureManager.getTextureFromHandle(l.renderTargetDepth):null}else Yh.IsCullPass(l)&&(i=l.objectList)}let r=null,n=[],a=null,o;for(let l of this._passesDisabled){let c=l._isValid();if(c)throw new Error(`Pass "${l.name}" is not valid. ${c}`);if(Il.IsRenderPass(l)){let f=Array.isArray(l.renderTarget)?l.renderTarget:[l.renderTarget];r=[];for(let h of f)h!==void 0&&r.push(this._frameGraph.textureManager.getTextureFromHandle(h));n=f,a=l.renderTargetDepth!==void 0?this._frameGraph.textureManager.getTextureFromHandle(l.renderTargetDepth):null}else Yh.IsCullPass(l)&&(o=l.objectList)}if(this._passesDisabled.length>0){if(!this._checkSameRenderTarget(e,r)){let l=!0;for(let c of n)if(c!==void 0&&!this._frameGraph.textureManager.isHistoryTexture(c)){l=!1;break}if(!l)throw new Error(`The output texture of the task "${this.name}" is different when it is enabled or disabled.`)}if(t!==a)throw new Error(`The output depth texture of the task "${this.name}" is different when it is enabled or disabled.`);if(i!==o)throw new Error(`The output object list of the task "${this.name}" is different when it is enabled or disabled.`)}}_getPasses(){return this.disabled&&this._passesDisabled.length>0?this._passesDisabled:this._passes}_checkSameRenderTarget(e,t){if(e===null||t===null)return e===t;if(e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(e[i]!==t[i])return!1;return!0}}});var Ke,Dn=S(()=>{Ye();je();ie();it();rs();Rl();Te();Mm();ei();Ke=class s extends _t{get range(){return this._range}set range(e){this._range=e,this._inverseSquaredRange=1/(this.range*this.range)}get intensityMode(){return this._intensityMode}set intensityMode(e){this._intensityMode=e,this._computePhotometricScale()}get radius(){return this._radius}set radius(e){this._radius=e,this._computePhotometricScale()}get shadowEnabled(){return this._shadowEnabled}set shadowEnabled(e){this._shadowEnabled!==e&&(this._shadowEnabled=e,this._markMeshesAsLightDirty())}get includedOnlyMeshes(){return this._includedOnlyMeshes}set includedOnlyMeshes(e){this._includedOnlyMeshes=e,this._hookArrayForIncludedOnly(e)}get excludedMeshes(){return this._excludedMeshes}set excludedMeshes(e){this._excludedMeshes=e,this._hookArrayForExcluded(e)}get excludeWithLayerMask(){return this._excludeWithLayerMask}set excludeWithLayerMask(e){this._excludeWithLayerMask=e,this._resyncMeshes()}get includeOnlyWithLayerMask(){return this._includeOnlyWithLayerMask}set includeOnlyWithLayerMask(e){this._includeOnlyWithLayerMask=e,this._resyncMeshes()}get lightmapMode(){return this._lightmapMode}set lightmapMode(e){this._lightmapMode!==e&&(this._lightmapMode=e,this._markMeshesAsLightDirty())}getViewMatrix(e){return null}getProjectionMatrix(e,t){return null}constructor(e,t){super(e,t,!1),this.diffuse=new j(1,1,1),this.specular=new j(1,1,1),this.falloffType=s.FALLOFF_DEFAULT,this.intensity=1,this._range=Number.MAX_VALUE,this._inverseSquaredRange=0,this._photometricScale=1,this._intensityMode=s.INTENSITYMODE_AUTOMATIC,this._radius=1e-5,this.renderPriority=0,this._shadowEnabled=!0,this._excludeWithLayerMask=0,this._includeOnlyWithLayerMask=0,this._lightmapMode=0,this._shadowGenerators=null,this._excludedMeshesIds=new Array,this._includedOnlyMeshesIds=new Array,this._currentViewDepth=0,this._isLight=!0,this.getScene().addLight(this),this._uniformBuffer=new ii(this.getScene().getEngine(),void 0,void 0,e),this._buildUniformLayout(),this.includedOnlyMeshes=[],this.excludedMeshes=[],this._resyncMeshes()}transferTexturesToEffect(e,t){return this}_bindLight(e,t,i,r,n=!0){let a=e.toString(),o=!1;if(this._uniformBuffer.bindToEffect(i,"Light"+a),this._renderId!==t.getRenderId()||this._lastUseSpecular!==r||!this._uniformBuffer.useUbo){this._renderId=t.getRenderId(),this._lastUseSpecular=r;let l=this.getScaledIntensity();this.transferToEffect(i,a),this.diffuse.scaleToRef(l,Qi.Color3[0]),this._uniformBuffer.updateColor4("vLightDiffuse",Qi.Color3[0],this.range,a),r&&(this.specular.scaleToRef(l,Qi.Color3[1]),this._uniformBuffer.updateColor4("vLightSpecular",Qi.Color3[1],this.radius,a)),o=!0}if(this.transferTexturesToEffect(i,a),t.shadowsEnabled&&this.shadowEnabled&&n){let l=this.getShadowGenerator(t.activeCamera)??this.getShadowGenerator();l&&(l.bindShadowLight(a,i),o=!0)}o?this._uniformBuffer.update():this._uniformBuffer.bindUniformBuffer()}getClassName(){return"Light"}toString(e){let t="Name: "+this.name;if(t+=", type: "+["Point","Directional","Spot","Hemispheric","Clustered"][this.getTypeID()],this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);return t}_syncParentEnabledState(){super._syncParentEnabledState(),this.isDisposed()||this._resyncMeshes()}setEnabled(e){super.setEnabled(e),this._resyncMeshes()}getShadowGenerator(e=null){return this._shadowGenerators===null?null:this._shadowGenerators.get(e)??null}getShadowGenerators(){return this._shadowGenerators}getAbsolutePosition(){return E.Zero()}canAffectMesh(e){return e?!(this.includedOnlyMeshes&&this.includedOnlyMeshes.length>0&&this.includedOnlyMeshes.indexOf(e)===-1||this.excludedMeshes&&this.excludedMeshes.length>0&&this.excludedMeshes.indexOf(e)!==-1||this.includeOnlyWithLayerMask!==0&&(this.includeOnlyWithLayerMask&e.layerMask)===0||this.excludeWithLayerMask!==0&&this.excludeWithLayerMask&e.layerMask):!0}dispose(e,t=!1){if(this._shadowGenerators){let i=this._shadowGenerators.values();for(let r=i.next();r.done!==!0;r=i.next())r.value.dispose();this._shadowGenerators=null}if(this.getScene().stopAnimation(this),this._parentContainer){let i=this._parentContainer.lights.indexOf(this);i>-1&&this._parentContainer.lights.splice(i,1),this._parentContainer=null}for(let i of this.getScene().meshes)i._removeLightSource(this,!0);this._uniformBuffer.dispose(),this.getScene().removeLight(this),super.dispose(e,t)}getTypeID(){return 0}getScaledIntensity(){return this._photometricScale*this.intensity}clone(e,t=null){let i=s.GetConstructorFromName(this.getTypeID(),e,this.getScene());if(!i)return null;let r=_e.Clone(i,this);return e&&(r.name=e),t&&(r.parent=t),r.setEnabled(this.isEnabled()),this.onClonedObservable.notifyObservers(r),r}serialize(){let e=_e.Serialize(this);if(e.uniqueId=this.uniqueId,e.type=this.getTypeID(),this.parent&&this.parent._serializeAsParent(e),this.excludedMeshes.length>0){e.excludedMeshesIds=[];for(let t of this.excludedMeshes)e.excludedMeshesIds.push(t.id)}if(this.includedOnlyMeshes.length>0){e.includedOnlyMeshesIds=[];for(let t of this.includedOnlyMeshes)e.includedOnlyMeshesIds.push(t.id)}return _e.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}static GetConstructorFromName(e,t,i){let r=_t.Construct("Light_Type_"+e,t,i);return r||null}static Parse(e,t){let i=s.GetConstructorFromName(e.type,e.name,t);if(!i)return null;let r=_e.Parse(i,e,t);if(e.excludedMeshesIds&&(r._excludedMeshesIds=e.excludedMeshesIds),e.includedOnlyMeshesIds&&(r._includedOnlyMeshesIds=e.includedOnlyMeshesIds),e.parentId!==void 0&&(r._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(r._waitingParentInstanceIndex=e.parentInstanceIndex),e.falloffType!==void 0&&(r.falloffType=e.falloffType),e.lightmapMode!==void 0&&(r.lightmapMode=e.lightmapMode),e.animations){for(let n=0;n<e.animations.length;n++){let a=e.animations[n],o=Ci("BABYLON.Animation");o&&r.animations.push(o.Parse(a))}_t.ParseAnimationRanges(r,e,t)}return e.autoAnimate&&t.beginAnimation(r,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.isEnabled!==void 0&&r.setEnabled(e.isEnabled),r}_hookArrayForExcluded(e){let t=e.push;e.push=(...r)=>{let n=t.apply(e,r);for(let a of r)a._resyncLightSource(this);return n};let i=e.splice;e.splice=(r,n)=>{let a=i.apply(e,[r,n]);for(let o of a)o._resyncLightSource(this);return a};for(let r of e)r._resyncLightSource(this)}_hookArrayForIncludedOnly(e){let t=e.push;e.push=(...r)=>{let n=t.apply(e,r);return this._resyncMeshes(),n};let i=e.splice;e.splice=(r,n)=>{let a=i.apply(e,[r,n]);return this._resyncMeshes(),a},this._resyncMeshes()}_resyncMeshes(){for(let e of this.getScene().meshes)e._resyncLightSource(this)}_markMeshesAsLightDirty(){for(let e of this.getScene().meshes)e.lightSources.indexOf(this)!==-1&&e._markSubMeshesAsLightDirty()}_computePhotometricScale(){this._photometricScale=this._getPhotometricScale(),this.getScene().resetCachedMaterial()}_getPhotometricScale(){let e=0,t=this.getTypeID(),i=this.intensityMode;switch(i===s.INTENSITYMODE_AUTOMATIC&&(t===s.LIGHTTYPEID_DIRECTIONALLIGHT?i=s.INTENSITYMODE_ILLUMINANCE:i=s.INTENSITYMODE_LUMINOUSINTENSITY),t){case s.LIGHTTYPEID_POINTLIGHT:case s.LIGHTTYPEID_SPOTLIGHT:switch(i){case s.INTENSITYMODE_LUMINOUSPOWER:e=1/(4*Math.PI);break;case s.INTENSITYMODE_LUMINOUSINTENSITY:e=1;break;case s.INTENSITYMODE_LUMINANCE:e=this.radius*this.radius;break}break;case s.LIGHTTYPEID_DIRECTIONALLIGHT:switch(i){case s.INTENSITYMODE_ILLUMINANCE:e=1;break;case s.INTENSITYMODE_LUMINANCE:{let r=this.radius;r=Math.max(r,.001),e=2*Math.PI*(1-Math.cos(r));break}}break;case s.LIGHTTYPEID_HEMISPHERICLIGHT:e=1;break}return e}_reorderLightsInScene(){let e=this.getScene();this._renderPriority!=0&&(e.requireLightSorting=!0),this.getScene().sortLightsByPriority()}_isReady(){return!0}};Ke.FALLOFF_DEFAULT=ot.FALLOFF_DEFAULT;Ke.FALLOFF_PHYSICAL=ot.FALLOFF_PHYSICAL;Ke.FALLOFF_GLTF=ot.FALLOFF_GLTF;Ke.FALLOFF_STANDARD=ot.FALLOFF_STANDARD;Ke.LIGHTMAP_DEFAULT=ot.LIGHTMAP_DEFAULT;Ke.LIGHTMAP_SPECULAR=ot.LIGHTMAP_SPECULAR;Ke.LIGHTMAP_SHADOWSONLY=ot.LIGHTMAP_SHADOWSONLY;Ke.INTENSITYMODE_AUTOMATIC=ot.INTENSITYMODE_AUTOMATIC;Ke.INTENSITYMODE_LUMINOUSPOWER=ot.INTENSITYMODE_LUMINOUSPOWER;Ke.INTENSITYMODE_LUMINOUSINTENSITY=ot.INTENSITYMODE_LUMINOUSINTENSITY;Ke.INTENSITYMODE_ILLUMINANCE=ot.INTENSITYMODE_ILLUMINANCE;Ke.INTENSITYMODE_LUMINANCE=ot.INTENSITYMODE_LUMINANCE;Ke.LIGHTTYPEID_POINTLIGHT=ot.LIGHTTYPEID_POINTLIGHT;Ke.LIGHTTYPEID_DIRECTIONALLIGHT=ot.LIGHTTYPEID_DIRECTIONALLIGHT;Ke.LIGHTTYPEID_SPOTLIGHT=ot.LIGHTTYPEID_SPOTLIGHT;Ke.LIGHTTYPEID_HEMISPHERICLIGHT=ot.LIGHTTYPEID_HEMISPHERICLIGHT;Ke.LIGHTTYPEID_RECT_AREALIGHT=ot.LIGHTTYPEID_RECT_AREALIGHT;x([zt()],Ke.prototype,"diffuse",void 0);x([zt()],Ke.prototype,"specular",void 0);x([y()],Ke.prototype,"falloffType",void 0);x([y()],Ke.prototype,"intensity",void 0);x([y()],Ke.prototype,"range",null);x([y()],Ke.prototype,"intensityMode",null);x([y()],Ke.prototype,"radius",null);x([y()],Ke.prototype,"_renderPriority",void 0);x([z("_reorderLightsInScene")],Ke.prototype,"renderPriority",void 0);x([y("shadowEnabled")],Ke.prototype,"_shadowEnabled",void 0);x([y("excludeWithLayerMask")],Ke.prototype,"_excludeWithLayerMask",void 0);x([y("includeOnlyWithLayerMask")],Ke.prototype,"_includeOnlyWithLayerMask",void 0);x([y("lightmapMode")],Ke.prototype,"_lightmapMode",void 0)});var JL,Mq,WR=S(()=>{O();JL="kernelBlurVaryingDeclaration",Mq="varying sampleCoord{X}: vec2f;";g.IncludesShadersStoreWGSL[JL]||(g.IncludesShadersStoreWGSL[JL]=Mq)});var $L,Pq,Dm=S(()=>{O();$L="packingFunctions",Pq=`fn pack(depth: f32)->vec4f
{const bit_shift: vec4f= vec4f(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const bit_mask: vec4f= vec4f(0.0,1.0/255.0,1.0/255.0,1.0/255.0);var res: vec4f=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
fn unpack(color: vec4f)->f32
{const bit_shift: vec4f= vec4f(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}`;g.IncludesShadersStoreWGSL[$L]||(g.IncludesShadersStoreWGSL[$L]=Pq)});var ew,Dq,tw=S(()=>{O();ew="kernelBlurFragment",Dq=`#ifdef DOF
factor=sampleCoC(fragmentInputs.sampleCoord{X}); 
computedWeight=KERNEL_WEIGHT{X}*factor;sumOfWeights+=computedWeight;
#else
computedWeight=KERNEL_WEIGHT{X};
#endif
#ifdef PACKEDFLOAT
blend+=unpack(textureSample(textureSampler,textureSamplerSampler,fragmentInputs.sampleCoord{X}))*computedWeight;
#else
blend+=textureSample(textureSampler,textureSamplerSampler,fragmentInputs.sampleCoord{X})*computedWeight;
#endif
`;g.IncludesShadersStoreWGSL[ew]||(g.IncludesShadersStoreWGSL[ew]=Dq)});var iw,Oq,rw=S(()=>{O();iw="kernelBlurFragment2",Oq=`#ifdef DOF
factor=sampleCoC(fragmentInputs.sampleCenter+uniforms.delta*KERNEL_DEP_OFFSET{X});computedWeight=KERNEL_DEP_WEIGHT{X}*factor;sumOfWeights+=computedWeight;
#else
computedWeight=KERNEL_DEP_WEIGHT{X};
#endif
#ifdef PACKEDFLOAT
blend+=unpack(textureSample(textureSampler,textureSamplerSampler,fragmentInputs.sampleCenter+uniforms.delta*KERNEL_DEP_OFFSET{X}))*computedWeight;
#else
blend+=textureSample(textureSampler,textureSamplerSampler,fragmentInputs.sampleCenter+uniforms.delta*KERNEL_DEP_OFFSET{X})*computedWeight;
#endif
`;g.IncludesShadersStoreWGSL[iw]||(g.IncludesShadersStoreWGSL[iw]=Oq)});var nw={};V(nw,{kernelBlurPixelShaderWGSL:()=>Lq});var HR,sw,Lq,aw=S(()=>{O();WR();Dm();tw();rw();HR="kernelBlurPixelShader",sw=`var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform delta: vec2f;varying sampleCenter: vec2f;
#ifdef DOF
var circleOfConfusionSamplerSampler: sampler;var circleOfConfusionSampler: texture_2d<f32>;fn sampleCoC(offset: vec2f)->f32 {var coc: f32=textureSample(circleOfConfusionSampler,circleOfConfusionSamplerSampler,offset).r;return coc; }
#endif
#include<kernelBlurVaryingDeclaration>[0..varyingCount]
#ifdef PACKEDFLOAT
#include<packingFunctions>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var computedWeight: f32=0.0;
#ifdef PACKEDFLOAT
var blend: f32=0.;
#else
var blend: vec4f= vec4f(0.);
#endif
#ifdef DOF
var sumOfWeights: f32=CENTER_WEIGHT; 
var factor: f32=0.0;
#ifdef PACKEDFLOAT
blend+=unpack(textureSample(textureSampler,textureSamplerSampler,input.sampleCenter))*CENTER_WEIGHT;
#else
blend+=textureSample(textureSampler,textureSamplerSampler,input.sampleCenter)*CENTER_WEIGHT;
#endif
#endif
#include<kernelBlurFragment>[0..varyingCount]
#include<kernelBlurFragment2>[0..depCount]
#ifdef PACKEDFLOAT
fragmentOutputs.color=pack(blend);
#else
fragmentOutputs.color=blend;
#endif
#ifdef DOF
fragmentOutputs.color/=sumOfWeights;
#endif
}`;g.ShadersStoreWGSL[HR]||(g.ShadersStoreWGSL[HR]=sw);Lq={name:HR,shader:sw}});var ow,wq,lw=S(()=>{O();ow="kernelBlurVertex",wq="vertexOutputs.sampleCoord{X}=vertexOutputs.sampleCenter+uniforms.delta*KERNEL_OFFSET{X};";g.IncludesShadersStoreWGSL[ow]||(g.IncludesShadersStoreWGSL[ow]=wq)});var fw={};V(fw,{kernelBlurVertexShaderWGSL:()=>Fq});var zR,cw,Fq,hw=S(()=>{O();WR();lw();zR="kernelBlurVertexShader",cw=`attribute position: vec2f;uniform delta: vec2f;varying sampleCenter: vec2f;
#include<kernelBlurVaryingDeclaration>[0..varyingCount]
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {const madd: vec2f= vec2f(0.5,0.5);
#define CUSTOM_VERTEX_MAIN_BEGIN
vertexOutputs.sampleCenter=(input.position*madd+madd);
#include<kernelBlurVertex>[0..varyingCount]
vertexOutputs.position= vec4f(input.position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;g.ShadersStoreWGSL[zR]||(g.ShadersStoreWGSL[zR]=cw);Fq={name:zR,shader:cw}});var uw,Nq,XR=S(()=>{O();uw="kernelBlurVaryingDeclaration",Nq="varying vec2 sampleCoord{X};";g.IncludesShadersStore[uw]||(g.IncludesShadersStore[uw]=Nq)});var dw,Bq,Om=S(()=>{O();dw="packingFunctions",Bq=`vec4 pack(float depth)
{const vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const vec4 bit_mask=vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
float unpack(vec4 color)
{const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}`;g.IncludesShadersStore[dw]||(g.IncludesShadersStore[dw]=Bq)});var pw,Uq,mw=S(()=>{O();pw="kernelBlurFragment",Uq=`#ifdef DOF
factor=sampleCoC(sampleCoord{X}); 
computedWeight=KERNEL_WEIGHT{X}*factor;sumOfWeights+=computedWeight;
#else
computedWeight=KERNEL_WEIGHT{X};
#endif
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCoord{X}))*computedWeight;
#else
blend+=texture2D(textureSampler,sampleCoord{X})*computedWeight;
#endif
`;g.IncludesShadersStore[pw]||(g.IncludesShadersStore[pw]=Uq)});var _w,Gq,gw=S(()=>{O();_w="kernelBlurFragment2",Gq=`#ifdef DOF
factor=sampleCoC(sampleCenter+delta*KERNEL_DEP_OFFSET{X});computedWeight=KERNEL_DEP_WEIGHT{X}*factor;sumOfWeights+=computedWeight;
#else
computedWeight=KERNEL_DEP_WEIGHT{X};
#endif
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X}))*computedWeight;
#else
blend+=texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X})*computedWeight;
#endif
`;g.IncludesShadersStore[_w]||(g.IncludesShadersStore[_w]=Gq)});var Sw={};V(Sw,{kernelBlurPixelShader:()=>Vq});var YR,vw,Vq,Ew=S(()=>{O();XR();Om();mw();gw();YR="kernelBlurPixelShader",vw=`uniform sampler2D textureSampler;uniform vec2 delta;varying vec2 sampleCenter;
#ifdef DOF
uniform sampler2D circleOfConfusionSampler;float sampleCoC(in vec2 offset) {float coc=texture2D(circleOfConfusionSampler,offset).r;return coc; }
#endif
#include<kernelBlurVaryingDeclaration>[0..varyingCount]
#ifdef PACKEDFLOAT
#include<packingFunctions>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{float computedWeight=0.0;
#ifdef PACKEDFLOAT
float blend=0.;
#else
vec4 blend=vec4(0.);
#endif
#ifdef DOF
float sumOfWeights=CENTER_WEIGHT; 
float factor=0.0;
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCenter))*CENTER_WEIGHT;
#else
blend+=texture2D(textureSampler,sampleCenter)*CENTER_WEIGHT;
#endif
#endif
#include<kernelBlurFragment>[0..varyingCount]
#include<kernelBlurFragment2>[0..depCount]
#ifdef PACKEDFLOAT
gl_FragColor=pack(blend);
#else
gl_FragColor=blend;
#endif
#ifdef DOF
gl_FragColor/=sumOfWeights;
#endif
}`;g.ShadersStore[YR]||(g.ShadersStore[YR]=vw);Vq={name:YR,shader:vw}});var Tw,kq,xw=S(()=>{O();Tw="kernelBlurVertex",kq="sampleCoord{X}=sampleCenter+delta*KERNEL_OFFSET{X};";g.IncludesShadersStore[Tw]||(g.IncludesShadersStore[Tw]=kq)});var Rw={};V(Rw,{kernelBlurVertexShader:()=>Wq});var KR,Aw,Wq,bw=S(()=>{O();XR();xw();KR="kernelBlurVertexShader",Aw=`attribute vec2 position;uniform vec2 delta;varying vec2 sampleCenter;
#include<kernelBlurVaryingDeclaration>[0..varyingCount]
const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
sampleCenter=(position*madd+madd);
#include<kernelBlurVertex>[0..varyingCount]
gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;g.ShadersStore[KR]||(g.ShadersStore[KR]=Aw);Wq={name:KR,shader:Aw}});var Hr,qR=S(()=>{In();Sa();Hr=class s extends ti{_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(()=>(aw(),nw)),Promise.resolve().then(()=>(hw(),fw))]))):t.push(Promise.all([Promise.resolve().then(()=>(Ew(),Sw)),Promise.resolve().then(()=>(bw(),Rw))]))}constructor(e,t=null,i,r,n){let a=!!n?.blockCompilation;super({...n,name:e,engine:t||ee.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:s.FragmentUrl,uniforms:s.Uniforms,samplers:s.Samplers,vertexUrl:s.VertexUrl,blockCompilation:!0}),this._packedFloat=!1,this._staticDefines="",this.textureWidth=0,this.textureHeight=0,this._staticDefines=n?Array.isArray(n.defines)?n.defines.join(`
`):n.defines||"":"",this.options.blockCompilation=a,i!==void 0&&(this.direction=i),r!==void 0&&(this.kernel=r)}set kernel(e){this._idealKernel!==e&&(e=Math.max(e,1),this._idealKernel=e,this._kernel=this._nearestBestKernel(e),this.options.blockCompilation||this._updateParameters())}get kernel(){return this._idealKernel}set packedFloat(e){this._packedFloat!==e&&(this._packedFloat=e,this.options.blockCompilation||this._updateParameters())}get packedFloat(){return this._packedFloat}bind(e=!1){super.bind(e),this._drawWrapper.effect.setFloat2("delta",1/this.textureWidth*this.direction.x,1/this.textureHeight*this.direction.y)}_updateParameters(e,t){let i=this._kernel,r=(i-1)/2,n=[],a=[],o=0;for(let _=0;_<i;_++){let v=_/(i-1),T=this._gaussianWeight(v*2-1);n[_]=_-r,a[_]=T,o+=T}for(let _=0;_<a.length;_++)a[_]/=o;let l=[],c=[],f=[];for(let _=0;_<=r;_+=2){let v=Math.min(_+1,Math.floor(r));if(_===v)f.push({o:n[_],w:a[_]});else{let C=v===r,I=a[_]+a[v]*(C?.5:1),R=n[_]+1/(1+a[_]/a[v]);R===0?(f.push({o:n[_],w:a[_]}),f.push({o:n[_+1],w:a[_+1]})):(f.push({o:R,w:I}),f.push({o:-R,w:I}))}}for(let _=0;_<f.length;_++)c[_]=f[_].o,l[_]=f[_].w;n=c,a=l;let h=this.options.engine.getCaps().maxVaryingVectors-(this.options.shaderLanguage===1?1:0),u=Math.max(h,0)-1,d=Math.min(n.length,u),p="";p+=this._staticDefines,this._staticDefines.indexOf("DOF")!=-1&&(p+=`#define CENTER_WEIGHT ${this._glslFloat(a[d-1])}
`,d--);for(let _=0;_<d;_++)p+=`#define KERNEL_OFFSET${_} ${this._glslFloat(n[_])}
`,p+=`#define KERNEL_WEIGHT${_} ${this._glslFloat(a[_])}
`;let m=0;for(let _=u;_<n.length;_++)p+=`#define KERNEL_DEP_OFFSET${m} ${this._glslFloat(n[_])}
`,p+=`#define KERNEL_DEP_WEIGHT${m} ${this._glslFloat(a[_])}
`,m++;this.packedFloat&&(p+="#define PACKEDFLOAT 1"),this.options.blockCompilation=!1,this.updateEffect(p,null,null,{varyingCount:d,depCount:m},e,t)}_nearestBestKernel(e){let t=Math.round(e);for(let i of[t,t-1,t+1,t-2,t+2])if(i%2!==0&&Math.floor(i/2)%2===0&&i>0)return Math.max(i,3);return Math.max(t,3)}_gaussianWeight(e){let t=.3333333333333333,i=Math.sqrt(2*Math.PI)*t,r=-(e*e/(2*t*t));return 1/i*Math.exp(r)}_glslFloat(e,t=8){return e.toFixed(t).replace(/0+$/,"")}};Hr.VertexUrl="kernelBlur";Hr.FragmentUrl="kernelBlur";Hr.Uniforms=["delta","direction"];Hr.Samplers=["circleOfConfusionSampler"]});var Ra,Cw=S(()=>{Ye();Wr();Ut();Te();je();ei();qR();Ra=class s extends at{get direction(){return this._effectWrapper.direction}set direction(e){this._effectWrapper.direction=e}set kernel(e){this._effectWrapper.kernel=e}get kernel(){return this._effectWrapper.kernel}set packedFloat(e){this._effectWrapper.packedFloat=e}get packedFloat(){return this._effectWrapper.packedFloat}getClassName(){return"BlurPostProcess"}constructor(e,t,i,r,n=null,a=H.BILINEAR_SAMPLINGMODE,o,l,c=0,f="",h=!1,u=5){let d=typeof r=="number"?h:!!r.blockCompilation,p={uniforms:Hr.Uniforms,samplers:Hr.Samplers,size:typeof r=="number"?r:void 0,camera:n,samplingMode:a,engine:o,reusable:l,textureType:c,vertexUrl:Hr.VertexUrl,indexParameters:{varyingCount:0,depCount:0},textureFormat:u,defines:f,...r,blockCompilation:!0};super(e,Hr.FragmentUrl,{effectWrapper:typeof r=="number"||!r.effectWrapper?new Hr(e,o,void 0,void 0,p):void 0,...p}),this._effectWrapper.options.blockCompilation=d,this.direction=t,this.onApplyObservable.add(()=>{this._effectWrapper.textureWidth=this._outputTexture?this._outputTexture.width:this.width,this._effectWrapper.textureHeight=this._outputTexture?this._outputTexture.height:this.height}),this.kernel=i}updateEffect(e=null,t=null,i=null,r,n,a){this._effectWrapper._updateParameters(n,a)}static _Parse(e,t,i,r){return _e.Parse(()=>new s(e.name,e.direction,e.kernel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,void 0,!1),e,i,r)}};x([vc()],Ra.prototype,"direction",null);x([y()],Ra.prototype,"kernel",null);x([y()],Ra.prototype,"packedFloat",null);G("BABYLON.BlurPostProcess",Ra)});var or,bo=S(()=>{or=class{constructor(){this._defines={},this._currentRank=32,this._maxRank=-1,this._mesh=null}unBindMesh(){this._mesh=null}addFallback(e,t){this._defines[e]||(e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e),this._defines[e]=new Array),this._defines[e].push(t)}addCPUSkinningFallback(e,t){this._mesh=t,e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e)}get hasMoreFallbacks(){return this._currentRank<=this._maxRank}reduce(e,t){if(this._mesh&&this._mesh.computeBonesUsingShaders&&this._mesh.numBoneInfluencers>0){this._mesh.computeBonesUsingShaders=!1,e=e.replace("#define NUM_BONE_INFLUENCERS "+this._mesh.numBoneInfluencers,"#define NUM_BONE_INFLUENCERS 0"),t._bonesComputationForcedToCPU=!0;let i=this._mesh.getScene();for(let r=0;r<i.meshes.length;r++){let n=i.meshes[r];if(!n.material){!this._mesh.material&&n.computeBonesUsingShaders&&n.numBoneInfluencers>0&&(n.computeBonesUsingShaders=!1);continue}if(!(!n.computeBonesUsingShaders||n.numBoneInfluencers===0)){if(n.material.getEffect()===t)n.computeBonesUsingShaders=!1;else if(n.subMeshes){for(let a of n.subMeshes)if(a.effect===t){n.computeBonesUsingShaders=!1;break}}}}}else{let i=this._defines[this._currentRank];if(i)for(let r=0;r<i.length;r++)e=e.replace("#define "+i[r],"");this._currentRank++}return e}}});function Hi(s){s.indexOf("vClipPlane")===-1&&s.push("vClipPlane"),s.indexOf("vClipPlane2")===-1&&s.push("vClipPlane2"),s.indexOf("vClipPlane3")===-1&&s.push("vClipPlane3"),s.indexOf("vClipPlane4")===-1&&s.push("vClipPlane4"),s.indexOf("vClipPlane5")===-1&&s.push("vClipPlane5"),s.indexOf("vClipPlane6")===-1&&s.push("vClipPlane6")}function On(s,e,t){let i=!!(s.clipPlane??e.clipPlane),r=!!(s.clipPlane2??e.clipPlane2),n=!!(s.clipPlane3??e.clipPlane3),a=!!(s.clipPlane4??e.clipPlane4),o=!!(s.clipPlane5??e.clipPlane5),l=!!(s.clipPlane6??e.clipPlane6);i&&t.push("#define CLIPPLANE"),r&&t.push("#define CLIPPLANE2"),n&&t.push("#define CLIPPLANE3"),a&&t.push("#define CLIPPLANE4"),o&&t.push("#define CLIPPLANE5"),l&&t.push("#define CLIPPLANE6")}function Iw(s,e,t){let i=!1,r=!!(s.clipPlane??e.clipPlane),n=!!(s.clipPlane2??e.clipPlane2),a=!!(s.clipPlane3??e.clipPlane3),o=!!(s.clipPlane4??e.clipPlane4),l=!!(s.clipPlane5??e.clipPlane5),c=!!(s.clipPlane6??e.clipPlane6);return t.CLIPPLANE!==r&&(t.CLIPPLANE=r,i=!0),t.CLIPPLANE2!==n&&(t.CLIPPLANE2=n,i=!0),t.CLIPPLANE3!==a&&(t.CLIPPLANE3=a,i=!0),t.CLIPPLANE4!==o&&(t.CLIPPLANE4=o,i=!0),t.CLIPPLANE5!==l&&(t.CLIPPLANE5=l,i=!0),t.CLIPPLANE6!==c&&(t.CLIPPLANE6=c,i=!0),i}function zi(s,e,t){let i=e.clipPlane??t.clipPlane;Qc(s,"vClipPlane",i),i=e.clipPlane2??t.clipPlane2,Qc(s,"vClipPlane2",i),i=e.clipPlane3??t.clipPlane3,Qc(s,"vClipPlane3",i),i=e.clipPlane4??t.clipPlane4,Qc(s,"vClipPlane4",i),i=e.clipPlane5??t.clipPlane5,Qc(s,"vClipPlane5",i),i=e.clipPlane6??t.clipPlane6,Qc(s,"vClipPlane6",i)}function Qc(s,e,t){t&&s.setFloat4(e,t.normal.x,t.normal.y,t.normal.z,t.d)}var rn=S(()=>{});function Ln(s,e,t){if(!s||s.LOGARITHMICDEPTH||s.indexOf&&s.indexOf("LOGARITHMICDEPTH")>=0){let i=t.activeCamera;i.mode===1&&P.Error("Logarithmic depth is not compatible with orthographic cameras!",20),e.setFloat("logarithmicDepthConstant",2/(Math.log(i.maxZ+1)/Math.LN2))}}function wn(s,e,t,i=!1){t&&s.fogEnabled&&(!e||e.applyFog)&&s.fogMode!==0&&(t.setFloat4("vFogInfos",s.fogMode,s.fogStart,s.fogEnd,s.fogDensity),i?(s.fogColor.toLinearSpaceToRef(yw,s.getEngine().useExactSrgbConversions),t.setColor3("vFogColor",yw)):t.setColor3("vFogColor",s.fogColor))}function Fn(s,e,t,i,r,n,a,o,l,c){let f=s.numMaxInfluencers||s.numInfluencers;return f<=0?0:(e.push("#define MORPHTARGETS"),s.hasPositions&&e.push("#define MORPHTARGETTEXTURE_HASPOSITIONS"),s.hasNormals&&e.push("#define MORPHTARGETTEXTURE_HASNORMALS"),s.hasTangents&&e.push("#define MORPHTARGETTEXTURE_HASTANGENTS"),s.hasUVs&&e.push("#define MORPHTARGETTEXTURE_HASUVS"),s.hasUV2s&&e.push("#define MORPHTARGETTEXTURE_HASUV2S"),s.hasColors&&e.push("#define MORPHTARGETTEXTURE_HASCOLORS"),s.supportsPositions&&r&&e.push("#define MORPHTARGETS_POSITION"),s.supportsNormals&&n&&e.push("#define MORPHTARGETS_NORMAL"),s.supportsTangents&&a&&e.push("#define MORPHTARGETS_TANGENT"),s.supportsUVs&&o&&e.push("#define MORPHTARGETS_UV"),s.supportsUV2s&&l&&e.push("#define MORPHTARGETS_UV2"),s.supportsColors&&c&&e.push("#define MORPHTARGETS_COLOR"),e.push("#define NUM_MORPH_INFLUENCERS "+f),s.isUsingTextureForTargets&&e.push("#define MORPHTARGETS_TEXTURE"),yl.NUM_MORPH_INFLUENCERS=f,yl.NORMAL=n,yl.TANGENT=a,yl.UV=o,yl.UV2=l,yl.COLOR=c,Kh(t,i,yl,r),f)}function Kh(s,e,t,i=!0){let r=t.NUM_MORPH_INFLUENCERS;if(r>0&&Z.LastCreatedEngine){let n=Z.LastCreatedEngine.getCaps().maxVertexAttribs,a=e.morphTargetManager;if(a?.isUsingTextureForTargets)return;let o=a&&a.supportsPositions&&i,l=a&&a.supportsNormals&&t.NORMAL,c=a&&a.supportsTangents&&t.TANGENT,f=a&&a.supportsUVs&&t.UV1,h=a&&a.supportsUV2s&&t.UV2,u=a&&a.supportsColors&&t.VERTEXCOLOR;for(let d=0;d<r;d++)o&&s.push("position"+d),l&&s.push("normal"+d),c&&s.push("tangent"+d),f&&s.push("uv_"+d),h&&s.push("uv2_"+d),u&&s.push("color"+d),s.length>n&&P.Error("Cannot add more vertex attributes for mesh "+e.name)}}function sn(s,e=!1){s.push("world0"),s.push("world1"),s.push("world2"),s.push("world3"),e&&(s.push("previousWorld0"),s.push("previousWorld1"),s.push("previousWorld2"),s.push("previousWorld3"))}function lr(s,e){let t=s.morphTargetManager;!s||!t||e.setFloatArray("morphTargetInfluences",t.influences)}function Co(s,e){e.bindToEffect(s,"Scene")}function lt(s,e,t){e._needUVs=!0,e[t]=!0,s.optimizeUVAllocation&&s.getTextureMatrix().isIdentityAs3x2()?(e[t+"DIRECTUV"]=s.coordinatesIndex+1,e["MAINUV"+(s.coordinatesIndex+1)]=!0):e[t+"DIRECTUV"]=0}function ct(s,e,t){let i=s.getTextureMatrix();e.updateMatrix(t+"Matrix",i)}function jc(s,e,t){t.BAKED_VERTEX_ANIMATION_TEXTURE&&t.INSTANCES&&s.push("bakedVertexAnimationSettingsInstanced")}function Hq(s,e){return e.set(s),e}function Nn(s,e,t){if(!(!e||!s)&&(s.computeBonesUsingShaders&&e._bonesComputationForcedToCPU&&(s.computeBonesUsingShaders=!1),s.useBones&&s.computeBonesUsingShaders&&s.skeleton)){let i=s.skeleton;if(i.isUsingTextureForMatrices&&e.getUniformIndex("boneTextureWidth")>-1){let r=i.getTransformMatrixTexture(s);e.setTexture("boneSampler",r),e.setFloat("boneTextureWidth",4*(i.bones.length+1))}else{let r=i.getTransformMatrices(s);r&&(e.setMatrices("mBones",r),t&&s.getScene().prePassRenderer&&s.getScene().prePassRenderer.getIndex(2)&&(t.previousBones[s.uniqueId]||(t.previousBones[s.uniqueId]=r.slice()),e.setMatrices("mPreviousBones",t.previousBones[s.uniqueId]),Hq(r,t.previousBones[s.uniqueId])))}}}function zq(s,e,t,i,r,n=!0){s._bindLight(e,t,i,r,n)}function Zc(s,e,t,i,r=4){let n=Math.min(e.lightSources.length,r);for(let a=0;a<n;a++){let o=e.lightSources[a];zq(o,a,s,t,typeof i=="boolean"?i:i.SPECULARTERM,e.receiveShadows)}}function Jc(s,e,t,i){t.NUM_BONE_INFLUENCERS>0&&(i.addCPUSkinningFallback(0,e),s.push("matricesIndices"),s.push("matricesWeights"),t.NUM_BONE_INFLUENCERS>4&&(s.push("matricesIndicesExtra"),s.push("matricesWeightsExtra")))}function Io(s,e){(e.INSTANCES||e.THIN_INSTANCES)&&sn(s,!!e.PREPASS_VELOCITY),e.INSTANCESCOLOR&&s.push("instanceColor")}function $c(s,e,t=4,i=0){let r=0;for(let n=0;n<t&&s["LIGHT"+n];n++)n>0&&(r=i+n,e.addFallback(r,"LIGHT"+n)),s.SHADOWS||(s["SHADOW"+n]&&e.addFallback(i,"SHADOW"+n),s["SHADOWPCF"+n]&&e.addFallback(i,"SHADOWPCF"+n),s["SHADOWPCSS"+n]&&e.addFallback(i,"SHADOWPCSS"+n),s["SHADOWPOISSON"+n]&&e.addFallback(i,"SHADOWPOISSON"+n),s["SHADOWESM"+n]&&e.addFallback(i,"SHADOWESM"+n),s["SHADOWCLOSEESM"+n]&&e.addFallback(i,"SHADOWCLOSEESM"+n));return r++}function Xq(s,e){return e.fogEnabled&&s.applyFog&&e.fogMode!==0}function yo(s,e,t,i,r,n,a,o=!1,l=!1,c,f){if(a._areMiscDirty){a.LOGARITHMICDEPTH=t,a.POINTSIZE=i,a.FOG=r&&Xq(s,e),a.NONUNIFORMSCALING=s.nonUniformScaling,a.ALPHATEST=n,a.DECAL_AFTER_DETAIL=o,a.USE_VERTEX_PULLING=l;let h=c?.geometry?.getIndexBuffer();a.VERTEX_PULLING_USE_INDEX_BUFFER=!!h,a.VERTEX_PULLING_INDEX_BUFFER_32BITS=h?h.is32Bits:!1,a.VERTEXOUTPUT_INVARIANT=!!f}}function ef(s,e,t,i,r=4,n=!1){if(!t._areLightsDirty)return t._needNormals;let a=0,o={needNormals:t._needNormals,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};if(s.lightsEnabled&&!n){for(let f of e.lightSources)if(Yq(s,e,f,a,t,i,o),a++,a===r)break}t.SPECULARTERM=o.specularEnabled,t.SHADOWS=o.shadowEnabled;let l=Math.max(r,t.MAXLIGHTCOUNT||0);for(let f=a;f<l;f++)t["LIGHT"+f]!==void 0&&(t["LIGHT"+f]=!1,t["HEMILIGHT"+f]=!1,t["POINTLIGHT"+f]=!1,t["DIRLIGHT"+f]=!1,t["SPOTLIGHT"+f]=!1,t["AREALIGHT"+f]=!1,t["CLUSTLIGHT"+f]=!1,t["SHADOW"+f]=!1,t["SHADOWCSM"+f]=!1,t["SHADOWCSMDEBUG"+f]=!1,t["SHADOWCSMNUM_CASCADES"+f]=!1,t["SHADOWCSMUSESHADOWMAXZ"+f]=!1,t["SHADOWCSMNOBLEND"+f]=!1,t["SHADOWCSM_RIGHTHANDED"+f]=!1,t["SHADOWPCF"+f]=!1,t["SHADOWPCSS"+f]=!1,t["SHADOWPOISSON"+f]=!1,t["SHADOWESM"+f]=!1,t["SHADOWCLOSEESM"+f]=!1,t["SHADOWCUBE"+f]=!1,t["SHADOWLOWQUALITY"+f]=!1,t["SHADOWMEDIUMQUALITY"+f]=!1);t.MAXLIGHTCOUNT=r;let c=s.getEngine().getCaps();return t.SHADOWFLOAT===void 0&&(o.needRebuild=!0),t.SHADOWFLOAT=o.shadowEnabled&&(c.textureFloatRender&&c.textureFloatLinearFiltering||c.textureHalfFloatRender&&c.textureHalfFloatLinearFiltering),t.LIGHTMAPEXCLUDED=o.lightmapMode,o.needRebuild&&t.rebuild(),o.needNormals}function Yq(s,e,t,i,r,n,a){switch(a.needNormals=!0,r["LIGHT"+i]===void 0&&(a.needRebuild=!0),r["LIGHT"+i]=!0,r["SPOTLIGHT"+i]=!1,r["HEMILIGHT"+i]=!1,r["POINTLIGHT"+i]=!1,r["DIRLIGHT"+i]=!1,r["AREALIGHT"+i]=!1,t.prepareLightSpecificDefines(r,i),r["LIGHT_FALLOFF_PHYSICAL"+i]=!1,r["LIGHT_FALLOFF_GLTF"+i]=!1,r["LIGHT_FALLOFF_STANDARD"+i]=!1,t.falloffType){case ot.FALLOFF_GLTF:r["LIGHT_FALLOFF_GLTF"+i]=!0;break;case ot.FALLOFF_PHYSICAL:r["LIGHT_FALLOFF_PHYSICAL"+i]=!0;break;case ot.FALLOFF_STANDARD:r["LIGHT_FALLOFF_STANDARD"+i]=!0;break}if(n&&!t.specular.equalsFloats(0,0,0)&&(a.specularEnabled=!0),r["SHADOW"+i]=!1,r["SHADOWCSM"+i]=!1,r["SHADOWCSMDEBUG"+i]=!1,r["SHADOWCSMNUM_CASCADES"+i]=!1,r["SHADOWCSMUSESHADOWMAXZ"+i]=!1,r["SHADOWCSMNOBLEND"+i]=!1,r["SHADOWCSM_RIGHTHANDED"+i]=!1,r["SHADOWPCF"+i]=!1,r["SHADOWPCSS"+i]=!1,r["SHADOWPOISSON"+i]=!1,r["SHADOWESM"+i]=!1,r["SHADOWCLOSEESM"+i]=!1,r["SHADOWCUBE"+i]=!1,r["SHADOWLOWQUALITY"+i]=!1,r["SHADOWMEDIUMQUALITY"+i]=!1,e&&e.receiveShadows&&s.shadowsEnabled&&t.shadowEnabled){let o=t.getShadowGenerator(s.activeCamera)??t.getShadowGenerator();if(o){let l=o.getShadowMap();l&&l.renderList&&l.renderList.length>0&&(a.shadowEnabled=!0,o.prepareDefines(r,i))}}t.lightmapMode!=ot.LIGHTMAP_DEFAULT?(a.lightmapMode=!0,r["LIGHTMAPEXCLUDED"+i]=!0,r["LIGHTMAPNOSPECULAR"+i]=t.lightmapMode==ot.LIGHTMAP_SHADOWSONLY):(r["LIGHTMAPEXCLUDED"+i]=!1,r["LIGHTMAPNOSPECULAR"+i]=!1)}function Mo(s,e,t,i,r,n=null,a=!1){let o=jq(s,i);n!==!1&&(o=Iw(t,s,i)),i.DEPTHPREPASS!==!e.getColorWrite()&&(i.DEPTHPREPASS=!i.DEPTHPREPASS,o=!0),i.INSTANCES!==r&&(i.INSTANCES=r,o=!0),i.THIN_INSTANCES!==a&&(i.THIN_INSTANCES=a,o=!0),o&&i.markAsUnprocessed()}function Kq(s,e){if(s.useBones&&s.computeBonesUsingShaders&&s.skeleton){e.NUM_BONE_INFLUENCERS=s.numBoneInfluencers;let t=e.BONETEXTURE!==void 0;if(s.skeleton.isUsingTextureForMatrices&&t)e.BONETEXTURE=!0;else{e.BonesPerMesh=s.skeleton.bones.length+1,e.BONETEXTURE=t?!1:void 0;let i=s.getScene().prePassRenderer;if(i&&i.enabled){let r=i.excludedSkinnedMesh.indexOf(s)===-1;e.BONES_VELOCITY_ENABLED=r}}}else e.NUM_BONE_INFLUENCERS=0,e.BonesPerMesh=0,e.BONETEXTURE!==void 0&&(e.BONETEXTURE=!1)}function qq(s,e){let t=s.morphTargetManager;t?(e.MORPHTARGETS_UV=t.supportsUVs&&e.UV1,e.MORPHTARGETS_UV2=t.supportsUV2s&&e.UV2,e.MORPHTARGETS_TANGENT=t.supportsTangents&&e.TANGENT,e.MORPHTARGETS_NORMAL=t.supportsNormals&&e.NORMAL,e.MORPHTARGETS_POSITION=t.supportsPositions,e.MORPHTARGETS_COLOR=t.supportsColors,e.MORPHTARGETTEXTURE_HASUVS=t.hasUVs,e.MORPHTARGETTEXTURE_HASUV2S=t.hasUV2s,e.MORPHTARGETTEXTURE_HASTANGENTS=t.hasTangents,e.MORPHTARGETTEXTURE_HASNORMALS=t.hasNormals,e.MORPHTARGETTEXTURE_HASPOSITIONS=t.hasPositions,e.MORPHTARGETTEXTURE_HASCOLORS=t.hasColors,e.NUM_MORPH_INFLUENCERS=t.numMaxInfluencers||t.numInfluencers,e.MORPHTARGETS=e.NUM_MORPH_INFLUENCERS>0,e.MORPHTARGETS_TEXTURE=t.isUsingTextureForTargets):(e.MORPHTARGETS_UV=!1,e.MORPHTARGETS_UV2=!1,e.MORPHTARGETS_TANGENT=!1,e.MORPHTARGETS_NORMAL=!1,e.MORPHTARGETS_POSITION=!1,e.MORPHTARGETS_COLOR=!1,e.MORPHTARGETTEXTURE_HASUVS=!1,e.MORPHTARGETTEXTURE_HASUV2S=!1,e.MORPHTARGETTEXTURE_HASTANGENTS=!1,e.MORPHTARGETTEXTURE_HASNORMALS=!1,e.MORPHTARGETTEXTURE_HASPOSITIONS=!1,e.MORPHTARGETTEXTURE_HAS_COLORS=!1,e.MORPHTARGETS=!1,e.NUM_MORPH_INFLUENCERS=0)}function Qq(s,e){let t=s.bakedVertexAnimationManager;e.BAKED_VERTEX_ANIMATION_TEXTURE=!!(t&&t.isEnabled)}function Po(s,e,t,i,r=!1,n=!0,a=!0){if(!e._areAttributesDirty&&e._needNormals===e._normals&&e._needUVs===e._uvs)return!1;e._normals=e._needNormals,e._uvs=e._needUVs,e.NORMAL=e._needNormals&&s.isVerticesDataPresent("normal"),e._needNormals&&s.isVerticesDataPresent("tangent")&&(e.TANGENT=!0);for(let o=1;o<=6;++o)e["UV"+o]=e._needUVs?s.isVerticesDataPresent(`uv${o===1?"":o}`):!1;if(t){let o=s.useVertexColors&&s.isVerticesDataPresent("color");e.VERTEXCOLOR=o,e.VERTEXALPHA=s.hasVertexAlpha&&o&&n}return s.isVerticesDataPresent("instanceColor")&&(s.hasInstances||s.hasThinInstances)&&(e.INSTANCESCOLOR=!0),i&&Kq(s,e),r&&qq(s,e),a&&Qq(s,e),!0}function tf(s,e){if(s.activeCamera){let t=e.MULTIVIEW;e.MULTIVIEW=s.activeCamera.outputRenderTarget!==null&&s.activeCamera.outputRenderTarget.getViewCount()>1,e.MULTIVIEW!=t&&e.markAsUnprocessed()}}function Lm(s,e,t){let i=e.ORDER_INDEPENDENT_TRANSPARENCY,r=e.ORDER_INDEPENDENT_TRANSPARENCY_16BITS;e.ORDER_INDEPENDENT_TRANSPARENCY=s.useOrderIndependentTransparency&&t,e.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!s.getEngine().getCaps().textureFloatLinearFiltering,(i!==e.ORDER_INDEPENDENT_TRANSPARENCY||r!==e.ORDER_INDEPENDENT_TRANSPARENCY_16BITS)&&e.markAsUnprocessed()}function wm(s,e,t){let i=e.PREPASS;if(!e._arePrePassDirty)return;let r=[{type:1,define:"PREPASS_POSITION",index:"PREPASS_POSITION_INDEX"},{type:9,define:"PREPASS_LOCAL_POSITION",index:"PREPASS_LOCAL_POSITION_INDEX"},{type:2,define:"PREPASS_VELOCITY",index:"PREPASS_VELOCITY_INDEX"},{type:11,define:"PREPASS_VELOCITY_LINEAR",index:"PREPASS_VELOCITY_LINEAR_INDEX"},{type:3,define:"PREPASS_REFLECTIVITY",index:"PREPASS_REFLECTIVITY_INDEX"},{type:0,define:"PREPASS_IRRADIANCE",index:"PREPASS_IRRADIANCE_INDEX"},{type:7,define:"PREPASS_ALBEDO_SQRT",index:"PREPASS_ALBEDO_SQRT_INDEX"},{type:5,define:"PREPASS_DEPTH",index:"PREPASS_DEPTH_INDEX"},{type:10,define:"PREPASS_SCREENSPACE_DEPTH",index:"PREPASS_SCREENSPACE_DEPTH_INDEX"},{type:6,define:"PREPASS_NORMAL",index:"PREPASS_NORMAL_INDEX"},{type:8,define:"PREPASS_WORLD_NORMAL",index:"PREPASS_WORLD_NORMAL_INDEX"}];if(s.prePassRenderer&&s.prePassRenderer.enabled&&t){e.PREPASS=!0,e.SCENE_MRT_COUNT=s.prePassRenderer.mrtCount,e.PREPASS_NORMAL_WORLDSPACE=s.prePassRenderer.generateNormalsInWorldSpace,e.PREPASS_COLOR=!0,e.PREPASS_COLOR_INDEX=0;for(let n=0;n<r.length;n++){let a=s.prePassRenderer.getIndex(r[n].type);a!==-1?(e[r[n].define]=!0,e[r[n].index]=a):e[r[n].define]=!1}}else{e.PREPASS=!1;for(let n=0;n<r.length;n++)e[r[n].define]=!1}e.PREPASS!=i&&(e.markAsUnprocessed(),e.markAsImageProcessingDirty())}function jq(s,e){let t=!1;if(s.activeCamera){let i=e.CAMERA_ORTHOGRAPHIC?1:0,r=e.CAMERA_PERSPECTIVE?1:0,n=s.activeCamera.mode===1?1:0,a=s.activeCamera.mode===0?1:0;(i^n||r^a)&&(e.CAMERA_ORTHOGRAPHIC=n===1,e.CAMERA_PERSPECTIVE=a===1,t=!0)}return t}function Zq(s,e,t,i,r=null,n=!1,a=!1,o=!1){r&&r.push("Light"+s),!n&&(e.push("vLightData"+s,"vLightDiffuse"+s,"vLightSpecular"+s,"vLightDirection"+s,"vLightWidth"+s,"vLightHeight"+s,"vLightFalloff"+s,"vLightGround"+s,"vSliceData"+s,"vSliceRanges"+s,"lightMatrix"+s,"shadowsInfo"+s,"depthValues"+s),t.push("shadowTexture"+s),t.push("depthTexture"+s),e.push("viewFrustumZ"+s,"cascadeBlendFactor"+s,"lightSizeUVCorrection"+s,"depthCorrection"+s,"penumbraDarkness"+s,"frustumLengths"+s),i&&(t.push("projectionLightTexture"+s),e.push("textureProjectionMatrix"+s)),a&&t.push("iesLightTexture"+s),o&&(t.push("lightDataTexture"+s),t.push("tileMaskTexture"+s)))}function Do(s,e,t,i=4){let r,n;if(s.uniformsNames){let a=s;r=a.uniformsNames,n=a.uniformBuffersNames,e=a.samplers,t=a.defines,i=a.maxSimultaneousLights||0}else r=s,e||(e=[]);for(let a=0;a<i&&t["LIGHT"+a];a++)Zq(a,r,e,t["PROJECTEDLIGHTTEXTURE"+a],n,!1,t["IESLIGHTTEXTURE"+a],t["CLUSTLIGHT"+a]);t.NUM_MORPH_INFLUENCERS&&(r.push("morphTargetInfluences"),r.push("morphTargetCount")),t.BAKED_VERTEX_ANIMATION_TEXTURE&&(r.push("bakedVertexAnimationSettings"),r.push("bakedVertexAnimationTextureSizeInverted"),r.push("bakedVertexAnimationTime"),e.push("bakedVertexAnimationTexture"))}var yw,yl,Xi=S(()=>{Ee();gt();Mm();rn();yw={r:0,g:0,b:0},yl={NUM_MORPH_INFLUENCERS:0,NORMAL:!1,TANGENT:!1,UV:!1,UV2:!1,COLOR:!1}});var Mw,Jq,Pw=S(()=>{O();Mw="bayerDitherFunctions",Jq=`fn bayerDither2(_P: vec2f)->f32 {return ((2.0*_P.y+_P.x+1.0)%(4.0));}
fn bayerDither4(_P: vec2f)->f32 {var P1: vec2f=((_P)%(2.0)); 
var P2: vec2f=floor(0.5*((_P)%(4.0))); 
return 4.0*bayerDither2(P1)+bayerDither2(P2);}
fn bayerDither8(_P: vec2f)->f32 {var P1: vec2f=((_P)%(2.0)); 
var P2: vec2f=floor(0.5 *((_P)%(4.0))); 
var P4: vec2f=floor(0.25*((_P)%(8.0))); 
return 4.0*(4.0*bayerDither2(P1)+bayerDither2(P2))+bayerDither2(P4);}
`;g.IncludesShadersStoreWGSL[Mw]||(g.IncludesShadersStoreWGSL[Mw]=Jq)});var Dw,$q,Ow=S(()=>{O();Dm();Pw();Dw="shadowMapFragmentExtraDeclaration",$q=`#if SM_FLOAT==0
#include<packingFunctions>
#endif
#if SM_SOFTTRANSPARENTSHADOW==1
#include<bayerDitherFunctions>
uniform softTransparentShadowSM: vec2f;
#endif
varying vDepthMetricSM: f32;
#if SM_USEDISTANCE==1
uniform lightDataSM: vec3f;varying vPositionWSM: vec3f;
#endif
uniform biasAndScaleSM: vec3f;uniform depthValuesSM: vec2f;
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
varying zSM: f32;
#endif
`;g.IncludesShadersStoreWGSL[Dw]||(g.IncludesShadersStoreWGSL[Dw]=$q)});var Lw,eQ,ba=S(()=>{O();Lw="clipPlaneFragmentDeclaration",eQ=`#ifdef CLIPPLANE
varying fClipDistance: f32;
#endif
#ifdef CLIPPLANE2
varying fClipDistance2: f32;
#endif
#ifdef CLIPPLANE3
varying fClipDistance3: f32;
#endif
#ifdef CLIPPLANE4
varying fClipDistance4: f32;
#endif
#ifdef CLIPPLANE5
varying fClipDistance5: f32;
#endif
#ifdef CLIPPLANE6
varying fClipDistance6: f32;
#endif
`;g.IncludesShadersStoreWGSL[Lw]||(g.IncludesShadersStoreWGSL[Lw]=eQ)});var ww,tQ,Ca=S(()=>{O();ww="clipPlaneFragment",tQ=`#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
if (false) {}
#endif
#ifdef CLIPPLANE
else if (fragmentInputs.fClipDistance>0.0)
{discard;}
#endif
#ifdef CLIPPLANE2
else if (fragmentInputs.fClipDistance2>0.0)
{discard;}
#endif
#ifdef CLIPPLANE3
else if (fragmentInputs.fClipDistance3>0.0)
{discard;}
#endif
#ifdef CLIPPLANE4
else if (fragmentInputs.fClipDistance4>0.0)
{discard;}
#endif
#ifdef CLIPPLANE5
else if (fragmentInputs.fClipDistance5>0.0)
{discard;}
#endif
#ifdef CLIPPLANE6
else if (fragmentInputs.fClipDistance6>0.0)
{discard;}
#endif
`;g.IncludesShadersStoreWGSL[ww]||(g.IncludesShadersStoreWGSL[ww]=tQ)});var Fw,iQ,Nw=S(()=>{O();Fw="shadowMapFragment",iQ=`var depthSM: f32=fragmentInputs.vDepthMetricSM;
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
#if SM_USEDISTANCE==1
depthSM=(length(fragmentInputs.vPositionWSM-uniforms.lightDataSM)+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;
#else
#ifdef USE_REVERSE_DEPTHBUFFER
depthSM=(-fragmentInputs.zSM+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;
#else
depthSM=(fragmentInputs.zSM+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;
#endif
#endif
depthSM=clamp(depthSM,0.0,1.0);
#ifdef USE_REVERSE_DEPTHBUFFER
fragmentOutputs.fragDepth=clamp(1.0-depthSM,0.0,1.0);
#else
fragmentOutputs.fragDepth=clamp(depthSM,0.0,1.0); 
#endif
#elif SM_USEDISTANCE==1
depthSM=(length(fragmentInputs.vPositionWSM-uniforms.lightDataSM)+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;
#endif
#if SM_ESM==1
depthSM=clamp(exp(-min(87.,uniforms.biasAndScaleSM.z*depthSM)),0.,1.);
#endif
#if SM_FLOAT==1
fragmentOutputs.color= vec4f(depthSM,1.0,1.0,1.0);
#else
fragmentOutputs.color=pack(depthSM);
#endif
`;g.IncludesShadersStoreWGSL[Fw]||(g.IncludesShadersStoreWGSL[Fw]=iQ)});var Uw={};V(Uw,{shadowMapPixelShaderWGSL:()=>rQ});var QR,Bw,rQ,Gw=S(()=>{O();Ow();ba();Ca();Nw();QR="shadowMapPixelShader",Bw=`#include<shadowMapFragmentExtraDeclaration>
#ifdef ALPHATEXTURE
varying vUV: vec2f;var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;
#endif
#include<clipPlaneFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#include<clipPlaneFragment>
#ifdef ALPHATEXTURE
var opacityMap: vec4f=textureSample(diffuseSampler,diffuseSamplerSampler,fragmentInputs.vUV);var alphaFromAlphaTexture: f32=opacityMap.a;
#if SM_SOFTTRANSPARENTSHADOW==1
if (uniforms.softTransparentShadowSM.y==1.0) {opacityMap=vec4f(opacityMap.rgb* vec3f(0.3,0.59,0.11),opacityMap.a);alphaFromAlphaTexture=opacityMap.x+opacityMap.y+opacityMap.z;}
#endif
#ifdef ALPHATESTVALUE
if (alphaFromAlphaTexture<ALPHATESTVALUE) {discard;}
#endif
#endif
#if SM_SOFTTRANSPARENTSHADOW==1
#ifdef ALPHATEXTURE
if ((bayerDither8(floor(((fragmentInputs.position.xy)%(8.0)))))/64.0>=uniforms.softTransparentShadowSM.x*alphaFromAlphaTexture) {discard;}
#else
if ((bayerDither8(floor(((fragmentInputs.position.xy)%(8.0)))))/64.0>=uniforms.softTransparentShadowSM.x) {discard;} 
#endif
#endif
#include<shadowMapFragment>
}`;g.ShadersStoreWGSL[QR]||(g.ShadersStoreWGSL[QR]=Bw);rQ={name:QR,shader:Bw}});var Vw,sQ,Ia=S(()=>{O();Vw="bonesDeclaration",sQ=`#if NUM_BONE_INFLUENCERS>0
attribute matricesIndices : vec4<f32>;attribute matricesWeights : vec4<f32>;
#if NUM_BONE_INFLUENCERS>4
attribute matricesIndicesExtra : vec4<f32>;attribute matricesWeightsExtra : vec4<f32>;
#endif
#ifndef BAKED_VERTEX_ANIMATION_TEXTURE
#ifdef BONETEXTURE
var boneSampler : texture_2d<f32>;uniform boneTextureWidth : f32;
#else
uniform mBones : array<mat4x4f,BonesPerMesh>;
#endif
#ifdef BONES_VELOCITY_ENABLED
uniform mPreviousBones : array<mat4x4f,BonesPerMesh>;
#endif
#ifdef BONETEXTURE
fn readMatrixFromRawSampler(smp : texture_2d<f32>,index : f32)->mat4x4f
{let offset=i32(index) *4; 
let m0=textureLoad(smp,vec2<i32>(offset+0,0),0);let m1=textureLoad(smp,vec2<i32>(offset+1,0),0);let m2=textureLoad(smp,vec2<i32>(offset+2,0),0);let m3=textureLoad(smp,vec2<i32>(offset+3,0),0);return mat4x4f(m0,m1,m2,m3);}
#endif
#endif
#endif
`;g.IncludesShadersStoreWGSL[Vw]||(g.IncludesShadersStoreWGSL[Vw]=sQ)});var kw,nQ,Bn=S(()=>{O();kw="bakedVertexAnimationDeclaration",nQ=`#ifdef BAKED_VERTEX_ANIMATION_TEXTURE
uniform bakedVertexAnimationTime: f32;uniform bakedVertexAnimationTextureSizeInverted: vec2<f32>;uniform bakedVertexAnimationSettings: vec4<f32>;var bakedVertexAnimationTexture : texture_2d<f32>;
#ifdef INSTANCES
attribute bakedVertexAnimationSettingsInstanced : vec4<f32>;
#endif
fn readMatrixFromRawSamplerVAT(smp : texture_2d<f32>,index : f32,frame : f32)->mat4x4<f32>
{let offset=i32(index)*4;let frameUV=i32(frame);let m0=textureLoad(smp,vec2<i32>(offset+0,frameUV),0);let m1=textureLoad(smp,vec2<i32>(offset+1,frameUV),0);let m2=textureLoad(smp,vec2<i32>(offset+2,frameUV),0);let m3=textureLoad(smp,vec2<i32>(offset+3,frameUV),0);return mat4x4<f32>(m0,m1,m2,m3);}
#endif
`;g.IncludesShadersStoreWGSL[kw]||(g.IncludesShadersStoreWGSL[kw]=nQ)});var Ww,aQ,Oo=S(()=>{O();Ww="morphTargetsVertexGlobalDeclaration",aQ=`#ifdef MORPHTARGETS
uniform morphTargetInfluences : array<f32,NUM_MORPH_INFLUENCERS>;
#ifdef MORPHTARGETS_TEXTURE 
uniform morphTargetTextureIndices : array<f32,NUM_MORPH_INFLUENCERS>;uniform morphTargetTextureInfo : vec3<f32>;var morphTargets : texture_2d_array<f32>;var morphTargetsSampler : sampler;fn readVector3FromRawSampler(targetIndex : i32,vertexIndex : f32)->vec3<f32>
{ 
let y=floor(vertexIndex/uniforms.morphTargetTextureInfo.y);let x=vertexIndex-y*uniforms.morphTargetTextureInfo.y;let textureUV=vec2<f32>((x+0.5)/uniforms.morphTargetTextureInfo.y,(y+0.5)/uniforms.morphTargetTextureInfo.z);return textureSampleLevel(morphTargets,morphTargetsSampler,textureUV,i32(uniforms.morphTargetTextureIndices[targetIndex]),0.0).xyz;}
fn readVector4FromRawSampler(targetIndex : i32,vertexIndex : f32)->vec4<f32>
{ 
let y=floor(vertexIndex/uniforms.morphTargetTextureInfo.y);let x=vertexIndex-y*uniforms.morphTargetTextureInfo.y;let textureUV=vec2<f32>((x+0.5)/uniforms.morphTargetTextureInfo.y,(y+0.5)/uniforms.morphTargetTextureInfo.z);return textureSampleLevel(morphTargets,morphTargetsSampler,textureUV,i32(uniforms.morphTargetTextureIndices[targetIndex]),0.0);}
#endif
#endif
`;g.IncludesShadersStoreWGSL[Ww]||(g.IncludesShadersStoreWGSL[Ww]=aQ)});var Hw,oQ,Lo=S(()=>{O();Hw="morphTargetsVertexDeclaration",oQ=`#ifdef MORPHTARGETS
#ifndef MORPHTARGETS_TEXTURE
#ifdef MORPHTARGETS_POSITION
attribute position{X} : vec3<f32>;
#endif
#ifdef MORPHTARGETS_NORMAL
attribute normal{X} : vec3<f32>;
#endif
#ifdef MORPHTARGETS_TANGENT
attribute tangent{X} : vec3<f32>;
#endif
#ifdef MORPHTARGETS_UV
attribute uv_{X} : vec2<f32>;
#endif
#ifdef MORPHTARGETS_UV2
attribute uv2_{X} : vec2<f32>;
#endif
#ifdef MORPHTARGETS_COLOR
attribute color{X} : vec4<f32>;
#endif
#elif {X}==0
uniform morphTargetCount: f32;
#endif
#endif
`;g.IncludesShadersStoreWGSL[Hw]||(g.IncludesShadersStoreWGSL[Hw]=oQ)});var zw,lQ,Pi=S(()=>{O();zw="helperFunctions",lQ=`const PI: f32=3.1415926535897932384626433832795;const TWO_PI: f32=6.283185307179586;const HALF_PI: f32=1.5707963267948966;const RECIPROCAL_PI: f32=0.3183098861837907;const RECIPROCAL_PI2: f32=0.15915494309189535;const RECIPROCAL_PI4: f32=0.07957747154594767;const HALF_MIN: f32=5.96046448e-08; 
const LinearEncodePowerApprox: f32=2.2;const GammaEncodePowerApprox: f32=1.0/LinearEncodePowerApprox;const LuminanceEncodeApprox: vec3f=vec3f(0.2126,0.7152,0.0722);const Epsilon:f32=0.0000001;fn square(x: f32)->f32 {return x*x;}
fn saturate(x: f32)->f32 {return clamp(x,0.0,1.0);}
fn saturateVec3(x: vec3f)->vec3f {return clamp(x,vec3f(),vec3f(1.0));}
fn saturateEps(x: f32)->f32 {return clamp(x,Epsilon,1.0);}
fn maxEps(x: f32)->f32 {return max(x,Epsilon);}
fn maxEpsVec3(x: vec3f)->vec3f {return max(x,vec3f(Epsilon));}
fn absEps(x: f32)->f32 {return abs(x)+Epsilon;}
fn transposeMat3(inMatrix: mat3x3f)->mat3x3f {let i0: vec3f=inMatrix[0];let i1: vec3f=inMatrix[1];let i2: vec3f=inMatrix[2];let outMatrix:mat3x3f=mat3x3f(
vec3(i0.x,i1.x,i2.x),
vec3(i0.y,i1.y,i2.y),
vec3(i0.z,i1.z,i2.z)
);return outMatrix;}
fn inverseMat3(inMatrix: mat3x3f)->mat3x3f {let a00: f32=inMatrix[0][0];let a01: f32=inMatrix[0][1];let a02: f32=inMatrix[0][2];let a10: f32=inMatrix[1][0];let a11: f32=inMatrix[1][1];let a12: f32=inMatrix[1][2];let a20: f32=inMatrix[2][0];let a21: f32=inMatrix[2][1];let a22: f32=inMatrix[2][2];let b01: f32=a22*a11-a12*a21;let b11: f32=-a22*a10+a12*a20;let b21: f32=a21*a10-a11*a20;let det: f32=a00*b01+a01*b11+a02*b21;return mat3x3f(b01/det,(-a22*a01+a02*a21)/det,(a12*a01-a02*a11)/det,
b11/det,(a22*a00-a02*a20)/det,(-a12*a00+a02*a10)/det,
b21/det,(-a21*a00+a01*a20)/det,(a11*a00-a01*a10)/det);}
#if USE_EXACT_SRGB_CONVERSIONS
fn toLinearSpaceExact(color: vec3f)->vec3f
{let nearZeroSection: vec3f=0.0773993808*color;let remainingSection: vec3f=pow(0.947867299*(color+vec3f(0.055)),vec3f(2.4));return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3f(0.04045)));}
fn toGammaSpaceExact(color: vec3f)->vec3f
{let nearZeroSection: vec3f=12.92*color;let remainingSection: vec3f=1.055*pow(color,vec3f(0.41666))-vec3f(0.055);return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3f(0.0031308)));}
#endif
fn toLinearSpace(color: f32)->f32
{
#if USE_EXACT_SRGB_CONVERSIONS
var nearZeroSection=0.0773993808*color;var remainingSection=pow(0.947867299*(color+0.055),2.4);return select(remainingSection,nearZeroSection,color<=0.04045);
#else
return pow(color,LinearEncodePowerApprox);
#endif
}
fn toLinearSpaceVec3(color: vec3f)->vec3f
{
#if USE_EXACT_SRGB_CONVERSIONS
return toLinearSpaceExact(color);
#else
return pow(color,vec3f(LinearEncodePowerApprox));
#endif
}
fn toLinearSpaceVec4(color: vec4<f32>)->vec4<f32>
{
#if USE_EXACT_SRGB_CONVERSIONS
return vec4f(toLinearSpaceExact(color.rgb),color.a);
#else
return vec4f(pow(color.rgb,vec3f(LinearEncodePowerApprox)),color.a);
#endif
}
fn toGammaSpace(color: vec4<f32>)->vec4<f32>
{
#if USE_EXACT_SRGB_CONVERSIONS
return vec4<f32>(toGammaSpaceExact(color.rgb),color.a);
#else
return vec4<f32>(pow(color.rgb,vec3f(GammaEncodePowerApprox)),color.a);
#endif
}
fn toGammaSpaceVec3(color: vec3f)->vec3f
{
#if USE_EXACT_SRGB_CONVERSIONS
return toGammaSpaceExact(color);
#else
return pow(color,vec3f(GammaEncodePowerApprox));
#endif
}
fn squareVec3(value: vec3f)->vec3f
{return value*value;}
fn pow5(value: f32)->f32 {let sq: f32=value*value;return sq*sq*value;}
fn getLuminance(color: vec3f)->f32
{return saturate(dot(color,LuminanceEncodeApprox));}
fn getRand(seed: vec2<f32>)->f32 {return fract(sin(dot(seed.xy ,vec2<f32>(12.9898,78.233)))*43758.5453);}
fn dither(seed: vec2<f32>,varianceAmount: f32)->f32 {let rand: f32=getRand(seed);let normVariance: f32=varianceAmount/255.0;let dither: f32=mix(-normVariance,normVariance,rand);return dither;}
const rgbdMaxRange: f32=255.0;fn toRGBD(color: vec3f)->vec4<f32> {let maxRGB: f32=max(max(color.r,max(color.g,color.b)),Epsilon);var D: f32 =max(rgbdMaxRange/maxRGB,1.);D =clamp(floor(D)/255.0,0.,1.);var rgb: vec3f =color.rgb*D;rgb=toGammaSpaceVec3(rgb);return vec4<f32>(saturateVec3(rgb),D);}
fn fromRGBD(rgbd: vec4<f32>)->vec3f {let rgb=toLinearSpaceVec3(rgbd.rgb);return rgb/rgbd.a;}
fn parallaxCorrectNormal(vertexPos: vec3f,origVec: vec3f,cubeSize: vec3f,cubePos: vec3f)->vec3f {let invOrigVec: vec3f=vec3f(1.)/origVec;let halfSize: vec3f=cubeSize*0.5;let intersecAtMaxPlane: vec3f=(cubePos+halfSize-vertexPos)*invOrigVec;let intersecAtMinPlane: vec3f=(cubePos-halfSize-vertexPos)*invOrigVec;let largestIntersec: vec3f=max(intersecAtMaxPlane,intersecAtMinPlane);let distance: f32=min(min(largestIntersec.x,largestIntersec.y),largestIntersec.z);let intersectPositionWS: vec3f=vertexPos+origVec*distance;return intersectPositionWS-cubePos;}
fn equirectangularToCubemapDirection(uv : vec2f)->vec3f {var longitude : f32=uv.x*TWO_PI-PI;var latitude : f32=HALF_PI-uv.y*PI;var direction : vec3f;direction.x=cos(latitude)*sin(longitude);direction.y=sin(latitude);direction.z=cos(latitude)*cos(longitude);return direction;}
fn sqrtClamped(value: f32)->f32 {return sqrt(max(value,0.));}
fn avg(value: vec3f)->f32 {return dot(value,vec3f(0.333333333));}
`;g.IncludesShadersStoreWGSL[zw]||(g.IncludesShadersStoreWGSL[zw]=lQ)});var Xw,cQ,wo=S(()=>{O();Xw="sceneUboDeclaration",cQ=`struct Scene {viewProjection : mat4x4<f32>,
#ifdef MULTIVIEW
viewProjectionR : mat4x4<f32>,
#endif 
view : mat4x4<f32>,
projection : mat4x4<f32>,
vEyePosition : vec4<f32>,};
#define SCENE_UBO
var<uniform> scene : Scene;
`;g.IncludesShadersStoreWGSL[Xw]||(g.IncludesShadersStoreWGSL[Xw]=cQ)});var Yw,fQ,rf=S(()=>{O();Yw="meshUboDeclaration",fQ=`struct Mesh {world : mat4x4<f32>,
visibility : f32,};var<uniform> mesh : Mesh;
#define WORLD_UBO
`;g.IncludesShadersStoreWGSL[Yw]||(g.IncludesShadersStoreWGSL[Yw]=fQ)});var Kw,hQ,qw=S(()=>{O();Kw="shadowMapVertexExtraDeclaration",hQ=`#if SM_NORMALBIAS==1
uniform lightDataSM: vec3f;
#endif
uniform biasAndScaleSM: vec3f;uniform depthValuesSM: vec2f;varying vDepthMetricSM: f32;
#if SM_USEDISTANCE==1
varying vPositionWSM: vec3f;
#endif
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
varying zSM: f32;
#endif
`;g.IncludesShadersStoreWGSL[Kw]||(g.IncludesShadersStoreWGSL[Kw]=hQ)});var Qw,uQ,ya=S(()=>{O();Qw="clipPlaneVertexDeclaration",uQ=`#ifdef CLIPPLANE
uniform vClipPlane: vec4<f32>;varying fClipDistance: f32;
#endif
#ifdef CLIPPLANE2
uniform vClipPlane2: vec4<f32>;varying fClipDistance2: f32;
#endif
#ifdef CLIPPLANE3
uniform vClipPlane3: vec4<f32>;varying fClipDistance3: f32;
#endif
#ifdef CLIPPLANE4
uniform vClipPlane4: vec4<f32>;varying fClipDistance4: f32;
#endif
#ifdef CLIPPLANE5
uniform vClipPlane5: vec4<f32>;varying fClipDistance5: f32;
#endif
#ifdef CLIPPLANE6
uniform vClipPlane6: vec4<f32>;varying fClipDistance6: f32;
#endif
`;g.IncludesShadersStoreWGSL[Qw]||(g.IncludesShadersStoreWGSL[Qw]=uQ)});var jw,dQ,Fo=S(()=>{O();jw="morphTargetsVertexGlobal",dQ=`#ifdef MORPHTARGETS
#ifdef MORPHTARGETS_TEXTURE
var vertexID : f32;
#endif
#endif
`;g.IncludesShadersStoreWGSL[jw]||(g.IncludesShadersStoreWGSL[jw]=dQ)});var Zw,pQ,No=S(()=>{O();Zw="morphTargetsVertex",pQ=`#ifdef MORPHTARGETS
#ifdef MORPHTARGETS_TEXTURE
#if {X}==0
for (var i=0; i<NUM_MORPH_INFLUENCERS; i=i+1) {if (f32(i)>=uniforms.morphTargetCount) {break;}
vertexID=f32(vertexInputs.vertexIndex)*uniforms.morphTargetTextureInfo.x;
#ifdef MORPHTARGETS_POSITION
positionUpdated=positionUpdated+(readVector3FromRawSampler(i,vertexID)-vertexInputs.position)*uniforms.morphTargetInfluences[i];
#endif
#ifdef MORPHTARGETTEXTURE_HASPOSITIONS
vertexID=vertexID+1.0;
#endif
#ifdef MORPHTARGETS_NORMAL
normalUpdated=normalUpdated+(readVector3FromRawSampler(i,vertexID) -vertexInputs.normal)*uniforms.morphTargetInfluences[i];
#endif
#ifdef MORPHTARGETTEXTURE_HASNORMALS
vertexID=vertexID+1.0;
#endif
#ifdef MORPHTARGETS_UV
uvUpdated=uvUpdated+(readVector3FromRawSampler(i,vertexID).xy-vertexInputs.uv)*uniforms.morphTargetInfluences[i];
#endif
#ifdef MORPHTARGETTEXTURE_HASUVS
vertexID=vertexID+1.0;
#endif
#ifdef MORPHTARGETS_TANGENT
tangentUpdated=vec4f(tangentUpdated.xyz+(readVector3FromRawSampler(i,vertexID) -vertexInputs.tangent.xyz)*uniforms.morphTargetInfluences[i],tangentUpdated.a);
#endif
#ifdef MORPHTARGETTEXTURE_HASTANGENTS
vertexID=vertexID+1.0;
#endif
#ifdef MORPHTARGETS_UV2
uv2Updated=uv2Updated+(readVector3FromRawSampler(i,vertexID).xy-vertexInputs.uv2)*uniforms.morphTargetInfluences[i];
#endif
#ifdef MORPHTARGETS_COLOR
colorUpdated=colorUpdated+(readVector4FromRawSampler(i,vertexID)-vertexInputs.color)*uniforms.morphTargetInfluences[i];
#endif
}
#endif
#else
#ifdef MORPHTARGETS_POSITION
positionUpdated=positionUpdated+(vertexInputs.position{X}-vertexInputs.position)*uniforms.morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_NORMAL
normalUpdated=normalUpdated+(vertexInputs.normal{X}-vertexInputs.normal)*uniforms.morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_TANGENT
tangentUpdated=vec4f(tangentUpdated.xyz+(vertexInputs.tangent{X}-vertexInputs.tangent.xyz)*uniforms.morphTargetInfluences[{X}],tangentUpdated.a);
#endif
#ifdef MORPHTARGETS_UV
uvUpdated=uvUpdated+(vertexInputs.uv_{X}-vertexInputs.uv)*uniforms.morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_UV2
uv2Updated=uv2Updated+(vertexInputs.uv2_{X}-vertexInputs.uv2)*uniforms.morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_COLOR
colorUpdated=colorUpdated+(vertexInputs.color{X}-vertexInputs.color)*uniforms.morphTargetInfluences[{X}];
#endif
#endif
#endif
`;g.IncludesShadersStoreWGSL[Zw]||(g.IncludesShadersStoreWGSL[Zw]=pQ)});var Jw,mQ,Un=S(()=>{O();Jw="instancesVertex",mQ=`#ifdef INSTANCES
var finalWorld=mat4x4<f32>(vertexInputs.world0,vertexInputs.world1,vertexInputs.world2,vertexInputs.world3);
#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)
var finalPreviousWorld=mat4x4<f32>(
vertexInputs.previousWorld0,vertexInputs.previousWorld1,
vertexInputs.previousWorld2,vertexInputs.previousWorld3);
#endif
#ifdef THIN_INSTANCES
#if !defined(WORLD_UBO)
finalWorld=uniforms.world*finalWorld;
#else
finalWorld=mesh.world*finalWorld;
#endif
#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)
finalPreviousWorld=uniforms.previousWorld*finalPreviousWorld;
#endif
#endif
#else
#if !defined(WORLD_UBO)
var finalWorld=uniforms.world;
#else
var finalWorld=mesh.world;
#endif
#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)
var finalPreviousWorld=uniforms.previousWorld;
#endif
#endif
`;g.IncludesShadersStoreWGSL[Jw]||(g.IncludesShadersStoreWGSL[Jw]=mQ)});var $w,_Q,Ma=S(()=>{O();$w="bonesVertex",_Q=`#ifndef BAKED_VERTEX_ANIMATION_TEXTURE
#if NUM_BONE_INFLUENCERS>0
var influence : mat4x4<f32>;
#ifdef BONETEXTURE
influence=readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndices[0])*vertexInputs.matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndices[1])*vertexInputs.matricesWeights[1];
#endif 
#if NUM_BONE_INFLUENCERS>2
influence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndices[2])*vertexInputs.matricesWeights[2];
#endif 
#if NUM_BONE_INFLUENCERS>3
influence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndices[3])*vertexInputs.matricesWeights[3];
#endif 
#if NUM_BONE_INFLUENCERS>4
influence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndicesExtra[0])*vertexInputs.matricesWeightsExtra[0];
#endif 
#if NUM_BONE_INFLUENCERS>5
influence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndicesExtra[1])*vertexInputs.matricesWeightsExtra[1];
#endif 
#if NUM_BONE_INFLUENCERS>6
influence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndicesExtra[2])*vertexInputs.matricesWeightsExtra[2];
#endif 
#if NUM_BONE_INFLUENCERS>7
influence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndicesExtra[3])*vertexInputs.matricesWeightsExtra[3];
#endif 
#else 
influence=uniforms.mBones[i32(vertexInputs.matricesIndices[0])]*vertexInputs.matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence=influence+uniforms.mBones[i32(vertexInputs.matricesIndices[1])]*vertexInputs.matricesWeights[1];
#endif 
#if NUM_BONE_INFLUENCERS>2
influence=influence+uniforms.mBones[i32(vertexInputs.matricesIndices[2])]*vertexInputs.matricesWeights[2];
#endif 
#if NUM_BONE_INFLUENCERS>3
influence=influence+uniforms.mBones[i32(vertexInputs.matricesIndices[3])]*vertexInputs.matricesWeights[3];
#endif 
#if NUM_BONE_INFLUENCERS>4
influence=influence+uniforms.mBones[i32(vertexInputs.matricesIndicesExtra[0])]*vertexInputs.matricesWeightsExtra[0];
#endif 
#if NUM_BONE_INFLUENCERS>5
influence=influence+uniforms.mBones[i32(vertexInputs.matricesIndicesExtra[1])]*vertexInputs.matricesWeightsExtra[1];
#endif 
#if NUM_BONE_INFLUENCERS>6
influence=influence+uniforms.mBones[i32(vertexInputs.matricesIndicesExtra[2])]*vertexInputs.matricesWeightsExtra[2];
#endif 
#if NUM_BONE_INFLUENCERS>7
influence=influence+uniforms.mBones[i32(vertexInputs.matricesIndicesExtra[3])]*vertexInputs.matricesWeightsExtra[3];
#endif 
#endif
finalWorld=finalWorld*influence;
#endif
#endif
`;g.IncludesShadersStoreWGSL[$w]||(g.IncludesShadersStoreWGSL[$w]=_Q)});var eF,gQ,Gn=S(()=>{O();eF="bakedVertexAnimation",gQ=`#ifdef BAKED_VERTEX_ANIMATION_TEXTURE
{
#ifdef INSTANCES
let VATStartFrame: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.x;let VATEndFrame: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.y;let VATOffsetFrame: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.z;let VATSpeed: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.w;
#else
let VATStartFrame: f32=uniforms.bakedVertexAnimationSettings.x;let VATEndFrame: f32=uniforms.bakedVertexAnimationSettings.y;let VATOffsetFrame: f32=uniforms.bakedVertexAnimationSettings.z;let VATSpeed: f32=uniforms.bakedVertexAnimationSettings.w;
#endif
let totalFrames: f32=VATEndFrame-VATStartFrame+1.0;let time: f32=uniforms.bakedVertexAnimationTime*VATSpeed/totalFrames;let frameCorrection: f32=select(1.0,0.0,time<1.0);let numOfFrames: f32=totalFrames-frameCorrection;var VATFrameNum: f32=fract(time)*numOfFrames;VATFrameNum=(VATFrameNum+VATOffsetFrame) % numOfFrames;VATFrameNum=floor(VATFrameNum);VATFrameNum=VATFrameNum+VATStartFrame+frameCorrection;var VATInfluence : mat4x4<f32>;VATInfluence=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[0],VATFrameNum)*vertexInputs.matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[1],VATFrameNum)*vertexInputs.matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[2],VATFrameNum)*vertexInputs.matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[3],VATFrameNum)*vertexInputs.matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[0],VATFrameNum)*vertexInputs.matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[1],VATFrameNum)*vertexInputs.matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[2],VATFrameNum)*vertexInputs.matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[3],VATFrameNum)*vertexInputs.matricesWeightsExtra[3];
#endif
finalWorld=finalWorld*VATInfluence;}
#endif
`;g.IncludesShadersStoreWGSL[eF]||(g.IncludesShadersStoreWGSL[eF]=gQ)});var tF,vQ,iF=S(()=>{O();tF="shadowMapVertexNormalBias",vQ=`#if SM_NORMALBIAS==1
#if SM_DIRECTIONINLIGHTDATA==1
var worldLightDirSM: vec3f=normalize(-uniforms.lightDataSM.xyz);
#else
var directionToLightSM: vec3f=uniforms.lightDataSM.xyz-worldPos.xyz;var worldLightDirSM: vec3f=normalize(directionToLightSM);
#endif
var ndlSM: f32=dot(vNormalW,worldLightDirSM);var sinNLSM: f32=sqrt(1.0-ndlSM*ndlSM);var normalBiasSM: f32=uniforms.biasAndScaleSM.y*sinNLSM;worldPos=vec4f(worldPos.xyz-vNormalW*normalBiasSM,worldPos.w);
#endif
`;g.IncludesShadersStoreWGSL[tF]||(g.IncludesShadersStoreWGSL[tF]=vQ)});var rF,SQ,sF=S(()=>{O();rF="shadowMapVertexMetric",SQ=`#if SM_USEDISTANCE==1
vertexOutputs.vPositionWSM=worldPos.xyz;
#endif
#if SM_DEPTHTEXTURE==1
#ifdef IS_NDC_HALF_ZRANGE
#define BIASFACTOR 0.5
#else
#define BIASFACTOR 1.0
#endif
#ifdef USE_REVERSE_DEPTHBUFFER
vertexOutputs.position.z-=uniforms.biasAndScaleSM.x*vertexOutputs.position.w*BIASFACTOR;
#else
vertexOutputs.position.z+=uniforms.biasAndScaleSM.x*vertexOutputs.position.w*BIASFACTOR;
#endif
#endif
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
vertexOutputs.zSM=vertexOutputs.position.z;vertexOutputs.position.z=0.0;
#elif SM_USEDISTANCE==0
#ifdef USE_REVERSE_DEPTHBUFFER
vertexOutputs.vDepthMetricSM=(-vertexOutputs.position.z+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;
#else
vertexOutputs.vDepthMetricSM=(vertexOutputs.position.z+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;
#endif
#endif
`;g.IncludesShadersStoreWGSL[rF]||(g.IncludesShadersStoreWGSL[rF]=SQ)});var nF,EQ,Pa=S(()=>{O();nF="clipPlaneVertex",EQ=`#ifdef CLIPPLANE
vertexOutputs.fClipDistance=dot(worldPos,uniforms.vClipPlane);
#endif
#ifdef CLIPPLANE2
vertexOutputs.fClipDistance2=dot(worldPos,uniforms.vClipPlane2);
#endif
#ifdef CLIPPLANE3
vertexOutputs.fClipDistance3=dot(worldPos,uniforms.vClipPlane3);
#endif
#ifdef CLIPPLANE4
vertexOutputs.fClipDistance4=dot(worldPos,uniforms.vClipPlane4);
#endif
#ifdef CLIPPLANE5
vertexOutputs.fClipDistance5=dot(worldPos,uniforms.vClipPlane5);
#endif
#ifdef CLIPPLANE6
vertexOutputs.fClipDistance6=dot(worldPos,uniforms.vClipPlane6);
#endif
`;g.IncludesShadersStoreWGSL[nF]||(g.IncludesShadersStoreWGSL[nF]=EQ)});var oF={};V(oF,{shadowMapVertexShaderWGSL:()=>TQ});var jR,aF,TQ,lF=S(()=>{O();Ia();Bn();Oo();Lo();Pi();wo();rf();qw();ya();Fo();No();Un();Ma();Gn();iF();sF();Pa();jR="shadowMapVertexShader",aF=`attribute position: vec3f;
#ifdef NORMAL
attribute normal: vec3f;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef INSTANCES
attribute world0: vec4f;attribute world1: vec4f;attribute world2: vec4f;attribute world3: vec4f;
#endif
#include<helperFunctions>
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
#ifdef ALPHATEXTURE
varying vUV: vec2f;uniform diffuseMatrix: mat4x4f;
#ifdef UV1
attribute uv: vec2f;
#endif
#ifdef UV2
attribute uv2: vec2f;
#endif
#endif
#include<shadowMapVertexExtraDeclaration>
#include<clipPlaneVertexDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {var positionUpdated: vec3f=input.position;
#ifdef UV1
var uvUpdated: vec2f=input.uv;
#endif
#ifdef UV2
var uv2Updated: vec2f=input.uv2;
#endif
#ifdef NORMAL
var normalUpdated: vec3f=input.normal;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
var worldPos: vec4f=finalWorld* vec4f(positionUpdated,1.0);
#ifdef NORMAL
var normWorldSM: mat3x3f= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
var vNormalW: vec3f=normalUpdated/ vec3f(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));vNormalW=normalize(normWorldSM*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normWorldSM=transposeMat3(inverseMat3(normWorldSM));
#endif
var vNormalW: vec3f=normalize(normWorldSM*normalUpdated);
#endif
#endif
#include<shadowMapVertexNormalBias>
vertexOutputs.position=scene.viewProjection*worldPos;
#include<shadowMapVertexMetric>
#ifdef ALPHATEXTURE
#ifdef UV1
vertexOutputs.vUV= (uniforms.diffuseMatrix* vec4f(uvUpdated,1.0,0.0)).xy;
#endif
#ifdef UV2
vertexOutputs.vUV= (uniforms.diffuseMatrix* vec4f(uv2Updated,1.0,0.0)).xy;
#endif
#endif
#include<clipPlaneVertex>
}`;g.ShadersStoreWGSL[jR]||(g.ShadersStoreWGSL[jR]=aF);TQ={name:jR,shader:aF}});var fF={};V(fF,{depthBoxBlurPixelShaderWGSL:()=>xQ});var ZR,cF,xQ,hF=S(()=>{O();ZR="depthBoxBlurPixelShader",cF=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform screenSize: vec2f;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var colorDepth: vec4f=vec4f(0.0);for (var x: i32=-OFFSET; x<=OFFSET; x++) {for (var y: i32=-OFFSET; y<=OFFSET; y++) {colorDepth+=textureSample(textureSampler,textureSamplerSampler,input.vUV+ vec2f(f32(x),f32(y))/uniforms.screenSize);}}
fragmentOutputs.color=(colorDepth/ f32((OFFSET*2+1)*(OFFSET*2+1)));}`;g.ShadersStoreWGSL[ZR]||(g.ShadersStoreWGSL[ZR]=cF);xQ={name:ZR,shader:cF}});var dF={};V(dF,{shadowMapFragmentSoftTransparentShadowWGSL:()=>AQ});var JR,uF,AQ,pF=S(()=>{O();JR="shadowMapFragmentSoftTransparentShadow",uF=`#if SM_SOFTTRANSPARENTSHADOW==1
if ((bayerDither8(floor(((fragmentInputs.position.xy)%(8.0)))))/64.0>=uniforms.softTransparentShadowSM.x*alpha) {discard;}
#endif
`;g.IncludesShadersStoreWGSL[JR]||(g.IncludesShadersStoreWGSL[JR]=uF);AQ={name:JR,shader:uF}});var mF,RQ,_F=S(()=>{O();mF="bayerDitherFunctions",RQ=`float bayerDither2(vec2 _P) {return mod(2.0*_P.y+_P.x+1.0,4.0);}
float bayerDither4(vec2 _P) {vec2 P1=mod(_P,2.0); 
vec2 P2=floor(0.5*mod(_P,4.0)); 
return 4.0*bayerDither2(P1)+bayerDither2(P2);}
float bayerDither8(vec2 _P) {vec2 P1=mod(_P,2.0); 
vec2 P2=floor(0.5 *mod(_P,4.0)); 
vec2 P4=floor(0.25*mod(_P,8.0)); 
return 4.0*(4.0*bayerDither2(P1)+bayerDither2(P2))+bayerDither2(P4);}
`;g.IncludesShadersStore[mF]||(g.IncludesShadersStore[mF]=RQ)});var gF,bQ,vF=S(()=>{O();Om();_F();gF="shadowMapFragmentExtraDeclaration",bQ=`#if SM_FLOAT==0
#include<packingFunctions>
#endif
#if SM_SOFTTRANSPARENTSHADOW==1
#include<bayerDitherFunctions>
uniform vec2 softTransparentShadowSM;
#endif
varying float vDepthMetricSM;
#if SM_USEDISTANCE==1
uniform vec3 lightDataSM;varying vec3 vPositionWSM;
#endif
uniform vec3 biasAndScaleSM;uniform vec2 depthValuesSM;
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
varying float zSM;
#endif
`;g.IncludesShadersStore[gF]||(g.IncludesShadersStore[gF]=bQ)});var SF,CQ,Da=S(()=>{O();SF="clipPlaneFragmentDeclaration",CQ=`#ifdef CLIPPLANE
varying float fClipDistance;
#endif
#ifdef CLIPPLANE2
varying float fClipDistance2;
#endif
#ifdef CLIPPLANE3
varying float fClipDistance3;
#endif
#ifdef CLIPPLANE4
varying float fClipDistance4;
#endif
#ifdef CLIPPLANE5
varying float fClipDistance5;
#endif
#ifdef CLIPPLANE6
varying float fClipDistance6;
#endif
`;g.IncludesShadersStore[SF]||(g.IncludesShadersStore[SF]=CQ)});var EF,IQ,Oa=S(()=>{O();EF="clipPlaneFragment",IQ=`#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
if (false) {}
#endif
#ifdef CLIPPLANE
else if (fClipDistance>0.0)
{discard;}
#endif
#ifdef CLIPPLANE2
else if (fClipDistance2>0.0)
{discard;}
#endif
#ifdef CLIPPLANE3
else if (fClipDistance3>0.0)
{discard;}
#endif
#ifdef CLIPPLANE4
else if (fClipDistance4>0.0)
{discard;}
#endif
#ifdef CLIPPLANE5
else if (fClipDistance5>0.0)
{discard;}
#endif
#ifdef CLIPPLANE6
else if (fClipDistance6>0.0)
{discard;}
#endif
`;g.IncludesShadersStore[EF]||(g.IncludesShadersStore[EF]=IQ)});var TF,yQ,xF=S(()=>{O();TF="shadowMapFragment",yQ=`float depthSM=vDepthMetricSM;
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
#if SM_USEDISTANCE==1
depthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#else
#ifdef USE_REVERSE_DEPTHBUFFER
depthSM=(-zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#else
depthSM=(zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#endif
#endif
depthSM=clamp(depthSM,0.0,1.0);
#ifdef USE_REVERSE_DEPTHBUFFER
gl_FragDepth=clamp(1.0-depthSM,0.0,1.0);
#else
gl_FragDepth=clamp(depthSM,0.0,1.0); 
#endif
#elif SM_USEDISTANCE==1
depthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#endif
#if SM_ESM==1
depthSM=clamp(exp(-min(87.,biasAndScaleSM.z*depthSM)),0.,1.);
#endif
#if SM_FLOAT==1
gl_FragColor=vec4(depthSM,1.0,1.0,1.0);
#else
gl_FragColor=pack(depthSM);
#endif
return;`;g.IncludesShadersStore[TF]||(g.IncludesShadersStore[TF]=yQ)});var RF={};V(RF,{shadowMapPixelShader:()=>MQ});var $R,AF,MQ,bF=S(()=>{O();vF();Da();Oa();xF();$R="shadowMapPixelShader",AF=`#include<shadowMapFragmentExtraDeclaration>
#ifdef ALPHATEXTURE
varying vec2 vUV;uniform sampler2D diffuseSampler;
#endif
#include<clipPlaneFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#include<clipPlaneFragment>
#ifdef ALPHATEXTURE
vec4 opacityMap=texture2D(diffuseSampler,vUV);float alphaFromAlphaTexture=opacityMap.a;
#if SM_SOFTTRANSPARENTSHADOW==1
if (softTransparentShadowSM.y==1.0) {opacityMap.rgb=opacityMap.rgb*vec3(0.3,0.59,0.11);alphaFromAlphaTexture=opacityMap.x+opacityMap.y+opacityMap.z;}
#endif
#ifdef ALPHATESTVALUE
if (alphaFromAlphaTexture<ALPHATESTVALUE)
discard;
#endif
#endif
#if SM_SOFTTRANSPARENTSHADOW==1
#ifdef ALPHATEXTURE
if ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM.x*alphaFromAlphaTexture) discard;
#else
if ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM.x) discard;
#endif
#endif
#include<shadowMapFragment>
}`;g.ShadersStore[$R]||(g.ShadersStore[$R]=AF);MQ={name:$R,shader:AF}});var CF,PQ,La=S(()=>{O();CF="bonesDeclaration",PQ=`#if NUM_BONE_INFLUENCERS>0
attribute vec4 matricesIndices;attribute vec4 matricesWeights;
#if NUM_BONE_INFLUENCERS>4
attribute vec4 matricesIndicesExtra;attribute vec4 matricesWeightsExtra;
#endif
#ifndef BAKED_VERTEX_ANIMATION_TEXTURE
#ifdef BONETEXTURE
uniform highp sampler2D boneSampler;uniform float boneTextureWidth;
#else
uniform mat4 mBones[BonesPerMesh];
#endif
#ifdef BONES_VELOCITY_ENABLED
uniform mat4 mPreviousBones[BonesPerMesh];
#endif
#ifdef BONETEXTURE
#define inline
mat4 readMatrixFromRawSampler(sampler2D smp,float index)
{float offset=index *4.0;float dx=1.0/boneTextureWidth;vec4 m0=texture2D(smp,vec2(dx*(offset+0.5),0.));vec4 m1=texture2D(smp,vec2(dx*(offset+1.5),0.));vec4 m2=texture2D(smp,vec2(dx*(offset+2.5),0.));vec4 m3=texture2D(smp,vec2(dx*(offset+3.5),0.));return mat4(m0,m1,m2,m3);}
#endif
#endif
#endif
`;g.IncludesShadersStore[CF]||(g.IncludesShadersStore[CF]=PQ)});var IF,DQ,wa=S(()=>{O();IF="bakedVertexAnimationDeclaration",DQ=`#ifdef BAKED_VERTEX_ANIMATION_TEXTURE
uniform float bakedVertexAnimationTime;uniform vec2 bakedVertexAnimationTextureSizeInverted;uniform vec4 bakedVertexAnimationSettings;uniform sampler2D bakedVertexAnimationTexture;
#ifdef INSTANCES
attribute vec4 bakedVertexAnimationSettingsInstanced;
#endif
#define inline
mat4 readMatrixFromRawSamplerVAT(sampler2D smp,float index,float frame)
{float offset=index*4.0;float frameUV=(frame+0.5)*bakedVertexAnimationTextureSizeInverted.y;float dx=bakedVertexAnimationTextureSizeInverted.x;vec4 m0=texture2D(smp,vec2(dx*(offset+0.5),frameUV));vec4 m1=texture2D(smp,vec2(dx*(offset+1.5),frameUV));vec4 m2=texture2D(smp,vec2(dx*(offset+2.5),frameUV));vec4 m3=texture2D(smp,vec2(dx*(offset+3.5),frameUV));return mat4(m0,m1,m2,m3);}
#endif
`;g.IncludesShadersStore[IF]||(g.IncludesShadersStore[IF]=DQ)});var yF,OQ,Bo=S(()=>{O();yF="morphTargetsVertexGlobalDeclaration",OQ=`#ifdef MORPHTARGETS
uniform float morphTargetInfluences[NUM_MORPH_INFLUENCERS];
#ifdef MORPHTARGETS_TEXTURE 
uniform float morphTargetTextureIndices[NUM_MORPH_INFLUENCERS];uniform vec3 morphTargetTextureInfo;uniform highp sampler2DArray morphTargets;vec3 readVector3FromRawSampler(int targetIndex,float vertexIndex)
{ 
float y=floor(vertexIndex/morphTargetTextureInfo.y);float x=vertexIndex-y*morphTargetTextureInfo.y;vec3 textureUV=vec3((x+0.5)/morphTargetTextureInfo.y,(y+0.5)/morphTargetTextureInfo.z,morphTargetTextureIndices[targetIndex]);return texture(morphTargets,textureUV).xyz;}
vec4 readVector4FromRawSampler(int targetIndex,float vertexIndex)
{ 
float y=floor(vertexIndex/morphTargetTextureInfo.y);float x=vertexIndex-y*morphTargetTextureInfo.y;vec3 textureUV=vec3((x+0.5)/morphTargetTextureInfo.y,(y+0.5)/morphTargetTextureInfo.z,morphTargetTextureIndices[targetIndex]);return texture(morphTargets,textureUV);}
#endif
#endif
`;g.IncludesShadersStore[yF]||(g.IncludesShadersStore[yF]=OQ)});var MF,LQ,Uo=S(()=>{O();MF="morphTargetsVertexDeclaration",LQ=`#ifdef MORPHTARGETS
#ifndef MORPHTARGETS_TEXTURE
#ifdef MORPHTARGETS_POSITION
attribute vec3 position{X};
#endif
#ifdef MORPHTARGETS_NORMAL
attribute vec3 normal{X};
#endif
#ifdef MORPHTARGETS_TANGENT
attribute vec3 tangent{X};
#endif
#ifdef MORPHTARGETS_UV
attribute vec2 uv_{X};
#endif
#ifdef MORPHTARGETS_UV2
attribute vec2 uv2_{X};
#endif
#ifdef MORPHTARGETS_COLOR
attribute vec4 color{X};
#endif
#elif {X}==0
uniform float morphTargetCount;
#endif
#endif
`;g.IncludesShadersStore[MF]||(g.IncludesShadersStore[MF]=LQ)});var PF,wQ,Di=S(()=>{O();PF="helperFunctions",wQ=`const float PI=3.1415926535897932384626433832795;const float TWO_PI=6.283185307179586;const float HALF_PI=1.5707963267948966;const float RECIPROCAL_PI=0.3183098861837907;const float RECIPROCAL_PI2=0.15915494309189535;const float RECIPROCAL_PI4=0.07957747154594767;const float HALF_MIN=5.96046448e-08; 
const float LinearEncodePowerApprox=2.2;const float GammaEncodePowerApprox=1.0/LinearEncodePowerApprox;const vec3 LuminanceEncodeApprox=vec3(0.2126,0.7152,0.0722);const float Epsilon=0.0000001;
#define saturate(x) clamp(x,0.0,1.0)
#define absEps(x) abs(x)+Epsilon
#define maxEps(x) max(x,Epsilon)
#define saturateEps(x) clamp(x,Epsilon,1.0)
mat3 transposeMat3(mat3 inMatrix) {vec3 i0=inMatrix[0];vec3 i1=inMatrix[1];vec3 i2=inMatrix[2];mat3 outMatrix=mat3(
vec3(i0.x,i1.x,i2.x),
vec3(i0.y,i1.y,i2.y),
vec3(i0.z,i1.z,i2.z)
);return outMatrix;}
mat3 inverseMat3(mat3 inMatrix) {float a00=inMatrix[0][0],a01=inMatrix[0][1],a02=inMatrix[0][2];float a10=inMatrix[1][0],a11=inMatrix[1][1],a12=inMatrix[1][2];float a20=inMatrix[2][0],a21=inMatrix[2][1],a22=inMatrix[2][2];float b01=a22*a11-a12*a21;float b11=-a22*a10+a12*a20;float b21=a21*a10-a11*a20;float det=a00*b01+a01*b11+a02*b21;return mat3(b01,(-a22*a01+a02*a21),(a12*a01-a02*a11),
b11,(a22*a00-a02*a20),(-a12*a00+a02*a10),
b21,(-a21*a00+a01*a20),(a11*a00-a01*a10))/det;}
#if USE_EXACT_SRGB_CONVERSIONS
vec3 toLinearSpaceExact(vec3 color)
{vec3 nearZeroSection=0.0773993808*color;vec3 remainingSection=pow(0.947867299*(color+vec3(0.055)),vec3(2.4));
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.04045)));
#else
return
vec3(
color.r<=0.04045 ? nearZeroSection.r : remainingSection.r,
color.g<=0.04045 ? nearZeroSection.g : remainingSection.g,
color.b<=0.04045 ? nearZeroSection.b : remainingSection.b);
#endif
}
vec3 toGammaSpaceExact(vec3 color)
{vec3 nearZeroSection=12.92*color;vec3 remainingSection=1.055*pow(color,vec3(0.41666))-vec3(0.055);
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.0031308)));
#else
return
vec3(
color.r<=0.0031308 ? nearZeroSection.r : remainingSection.r,
color.g<=0.0031308 ? nearZeroSection.g : remainingSection.g,
color.b<=0.0031308 ? nearZeroSection.b : remainingSection.b);
#endif
}
#endif
float toLinearSpace(float color)
{
#if USE_EXACT_SRGB_CONVERSIONS
float nearZeroSection=0.0773993808*color;float remainingSection=pow(0.947867299*(color+0.055),2.4);return color<=0.04045 ? nearZeroSection : remainingSection;
#else
return pow(color,LinearEncodePowerApprox);
#endif
}
vec3 toLinearSpace(vec3 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return toLinearSpaceExact(color);
#else
return pow(color,vec3(LinearEncodePowerApprox));
#endif
}
vec4 toLinearSpace(vec4 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return vec4(toLinearSpaceExact(color.rgb),color.a);
#else
return vec4(pow(color.rgb,vec3(LinearEncodePowerApprox)),color.a);
#endif
}
float toGammaSpace(float color)
{
#if USE_EXACT_SRGB_CONVERSIONS
float nearZeroSection=12.92*color;float remainingSection=1.055*pow(color,0.41666)-0.055;return color<=0.0031308 ? nearZeroSection : remainingSection;
#else
return pow(color,GammaEncodePowerApprox);
#endif
}
vec3 toGammaSpace(vec3 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return toGammaSpaceExact(color);
#else
return pow(color,vec3(GammaEncodePowerApprox));
#endif
}
vec4 toGammaSpace(vec4 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return vec4(toGammaSpaceExact(color.rgb),color.a);
#else
return vec4(pow(color.rgb,vec3(GammaEncodePowerApprox)),color.a);
#endif
}
float square(float value)
{return value*value;}
vec3 square(vec3 value)
{return value*value;}
float pow5(float value) {float sq=value*value;return sq*sq*value;}
float getLuminance(vec3 color)
{return saturate(dot(color,LuminanceEncodeApprox));}
float getRand(vec2 seed) {return fract(sin(dot(seed.xy ,vec2(12.9898,78.233)))*43758.5453);}
float dither(vec2 seed,float varianceAmount) {float rand=getRand(seed);float normVariance=varianceAmount/255.0;float dither=mix(-normVariance,normVariance,rand);return dither;}
const float rgbdMaxRange=255.;vec4 toRGBD(vec3 color) {float maxRGB=maxEps(max(color.r,max(color.g,color.b)));float D =max(rgbdMaxRange/maxRGB,1.);D =saturate(floor(D)/255.);vec3 rgb=color.rgb*D;rgb=toGammaSpace(rgb);return vec4(saturate(rgb),D);}
vec3 fromRGBD(vec4 rgbd) {rgbd.rgb=toLinearSpace(rgbd.rgb);return rgbd.rgb/rgbd.a;}
vec3 parallaxCorrectNormal( vec3 vertexPos,vec3 origVec,vec3 cubeSize,vec3 cubePos ) {vec3 invOrigVec=vec3(1.)/origVec;vec3 halfSize=cubeSize*0.5;vec3 intersecAtMaxPlane=(cubePos+halfSize-vertexPos)*invOrigVec;vec3 intersecAtMinPlane=(cubePos-halfSize-vertexPos)*invOrigVec;vec3 largestIntersec=max(intersecAtMaxPlane,intersecAtMinPlane);float distance=min(min(largestIntersec.x,largestIntersec.y),largestIntersec.z);vec3 intersectPositionWS=vertexPos+origVec*distance;return intersectPositionWS-cubePos;}
vec3 equirectangularToCubemapDirection(vec2 uv) {float longitude=uv.x*TWO_PI-PI;float latitude=HALF_PI-uv.y*PI;vec3 direction;direction.x=cos(latitude)*sin(longitude);direction.y=sin(latitude);direction.z=cos(latitude)*cos(longitude);return direction;}
float sqrtClamped(float value) {return sqrt(max(value,0.));}
float avg(vec3 value) {return dot(value,vec3(0.333333333));}
#ifdef WEBGL2
uint extractBits(uint value,int offset,int width) {return (value>>offset) & ((1u<<width)-1u);}
int onlyBitPosition(uint value) {return (floatBitsToInt(float(value))>>23)-0x7f;}
#endif
`;g.IncludesShadersStore[PF]||(g.IncludesShadersStore[PF]=wQ)});var DF,FQ,OF=S(()=>{O();DF="sceneVertexDeclaration",FQ=`uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
uniform mat4 view;uniform mat4 projection;uniform vec4 vEyePosition;
`;g.IncludesShadersStore[DF]||(g.IncludesShadersStore[DF]=FQ)});var LF,NQ,wF=S(()=>{O();LF="meshVertexDeclaration",NQ=`uniform mat4 world;uniform float visibility;
`;g.IncludesShadersStore[LF]||(g.IncludesShadersStore[LF]=NQ)});var FF,BQ,NF=S(()=>{O();OF();wF();FF="shadowMapVertexDeclaration",BQ=`#include<sceneVertexDeclaration>
#include<meshVertexDeclaration>
`;g.IncludesShadersStore[FF]||(g.IncludesShadersStore[FF]=BQ)});var BF,UQ,Ml=S(()=>{O();BF="sceneUboDeclaration",UQ=`layout(std140,column_major) uniform;uniform Scene {mat4 viewProjection;
#ifdef MULTIVIEW
mat4 viewProjectionR;
#endif 
mat4 view;mat4 projection;vec4 vEyePosition;};
`;g.IncludesShadersStore[BF]||(g.IncludesShadersStore[BF]=UQ)});var UF,GQ,qh=S(()=>{O();UF="meshUboDeclaration",GQ=`#ifdef WEBGL2
uniform mat4 world;uniform float visibility;
#else
layout(std140,column_major) uniform;uniform Mesh
{mat4 world;float visibility;};
#endif
#define WORLD_UBO
`;g.IncludesShadersStore[UF]||(g.IncludesShadersStore[UF]=GQ)});var GF,VQ,VF=S(()=>{O();Ml();qh();GF="shadowMapUboDeclaration",VQ=`layout(std140,column_major) uniform;
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;g.IncludesShadersStore[GF]||(g.IncludesShadersStore[GF]=VQ)});var kF,kQ,WF=S(()=>{O();kF="shadowMapVertexExtraDeclaration",kQ=`#if SM_NORMALBIAS==1
uniform vec3 lightDataSM;
#endif
uniform vec3 biasAndScaleSM;uniform vec2 depthValuesSM;varying float vDepthMetricSM;
#if SM_USEDISTANCE==1
varying vec3 vPositionWSM;
#endif
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
varying float zSM;
#endif
`;g.IncludesShadersStore[kF]||(g.IncludesShadersStore[kF]=kQ)});var HF,WQ,Fa=S(()=>{O();HF="clipPlaneVertexDeclaration",WQ=`#ifdef CLIPPLANE
uniform vec4 vClipPlane;varying float fClipDistance;
#endif
#ifdef CLIPPLANE2
uniform vec4 vClipPlane2;varying float fClipDistance2;
#endif
#ifdef CLIPPLANE3
uniform vec4 vClipPlane3;varying float fClipDistance3;
#endif
#ifdef CLIPPLANE4
uniform vec4 vClipPlane4;varying float fClipDistance4;
#endif
#ifdef CLIPPLANE5
uniform vec4 vClipPlane5;varying float fClipDistance5;
#endif
#ifdef CLIPPLANE6
uniform vec4 vClipPlane6;varying float fClipDistance6;
#endif
`;g.IncludesShadersStore[HF]||(g.IncludesShadersStore[HF]=WQ)});var zF,HQ,Go=S(()=>{O();zF="morphTargetsVertexGlobal",HQ=`#ifdef MORPHTARGETS
#ifdef MORPHTARGETS_TEXTURE
float vertexID;
#endif
#endif
`;g.IncludesShadersStore[zF]||(g.IncludesShadersStore[zF]=HQ)});var XF,zQ,Vo=S(()=>{O();XF="morphTargetsVertex",zQ=`#ifdef MORPHTARGETS
#ifdef MORPHTARGETS_TEXTURE
#if {X}==0
for (int i=0; i<NUM_MORPH_INFLUENCERS; i++) {if (float(i)>=morphTargetCount) break;vertexID=float(gl_VertexID)*morphTargetTextureInfo.x;
#ifdef MORPHTARGETS_POSITION
positionUpdated+=(readVector3FromRawSampler(i,vertexID)-position)*morphTargetInfluences[i];
#endif
#ifdef MORPHTARGETTEXTURE_HASPOSITIONS
vertexID+=1.0;
#endif
#ifdef MORPHTARGETS_NORMAL
normalUpdated+=(readVector3FromRawSampler(i,vertexID) -normal)*morphTargetInfluences[i];
#endif
#ifdef MORPHTARGETTEXTURE_HASNORMALS
vertexID+=1.0;
#endif
#ifdef MORPHTARGETS_UV
uvUpdated+=(readVector3FromRawSampler(i,vertexID).xy-uv)*morphTargetInfluences[i];
#endif
#ifdef MORPHTARGETTEXTURE_HASUVS
vertexID+=1.0;
#endif
#ifdef MORPHTARGETS_TANGENT
tangentUpdated.xyz+=(readVector3FromRawSampler(i,vertexID) -tangent.xyz)*morphTargetInfluences[i];
#endif
#ifdef MORPHTARGETTEXTURE_HASTANGENTS
vertexID+=1.0;
#endif
#ifdef MORPHTARGETS_UV2
uv2Updated+=(readVector3FromRawSampler(i,vertexID).xy-uv2)*morphTargetInfluences[i];
#endif
#ifdef MORPHTARGETTEXTURE_HASUV2S
vertexID+=1.0;
#endif
#ifdef MORPHTARGETS_COLOR
colorUpdated+=(readVector4FromRawSampler(i,vertexID)-color)*morphTargetInfluences[i];
#endif
}
#endif
#else
#ifdef MORPHTARGETS_POSITION
positionUpdated+=(position{X}-position)*morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_NORMAL
normalUpdated+=(normal{X}-normal)*morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_TANGENT
tangentUpdated.xyz+=(tangent{X}-tangent.xyz)*morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_UV
uvUpdated+=(uv_{X}-uv)*morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_UV2
uv2Updated+=(uv2_{X}-uv2)*morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_COLOR
colorUpdated+=(color{X}-color)*morphTargetInfluences[{X}];
#endif
#endif
#endif
`;g.IncludesShadersStore[XF]||(g.IncludesShadersStore[XF]=zQ)});var YF,XQ,Na=S(()=>{O();YF="instancesVertex",XQ=`#ifdef INSTANCES
mat4 finalWorld=mat4(world0,world1,world2,world3);
#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)
mat4 finalPreviousWorld=mat4(previousWorld0,previousWorld1,
previousWorld2,previousWorld3);
#endif
#ifdef THIN_INSTANCES
finalWorld=world*finalWorld;
#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)
finalPreviousWorld=previousWorld*finalPreviousWorld;
#endif
#endif
#else
mat4 finalWorld=world;
#if defined(PREPASS_VELOCITY) || defined(VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)
mat4 finalPreviousWorld=previousWorld;
#endif
#endif
`;g.IncludesShadersStore[YF]||(g.IncludesShadersStore[YF]=XQ)});var KF,YQ,Ba=S(()=>{O();KF="bonesVertex",YQ=`#ifndef BAKED_VERTEX_ANIMATION_TEXTURE
#if NUM_BONE_INFLUENCERS>0
mat4 influence;
#ifdef BONETEXTURE
influence=readMatrixFromRawSampler(boneSampler,matricesIndices[0])*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence+=readMatrixFromRawSampler(boneSampler,matricesIndices[1])*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
influence+=readMatrixFromRawSampler(boneSampler,matricesIndices[2])*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
influence+=readMatrixFromRawSampler(boneSampler,matricesIndices[3])*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[0])*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[1])*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[2])*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[3])*matricesWeightsExtra[3];
#endif
#else
influence=mBones[int(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence+=mBones[int(matricesIndices[1])]*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
influence+=mBones[int(matricesIndices[2])]*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
influence+=mBones[int(matricesIndices[3])]*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
influence+=mBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
influence+=mBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
influence+=mBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
influence+=mBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif
#endif
finalWorld=finalWorld*influence;
#endif
#endif
`;g.IncludesShadersStore[KF]||(g.IncludesShadersStore[KF]=YQ)});var qF,KQ,Ua=S(()=>{O();qF="bakedVertexAnimation",KQ=`#ifdef BAKED_VERTEX_ANIMATION_TEXTURE
{
#ifdef INSTANCES
#define BVASNAME bakedVertexAnimationSettingsInstanced
#else
#define BVASNAME bakedVertexAnimationSettings
#endif
float VATStartFrame=BVASNAME.x;float VATEndFrame=BVASNAME.y;float VATOffsetFrame=BVASNAME.z;float VATSpeed=BVASNAME.w;float totalFrames=VATEndFrame-VATStartFrame+1.0;float time=bakedVertexAnimationTime*VATSpeed/totalFrames;float frameCorrection=time<1.0 ? 0.0 : 1.0;float numOfFrames=totalFrames-frameCorrection;float VATFrameNum=fract(time)*numOfFrames;VATFrameNum=mod(VATFrameNum+VATOffsetFrame,numOfFrames);VATFrameNum=floor(VATFrameNum);VATFrameNum+=VATStartFrame+frameCorrection;mat4 VATInfluence;VATInfluence=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[0],VATFrameNum)*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[1],VATFrameNum)*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[2],VATFrameNum)*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[3],VATFrameNum)*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[0],VATFrameNum)*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[1],VATFrameNum)*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[2],VATFrameNum)*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[3],VATFrameNum)*matricesWeightsExtra[3];
#endif
finalWorld=finalWorld*VATInfluence;}
#endif
`;g.IncludesShadersStore[qF]||(g.IncludesShadersStore[qF]=KQ)});var QF,qQ,jF=S(()=>{O();QF="shadowMapVertexNormalBias",qQ=`#if SM_NORMALBIAS==1
#if SM_DIRECTIONINLIGHTDATA==1
vec3 worldLightDirSM=normalize(-lightDataSM.xyz);
#else
vec3 directionToLightSM=lightDataSM.xyz-worldPos.xyz;vec3 worldLightDirSM=normalize(directionToLightSM);
#endif
float ndlSM=dot(vNormalW,worldLightDirSM);float sinNLSM=sqrt(1.0-ndlSM*ndlSM);float normalBiasSM=biasAndScaleSM.y*sinNLSM;worldPos.xyz-=vNormalW*normalBiasSM;
#endif
`;g.IncludesShadersStore[QF]||(g.IncludesShadersStore[QF]=qQ)});var ZF,QQ,JF=S(()=>{O();ZF="shadowMapVertexMetric",QQ=`#if SM_USEDISTANCE==1
vPositionWSM=worldPos.xyz;
#endif
#if SM_DEPTHTEXTURE==1
#ifdef IS_NDC_HALF_ZRANGE
#define BIASFACTOR 0.5
#else
#define BIASFACTOR 1.0
#endif
#ifdef USE_REVERSE_DEPTHBUFFER
gl_Position.z-=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;
#else
gl_Position.z+=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;
#endif
#endif
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
zSM=gl_Position.z;gl_Position.z=0.0;
#elif SM_USEDISTANCE==0
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetricSM=(-gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#else
vDepthMetricSM=(gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#endif
#endif
`;g.IncludesShadersStore[ZF]||(g.IncludesShadersStore[ZF]=QQ)});var $F,jQ,Ga=S(()=>{O();$F="clipPlaneVertex",jQ=`#ifdef CLIPPLANE
fClipDistance=dot(worldPos,vClipPlane);
#endif
#ifdef CLIPPLANE2
fClipDistance2=dot(worldPos,vClipPlane2);
#endif
#ifdef CLIPPLANE3
fClipDistance3=dot(worldPos,vClipPlane3);
#endif
#ifdef CLIPPLANE4
fClipDistance4=dot(worldPos,vClipPlane4);
#endif
#ifdef CLIPPLANE5
fClipDistance5=dot(worldPos,vClipPlane5);
#endif
#ifdef CLIPPLANE6
fClipDistance6=dot(worldPos,vClipPlane6);
#endif
`;g.IncludesShadersStore[$F]||(g.IncludesShadersStore[$F]=jQ)});var tN={};V(tN,{shadowMapVertexShader:()=>ZQ});var eb,eN,ZQ,iN=S(()=>{O();La();wa();Bo();Uo();Di();NF();VF();WF();Fa();Go();Vo();Na();Ba();Ua();jF();JF();Ga();eb="shadowMapVertexShader",eN=`attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef INSTANCES
attribute vec4 world0;attribute vec4 world1;attribute vec4 world2;attribute vec4 world3;
#endif
#include<helperFunctions>
#include<__decl__shadowMapVertex>
#ifdef ALPHATEXTURE
varying vec2 vUV;uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#include<shadowMapVertexExtraDeclaration>
#include<clipPlaneVertexDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{vec3 positionUpdated=position;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#ifdef UV2
vec2 uv2Updated=uv2;
#endif
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#ifdef NORMAL
mat3 normWorldSM=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vec3 vNormalW=normalUpdated/vec3(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));vNormalW=normalize(normWorldSM*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normWorldSM=transposeMat3(inverseMat3(normWorldSM));
#endif
vec3 vNormalW=normalize(normWorldSM*normalUpdated);
#endif
#endif
#include<shadowMapVertexNormalBias>
gl_Position=viewProjection*worldPos;
#include<shadowMapVertexMetric>
#ifdef ALPHATEXTURE
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2Updated,1.0,0.0));
#endif
#endif
#include<clipPlaneVertex>
}`;g.ShadersStore[eb]||(g.ShadersStore[eb]=eN);ZQ={name:eb,shader:eN}});var sN={};V(sN,{depthBoxBlurPixelShader:()=>JQ});var tb,rN,JQ,nN=S(()=>{O();tb="depthBoxBlurPixelShader",rN=`varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 screenSize;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{vec4 colorDepth=vec4(0.0);for (int x=-OFFSET; x<=OFFSET; x++)
for (int y=-OFFSET; y<=OFFSET; y++)
colorDepth+=texture2D(textureSampler,vUV+vec2(x,y)/screenSize);gl_FragColor=(colorDepth/float((OFFSET*2+1)*(OFFSET*2+1)));}`;g.ShadersStore[tb]||(g.ShadersStore[tb]=rN);JQ={name:tb,shader:rN}});var oN={};V(oN,{shadowMapFragmentSoftTransparentShadow:()=>$Q});var ib,aN,$Q,lN=S(()=>{O();ib="shadowMapFragmentSoftTransparentShadow",aN=`#if SM_SOFTTRANSPARENTSHADOW==1
if ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM.x*alpha) discard;
#endif
`;g.IncludesShadersStore[ib]||(g.IncludesShadersStore[ib]=aN);$Q={name:ib,shader:aN}});var cN={};V(cN,{ShadowGenerator:()=>vt});var vt,Qh=S(()=>{ie();it();yt();Dn();Ut();Mn();Wr();Cw();we();Ii();bo();zp();El();rn();Xi();vt=class s{get bias(){return this._bias}set bias(e){this._bias=e}get normalBias(){return this._normalBias}set normalBias(e){this._normalBias=e}get blurBoxOffset(){return this._blurBoxOffset}set blurBoxOffset(e){this._blurBoxOffset!==e&&(this._blurBoxOffset=e,this._disposeBlurPostProcesses())}get blurScale(){return this._blurScale}set blurScale(e){this._blurScale!==e&&(this._blurScale=e,this._disposeBlurPostProcesses())}get blurKernel(){return this._blurKernel}set blurKernel(e){this._blurKernel!==e&&(this._blurKernel=e,this._disposeBlurPostProcesses())}get useKernelBlur(){return this._useKernelBlur}set useKernelBlur(e){this._useKernelBlur!==e&&(this._useKernelBlur=e,this._disposeBlurPostProcesses())}get depthScale(){return this._depthScale!==void 0?this._depthScale:this._light.getDepthScale()}set depthScale(e){this._depthScale=e}_validateFilter(e){return e}get filter(){return this._filter}set filter(e){if(e=this._validateFilter(e),this._light.needCube()){if(e===s.FILTER_BLUREXPONENTIALSHADOWMAP){this.useExponentialShadowMap=!0;return}else if(e===s.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP){this.useCloseExponentialShadowMap=!0;return}else if(e===s.FILTER_PCF||e===s.FILTER_PCSS){this.usePoissonSampling=!0;return}}if((e===s.FILTER_PCF||e===s.FILTER_PCSS)&&!this._scene.getEngine()._features.supportShadowSamplers){this.usePoissonSampling=!0;return}this._filter!==e&&(this._filter=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())}get usePoissonSampling(){return this.filter===s.FILTER_POISSONSAMPLING}set usePoissonSampling(e){let t=this._validateFilter(s.FILTER_POISSONSAMPLING);!e&&this.filter!==s.FILTER_POISSONSAMPLING||(this.filter=e?t:s.FILTER_NONE)}get useExponentialShadowMap(){return this.filter===s.FILTER_EXPONENTIALSHADOWMAP}set useExponentialShadowMap(e){let t=this._validateFilter(s.FILTER_EXPONENTIALSHADOWMAP);!e&&this.filter!==s.FILTER_EXPONENTIALSHADOWMAP||(this.filter=e?t:s.FILTER_NONE)}get useBlurExponentialShadowMap(){return this.filter===s.FILTER_BLUREXPONENTIALSHADOWMAP}set useBlurExponentialShadowMap(e){let t=this._validateFilter(s.FILTER_BLUREXPONENTIALSHADOWMAP);!e&&this.filter!==s.FILTER_BLUREXPONENTIALSHADOWMAP||(this.filter=e?t:s.FILTER_NONE)}get useCloseExponentialShadowMap(){return this.filter===s.FILTER_CLOSEEXPONENTIALSHADOWMAP}set useCloseExponentialShadowMap(e){let t=this._validateFilter(s.FILTER_CLOSEEXPONENTIALSHADOWMAP);!e&&this.filter!==s.FILTER_CLOSEEXPONENTIALSHADOWMAP||(this.filter=e?t:s.FILTER_NONE)}get useBlurCloseExponentialShadowMap(){return this.filter===s.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP}set useBlurCloseExponentialShadowMap(e){let t=this._validateFilter(s.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP);!e&&this.filter!==s.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP||(this.filter=e?t:s.FILTER_NONE)}get usePercentageCloserFiltering(){return this.filter===s.FILTER_PCF}set usePercentageCloserFiltering(e){let t=this._validateFilter(s.FILTER_PCF);!e&&this.filter!==s.FILTER_PCF||(this.filter=e?t:s.FILTER_NONE)}get filteringQuality(){return this._filteringQuality}set filteringQuality(e){this._filteringQuality!==e&&(this._filteringQuality=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())}get useContactHardeningShadow(){return this.filter===s.FILTER_PCSS}set useContactHardeningShadow(e){let t=this._validateFilter(s.FILTER_PCSS);!e&&this.filter!==s.FILTER_PCSS||(this.filter=e?t:s.FILTER_NONE)}get contactHardeningLightSizeUVRatio(){return this._contactHardeningLightSizeUVRatio}set contactHardeningLightSizeUVRatio(e){this._contactHardeningLightSizeUVRatio=e}get darkness(){return this._darkness}set darkness(e){this.setDarkness(e)}getDarkness(){return this._darkness}setDarkness(e){return e>=1?this._darkness=1:e<=0?this._darkness=0:this._darkness=e,this}get transparencyShadow(){return this._transparencyShadow}set transparencyShadow(e){this.setTransparencyShadow(e)}setTransparencyShadow(e){return this._transparencyShadow=e,this}getShadowMap(){return this._shadowMap}getShadowMapForRendering(){return this._shadowMap2?this._shadowMap2:this._shadowMap}getClassName(){return s.CLASSNAME}addShadowCaster(e,t=!0){if(!this._shadowMap)return this;if(this._shadowMap.renderList||(this._shadowMap.renderList=[]),this._shadowMap.renderList.indexOf(e)===-1&&this._shadowMap.renderList.push(e),t)for(let i of e.getChildMeshes())this._shadowMap.renderList.indexOf(i)===-1&&this._shadowMap.renderList.push(i);return this}removeShadowCaster(e,t=!0){if(!this._shadowMap||!this._shadowMap.renderList)return this;let i=this._shadowMap.renderList.indexOf(e);if(i!==-1&&this._shadowMap.renderList.splice(i,1),t)for(let r of e.getChildren())this.removeShadowCaster(r);return this}getLight(){return this._light}get shaderLanguage(){return this._shaderLanguage}_getCamera(){return this._camera??this._scene.activeCamera}get mapSize(){return this._mapSize}set mapSize(e){this._mapSize=e,this._light._markMeshesAsLightDirty(),this.recreateShadowMap()}constructor(e,t,i,r,n,a=!1){this.onBeforeShadowMapRenderObservable=new N,this.onAfterShadowMapRenderObservable=new N,this.onBeforeShadowMapRenderMeshObservable=new N,this.onAfterShadowMapRenderMeshObservable=new N,this.doNotSerialize=!1,this._bias=5e-5,this._normalBias=0,this._blurBoxOffset=1,this._blurScale=2,this._blurKernel=1,this._useKernelBlur=!1,this._filter=s.FILTER_NONE,this._filteringQuality=s.QUALITY_HIGH,this._contactHardeningLightSizeUVRatio=.1,this._darkness=0,this._transparencyShadow=!1,this.enableSoftTransparentShadow=!1,this.useOpacityTextureForTransparentShadow=!1,this.frustumEdgeFalloff=0,this._shaderLanguage=0,this.forceBackFacesOnly=!1,this._lightDirection=E.Zero(),this._viewMatrix=B.Zero(),this._projectionMatrix=B.Zero(),this._transformMatrix=B.Zero(),this._cachedPosition=new E(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cachedDirection=new E(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._currentFaceIndex=0,this._currentFaceIndexCache=0,this._defaultTextureMatrix=B.Identity(),this._shadersLoaded=!1,this._mapSize=e,this._light=t,this._scene=t.getScene(),this._camera=r??null,this._useRedTextureType=!!n,this._initShaderSourceAsync(a);let o=t._shadowGenerators;o||(o=t._shadowGenerators=new Map),o.set(this._camera,this),this.id=t.id,this._useUBO=this._scene.getEngine().supportsUniformBuffers,this._useUBO&&(this._sceneUBOs=[],this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for Shadow Generator (light "${this._light.name}")`))),s._SceneComponentInitialization(this._scene);let l=this._scene.getEngine().getCaps();i?l.textureFloatRender&&l.textureFloatLinearFiltering?this._textureType=1:l.textureHalfFloatRender&&l.textureHalfFloatLinearFiltering?this._textureType=2:this._textureType=0:l.textureHalfFloatRender&&l.textureHalfFloatLinearFiltering?this._textureType=2:l.textureFloatRender&&l.textureFloatLinearFiltering?this._textureType=1:this._textureType=0,this._initializeGenerator(),this._applyFilterValues()}_initializeGenerator(){this._light._markMeshesAsLightDirty(),this._initializeShadowMap()}_createTargetRenderTexture(){let e=this._scene.getEngine();this._shadowMap?.dispose(),e._features.supportDepthStencilTexture?(this._shadowMap=new Gt(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube(),void 0,!1,!1,void 0,this._useRedTextureType?6:5),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0,void 0,void 0,void 0,`DepthStencilForShadowGenerator-${this._light.name}`)):this._shadowMap=new Gt(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube()),this._shadowMap.noPrePassRenderer=!0}_initializeShadowMap(){if(this._createTargetRenderTexture(),this._shadowMap===null)return;this._shadowMap.wrapU=H.CLAMP_ADDRESSMODE,this._shadowMap.wrapV=H.CLAMP_ADDRESSMODE,this._shadowMap.anisotropicFilteringLevel=1,this._shadowMap.updateSamplingMode(H.BILINEAR_SAMPLINGMODE),this._shadowMap.renderParticles=!1,this._shadowMap.ignoreCameraViewport=!0,this._storedUniqueId&&(this._shadowMap.uniqueId=this._storedUniqueId),this._shadowMap.customRenderFunction=(r,n,a,o)=>this._renderForShadowMap(r,n,a,o),this._shadowMap.customIsReadyFunction=(r,n,a)=>{if(!a||!r.subMeshes)return!0;let o=!0;for(let l of r.subMeshes){let c=l.getRenderingMesh(),h=this._scene.getEngine(),u=l.getMaterial();if(!u||l.verticesCount===0||this.customAllowRendering&&!this.customAllowRendering(l))continue;let d=c._getInstancesRenderList(l._id,!!l.getReplacementMesh());if(d.mustReturn)continue;let p=h.getCaps().instancedArrays&&(d.visibleInstances[l._id]!==null&&d.visibleInstances[l._id]!==void 0||c.hasThinInstances),m=u.needAlphaBlendingForMesh(c);o=this.isReady(l,p,m)&&o}return o};let e=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.add(()=>{this._currentSceneUBO=this._scene.getSceneUniformBuffer(),e._debugPushGroup?.(`shadow map generation for pass id ${e.currentRenderPassId}`,1)}),this._shadowMap.onBeforeRenderObservable.add(r=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[0]),this._currentFaceIndex=r,this._filter===s.FILTER_PCF&&e.setColorWrite(!1),this.getTransformMatrix(),this._scene.setTransformMatrix(this._viewMatrix,this._projectionMatrix),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())}),this._shadowMap.onAfterUnbindObservable.add(()=>{if(this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._currentSceneUBO),this._scene.updateTransformMatrix(),this._filter===s.FILTER_PCF&&e.setColorWrite(!0),!this.useBlurExponentialShadowMap&&!this.useBlurCloseExponentialShadowMap){e._debugPopGroup?.(1);return}let r=this.getShadowMapForRendering();r&&(this._scene.postProcessManager.directRender(this._blurPostProcesses,r.renderTarget,!0),e.unBindFramebuffer(r.renderTarget,!0)),e._debugPopGroup?.(1)});let t=new me(0,0,0,0),i=new me(1,1,1,1);this._shadowMap.onClearObservable.add(r=>{this._filter===s.FILTER_PCF?r.clear(i,!1,!0,!1):this.useExponentialShadowMap||this.useBlurExponentialShadowMap?r.clear(t,!0,!0,!1):r.clear(i,!0,!0,!1)}),this._shadowMap.onResizeObservable.add(r=>{this._storedUniqueId=this._shadowMap.uniqueId,this._mapSize=r.getRenderSize(),this._light._markMeshesAsLightDirty(),this.recreateShadowMap()});for(let r=Ps.MIN_RENDERINGGROUPS;r<Ps.MAX_RENDERINGGROUPS;r++)this._shadowMap.setRenderingAutoClearDepthStencil(r,!1)}async _initShaderSourceAsync(e=!1){this._scene.getEngine().isWebGPU&&!e&&!s.ForceGLSL?(this._shaderLanguage=1,await Promise.all([Promise.resolve().then(()=>(Gw(),Uw)),Promise.resolve().then(()=>(lF(),oF)),Promise.resolve().then(()=>(hF(),fF)),Promise.resolve().then(()=>(pF(),dF))])):await Promise.all([Promise.resolve().then(()=>(bF(),RF)),Promise.resolve().then(()=>(iN(),tN)),Promise.resolve().then(()=>(nN(),sN)),Promise.resolve().then(()=>(lN(),oN))]),this._shadersLoaded=!0}_initializeBlurRTTAndPostProcesses(){let e=this._scene.getEngine(),t=this._mapSize/this.blurScale;(!this.useKernelBlur||this.blurScale!==1)&&(this._shadowMap2=new Gt(this._light.name+"_shadowMap2",t,this._scene,!1,!0,this._textureType,void 0,void 0,!1),this._shadowMap2.wrapU=H.CLAMP_ADDRESSMODE,this._shadowMap2.wrapV=H.CLAMP_ADDRESSMODE,this._shadowMap2.updateSamplingMode(H.BILINEAR_SAMPLINGMODE)),this.useKernelBlur?(this._kernelBlurXPostprocess=new Ra(this._light.name+"KernelBlurX",new he(1,0),this.blurKernel,1,null,H.BILINEAR_SAMPLINGMODE,e,!1,this._textureType),this._kernelBlurXPostprocess.width=t,this._kernelBlurXPostprocess.height=t,this._kernelBlurXPostprocess.externalTextureSamplerBinding=!0,this._kernelBlurXPostprocess.onApplyObservable.add(i=>{i.setTexture("textureSampler",this._shadowMap)}),this._kernelBlurYPostprocess=new Ra(this._light.name+"KernelBlurY",new he(0,1),this.blurKernel,1,null,H.BILINEAR_SAMPLINGMODE,e,!1,this._textureType),this._kernelBlurXPostprocess.autoClear=!1,this._kernelBlurYPostprocess.autoClear=!1,this._textureType===0&&(this._kernelBlurXPostprocess.packedFloat=!0,this._kernelBlurYPostprocess.packedFloat=!0),this._blurPostProcesses=[this._kernelBlurXPostprocess,this._kernelBlurYPostprocess]):(this._boxBlurPostprocess=new at(this._light.name+"DepthBoxBlur","depthBoxBlur",["screenSize","boxOffset"],[],1,null,H.BILINEAR_SAMPLINGMODE,e,!1,"#define OFFSET "+this._blurBoxOffset,this._textureType,void 0,void 0,void 0,void 0,this._shaderLanguage),this._boxBlurPostprocess.externalTextureSamplerBinding=!0,this._boxBlurPostprocess.onApplyObservable.add(i=>{i.setFloat2("screenSize",t,t),i.setTexture("textureSampler",this._shadowMap)}),this._boxBlurPostprocess.autoClear=!1,this._blurPostProcesses=[this._boxBlurPostprocess])}_renderForShadowMap(e,t,i,r){let n;if(r.length)for(n=0;n<r.length;n++)this._renderSubMeshForShadowMap(r.data[n]);for(n=0;n<e.length;n++)this._renderSubMeshForShadowMap(e.data[n]);for(n=0;n<t.length;n++)this._renderSubMeshForShadowMap(t.data[n]);if(this._transparencyShadow)for(n=0;n<i.length;n++)this._renderSubMeshForShadowMap(i.data[n],!0);else for(n=0;n<i.length;n++)i.data[n].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}_bindCustomEffectForRenderSubMeshForShadowMap(e,t,i){t.setMatrix("viewProjection",this.getTransformMatrix())}_renderSubMeshForShadowMap(e,t=!1){let i=e.getRenderingMesh(),r=e.getEffectiveMesh(),n=this._scene,a=n.getEngine(),o=e.getMaterial();if(r._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!o||e.verticesCount===0||e._renderId===n.getRenderId())return;let l=n.useRightHandedSystem,c=r._getWorldMatrixDeterminant()<0,f=o._getEffectiveOrientation(i);(c&&!l||!c&&l)&&(f=f===0?1:0);let h=f===0;a.setState(o.backFaceCulling,void 0,void 0,h,o.cullBackFaces);let u=i._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(u.mustReturn)return;let d=a.getCaps().instancedArrays&&(u.visibleInstances[e._id]!==null&&u.visibleInstances[e._id]!==void 0||i.hasThinInstances);if(!(this.customAllowRendering&&!this.customAllowRendering(e)))if(this.isReady(e,d,t)){e._renderId=n.getRenderId();let p=o.shadowDepthWrapper,m=p?.getEffect(e,this,a.currentRenderPassId)??e._getDrawWrapper(),_=Vr.GetEffect(m);a.enableEffect(m),d||i._bind(e,_,o.fillMode),this.getTransformMatrix(),_.setFloat3("biasAndScaleSM",this.bias,this.normalBias,this.depthScale),this.getLight().getTypeID()===Ke.LIGHTTYPEID_DIRECTIONALLIGHT?_.setVector3("lightDataSM",this._cachedDirection):_.setVector3("lightDataSM",this._cachedPosition);let v=this._getCamera();if(_.setFloat2("depthValuesSM",this.getLight().getDepthMinZ(v),this.getLight().getDepthMinZ(v)+this.getLight().getDepthMaxZ(v)),t&&this.enableSoftTransparentShadow&&_.setFloat2("softTransparentShadowSM",r.visibility*o.alpha,this._opacityTexture?.getAlphaFromRGB?1:0),p)e._setMainDrawWrapperOverride(m),p.standalone?p.baseMaterial.bindForSubMesh(r.getWorldMatrix(),i,e):o.bindForSubMesh(r.getWorldMatrix(),i,e),e._setMainDrawWrapperOverride(null);else{if(this._opacityTexture&&(_.setTexture("diffuseSampler",this._opacityTexture),_.setMatrix("diffuseMatrix",this._opacityTexture.getTextureMatrix()||this._defaultTextureMatrix)),i.useBones&&i.computeBonesUsingShaders&&i.skeleton){let I=i.skeleton;if(I.isUsingTextureForMatrices){let R=I.getTransformMatrixTexture(i);if(!R)return;_.setTexture("boneSampler",R),_.setFloat("boneTextureWidth",4*(I.bones.length+1))}else _.setMatrices("mBones",I.getTransformMatrices(i))}lr(i,_),i.morphTargetManager&&i.morphTargetManager.isUsingTextureForTargets&&i.morphTargetManager._bind(_);let C=e.getMesh().bakedVertexAnimationManager;C&&C.isEnabled&&C.bind(_,d),zi(_,o,n)}!this._useUBO&&!p&&this._bindCustomEffectForRenderSubMeshForShadowMap(e,_,r),Co(_,this._scene.getSceneUniformBuffer()),this._scene.getSceneUniformBuffer().bindUniformBuffer();let T=r.getWorldMatrix();d&&(r.getMeshUniformBuffer().bindToEffect(_,"Mesh"),r.transferToEffect(T)),this.forceBackFacesOnly&&a.setState(!0,0,!1,!0,o.cullBackFaces),this.onBeforeShadowMapRenderMeshObservable.notifyObservers(i),this.onBeforeShadowMapRenderObservable.notifyObservers(_),i._processRendering(r,e,_,o.fillMode,u,d,(C,I)=>{r!==i&&!C?(i.getMeshUniformBuffer().bindToEffect(_,"Mesh"),i.transferToEffect(I)):(r.getMeshUniformBuffer().bindToEffect(_,"Mesh"),r.transferToEffect(C?I:T))}),this.forceBackFacesOnly&&a.setState(!0,0,!1,!1,o.cullBackFaces),this.onAfterShadowMapRenderObservable.notifyObservers(_),this.onAfterShadowMapRenderMeshObservable.notifyObservers(i)}else this._shadowMap&&this._shadowMap.resetRefreshCounter()}_applyFilterValues(){this._shadowMap&&(this.filter===s.FILTER_NONE||this.filter===s.FILTER_PCSS?this._shadowMap.updateSamplingMode(H.NEAREST_SAMPLINGMODE):this._shadowMap.updateSamplingMode(H.BILINEAR_SAMPLINGMODE))}forceCompilation(e,t){let i={useInstances:!1,...t},r=this.getShadowMap();if(!r){e&&e(this);return}let n=r.renderList;if(!n){e&&e(this);return}let a=[];for(let c of n)a.push(...c.subMeshes);if(a.length===0){e&&e(this);return}let o=0,l=()=>{if(!(!this._scene||!this._scene.getEngine())){for(;this.isReady(a[o],i.useInstances,a[o].getMaterial()?.needAlphaBlendingForMesh(a[o].getMesh())??!1);)if(o++,o>=a.length){e&&e(this);return}setTimeout(l,16)}};l()}async forceCompilationAsync(e){return await new Promise(t=>{this.forceCompilation(()=>{t()},e)})}_isReadyCustomDefines(e,t,i){}_prepareShadowDefines(e,t,i,r){i.push("#define SM_LIGHTTYPE_"+this._light.getClassName().toUpperCase()),i.push("#define SM_FLOAT "+(this._textureType!==0?"1":"0")),i.push("#define SM_ESM "+(this.useExponentialShadowMap||this.useBlurExponentialShadowMap?"1":"0")),i.push("#define SM_DEPTHTEXTURE "+(this.usePercentageCloserFiltering||this.useContactHardeningShadow?"1":"0"));let n=e.getMesh();return i.push("#define SM_NORMALBIAS "+(this.normalBias&&n.isVerticesDataPresent(A.NormalKind)?"1":"0")),i.push("#define SM_DIRECTIONINLIGHTDATA "+(this.getLight().getTypeID()===Ke.LIGHTTYPEID_DIRECTIONALLIGHT?"1":"0")),i.push("#define SM_USEDISTANCE "+(this._light.needCube()?"1":"0")),i.push("#define SM_SOFTTRANSPARENTSHADOW "+(this.enableSoftTransparentShadow&&r?"1":"0")),this._isReadyCustomDefines(i,e,t),i}isReady(e,t,i){if(!this._shadersLoaded)return!1;let r=e.getMaterial(),n=r?.shadowDepthWrapper;if(this._opacityTexture=null,!r)return!1;let a=[];if(this._prepareShadowDefines(e,t,a,i),n){if(!n.isReadyForSubMesh(e,a,this,t,this._scene.getEngine().currentRenderPassId))return!1}else{let o=e._getDrawWrapper(void 0,!0),l=o.effect,c=o.defines,f=[A.PositionKind],h=e.getMesh(),u=!1,d=!1,p=!1,m=!1;this.normalBias&&h.isVerticesDataPresent(A.NormalKind)&&(f.push(A.NormalKind),a.push("#define NORMAL"),u=!0,h.nonUniformScaling&&a.push("#define NONUNIFORMSCALING"));let _=r.needAlphaTestingForMesh(h);if((_||r.needAlphaBlendingForMesh(h))&&(this.useOpacityTextureForTransparentShadow?this._opacityTexture=r.opacityTexture:this._opacityTexture=r.getAlphaTestTexture(),this._opacityTexture)){if(!this._opacityTexture.isReady())return!1;let R=r.alphaCutOff??s.DEFAULT_ALPHA_CUTOFF;a.push("#define ALPHATEXTURE"),_&&a.push(`#define ALPHATESTVALUE ${R}${R%1===0?".":""}`),h.isVerticesDataPresent(A.UVKind)&&(f.push(A.UVKind),a.push("#define UV1"),d=!0),h.isVerticesDataPresent(A.UV2Kind)&&this._opacityTexture.coordinatesIndex===1&&(f.push(A.UV2Kind),a.push("#define UV2"),p=!0)}let v=new or;if(h.useBones&&h.computeBonesUsingShaders&&h.skeleton){f.push(A.MatricesIndicesKind),f.push(A.MatricesWeightsKind),h.numBoneInfluencers>4&&(f.push(A.MatricesIndicesExtraKind),f.push(A.MatricesWeightsExtraKind));let R=h.skeleton;a.push("#define NUM_BONE_INFLUENCERS "+h.numBoneInfluencers),h.numBoneInfluencers>0&&v.addCPUSkinningFallback(0,h),R.isUsingTextureForMatrices?a.push("#define BONETEXTURE"):a.push("#define BonesPerMesh "+(R.bones.length+1))}else a.push("#define NUM_BONE_INFLUENCERS 0");let T=h.morphTargetManager?Fn(h.morphTargetManager,a,f,h,!0,u,!1,d,p,m):0;if(On(r,this._scene,a),t&&(a.push("#define INSTANCES"),sn(f),e.getRenderingMesh().hasThinInstances&&a.push("#define THIN_INSTANCES")),this.customShaderOptions&&this.customShaderOptions.defines)for(let R of this.customShaderOptions.defines)a.indexOf(R)===-1&&a.push(R);let C=h.bakedVertexAnimationManager;C&&C.isEnabled&&(a.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),t&&f.push("bakedVertexAnimationSettingsInstanced"));let I=a.join(`
`);if(c!==I){c=I;let R="shadowMap",b=["world","mBones","viewProjection","diffuseMatrix","lightDataSM","depthValuesSM","biasAndScaleSM","morphTargetInfluences","morphTargetCount","boneTextureWidth","softTransparentShadowSM","morphTargetTextureInfo","morphTargetTextureIndices","bakedVertexAnimationSettings","bakedVertexAnimationTextureSizeInverted","bakedVertexAnimationTime","bakedVertexAnimationTexture"],M=["diffuseSampler","boneSampler","morphTargets","bakedVertexAnimationTexture"],F=["Scene","Mesh"];if(Hi(b),this.customShaderOptions){if(R=this.customShaderOptions.shaderName,this.customShaderOptions.attributes)for(let D of this.customShaderOptions.attributes)f.indexOf(D)===-1&&f.push(D);if(this.customShaderOptions.uniforms)for(let D of this.customShaderOptions.uniforms)b.indexOf(D)===-1&&b.push(D);if(this.customShaderOptions.samplers)for(let D of this.customShaderOptions.samplers)M.indexOf(D)===-1&&M.push(D)}let U=this._scene.getEngine();l=U.createEffect(R,{attributes:f,uniformsNames:b,uniformBuffersNames:F,samplers:M,defines:I,fallbacks:v,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:T},shaderLanguage:this._shaderLanguage},U),o.setEffect(l,c)}if(!l.isReady())return!1}return(this.useBlurExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(!this._blurPostProcesses||!this._blurPostProcesses.length)&&this._initializeBlurRTTAndPostProcesses(),!(this._kernelBlurXPostprocess&&!this._kernelBlurXPostprocess.isReady()||this._kernelBlurYPostprocess&&!this._kernelBlurYPostprocess.isReady()||this._boxBlurPostprocess&&!this._boxBlurPostprocess.isReady())}prepareDefines(e,t){let i=this._scene,r=this._light;!i.shadowsEnabled||!r.shadowEnabled||(e["SHADOW"+t]=!0,this.useContactHardeningShadow?(e["SHADOWPCSS"+t]=!0,this._filteringQuality===s.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=!0:this._filteringQuality===s.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=!0)):this.usePercentageCloserFiltering?(e["SHADOWPCF"+t]=!0,this._filteringQuality===s.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=!0:this._filteringQuality===s.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=!0)):this.usePoissonSampling?e["SHADOWPOISSON"+t]=!0:this.useExponentialShadowMap||this.useBlurExponentialShadowMap?e["SHADOWESM"+t]=!0:(this.useCloseExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(e["SHADOWCLOSEESM"+t]=!0),r.needCube()&&(e["SHADOWCUBE"+t]=!0))}bindShadowLight(e,t){let i=this._light;if(!this._scene.shadowsEnabled||!i.shadowEnabled)return;let n=this._getCamera(),a=this.getShadowMap();if(!a)return;i.needCube()||t.setMatrix("lightMatrix"+e,this.getTransformMatrix());let o=this.getShadowMapForRendering();this._filter===s.FILTER_PCF?(t.setDepthStencilTexture("shadowTexture"+e,o),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),a.getSize().width,1/a.getSize().width,this.frustumEdgeFalloff,e)):this._filter===s.FILTER_PCSS?(t.setDepthStencilTexture("shadowTexture"+e,o),t.setTexture("depthTexture"+e,o),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/a.getSize().width,this._contactHardeningLightSizeUVRatio*a.getSize().width,this.frustumEdgeFalloff,e)):(t.setTexture("shadowTexture"+e,o),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),this.blurScale/a.getSize().width,this.depthScale,this.frustumEdgeFalloff,e)),i._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(n),this.getLight().getDepthMinZ(n)+this.getLight().getDepthMaxZ(n),e)}get viewMatrix(){return this._viewMatrix}get projectionMatrix(){return this._projectionMatrix}getTransformMatrix(){let e=this._scene;if(this._currentRenderId===e.getRenderId()&&this._currentFaceIndexCache===this._currentFaceIndex)return this._transformMatrix;this._currentRenderId=e.getRenderId(),this._currentFaceIndexCache=this._currentFaceIndex;let t=this._light.position;if(this._light.computeTransformedInformation()&&(t=this._light.transformedPosition),E.NormalizeToRef(this._light.getShadowDirection(this._currentFaceIndex),this._lightDirection),Math.abs(E.Dot(this._lightDirection,E.Up()))===1&&(this._lightDirection.z=1e-13),this._light.needProjectionMatrixCompute()||!this._cachedPosition||!this._cachedDirection||!t.equals(this._cachedPosition)||!this._lightDirection.equals(this._cachedDirection)){this._cachedPosition.copyFrom(t),this._cachedDirection.copyFrom(this._lightDirection),B.LookAtLHToRef(t,t.add(this._lightDirection),E.Up(),this._viewMatrix);let i=this.getShadowMap();if(i){let r=i.renderList;r&&this._light.setShadowProjectionMatrix(this._projectionMatrix,this._viewMatrix,r)}this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix)}return this._transformMatrix}recreateShadowMap(){let e=this._shadowMap;if(!e)return;let t=e.renderList;if(this._disposeRTTandPostProcesses(),this._initializeGenerator(),this.filter=this._filter,this._applyFilterValues(),t){this._shadowMap.renderList||(this._shadowMap.renderList=[]);for(let i of t)this._shadowMap.renderList.push(i)}else this._shadowMap.renderList=null}_disposeBlurPostProcesses(){this._shadowMap2&&(this._shadowMap2.dispose(),this._shadowMap2=null),this._boxBlurPostprocess&&(this._boxBlurPostprocess.dispose(),this._boxBlurPostprocess=null),this._kernelBlurXPostprocess&&(this._kernelBlurXPostprocess.dispose(),this._kernelBlurXPostprocess=null),this._kernelBlurYPostprocess&&(this._kernelBlurYPostprocess.dispose(),this._kernelBlurYPostprocess=null),this._blurPostProcesses=[]}_disposeRTTandPostProcesses(){this._shadowMap&&(this._shadowMap.dispose(),this._shadowMap=null),this._disposeBlurPostProcesses()}_disposeSceneUBOs(){if(this._sceneUBOs){for(let e of this._sceneUBOs)e.dispose();this._sceneUBOs=[]}}dispose(){if(this._disposeRTTandPostProcesses(),this._disposeSceneUBOs(),this._light){if(this._light._shadowGenerators){let e=this._light._shadowGenerators.entries();for(let t=e.next();t.done!==!0;t=e.next()){let[i,r]=t.value;r===this&&this._light._shadowGenerators.delete(i)}this._light._shadowGenerators.size===0&&(this._light._shadowGenerators=null)}this._light._markMeshesAsLightDirty()}this.onBeforeShadowMapRenderMeshObservable.clear(),this.onBeforeShadowMapRenderObservable.clear(),this.onAfterShadowMapRenderMeshObservable.clear(),this.onAfterShadowMapRenderObservable.clear()}serialize(){let e={},t=this.getShadowMap();if(!t)return e;if(e.className=this.getClassName(),e.lightId=this._light.id,e.cameraId=this._camera?.id,e.id=this.id,e.mapSize=t.getRenderSize(),e.forceBackFacesOnly=this.forceBackFacesOnly,e.darkness=this.getDarkness(),e.transparencyShadow=this._transparencyShadow,e.frustumEdgeFalloff=this.frustumEdgeFalloff,e.bias=this.bias,e.normalBias=this.normalBias,e.usePercentageCloserFiltering=this.usePercentageCloserFiltering,e.useContactHardeningShadow=this.useContactHardeningShadow,e.contactHardeningLightSizeUVRatio=this.contactHardeningLightSizeUVRatio,e.filteringQuality=this.filteringQuality,e.useExponentialShadowMap=this.useExponentialShadowMap,e.useBlurExponentialShadowMap=this.useBlurExponentialShadowMap,e.useCloseExponentialShadowMap=this.useBlurExponentialShadowMap,e.useBlurCloseExponentialShadowMap=this.useBlurExponentialShadowMap,e.usePoissonSampling=this.usePoissonSampling,e.depthScale=this.depthScale,e.blurBoxOffset=this.blurBoxOffset,e.blurKernel=this.blurKernel,e.blurScale=this.blurScale,e.useKernelBlur=this.useKernelBlur,e.renderList=[],t.renderList)for(let i=0;i<t.renderList.length;i++){let r=t.renderList[i];e.renderList.push(r.id)}return e}static Parse(e,t,i){let r=t.getLightById(e.lightId),n=e.cameraId!==void 0?t.getCameraById(e.cameraId):null,a=i?i(e.mapSize,r,n):new s(e.mapSize,r,void 0,n),o=a.getShadowMap();if(e.renderList.length&&o){let l=new Set(e.renderList),c=o.renderList;c||(c=o.renderList=[]);let f=t.meshes;for(let h of f)l.has(h.id)&&c.push(h)}return e.id!==void 0&&(a.id=e.id),a.forceBackFacesOnly=!!e.forceBackFacesOnly,e.darkness!==void 0&&a.setDarkness(e.darkness),e.transparencyShadow&&a.setTransparencyShadow(!0),e.frustumEdgeFalloff!==void 0&&(a.frustumEdgeFalloff=e.frustumEdgeFalloff),e.bias!==void 0&&(a.bias=e.bias),e.normalBias!==void 0&&(a.normalBias=e.normalBias),e.usePercentageCloserFiltering?a.usePercentageCloserFiltering=!0:e.useContactHardeningShadow?a.useContactHardeningShadow=!0:e.usePoissonSampling?a.usePoissonSampling=!0:e.useExponentialShadowMap?a.useExponentialShadowMap=!0:e.useBlurExponentialShadowMap?a.useBlurExponentialShadowMap=!0:e.useCloseExponentialShadowMap?a.useCloseExponentialShadowMap=!0:e.useBlurCloseExponentialShadowMap?a.useBlurCloseExponentialShadowMap=!0:e.useVarianceShadowMap?a.useExponentialShadowMap=!0:e.useBlurVarianceShadowMap&&(a.useBlurExponentialShadowMap=!0),e.contactHardeningLightSizeUVRatio!==void 0&&(a.contactHardeningLightSizeUVRatio=e.contactHardeningLightSizeUVRatio),e.filteringQuality!==void 0&&(a.filteringQuality=e.filteringQuality),e.depthScale&&(a.depthScale=e.depthScale),e.blurScale&&(a.blurScale=e.blurScale),e.blurBoxOffset&&(a.blurBoxOffset=e.blurBoxOffset),e.useKernelBlur&&(a.useKernelBlur=e.useKernelBlur),e.blurKernel&&(a.blurKernel=e.blurKernel),a}};vt.CLASSNAME="ShadowGenerator";vt.ForceGLSL=!1;vt.FILTER_NONE=0;vt.FILTER_EXPONENTIALSHADOWMAP=1;vt.FILTER_POISSONSAMPLING=2;vt.FILTER_BLUREXPONENTIALSHADOWMAP=3;vt.FILTER_CLOSEEXPONENTIALSHADOWMAP=4;vt.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP=5;vt.FILTER_PCF=6;vt.FILTER_PCSS=7;vt.QUALITY_HIGH=0;vt.QUALITY_MEDIUM=1;vt.QUALITY_LOW=2;vt.DEFAULT_ALPHA_CUTOFF=.5;vt._SceneComponentInitialization=s=>{throw pe("ShadowGeneratorSceneComponent")}});var sf,fN=S(()=>{Hs();ie();xr();sf=class s{constructor(e,t,i){this.vectors=Gi(8,E.Zero),this.center=E.Zero(),this.centerWorld=E.Zero(),this.extendSize=E.Zero(),this.extendSizeWorld=E.Zero(),this.directions=Gi(3,E.Zero),this.vectorsWorld=Gi(8,E.Zero),this.minimumWorld=E.Zero(),this.maximumWorld=E.Zero(),this.minimum=E.Zero(),this.maximum=E.Zero(),this._drawWrapperFront=null,this._drawWrapperBack=null,this.reConstruct(e,t,i)}reConstruct(e,t,i){let r=e.x,n=e.y,a=e.z,o=t.x,l=t.y,c=t.z,f=this.vectors;this.minimum.copyFromFloats(r,n,a),this.maximum.copyFromFloats(o,l,c),f[0].copyFromFloats(r,n,a),f[1].copyFromFloats(o,l,c),f[2].copyFromFloats(o,n,a),f[3].copyFromFloats(r,l,a),f[4].copyFromFloats(r,n,c),f[5].copyFromFloats(o,l,a),f[6].copyFromFloats(r,l,c),f[7].copyFromFloats(o,n,c),t.addToRef(e,this.center).scaleInPlace(.5),t.subtractToRef(e,this.extendSize).scaleInPlace(.5),this._worldMatrix=i||B.IdentityReadOnly,this._update(this._worldMatrix)}scale(e){let t=s._TmpVector3,i=this.maximum.subtractToRef(this.minimum,t[0]),r=i.length();i.normalizeFromLength(r);let n=r*e,a=i.scaleInPlace(n*.5),o=this.center.subtractToRef(a,t[1]),l=this.center.addToRef(a,t[2]);return this.reConstruct(o,l,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){let t=this.minimumWorld,i=this.maximumWorld,r=this.directions,n=this.vectorsWorld,a=this.vectors;if(e.isIdentity()){t.copyFrom(this.minimum),i.copyFrom(this.maximum);for(let o=0;o<8;++o)n[o].copyFrom(a[o]);this.extendSizeWorld.copyFrom(this.extendSize),this.centerWorld.copyFrom(this.center)}else{t.setAll(Number.MAX_VALUE),i.setAll(-Number.MAX_VALUE);for(let o=0;o<8;++o){let l=n[o];E.TransformCoordinatesToRef(a[o],e,l),t.minimizeInPlace(l),i.maximizeInPlace(l)}i.subtractToRef(t,this.extendSizeWorld).scaleInPlace(.5),i.addToRef(t,this.centerWorld).scaleInPlace(.5)}E.FromArrayToRef(e.m,0,r[0]),E.FromArrayToRef(e.m,4,r[1]),E.FromArrayToRef(e.m,8,r[2]),this._worldMatrix=e}isInFrustum(e){return s.IsInFrustum(this.vectorsWorld,e)}isCompletelyInFrustum(e){return s.IsCompletelyInFrustum(this.vectorsWorld,e)}intersectsPoint(e){let t=this.minimumWorld,i=this.maximumWorld,r=t.x,n=t.y,a=t.z,o=i.x,l=i.y,c=i.z,f=e.x,h=e.y,u=e.z,d=-We;return!(o-f<d||d>f-r||l-h<d||d>h-n||c-u<d||d>u-a)}intersectsSphere(e){return s.IntersectsSphere(this.minimumWorld,this.maximumWorld,e.centerWorld,e.radiusWorld)}intersectsMinMax(e,t){let i=this.minimumWorld,r=this.maximumWorld,n=i.x,a=i.y,o=i.z,l=r.x,c=r.y,f=r.z,h=e.x,u=e.y,d=e.z,p=t.x,m=t.y,_=t.z;return!(l<h||n>p||c<u||a>m||f<d||o>_)}dispose(){this._drawWrapperFront?.dispose(),this._drawWrapperBack?.dispose()}static Intersects(e,t){return e.intersectsMinMax(t.minimumWorld,t.maximumWorld)}static IntersectsSphere(e,t,i,r){let n=s._TmpVector3[0];return E.ClampToRef(i,e,t,n),E.DistanceSquared(i,n)<=r*r}static IsCompletelyInFrustum(e,t){for(let i=0;i<6;++i){let r=t[i];for(let n=0;n<8;++n)if(r.dotCoordinate(e[n])<0)return!1}return!0}static IsInFrustum(e,t){for(let i=0;i<6;++i){let r=!0,n=t[i];for(let a=0;a<8;++a)if(n.dotCoordinate(e[a])>=0){r=!1;break}if(r)return!1}return!0}};sf._TmpVector3=Gi(3,E.Zero)});var nf,hN=S(()=>{Hs();ie();nf=class s{constructor(e,t,i){this.center=E.Zero(),this.centerWorld=E.Zero(),this.minimum=E.Zero(),this.maximum=E.Zero(),this.reConstruct(e,t,i)}reConstruct(e,t,i){this.minimum.copyFrom(e),this.maximum.copyFrom(t);let r=E.Distance(e,t);t.addToRef(e,this.center).scaleInPlace(.5),this.radius=r*.5,this._update(i||B.IdentityReadOnly)}scale(e){let t=this.radius*e,i=s._TmpVector3,r=i[0].setAll(t),n=this.center.subtractToRef(r,i[1]),a=this.center.addToRef(r,i[2]);return this.reConstruct(n,a,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){if(e.isIdentity())this.centerWorld.copyFrom(this.center),this.radiusWorld=this.radius;else{E.TransformCoordinatesToRef(this.center,e,this.centerWorld);let t=s._TmpVector3[0];E.TransformNormalFromFloatsToRef(1,1,1,e,t),this.radiusWorld=Math.max(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z))*this.radius}}isInFrustum(e){let t=this.centerWorld,i=this.radiusWorld;for(let r=0;r<6;r++)if(e[r].dotCoordinate(t)<=-i)return!1;return!0}isCenterInFrustum(e){let t=this.centerWorld;for(let i=0;i<6;i++)if(e[i].dotCoordinate(t)<0)return!1;return!0}intersectsPoint(e){let t=E.DistanceSquared(this.centerWorld,e);return!(this.radiusWorld*this.radiusWorld<t)}static Intersects(e,t){let i=E.DistanceSquared(e.centerWorld,t.centerWorld),r=e.radiusWorld+t.radiusWorld;return!(r*r<i)}static CreateFromCenterAndRadius(e,t,i){this._TmpVector3[0].copyFrom(e),this._TmpVector3[1].copyFromFloats(0,0,t),this._TmpVector3[2].copyFrom(e),this._TmpVector3[0].addInPlace(this._TmpVector3[1]),this._TmpVector3[2].subtractInPlace(this._TmpVector3[1]);let r=new s(this._TmpVector3[0],this._TmpVector3[2]);return i?r._worldMatrix=i:r._worldMatrix=B.Identity(),r}};nf._TmpVector3=Gi(3,E.Zero)});var rb,sb,uN,Cr,Ei,Pl=S(()=>{Hs();ie();fN();hN();rb={min:0,max:0},sb={min:0,max:0},uN=(s,e,t)=>{let i=E.Dot(e.centerWorld,s),r=Math.abs(E.Dot(e.directions[0],s))*e.extendSize.x,n=Math.abs(E.Dot(e.directions[1],s))*e.extendSize.y,a=Math.abs(E.Dot(e.directions[2],s))*e.extendSize.z,o=r+n+a;t.min=i-o,t.max=i+o},Cr=(s,e,t)=>(uN(s,e,rb),uN(s,t,sb),!(rb.min>sb.max||sb.min>rb.max)),Ei=class s{constructor(e,t,i){this._isLocked=!1,this.boundingBox=new sf(e,t,i),this.boundingSphere=new nf(e,t,i)}reConstruct(e,t,i){this.boundingBox.reConstruct(e,t,i),this.boundingSphere.reConstruct(e,t,i)}get minimum(){return this.boundingBox.minimum}get maximum(){return this.boundingBox.maximum}get isLocked(){return this._isLocked}set isLocked(e){this._isLocked=e}update(e){this._isLocked||(this.boundingBox._update(e),this.boundingSphere._update(e))}centerOn(e,t){let i=s._TmpVector3[0].copyFrom(e).subtractInPlace(t),r=s._TmpVector3[1].copyFrom(e).addInPlace(t);return this.boundingBox.reConstruct(i,r,this.boundingBox.getWorldMatrix()),this.boundingSphere.reConstruct(i,r,this.boundingBox.getWorldMatrix()),this}encapsulate(e){let t=E.Minimize(this.minimum,e),i=E.Maximize(this.maximum,e);return this.reConstruct(t,i,this.boundingBox.getWorldMatrix()),this}encapsulateBoundingInfo(e){let t=w.Matrix[0];this.boundingBox.getWorldMatrix().invertToRef(t);let i=w.Vector3[0];return E.TransformCoordinatesToRef(e.boundingBox.minimumWorld,t,i),this.encapsulate(i),E.TransformCoordinatesToRef(e.boundingBox.maximumWorld,t,i),this.encapsulate(i),this}scale(e){return this.boundingBox.scale(e),this.boundingSphere.scale(e),this}isInFrustum(e,t=0){return(t===2||t===3)&&this.boundingSphere.isCenterInFrustum(e)?!0:this.boundingSphere.isInFrustum(e)?t===1||t===3?!0:this.boundingBox.isInFrustum(e):!1}get diagonalLength(){let e=this.boundingBox;return e.maximumWorld.subtractToRef(e.minimumWorld,s._TmpVector3[0]).length()}isCompletelyInFrustum(e){return this.boundingBox.isCompletelyInFrustum(e)}_checkCollision(e){return e._canDoCollision(this.boundingSphere.centerWorld,this.boundingSphere.radiusWorld,this.boundingBox.minimumWorld,this.boundingBox.maximumWorld)}intersectsPoint(e){return!(!this.boundingSphere.centerWorld||!this.boundingSphere.intersectsPoint(e)||!this.boundingBox.intersectsPoint(e))}intersects(e,t){if(!nf.Intersects(this.boundingSphere,e.boundingSphere)||!sf.Intersects(this.boundingBox,e.boundingBox))return!1;if(!t)return!0;let i=this.boundingBox,r=e.boundingBox;return!(!Cr(i.directions[0],i,r)||!Cr(i.directions[1],i,r)||!Cr(i.directions[2],i,r)||!Cr(r.directions[0],i,r)||!Cr(r.directions[1],i,r)||!Cr(r.directions[2],i,r)||!Cr(E.Cross(i.directions[0],r.directions[0]),i,r)||!Cr(E.Cross(i.directions[0],r.directions[1]),i,r)||!Cr(E.Cross(i.directions[0],r.directions[2]),i,r)||!Cr(E.Cross(i.directions[1],r.directions[0]),i,r)||!Cr(E.Cross(i.directions[1],r.directions[1]),i,r)||!Cr(E.Cross(i.directions[1],r.directions[2]),i,r)||!Cr(E.Cross(i.directions[2],r.directions[0]),i,r)||!Cr(E.Cross(i.directions[2],r.directions[1]),i,r)||!Cr(E.Cross(i.directions[2],r.directions[2]),i,r))}};Ei._TmpVector3=Gi(2,E.Zero)});var ye,Vn=S(()=>{Ye();je();bn();$e();we();ie();rs();Ee();Te();Ii();Dh();Np();ei();ye=class s extends _t{get position(){return this._position}set position(e){this._position=e}set upVector(e){this._upVector=e}get upVector(){return this._upVector}get screenArea(){let e=0,t=0;if(this.mode===s.PERSPECTIVE_CAMERA)this.fovMode===s.FOVMODE_VERTICAL_FIXED?(t=this.minZ*2*Math.tan(this.fov/2),e=this.getEngine().getAspectRatio(this)*t):(e=this.minZ*2*Math.tan(this.fov/2),t=e/this.getEngine().getAspectRatio(this));else{let i=this.getEngine().getRenderWidth()/2,r=this.getEngine().getRenderHeight()/2;e=(this.orthoRight??i)-(this.orthoLeft??-i),t=(this.orthoTop??r)-(this.orthoBottom??-r)}return e*t}set orthoLeft(e){this._orthoLeft=e;for(let t of this._rigCameras)t.orthoLeft=e}get orthoLeft(){return this._orthoLeft}set orthoRight(e){this._orthoRight=e;for(let t of this._rigCameras)t.orthoRight=e}get orthoRight(){return this._orthoRight}set orthoBottom(e){this._orthoBottom=e;for(let t of this._rigCameras)t.orthoBottom=e}get orthoBottom(){return this._orthoBottom}set orthoTop(e){this._orthoTop=e;for(let t of this._rigCameras)t.orthoTop=e}get orthoTop(){return this._orthoTop}setFocalLength(e,t=36){this.fov=2*Math.atan(t/(2*e))}set mode(e){this._mode=e;for(let t of this._rigCameras)t.mode=e}get mode(){return this._mode}get hasMoved(){return this._hasMoved}constructor(e,t,i,r=!0){super(e,i,!1),this._position=E.Zero(),this._upVector=E.Up(),this.oblique=null,this._orthoLeft=null,this._orthoRight=null,this._orthoBottom=null,this._orthoTop=null,this.fov=.8,this.projectionPlaneTilt=0,this.minZ=1,this.maxZ=1e4,this.inertia=.9,this._mode=s.PERSPECTIVE_CAMERA,this.isIntermediate=!1,this.viewport=new So(0,0,1,1),this.layerMask=268435455,this.fovMode=s.FOVMODE_VERTICAL_FIXED,this.cameraRigMode=s.RIG_MODE_NONE,this.customRenderTargets=[],this.outputRenderTarget=null,this.onViewMatrixChangedObservable=new N,this.onProjectionMatrixChangedObservable=new N,this.onAfterCheckInputsObservable=new N,this.onRestoreStateObservable=new N,this.isRigCamera=!1,this._hasMoved=!1,this._rigCameras=new Array,this._skipRendering=!1,this._projectionMatrix=new B,this._postProcesses=new Array,this._activeMeshes=new wt(256),this._globalPosition=E.Zero(),this._computedViewMatrix=B.Identity(),this._doNotComputeProjectionMatrix=!1,this._transformMatrix=B.Zero(),this._refreshFrustumPlanes=!0,this._absoluteRotation=K.Identity(),this._isCamera=!0,this._isLeftCamera=!1,this._isRightCamera=!1,this.getScene().addCamera(this),r&&!this.getScene().activeCamera&&(this.getScene().activeCamera=this),this.position=t,this.renderPassId=this.getScene().getEngine().createRenderPassId(`Camera ${e}`)}storeState(){return this._stateStored=!0,this._storedFov=this.fov,this}hasStateStored(){return!!this._stateStored}_restoreStateValues(){return this._stateStored?(this.fov=this._storedFov,!0):!1}restoreState(){return this._restoreStateValues()?(this.onRestoreStateObservable.notifyObservers(this),!0):!1}getClassName(){return"Camera"}toString(e){let t="Name: "+this.name;if(t+=", type: "+this.getClassName(),this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);return t}applyVerticalCorrection(){let e=this.absoluteRotation.toEulerAngles();this.projectionPlaneTilt=this._scene.useRightHandedSystem?-e.x:e.x}get globalPosition(){return this._globalPosition}getActiveMeshes(){return this._activeMeshes}isActiveMesh(e){return this._activeMeshes.indexOf(e)!==-1}isReady(e=!1){if(e){for(let t of this._postProcesses)if(t&&!t.isReady())return!1}return super.isReady(e)}_initCache(){super._initCache(),this._cache.position=new E(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.upVector=new E(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.mode=void 0,this._cache.minZ=void 0,this._cache.maxZ=void 0,this._cache.fov=void 0,this._cache.fovMode=void 0,this._cache.aspectRatio=void 0,this._cache.orthoLeft=void 0,this._cache.orthoRight=void 0,this._cache.orthoBottom=void 0,this._cache.orthoTop=void 0,this._cache.obliqueAngle=void 0,this._cache.obliqueLength=void 0,this._cache.obliqueOffset=void 0,this._cache.renderWidth=void 0,this._cache.renderHeight=void 0}_updateCache(e){e||super._updateCache(),this._cache.position.copyFrom(this.position),this._cache.upVector.copyFrom(this.upVector)}_isSynchronized(){return this._isSynchronizedViewMatrix()&&this._isSynchronizedProjectionMatrix()}_isSynchronizedViewMatrix(){return super._isSynchronized()?this._cache.position.equals(this.position)&&this._cache.upVector.equals(this.upVector)&&this.isSynchronizedWithParent():!1}_isSynchronizedProjectionMatrix(){let e=this._cache.mode===this.mode&&this._cache.minZ===this.minZ&&this._cache.maxZ===this.maxZ;if(!e)return!1;let t=this.getEngine();return this.mode===s.PERSPECTIVE_CAMERA?e=this._cache.fov===this.fov&&this._cache.fovMode===this.fovMode&&this._cache.aspectRatio===t.getAspectRatio(this)&&this._cache.projectionPlaneTilt===this.projectionPlaneTilt:(e=this._cache.orthoLeft===this.orthoLeft&&this._cache.orthoRight===this.orthoRight&&this._cache.orthoBottom===this.orthoBottom&&this._cache.orthoTop===this.orthoTop&&this._cache.renderWidth===t.getRenderWidth()&&this._cache.renderHeight===t.getRenderHeight(),this.oblique&&(e=e&&this._cache.obliqueAngle===this.oblique.angle&&this._cache.obliqueLength===this.oblique.length&&this._cache.obliqueOffset===this.oblique.offset)),e}attachControl(e,t){}detachControl(e){}update(){this._hasMoved=!1,this._checkInputs(),this.cameraRigMode!==s.RIG_MODE_NONE&&this._updateRigCameras(),this.getViewMatrix(),this.getProjectionMatrix()}_checkInputs(){this.onAfterCheckInputsObservable.notifyObservers(this)}get rigCameras(){return this._rigCameras}get rigPostProcess(){return this._rigPostProcess}_getFirstPostProcess(){for(let e=0;e<this._postProcesses.length;e++)if(this._postProcesses[e]!==null)return this._postProcesses[e];return null}_cascadePostProcessesToRigCams(){let e=this._getFirstPostProcess();e&&e.markTextureDirty();for(let t=0,i=this._rigCameras.length;t<i;t++){let r=this._rigCameras[t],n=r._rigPostProcess;n?(n.getEffectName()==="pass"&&(r.isIntermediate=this._postProcesses.length===0),r._postProcesses=this._postProcesses.slice(0).concat(n),n.markTextureDirty()):r._postProcesses=this._postProcesses.slice(0)}}attachPostProcess(e,t=null){return!e.isReusable()&&this._postProcesses.indexOf(e)>-1?(P.Error("You're trying to reuse a post process not defined as reusable."),0):(t==null||t<0?this._postProcesses.push(e):this._postProcesses[t]===null?this._postProcesses[t]=e:this._postProcesses.splice(t,0,e),this._cascadePostProcessesToRigCams(),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._postProcesses.indexOf(e))}detachPostProcess(e){let t=this._postProcesses.indexOf(e);t!==-1&&(this._postProcesses[t]=null),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._cascadePostProcessesToRigCams()}getWorldMatrix(){return this._isSynchronizedViewMatrix()?this._worldMatrix:(this.getViewMatrix(),this._worldMatrix)}_getViewMatrix(){return B.Identity()}getViewMatrix(e){return!e&&this._isSynchronizedViewMatrix()?this._computedViewMatrix:(this._hasMoved=!0,this.updateCache(),this._computedViewMatrix=this._getViewMatrix(),this._currentRenderId=this.getScene().getRenderId(),this._childUpdateId++,this._refreshFrustumPlanes=!0,this._cameraRigParams&&this._cameraRigParams.vrPreViewMatrix&&this._computedViewMatrix.multiplyToRef(this._cameraRigParams.vrPreViewMatrix,this._computedViewMatrix),this.parent&&this.parent.onViewMatrixChangedObservable&&this.parent.onViewMatrixChangedObservable.notifyObservers(this.parent),this.onViewMatrixChangedObservable.notifyObservers(this),this._computedViewMatrix.invertToRef(this._worldMatrix),this._computedViewMatrix)}freezeProjectionMatrix(e){this._doNotComputeProjectionMatrix=!0,e!==void 0&&(this._projectionMatrix=e)}unfreezeProjectionMatrix(){this._doNotComputeProjectionMatrix=!1}getProjectionMatrix(e){if(this._doNotComputeProjectionMatrix||!e&&this._isSynchronizedProjectionMatrix())return this._projectionMatrix;this._cache.mode=this.mode,this._cache.minZ=this.minZ,this._cache.maxZ=this.maxZ,this._refreshFrustumPlanes=!0;let t=this.getEngine(),i=this.getScene(),r=t.useReverseDepthBuffer;if(this.mode===s.PERSPECTIVE_CAMERA){this._cache.fov=this.fov,this._cache.fovMode=this.fovMode,this._cache.aspectRatio=t.getAspectRatio(this),this._cache.projectionPlaneTilt=this.projectionPlaneTilt,this.minZ<=0&&(this.minZ=.1);let n;i.useRightHandedSystem?n=B.PerspectiveFovRHToRef:n=B.PerspectiveFovLHToRef,n(this.fov,t.getAspectRatio(this),r?this.maxZ:this.minZ,r?this.minZ:this.maxZ,this._projectionMatrix,this.fovMode===s.FOVMODE_VERTICAL_FIXED,t.isNDCHalfZRange,this.projectionPlaneTilt,r)}else{let n=t.getRenderWidth()/2,a=t.getRenderHeight()/2;i.useRightHandedSystem?this.oblique?B.ObliqueOffCenterRHToRef(this.orthoLeft??-n,this.orthoRight??n,this.orthoBottom??-a,this.orthoTop??a,r?this.maxZ:this.minZ,r?this.minZ:this.maxZ,this.oblique.length,this.oblique.angle,this._computeObliqueDistance(this.oblique.offset),this._projectionMatrix,t.isNDCHalfZRange):B.OrthoOffCenterRHToRef(this.orthoLeft??-n,this.orthoRight??n,this.orthoBottom??-a,this.orthoTop??a,r?this.maxZ:this.minZ,r?this.minZ:this.maxZ,this._projectionMatrix,t.isNDCHalfZRange):this.oblique?B.ObliqueOffCenterLHToRef(this.orthoLeft??-n,this.orthoRight??n,this.orthoBottom??-a,this.orthoTop??a,r?this.maxZ:this.minZ,r?this.minZ:this.maxZ,this.oblique.length,this.oblique.angle,this._computeObliqueDistance(this.oblique.offset),this._projectionMatrix,t.isNDCHalfZRange):B.OrthoOffCenterLHToRef(this.orthoLeft??-n,this.orthoRight??n,this.orthoBottom??-a,this.orthoTop??a,r?this.maxZ:this.minZ,r?this.minZ:this.maxZ,this._projectionMatrix,t.isNDCHalfZRange),this._cache.orthoLeft=this.orthoLeft,this._cache.orthoRight=this.orthoRight,this._cache.orthoBottom=this.orthoBottom,this._cache.orthoTop=this.orthoTop,this._cache.obliqueAngle=this.oblique?.angle,this._cache.obliqueLength=this.oblique?.length,this._cache.obliqueOffset=this.oblique?.offset,this._cache.renderWidth=t.getRenderWidth(),this._cache.renderHeight=t.getRenderHeight()}return this.onProjectionMatrixChangedObservable.notifyObservers(this),this._projectionMatrix}getTransformationMatrix(){return this._computedViewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._transformMatrix}_computeObliqueDistance(e){let t=this,i=this;return(t.radius||(i.target?E.Distance(this.position,i.target):this.position.length()))+e}_updateFrustumPlanes(){this._refreshFrustumPlanes&&(this.getTransformationMatrix(),this._frustumPlanes?vo.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=vo.GetPlanes(this._transformMatrix),this._refreshFrustumPlanes=!1)}isInFrustum(e,t=!1){if(this._updateFrustumPlanes(),t&&this.rigCameras.length>0){let i=!1;for(let r of this.rigCameras)r._updateFrustumPlanes(),i=i||e.isInFrustum(r._frustumPlanes);return i}else return e.isInFrustum(this._frustumPlanes)}isCompletelyInFrustum(e){return this._updateFrustumPlanes(),e.isCompletelyInFrustum(this._frustumPlanes)}getForwardRay(e=100,t,i){throw pe("Ray")}getForwardRayToRef(e,t=100,i,r){throw pe("Ray")}dispose(e,t=!1){for(this.onViewMatrixChangedObservable.clear(),this.onProjectionMatrixChangedObservable.clear(),this.onAfterCheckInputsObservable.clear(),this.onRestoreStateObservable.clear(),this.inputs&&this.inputs.clear(),this.getScene().stopAnimation(this),this.getScene().removeCamera(this);this._rigCameras.length>0;){let r=this._rigCameras.pop();r&&r.dispose()}if(this._parentContainer){let r=this._parentContainer.cameras.indexOf(this);r>-1&&this._parentContainer.cameras.splice(r,1),this._parentContainer=null}if(this._rigPostProcess)this._rigPostProcess.dispose(this),this._rigPostProcess=null,this._postProcesses.length=0;else if(this.cameraRigMode!==s.RIG_MODE_NONE)this._rigPostProcess=null,this._postProcesses.length=0;else{let r=this._postProcesses.length;for(;--r>=0;){let n=this._postProcesses[r];n&&n.dispose(this)}}let i=this.customRenderTargets.length;for(;--i>=0;)this.customRenderTargets[i].dispose();this.customRenderTargets.length=0,this._activeMeshes.dispose(),this.getScene().getEngine().releaseRenderPassId(this.renderPassId),super.dispose(e,t)}get isLeftCamera(){return this._isLeftCamera}get isRightCamera(){return this._isRightCamera}get leftCamera(){return this._rigCameras.length<1?null:this._rigCameras[0]}get rightCamera(){return this._rigCameras.length<2?null:this._rigCameras[1]}getLeftTarget(){return this._rigCameras.length<1?null:this._rigCameras[0].getTarget()}getRightTarget(){return this._rigCameras.length<2?null:this._rigCameras[1].getTarget()}setCameraRigMode(e,t){if(this.cameraRigMode!==e){for(;this._rigCameras.length>0;){let i=this._rigCameras.pop();i&&i.dispose()}if(this.cameraRigMode=e,this._cameraRigParams={},this._cameraRigParams.interaxialDistance=t.interaxialDistance||.0637,this._cameraRigParams.stereoHalfAngle=W.ToRadians(this._cameraRigParams.interaxialDistance/.0637),this.cameraRigMode!==s.RIG_MODE_NONE){let i=this.createRigCamera(this.name+"_L",0);i&&(i._isLeftCamera=!0);let r=this.createRigCamera(this.name+"_R",1);r&&(r._isRightCamera=!0),i&&r&&(this._rigCameras.push(i),this._rigCameras.push(r))}this._setRigMode(t),this._cascadePostProcessesToRigCams(),this.update()}}_setRigMode(e){}_getVRProjectionMatrix(){return B.PerspectiveFovLHToRef(this._cameraRigParams.vrMetrics.aspectRatioFov,this._cameraRigParams.vrMetrics.aspectRatio,this.minZ,this.maxZ,this._cameraRigParams.vrWorkMatrix,!0,this.getEngine().isNDCHalfZRange),this._cameraRigParams.vrWorkMatrix.multiplyToRef(this._cameraRigParams.vrHMatrix,this._projectionMatrix),this._projectionMatrix}setCameraRigParameter(e,t){this._cameraRigParams||(this._cameraRigParams={}),this._cameraRigParams[e]=t,e==="interaxialDistance"&&(this._cameraRigParams.stereoHalfAngle=W.ToRadians(t/.0637))}createRigCamera(e,t){return null}_updateRigCameras(){for(let e=0;e<this._rigCameras.length;e++)this._rigCameras[e].minZ=this.minZ,this._rigCameras[e].maxZ=this.maxZ,this._rigCameras[e].fov=this.fov,this._rigCameras[e].upVector.copyFrom(this.upVector);this.cameraRigMode===s.RIG_MODE_STEREOSCOPIC_ANAGLYPH&&(this._rigCameras[0].viewport=this._rigCameras[1].viewport=this.viewport)}_setupInputs(){}serialize(){let e=_e.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getClassName(),this.parent&&this.parent._serializeAsParent(e),this.inputs&&this.inputs.serialize(e),_e.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}clone(e,t=null){let i=_e.Clone(s.GetConstructorFromName(this.getClassName(),e,this.getScene(),this.interaxialDistance,this.isStereoscopicSideBySide),this);return i.name=e,i.parent=t,this.onClonedObservable.notifyObservers(i),i}getDirection(e){let t=E.Zero();return this.getDirectionToRef(e,t),t}get absoluteRotation(){return this.getWorldMatrix().decompose(void 0,this._absoluteRotation),this._absoluteRotation}getDirectionToRef(e,t){E.TransformNormalToRef(e,this.getWorldMatrix(),t)}static GetConstructorFromName(e,t,i,r=0,n=!0){let a=_t.Construct(e,t,i,{interaxial_distance:r,isStereoscopicSideBySide:n});return a||(()=>s._CreateDefaultParsedCamera(t,i))}computeWorldMatrix(){return this.getWorldMatrix()}static Parse(e,t){let i=e.type,r=s.GetConstructorFromName(i,e.name,t,e.interaxial_distance,e.isStereoscopicSideBySide),n=_e.Parse(r,e,t);if(e.parentId!==void 0&&(n._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(n._waitingParentInstanceIndex=e.parentInstanceIndex),n.inputs&&(n.inputs.parse(e),n._setupInputs()),e.upVector&&(n.upVector=E.FromArray(e.upVector)),n.setPosition&&(n.position.copyFromFloats(0,0,0),n.setPosition(E.FromArray(e.position))),e.target&&n.setTarget&&n.setTarget(E.FromArray(e.target)),e.cameraRigMode){let a=e.interaxial_distance?{interaxialDistance:e.interaxial_distance}:{};n.setCameraRigMode(e.cameraRigMode,a)}if(e.animations){for(let a=0;a<e.animations.length;a++){let o=e.animations[a],l=Ci("BABYLON.Animation");l&&n.animations.push(l.Parse(o))}_t.ParseAnimationRanges(n,e,t)}return e.autoAnimate&&t.beginAnimation(n,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.isEnabled!==void 0&&n.setEnabled(e.isEnabled),n}_calculateHandednessMultiplier(){let e=this.getScene().useRightHandedSystem?-1:1;return this.parent&&this.parent._getWorldMatrixDeterminant()<0&&(e*=-1),e}};ye._CreateDefaultParsedCamera=(s,e)=>{throw pe("UniversalCamera")};ye.PERSPECTIVE_CAMERA=0;ye.ORTHOGRAPHIC_CAMERA=1;ye.FOVMODE_VERTICAL_FIXED=0;ye.FOVMODE_HORIZONTAL_FIXED=1;ye.RIG_MODE_NONE=0;ye.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10;ye.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11;ye.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12;ye.RIG_MODE_STEREOSCOPIC_OVERUNDER=13;ye.RIG_MODE_STEREOSCOPIC_INTERLACED=14;ye.RIG_MODE_VR=20;ye.RIG_MODE_CUSTOM=22;ye.ForceAttachControlToAlwaysPreventDefault=!1;x([oi("position")],ye.prototype,"_position",void 0);x([oi("upVector")],ye.prototype,"_upVector",void 0);x([y()],ye.prototype,"orthoLeft",null);x([y()],ye.prototype,"orthoRight",null);x([y()],ye.prototype,"orthoBottom",null);x([y()],ye.prototype,"orthoTop",null);x([y()],ye.prototype,"fov",void 0);x([y()],ye.prototype,"projectionPlaneTilt",void 0);x([y()],ye.prototype,"minZ",void 0);x([y()],ye.prototype,"maxZ",void 0);x([y()],ye.prototype,"inertia",void 0);x([y()],ye.prototype,"mode",null);x([y()],ye.prototype,"layerMask",void 0);x([y()],ye.prototype,"fovMode",void 0);x([y()],ye.prototype,"cameraRigMode",void 0);x([y()],ye.prototype,"interaxialDistance",void 0);x([y()],ye.prototype,"isStereoscopicSideBySide",void 0)});var pN={};V(pN,{depthPixelShader:()=>ej});var nb,dN,ej,ab=S(()=>{O();Da();Om();Oa();nb="depthPixelShader",dN=`#ifdef ALPHATEST
varying vec2 vUV;uniform sampler2D diffuseSampler;
#endif
#include<clipPlaneFragmentDeclaration>
varying float vDepthMetric;
#ifdef PACKED
#include<packingFunctions>
#endif
#ifdef STORE_CAMERASPACE_Z
varying vec4 vViewPos;
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#include<clipPlaneFragment>
#ifdef ALPHATEST
if (texture2D(diffuseSampler,vUV).a<0.4)
discard;
#endif
#ifdef STORE_CAMERASPACE_Z
#ifdef PACKED
gl_FragColor=pack(vViewPos.z);
#else
gl_FragColor=vec4(vViewPos.z,0.0,0.0,1.0);
#endif
#else
#ifdef NONLINEARDEPTH
#ifdef PACKED
gl_FragColor=pack(gl_FragCoord.z);
#else
gl_FragColor=vec4(gl_FragCoord.z,0.0,0.0,0.0);
#endif
#else
#ifdef PACKED
gl_FragColor=pack(vDepthMetric);
#else
gl_FragColor=vec4(vDepthMetric,0.0,0.0,1.0);
#endif
#endif
#endif
}`;g.ShadersStore[nb]||(g.ShadersStore[nb]=dN);ej={name:nb,shader:dN}});var mN,tj,ko=S(()=>{O();mN="instancesDeclaration",tj=`#ifdef INSTANCES
attribute vec4 world0;attribute vec4 world1;attribute vec4 world2;attribute vec4 world3;
#ifdef INSTANCESCOLOR
attribute vec4 instanceColor;
#endif
#if defined(THIN_INSTANCES) && !defined(WORLD_UBO)
uniform mat4 world;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)
attribute vec4 previousWorld0;attribute vec4 previousWorld1;attribute vec4 previousWorld2;attribute vec4 previousWorld3;
#ifdef THIN_INSTANCES
uniform mat4 previousWorld;
#endif
#endif
#else
#if !defined(WORLD_UBO)
uniform mat4 world;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)
uniform mat4 previousWorld;
#endif
#endif
`;g.IncludesShadersStore[mN]||(g.IncludesShadersStore[mN]=tj)});var _N,ij,gN=S(()=>{O();_N="pointCloudVertexDeclaration",ij=`#ifdef POINTSIZE
uniform float pointSize;
#endif
`;g.IncludesShadersStore[_N]||(g.IncludesShadersStore[_N]=ij)});var vN,rj,ob=S(()=>{O();vN="pointCloudVertex",rj=`#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
`;g.IncludesShadersStore[vN]||(g.IncludesShadersStore[vN]=rj)});var EN={};V(EN,{depthVertexShader:()=>sj});var lb,SN,sj,cb=S(()=>{O();La();wa();Bo();Uo();Fa();ko();gN();Go();Vo();Na();Ba();Ua();Ga();ob();lb="depthVertexShader",SN=`attribute vec3 position;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<clipPlaneVertexDeclaration>
#include<instancesDeclaration>
uniform mat4 viewProjection;uniform vec2 depthValues;
#if defined(ALPHATEST) || defined(NEED_UV)
varying vec2 vUV;uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#ifdef STORE_CAMERASPACE_Z
uniform mat4 view;varying vec4 vViewPos;
#endif
#include<pointCloudVertexDeclaration>
varying float vDepthMetric;
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{vec3 positionUpdated=position;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#ifdef UV2
vec2 uv2Updated=uv2;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#include<clipPlaneVertex>
gl_Position=viewProjection*worldPos;
#ifdef STORE_CAMERASPACE_Z
vViewPos=view*worldPos;
#else
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetric=((-gl_Position.z+depthValues.x)/(depthValues.y));
#else
vDepthMetric=((gl_Position.z+depthValues.x)/(depthValues.y));
#endif
#endif
#if defined(ALPHATEST) || defined(BASIC_RENDER)
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2Updated,1.0,0.0));
#endif
#endif
#include<pointCloudVertex>
}
`;g.ShadersStore[lb]||(g.ShadersStore[lb]=SN);sj={name:lb,shader:SN}});var TN,nj,Va=S(()=>{O();TN="instancesDeclaration",nj=`#ifdef INSTANCES
attribute world0 : vec4<f32>;attribute world1 : vec4<f32>;attribute world2 : vec4<f32>;attribute world3 : vec4<f32>;
#ifdef INSTANCESCOLOR
attribute instanceColor : vec4<f32>;
#endif
#if defined(THIN_INSTANCES) && !defined(WORLD_UBO)
uniform world : mat4x4<f32>;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)
attribute previousWorld0 : vec4<f32>;attribute previousWorld1 : vec4<f32>;attribute previousWorld2 : vec4<f32>;attribute previousWorld3 : vec4<f32>;
#ifdef THIN_INSTANCES
uniform previousWorld : mat4x4<f32>;
#endif
#endif
#else
#if !defined(WORLD_UBO)
uniform world : mat4x4<f32>;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR) || defined(VELOCITY_LINEAR)
uniform previousWorld : mat4x4<f32>;
#endif
#endif
`;g.IncludesShadersStoreWGSL[TN]||(g.IncludesShadersStoreWGSL[TN]=nj)});var AN={};V(AN,{depthVertexShaderWGSL:()=>aj});var fb,xN,aj,RN=S(()=>{O();Ia();Bn();Oo();Lo();ya();Va();Fo();No();Un();Ma();Gn();Pa();fb="depthVertexShader",xN=`attribute position: vec3f;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<clipPlaneVertexDeclaration>
#include<instancesDeclaration>
uniform viewProjection: mat4x4f;uniform depthValues: vec2f;
#if defined(ALPHATEST) || defined(NEED_UV)
varying vUV: vec2f;uniform diffuseMatrix: mat4x4f;
#ifdef UV1
attribute uv: vec2f;
#endif
#ifdef UV2
attribute uv2: vec2f;
#endif
#endif
#ifdef STORE_CAMERASPACE_Z
uniform view: mat4x4f;varying vViewPos: vec4f;
#endif
varying vDepthMetric: f32;
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {var positionUpdated: vec3f=input.position;
#ifdef UV1
var uvUpdated: vec2f=input.uv;
#endif
#ifdef UV2
var uv2Updated: vec2f=input.uv2;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
var worldPos: vec4f=finalWorld* vec4f(positionUpdated,1.0);
#include<clipPlaneVertex>
vertexOutputs.position=uniforms.viewProjection*worldPos;
#ifdef STORE_CAMERASPACE_Z
vertexOutputs.vViewPos=uniforms.view*worldPos;
#else
#ifdef USE_REVERSE_DEPTHBUFFER
vertexOutputs.vDepthMetric=((-vertexOutputs.position.z+uniforms.depthValues.x)/(uniforms.depthValues.y));
#else
vertexOutputs.vDepthMetric=((vertexOutputs.position.z+uniforms.depthValues.x)/(uniforms.depthValues.y));
#endif
#endif
#if defined(ALPHATEST) || defined(BASIC_RENDER)
#ifdef UV1
vertexOutputs.vUV= (uniforms.diffuseMatrix* vec4f(uvUpdated,1.0,0.0)).xy;
#endif
#ifdef UV2
vertexOutputs.vUV= (uniforms.diffuseMatrix* vec4f(uv2Updated,1.0,0.0)).xy;
#endif
#endif
}
`;g.ShadersStoreWGSL[fb]||(g.ShadersStoreWGSL[fb]=xN);aj={name:fb,shader:xN}});var CN={};V(CN,{depthPixelShaderWGSL:()=>oj});var hb,bN,oj,IN=S(()=>{O();ba();Dm();Ca();hb="depthPixelShader",bN=`#ifdef ALPHATEST
varying vUV: vec2f;var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;
#endif
#include<clipPlaneFragmentDeclaration>
varying vDepthMetric: f32;
#ifdef PACKED
#include<packingFunctions>
#endif
#ifdef STORE_CAMERASPACE_Z
varying vViewPos: vec4f;
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#include<clipPlaneFragment>
#ifdef ALPHATEST
if (textureSample(diffuseSampler,diffuseSamplerSampler,input.vUV).a<0.4) {discard;}
#endif
#ifdef STORE_CAMERASPACE_Z
#ifdef PACKED
fragmentOutputs.color=pack(input.vViewPos.z);
#else
fragmentOutputs.color= vec4f(input.vViewPos.z,0.0,0.0,1.0);
#endif
#else
#ifdef NONLINEARDEPTH
#ifdef PACKED
fragmentOutputs.color=pack(input.position.z);
#else
fragmentOutputs.color= vec4f(input.position.z,0.0,0.0,0.0);
#endif
#else
#ifdef PACKED
fragmentOutputs.color=pack(input.vDepthMetric);
#else
fragmentOutputs.color= vec4f(input.vDepthMetric,0.0,0.0,1.0);
#endif
#endif
#endif
}`;g.ShadersStoreWGSL[hb]||(g.ShadersStoreWGSL[hb]=bN);oj={name:hb,shader:bN}});var af,yN=S(()=>{it();yt();Ut();Mn();Vn();ab();cb();Ii();rn();Xi();bo();af=class s{get shaderLanguage(){return this._shaderLanguage}setMaterialForRendering(e,t){this._depthMap.setMaterialForRendering(e,t)}constructor(e,t=1,i=null,r=!1,n=H.TRILINEAR_SAMPLINGMODE,a=!1,o,l){this._shaderLanguage=0,this.enabled=!0,this.forceDepthWriteTransparentMeshes=!1,this.useOnlyInActiveCamera=!1,this.reverseCulling=!1,this._shadersLoaded=!1,this._scene=e,this._storeNonLinearDepth=r,this._storeCameraSpaceZ=a,this.isPacked=t===0,this.isPacked?this.clearColor=new me(1,1,1,1):this.clearColor=new me(a?0:1,0,0,1),this._initShaderSourceAsync(),s._SceneComponentInitialization(this._scene);let c=e.getEngine();this._camera=i,n!==H.NEAREST_SAMPLINGMODE&&(t===1&&!c._caps.textureFloatLinearFiltering&&(n=H.NEAREST_SAMPLINGMODE),t===2&&!c._caps.textureHalfFloatLinearFiltering&&(n=H.NEAREST_SAMPLINGMODE));let f=this.isPacked||!c._features.supportExtendedTextureFormats?5:6;this._depthMap=l??new Gt(o??"DepthRenderer",{width:c.getRenderWidth(),height:c.getRenderHeight()},this._scene,!1,!0,t,!1,n,void 0,void 0,void 0,f),this._depthMap.wrapU=H.CLAMP_ADDRESSMODE,this._depthMap.wrapV=H.CLAMP_ADDRESSMODE,this._depthMap.refreshRate=1,this._depthMap.renderParticles=!1,this._depthMap.renderList=null,this._depthMap.noPrePassRenderer=!0,this._depthMap.activeCamera=this._camera,this._depthMap.ignoreCameraViewport=!0,this._depthMap.useCameraPostProcesses=!1,this._depthMap.onClearObservable.add(u=>{u.clear(this.clearColor,!0,!0,!0)}),this._depthMap.onBeforeBindObservable.add(()=>{c._debugPushGroup?.("depth renderer",1)}),this._depthMap.onAfterUnbindObservable.add(()=>{c._debugPopGroup?.(1)}),this._depthMap.customIsReadyFunction=(u,d,p)=>{if((p||d===0)&&u.subMeshes)for(let m=0;m<u.subMeshes.length;++m){let _=u.subMeshes[m],v=_.getRenderingMesh(),T=v._getInstancesRenderList(_._id,!!_.getReplacementMesh()),C=c.getCaps().instancedArrays&&(T.visibleInstances[_._id]!==null&&T.visibleInstances[_._id]!==void 0||v.hasThinInstances);if(!this.isReady(_,C))return!1}return!0};let h=u=>{let d=u.getRenderingMesh(),p=u.getEffectiveMesh(),m=this._scene,_=m.getEngine(),v=u.getMaterial();if(p._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!v||p.infiniteDistance||v.disableDepthWrite||u.verticesCount===0||u._renderId===m.getRenderId())return;let T=p._getWorldMatrixDeterminant()<0,C=v._getEffectiveOrientation(d);T&&(C=C===0?1:0);let I=C===0;_.setState(v.backFaceCulling,0,!1,I,this.reverseCulling?!v.cullBackFaces:v.cullBackFaces);let R=d._getInstancesRenderList(u._id,!!u.getReplacementMesh());if(R.mustReturn)return;let b=_.getCaps().instancedArrays&&(R.visibleInstances[u._id]!==null&&R.visibleInstances[u._id]!==void 0||d.hasThinInstances),M=this._camera||m.activeCamera;if(this.isReady(u,b)&&M){u._renderId=m.getRenderId();let F=p._internalAbstractMeshDataInfo._materialForRenderPass?.[_.currentRenderPassId],U=u._getDrawWrapper();!U&&F&&(U=F._getDrawWrapper());let D=M.mode===ye.ORTHOGRAPHIC_CAMERA;if(!U)return;let $=U.effect;_.enableEffect(U),b||d._bind(u,$,v.fillMode),F?F.bindForSubMesh(p.getWorldMatrix(),p,u):($.setMatrix("viewProjection",m.getTransformMatrix()),$.setMatrix("world",p.getWorldMatrix()),this._storeCameraSpaceZ&&$.setMatrix("view",m.getViewMatrix()));let oe,re;if(D?(oe=!_.useReverseDepthBuffer&&_.isNDCHalfZRange?0:1,re=_.useReverseDepthBuffer&&_.isNDCHalfZRange?0:1):(oe=_.useReverseDepthBuffer&&_.isNDCHalfZRange?M.minZ:_.isNDCHalfZRange?0:M.minZ,re=_.useReverseDepthBuffer&&_.isNDCHalfZRange?0:M.maxZ),$.setFloat2("depthValues",oe,oe+re),!F){if(v.needAlphaTestingForMesh(p)){let be=v.getAlphaTestTexture();be&&($.setTexture("diffuseSampler",be),$.setMatrix("diffuseMatrix",be.getTextureMatrix()))}Nn(d,$),zi($,v,m),lr(d,$),d.morphTargetManager&&d.morphTargetManager.isUsingTextureForTargets&&d.morphTargetManager._bind($);let se=u.getMesh().bakedVertexAnimationManager;se&&se.isEnabled&&se.bind($,b),v.pointsCloud&&$.setFloat("pointSize",v.pointSize)}d._processRendering(p,u,$,v.fillMode,R,b,(se,be)=>$.setMatrix("world",be))}};this._depthMap.customRenderFunction=(u,d,p,m)=>{let _;if(m.length)for(_=0;_<m.length;_++)h(m.data[_]);for(_=0;_<u.length;_++)h(u.data[_]);for(_=0;_<d.length;_++)h(d.data[_]);if(this.forceDepthWriteTransparentMeshes)for(_=0;_<p.length;_++)h(p.data[_]);else for(_=0;_<p.length;_++)p.data[_].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}}async _initShaderSourceAsync(e=!1){this._scene.getEngine().isWebGPU&&!e&&!s.ForceGLSL?(this._shaderLanguage=1,await Promise.all([Promise.resolve().then(()=>(RN(),AN)),Promise.resolve().then(()=>(IN(),CN))])):await Promise.all([Promise.resolve().then(()=>(cb(),EN)),Promise.resolve().then(()=>(ab(),pN))]),this._shadersLoaded=!0}isReady(e,t){if(!this._shadersLoaded)return!1;let i=this._scene.getEngine(),r=e.getMesh(),n=r.getScene(),a=r._internalAbstractMeshDataInfo._materialForRenderPass?.[i.currentRenderPassId];if(a)return a.isReadyForSubMesh(r,e,t);let o=e.getMaterial();if(!o||o.disableDepthWrite)return!1;let l=[],c=[A.PositionKind],f=!1,h=!1,u=!1;o.needAlphaTestingForMesh(r)&&o.getAlphaTestTexture()&&(l.push("#define ALPHATEST"),r.isVerticesDataPresent(A.UVKind)&&(c.push(A.UVKind),l.push("#define UV1"),f=!0),r.isVerticesDataPresent(A.UV2Kind)&&(c.push(A.UV2Kind),l.push("#define UV2"),h=!0));let d=new or;if(r.useBones&&r.computeBonesUsingShaders&&r.skeleton){c.push(A.MatricesIndicesKind),c.push(A.MatricesWeightsKind),r.numBoneInfluencers>4&&(c.push(A.MatricesIndicesExtraKind),c.push(A.MatricesWeightsExtraKind)),l.push("#define NUM_BONE_INFLUENCERS "+r.numBoneInfluencers),r.numBoneInfluencers>0&&d.addCPUSkinningFallback(0,r);let C=r.skeleton;C.isUsingTextureForMatrices?l.push("#define BONETEXTURE"):l.push("#define BonesPerMesh "+(C.bones.length+1))}else l.push("#define NUM_BONE_INFLUENCERS 0");let p=r.morphTargetManager?Fn(r.morphTargetManager,l,c,r,!0,!1,!1,f,h,u):0;o.pointsCloud&&l.push("#define POINTSIZE"),t&&(l.push("#define INSTANCES"),sn(c),e.getRenderingMesh().hasThinInstances&&l.push("#define THIN_INSTANCES"));let m=r.bakedVertexAnimationManager;m&&m.isEnabled&&(l.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),t&&c.push("bakedVertexAnimationSettingsInstanced")),this._storeNonLinearDepth&&l.push("#define NONLINEARDEPTH"),this._storeCameraSpaceZ&&l.push("#define STORE_CAMERASPACE_Z"),this.isPacked&&l.push("#define PACKED"),On(o,n,l);let _=e._getDrawWrapper(void 0,!0),v=_.defines,T=l.join(`
`);if(v!==T){let C=["world","mBones","boneTextureWidth","pointSize","viewProjection","view","diffuseMatrix","depthValues","morphTargetInfluences","morphTargetCount","morphTargetTextureInfo","morphTargetTextureIndices","bakedVertexAnimationSettings","bakedVertexAnimationTextureSizeInverted","bakedVertexAnimationTime","bakedVertexAnimationTexture"],I=["diffuseSampler","morphTargets","boneSampler","bakedVertexAnimationTexture"];Hi(C),_.setEffect(i.createEffect("depth",{attributes:c,uniformsNames:C,uniformBuffersNames:[],samplers:I,defines:T,fallbacks:d,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:p},shaderLanguage:this._shaderLanguage},i),T)}return _.effect.isReady()}getDepthMap(){return this._depthMap}dispose(){let e=[];for(let t in this._scene._depthRenderer)this._scene._depthRenderer[t]===this&&e.push(t);if(e.length>0){this._depthMap.dispose();for(let t of e)delete this._scene._depthRenderer[t]}}};af.ForceGLSL=!1;af._SceneComponentInitialization=s=>{throw pe("DepthRendererSceneComponent")}});var PN={};V(PN,{minmaxReduxPixelShaderWGSL:()=>lj});var ub,MN,lj,db=S(()=>{O();ub="minmaxReduxPixelShader",MN=`varying vUV: vec2f;var textureSampler: texture_2d<f32>;
#if defined(INITIAL)
uniform texSize: vec2f;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {let coord=vec2i(fragmentInputs.vUV*(uniforms.texSize-1.0));let f1=textureLoad(textureSampler,coord,0).r;let f2=textureLoad(textureSampler,coord+vec2i(1,0),0).r;let f3=textureLoad(textureSampler,coord+vec2i(1,1),0).r;let f4=textureLoad(textureSampler,coord+vec2i(0,1),0).r;
#ifdef DEPTH_REDUX
#ifdef VIEW_DEPTH
var minz=3.4e38;if (f1 != 0.0) { minz=f1; }
if (f2 != 0.0) { minz=min(minz,f2); }
if (f3 != 0.0) { minz=min(minz,f3); }
if (f4 != 0.0) { minz=min(minz,f4); }
let maxz=max(max(max(f1,f2),f3),f4);
#else
let minz=min(min(min(f1,f2),f3),f4);let maxz=max(max(max(sign(1.0-f1)*f1,sign(1.0-f2)*f2),sign(1.0-f3)*f3),sign(1.0-f4)*f4);
#endif
#else
let minz=min(min(min(f1,f2),f3),f4);let maxz=max(max(max(f1,f2),f3),f4);
#endif
fragmentOutputs.color=vec4f(minz,maxz,0.,0.);}
#elif defined(MAIN)
uniform texSize: vec2f;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {let coord=vec2i(fragmentInputs.vUV*(uniforms.texSize-1.0));let f1=textureLoad(textureSampler,coord,0).rg;let f2=textureLoad(textureSampler,coord+vec2i(1,0),0).rg;let f3=textureLoad(textureSampler,coord+vec2i(1,1),0).rg;let f4=textureLoad(textureSampler,coord+vec2i(0,1),0).rg;let minz=min(min(min(f1.x,f2.x),f3.x),f4.x);let maxz=max(max(max(f1.y,f2.y),f3.y),f4.y);fragmentOutputs.color=vec4(minz,maxz,0.,0.);}
#elif defined(ONEBEFORELAST)
uniform texSize: vec2i;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {let coord=vec2i(fragmentInputs.vUV*vec2f(uniforms.texSize-1));let f1=textureLoad(textureSampler,coord % uniforms.texSize,0).rg;let f2=textureLoad(textureSampler,(coord+vec2i(1,0)) % uniforms.texSize,0).rg;let f3=textureLoad(textureSampler,(coord+vec2i(1,1)) % uniforms.texSize,0).rg;let f4=textureLoad(textureSampler,(coord+vec2i(0,1)) % uniforms.texSize,0).rg;let minz=min(min(min(f1.x,f2.x),f3.x),f4.x);let maxz=max(max(max(f1.y,f2.y),f3.y),f4.y);fragmentOutputs.color=vec4(minz,maxz,0.,0.);}
#elif defined(LAST)
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=vec4f(0.);if (true) { 
discard;}}
#endif
`;g.ShadersStoreWGSL[ub]||(g.ShadersStoreWGSL[ub]=MN);lj={name:ub,shader:MN}});var ON={};V(ON,{minmaxReduxPixelShader:()=>cj});var pb,DN,cj,mb=S(()=>{O();pb="minmaxReduxPixelShader",DN=`varying vec2 vUV;uniform sampler2D textureSampler;
#if defined(INITIAL)
uniform vec2 texSize;void main(void)
{ivec2 coord=ivec2(vUV*(texSize-1.0));float f1=texelFetch(textureSampler,coord,0).r;float f2=texelFetch(textureSampler,coord+ivec2(1,0),0).r;float f3=texelFetch(textureSampler,coord+ivec2(1,1),0).r;float f4=texelFetch(textureSampler,coord+ivec2(0,1),0).r;
#ifdef DEPTH_REDUX
#ifdef VIEW_DEPTH
float minz=3.4e38;if (f1 != 0.0) { minz=f1; }
if (f2 != 0.0) { minz=min(minz,f2); }
if (f3 != 0.0) { minz=min(minz,f3); }
if (f4 != 0.0) { minz=min(minz,f4); }
float maxz=max(max(max(f1,f2),f3),f4);
#else
float minz=min(min(min(f1,f2),f3),f4);float maxz=max(max(max(sign(1.0-f1)*f1,sign(1.0-f2)*f2),sign(1.0-f3)*f3),sign(1.0-f4)*f4);
#endif
#else
float minz=min(min(min(f1,f2),f3),f4);float maxz=max(max(max(f1,f2),f3),f4);
#endif
glFragColor=vec4(minz,maxz,0.,0.);}
#elif defined(MAIN)
uniform vec2 texSize;void main(void)
{ivec2 coord=ivec2(vUV*(texSize-1.0));vec2 f1=texelFetch(textureSampler,coord,0).rg;vec2 f2=texelFetch(textureSampler,coord+ivec2(1,0),0).rg;vec2 f3=texelFetch(textureSampler,coord+ivec2(1,1),0).rg;vec2 f4=texelFetch(textureSampler,coord+ivec2(0,1),0).rg;float minz=min(min(min(f1.x,f2.x),f3.x),f4.x);float maxz=max(max(max(f1.y,f2.y),f3.y),f4.y);glFragColor=vec4(minz,maxz,0.,0.);}
#elif defined(ONEBEFORELAST)
uniform ivec2 texSize;void main(void)
{ivec2 coord=ivec2(vUV*vec2(texSize-1));vec2 f1=texelFetch(textureSampler,coord % texSize,0).rg;vec2 f2=texelFetch(textureSampler,(coord+ivec2(1,0)) % texSize,0).rg;vec2 f3=texelFetch(textureSampler,(coord+ivec2(1,1)) % texSize,0).rg;vec2 f4=texelFetch(textureSampler,(coord+ivec2(0,1)) % texSize,0).rg;float minz=min(min(min(f1.x,f2.x),f3.x),f4.x);float maxz=max(max(max(f1.y,f2.y),f3.y),f4.y);glFragColor=vec4(minz,maxz,0.,0.);}
#elif defined(LAST)
void main(void)
{glFragColor=vec4(0.);if (true) { 
discard;}}
#endif
`;g.ShadersStore[pb]||(g.ShadersStore[pb]=DN);cj={name:pb,shader:DN}});var LN,Wo,fj,hj,nn,of,_b=S(()=>{we();In();Sa();(function(s){s[s.NormalizedViewDepth=0]="NormalizedViewDepth",s[s.ViewDepth=1]="ViewDepth",s[s.ScreenDepth=2]="ScreenDepth"})(LN||(LN={}));Wo=class s extends ti{_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(()=>(db(),PN)))):t.push(Promise.resolve().then(()=>(mb(),ON)))}constructor(e,t=null,i="",r){super({...r,name:e,engine:t||ee.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:s.FragmentUrl,uniforms:s.Uniforms,defines:i}),this.textureWidth=0,this.textureHeight=0}bind(e=!1){super.bind(e);let t=this.drawWrapper.effect;this.textureWidth===1||this.textureHeight===1?t.setInt2("texSize",this.textureWidth,this.textureHeight):t.setFloat2("texSize",this.textureWidth,this.textureHeight)}};Wo.FragmentUrl="minmaxRedux";Wo.Uniforms=["texSize"];fj=new Float32Array(4),hj=new Uint8Array(4),nn={min:0,max:0},of=class{get depthRedux(){return this._depthRedux}set depthRedux(e){this._depthRedux!==e&&(this._depthRedux=e,this._recreatePostProcesses())}get textureWidth(){return this._textureWidth}get textureHeight(){return this._textureHeight}constructor(e,t=!0){this.onAfterReductionPerformed=new N,this._textureWidth=0,this._textureHeight=0,this._scene=e,this._depthRedux=t,this.reductionSteps=[]}setTextureDimensions(e,t,i=0){return e===this._textureWidth&&t===this._textureHeight&&i===this._depthTextureType?!1:(this._textureWidth=e,this._textureHeight=t,this._depthTextureType=i,this._recreatePostProcesses(),!0)}readMinMax(e){let t=e.type===ee.TEXTURETYPE_FLOAT||e.type===ee.TEXTURETYPE_HALF_FLOAT,i=t?fj:hj;this._scene.getEngine()._readTexturePixels(e,1,1,-1,0,i,!1),nn.min=i[0],nn.max=i[1],t||(nn.min=nn.min/255,nn.max=nn.max/255),nn.min>=nn.max&&(nn.min=0,nn.max=1),this.onAfterReductionPerformed.notifyObservers(nn)}dispose(e=!0){e&&(this.onAfterReductionPerformed.clear(),this._textureWidth=0,this._textureHeight=0);for(let t=0;t<this.reductionSteps.length;++t)this.reductionSteps[t].dispose();this.reductionSteps.length=0}_recreatePostProcesses(){this.dispose(!1);let e=this._scene,t=this.textureWidth,i=this.textureHeight,r=new Wo("Initial reduction phase",e.getEngine(),"#define INITIAL"+(this._depthRedux?`
#define DEPTH_REDUX`:"")+(this._depthTextureType===1?`
#define VIEW_DEPTH`:""));r.textureWidth=t,r.textureHeight=i,this.reductionSteps.push(r);let n=1;for(;t>1||i>1;){t=Math.max(Math.round(t/2),1),i=Math.max(Math.round(i/2),1);let a=new Wo("Reduction phase "+n,e.getEngine(),"#define "+(t==1&&i==1?"LAST":t==1||i==1?"ONEBEFORELAST":"MAIN"));a.textureWidth=t,a.textureHeight=i,this.reductionSteps.push(a),n++}}}});var Fm,wN=S(()=>{Wr();Wp();_b();mb();db();Fm=class{get onAfterReductionPerformed(){return this._thinMinMaxReducer.onAfterReductionPerformed}constructor(e){this._onAfterUnbindObserver=null,this._forceFullscreenViewport=!0,this._activated=!1,this._camera=e,this._postProcessManager=new va(e.getScene()),this._thinMinMaxReducer=new of(e.getScene()),this._reductionSteps=[],this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add(()=>{this._postProcessManager._rebuild()})}get sourceTexture(){return this._sourceTexture}setSourceTexture(e,t,i=2,r=!0){if(e!==this._sourceTexture&&(this._thinMinMaxReducer.depthRedux=t,this.deactivate(),this._sourceTexture=e,this._forceFullscreenViewport=r,this._thinMinMaxReducer.setTextureDimensions(e.getRenderWidth(),e.getRenderHeight()))){this._disposePostProcesses();let n=this._thinMinMaxReducer.reductionSteps;for(let a=0;a<n.length;++a){let o=n[a],l=new at(o.name,Wo.FragmentUrl,{effectWrapper:o,samplingMode:1,engine:this._camera.getScene().getEngine(),textureType:i,textureFormat:7,size:{width:o.textureWidth,height:o.textureHeight}});this._reductionSteps.push(l),l.autoClear=!1,l.forceFullscreenViewport=r,a===0&&(l.externalTextureSamplerBinding=!0,l.onApplyObservable.add(c=>{c.setTexture("textureSampler",this._sourceTexture)})),a===n.length-1&&this._reductionSteps[a-1].onAfterRenderObservable.add(()=>{this._thinMinMaxReducer.readMinMax(l.inputTexture.texture)})}}}get refreshRate(){return this._sourceTexture?this._sourceTexture.refreshRate:-1}set refreshRate(e){this._sourceTexture&&(this._sourceTexture.refreshRate=e)}get activated(){return this._activated}activate(){this._onAfterUnbindObserver||!this._sourceTexture||(this._onAfterUnbindObserver=this._sourceTexture.onAfterUnbindObservable.add(()=>{let e=this._camera.getScene().getEngine();e._debugPushGroup?.("min max reduction",1),this._reductionSteps[0].activate(this._camera),this._postProcessManager.directRender(this._reductionSteps,this._reductionSteps[0].inputTexture,this._forceFullscreenViewport,0,0,!0,this._reductionSteps.length-1),e.unBindFramebuffer(this._reductionSteps[this._reductionSteps.length-1].inputTexture,!1),e._debugPopGroup?.(1)}),this._activated=!0)}deactivate(){!this._onAfterUnbindObserver||!this._sourceTexture||(this._sourceTexture.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=null,this._activated=!1)}dispose(e=!0){e&&(this.onAfterReductionPerformed.clear(),this._camera.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=void 0,this._disposePostProcesses(),this._postProcessManager.dispose(),this._postProcessManager=void 0,this._thinMinMaxReducer.dispose(),this._thinMinMaxReducer=void 0,this._sourceTexture=null)}_disposePostProcesses(){for(let e=0;e<this._reductionSteps.length;++e)this._reductionSteps[e].dispose();this._reductionSteps.length=0}}});var Nm,FN=S(()=>{yN();wN();Nm=class extends Fm{get depthRenderer(){return this._depthRenderer}constructor(e){super(e)}setDepthRenderer(e=null,t=2,i=!0){let r=this._camera.getScene();this._depthRenderer&&(delete r._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null),e===null&&(r._depthRenderer||(r._depthRenderer={}),this._depthRendererId="minmax_"+this._camera.id,e=this._depthRenderer=new af(r,t,this._camera,!1,1,!1,`DepthRenderer ${this._depthRendererId}`),e.enabled=!1,r._depthRenderer[this._depthRendererId]=e),super.setSourceTexture(e.getDepthMap(),!0,t,i)}setSourceTexture(e,t,i=2,r=!0){super.setSourceTexture(e,t,i,r)}activate(){this._depthRenderer&&(this._depthRenderer.enabled=!0),super.activate()}deactivate(){super.deactivate(),this._depthRenderer&&(this._depthRenderer.enabled=!1)}dispose(e=!0){super.dispose(e),this._depthRenderer&&e&&(this._depthRenderer.dispose(),this._depthRenderer=null)}}});var NN,uj,fi,lf,Bm,zr,gb=S(()=>{ie();Mn();Ii();Qh();Pl();FN();Ee();gt();NN=E.Up(),uj=E.Zero(),fi=new E,lf=new E,Bm=new B,zr=class s extends vt{_validateFilter(e){return e===vt.FILTER_NONE||e===vt.FILTER_PCF||e===vt.FILTER_PCSS?e:(P.Error('Unsupported filter "'+e+'"!'),vt.FILTER_NONE)}get numCascades(){return this._numCascades}set numCascades(e){e=Math.min(Math.max(e,s.MIN_CASCADES_COUNT),s.MAX_CASCADES_COUNT),e!==this._numCascades&&(this._numCascades=e,this.recreateShadowMap(),this._recreateSceneUBOs())}get freezeShadowCastersBoundingInfo(){return this._freezeShadowCastersBoundingInfo}set freezeShadowCastersBoundingInfo(e){this._freezeShadowCastersBoundingInfoObservable&&e&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),!this._freezeShadowCastersBoundingInfoObservable&&!e&&(this._freezeShadowCastersBoundingInfoObservable=this._scene.onBeforeRenderObservable.add(()=>this._computeShadowCastersBoundingInfo())),this._freezeShadowCastersBoundingInfo=e,e&&this._computeShadowCastersBoundingInfo()}_computeShadowCastersBoundingInfo(){if(this._scbiMin.copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._scbiMax.copyFromFloats(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),this._shadowMap&&this._shadowMap.renderList){let e=this._shadowMap.renderList;for(let t=0;t<e.length;t++){let i=e[t];if(!i)continue;let r=i.getBoundingInfo(),n=r.boundingBox;this._scbiMin.minimizeInPlace(n.minimumWorld),this._scbiMax.maximizeInPlace(n.maximumWorld)}}this._shadowCastersBoundingInfo.reConstruct(this._scbiMin,this._scbiMax)}get shadowCastersBoundingInfo(){return this._shadowCastersBoundingInfo}set shadowCastersBoundingInfo(e){this._shadowCastersBoundingInfo=e}setMinMaxDistance(e,t){this._minDistance===e&&this._maxDistance===t||(e>t&&(e=0,t=1),e<0&&(e=0),t>1&&(t=1),this._minDistance=e,this._maxDistance=t,this._breaksAreDirty=!0)}get minDistance(){return this._minDistance}get maxDistance(){return this._maxDistance}getClassName(){return s.CLASSNAME}getCascadeMinExtents(e){return e>=0&&e<this._numCascades?this._cascadeMinExtents[e]:null}getCascadeMaxExtents(e){return e>=0&&e<this._numCascades?this._cascadeMaxExtents[e]:null}get shadowMaxZ(){return this._getCamera()?this._shadowMaxZ:0}set shadowMaxZ(e){let t=this._getCamera();if(!t){this._shadowMaxZ=e;return}this._shadowMaxZ===e||e<t.minZ||e>t.maxZ&&t.maxZ!==0||(this._shadowMaxZ=e,this._light._markMeshesAsLightDirty(),this._breaksAreDirty=!0)}get debug(){return this._debug}set debug(e){this._debug=e,this._light._markMeshesAsLightDirty()}get depthClamp(){return this._depthClamp}set depthClamp(e){this._depthClamp=e}get cascadeBlendPercentage(){return this._cascadeBlendPercentage}set cascadeBlendPercentage(e){this._cascadeBlendPercentage=e,this._light._markMeshesAsLightDirty()}get lambda(){return this._lambda}set lambda(e){let t=Math.min(Math.max(e,0),1);this._lambda!=t&&(this._lambda=t,this._breaksAreDirty=!0)}getCascadeViewMatrix(e){return e>=0&&e<this._numCascades?this._viewMatrices[e]:null}getCascadeProjectionMatrix(e){return e>=0&&e<this._numCascades?this._projectionMatrices[e]:null}getCascadeTransformMatrix(e){return e>=0&&e<this._numCascades?this._transformMatrices[e]:null}setDepthRenderer(e){this._depthRenderer=e,this._depthReducer&&this._depthReducer.setDepthRenderer(this._depthRenderer)}get autoCalcDepthBounds(){return this._autoCalcDepthBounds}set autoCalcDepthBounds(e){let t=this._getCamera();if(t){if(this._autoCalcDepthBounds=e,!e){this._depthReducer&&this._depthReducer.deactivate(),this.setMinMaxDistance(0,1);return}this._depthReducer||(this._depthReducer=new Nm(t),this._depthReducer.onAfterReductionPerformed.add(i=>{let r=i.min,n=i.max;r>=n&&(r=0,n=1),(r!=this._minDistance||n!=this._maxDistance)&&this.setMinMaxDistance(r,n)}),this._depthReducer.setDepthRenderer(this._depthRenderer)),this._depthReducer.activate()}}get autoCalcDepthBoundsRefreshRate(){return this._depthReducer?.depthRenderer?.getDepthMap().refreshRate??-1}set autoCalcDepthBoundsRefreshRate(e){this._depthReducer?.depthRenderer&&(this._depthReducer.depthRenderer.getDepthMap().refreshRate=e)}splitFrustum(){this._breaksAreDirty=!0}_splitFrustum(){let e=this._getCamera();if(!e)return;let t=e.minZ,i=e.maxZ||this._shadowMaxZ,r=i-t,n=this._minDistance,a=this._shadowMaxZ<i&&this._shadowMaxZ>=t?Math.min((this._shadowMaxZ-t)/(i-t),this._maxDistance):this._maxDistance,o=t+n*r,l=t+a*r,c=l-o,f=l/o;for(let h=0;h<this._cascades.length;++h){let u=(h+1)/this._numCascades,d=o*f**u,p=o+c*u,m=this._lambda*(d-p)+p;this._cascades[h].prevBreakDistance=h===0?n:this._cascades[h-1].breakDistance,this._cascades[h].breakDistance=(m-t)/r,this._viewSpaceFrustumsZ[h]=m,this._frustumLengths[h]=(this._cascades[h].breakDistance-this._cascades[h].prevBreakDistance)*r}this._breaksAreDirty=!1}_computeMatrices(){let e=this._scene;if(!this._getCamera())return;E.NormalizeToRef(this._light.getShadowDirection(0),this._lightDirection),Math.abs(E.Dot(this._lightDirection,E.Up()))===1&&(this._lightDirection.z=1e-13),this._cachedDirection.copyFrom(this._lightDirection);let i=e.getEngine().useReverseDepthBuffer;for(let r=0;r<this._numCascades;++r){this._computeFrustumInWorldSpace(r),this._computeCascadeFrustum(r),this._cascadeMaxExtents[r].subtractToRef(this._cascadeMinExtents[r],fi),this._frustumCenter[r].addToRef(this._lightDirection.scale(this._cascadeMinExtents[r].z),this._shadowCameraPos[r]),B.LookAtLHToRef(this._shadowCameraPos[r],this._frustumCenter[r],NN,this._viewMatrices[r]);let n=0,a=fi.z,o=this._shadowCastersBoundingInfo;o.update(this._viewMatrices[r]);let l=o.boundingBox.minimumWorld.z,c=o.boundingBox.maximumWorld.z;l>a||(!this._depthClamp||this.filter===vt.FILTER_PCSS?(n=Math.min(n,l),this.filter!==vt.FILTER_PCSS&&(a=Math.min(a,c))):(a=Math.min(a,c),n=Math.max(n,l),a=Math.max(n+1,a))),B.OrthoOffCenterLHToRef(this._cascadeMinExtents[r].x,this._cascadeMaxExtents[r].x,this._cascadeMinExtents[r].y,this._cascadeMaxExtents[r].y,i?a:n,i?n:a,this._projectionMatrices[r],e.getEngine().isNDCHalfZRange),this._cascadeMinExtents[r].z=n,this._cascadeMaxExtents[r].z=a,this._viewMatrices[r].multiplyToRef(this._projectionMatrices[r],this._transformMatrices[r]),E.TransformCoordinatesToRef(uj,this._transformMatrices[r],fi),fi.scaleInPlace(this._mapSize/2),lf.copyFromFloats(Math.round(fi.x),Math.round(fi.y),Math.round(fi.z)),lf.subtractInPlace(fi).scaleInPlace(2/this._mapSize),B.TranslationToRef(lf.x,lf.y,0,Bm),this._projectionMatrices[r].multiplyToRef(Bm,this._projectionMatrices[r]),this._viewMatrices[r].multiplyToRef(this._projectionMatrices[r],this._transformMatrices[r]),this._transformMatrices[r].copyToArray(this._transformMatricesAsArray,r*16)}}_computeFrustumInWorldSpace(e){let t=this._getCamera();if(!t)return;let i=this._cascades[e].prevBreakDistance,r=this._cascades[e].breakDistance,n=this._scene.getEngine().isNDCHalfZRange;t.getViewMatrix();let a=t.maxZ===0,o=t.maxZ;a&&(t.maxZ=this._shadowMaxZ,t.getProjectionMatrix(!0));let l=B.Invert(t.getTransformationMatrix());a&&(t.maxZ=o,t.getProjectionMatrix(!0));let c=this._scene.getEngine().useReverseDepthBuffer?4:0;for(let f=0;f<s._FrustumCornersNdcSpace.length;++f)fi.copyFrom(s._FrustumCornersNdcSpace[(f+c)%s._FrustumCornersNdcSpace.length]),n&&fi.z===-1&&(fi.z=0),E.TransformCoordinatesToRef(fi,l,this._frustumCornersWorldSpace[e][f]);for(let f=0;f<s._FrustumCornersNdcSpace.length/2;++f)fi.copyFrom(this._frustumCornersWorldSpace[e][f+4]).subtractInPlace(this._frustumCornersWorldSpace[e][f]),lf.copyFrom(fi).scaleInPlace(i),fi.scaleInPlace(r),fi.addInPlace(this._frustumCornersWorldSpace[e][f]),this._frustumCornersWorldSpace[e][f+4].copyFrom(fi),this._frustumCornersWorldSpace[e][f].addInPlace(lf)}_computeCascadeFrustum(e){if(this._cascadeMinExtents[e].copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cascadeMaxExtents[e].copyFromFloats(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),this._frustumCenter[e].copyFromFloats(0,0,0),!!this._getCamera()){for(let i=0;i<this._frustumCornersWorldSpace[e].length;++i)this._frustumCenter[e].addInPlace(this._frustumCornersWorldSpace[e][i]);if(this._frustumCenter[e].scaleInPlace(1/this._frustumCornersWorldSpace[e].length),this.stabilizeCascades){let i=0;for(let r=0;r<this._frustumCornersWorldSpace[e].length;++r){let n=this._frustumCornersWorldSpace[e][r].subtractToRef(this._frustumCenter[e],fi).length();i=Math.max(i,n)}i=Math.ceil(i*16)/16,this._cascadeMaxExtents[e].copyFromFloats(i,i,i),this._cascadeMinExtents[e].copyFromFloats(-i,-i,-i)}else{let i=this._frustumCenter[e];this._frustumCenter[e].addToRef(this._lightDirection,fi),B.LookAtLHToRef(i,fi,NN,Bm);for(let r=0;r<this._frustumCornersWorldSpace[e].length;++r)E.TransformCoordinatesToRef(this._frustumCornersWorldSpace[e][r],Bm,fi),this._cascadeMinExtents[e].minimizeInPlace(fi),this._cascadeMaxExtents[e].maximizeInPlace(fi)}}}_recreateSceneUBOs(){if(this._disposeSceneUBOs(),this._sceneUBOs)for(let e=0;e<this._numCascades;++e)this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for CSM Shadow Generator (light "${this._light.name}" cascade #${e})`))}static get IsSupported(){let e=Z.LastCreatedEngine;return e?e._features.supportCSM:!1}constructor(e,t,i,r,n=!0){if(!s.IsSupported){P.Error("CascadedShadowMap is not supported by the current engine.");return}super(e,t,i,r,n),this.usePercentageCloserFiltering=!0}_initializeGenerator(){this.penumbraDarkness=this.penumbraDarkness??1,this._numCascades=this._numCascades??s.DEFAULT_CASCADES_COUNT,this.stabilizeCascades=this.stabilizeCascades??!1,this._freezeShadowCastersBoundingInfoObservable=this._freezeShadowCastersBoundingInfoObservable??null,this.freezeShadowCastersBoundingInfo=this.freezeShadowCastersBoundingInfo??!1,this._scbiMin=this._scbiMin??new E(0,0,0),this._scbiMax=this._scbiMax??new E(0,0,0),this._shadowCastersBoundingInfo=this._shadowCastersBoundingInfo??new Ei(new E(0,0,0),new E(0,0,0)),this._breaksAreDirty=this._breaksAreDirty??!0,this._minDistance=this._minDistance??0,this._maxDistance=this._maxDistance??1,this._currentLayer=this._currentLayer??0,this._shadowMaxZ=this._shadowMaxZ??this._getCamera()?.maxZ??1e4,this._debug=this._debug??!1,this._depthClamp=this._depthClamp??!0,this._cascadeBlendPercentage=this._cascadeBlendPercentage??.1,this._lambda=this._lambda??.5,this._autoCalcDepthBounds=this._autoCalcDepthBounds??!1,this._recreateSceneUBOs(),super._initializeGenerator()}_createTargetRenderTexture(){let e=this._scene.getEngine();this._shadowMap?.dispose();let t={width:this._mapSize,height:this._mapSize,layers:this.numCascades};this._shadowMap=new Gt(this._light.name+"_CSMShadowMap",t,this._scene,!1,!0,this._textureType,!1,void 0,!1,!1,void 0,this._useRedTextureType?6:5),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0,void 0,void 0,void 0,`DepthStencilForCSMShadowGenerator-${this._light.name}`),this._shadowMap.noPrePassRenderer=!0}_initializeShadowMap(){if(super._initializeShadowMap(),this._shadowMap===null)return;this._transformMatricesAsArray=new Float32Array(this._numCascades*16),this._viewSpaceFrustumsZ=new Array(this._numCascades),this._frustumLengths=new Array(this._numCascades),this._lightSizeUVCorrection=new Array(this._numCascades*2),this._depthCorrection=new Array(this._numCascades),this._cascades=[],this._viewMatrices=[],this._projectionMatrices=[],this._transformMatrices=[],this._cascadeMinExtents=[],this._cascadeMaxExtents=[],this._frustumCenter=[],this._shadowCameraPos=[],this._frustumCornersWorldSpace=[];for(let t=0;t<this._numCascades;++t){this._cascades[t]={prevBreakDistance:0,breakDistance:0},this._viewMatrices[t]=B.Zero(),this._projectionMatrices[t]=B.Zero(),this._transformMatrices[t]=B.Zero(),this._cascadeMinExtents[t]=new E,this._cascadeMaxExtents[t]=new E,this._frustumCenter[t]=new E,this._shadowCameraPos[t]=new E,this._frustumCornersWorldSpace[t]=new Array(s._FrustumCornersNdcSpace.length);for(let i=0;i<s._FrustumCornersNdcSpace.length;++i)this._frustumCornersWorldSpace[t][i]=new E}let e=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.clear(),this._shadowMap.onBeforeRenderObservable.clear(),this._shadowMap.onBeforeRenderObservable.add(t=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[t]),this._currentLayer=t,this._filter===vt.FILTER_PCF&&e.setColorWrite(!1),this._scene.setTransformMatrix(this.getCascadeViewMatrix(t),this.getCascadeProjectionMatrix(t)),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())}),this._shadowMap.onBeforeBindObservable.add(()=>{this._currentSceneUBO=this._scene.getSceneUniformBuffer(),e._debugPushGroup?.(`cascaded shadow map generation for pass id ${e.currentRenderPassId}`,1),this._breaksAreDirty&&this._splitFrustum(),this._computeMatrices()}),this._splitFrustum()}_bindCustomEffectForRenderSubMeshForShadowMap(e,t){t.setMatrix("viewProjection",this.getCascadeTransformMatrix(this._currentLayer))}_isReadyCustomDefines(e){e.push("#define SM_DEPTHCLAMP "+(this._depthClamp&&this._filter!==vt.FILTER_PCSS?"1":"0"))}prepareDefines(e,t){super.prepareDefines(e,t);let i=this._scene,r=this._light;if(!i.shadowsEnabled||!r.shadowEnabled)return;e["SHADOWCSM"+t]=!0,e["SHADOWCSMDEBUG"+t]=this.debug,e["SHADOWCSMNUM_CASCADES"+t]=this.numCascades,e["SHADOWCSM_RIGHTHANDED"+t]=i.useRightHandedSystem;let n=this._getCamera();n&&this._shadowMaxZ<=(n.maxZ||this._shadowMaxZ)&&(e["SHADOWCSMUSESHADOWMAXZ"+t]=!0),this.cascadeBlendPercentage===0&&(e["SHADOWCSMNOBLEND"+t]=!0)}bindShadowLight(e,t){let i=this._light;if(!this._scene.shadowsEnabled||!i.shadowEnabled)return;let n=this._getCamera();if(!n)return;let a=this.getShadowMap();if(!a)return;let o=a.getSize().width;if(t.setMatrices("lightMatrix"+e,this._transformMatricesAsArray),t.setArray("viewFrustumZ"+e,this._viewSpaceFrustumsZ),t.setFloat("cascadeBlendFactor"+e,this.cascadeBlendPercentage===0?1e4:1/this.cascadeBlendPercentage),t.setArray("frustumLengths"+e,this._frustumLengths),this._filter===vt.FILTER_PCF)t.setDepthStencilTexture("shadowTexture"+e,a),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),o,1/o,this.frustumEdgeFalloff,e);else if(this._filter===vt.FILTER_PCSS){for(let l=0;l<this._numCascades;++l)this._lightSizeUVCorrection[l*2+0]=l===0?1:(this._cascadeMaxExtents[0].x-this._cascadeMinExtents[0].x)/(this._cascadeMaxExtents[l].x-this._cascadeMinExtents[l].x),this._lightSizeUVCorrection[l*2+1]=l===0?1:(this._cascadeMaxExtents[0].y-this._cascadeMinExtents[0].y)/(this._cascadeMaxExtents[l].y-this._cascadeMinExtents[l].y),this._depthCorrection[l]=l===0?1:(this._cascadeMaxExtents[l].z-this._cascadeMinExtents[l].z)/(this._cascadeMaxExtents[0].z-this._cascadeMinExtents[0].z);t.setDepthStencilTexture("shadowTexture"+e,a),t.setTexture("depthTexture"+e,a),t.setArray2("lightSizeUVCorrection"+e,this._lightSizeUVCorrection),t.setArray("depthCorrection"+e,this._depthCorrection),t.setFloat("penumbraDarkness"+e,this.penumbraDarkness),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/o,this._contactHardeningLightSizeUVRatio*o,this.frustumEdgeFalloff,e)}else t.setTexture("shadowTexture"+e,a),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),o,1/o,this.frustumEdgeFalloff,e);i._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(n),this.getLight().getDepthMinZ(n)+this.getLight().getDepthMaxZ(n),e)}getTransformMatrix(){return this.getCascadeTransformMatrix(0)}dispose(){super.dispose(),this._freezeShadowCastersBoundingInfoObservable&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),this._depthReducer&&(this._depthReducer.dispose(),this._depthReducer=null)}serialize(){let e=super.serialize(),t=this.getShadowMap();if(!t)return e;if(e.numCascades=this._numCascades,e.debug=this._debug,e.stabilizeCascades=this.stabilizeCascades,e.lambda=this._lambda,e.cascadeBlendPercentage=this.cascadeBlendPercentage,e.depthClamp=this._depthClamp,e.autoCalcDepthBounds=this.autoCalcDepthBounds,e.shadowMaxZ=this._shadowMaxZ,e.penumbraDarkness=this.penumbraDarkness,e.freezeShadowCastersBoundingInfo=this._freezeShadowCastersBoundingInfo,e.minDistance=this.minDistance,e.maxDistance=this.maxDistance,e.renderList=[],t.renderList)for(let i=0;i<t.renderList.length;i++){let r=t.renderList[i];e.renderList.push(r.id)}return e}static Parse(e,t){let i=vt.Parse(e,t,(r,n,a)=>new s(r,n,void 0,a));return e.numCascades!==void 0&&(i.numCascades=e.numCascades),e.debug!==void 0&&(i.debug=e.debug),e.stabilizeCascades!==void 0&&(i.stabilizeCascades=e.stabilizeCascades),e.lambda!==void 0&&(i.lambda=e.lambda),e.cascadeBlendPercentage!==void 0&&(i.cascadeBlendPercentage=e.cascadeBlendPercentage),e.depthClamp!==void 0&&(i.depthClamp=e.depthClamp),e.autoCalcDepthBounds!==void 0&&(i.autoCalcDepthBounds=e.autoCalcDepthBounds),e.shadowMaxZ!==void 0&&(i.shadowMaxZ=e.shadowMaxZ),e.penumbraDarkness!==void 0&&(i.penumbraDarkness=e.penumbraDarkness),e.freezeShadowCastersBoundingInfo!==void 0&&(i.freezeShadowCastersBoundingInfo=e.freezeShadowCastersBoundingInfo),e.minDistance!==void 0&&e.maxDistance!==void 0&&i.setMinMaxDistance(e.minDistance,e.maxDistance),i}};zr._FrustumCornersNdcSpace=[new E(-1,1,-1),new E(1,1,-1),new E(1,-1,-1),new E(-1,-1,-1),new E(-1,1,1),new E(1,1,1),new E(1,-1,1),new E(-1,-1,1)];zr.CLASSNAME="CascadedShadowGenerator";zr.DEFAULT_CASCADES_COUNT=4;zr.MIN_CASCADES_COUNT=2;zr.MAX_CASCADES_COUNT=4;zr._SceneComponentInitialization=s=>{throw pe("ShadowGeneratorSceneComponent")}});var Um,BN=S(()=>{Aa();Qh();Um=class extends Wi{get light(){return this._light}set light(e){e!==this._light&&(this._light=e,this._setupShadowGenerator())}get camera(){return this._camera}set camera(e){this._camera=e,this._setupShadowGenerator()}get mapSize(){return this._mapSize}set mapSize(e){e!==this._mapSize&&(this._mapSize=e,this._setupShadowGenerator())}get useFloat32TextureType(){return this._useFloat32TextureType}set useFloat32TextureType(e){e!==this._useFloat32TextureType&&(this._useFloat32TextureType=e,this._setupShadowGenerator())}get useRedTextureFormat(){return this._useRedTextureFormat}set useRedTextureFormat(e){e!==this._useRedTextureFormat&&(this._useRedTextureFormat=e,this._setupShadowGenerator())}get bias(){return this._bias}set bias(e){e!==this._bias&&(this._bias=e,this._shadowGenerator&&(this._shadowGenerator.bias=e))}get normalBias(){return this._normalBias}set normalBias(e){e!==this._normalBias&&(this._normalBias=e,this._shadowGenerator&&(this._shadowGenerator.normalBias=e))}get darkness(){return this._darkness}set darkness(e){e!==this._darkness&&(this._darkness=e,this._shadowGenerator&&(this._shadowGenerator.darkness=e))}get transparencyShadow(){return this._transparencyShadow}set transparencyShadow(e){e!==this._transparencyShadow&&(this._transparencyShadow=e,this._shadowGenerator&&(this._shadowGenerator.transparencyShadow=e))}get enableSoftTransparentShadow(){return this._enableSoftTransparentShadow}set enableSoftTransparentShadow(e){e!==this._enableSoftTransparentShadow&&(this._enableSoftTransparentShadow=e,this._shadowGenerator&&(this._shadowGenerator.enableSoftTransparentShadow=e))}get useOpacityTextureForTransparentShadow(){return this._useOpacityTextureForTransparentShadow}set useOpacityTextureForTransparentShadow(e){e!==this._useOpacityTextureForTransparentShadow&&(this._useOpacityTextureForTransparentShadow=e,this._shadowGenerator&&(this._shadowGenerator.useOpacityTextureForTransparentShadow=e))}get filter(){return this._filter}set filter(e){e!==this._filter&&(this._filter=e,this._shadowGenerator&&(this._shadowGenerator.filter=e))}get filteringQuality(){return this._filteringQuality}set filteringQuality(e){e!==this._filteringQuality&&(this._filteringQuality=e,this._shadowGenerator&&(this._shadowGenerator.filteringQuality=e))}_createShadowGenerator(){this._shadowGenerator=new vt(this._mapSize,this._light,this._useFloat32TextureType,void 0,this._useRedTextureFormat)}_setupShadowGenerator(){if(this._shadowGenerator?.dispose(),this._shadowGenerator=void 0,this._light!==void 0){this._createShadowGenerator();let e=this._shadowGenerator;if(e===void 0)return;e.bias=this._bias,e.normalBias=this._normalBias,e.darkness=this._darkness,e.transparencyShadow=this._transparencyShadow,e.enableSoftTransparentShadow=this._enableSoftTransparentShadow,e.useOpacityTextureForTransparentShadow=this._useOpacityTextureForTransparentShadow,e.filter=this._filter,e.filteringQuality=this._filteringQuality;let t=e.getShadowMap();t._disableEngineStages=!0,t.cameraForLOD=this._camera,this.shadowGenerator=e}}isReady(){return!!this._shadowGenerator&&!!this._shadowGenerator.getShadowMap()?.isReadyForRendering()}constructor(e,t,i){super(e,t),this._mapSize=1024,this._useFloat32TextureType=!1,this._useRedTextureFormat=!0,this._bias=.01,this._normalBias=0,this._darkness=0,this._transparencyShadow=!1,this._enableSoftTransparentShadow=!1,this._useOpacityTextureForTransparentShadow=!1,this._filter=vt.FILTER_PCF,this._filteringQuality=vt.QUALITY_HIGH,this.outputTexture=this._frameGraph.textureManager.createDanglingHandle()}record(){if(this.light===void 0||this.objectList===void 0||this.camera===void 0)throw new Error(`FrameGraphShadowGeneratorTask ${this.name}: light, objectList and camera are required`);let e=this._shadowGenerator.getShadowMap();e.renderList=this.objectList.meshes,e.particleSystemList=this.objectList.particleSystems;let t=this._frameGraph.textureManager.importTexture(`${this.name} shadowmap`,this._shadowGenerator.getShadowMap().getInternalTexture());this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,t),this._frameGraph.addPass(this.name).setExecuteFunc(n=>{if(!this.light.isEnabled()||!this.light.shadowEnabled)return;let a=this._shadowGenerator.getShadowMap();a.renderList=this.objectList.meshes,a.particleSystemList=this.objectList.particleSystems,n.saveDepthStates(),n.setDepthStates(!0,!0),n.renderUnmanaged(a),n.restoreDepthStates()}),this._frameGraph.addPass(this.name+"_disabled",!0).setExecuteFunc(n=>{})}dispose(){this._shadowGenerator?.dispose(),this._shadowGenerator=void 0}}});var Ds,Gm=S(()=>{Ye();je();ie();Dn();Ph();Ds=class extends Ke{constructor(){super(...arguments),this._needProjectionMatrixCompute=!0,this._viewMatrix=B.Identity(),this._projectionMatrix=B.Identity()}_setPosition(e){this._position=e}get position(){return this._position}set position(e){this._setPosition(e)}_setDirection(e){this._direction=e}get direction(){return this._direction}set direction(e){this._setDirection(e)}get shadowMinZ(){return this._shadowMinZ}set shadowMinZ(e){this._shadowMinZ=e,this.forceProjectionMatrixCompute()}get shadowMaxZ(){return this._shadowMaxZ}set shadowMaxZ(e){this._shadowMaxZ=e,this.forceProjectionMatrixCompute()}computeTransformedInformation(){return this.parent&&this.parent.getWorldMatrix?(this.transformedPosition||(this.transformedPosition=E.Zero()),E.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this.transformedPosition),this.direction&&(this.transformedDirection||(this.transformedDirection=E.Zero()),E.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this.transformedDirection)),!0):!1}getDepthScale(){return 50}getShadowDirection(e){return this.transformedDirection?this.transformedDirection:this.direction}getAbsolutePosition(){return this.transformedPosition?this.transformedPosition:this.position}setDirectionToTarget(e){return this.direction=E.Normalize(e.subtract(this.position)),this.direction}getRotation(){this.direction.normalize();let e=E.Cross(this.direction,Ms.Y),t=E.Cross(e,this.direction);return E.RotationFromAxis(e,t,this.direction)}needCube(){return!1}needProjectionMatrixCompute(){return this._needProjectionMatrixCompute}forceProjectionMatrixCompute(){this._needProjectionMatrixCompute=!0}_initCache(){super._initCache(),this._cache.position=E.Zero()}_isSynchronized(){return!!this._cache.position.equals(this.position)}computeWorldMatrix(e){return!e&&this.isSynchronized()?(this._currentRenderId=this.getScene().getRenderId(),this._worldMatrix):(this._updateCache(),this._cache.position.copyFrom(this.position),this._worldMatrix||(this._worldMatrix=B.Identity()),B.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this.parent&&this.parent.getWorldMatrix&&(this._worldMatrix.multiplyToRef(this.parent.getWorldMatrix(),this._worldMatrix),this._markSyncedWithParent()),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix)}getDepthMinZ(e){return this.shadowMinZ!==void 0?this.shadowMinZ:e?.minZ||0}getDepthMaxZ(e){return this.shadowMaxZ!==void 0?this.shadowMaxZ:e?.maxZ||1e4}setShadowProjectionMatrix(e,t,i){return this.customProjectionMatrixBuilder?this.customProjectionMatrixBuilder(t,i,e):this._setDefaultShadowProjectionMatrix(e,t,i),this}_syncParentEnabledState(){super._syncParentEnabledState(),(!this.parent||!this.parent.getWorldMatrix)&&(this.transformedPosition=null,this.transformedDirection=null)}getViewMatrix(e){let t=w.Vector3[0],i=this.position;this.computeTransformedInformation()&&(i=this.transformedPosition),E.NormalizeToRef(this.getShadowDirection(e),t),Math.abs(E.Dot(t,E.Up()))===1&&(t.z=1e-13);let r=w.Vector3[1];return i.addToRef(t,r),B.LookAtLHToRef(i,r,E.Up(),this._viewMatrix),this._viewMatrix}getProjectionMatrix(e,t){return this.setShadowProjectionMatrix(this._projectionMatrix,e??this._viewMatrix,t??[]),this._projectionMatrix}};x([oi()],Ds.prototype,"position",null);x([oi()],Ds.prototype,"direction",null);x([y()],Ds.prototype,"shadowMinZ",null);x([y()],Ds.prototype,"shadowMaxZ",null)});var Yi,Vm=S(()=>{Ye();je();ie();rs();Dn();Gm();Te();_t.AddNodeConstructor("Light_Type_1",(s,e)=>()=>new Yi(s,E.Zero(),e));Yi=class extends Ds{get shadowFrustumSize(){return this._shadowFrustumSize}set shadowFrustumSize(e){this._shadowFrustumSize=e,this.forceProjectionMatrixCompute()}get shadowOrthoScale(){return this._shadowOrthoScale}set shadowOrthoScale(e){this._shadowOrthoScale=e,this.forceProjectionMatrixCompute()}get orthoLeft(){return this._orthoLeft}set orthoLeft(e){this._orthoLeft=e}get orthoRight(){return this._orthoRight}set orthoRight(e){this._orthoRight=e}get orthoTop(){return this._orthoTop}set orthoTop(e){this._orthoTop=e}get orthoBottom(){return this._orthoBottom}set orthoBottom(e){this._orthoBottom=e}constructor(e,t,i){super(e,i),this._shadowFrustumSize=0,this._shadowOrthoScale=.1,this.autoUpdateExtends=!0,this.autoCalcShadowZBounds=!1,this._orthoLeft=Number.MAX_VALUE,this._orthoRight=Number.MIN_VALUE,this._orthoTop=Number.MIN_VALUE,this._orthoBottom=Number.MAX_VALUE,this.position=t.scale(-1),this.direction=t}getClassName(){return"DirectionalLight"}getTypeID(){return Ke.LIGHTTYPEID_DIRECTIONALLIGHT}_setDefaultShadowProjectionMatrix(e,t,i){this.shadowFrustumSize>0?this._setDefaultFixedFrustumShadowProjectionMatrix(e):this._setDefaultAutoExtendShadowProjectionMatrix(e,t,i)}_setDefaultFixedFrustumShadowProjectionMatrix(e){let t=this.getScene().activeCamera;t&&B.OrthoLHToRef(this.shadowFrustumSize,this.shadowFrustumSize,this.shadowMinZ!==void 0?this.shadowMinZ:t.minZ,this.shadowMaxZ!==void 0?this.shadowMaxZ:t.maxZ,e,this.getScene().getEngine().isNDCHalfZRange)}_setDefaultAutoExtendShadowProjectionMatrix(e,t,i){let r=this.getScene().activeCamera;if(this.autoUpdateExtends||this._orthoLeft===Number.MAX_VALUE){let f=E.Zero();this._orthoLeft=Number.MAX_VALUE,this._orthoRight=-Number.MAX_VALUE,this._orthoTop=-Number.MAX_VALUE,this._orthoBottom=Number.MAX_VALUE;let h=Number.MAX_VALUE,u=-Number.MAX_VALUE;for(let d=0;d<i.length;d++){let p=i[d];if(!p)continue;let _=p.getBoundingInfo().boundingBox;for(let v=0;v<_.vectorsWorld.length;v++)E.TransformCoordinatesToRef(_.vectorsWorld[v],t,f),f.x<this._orthoLeft&&(this._orthoLeft=f.x),f.y<this._orthoBottom&&(this._orthoBottom=f.y),f.x>this._orthoRight&&(this._orthoRight=f.x),f.y>this._orthoTop&&(this._orthoTop=f.y),this.autoCalcShadowZBounds&&(f.z<h&&(h=f.z),f.z>u&&(u=f.z))}this.autoCalcShadowZBounds&&(this._shadowMinZ=h,this._shadowMaxZ=u)}let n=this._orthoRight-this._orthoLeft,a=this._orthoTop-this._orthoBottom,o=this.shadowMinZ!==void 0?this.shadowMinZ:r?.minZ||0,l=this.shadowMaxZ!==void 0?this.shadowMaxZ:r?.maxZ||1e4,c=this.getScene().getEngine().useReverseDepthBuffer;B.OrthoOffCenterLHToRef(this._orthoLeft-n*this.shadowOrthoScale,this._orthoRight+n*this.shadowOrthoScale,this._orthoBottom-a*this.shadowOrthoScale,this._orthoTop+a*this.shadowOrthoScale,c?l:o,c?o:l,e,this.getScene().getEngine().isNDCHalfZRange)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z,1,t),this):(this._uniformBuffer.updateFloat4("vLightData",this.direction.x,this.direction.y,this.direction.z,1,t),this)}transferToNodeMaterialEffect(e,t){return this.computeTransformedInformation()?(e.setFloat3(t,this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z),this):(e.setFloat3(t,this.direction.x,this.direction.y,this.direction.z),this)}getDepthMinZ(e){let t=this._scene.getEngine();return!t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}getDepthMaxZ(e){let t=this._scene.getEngine();return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}prepareLightSpecificDefines(e,t){e["DIRLIGHT"+t]=!0}};x([y()],Yi.prototype,"shadowFrustumSize",null);x([y()],Yi.prototype,"shadowOrthoScale",null);x([y()],Yi.prototype,"autoUpdateExtends",void 0);x([y()],Yi.prototype,"autoCalcShadowZBounds",void 0);x([y("orthoLeft")],Yi.prototype,"_orthoLeft",void 0);x([y("orthoRight")],Yi.prototype,"_orthoRight",void 0);x([y("orthoTop")],Yi.prototype,"_orthoTop",void 0);x([y("orthoBottom")],Yi.prototype,"_orthoBottom",void 0);G("BABYLON.DirectionalLight",Yi)});function Os(s){return s.width!==void 0}function cf(s){return Os(s)?{width:s.width,height:s.height}:{width:s,height:s}}var jh=S(()=>{});var Ho,km=S(()=>{Aa();jh();Ho=class extends Wi{get drawWrapper(){return this._postProcessDrawWrapper}constructor(e,t,i){super(e,t),this.sourceSamplingMode=2,this.depthReadOnly=!1,this.stencilReadOnly=!1,this.disableColorWrite=!1,this.drawBackFace=!1,this.depthTest=!0,this.postProcess=i,this._postProcessDrawWrapper=this.postProcess.drawWrapper,this.outputTexture=this._frameGraph.textureManager.createDanglingHandle(),this.outputDepthAttachmentTexture=this._frameGraph.textureManager.createDanglingHandle(),this.onTexturesAllocatedObservable.add(r=>{this.sourceTexture!==void 0&&r.setTextureSamplingMode(this.sourceTexture,this.sourceSamplingMode)})}isReady(){return this.postProcess.isReady()}record(e=!1,t,i){if(this.sourceTexture===void 0&&this.targetTexture===void 0)throw new Error(`FrameGraphPostProcessTask "${this.name}": sourceTexture or targetTexture is required`);let r=this.sourceTexture!==void 0?this._frameGraph.textureManager.getTextureCreationOptions(this.sourceTexture):void 0;if(r&&(r.options.samples=1),this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,this.targetTexture,this.name,r),this.depthAttachmentTexture!==void 0&&this._frameGraph.textureManager.resolveDanglingHandle(this.outputDepthAttachmentTexture,this.depthAttachmentTexture),r){let o=r.sizeIsPercentage?this._frameGraph.textureManager.getAbsoluteDimensions(r.size):Os(r.size)?r.size:{width:r.size,height:r.size};this._sourceWidth=o.width,this._sourceHeight=o.height}let n=this._frameGraph.textureManager.getTextureDescription(this.outputTexture);this._outputWidth=n.size.width,this._outputHeight=n.size.height;let a=this._frameGraph.addRenderPass(this.name);if(a.depthReadOnly=this.depthReadOnly,a.stencilReadOnly=this.stencilReadOnly,a.addDependencies(this.sourceTexture),a.setRenderTarget(this.outputTexture),a.setRenderTargetDepth(this.depthAttachmentTexture),a.setExecuteFunc(o=>{t?.(o),o.applyFullScreenEffect(this._postProcessDrawWrapper,()=>{this.sourceTexture!==void 0&&o.bindTextureHandle(this._postProcessDrawWrapper.effect,"textureSampler",this.sourceTexture),i?.(o),this.postProcess.bind()},this.stencilState,this.disableColorWrite,this.drawBackFace,this.depthTest)}),!e){let o=this._frameGraph.addRenderPass(this.name+"_disabled",!0);o.depthReadOnly=this.depthReadOnly,o.stencilReadOnly=this.stencilReadOnly,o.addDependencies(this.sourceTexture),o.setRenderTarget(this.outputTexture),o.setRenderTargetDepth(this.depthAttachmentTexture),o.setExecuteFunc(l=>{this.sourceTexture!==void 0&&l.copyTexture(this.sourceTexture)})}return a}dispose(){this.postProcess.dispose(),super.dispose()}}});var Wm,UN=S(()=>{gb();BN();Vm();_b();km();jh();Wm=class extends Um{static IsCascadedShadowGenerator(e){return e.numCascades!==void 0}get numCascades(){return this._numCascades}set numCascades(e){e!==this._numCascades&&(this._numCascades=e,this._setupShadowGenerator())}get debug(){return this._debug}set debug(e){e!==this._debug&&(this._debug=e,this._shadowGenerator&&(this._shadowGenerator.debug=e))}get stabilizeCascades(){return this._stabilizeCascades}set stabilizeCascades(e){e!==this._stabilizeCascades&&(this._stabilizeCascades=e,this._shadowGenerator&&(this._shadowGenerator.stabilizeCascades=e))}get lambda(){return this._lambda}set lambda(e){e!==this._lambda&&(this._lambda=e,this._shadowGenerator&&(this._shadowGenerator.lambda=e))}get cascadeBlendPercentage(){return this._cascadeBlendPercentage}set cascadeBlendPercentage(e){e!==this._cascadeBlendPercentage&&(this._cascadeBlendPercentage=e,this._shadowGenerator&&(this._shadowGenerator.cascadeBlendPercentage=e))}get depthClamp(){return this._depthClamp}set depthClamp(e){e!==this._depthClamp&&(this._depthClamp=e,this._shadowGenerator&&(this._shadowGenerator.depthClamp=e))}get autoCalcDepthBounds(){return this._autoCalcDepthBounds}set autoCalcDepthBounds(e){if(e===this._autoCalcDepthBounds)return;this._autoCalcDepthBounds=e,this._currentAutoCalcDepthBoundsCounter=this._autoCalcDepthBoundsRefreshRate,e||this._shadowGenerator?.setMinMaxDistance(0,1);let t=this.passes;for(let i=0;i<t.length-1;++i)t[i].disabled=!e}get autoCalcDepthBoundsRefreshRate(){return this._autoCalcDepthBoundsRefreshRate}set autoCalcDepthBoundsRefreshRate(e){this._autoCalcDepthBoundsRefreshRate=e,this._currentAutoCalcDepthBoundsCounter=this._autoCalcDepthBoundsRefreshRate}get shadowMaxZ(){return this._shadowMaxZ}set shadowMaxZ(e){e!==this._shadowMaxZ&&(this._shadowMaxZ=e,this._shadowGenerator&&(this._shadowGenerator.shadowMaxZ=e))}constructor(e,t,i){super(e,t,i),this.depthTextureType=0,this._numCascades=zr.DEFAULT_CASCADES_COUNT,this._debug=!1,this._stabilizeCascades=!1,this._lambda=.5,this._cascadeBlendPercentage=.1,this._depthClamp=!0,this._autoCalcDepthBounds=!1,this._currentAutoCalcDepthBoundsCounter=0,this._autoCalcDepthBoundsRefreshRate=1,this._shadowMaxZ=1e4,this._thinMinMaxReducer=new of(i),this._thinMinMaxReducer.onAfterReductionPerformed.add(r=>{if(!this._shadowGenerator)return;let n=this.camera,a=r.min,o=r.max;if(a>=o)a=0,o=1;else if(n&&this.depthTextureType!==0){if(this.depthTextureType===2){let f=this._frameGraph.engine,h=n.getProjectionMatrix(),u=h.m[10],d=h.m[14];f.isNDCHalfZRange||(a=a*2-1,o=o*2-1),a=d/(a-u),o=d/(o-u)}let l=n.minZ,c=n.maxZ;a=(a-l)/(c-l),o=(o-l)/(c-l)}(a!==this._shadowGenerator.minDistance||o!==this._shadowGenerator.maxDistance)&&this._shadowGenerator.setMinMaxDistance(a,o)})}_createShadowGenerator(){if(!(this.light instanceof Yi))throw new Error(`FrameGraphCascadedShadowGeneratorTask ${this.name}: the CSM shadow generator only supports directional lights.`);this._shadowGenerator=new zr(this.mapSize,this.light,this.useFloat32TextureType,this.camera,this.useRedTextureFormat),this._shadowGenerator.numCascades=this._numCascades}_setupShadowGenerator(){super._setupShadowGenerator();let e=this._shadowGenerator;e!==void 0&&(e.debug=this._debug,e.stabilizeCascades=this._stabilizeCascades,e.lambda=this._lambda,e.cascadeBlendPercentage=this._cascadeBlendPercentage,e.depthClamp=this._depthClamp,e.shadowMaxZ=this._shadowMaxZ)}record(){if(this.light===void 0||this.objectList===void 0||this.camera===void 0)throw new Error(`FrameGraphCascadedShadowGeneratorTask ${this.name}: light, objectList and camera are required`);if(this.depthTexture!==void 0){let e=this._frameGraph.textureManager.getTextureCreationOptions(this.depthTexture),t=e.sizeIsPercentage?this._frameGraph.textureManager.getAbsoluteDimensions(e.size):Os(e.size)?e.size:{width:e.size,height:e.size},i=t.width,r=t.height;e.sizeIsPercentage=!1,e.options.formats=[7],e.options.samples=1,this._thinMinMaxReducer.setTextureDimensions(i,r,this.depthTextureType);let n=this._thinMinMaxReducer.reductionSteps,a;this._frameGraph.addPass(`${this.name} Before Min Max Reduction`).setExecuteFunc(o=>{o.pushDebugGroup("Min Max Reduction")});for(let o=0;o<n.length-1;++o){let l=n[o];e.size={width:n[o+1].textureWidth,height:n[o+1].textureHeight};let c=new Ho(l.name,this._frameGraph,l);c.sourceTexture=o==0?this.depthTexture:a,c.sourceSamplingMode=1,c.targetTexture=this._frameGraph.textureManager.createRenderTargetTexture(`${this.name} ${l.name}`,e),c.record(!0),a=c.outputTexture}this._frameGraph.addPass(`${this.name} After Min Max Reduction`).setExecuteFunc(o=>{if(o.popDebugGroup(),this._autoCalcDepthBounds&&this._currentAutoCalcDepthBoundsCounter>=0){if(++this._currentAutoCalcDepthBoundsCounter>=this._autoCalcDepthBoundsRefreshRate){let l=o.getTextureFromHandle(a);l&&this._thinMinMaxReducer.readMinMax(l)}this._currentAutoCalcDepthBoundsCounter%=this._autoCalcDepthBoundsRefreshRate,this._autoCalcDepthBoundsRefreshRate===0&&(this._currentAutoCalcDepthBoundsCounter=-1)}})}super.record()}dispose(){super.dispose(),this._thinMinMaxReducer.dispose()}}});var ka,Hm=S(()=>{Xh();Aa();wh();UN();ka=class extends Wi{get camera(){return this._camera}set camera(e){this._camera=e,this._renderer.activeCamera=this.camera}get disableImageProcessing(){return this._disableImageProcessing}set disableImageProcessing(e){e!==this._disableImageProcessing&&(this._disableImageProcessing=e,this._renderer.disableImageProcessing=e)}get renderParticles(){return this._renderParticles}set renderParticles(e){e!==this._renderParticles&&(this._renderParticles=e,this._renderer.renderParticles=e)}get renderSprites(){return this._renderSprites}set renderSprites(e){e!==this._renderSprites&&(this._renderSprites=e,this._renderer.renderSprites=e)}get forceLayerMaskCheck(){return this._forceLayerMaskCheck}set forceLayerMaskCheck(e){e!==this._forceLayerMaskCheck&&(this._forceLayerMaskCheck=e,this._renderer.forceLayerMaskCheck=e)}get enableBoundingBoxRendering(){return this._enableBoundingBoxRendering}set enableBoundingBoxRendering(e){e!==this._enableBoundingBoxRendering&&(this._enableBoundingBoxRendering=e,this._renderer.enableBoundingBoxRendering=e)}get enableOutlineRendering(){return this._enableOutlineRendering}set enableOutlineRendering(e){e!==this._enableOutlineRendering&&(this._enableOutlineRendering=e,this._renderer.enableOutlineRendering=e)}get objectRenderer(){return this._renderer}get name(){return this._name}set name(e){this._name=e,this._renderer&&(this._renderer.name=e)}constructor(e,t,i,r,n){super(e,t),this.shadowGenerators=[],this.depthTest=!0,this.depthWrite=!0,this.disableShadows=!1,this._disableImageProcessing=!1,this.isMainObjectRenderer=!1,this._renderParticles=!0,this._renderSprites=!0,this._forceLayerMaskCheck=!0,this._enableBoundingBoxRendering=!0,this._enableOutlineRendering=!0,this._onBeforeRenderObservable=null,this._onAfterRenderObservable=null,this._externalObjectRenderer=!1,this._scene=i,this._engine=i.getEngine(),this._externalObjectRenderer=!!n,this._renderer=n??new rr(e,i,r),this.name=e,this._renderer.disableImageProcessing=this._disableImageProcessing,this._renderer.renderParticles=this._renderParticles,this._renderer.renderSprites=this._renderSprites,this._renderer.enableBoundingBoxRendering=this._enableBoundingBoxRendering,this._renderer.forceLayerMaskCheck=this._forceLayerMaskCheck,this._externalObjectRenderer||this._renderer.onBeforeRenderingManagerRenderObservable.add(()=>{this._renderer.options.doNotChangeAspectRatio||i.updateTransformMatrix(!0)}),this.outputTexture=this._frameGraph.textureManager.createDanglingHandle(),this.outputDepthTexture=this._frameGraph.textureManager.createDanglingHandle()}isReady(){return this._renderer.isReadyForRendering(this._textureWidth,this._textureHeight)}record(e=!1,t){if(this.targetTexture===void 0||this.objectList===void 0)throw new Error(`FrameGraphObjectRendererTask ${this.name}: targetTexture and objectList are required`);this._renderer.renderList=this.objectList.meshes,this._renderer.particleSystemList=this.objectList.particleSystems;let i=Array.isArray(this.targetTexture)?this.targetTexture:[this.targetTexture],r=this._frameGraph.textureManager.getTextureDescription(i[0]),n=!1;if(this.depthTexture!==void 0){if(this.depthTexture===1&&(i[0]!==0||i.length>1))throw new Error(`FrameGraphObjectRendererTask ${this.name}: the back buffer color texture is the only color texture allowed when the depth is the back buffer depth/stencil`);if(this.depthTexture!==1&&i[0]===0)throw new Error(`FrameGraphObjectRendererTask ${this.name}: the back buffer depth/stencil texture is the only depth texture allowed when the target is the back buffer color`);if(this._frameGraph.textureManager.getTextureDescription(this.depthTexture).options.samples!==r.options.samples)throw new Error(`FrameGraphObjectRendererTask ${this.name}: the depth texture and the output texture must have the same number of samples`);n=!0}this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,i[0]),this.depthTexture!==void 0&&this._frameGraph.textureManager.resolveDanglingHandle(this.outputDepthTexture,this.depthTexture),this._textureWidth=r.size.width,this._textureHeight=r.size.height,this._setLightsForShadow();let a=this._frameGraph.addRenderPass(this.name);if(a.setRenderTarget(i),a.setRenderTargetDepth(this.depthTexture),a.setExecuteFunc(o=>{this._renderer.renderList=this.objectList.meshes,this._renderer.particleSystemList=this.objectList.particleSystems;let l=this.getBoundingBoxRenderer?.(),c=l&&l.renderList.length>0?l.renderList.data.slice():[];l&&(c.length=l.renderList.length),o.setDepthStates(this.depthTest&&n,this.depthWrite&&n);let f=this._renderer.activeCamera;if(f&&f.cameraRigMode!==0&&!f._renderingMultiview){for(let h=0;h<f._rigCameras.length;h++){let u=f._rigCameras[h];u.rigParent=void 0,this._renderer.activeCamera=u,o.render(this._renderer,this._textureWidth,this._textureHeight),u.rigParent=f}this._renderer.activeCamera=f}else o.render(this._renderer,this._textureWidth,this._textureHeight);t?.(o),l&&(l.renderList.data=c,l.renderList.length=c.length)}),!e){let o=this._frameGraph.addRenderPass(this.name+"_disabled",!0);o.setRenderTarget(i),o.setRenderTargetDepth(this.depthTexture),o.setExecuteFunc(l=>{})}return a}dispose(){this._renderer.onBeforeRenderObservable.remove(this._onBeforeRenderObservable),this._renderer.onAfterRenderObservable.remove(this._onAfterRenderObservable),this._externalObjectRenderer||this._renderer.dispose(),super.dispose()}_setLightsForShadow(){let e=new Set,t=new Map;if(this.shadowGenerators)for(let i of this.shadowGenerators){let r=i.shadowGenerator,n=r.getLight();n.isEnabled()&&n.shadowEnabled&&(e.add(n),Wm.IsCascadedShadowGenerator(i)?n._shadowGenerators.set(i.camera,r):n._shadowGenerators.set(null,r))}this._renderer.onBeforeRenderObservable.remove(this._onBeforeRenderObservable),this._onBeforeRenderObservable=this._renderer.onBeforeRenderObservable.add(()=>{for(let i=0;i<this._scene.lights.length;i++){let r=this._scene.lights[i];r.setShadowProjectionMatrix&&(t.set(r,r.shadowEnabled),r.shadowEnabled=!this.disableShadows&&e.has(r))}}),this._renderer.onAfterRenderObservable.remove(this._onAfterRenderObservable),this._onAfterRenderObservable=this._renderer.onAfterRenderObservable.add(()=>{for(let i=0;i<this._scene.lights.length;i++){let r=this._scene.lights[i];r.setShadowProjectionMatrix&&(r.shadowEnabled=t.get(r))}})}}});var GN,ze,Xr=S(()=>{$e();zs();we();bn();PL();po();ie();Xc();Rl();Yc();BR();Wp();zp();Pn();Cs();gt();Ii();QL();Wc();it();Np();ym();To();Mm();Hs();jL();Ee();Te();Hm();ys();(function(s){s[s.BackwardCompatible=0]="BackwardCompatible",s[s.Intermediate=1]="Intermediate",s[s.Aggressive=2]="Aggressive"})(GN||(GN={}));ze=class s{static DefaultMaterialFactory(e){throw pe("StandardMaterial")}static CollisionCoordinatorFactory(){throw pe("DefaultCollisionCoordinator")}get clearColor(){return this._clearColor}set clearColor(e){e!==this._clearColor&&(this._clearColor=e,this.onClearColorChangedObservable.notifyObservers(this._clearColor))}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}get performancePriority(){return this._performancePriority}set performancePriority(e){if(e!==this._performancePriority){switch(this._performancePriority=e,e){case 0:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!1,this.autoClear=!0;break;case 1:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!0,this.autoClear=!1;break;case 2:this.skipFrustumClipping=!0,this._renderingManager.maintainStateBetweenFrames=!0,this.skipPointerMovePicking=!0,this.autoClear=!1;break}this.onScenePerformancePriorityChangedObservable.notifyObservers(e)}}set forceWireframe(e){this._forceWireframe!==e&&(this._forceWireframe=e,this.markAllMaterialsAsDirty(16))}get forceWireframe(){return this._forceWireframe}set skipFrustumClipping(e){this._skipFrustumClipping!==e&&(this._skipFrustumClipping=e)}get skipFrustumClipping(){return this._skipFrustumClipping}set forcePointsCloud(e){this._forcePointsCloud!==e&&(this._forcePointsCloud=e,this.markAllMaterialsAsDirty(16))}get forcePointsCloud(){return this._forcePointsCloud}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture!==e&&(this._environmentTexture=e,this.onEnvironmentTextureChangedObservable.notifyObservers(e),this.markAllMaterialsAsDirty(1))}getNodes(){let e=[];e=e.concat(this.meshes),e=e.concat(this.lights),e=e.concat(this.cameras),e=e.concat(this.transformNodes);for(let t of this.skeletons)e=e.concat(t.bones);return e}get animationPropertiesOverride(){return this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set beforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),e&&(this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e))}set afterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),e&&(this._onAfterRenderObserver=this.onAfterRenderObservable.add(e))}set beforeCameraRender(e){this._onBeforeCameraRenderObserver&&this.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=this.onBeforeCameraRenderObservable.add(e)}set afterCameraRender(e){this._onAfterCameraRenderObserver&&this.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=this.onAfterCameraRenderObservable.add(e)}get pointerDownPredicate(){return this._pointerPickingConfiguration.pointerDownPredicate}set pointerDownPredicate(e){this._pointerPickingConfiguration.pointerDownPredicate=e}get pointerUpPredicate(){return this._pointerPickingConfiguration.pointerUpPredicate}set pointerUpPredicate(e){this._pointerPickingConfiguration.pointerUpPredicate=e}get pointerMovePredicate(){return this._pointerPickingConfiguration.pointerMovePredicate}set pointerMovePredicate(e){this._pointerPickingConfiguration.pointerMovePredicate=e}get pointerDownFastCheck(){return this._pointerPickingConfiguration.pointerDownFastCheck}set pointerDownFastCheck(e){this._pointerPickingConfiguration.pointerDownFastCheck=e}get pointerUpFastCheck(){return this._pointerPickingConfiguration.pointerUpFastCheck}set pointerUpFastCheck(e){this._pointerPickingConfiguration.pointerUpFastCheck=e}get pointerMoveFastCheck(){return this._pointerPickingConfiguration.pointerMoveFastCheck}set pointerMoveFastCheck(e){this._pointerPickingConfiguration.pointerMoveFastCheck=e}get skipPointerMovePicking(){return this._pointerPickingConfiguration.skipPointerMovePicking}set skipPointerMovePicking(e){this._pointerPickingConfiguration.skipPointerMovePicking=e}get skipPointerDownPicking(){return this._pointerPickingConfiguration.skipPointerDownPicking}set skipPointerDownPicking(e){this._pointerPickingConfiguration.skipPointerDownPicking=e}get skipPointerUpPicking(){return this._pointerPickingConfiguration.skipPointerUpPicking}set skipPointerUpPicking(e){this._pointerPickingConfiguration.skipPointerUpPicking=e}get unTranslatedPointer(){return this._inputManager.unTranslatedPointer}static get DragMovementThreshold(){return ar.DragMovementThreshold}static set DragMovementThreshold(e){ar.DragMovementThreshold=e}static get LongPressDelay(){return ar.LongPressDelay}static set LongPressDelay(e){ar.LongPressDelay=e}static get DoubleClickDelay(){return ar.DoubleClickDelay}static set DoubleClickDelay(e){ar.DoubleClickDelay=e}static get ExclusiveDoubleClickMode(){return ar.ExclusiveDoubleClickMode}static set ExclusiveDoubleClickMode(e){ar.ExclusiveDoubleClickMode=e}bindEyePosition(e,t="vEyePosition",i=!1){let r=this._forcedViewPosition?this._forcedViewPosition:this._mirroredCameraPosition?this._mirroredCameraPosition:this.activeCamera?.globalPosition??E.ZeroReadOnly,n=this.useRightHandedSystem===(this._mirroredCameraPosition!=null);return w.Vector4[0].set(r.x,r.y,r.z,n?-1:1),e&&(i?e.setFloat3(t,w.Vector4[0].x,w.Vector4[0].y,w.Vector4[0].z):e.setVector4(t,w.Vector4[0])),w.Vector4[0]}finalizeSceneUbo(){let e=this.getSceneUniformBuffer(),t=this.bindEyePosition(null);return e.updateFloat4("vEyePosition",t.x,t.y,t.z,t.w),e.update(),e}set useRightHandedSystem(e){this._useRightHandedSystem!==e&&(this._useRightHandedSystem=e,this.markAllMaterialsAsDirty(16))}get useRightHandedSystem(){return this._useRightHandedSystem}setStepId(e){this._currentStepId=e}getStepId(){return this._currentStepId}getInternalStep(){return this._currentInternalStep}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAllMaterialsAsDirty(16))}get fogEnabled(){return this._fogEnabled}set fogMode(e){this._fogMode!==e&&(this._fogMode=e,this.markAllMaterialsAsDirty(16))}get fogMode(){return this._fogMode}get prePass(){return!!this.prePassRenderer&&this.prePassRenderer.defaultRT.enabled}set shadowsEnabled(e){this._shadowsEnabled!==e&&(this._shadowsEnabled=e,this.markAllMaterialsAsDirty(2))}get shadowsEnabled(){return this._shadowsEnabled}set lightsEnabled(e){this._lightsEnabled!==e&&(this._lightsEnabled=e,this.markAllMaterialsAsDirty(2))}get lightsEnabled(){return this._lightsEnabled}get activeCameras(){return this._activeCameras}set activeCameras(e){this._unObserveActiveCameras&&(this._unObserveActiveCameras(),this._unObserveActiveCameras=null),e&&(this._unObserveActiveCameras=op(e,()=>{this.onActiveCamerasChanged.notifyObservers(this)})),this._activeCameras=e}get activeCamera(){return this._activeCamera}set activeCamera(e){e!==this._activeCamera&&(this._activeCamera=e,this.onActiveCameraChanged.notifyObservers(this))}get _hasDefaultMaterial(){return s.DefaultMaterialFactory!==s._OriginalDefaultMaterialFactory}get defaultMaterial(){return this._defaultMaterial||(this._defaultMaterial=s.DefaultMaterialFactory(this)),this._defaultMaterial}set defaultMaterial(e){this._defaultMaterial=e}set texturesEnabled(e){this._texturesEnabled!==e&&(this._texturesEnabled=e,this.markAllMaterialsAsDirty(1))}get texturesEnabled(){return this._texturesEnabled}get frameGraph(){return this._frameGraph}set frameGraph(e){if(this._frameGraph){this._frameGraph=e,e||(this.customRenderFunction=this._currentCustomRenderFunction);return}this._frameGraph=e,e&&(this._currentCustomRenderFunction=this.customRenderFunction,this.customRenderFunction=this._renderWithFrameGraph,this.activeCamera=null)}set skeletonsEnabled(e){this._skeletonsEnabled!==e&&(this._skeletonsEnabled=e,this.markAllMaterialsAsDirty(8))}get skeletonsEnabled(){return this._skeletonsEnabled}get collisionCoordinator(){return this._collisionCoordinator||(this._collisionCoordinator=s.CollisionCoordinatorFactory(),this._collisionCoordinator.init(this)),this._collisionCoordinator}get renderingManager(){return this._renderingManager}get frustumPlanes(){return this._frustumPlanes}_registerTransientComponents(){if(this._transientComponents.length>0){for(let e of this._transientComponents)e.register();this._transientComponents.length=0}}_addComponent(e){this._components.push(e),this._transientComponents.push(e);let t=e;t.addFromContainer&&t.serialize&&this._serializableComponents.push(t)}_getComponent(e){for(let t of this._components)if(t.name===e)return t;return null}get uniqueId(){return this._uniqueId}constructor(e,t){this._inputManager=new ar(this),this.cameraToUseForPointers=null,this._isScene=!0,this._blockEntityCollection=!1,this.autoClear=!0,this.autoClearDepthAndStencil=!0,this._clearColor=new me(.2,.2,.3,1),this.onClearColorChangedObservable=new N,this.ambientColor=new j(0,0,0),this.environmentIntensity=1,this.iblIntensity=1,this._performancePriority=0,this.onScenePerformancePriorityChangedObservable=new N,this._forceWireframe=!1,this._skipFrustumClipping=!1,this._forcePointsCloud=!1,this.rootNodes=[],this.cameras=[],this.lights=[],this.meshes=[],this.skeletons=[],this.particleSystems=[],this.animations=[],this.animationGroups=[],this.multiMaterials=[],this.materials=[],this.morphTargetManagers=[],this.geometries=[],this.transformNodes=[],this.actionManagers=[],this.objectRenderers=[],this.textures=[],this._environmentTexture=null,this.postProcesses=[],this.effectLayers=[],this.sounds=null,this.layers=[],this.lensFlareSystems=[],this.proceduralTextures=[],this.animationsEnabled=!0,this._animationPropertiesOverride=null,this.useConstantAnimationDeltaTime=!1,this.constantlyUpdateMeshUnderPointer=!1,this.hoverCursor="pointer",this.defaultCursor="",this.doNotHandleCursors=!1,this.preventDefaultOnPointerDown=!0,this.preventDefaultOnPointerUp=!0,this.metadata=null,this.reservedDataStore=null,this.disableOfflineSupportExceptionRules=[],this.onDisposeObservable=new N,this._onDisposeObserver=null,this.onBeforeRenderObservable=new N,this._onBeforeRenderObserver=null,this.onAfterRenderObservable=new N,this.onAfterRenderCameraObservable=new N,this._onAfterRenderObserver=null,this.onBeforeAnimationsObservable=new N,this.onAfterAnimationsObservable=new N,this.onBeforeDrawPhaseObservable=new N,this.onAfterDrawPhaseObservable=new N,this.onReadyObservable=new N,this.onBeforeCameraRenderObservable=new N,this._onBeforeCameraRenderObserver=null,this.onAfterCameraRenderObservable=new N,this._onAfterCameraRenderObserver=null,this.onBeforeActiveMeshesEvaluationObservable=new N,this.onAfterActiveMeshesEvaluationObservable=new N,this.onBeforeParticlesRenderingObservable=new N,this.onAfterParticlesRenderingObservable=new N,this.onDataLoadedObservable=new N,this.onNewCameraAddedObservable=new N,this.onCameraRemovedObservable=new N,this.onNewLightAddedObservable=new N,this.onLightRemovedObservable=new N,this.onNewGeometryAddedObservable=new N,this.onGeometryRemovedObservable=new N,this.onNewTransformNodeAddedObservable=new N,this.onTransformNodeRemovedObservable=new N,this.onNewMeshAddedObservable=new N,this.onMeshRemovedObservable=new N,this.onNewSkeletonAddedObservable=new N,this.onSkeletonRemovedObservable=new N,this.onNewParticleSystemAddedObservable=new N,this.onParticleSystemRemovedObservable=new N,this.onNewAnimationGroupAddedObservable=new N,this.onAnimationGroupRemovedObservable=new N,this.onNewMaterialAddedObservable=new N,this.onNewMultiMaterialAddedObservable=new N,this.onMaterialRemovedObservable=new N,this.onMultiMaterialRemovedObservable=new N,this.onNewTextureAddedObservable=new N,this.onTextureRemovedObservable=new N,this.onNewFrameGraphAddedObservable=new N,this.onFrameGraphRemovedObservable=new N,this.onNewObjectRendererAddedObservable=new N,this.onObjectRendererRemovedObservable=new N,this.onNewPostProcessAddedObservable=new N,this.onPostProcessRemovedObservable=new N,this.onNewEffectLayerAddedObservable=new N,this.onEffectLayerRemovedObservable=new N,this.onBeforeRenderTargetsRenderObservable=new N,this.onAfterRenderTargetsRenderObservable=new N,this.onBeforeStepObservable=new N,this.onAfterStepObservable=new N,this.onActiveCameraChanged=new N,this.onActiveCamerasChanged=new N,this.onBeforeRenderingGroupObservable=new N,this.onAfterRenderingGroupObservable=new N,this.onMeshImportedObservable=new N,this.onAnimationFileImportedObservable=new N,this.onEnvironmentTextureChangedObservable=new N,this.onMeshUnderPointerUpdatedObservable=new N,this._registeredForLateAnimationBindings=new js(256),this._pointerPickingConfiguration=new Pm,this.onPrePointerObservable=new N,this.onPointerObservable=new N,this.onPreKeyboardObservable=new N,this.onKeyboardObservable=new N,this._useRightHandedSystem=!1,this._timeAccumulator=0,this._currentStepId=0,this._currentInternalStep=0,this._fogEnabled=!0,this._fogMode=s.FOGMODE_NONE,this.fogColor=new j(.2,.2,.3),this.fogDensity=.1,this.fogStart=0,this.fogEnd=1e3,this.needsPreviousWorldMatrices=!1,this._shadowsEnabled=!0,this._lightsEnabled=!0,this._unObserveActiveCameras=null,this._texturesEnabled=!0,this._frameGraph=null,this.frameGraphs=[],this.physicsEnabled=!0,this.particlesEnabled=!0,this.spritesEnabled=!0,this._skeletonsEnabled=!0,this.lensFlaresEnabled=!0,this.collisionsEnabled=!0,this.gravity=new E(0,-9.807,0),this.postProcessesEnabled=!0,this.renderTargetsEnabled=!0,this.dumpNextRenderTargets=!1,this.customRenderTargets=[],this.importedMeshesFiles=[],this.probesEnabled=!0,this._meshesForIntersections=new js(256),this.proceduralTexturesEnabled=!0,this._totalVertices=new sr,this._activeIndices=new sr,this._activeParticles=new sr,this._activeBones=new sr,this._animationTime=0,this.animationTimeScale=1,this._renderId=0,this._frameId=0,this._executeWhenReadyTimeoutId=null,this._intermediateRendering=!1,this._defaultFrameBufferCleared=!1,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1,this._toBeDisposed=new Array(256),this._activeRequests=new Array,this._pendingData=[],this._isDisposed=!1,this.dispatchAllSubMeshesOfActiveMeshes=!1,this._activeMeshes=new wt(256),this._processedMaterials=new wt(256),this._renderTargets=new js(256),this._materialsRenderTargets=new js(256),this._activeParticleSystems=new wt(256),this._activeSkeletons=new js(32),this._softwareSkinnedMeshes=new js(32),this._activeAnimatables=new Array,this._transformMatrix=B.Zero(),this.requireLightSorting=!1,this._components=[],this._serializableComponents=[],this._transientComponents=[],this._beforeCameraUpdateStage=$t.Create(),this._beforeClearStage=$t.Create(),this._beforeRenderTargetClearStage=$t.Create(),this._gatherRenderTargetsStage=$t.Create(),this._gatherActiveCameraRenderTargetsStage=$t.Create(),this._isReadyForMeshStage=$t.Create(),this._beforeEvaluateActiveMeshStage=$t.Create(),this._evaluateSubMeshStage=$t.Create(),this._preActiveMeshStage=$t.Create(),this._cameraDrawRenderTargetStage=$t.Create(),this._beforeCameraDrawStage=$t.Create(),this._beforeRenderTargetDrawStage=$t.Create(),this._beforeRenderingGroupDrawStage=$t.Create(),this._beforeRenderingMeshStage=$t.Create(),this._afterRenderingMeshStage=$t.Create(),this._afterRenderingGroupDrawStage=$t.Create(),this._afterCameraDrawStage=$t.Create(),this._afterCameraPostProcessStage=$t.Create(),this._afterRenderTargetDrawStage=$t.Create(),this._afterRenderTargetPostProcessStage=$t.Create(),this._afterRenderStage=$t.Create(),this._pointerMoveStage=$t.Create(),this._pointerDownStage=$t.Create(),this._pointerUpStage=$t.Create(),this._geometriesByUniqueId=null,this._uniqueId=0,this._defaultMeshCandidates={data:[],length:0},this._defaultSubMeshCandidates={data:[],length:0},this._preventFreeActiveMeshesAndRenderingGroups=!1,this._activeMeshesFrozen=!1,this._activeMeshesFrozenButKeepClipping=!1,this._skipEvaluateActiveMeshesCompletely=!1,this._freezeActiveMeshesCancel=null,this._useCurrentFrameBuffer=!1,this._allowPostProcessClearColor=!0,this.getDeterministicFrameTime=()=>this._engine.getTimeStep(),this._registeredActions=0,this._blockMaterialDirtyMechanism=!1,this._perfCollector=null,this.activeCameras=[],this._uniqueId=this.getUniqueId();let i={useGeometryUniqueIdsMap:!0,useMaterialMeshMap:!0,useClonedMeshMap:!0,virtual:!1,...t};e=this._engine=e||Z.LastCreatedEngine,i.virtual?e._virtualScenes.push(this):(Z._LastCreatedScene=this,e.scenes.push(this)),this._uid=null,this._renderingManager=new Ps(this),va&&(this.postProcessManager=new va(this)),jt()&&this.attachControl(),this._createUbo(),Ve&&(this._imageProcessingConfiguration=new Ve),this.setDefaultCandidateProviders(),i.useGeometryUniqueIdsMap&&(this._geometriesByUniqueId={}),this.useMaterialMeshMap=i.useMaterialMeshMap,this.useClonedMeshMap=i.useClonedMeshMap,(!t||!t.virtual)&&e.onNewSceneAddedObservable.notifyObservers(this)}getClassName(){return"Scene"}_getDefaultMeshCandidates(){return this._defaultMeshCandidates.data=this.meshes,this._defaultMeshCandidates.length=this.meshes.length,this._defaultMeshCandidates}_getDefaultSubMeshCandidates(e){return this._defaultSubMeshCandidates.data=e.subMeshes,this._defaultSubMeshCandidates.length=e.subMeshes.length,this._defaultSubMeshCandidates}setDefaultCandidateProviders(){this.getActiveMeshCandidates=()=>this._getDefaultMeshCandidates(),this.getActiveSubMeshCandidates=e=>this._getDefaultSubMeshCandidates(e),this.getIntersectingSubMeshCandidates=(e,t)=>this._getDefaultSubMeshCandidates(e),this.getCollidingSubMeshCandidates=(e,t)=>this._getDefaultSubMeshCandidates(e)}get meshUnderPointer(){return this._inputManager.meshUnderPointer}get pointerX(){return this._inputManager.pointerX}set pointerX(e){this._inputManager.pointerX=e}get pointerY(){return this._inputManager.pointerY}set pointerY(e){this._inputManager.pointerY=e}getCachedMaterial(){return this._cachedMaterial}getCachedEffect(){return this._cachedEffect}getCachedVisibility(){return this._cachedVisibility}isCachedMaterialInvalid(e,t,i=1){return this._cachedEffect!==t||this._cachedMaterial!==e||this._cachedVisibility!==i}getEngine(){return this._engine}getTotalVertices(){return this._totalVertices.current}get totalVerticesPerfCounter(){return this._totalVertices}getActiveIndices(){return this._activeIndices.current}get totalActiveIndicesPerfCounter(){return this._activeIndices}getActiveParticles(){return this._activeParticles.current}get activeParticlesPerfCounter(){return this._activeParticles}getActiveBones(){return this._activeBones.current}get activeBonesPerfCounter(){return this._activeBones}getActiveMeshes(){return this._activeMeshes}getAnimationRatio(){return this._animationRatio!==void 0?this._animationRatio:1}getRenderId(){return this._renderId}getFrameId(){return this._frameId}incrementRenderId(){this._renderId++}_createUbo(){this.setSceneUniformBuffer(this.createSceneUniformBuffer())}simulatePointerMove(e,t){return this._inputManager.simulatePointerMove(e,t),this}simulatePointerDown(e,t){return this._inputManager.simulatePointerDown(e,t),this}simulatePointerUp(e,t,i){return this._inputManager.simulatePointerUp(e,t,i),this}isPointerCaptured(e=0){return this._inputManager.isPointerCaptured(e)}attachControl(e=!0,t=!0,i=!0){this._inputManager.attachControl(e,t,i)}detachControl(){this._inputManager.detachControl()}isReady(e=!0){if(this._isDisposed)return!1;let t,i=this.getEngine(),r=i.currentRenderPassId;i.currentRenderPassId=this.activeCamera?.renderPassId??r;let n=!0;for(this._pendingData.length>0&&(n=!1),this.prePassRenderer?.update(),this.useOrderIndependentTransparency&&this.depthPeelingRenderer&&n&&(n=this.depthPeelingRenderer.isReady()),e&&(this._processedMaterials.reset(),this._materialsRenderTargets.reset()),t=0;t<this.meshes.length;t++){let a=this.meshes[t];if(!a.subMeshes||a.subMeshes.length===0)continue;if(!a.isReady(!0)){n=!1;continue}let o=a.hasThinInstances||a.getClassName()==="InstancedMesh"||a.getClassName()==="InstancedLinesMesh"||i.getCaps().instancedArrays&&a.instances.length>0;for(let c of this._isReadyForMeshStage)c.action(a,o)||(n=!1);if(!e)continue;let l=a.material||this.defaultMaterial;if(l)if(l._storeEffectOnSubMeshes)for(let c of a.subMeshes){let f=c.getMaterial();f&&f.hasRenderTargetTextures&&f.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(f)===-1&&(this._processedMaterials.push(f),this._materialsRenderTargets.concatWithNoDuplicate(f.getRenderTargetTextures()))}else l.hasRenderTargetTextures&&l.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(l)===-1&&(this._processedMaterials.push(l),this._materialsRenderTargets.concatWithNoDuplicate(l.getRenderTargetTextures()))}if(e)for(t=0;t<this._materialsRenderTargets.length;++t)this._materialsRenderTargets.data[t].isReadyForRendering()||(n=!1);for(t=0;t<this.geometries.length;t++)this.geometries[t].delayLoadState===2&&(n=!1);if(this.activeCameras&&this.activeCameras.length>0)for(let a of this.activeCameras)a.isReady(!0)||(n=!1);else this.activeCamera&&(this.activeCamera.isReady(!0)||(n=!1));for(let a of this.particleSystems)a.isReady()||(n=!1);if(this.layers)for(let a of this.layers)a.isReady()||(n=!1);if(this.effectLayers)for(let a of this.effectLayers)a.isLayerReady()||(n=!1);return i.areAllEffectsReady()||(n=!1),i.currentRenderPassId=r,n}resetCachedMaterial(){this._cachedMaterial=null,this._cachedEffect=null,this._cachedVisibility=null}registerBeforeRender(e){this.onBeforeRenderObservable.add(e)}unregisterBeforeRender(e){this.onBeforeRenderObservable.removeCallback(e)}registerAfterRender(e){this.onAfterRenderObservable.add(e)}unregisterAfterRender(e){this.onAfterRenderObservable.removeCallback(e)}_executeOnceBeforeRender(e){let t=()=>{e(),setTimeout(()=>{this.unregisterBeforeRender(t)})};this.registerBeforeRender(t)}executeOnceBeforeRender(e,t){t!==void 0?setTimeout(()=>{this._executeOnceBeforeRender(e)},t):this._executeOnceBeforeRender(e)}addPendingData(e){this._pendingData.push(e)}removePendingData(e){let t=this.isLoading,i=this._pendingData.indexOf(e);i!==-1&&this._pendingData.splice(i,1),t&&!this.isLoading&&this.onDataLoadedObservable.notifyObservers(this)}getWaitingItemsCount(){return this._pendingData.length}get isLoading(){return this._pendingData.length>0}executeWhenReady(e,t=!1){this.onReadyObservable.addOnce(e),this._executeWhenReadyTimeoutId===null&&this._checkIsReady(t)}async whenReadyAsync(e=!1){return await new Promise(t=>{this.executeWhenReady(()=>{t()},e)})}_checkIsReady(e=!1){if(this._registerTransientComponents(),this.isReady(e)){this.onReadyObservable.notifyObservers(this),this.onReadyObservable.clear(),this._executeWhenReadyTimeoutId=null;return}if(this._isDisposed){this.onReadyObservable.clear(),this._executeWhenReadyTimeoutId=null;return}this._executeWhenReadyTimeoutId=setTimeout(()=>{this.incrementRenderId(),this._checkIsReady(e)},100)}get animatables(){return this._activeAnimatables}resetLastAnimationTimeFrame(){this._animationTimeLast=Zt.Now}getViewMatrix(){return this._viewMatrix}getProjectionMatrix(){return this._projectionMatrix}getTransformMatrix(){return this._transformMatrix}setTransformMatrix(e,t,i,r){!i&&!r&&this._multiviewSceneUbo&&(this._multiviewSceneUbo.dispose(),this._multiviewSceneUbo=null),!(this._viewUpdateFlag===e.updateFlag&&this._projectionUpdateFlag===t.updateFlag)&&(this._viewUpdateFlag=e.updateFlag,this._projectionUpdateFlag=t.updateFlag,this._viewMatrix=e,this._projectionMatrix=t,this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._frustumPlanes?vo.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=vo.GetPlanes(this._transformMatrix),this._multiviewSceneUbo&&this._multiviewSceneUbo.useUbo?this._updateMultiviewUbo(i,r):this._sceneUbo.useUbo&&(this._sceneUbo.updateMatrix("viewProjection",this._transformMatrix),this._sceneUbo.updateMatrix("view",this._viewMatrix),this._sceneUbo.updateMatrix("projection",this._projectionMatrix)))}getSceneUniformBuffer(){return this._multiviewSceneUbo?this._multiviewSceneUbo:this._sceneUbo}createSceneUniformBuffer(e,t){let i=new ii(this._engine,void 0,!1,e??"scene",void 0,t);return i.addUniform("viewProjection",16),i.addUniform("view",16),i.addUniform("projection",16),i.addUniform("vEyePosition",4),i}setSceneUniformBuffer(e){this._sceneUbo=e,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1}getUniqueId(){return xa.UniqueId}addMesh(e,t=!1){if(!this._blockEntityCollection&&(this.meshes.push(e),e._resyncLightSources(),e.parent||e._addToSceneRootNodes(),W.SetImmediate(()=>{this.onNewMeshAddedObservable.notifyObservers(e)}),t)){let i=e.getChildMeshes();for(let r of i)this.addMesh(r)}}removeMesh(e,t=!1){let i=this.meshes.indexOf(e);if(i!==-1&&(this.meshes.splice(i,1),e.parent||e._removeFromSceneRootNodes()),this._inputManager._invalidateMesh(e),this.onMeshRemovedObservable.notifyObservers(e),t){let r=e.getChildMeshes();for(let n of r)this.removeMesh(n)}return i}addTransformNode(e){this._blockEntityCollection||e.getScene()===this&&e._indexInSceneTransformNodesArray!==-1||(e._indexInSceneTransformNodesArray=this.transformNodes.length,this.transformNodes.push(e),e.parent||e._addToSceneRootNodes(),this.onNewTransformNodeAddedObservable.notifyObservers(e))}removeTransformNode(e){let t=e._indexInSceneTransformNodesArray;if(t!==-1){if(t!==this.transformNodes.length-1){let i=this.transformNodes[this.transformNodes.length-1];this.transformNodes[t]=i,i._indexInSceneTransformNodesArray=t}e._indexInSceneTransformNodesArray=-1,this.transformNodes.pop(),e.parent||e._removeFromSceneRootNodes()}return this.onTransformNodeRemovedObservable.notifyObservers(e),t}removeSkeleton(e){let t=this.skeletons.indexOf(e);return t!==-1&&(this.skeletons.splice(t,1),this.onSkeletonRemovedObservable.notifyObservers(e),this._executeActiveContainerCleanup(this._activeSkeletons)),t}removeMorphTargetManager(e){let t=this.morphTargetManagers.indexOf(e);return t!==-1&&this.morphTargetManagers.splice(t,1),t}removeLight(e){let t=this.lights.indexOf(e);if(t!==-1){for(let i of this.meshes)i._removeLightSource(e,!1);this.lights.splice(t,1),this.sortLightsByPriority(),e.parent||e._removeFromSceneRootNodes()}return this.onLightRemovedObservable.notifyObservers(e),t}removeCamera(e){let t=this.cameras.indexOf(e);if(t!==-1&&(this.cameras.splice(t,1),e.parent||e._removeFromSceneRootNodes()),this.activeCameras){let i=this.activeCameras.indexOf(e);i!==-1&&this.activeCameras.splice(i,1)}return this.activeCamera===e&&(this.cameras.length>0?this.activeCamera=this.cameras[0]:this.activeCamera=null),this.onCameraRemovedObservable.notifyObservers(e),t}removeParticleSystem(e){let t=this.particleSystems.indexOf(e);return t!==-1&&(this.particleSystems.splice(t,1),this._executeActiveContainerCleanup(this._activeParticleSystems)),this.onParticleSystemRemovedObservable.notifyObservers(e),t}removeAnimation(e){let t=this.animations.indexOf(e);return t!==-1&&this.animations.splice(t,1),t}stopAnimation(e,t,i){}removeAnimationGroup(e){let t=this.animationGroups.indexOf(e);return t!==-1&&this.animationGroups.splice(t,1),this.onAnimationGroupRemovedObservable.notifyObservers(e),t}removeMultiMaterial(e){let t=this.multiMaterials.indexOf(e);return t!==-1&&this.multiMaterials.splice(t,1),this.onMultiMaterialRemovedObservable.notifyObservers(e),t}removeMaterial(e){let t=e._indexInSceneMaterialArray;if(t!==-1&&t<this.materials.length){if(t!==this.materials.length-1){let i=this.materials[this.materials.length-1];this.materials[t]=i,i._indexInSceneMaterialArray=t}e._indexInSceneMaterialArray=-1,this.materials.pop()}return this.onMaterialRemovedObservable.notifyObservers(e),t}removeActionManager(e){let t=this.actionManagers.indexOf(e);return t!==-1&&this.actionManagers.splice(t,1),t}removeTexture(e){let t=this.textures.indexOf(e);return t!==-1&&this.textures.splice(t,1),this.onTextureRemovedObservable.notifyObservers(e),t}removeFrameGraph(e){let t=this.frameGraphs.indexOf(e);return t!==-1&&this.frameGraphs.splice(t,1),this.onFrameGraphRemovedObservable.notifyObservers(e),t}removeObjectRenderer(e){let t=this.objectRenderers.indexOf(e);return t!==-1&&this.objectRenderers.splice(t,1),this.onObjectRendererRemovedObservable.notifyObservers(e),t}removePostProcess(e){let t=this.postProcesses.indexOf(e);return t!==-1&&this.postProcesses.splice(t,1),this.onPostProcessRemovedObservable.notifyObservers(e),t}removeEffectLayer(e){let t=this.effectLayers.indexOf(e);return t!==-1&&this.effectLayers.splice(t,1),this.onEffectLayerRemovedObservable.notifyObservers(e),t}addLight(e){if(!this._blockEntityCollection){this.lights.push(e),this.sortLightsByPriority(),e.parent||e._addToSceneRootNodes();for(let t of this.meshes)t.lightSources.indexOf(e)===-1&&(t.lightSources.push(e),t._resyncLightSources());W.SetImmediate(()=>{this.onNewLightAddedObservable.notifyObservers(e)})}}sortLightsByPriority(){this.requireLightSorting&&this.lights.sort(ot.CompareLightsPriority)}addCamera(e){this._blockEntityCollection||(this.cameras.push(e),W.SetImmediate(()=>{this.onNewCameraAddedObservable.notifyObservers(e)}),e.parent||e._addToSceneRootNodes())}addSkeleton(e){this._blockEntityCollection||(this.skeletons.push(e),W.SetImmediate(()=>{this.onNewSkeletonAddedObservable.notifyObservers(e)}))}addParticleSystem(e){this._blockEntityCollection||(this.particleSystems.push(e),W.SetImmediate(()=>{this.onNewParticleSystemAddedObservable.notifyObservers(e)}))}addAnimation(e){this._blockEntityCollection||this.animations.push(e)}addAnimationGroup(e){this._blockEntityCollection||(this.animationGroups.push(e),W.SetImmediate(()=>{this.onNewAnimationGroupAddedObservable.notifyObservers(e)}))}addMultiMaterial(e){this._blockEntityCollection||(this.multiMaterials.push(e),W.SetImmediate(()=>{this.onNewMultiMaterialAddedObservable.notifyObservers(e)}))}addMaterial(e){this._blockEntityCollection||e.getScene()===this&&e._indexInSceneMaterialArray!==-1||(e._indexInSceneMaterialArray=this.materials.length,this.materials.push(e),W.SetImmediate(()=>{this.onNewMaterialAddedObservable.notifyObservers(e)}))}addMorphTargetManager(e){this._blockEntityCollection||this.morphTargetManagers.push(e)}addGeometry(e){this._blockEntityCollection||(this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=this.geometries.length),this.geometries.push(e))}addActionManager(e){this.actionManagers.push(e)}addTexture(e){this._blockEntityCollection||(this.textures.push(e),this.onNewTextureAddedObservable.notifyObservers(e))}addFrameGraph(e){this.frameGraphs.push(e),W.SetImmediate(()=>{this.onNewFrameGraphAddedObservable.notifyObservers(e)})}addObjectRenderer(e){this.objectRenderers.push(e),W.SetImmediate(()=>{this.onNewObjectRendererAddedObservable.notifyObservers(e)})}addPostProcess(e){this._blockEntityCollection||(this.postProcesses.push(e),W.SetImmediate(()=>{this.onNewPostProcessAddedObservable.notifyObservers(e)}))}addEffectLayer(e){this._blockEntityCollection||(this.effectLayers.push(e),W.SetImmediate(()=>{this.onNewEffectLayerAddedObservable.notifyObservers(e)}))}switchActiveCamera(e,t=!0){this._engine.getInputElement()&&(this.activeCamera&&this.activeCamera.detachControl(),this.activeCamera=e,t&&e.attachControl())}setActiveCameraById(e){let t=this.getCameraById(e);return t?(this.activeCamera=t,t):null}setActiveCameraByName(e){let t=this.getCameraByName(e);return t?(this.activeCamera=t,t):null}getAnimationGroupByName(e){for(let t=0;t<this.animationGroups.length;t++)if(this.animationGroups[t].name===e)return this.animationGroups[t];return null}_getMaterial(e,t){for(let i=0;i<this.materials.length;i++){let r=this.materials[i];if(t(r))return r}if(e)for(let i=0;i<this.multiMaterials.length;i++){let r=this.multiMaterials[i];if(t(r))return r}return null}getMaterialByUniqueID(e,t=!1){return this.getMaterialByUniqueId(e,t)}getMaterialByUniqueId(e,t=!1){return this._getMaterial(t,i=>i.uniqueId===e)}getMaterialById(e,t=!1){return this._getMaterial(t,i=>i.id===e)}getMaterialByName(e,t=!1){return this._getMaterial(t,i=>i.name===e)}getLastMaterialById(e,t=!1){for(let i=this.materials.length-1;i>=0;i--)if(this.materials[i].id===e)return this.materials[i];if(t){for(let i=this.multiMaterials.length-1;i>=0;i--)if(this.multiMaterials[i].id===e)return this.multiMaterials[i]}return null}getTextureByUniqueId(e){for(let t=0;t<this.textures.length;t++)if(this.textures[t].uniqueId===e)return this.textures[t];return null}getTextureByName(e){for(let t=0;t<this.textures.length;t++)if(this.textures[t].name===e)return this.textures[t];return null}getCameraById(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].id===e)return this.cameras[t];return null}getCameraByUniqueId(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].uniqueId===e)return this.cameras[t];return null}getCameraByName(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].name===e)return this.cameras[t];return null}getBoneById(e){for(let t=0;t<this.skeletons.length;t++){let i=this.skeletons[t];for(let r=0;r<i.bones.length;r++)if(i.bones[r].id===e)return i.bones[r]}return null}getBoneByName(e){for(let t=0;t<this.skeletons.length;t++){let i=this.skeletons[t];for(let r=0;r<i.bones.length;r++)if(i.bones[r].name===e)return i.bones[r]}return null}getLightByName(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].name===e)return this.lights[t];return null}getLightById(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].id===e)return this.lights[t];return null}getLightByUniqueId(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].uniqueId===e)return this.lights[t];return null}getParticleSystemById(e){for(let t=0;t<this.particleSystems.length;t++)if(this.particleSystems[t].id===e)return this.particleSystems[t];return null}getGeometryById(e){for(let t=0;t<this.geometries.length;t++)if(this.geometries[t].id===e)return this.geometries[t];return null}_getGeometryByUniqueId(e){if(this._geometriesByUniqueId){let t=this._geometriesByUniqueId[e];if(t!==void 0)return this.geometries[t]}else for(let t=0;t<this.geometries.length;t++)if(this.geometries[t].uniqueId===e)return this.geometries[t];return null}getFrameGraphByName(e){for(let t=0;t<this.frameGraphs.length;t++)if(this.frameGraphs[t].name===e)return this.frameGraphs[t];return null}pushGeometry(e,t){return!t&&this._getGeometryByUniqueId(e.uniqueId)?!1:(this.addGeometry(e),W.SetImmediate(()=>{this.onNewGeometryAddedObservable.notifyObservers(e)}),!0)}removeGeometry(e){let t;if(this._geometriesByUniqueId){if(t=this._geometriesByUniqueId[e.uniqueId],t===void 0)return!1}else if(t=this.geometries.indexOf(e),t<0)return!1;if(t!==this.geometries.length-1){let i=this.geometries[this.geometries.length-1];i&&(this.geometries[t]=i,this._geometriesByUniqueId&&(this._geometriesByUniqueId[i.uniqueId]=t))}return this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=void 0),this.geometries.pop(),this.onGeometryRemovedObservable.notifyObservers(e),!0}getGeometries(){return this.geometries}getMeshById(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].id===e)return this.meshes[t];return null}getMeshesById(e){return this.meshes.filter(function(t){return t.id===e})}getTransformNodeById(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].id===e)return this.transformNodes[t];return null}getTransformNodeByUniqueId(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].uniqueId===e)return this.transformNodes[t];return null}getTransformNodesById(e){return this.transformNodes.filter(function(t){return t.id===e})}getMeshByUniqueId(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].uniqueId===e)return this.meshes[t];return null}getLastMeshById(e){for(let t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];return null}getLastTransformNodeById(e){for(let t=this.transformNodes.length-1;t>=0;t--)if(this.transformNodes[t].id===e)return this.transformNodes[t];return null}getLastEntryById(e){let t;for(t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];for(t=this.transformNodes.length-1;t>=0;t--)if(this.transformNodes[t].id===e)return this.transformNodes[t];for(t=this.cameras.length-1;t>=0;t--)if(this.cameras[t].id===e)return this.cameras[t];for(t=this.lights.length-1;t>=0;t--)if(this.lights[t].id===e)return this.lights[t];return null}getNodeById(e){let t=this.getMeshById(e);if(t)return t;let i=this.getTransformNodeById(e);if(i)return i;let r=this.getLightById(e);if(r)return r;let n=this.getCameraById(e);if(n)return n;let a=this.getBoneById(e);return a||null}getNodeByName(e){let t=this.getMeshByName(e);if(t)return t;let i=this.getTransformNodeByName(e);if(i)return i;let r=this.getLightByName(e);if(r)return r;let n=this.getCameraByName(e);if(n)return n;let a=this.getBoneByName(e);return a||null}getMeshByName(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].name===e)return this.meshes[t];return null}getTransformNodeByName(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].name===e)return this.transformNodes[t];return null}getLastSkeletonById(e){for(let t=this.skeletons.length-1;t>=0;t--)if(this.skeletons[t].id===e)return this.skeletons[t];return null}getSkeletonByUniqueId(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].uniqueId===e)return this.skeletons[t];return null}getSkeletonById(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].id===e)return this.skeletons[t];return null}getSkeletonByName(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].name===e)return this.skeletons[t];return null}getMorphTargetManagerById(e){for(let t=0;t<this.morphTargetManagers.length;t++)if(this.morphTargetManagers[t].uniqueId===e)return this.morphTargetManagers[t];return null}getMorphTargetById(e){for(let t=0;t<this.morphTargetManagers.length;++t){let i=this.morphTargetManagers[t];for(let r=0;r<i.numTargets;++r){let n=i.getTarget(r);if(n.id===e)return n}}return null}getMorphTargetByName(e){for(let t=0;t<this.morphTargetManagers.length;++t){let i=this.morphTargetManagers[t];for(let r=0;r<i.numTargets;++r){let n=i.getTarget(r);if(n.name===e)return n}}return null}getPostProcessByName(e){for(let t=0;t<this.postProcesses.length;++t){let i=this.postProcesses[t];if(i.name===e)return i}return null}isActiveMesh(e){return this._activeMeshes.indexOf(e)!==-1}get uid(){return this._uid||(this._uid=W.RandomId()),this._uid}addExternalData(e,t){return this._externalData||(this._externalData=new Wh),this._externalData.add(e,t)}getExternalData(e){return this._externalData?this._externalData.get(e):null}getOrAddExternalDataWithFactory(e,t){return this._externalData||(this._externalData=new Wh),this._externalData.getOrAddWithFactory(e,t)}removeExternalData(e){return this._externalData.remove(e)}_evaluateSubMesh(e,t,i,r){if(r||e.isInFrustum(this._frustumPlanes)){for(let a of this._evaluateSubMeshStage)a.action(t,e);let n=e.getMaterial();n!=null&&(n.hasRenderTargetTextures&&n.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(n)===-1&&(this._processedMaterials.push(n),this._materialsRenderTargets.concatWithNoDuplicate(n.getRenderTargetTextures())),this._renderingManager.dispatch(e,t,n))}}freeProcessedMaterials(){this._processedMaterials.dispose()}get blockfreeActiveMeshesAndRenderingGroups(){return this._preventFreeActiveMeshesAndRenderingGroups}set blockfreeActiveMeshesAndRenderingGroups(e){this._preventFreeActiveMeshesAndRenderingGroups!==e&&(e&&(this.freeActiveMeshes(),this.freeRenderingGroups()),this._preventFreeActiveMeshesAndRenderingGroups=e)}freeActiveMeshes(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._activeMeshes.dispose(),this.activeCamera&&this.activeCamera._activeMeshes&&this.activeCamera._activeMeshes.dispose(),this.activeCameras))for(let e=0;e<this.activeCameras.length;e++){let t=this.activeCameras[e];t&&t._activeMeshes&&t._activeMeshes.dispose()}}freeRenderingGroups(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._renderingManager&&this._renderingManager.freeRenderingGroups(),this.textures))for(let e=0;e<this.textures.length;e++){let t=this.textures[e];t&&t.renderList&&t.freeRenderingGroups()}}_isInIntermediateRendering(){return this._intermediateRendering}freezeActiveMeshes(e=!1,t,i,r=!0,n=!1){if(this.frameGraph){this._renderWithFrameGraph(!0,!1,!0);let a=this.frameGraph.getTasksByType(ka);for(let o of a)o.objectRenderer._freezeActiveMeshes(r);return this._freezeActiveMeshesCancel=br(()=>{let o=!0,l=!0;for(let c of a)o&&(o=c.objectRenderer._isFrozen),l&&(l=c.objectRenderer._freezeActiveMeshesCancel!==null);if(o)return!0;if(!l)throw new Error("Freezing active meshes was cancelled");return!1},()=>{this._freezeActiveMeshesCancel=null,this._activeMeshesFrozen=!0,this._activeMeshesFrozenButKeepClipping=n,this._skipEvaluateActiveMeshesCompletely=e,t?.()},(o,l)=>{if(this._freezeActiveMeshesCancel=null,this.unfreezeActiveMeshes(),l){let c="Scene: Timeout while waiting for meshes to be frozen.";i?i(c):(P.Error(c),o&&P.Error(o))}else{let c="Scene: An unexpected error occurred while trying to freeze active meshes.";i?i(c):(P.Error(c),o&&(P.Error(o),o.stack&&P.Error(o.stack)))}}),this}return this.executeWhenReady(()=>{if(!this.activeCamera){i&&i("No active camera found");return}if(this._frustumPlanes||this.updateTransformMatrix(),this._evaluateActiveMeshes(),this._activeMeshesFrozen=!0,this._activeMeshesFrozenButKeepClipping=n,this._skipEvaluateActiveMeshesCompletely=e,r)for(let a=0;a<this._activeMeshes.length;a++)this._activeMeshes.data[a]._freeze();t&&t()}),this}unfreezeActiveMeshes(){for(let e=0;e<this.meshes.length;e++){let t=this.meshes[e];t._internalAbstractMeshDataInfo&&(t._internalAbstractMeshDataInfo._isActive=!1)}if(this._freezeActiveMeshesCancel?.(),this._freezeActiveMeshesCancel=null,this.frameGraph){let e=this.frameGraph.getTasksByType(ka);for(let t of e)t.objectRenderer._unfreezeActiveMeshes()}else for(let e=0;e<this._activeMeshes.length;e++)this._activeMeshes.data[e]._unFreeze();return this._activeMeshesFrozen=!1,this}_executeActiveContainerCleanup(e){!(this._engine.snapshotRendering&&this._engine.snapshotRenderingMode===1)&&this._activeMeshesFrozen&&this._activeMeshes.length||this.onBeforeRenderObservable.addOnce(()=>e.dispose())}_evaluateActiveMeshes(){if(this._engine.snapshotRendering&&this._engine.snapshotRenderingMode===1){this._activeMeshes.length>0&&(this.activeCamera?._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset());return}if(this._activeMeshesFrozen&&this._activeMeshes.length){if(!this._skipEvaluateActiveMeshesCompletely){let i=this._activeMeshes.length;for(let r=0;r<i;r++)this._activeMeshes.data[r].computeWorldMatrix()}if(this._activeParticleSystems){let i=this._activeParticleSystems.length;for(let r=0;r<i;r++)this._activeParticleSystems.data[r].animate()}this._renderingManager.resetSprites();return}if(!this.activeCamera)return;this.onBeforeActiveMeshesEvaluationObservable.notifyObservers(this),this.activeCamera._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset(),this._materialsRenderTargets.reset();for(let i of this._beforeEvaluateActiveMeshStage)i.action();let e=this.getActiveMeshCandidates(),t=e.length;for(let i=0;i<t;i++){let r=e.data[i],n=r._internalAbstractMeshDataInfo._currentLOD.get(this.activeCamera);if(n?n[1]=-1:(n=[r,-1],r._internalAbstractMeshDataInfo._currentLOD.set(this.activeCamera,n)),r.isBlocked||(this._totalVertices.addCount(r.getTotalVertices(),!1),!r.isReady()||!r.isEnabled()||r.scaling.hasAZeroComponent))continue;r.computeWorldMatrix(),r.actionManager&&r.actionManager.hasSpecificTriggers2(12,13)&&this._meshesForIntersections.pushNoDuplicate(r);let a=this.customLODSelector?this.customLODSelector(r,this.activeCamera):r.getLOD(this.activeCamera);if(n[0]=a,n[1]=this._frameId,a!=null&&(a!==r&&a.billboardMode!==0&&a.computeWorldMatrix(),r._preActivate(),r.isVisible&&r.visibility>0&&(r.layerMask&this.activeCamera.layerMask)!==0&&(this._skipFrustumClipping||r.alwaysSelectAsActiveMesh||r.isInFrustum(this._frustumPlanes)))){this._activeMeshes.push(r),this.activeCamera._activeMeshes.push(r),a!==r&&a._activate(this._renderId,!1);for(let o of this._preActiveMeshStage)o.action(r);r._activate(this._renderId,!1)&&(r.isAnInstance?r._internalAbstractMeshDataInfo._actAsRegularMesh&&(a=r):a._internalAbstractMeshDataInfo._onlyForInstances=!1,a._internalAbstractMeshDataInfo._isActive=!0,this._activeMesh(r,a)),r._postActivate()}}if(this.onAfterActiveMeshesEvaluationObservable.notifyObservers(this),this.particlesEnabled){this.onBeforeParticlesRenderingObservable.notifyObservers(this);for(let i=0;i<this.particleSystems.length;i++){let r=this.particleSystems[i];if(!r.isStarted()||!r.emitter)continue;let n=r.emitter;(!n.position||n.isEnabled())&&(this._activeParticleSystems.push(r),r.animate(),this._renderingManager.dispatchParticles(r))}this.onAfterParticlesRenderingObservable.notifyObservers(this)}}_prepareSkeleton(e){!this._skeletonsEnabled||!e.skeleton||(this._activeSkeletons.pushNoDuplicate(e.skeleton)&&(e.skeleton.prepare(),this._activeBones.addCount(e.skeleton.bones.length,!1)),e.computeBonesUsingShaders||this._softwareSkinnedMeshes.pushNoDuplicate(e)&&this.frameGraph&&e.applySkeleton(e.skeleton))}_activeMesh(e,t){this._prepareSkeleton(t);let i=e.hasInstances||e.isAnInstance||this.dispatchAllSubMeshesOfActiveMeshes||this._skipFrustumClipping||t.alwaysSelectAsActiveMesh;if(t&&t.subMeshes&&t.subMeshes.length>0){let r=this.getActiveSubMeshCandidates(t),n=r.length;i=i||n===1;for(let a=0;a<n;a++){let o=r.data[a];this._evaluateSubMesh(o,t,e,i)}}}updateTransformMatrix(e){let t=this.activeCamera;if(t)if(t._renderingMultiview){let i=t._rigCameras[0],r=t._rigCameras[1];this.setTransformMatrix(i.getViewMatrix(),i.getProjectionMatrix(e),r.getViewMatrix(),r.getProjectionMatrix(e))}else this.setTransformMatrix(t.getViewMatrix(),t.getProjectionMatrix(e))}_bindFrameBuffer(e,t=!0){this._useCurrentFrameBuffer||(e&&e._multiviewTexture?e._multiviewTexture._bindFrameBuffer():e&&e.outputRenderTarget?e.outputRenderTarget._bindFrameBuffer():this._engine._currentFrameBufferIsDefaultFrameBuffer()||this._engine.restoreDefaultFramebuffer()),t&&this._clearFrameBuffer(e)}_clearFrameBuffer(e){if(!(e&&e._multiviewTexture))if(e&&e.outputRenderTarget&&!e._renderingMultiview){let t=e.outputRenderTarget;t.onClearObservable.hasObservers()?t.onClearObservable.notifyObservers(this._engine):!t.skipInitialClear&&!e.isRightCamera&&(this.autoClear&&this._engine.clear(t.clearColor||this._clearColor,!t._cleared,!0,!0),t._cleared=!0)}else this._defaultFrameBufferCleared?this._engine.clear(null,!1,!0,!0):(this._defaultFrameBufferCleared=!0,this._clear())}_renderForCamera(e,t,i=!0){if(e&&e._skipRendering)return;let r=this._engine;if(this._activeCamera=e,!this.activeCamera)throw new Error("Active camera not set");if(r.setViewport(this.activeCamera.viewport),this.resetCachedMaterial(),this._renderId++,!this.prePass&&i){let o=!0;e._renderingMultiview&&e.outputRenderTarget&&(o=e.outputRenderTarget.skipInitialClear,this.autoClear&&(this._defaultFrameBufferCleared=!1,e.outputRenderTarget.skipInitialClear=!1)),this._bindFrameBuffer(this._activeCamera),e._renderingMultiview&&e.outputRenderTarget&&(e.outputRenderTarget.skipInitialClear=o)}this.updateTransformMatrix(),this.onBeforeCameraRenderObservable.notifyObservers(this.activeCamera),this._evaluateActiveMeshes();for(let o=0;o<this._softwareSkinnedMeshes.length;o++){let l=this._softwareSkinnedMeshes.data[o];l.applySkeleton(l.skeleton)}this.onBeforeRenderTargetsRenderObservable.notifyObservers(this),this._renderTargets.concatWithNoDuplicate(this._materialsRenderTargets),e.customRenderTargets&&e.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(e.customRenderTargets),t&&t.customRenderTargets&&t.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(t.customRenderTargets),this.environmentTexture&&this.environmentTexture.isRenderTarget&&this._renderTargets.pushNoDuplicate(this.environmentTexture);for(let o of this._gatherActiveCameraRenderTargetsStage)o.action(this._renderTargets);let n=!1;if(this.renderTargetsEnabled){if(this._intermediateRendering=!0,this._renderTargets.length>0){W.StartPerformanceCounter("Render targets",this._renderTargets.length>0);let o=this.getBoundingBoxRenderer?.(),l;for(let c=0;c<this._renderTargets.length;c++){let f=this._renderTargets.data[c];if(f._shouldRender()){this._renderId++;let h=f.activeCamera&&f.activeCamera!==this.activeCamera;o&&!l&&(l=o.renderList.length>0?o.renderList.data.slice():[],l.length=o.renderList.length),f.render(h,this.dumpNextRenderTargets),n=!0}}o&&l&&(o.renderList.data=l,o.renderList.length=l.length),W.EndPerformanceCounter("Render targets",this._renderTargets.length>0),this._renderId++}for(let o of this._cameraDrawRenderTargetStage)n=o.action(this.activeCamera)||n;this._intermediateRendering=!1}this._engine.currentRenderPassId=e.outputRenderTarget?.renderPassId??e.renderPassId??0,n&&!this.prePass&&(this._bindFrameBuffer(this._activeCamera,!1),this.updateTransformMatrix()),this.onAfterRenderTargetsRenderObservable.notifyObservers(this),this.postProcessManager&&!e._multiviewTexture&&!this.prePass&&this.postProcessManager._prepareFrame();for(let o of this._beforeCameraDrawStage)o.action(this.activeCamera);this.onBeforeDrawPhaseObservable.notifyObservers(this);let a=r.snapshotRendering&&r.snapshotRenderingMode===1;a&&this.finalizeSceneUbo(),this._renderingManager.render(null,null,!0,!a),this.onAfterDrawPhaseObservable.notifyObservers(this);for(let o of this._afterCameraDrawStage)o.action(this.activeCamera);if(this.postProcessManager&&!e._multiviewTexture){let o=e.outputRenderTarget?e.outputRenderTarget.renderTarget:void 0;this.postProcessManager._finalizeFrame(e.isIntermediate,o)}for(let o of this._afterCameraPostProcessStage)o.action(this.activeCamera);this._renderTargets.reset(),this.onAfterCameraRenderObservable.notifyObservers(this.activeCamera)}_processSubCameras(e,t=!0){if(e.cameraRigMode===0||e._renderingMultiview){e._renderingMultiview&&!this._multiviewSceneUbo&&this._createMultiviewUbo(),this._renderForCamera(e,void 0,t),this.onAfterRenderCameraObservable.notifyObservers(e);return}if(e._useMultiviewToSingleView)this._renderMultiviewToSingleView(e);else{this.onBeforeCameraRenderObservable.notifyObservers(e);for(let i=0;i<e._rigCameras.length;i++)this._renderForCamera(e._rigCameras[i],e)}this._activeCamera=e,this.updateTransformMatrix(),this.onAfterRenderCameraObservable.notifyObservers(e)}_checkIntersections(){for(let e=0;e<this._meshesForIntersections.length;e++){let t=this._meshesForIntersections.data[e];if(t.actionManager)for(let i=0;t.actionManager&&i<t.actionManager.actions.length;i++){let r=t.actionManager.actions[i];if(r.trigger===12||r.trigger===13){let n=r.getTriggerParameter(),a=n.mesh?n.mesh:n,o=a.intersectsMesh(t,n.usePreciseIntersection),l=t._intersectionsInProgress.indexOf(a);o&&l===-1?r.trigger===12?(r._executeCurrent(Mi.CreateNew(t,void 0,a)),t._intersectionsInProgress.push(a)):r.trigger===13&&t._intersectionsInProgress.push(a):!o&&l>-1&&(r.trigger===13&&r._executeCurrent(Mi.CreateNew(t,void 0,a)),(!t.actionManager.hasSpecificTrigger(13,c=>{let f=c.mesh?c.mesh:c;return a===f})||r.trigger===13)&&t._intersectionsInProgress.splice(l,1))}}}}_advancePhysicsEngineStep(e){}_animate(e){}animate(){if(this._engine.isDeterministicLockStep()){let e=Math.max(s.MinDeltaTime,Math.min(this._engine.getDeltaTime(),s.MaxDeltaTime))+this._timeAccumulator,t=this._engine.getTimeStep(),i=1e3/t/1e3,r=0,n=this._engine.getLockstepMaxSteps(),a=Math.floor(e/t);for(a=Math.min(a,n);e>0&&r<a;)this.onBeforeStepObservable.notifyObservers(this),this._animationRatio=t*i,this._animate(t),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(t),this.onAfterStepObservable.notifyObservers(this),this._currentStepId++,r++,e-=t;this._timeAccumulator=e<0?0:e}else{let e=this.useConstantAnimationDeltaTime?16:Math.max(s.MinDeltaTime,Math.min(this._engine.getDeltaTime(),s.MaxDeltaTime));this._animationRatio=e*(60/1e3),this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(e)}}_clear(){(this.autoClearDepthAndStencil||this.autoClear)&&this._engine.clear(this._clearColor,this.autoClear||this.forceWireframe||this.forcePointsCloud,this.autoClearDepthAndStencil,this.autoClearDepthAndStencil)}_checkCameraRenderTarget(e){if(e?.outputRenderTarget&&!e?.isRigCamera&&(e.outputRenderTarget._cleared=!1),e?.rigCameras?.length)for(let t=0;t<e.rigCameras.length;++t){let i=e.rigCameras[t].outputRenderTarget;i&&(i._cleared=!1)}}resetDrawCache(e){if(this.meshes)for(let t of this.meshes)t.resetDrawCache(e)}_renderWithFrameGraph(e=!0,t=!1,i=!1){if(this.activeCamera=null,this.activeCameras=null,e){for(let r of this.cameras)if(r.update(),r.cameraRigMode!==0)for(let n=0;n<r._rigCameras.length;n++)r._rigCameras[n].update()}this.onBeforeRenderObservable.notifyObservers(this);for(let r of this._beforeClearStage)r.action();if(this._engine.snapshotRendering&&this._engine.snapshotRenderingMode===1)this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset();else{let r=this.getActiveMeshCandidates(),n=r.length;if(this._activeMeshesFrozen){if(!this._skipEvaluateActiveMeshesCompletely)for(let a=0;a<n;a++){let o=r.data[a];o._internalAbstractMeshDataInfo._wasActiveLastFrame&&o.computeWorldMatrix()}if(this.particlesEnabled){let a=this._activeParticleSystems.length;for(let o=0;o<a;o++)this._activeParticleSystems.data[o].animate()}}else{this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset();for(let a=0;a<n;a++){let o=r.data[a];o._internalAbstractMeshDataInfo._wasActiveLastFrame=!1,!o.isBlocked&&(this._totalVertices.addCount(o.getTotalVertices(),!1),!(!o.isReady()||!o.isEnabled()||o.scaling.hasAZeroComponent)&&(o.computeWorldMatrix(i),o.actionManager&&o.actionManager.hasSpecificTriggers2(12,13)&&this._meshesForIntersections.pushNoDuplicate(o)))}if(this.particlesEnabled)for(let a=0;a<this.particleSystems.length;a++){let o=this.particleSystems[a];if(!o.isStarted()||!o.emitter)continue;let l=o.emitter;(!l.position||l.isEnabled())&&(this._activeParticleSystems.push(o),o.animate())}}}this.frameGraph?.execute()}_renderRenderTarget(e,t,i=!1,r=!1){if(this._intermediateRendering=!0,e._shouldRender()){if(this._renderId++,this.activeCamera=t,!this.activeCamera)throw new Error("Active camera not set");this._engine.setViewport(this.activeCamera.viewport),this.updateTransformMatrix(),e.render(i,r)}this._intermediateRendering=!1}render(e=!0,t=!1){if(!this.isDisposed){if(this.onReadyObservable.hasObservers()&&this._executeWhenReadyTimeoutId===null&&this._checkIsReady(),this._frameId++,this._defaultFrameBufferCleared=!1,this._checkCameraRenderTarget(this.activeCamera),this.activeCameras?.length)for(let i of this.activeCameras)this._checkCameraRenderTarget(i);this._registerTransientComponents(),this._activeParticles.fetchNewFrame(),this._totalVertices.fetchNewFrame(),this._activeIndices.fetchNewFrame(),this._activeBones.fetchNewFrame(),this._meshesForIntersections.reset(),this.resetCachedMaterial(),this.onBeforeAnimationsObservable.notifyObservers(this),this.actionManager&&this.actionManager.processTrigger(11),t||this.animate();for(let i of this._beforeCameraUpdateStage)i.action();if(e){if(this.activeCameras&&this.activeCameras.length>0)for(let i=0;i<this.activeCameras.length;i++){let r=this.activeCameras[i];if(r.update(),r.cameraRigMode!==0)for(let n=0;n<r._rigCameras.length;n++)r._rigCameras[n].update()}else if(this.activeCamera&&(this.activeCamera.update(),this.activeCamera.cameraRigMode!==0))for(let i=0;i<this.activeCamera._rigCameras.length;i++)this.activeCamera._rigCameras[i].update()}if(this.customRenderFunction)this._renderId++,this._engine.currentRenderPassId=0,this.customRenderFunction(e,t);else{this.onBeforeRenderObservable.notifyObservers(this),this.onBeforeRenderTargetsRenderObservable.notifyObservers(this);let i=this.activeCameras?.length?this.activeCameras[0]:this.activeCamera;if(this.renderTargetsEnabled){W.StartPerformanceCounter("Custom render targets",this.customRenderTargets.length>0);for(let r=0;r<this.customRenderTargets.length;r++){let n=this.customRenderTargets[r],a=n.activeCamera||this.activeCamera;this._renderRenderTarget(n,a,i!==a,this.dumpNextRenderTargets)}W.EndPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._renderId++}this._engine.currentRenderPassId=i?.renderPassId??0,this.activeCamera=i,this._activeCamera&&this._activeCamera.cameraRigMode!==22&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this);for(let r of this._beforeClearStage)r.action();this._clearFrameBuffer(this.activeCamera);for(let r of this._gatherRenderTargetsStage)r.action(this._renderTargets);if(this.activeCameras&&this.activeCameras.length>0)for(let r=0;r<this.activeCameras.length;r++)this._processSubCameras(this.activeCameras[r],r>0);else{if(!this.activeCamera)throw new Error("No camera defined");this._processSubCameras(this.activeCamera,!!this.activeCamera.outputRenderTarget)}}this._checkIntersections();for(let i of this._afterRenderStage)i.action();if(this.afterRender&&this.afterRender(),this.onAfterRenderObservable.notifyObservers(this),this._toBeDisposed.length){for(let i=0;i<this._toBeDisposed.length;i++){let r=this._toBeDisposed[i];r&&r.dispose()}this._toBeDisposed.length=0}this.dumpNextRenderTargets&&(this.dumpNextRenderTargets=!1),this._activeBones.addCount(0,!0),this._activeIndices.addCount(0,!0),this._activeParticles.addCount(0,!0),this._engine.restoreDefaultFramebuffer()}}freezeMaterials(){for(let e=0;e<this.materials.length;e++)this.materials[e].freeze()}unfreezeMaterials(){for(let e=0;e<this.materials.length;e++)this.materials[e].unfreeze()}dispose(){if(this.isDisposed)return;if(this.beforeRender=null,this.afterRender=null,this.metadata=null,this.skeletons.length=0,this.morphTargetManagers.length=0,this._transientComponents.length=0,this._isReadyForMeshStage.clear(),this._beforeEvaluateActiveMeshStage.clear(),this._evaluateSubMeshStage.clear(),this._preActiveMeshStage.clear(),this._cameraDrawRenderTargetStage.clear(),this._beforeCameraDrawStage.clear(),this._beforeRenderTargetDrawStage.clear(),this._beforeRenderingGroupDrawStage.clear(),this._beforeRenderingMeshStage.clear(),this._afterRenderingMeshStage.clear(),this._afterRenderingGroupDrawStage.clear(),this._afterCameraDrawStage.clear(),this._afterRenderTargetDrawStage.clear(),this._afterRenderStage.clear(),this._beforeCameraUpdateStage.clear(),this._beforeClearStage.clear(),this._gatherRenderTargetsStage.clear(),this._gatherActiveCameraRenderTargetsStage.clear(),this._pointerMoveStage.clear(),this._pointerDownStage.clear(),this._pointerUpStage.clear(),this.importedMeshesFiles=[],this._activeAnimatables&&this.stopAllAnimations){for(let n of this._activeAnimatables)n.onAnimationEndObservable.clear(),n.onAnimationEnd=null;this.stopAllAnimations()}this.resetCachedMaterial(),this.activeCamera&&(this.activeCamera._activeMeshes.dispose(),this.activeCamera=null),this.activeCameras=null,this._activeMeshes.dispose(),this._renderingManager.dispose(),this._processedMaterials.dispose(),this._activeParticleSystems.dispose(),this._activeSkeletons.dispose(),this._softwareSkinnedMeshes.dispose(),this._renderTargets.dispose(),this._materialsRenderTargets.dispose(),this._registeredForLateAnimationBindings.dispose(),this._meshesForIntersections.dispose(),this._toBeDisposed.length=0;let e=this._activeRequests.slice();for(let n of e)n.abort();this._activeRequests.length=0;try{this.onDisposeObservable.notifyObservers(this)}catch(n){P.Error("An error occurred while calling onDisposeObservable!",n)}if(this.detachControl(),this._engine.getInputElement())for(let n=0;n<this.cameras.length;n++)this.cameras[n].detachControl();this._disposeList(this.animationGroups),this._disposeList(this.lights),this._defaultMaterial&&this._defaultMaterial.dispose(),this._disposeList(this.multiMaterials),this._disposeList(this.materials),this._disposeList(this.meshes,n=>n.dispose(!0)),this._disposeList(this.transformNodes,n=>n.dispose(!0));let i=this.cameras;this._disposeList(i),this._disposeList(this.particleSystems),this._disposeList(this.postProcesses),this._disposeList(this.textures),this._disposeList(this.morphTargetManagers),this._disposeList(this.frameGraphs),this._sceneUbo.dispose(),this._multiviewSceneUbo&&this._multiviewSceneUbo.dispose(),this.postProcessManager.dispose(),this._disposeList(this._components);let r=this._engine.scenes.indexOf(this);if(r>-1&&this._engine.scenes.splice(r,1),Z._LastCreatedScene===this){Z._LastCreatedScene=null;let n=Z.Instances.length-1;for(;n>=0;){let a=Z.Instances[n];if(a.scenes.length>0){Z._LastCreatedScene=a.scenes[this._engine.scenes.length-1];break}n--}}r=this._engine._virtualScenes.indexOf(this),r>-1&&this._engine._virtualScenes.splice(r,1),this._engine.wipeCaches(!0),this.onDisposeObservable.clear(),this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderTargetsRenderObservable.clear(),this.onAfterRenderTargetsRenderObservable.clear(),this.onAfterStepObservable.clear(),this.onBeforeStepObservable.clear(),this.onBeforeActiveMeshesEvaluationObservable.clear(),this.onAfterActiveMeshesEvaluationObservable.clear(),this.onBeforeParticlesRenderingObservable.clear(),this.onAfterParticlesRenderingObservable.clear(),this.onBeforeDrawPhaseObservable.clear(),this.onAfterDrawPhaseObservable.clear(),this.onBeforeAnimationsObservable.clear(),this.onAfterAnimationsObservable.clear(),this.onDataLoadedObservable.clear(),this.onBeforeRenderingGroupObservable.clear(),this.onAfterRenderingGroupObservable.clear(),this.onMeshImportedObservable.clear(),this.onBeforeCameraRenderObservable.clear(),this.onAfterCameraRenderObservable.clear(),this.onAfterRenderCameraObservable.clear(),this.onReadyObservable.clear(),this.onNewCameraAddedObservable.clear(),this.onCameraRemovedObservable.clear(),this.onNewLightAddedObservable.clear(),this.onLightRemovedObservable.clear(),this.onNewGeometryAddedObservable.clear(),this.onGeometryRemovedObservable.clear(),this.onNewTransformNodeAddedObservable.clear(),this.onTransformNodeRemovedObservable.clear(),this.onNewMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onNewSkeletonAddedObservable.clear(),this.onSkeletonRemovedObservable.clear(),this.onNewMaterialAddedObservable.clear(),this.onNewMultiMaterialAddedObservable.clear(),this.onMaterialRemovedObservable.clear(),this.onMultiMaterialRemovedObservable.clear(),this.onNewTextureAddedObservable.clear(),this.onTextureRemovedObservable.clear(),this.onNewFrameGraphAddedObservable.clear(),this.onFrameGraphRemovedObservable.clear(),this.onNewObjectRendererAddedObservable.clear(),this.onObjectRendererRemovedObservable.clear(),this.onPrePointerObservable.clear(),this.onPointerObservable.clear(),this.onPreKeyboardObservable.clear(),this.onKeyboardObservable.clear(),this.onActiveCameraChanged.clear(),this.onScenePerformancePriorityChangedObservable.clear(),this.onClearColorChangedObservable.clear(),this.onEnvironmentTextureChangedObservable.clear(),this.onMeshUnderPointerUpdatedObservable.clear(),this._isDisposed=!0}_disposeList(e,t){let i=e.slice(0);t=t??(r=>r.dispose());for(let r of i)t(r);e.length=0}get isDisposed(){return this._isDisposed}clearCachedVertexData(){for(let e=0;e<this.meshes.length;e++){let i=this.meshes[e].geometry;i&&i.clearCachedData()}}cleanCachedTextureBuffer(){for(let e of this.textures)e._buffer&&(e._buffer=null)}getWorldExtends(e){let t=new E(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),i=new E(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);e=e||(()=>!0);let r=this.meshes.filter(e);for(let n of r){if(n.computeWorldMatrix(!0),!n.subMeshes||n.subMeshes.length===0||n.infiniteDistance)continue;let a=n.getBoundingInfo(),o=a.boundingBox.minimumWorld,l=a.boundingBox.maximumWorld;E.CheckExtends(o,t,i),E.CheckExtends(l,t,i)}return{min:t,max:i}}createPickingRay(e,t,i,r,n=!1){throw pe("Ray")}createPickingRayToRef(e,t,i,r,n,a=!1,o=!1){throw pe("Ray")}createPickingRayInCameraSpace(e,t,i){throw pe("Ray")}createPickingRayInCameraSpaceToRef(e,t,i,r){throw pe("Ray")}pick(e,t,i,r,n,a){let o=pe("Ray",!0);return o&&P.Warn(o),new Zi}pickWithBoundingInfo(e,t,i,r,n){let a=pe("Ray",!0);return a&&P.Warn(a),new Zi}pickWithRay(e,t,i,r){throw pe("Ray")}multiPick(e,t,i,r,n){throw pe("Ray")}multiPickWithRay(e,t,i){throw pe("Ray")}setPointerOverMesh(e,t,i){this._inputManager.setPointerOverMesh(e,t,i)}getPointerOverMesh(){return this._inputManager.getPointerOverMesh()}_rebuildGeometries(){for(let e of this.geometries)e._rebuild();for(let e of this.meshes)e._rebuild();this.postProcessManager&&this.postProcessManager._rebuild();for(let e of this._components)e.rebuild();for(let e of this.particleSystems)e.rebuild();if(this.spriteManagers)for(let e of this.spriteManagers)e.rebuild()}_rebuildTextures(){for(let e of this.textures)e._rebuild(!0);this.markAllMaterialsAsDirty(1)}_getByTags(e,t,i){if(t===void 0)return e;let r=[];for(let n in e){let a=e[n];st&&st.MatchesQuery(a,t)&&(!i||i(a))&&r.push(a)}return r}getMeshesByTags(e,t){return this._getByTags(this.meshes,e,t)}getCamerasByTags(e,t){return this._getByTags(this.cameras,e,t)}getLightsByTags(e,t){return this._getByTags(this.lights,e,t)}getMaterialByTags(e,t){return this._getByTags(this.materials,e,t).concat(this._getByTags(this.multiMaterials,e,t))}getTransformNodesByTags(e,t){return this._getByTags(this.transformNodes,e,t)}setRenderingOrder(e,t=null,i=null,r=null){this._renderingManager.setRenderingOrder(e,t,i,r)}setRenderingAutoClearDepthStencil(e,t,i=!0,r=!0){this._renderingManager.setRenderingAutoClearDepthStencil(e,t,i,r)}getAutoClearDepthStencilSetup(e){return this._renderingManager.getAutoClearDepthStencilSetup(e)}_forceBlockMaterialDirtyMechanism(e){this._blockMaterialDirtyMechanism=e}get blockMaterialDirtyMechanism(){return this._blockMaterialDirtyMechanism}set blockMaterialDirtyMechanism(e){this._blockMaterialDirtyMechanism!==e&&(this._blockMaterialDirtyMechanism=e,e||this.markAllMaterialsAsDirty(127))}markAllMaterialsAsDirty(e,t){if(!this._blockMaterialDirtyMechanism)for(let i of this.materials)t&&!t(i)||i.markAsDirty(e)}_loadFile(e,t,i,r,n,a,o){let l=kn(e,t,i,r?this.offlineProvider:void 0,n,a,o);return this._activeRequests.push(l),l.onCompleteObservable.add(c=>{this._activeRequests.splice(this._activeRequests.indexOf(c),1)}),l}async _loadFileAsync(e,t,i,r,n){return await new Promise((a,o)=>{this._loadFile(e,l=>{a(l)},t,i,r,(l,c)=>{o(c)},n)})}_requestFile(e,t,i,r,n,a,o){let l=zm(e,t,i,r?this.offlineProvider:void 0,n,a,o);return this._activeRequests.push(l),l.onCompleteObservable.add(c=>{this._activeRequests.splice(this._activeRequests.indexOf(c),1)}),l}async _requestFileAsync(e,t,i,r,n){return await new Promise((a,o)=>{this._requestFile(e,l=>{a(l)},t,i,r,l=>{o(l)},n)})}_readFile(e,t,i,r,n){let a=Dl(e,t,i,r,n);return this._activeRequests.push(a),a.onCompleteObservable.add(o=>{this._activeRequests.splice(this._activeRequests.indexOf(o),1)}),a}async _readFileAsync(e,t,i){return await new Promise((r,n)=>{this._readFile(e,a=>{r(a)},t,i,a=>{n(a)})})}getPerfCollector(){throw pe("performanceViewerSceneExtension")}setActiveCameraByID(e){return this.setActiveCameraById(e)}getMaterialByID(e){return this.getMaterialById(e)}getLastMaterialByID(e){return this.getLastMaterialById(e)}getTextureByUniqueID(e){return this.getTextureByUniqueId(e)}getCameraByID(e){return this.getCameraById(e)}getCameraByUniqueID(e){return this.getCameraByUniqueId(e)}getBoneByID(e){return this.getBoneById(e)}getLightByID(e){return this.getLightById(e)}getLightByUniqueID(e){return this.getLightByUniqueId(e)}getParticleSystemByID(e){return this.getParticleSystemById(e)}getGeometryByID(e){return this.getGeometryById(e)}getMeshByID(e){return this.getMeshById(e)}getMeshByUniqueID(e){return this.getMeshByUniqueId(e)}getLastMeshByID(e){return this.getLastMeshById(e)}getMeshesByID(e){return this.getMeshesById(e)}getTransformNodeByID(e){return this.getTransformNodeById(e)}getTransformNodeByUniqueID(e){return this.getTransformNodeByUniqueId(e)}getTransformNodesByID(e){return this.getTransformNodesById(e)}getNodeByID(e){return this.getNodeById(e)}getLastEntryByID(e){return this.getLastEntryById(e)}getLastSkeletonByID(e){return this.getLastSkeletonById(e)}};ze.FOGMODE_NONE=0;ze.FOGMODE_EXP=1;ze.FOGMODE_EXP2=2;ze.FOGMODE_LINEAR=3;ze.MinDeltaTime=1;ze.MaxDeltaTime=1e3;ze._OriginalDefaultMaterialFactory=ze.DefaultMaterialFactory;G("BABYLON.Scene",ze)});var Sb={};V(Sb,{rgbdDecodePixelShaderWGSL:()=>dj});var vb,VN,dj,Eb=S(()=>{O();Pi();vb="rgbdDecodePixelShader",VN=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;
#include<helperFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=vec4f(fromRGBD(textureSample(textureSampler,textureSamplerSampler,input.vUV)),1.0);}`;g.ShadersStoreWGSL[vb]||(g.ShadersStoreWGSL[vb]=VN);dj={name:vb,shader:VN}});var xb={};V(xb,{rgbdDecodePixelShader:()=>pj});var Tb,kN,pj,Ab=S(()=>{O();Di();Tb="rgbdDecodePixelShader",kN=`varying vec2 vUV;uniform sampler2D textureSampler;
#include<helperFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{gl_FragColor=vec4(fromRGBD(texture2D(textureSampler,vUV)),1.0);}`;g.ShadersStore[Tb]||(g.ShadersStore[Tb]=kN);pj={name:Tb,shader:kN}});var HN={};V(HN,{rgbdEncodePixelShader:()=>mj});var Rb,WN,mj,zN=S(()=>{O();Di();Rb="rgbdEncodePixelShader",WN=`varying vec2 vUV;uniform sampler2D textureSampler;
#include<helperFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{gl_FragColor=toRGBD(texture2D(textureSampler,vUV).rgb);}`;g.ShadersStore[Rb]||(g.ShadersStore[Rb]=WN);mj={name:Rb,shader:WN}});var YN={};V(YN,{rgbdEncodePixelShaderWGSL:()=>_j});var bb,XN,_j,KN=S(()=>{O();Pi();bb="rgbdEncodePixelShader",XN=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;
#include<helperFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=toRGBD(textureSample(textureSampler,textureSamplerSampler,input.vUV).rgb);}`;g.ShadersStoreWGSL[bb]||(g.ShadersStoreWGSL[bb]=XN);_j={name:bb,shader:XN}});var ff,Cb=S(()=>{Wr();Hc();ff=class{static ExpandRGBDTexture(e){let t=e._texture;if(!t||!e.isRGBD)return;let i=t.getEngine(),r=i.getCaps(),n=t.isReady,a=!1;r.textureHalfFloatRender&&r.textureHalfFloatLinearFiltering?(a=!0,t.type=2):r.textureFloatRender&&r.textureFloatLinearFiltering&&(a=!0,t.type=1),a&&(t.isReady=!1,t._isRGBD=!1,t.invertY=!1);let o=async()=>{let l=i.isWebGPU,c=l?1:0;t.isReady=!1,l?await Promise.resolve().then(()=>(Eb(),Sb)):await Promise.resolve().then(()=>(Ab(),xb));let f=new at("rgbdDecode","rgbdDecode",null,null,1,null,3,i,!1,void 0,t.type,void 0,null,!1,void 0,c);f.externalTextureSamplerBinding=!0;let h=i.createRenderTargetTexture(t.width,{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:t.samplingMode,type:t.type,format:5});f.onEffectCreatedObservable.addOnce(u=>{u.executeWhenCompiled(()=>{f.onApply=d=>{d._bindTexture("textureSampler",t),d.setFloat2("scale",1,1)},e.getScene().postProcessManager.directRender([f],h,!0),i.restoreDefaultFramebuffer(),i._releaseTexture(t),f&&f.dispose(),h._swapAndDie(t),t.isReady=!0})})};a&&(n?o():e.onLoadObservable.addOnce(o))}static async EncodeTextureToRGBD(e,t,i=0){return t.getEngine().isWebGPU?await Promise.resolve().then(()=>(KN(),YN)):await Promise.resolve().then(()=>(zN(),HN)),await nL("rgbdEncode",e,t,i,1,5)}}});var Zh=S(()=>{Gp();ma();nt.prototype.forceSphericalPolynomialsRecompute=function(){this._texture&&(this._texture._sphericalPolynomial=null,this._texture._sphericalPolynomialPromise=null,this._texture._sphericalPolynomialComputed=!1)};Object.defineProperty(nt.prototype,"sphericalPolynomial",{get:function(){if(this._texture){if(this._texture._sphericalPolynomial||this._texture._sphericalPolynomialComputed)return this._texture._sphericalPolynomial;if(this._texture.isReady)return this._texture._sphericalPolynomialPromise||(this._texture._sphericalPolynomialPromise=qs.ConvertCubeMapTextureToSphericalPolynomial(this),this._texture._sphericalPolynomialPromise===null?this._texture._sphericalPolynomialComputed=!0:this._texture._sphericalPolynomialPromise.then(s=>{this._texture._sphericalPolynomial=s,this._texture._sphericalPolynomialComputed=!0})),null}return null},set:function(s){this._texture&&(this._texture._sphericalPolynomial=s)},enumerable:!0,configurable:!0})});function ZN(s){let e=new DataView(s.buffer,s.byteOffset,s.byteLength),t=0;for(let a=0;a<QN.length;a++)if(e.getUint8(t++)!==QN[a])return P.Error("Not a babylon environment map"),null;let i="",r=0;for(;r=e.getUint8(t++);)i+=String.fromCharCode(r);let n=JSON.parse(i);return n=Jh(n),n.binaryDataPosition=t,n.specular&&(n.specular.lodGenerationScale=n.specular.lodGenerationScale||.8),n}function Jh(s){if(s.version>qN)throw new Error(`Unsupported babylon environment map version "${s.version}". Latest supported version is "${qN}".`);return s.version===2||(s={...s,version:2,imageType:Xm}),s}function gj(s,e){e=Jh(e);let t=e.specular,i=Math.log2(e.width);if(i=Math.round(i)+1,t.mipmaps.length!==6*i)throw new Error(`Unsupported specular mipmaps number "${t.mipmaps.length}"`);let r=new Array(i);for(let n=0;n<i;n++){r[n]=new Array(6);for(let a=0;a<6;a++){let o=t.mipmaps[n*6+a];r[n][a]=new Uint8Array(s.buffer,s.byteOffset+e.binaryDataPosition+o.position,o.length)}}return r}function vj(s,e){e=Jh(e);let t=new Array(6),i=e.irradiance?.irradianceTexture;if(i){if(i.faces.length!==6)throw new Error(`Incorrect irradiance texture faces number "${i.faces.length}"`);for(let r=0;r<6;r++){let n=i.faces[r];t[r]=new Uint8Array(s.buffer,s.byteOffset+e.binaryDataPosition+n.position,n.length)}}return t}function JN(s,e,t){t=Jh(t);let i=t.specular;if(!i)return Promise.resolve([]);s._lodGenerationScale=i.lodGenerationScale;let r=[],n=gj(e,t);r.push(Ib(s,n,t.imageType));let a=t.irradiance?.irradianceTexture;if(a){let o=vj(e,t),l=null;t.irradiance?.irradianceTexture?.dominantDirection&&(l=E.FromArray(t.irradiance.irradianceTexture.dominantDirection)),r.push(Sj(s,o,a.size,t.imageType,l))}return Promise.all(r)}async function jN(s,e,t,i,r,n,a,o,l,c,f){return await new Promise((h,u)=>{if(t){let d=e.createTexture(null,!0,!0,null,1,null,p=>{u(p)},s);i?.onEffectCreatedObservable.addOnce(p=>{p.executeWhenCompiled(()=>{i.externalTextureSamplerBinding=!0,i.onApply=m=>{m._bindTexture("textureSampler",d),m.setFloat2("scale",1,e._features.needsInvertingBitmap&&s instanceof ImageBitmap?-1:1)},e.scenes.length&&(e.scenes[0].postProcessManager.directRender([i],c,!0,n,a),e.restoreDefaultFramebuffer(),d.dispose(),URL.revokeObjectURL(r),h())})})}else{if(e._uploadImageToTexture(f,s,n,a),o){let d=l[a];d&&e._uploadImageToTexture(d._texture,s,n,0)}h()}})}async function Ib(s,e,t=Xm){let i=s.getEngine();s.format=5,s.type=0,s.generateMipMaps=!0,s._cachedAnisotropicFilteringLevel=null,i.updateTextureSamplingMode(3,s),await $N(s,e,!0,t),s.isReady=!0}async function Sj(s,e,t,i=Xm,r=null){let n=s.getEngine(),a=new Je(n,5),o=new nt(n,a);s._irradianceTexture=o,o._dominantDirection=r,a.isCube=!0,a.format=5,a.type=0,a.generateMipMaps=!0,a._cachedAnisotropicFilteringLevel=null,a.generateMipMaps=!0,a.width=t,a.height=t,n.updateTextureSamplingMode(3,a),await $N(a,[e],!1,i),n.generateMipMapsForCubemap(a),a.isReady=!0}async function $N(s,e,t,i=Xm){if(!W.IsExponentOfTwo(s.width))throw new Error("Texture size must be a power of two");let r=bs(s.width)+1,n=s.getEngine(),a=!1,o=!1,l=null,c=null,f=null,h=n.getCaps();h.textureLOD?n._features.supportRenderAndCopyToLodForFloatTextures?h.textureHalfFloatRender&&h.textureHalfFloatLinearFiltering?(a=!0,s.type=2):h.textureFloatRender&&h.textureFloatLinearFiltering&&(a=!0,s.type=1):a=!1:(a=!1,o=t);let u=0;if(a)n.isWebGPU?(u=1,await Promise.resolve().then(()=>(Eb(),Sb))):await Promise.resolve().then(()=>(Ab(),xb)),l=new at("rgbdDecode","rgbdDecode",null,null,1,null,3,n,!1,void 0,s.type,void 0,null,!1,void 0,u),s._isRGBD=!1,s.invertY=!1,c=n.createRenderTargetCubeTexture(s.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:s.type,format:5});else if(s._isRGBD=!0,s.invertY=!0,o){f={};let m=s._lodGenerationScale,_=s._lodGenerationOffset;for(let v=0;v<3;v++){let C=1-v/2,I=_,R=(r-1)*m+_,b=I+(R-I)*C,M=Math.round(Math.min(Math.max(b,0),R)),F=new Je(n,2);F.isCube=!0,F.invertY=!0,F.generateMipMaps=!1,n.updateTextureSamplingMode(2,F);let U=new nt(null);switch(U._isCube=!0,U._texture=F,f[M]=U,v){case 0:s._lodTextureLow=U;break;case 1:s._lodTextureMid=U;break;case 2:s._lodTextureHigh=U;break}}}let d=[];for(let p=0;p<e.length;p++)for(let m=0;m<6;m++){let _=e[p][m],v=new Blob([_],{type:i}),T=URL.createObjectURL(v),C;if(n._features.forceBitmapOverHTMLImageElement)C=n.createImageBitmap(v,{premultiplyAlpha:"none"}).then(async I=>await jN(I,n,a,l,T,m,p,o,f,c,s));else{let I=new Image;I.src=T,C=new Promise((R,b)=>{I.onload=()=>{jN(I,n,a,l,T,m,p,o,f,c,s).then(()=>R()).catch(M=>{b(M)})},I.onerror=M=>{b(M)}})}d.push(C)}if(await Promise.all(d),e.length<r){let p,m=Math.pow(2,r-1-e.length),_=m*m*4;switch(s.type){case 0:{p=new Uint8Array(_);break}case 2:{p=new Uint16Array(_);break}case 1:{p=new Float32Array(_);break}}for(let v=e.length;v<r;v++)for(let T=0;T<6;T++)n._uploadArrayBufferViewToTexture(c?.texture||s,p,T,v)}if(c){let p=s._irradianceTexture;s._irradianceTexture=null,n._releaseTexture(s),c._swapAndDie(s),s._irradianceTexture=p}l&&l.dispose(),o&&(s._lodTextureHigh&&s._lodTextureHigh._texture&&(s._lodTextureHigh._texture.isReady=!0),s._lodTextureMid&&s._lodTextureMid._texture&&(s._lodTextureMid._texture.isReady=!0),s._lodTextureLow&&s._lodTextureLow._texture&&(s._lodTextureLow._texture.isReady=!0))}function e1(s,e){e=Jh(e);let t=e.irradiance;if(!t)return;let i=new Ur;E.FromArrayToRef(t.x,0,i.x),E.FromArrayToRef(t.y,0,i.y),E.FromArrayToRef(t.z,0,i.z),E.FromArrayToRef(t.xx,0,i.xx),E.FromArrayToRef(t.yy,0,i.yy),E.FromArrayToRef(t.zz,0,i.zz),E.FromArrayToRef(t.yz,0,i.yz),E.FromArrayToRef(t.zx,0,i.zx),E.FromArrayToRef(t.xy,0,i.xy),s._sphericalPolynomial=i}function t1(s,e,t,i,r){let n=s.getEngine().createRawCubeTexture(null,s.width,s.format,s.type,s.generateMipMaps,s.invertY,s.samplingMode,s._compression),a=Ib(n,e).then(()=>s);return s.onRebuildCallback=o=>({proxy:a,isReady:!0,isAsync:!0}),s._source=13,s._bufferViewArrayArray=e,s._lodGenerationScale=i,s._lodGenerationOffset=r,s._sphericalPolynomial=t,Ib(s,e).then(()=>(s.isReady=!0,s))}var Xm,qN,QN,yb=S(()=>{$e();ie();di();gl();vi();ma();Xr();Wr();Ee();Cb();fR();Zh();Xm="image/png",qN=2,QN=[134,22,135,150,246,214,150,54]});var i1={};V(i1,{_ENVTextureLoader:()=>Mb});var Mb,r1=S(()=>{yb();Mb=class{constructor(){this.supportCascades=!1}loadCubeData(e,t,i,r,n){if(Array.isArray(e))return;let a=ZN(e);if(a){t.width=a.width,t.height=a.width;try{e1(t,a),JN(t,e,a).then(()=>{t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),r&&r()},o=>{n?.("Can not upload environment levels",o)})}catch(o){n?.("Can not upload environment file",o)}}else n&&n("Can not parse the environment file",null)}loadData(){throw".env not supported in 2d."}}});var Wn,s1=S(()=>{ie();Wn=class{static ConvertPanoramaToCubemap(e,t,i,r,n=!1,a=!0){if(!e)throw"ConvertPanoramaToCubemap: input cannot be null";let o=0;if(e.length!=t*i*3){if(e.length!=t*i*4)throw"ConvertPanoramaToCubemap: input size is wrong";o=4}else o=3;let l=this.CreateCubemapTexture(r,this.FACE_FRONT,e,t,i,n,a,o),c=this.CreateCubemapTexture(r,this.FACE_BACK,e,t,i,n,a,o),f=this.CreateCubemapTexture(r,this.FACE_LEFT,e,t,i,n,a,o),h=this.CreateCubemapTexture(r,this.FACE_RIGHT,e,t,i,n,a,o),u=this.CreateCubemapTexture(r,this.FACE_UP,e,t,i,n,a,o),d=this.CreateCubemapTexture(r,this.FACE_DOWN,e,t,i,n,a,o);return{front:l,back:c,left:f,right:h,up:u,down:d,size:r,type:1,format:4,gammaSpace:!1}}static CreateCubemapTexture(e,t,i,r,n,a,o,l){let c=new ArrayBuffer(e*e*4*3),f=new Float32Array(c),h=a?Math.max(1,Math.round(r/4/e)):1,u=1/h,d=u*u,p=t[1].subtract(t[0]).scale(u/e),m=t[3].subtract(t[2]).scale(u/e),_=1/e,v=0;for(let T=0;T<e;T++)for(let C=0;C<h;C++){let I=t[0],R=t[2];for(let b=0;b<e;b++)for(let M=0;M<h;M++){let F=R.subtract(I).scale(v).add(I);F.normalize();let U=this.CalcProjectionSpherical(F,i,r,n,l,o);f[T*e*3+b*3+0]+=U.r*d,f[T*e*3+b*3+1]+=U.g*d,f[T*e*3+b*3+2]+=U.b*d,I=I.add(p),R=R.add(m)}v+=_*u}return f}static CalcProjectionSpherical(e,t,i,r,n,a){let o=Math.atan2(e.z,e.x),l=Math.acos(e.y);for(;o<-Math.PI;)o+=2*Math.PI;for(;o>Math.PI;)o-=2*Math.PI;let c=o/Math.PI,f=l/Math.PI;c=c*.5+.5;let h=Math.round(c*i);h<0?h=0:h>=i&&(h=i-1);let u=Math.round(f*r);u<0?u=0:u>=r&&(u=r-1);let d=a?r-u-1:u,p=t[d*i*n+h*n+0],m=t[d*i*n+h*n+1],_=t[d*i*n+h*n+2];return{r:p,g:m,b:_}}};Wn.FACE_LEFT=[new E(-1,-1,-1),new E(1,-1,-1),new E(-1,1,-1),new E(1,1,-1)];Wn.FACE_RIGHT=[new E(1,-1,1),new E(-1,-1,1),new E(1,1,1),new E(-1,1,1)];Wn.FACE_FRONT=[new E(1,-1,-1),new E(1,-1,1),new E(1,1,-1),new E(1,1,1)];Wn.FACE_BACK=[new E(-1,-1,1),new E(-1,-1,-1),new E(-1,1,1),new E(-1,1,-1)];Wn.FACE_DOWN=[new E(1,1,-1),new E(1,1,1),new E(-1,1,-1),new E(-1,1,1)];Wn.FACE_UP=[new E(-1,-1,-1),new E(-1,-1,1),new E(1,-1,-1),new E(1,-1,1)]});function Ej(s,e){return e>1023?s*Math.pow(2,1023)*Math.pow(2,e-1023):e<-1074?s*Math.pow(2,-1074)*Math.pow(2,e+1074):s*Math.pow(2,e)}function n1(s,e,t,i,r,n){r>0?(r=Ej(1,r-136),s[n+0]=e*r,s[n+1]=t*r,s[n+2]=i*r):(s[n+0]=0,s[n+1]=0,s[n+2]=0)}function Pb(s,e){let t="",i="";for(let r=e;r<s.length-e&&(i=String.fromCharCode(s[r]),i!=`
`);r++)t+=i;return t}function Db(s){let e=0,t=0,i=Pb(s,0);if(i[0]!="#"||i[1]!="?")throw"Bad HDR Format.";let r=!1,n=!1,a=0;do a+=i.length+1,i=Pb(s,a),i=="FORMAT=32-bit_rle_rgbe"?n=!0:i.length==0&&(r=!0);while(!r);if(!n)throw"HDR Bad header format, unsupported FORMAT";a+=i.length+1,i=Pb(s,a);let l=/^-Y (.*) \+X (.*)$/g.exec(i);if(!l||l.length<3)throw"HDR Bad header format, no size";if(t=parseInt(l[2]),e=parseInt(l[1]),t<8||t>32767)throw"HDR Bad header format, unsupported size";return a+=i.length+1,{height:e,width:t,dataPosition:a}}function a1(s,e,t=!1){let i=new Uint8Array(s),r=Db(i),n=Ob(i,r);return Wn.ConvertPanoramaToCubemap(n,r.width,r.height,e,t)}function Ob(s,e){return Tj(s,e)}function Tj(s,e){let t=e.height,i=e.width,r,n,a,o,l,c=e.dataPosition,f=0,h=0,u=0,d=new ArrayBuffer(i*4),p=new Uint8Array(d),m=new ArrayBuffer(e.width*e.height*4*3),_=new Float32Array(m);for(;t>0;){if(r=s[c++],n=s[c++],a=s[c++],o=s[c++],r!=2||n!=2||a&128||e.width<8||e.width>32767)return xj(s,e);if((a<<8|o)!=i)throw"HDR Bad header format, wrong scan line width";for(f=0,u=0;u<4;u++)for(h=(u+1)*i;f<h;)if(r=s[c++],n=s[c++],r>128){if(l=r-128,l==0||l>h-f)throw"HDR Bad Format, bad scanline data (run)";for(;l-- >0;)p[f++]=n}else{if(l=r,l==0||l>h-f)throw"HDR Bad Format, bad scanline data (non-run)";if(p[f++]=n,--l>0)for(let v=0;v<l;v++)p[f++]=s[c++]}for(u=0;u<i;u++)r=p[u],n=p[u+i],a=p[u+2*i],o=p[u+3*i],n1(_,r,n,a,o,(e.height-t)*i*3+u*3);t--}return _}function xj(s,e){let t=e.height,i=e.width,r,n,a,o,l,c=e.dataPosition,f=new ArrayBuffer(e.width*e.height*4*3),h=new Float32Array(f);for(;t>0;){for(l=0;l<e.width;l++)r=s[c++],n=s[c++],a=s[c++],o=s[c++],n1(h,r,n,a,o,(e.height-t)*i*3+l*3);t--}return h}var Lb=S(()=>{s1()});var o1={};V(o1,{_HDRTextureLoader:()=>wb});var wb,l1=S(()=>{Lb();wb=class{constructor(){this.supportCascades=!1}loadCubeData(){throw".hdr not supported in Cube."}loadData(e,t,i){let r=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),n=Db(r),a=Ob(r,n),o=n.width*n.height,l=new Float32Array(o*4);for(let c=0;c<o;c+=1)l[c*4]=a[c*3],l[c*4+1]=a[c*3+1],l[c*4+2]=a[c*3+2],l[c*4+3]=1;i(n.width,n.height,t.generateMipMaps,!1,()=>{let c=t.getEngine();t.type=1,t.format=5,t._gammaSpace=!1,c._uploadDataToTextureDirectly(t,l)})}}});var an,c1=S(()=>{Ee();an=class s{constructor(e,t){if(this.data=e,this.isInvalid=!1,!s.IsValid(e)){this.isInvalid=!0,P.Error("texture missing KTX identifier");return}let i=Uint32Array.BYTES_PER_ELEMENT,r=new DataView(this.data.buffer,this.data.byteOffset+12,13*i),a=r.getUint32(0,!0)===67305985;if(this.glType=r.getUint32(1*i,a),this.glTypeSize=r.getUint32(2*i,a),this.glFormat=r.getUint32(3*i,a),this.glInternalFormat=r.getUint32(4*i,a),this.glBaseInternalFormat=r.getUint32(5*i,a),this.pixelWidth=r.getUint32(6*i,a),this.pixelHeight=r.getUint32(7*i,a),this.pixelDepth=r.getUint32(8*i,a),this.numberOfArrayElements=r.getUint32(9*i,a),this.numberOfFaces=r.getUint32(10*i,a),this.numberOfMipmapLevels=r.getUint32(11*i,a),this.bytesOfKeyValueData=r.getUint32(12*i,a),this.glType!==0){P.Error("only compressed formats currently supported"),this.isInvalid=!0;return}else this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels);if(this.pixelHeight===0||this.pixelDepth!==0){P.Error("only 2D textures currently supported"),this.isInvalid=!0;return}if(this.numberOfArrayElements!==0){P.Error("texture arrays not currently supported"),this.isInvalid=!0;return}if(this.numberOfFaces!==t){P.Error("number of faces expected"+t+", but found "+this.numberOfFaces),this.isInvalid=!0;return}this.loadType=s.COMPRESSED_2D}uploadLevels(e,t){switch(this.loadType){case s.COMPRESSED_2D:this._upload2DCompressedLevels(e,t);break;case s.TEX_2D:case s.COMPRESSED_3D:case s.TEX_3D:}}_upload2DCompressedLevels(e,t){let i=s.HEADER_LEN+this.bytesOfKeyValueData,r=this.pixelWidth,n=this.pixelHeight,a=t?this.numberOfMipmapLevels:1;for(let o=0;o<a;o++){let l=new Int32Array(this.data.buffer,this.data.byteOffset+i,1)[0];i+=4;for(let c=0;c<this.numberOfFaces;c++){let f=new Uint8Array(this.data.buffer,this.data.byteOffset+i,l);e.getEngine()._uploadCompressedDataToTextureDirectly(e,e.format,r,n,f,c,o),i+=l,i+=3-(l+3)%4}r=Math.max(1,r*.5),n=Math.max(1,n*.5)}}static IsValid(e){if(e.byteLength>=12){let t=new Uint8Array(e.buffer,e.byteOffset,12);if(t[0]===171&&t[1]===75&&t[2]===84&&t[3]===88&&t[4]===32&&t[5]===49&&t[6]===49&&t[7]===187&&t[8]===13&&t[9]===10&&t[10]===26&&t[11]===10)return!0}return!1}};an.HEADER_LEN=64;an.COMPRESSED_2D=0;an.COMPRESSED_3D=1;an.TEX_2D=2;an.TEX_3D=3});var Fb,Ol,Nb=S(()=>{Fb=class{constructor(e){this._pendingActions=new Array,this._workerInfos=e.map(t=>({workerPromise:Promise.resolve(t),idle:!0}))}dispose(){for(let e of this._workerInfos)e.workerPromise.then(t=>{t.terminate()});this._workerInfos.length=0,this._pendingActions.length=0}push(e){this._executeOnIdleWorker(e)||this._pendingActions.push(e)}_executeOnIdleWorker(e){for(let t of this._workerInfos)if(t.idle)return this._execute(t,e),!0;return!1}_execute(e,t){e.idle=!1,e.workerPromise.then(i=>{t(i,()=>{let r=this._pendingActions.shift();r?this._execute(e,r):e.idle=!0})})}},Ol=class s extends Fb{constructor(e,t,i=s.DefaultOptions){super([]),this._maxWorkers=e,this._createWorkerAsync=t,this._options=i}push(e){if(!this._executeOnIdleWorker(e))if(this._workerInfos.length<this._maxWorkers){let t={workerPromise:this._createWorkerAsync(),idle:!1};this._workerInfos.push(t),this._execute(t,e)}else this._pendingActions.push(e)}_execute(e,t){e.timeoutId&&(clearTimeout(e.timeoutId),delete e.timeoutId),super._execute(e,(i,r)=>{t(i,()=>{r(),e.idle&&(e.timeoutId=setTimeout(()=>{e.workerPromise.then(a=>{a.terminate()});let n=this._workerInfos.indexOf(e);n!==-1&&this._workerInfos.splice(n,1)},this._options.idleTimeElapsedBeforeRelease))})})}};Ol.DefaultOptions={idleTimeElapsedBeforeRelease:1e3}});var f1,hf,h1,u1=S(()=>{(function(s){s[s.ETC1S=0]="ETC1S",s[s.UASTC4x4=1]="UASTC4x4"})(f1||(f1={}));(function(s){s[s.ASTC_4X4_RGBA=0]="ASTC_4X4_RGBA",s[s.ASTC_4x4_RGBA=0]="ASTC_4x4_RGBA",s[s.BC7_RGBA=1]="BC7_RGBA",s[s.BC3_RGBA=2]="BC3_RGBA",s[s.BC1_RGB=3]="BC1_RGB",s[s.PVRTC1_4_RGBA=4]="PVRTC1_4_RGBA",s[s.PVRTC1_4_RGB=5]="PVRTC1_4_RGB",s[s.ETC2_RGBA=6]="ETC2_RGBA",s[s.ETC1_RGB=7]="ETC1_RGB",s[s.RGBA32=8]="RGBA32",s[s.R8=9]="R8",s[s.RG8=10]="RG8"})(hf||(hf={}));(function(s){s[s.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",s[s.COMPRESSED_RGBA_ASTC_4X4_KHR=37808]="COMPRESSED_RGBA_ASTC_4X4_KHR",s[s.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",s[s.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",s[s.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",s[s.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",s[s.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",s[s.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",s[s.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",s[s.RGBA8Format=32856]="RGBA8Format",s[s.R8Format=33321]="R8Format",s[s.RG8Format=33323]="RG8Format"})(h1||(h1={}))});function $h(s,e){let t=e?.jsDecoderModule||KTX2DECODER;s&&(s.wasmBaseUrl&&(t.Transcoder.WasmBaseUrl=s.wasmBaseUrl),s.wasmUASTCToASTC&&(t.LiteTranscoder_UASTC_ASTC.WasmModuleURL=s.wasmUASTCToASTC),s.wasmUASTCToBC7&&(t.LiteTranscoder_UASTC_BC7.WasmModuleURL=s.wasmUASTCToBC7),s.wasmUASTCToRGBA_UNORM&&(t.LiteTranscoder_UASTC_RGBA_UNORM.WasmModuleURL=s.wasmUASTCToRGBA_UNORM),s.wasmUASTCToRGBA_SRGB&&(t.LiteTranscoder_UASTC_RGBA_SRGB.WasmModuleURL=s.wasmUASTCToRGBA_SRGB),s.wasmUASTCToR8_UNORM&&(t.LiteTranscoder_UASTC_R8_UNORM.WasmModuleURL=s.wasmUASTCToR8_UNORM),s.wasmUASTCToRG8_UNORM&&(t.LiteTranscoder_UASTC_RG8_UNORM.WasmModuleURL=s.wasmUASTCToRG8_UNORM),s.jsMSCTranscoder&&(t.MSCTranscoder.JSModuleURL=s.jsMSCTranscoder),s.wasmMSCTranscoder&&(t.MSCTranscoder.WasmModuleURL=s.wasmMSCTranscoder),s.wasmZSTDDecoder&&(t.ZSTDDecoder.WasmModuleURL=s.wasmZSTDDecoder)),e&&(e.wasmUASTCToASTC&&(t.LiteTranscoder_UASTC_ASTC.WasmBinary=e.wasmUASTCToASTC),e.wasmUASTCToBC7&&(t.LiteTranscoder_UASTC_BC7.WasmBinary=e.wasmUASTCToBC7),e.wasmUASTCToRGBA_UNORM&&(t.LiteTranscoder_UASTC_RGBA_UNORM.WasmBinary=e.wasmUASTCToRGBA_UNORM),e.wasmUASTCToRGBA_SRGB&&(t.LiteTranscoder_UASTC_RGBA_SRGB.WasmBinary=e.wasmUASTCToRGBA_SRGB),e.wasmUASTCToR8_UNORM&&(t.LiteTranscoder_UASTC_R8_UNORM.WasmBinary=e.wasmUASTCToR8_UNORM),e.wasmUASTCToRG8_UNORM&&(t.LiteTranscoder_UASTC_RG8_UNORM.WasmBinary=e.wasmUASTCToRG8_UNORM),e.jsMSCTranscoder&&(t.MSCTranscoder.JSModule=e.jsMSCTranscoder),e.wasmMSCTranscoder&&(t.MSCTranscoder.WasmBinary=e.wasmMSCTranscoder),e.wasmZSTDDecoder&&(t.ZSTDDecoder.WasmBinary=e.wasmZSTDDecoder))}function d1(s){typeof s>"u"&&typeof KTX2DECODER<"u"&&(s=KTX2DECODER);let e;onmessage=t=>{if(t.data)switch(t.data.action){case"init":{let i=t.data.urls;i&&(i.jsDecoderModule&&typeof s>"u"&&(importScripts(i.jsDecoderModule),s=KTX2DECODER),$h(i)),t.data.wasmBinaries&&$h(void 0,{...t.data.wasmBinaries,jsDecoderModule:s}),e=new s.KTX2Decoder,postMessage({action:"init"});break}case"setDefaultDecoderOptions":{s.KTX2Decoder.DefaultDecoderOptions=t.data.options;break}case"decode":e.decode(t.data.data,t.data.caps,t.data.options).then(i=>{let r=[];for(let n=0;n<i.mipmaps.length;++n){let a=i.mipmaps[n];a&&a.data&&r.push(a.data.buffer)}postMessage({action:"decoded",success:!0,decodedData:i},r)}).catch(i=>{postMessage({action:"decoded",success:!1,msg:i})});break}}}async function p1(s,e,t){return await new Promise((i,r)=>{let n=o=>{s.removeEventListener("error",n),s.removeEventListener("message",a),r(o)},a=o=>{o.data.action==="init"&&(s.removeEventListener("error",n),s.removeEventListener("message",a),i(s))};s.addEventListener("error",n),s.addEventListener("message",a),s.postMessage({action:"init",urls:t,wasmBinaries:e})})}var m1=S(()=>{});var Bb,Wa,_1=S(()=>{Nb();$e();u1();m1();Bb=class{constructor(){this._isDirty=!0,this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=!0,this._ktx2DecoderOptions={}}get isDirty(){return this._isDirty}get useRGBAIfASTCBC7NotAvailableWhenUASTC(){return this._useRGBAIfASTCBC7NotAvailableWhenUASTC}set useRGBAIfASTCBC7NotAvailableWhenUASTC(e){this._useRGBAIfASTCBC7NotAvailableWhenUASTC!==e&&(this._useRGBAIfASTCBC7NotAvailableWhenUASTC=e,this._isDirty=!0)}get useRGBAIfOnlyBC1BC3AvailableWhenUASTC(){return this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC}set useRGBAIfOnlyBC1BC3AvailableWhenUASTC(e){this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC!==e&&(this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=e,this._isDirty=!0)}get forceRGBA(){return this._forceRGBA}set forceRGBA(e){this._forceRGBA!==e&&(this._forceRGBA=e,this._isDirty=!0)}get forceR8(){return this._forceR8}set forceR8(e){this._forceR8!==e&&(this._forceR8=e,this._isDirty=!0)}get forceRG8(){return this._forceRG8}set forceRG8(e){this._forceRG8!==e&&(this._forceRG8=e,this._isDirty=!0)}get bypassTranscoders(){return this._bypassTranscoders}set bypassTranscoders(e){this._bypassTranscoders!==e&&(this._bypassTranscoders=e,this._isDirty=!0)}_getKTX2DecoderOptions(){if(!this._isDirty)return this._ktx2DecoderOptions;this._isDirty=!1;let e={};return this._useRGBAIfASTCBC7NotAvailableWhenUASTC!==void 0&&(e.useRGBAIfASTCBC7NotAvailableWhenUASTC=this._useRGBAIfASTCBC7NotAvailableWhenUASTC),this._forceRGBA!==void 0&&(e.forceRGBA=this._forceRGBA),this._forceR8!==void 0&&(e.forceR8=this._forceR8),this._forceRG8!==void 0&&(e.forceRG8=this._forceRG8),this._bypassTranscoders!==void 0&&(e.bypassTranscoders=this._bypassTranscoders),this.useRGBAIfOnlyBC1BC3AvailableWhenUASTC&&(e.transcodeFormatDecisionTree={UASTC:{transcodeFormat:[hf.BC1_RGB,hf.BC3_RGBA],yes:{transcodeFormat:hf.RGBA32,engineFormat:32856,roundToMultiple4:!1}}}),this._ktx2DecoderOptions=e,e}},Wa=class s{static GetDefaultNumWorkers(){return typeof navigator!="object"||!navigator.hardwareConcurrency?1:Math.min(Math.floor(navigator.hardwareConcurrency*.5),4)}static _Initialize(e){if(s._WorkerPoolPromise||s._DecoderModulePromise)return;let t={wasmBaseUrl:W.ScriptBaseUrl,jsDecoderModule:W.GetBabylonScriptURL(this.URLConfig.jsDecoderModule,!0),wasmUASTCToASTC:W.GetBabylonScriptURL(this.URLConfig.wasmUASTCToASTC,!0),wasmUASTCToBC7:W.GetBabylonScriptURL(this.URLConfig.wasmUASTCToBC7,!0),wasmUASTCToRGBA_UNORM:W.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_UNORM,!0),wasmUASTCToRGBA_SRGB:W.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_SRGB,!0),wasmUASTCToR8_UNORM:W.GetBabylonScriptURL(this.URLConfig.wasmUASTCToR8_UNORM,!0),wasmUASTCToRG8_UNORM:W.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRG8_UNORM,!0),jsMSCTranscoder:W.GetBabylonScriptURL(this.URLConfig.jsMSCTranscoder,!0),wasmMSCTranscoder:W.GetBabylonScriptURL(this.URLConfig.wasmMSCTranscoder,!0),wasmZSTDDecoder:W.GetBabylonScriptURL(this.URLConfig.wasmZSTDDecoder,!0)};e&&typeof Worker=="function"&&typeof URL<"u"?s._WorkerPoolPromise=new Promise(i=>{let r=`${$h}(${d1})()`,n=URL.createObjectURL(new Blob([r],{type:"application/javascript"}));i(new Ol(e,async()=>await p1(new Worker(n),void 0,t)))}):typeof s._KTX2DecoderModule>"u"?s._DecoderModulePromise=W.LoadBabylonScriptAsync(t.jsDecoderModule).then(()=>(s._KTX2DecoderModule=KTX2DECODER,s._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,s._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,$h(t,s._KTX2DecoderModule),new s._KTX2DecoderModule.KTX2Decoder)):(s._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,s._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,s._DecoderModulePromise=Promise.resolve(new s._KTX2DecoderModule.KTX2Decoder))}constructor(e,t=s.DefaultNumWorkers){this._engine=e;let i=typeof t=="object"&&t.workerPool||s.WorkerPool;if(i)s._WorkerPoolPromise=Promise.resolve(i);else{typeof t=="object"?s._KTX2DecoderModule=t?.binariesAndModulesContainer?.jsDecoderModule:typeof KTX2DECODER<"u"&&(s._KTX2DecoderModule=KTX2DECODER);let r=typeof t=="number"?t:t.numWorkers??s.DefaultNumWorkers;s._Initialize(r)}}async _uploadAsync(e,t,i){let r=this._engine.getCaps(),n={astc:!!r.astc,bptc:!!r.bptc,s3tc:!!r.s3tc,pvrtc:!!r.pvrtc,etc2:!!r.etc2,etc1:!!r.etc1};if(s._WorkerPoolPromise){let a=await s._WorkerPoolPromise;return await new Promise((o,l)=>{a.push((c,f)=>{let h=p=>{c.removeEventListener("error",h),c.removeEventListener("message",u),l(p),f()},u=p=>{if(p.data.action==="decoded"){if(c.removeEventListener("error",h),c.removeEventListener("message",u),!p.data.success)l({message:p.data.msg});else try{this._createTexture(p.data.decodedData,t,i),o()}catch(m){l({message:m})}f()}};c.addEventListener("error",h),c.addEventListener("message",u),c.postMessage({action:"setDefaultDecoderOptions",options:s.DefaultDecoderOptions._getKTX2DecoderOptions()});let d=new Uint8Array(e.byteLength);d.set(new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),c.postMessage({action:"decode",data:d,caps:n,options:i},[d.buffer])})})}else if(s._DecoderModulePromise){let a=await s._DecoderModulePromise;return s.DefaultDecoderOptions.isDirty&&(s._KTX2DecoderModule.KTX2Decoder.DefaultDecoderOptions=s.DefaultDecoderOptions._getKTX2DecoderOptions()),await new Promise((o,l)=>{a.decode(e,r).then(c=>{this._createTexture(c,t),o()}).catch(c=>{l({message:c})})})}throw new Error("KTX2 decoder module is not available")}_createTexture(e,t,i){this._engine._bindTextureDirectly(3553,t),i&&(i.transcodedFormat=e.transcodedFormat,i.isInGammaSpace=e.isInGammaSpace,i.hasAlpha=e.hasAlpha,i.transcoderName=e.transcoderName);let n=!0;switch(e.transcodedFormat){case 32856:t.type=0,t.format=5;break;case 33321:t.type=0,t.format=6;break;case 33323:t.type=0,t.format=7;break;default:t.format=e.transcodedFormat,n=!1;break}if(t._gammaSpace=e.isInGammaSpace,t.generateMipMaps=e.mipmaps.length>1,t.width=e.mipmaps[0].width,t.height=e.mipmaps[0].height,e.errors)throw new Error("KTX2 container - could not transcode the data. "+e.errors);for(let a=0;a<e.mipmaps.length;++a){let o=e.mipmaps[a];if(!o||!o.data)throw new Error("KTX2 container - could not transcode one of the image");n?(t.width=o.width,t.height=o.height,this._engine._uploadDataToTextureDirectly(t,o.data,0,a,void 0,!0)):this._engine._uploadCompressedDataToTextureDirectly(t,e.transcodedFormat,o.width,o.height,o.data,0,a)}t._extension=".ktx2",t.isReady=!0,this._engine._bindTextureDirectly(3553,null)}static IsValid(e){if(e.byteLength>=12){let t=new Uint8Array(e.buffer,e.byteOffset,12);if(t[0]===171&&t[1]===75&&t[2]===84&&t[3]===88&&t[4]===32&&t[5]===50&&t[6]===48&&t[7]===187&&t[8]===13&&t[9]===10&&t[10]===26&&t[11]===10)return!0}return!1}};Wa.URLConfig={jsDecoderModule:"https://cdn.babylonjs.com/babylon.ktx2Decoder.js",wasmUASTCToASTC:null,wasmUASTCToBC7:null,wasmUASTCToRGBA_UNORM:null,wasmUASTCToRGBA_SRGB:null,wasmUASTCToR8_UNORM:null,wasmUASTCToRG8_UNORM:null,jsMSCTranscoder:null,wasmMSCTranscoder:null,wasmZSTDDecoder:null};Wa.DefaultNumWorkers=Wa.GetDefaultNumWorkers();Wa.DefaultDecoderOptions=new Bb});var Gb={};V(Gb,{_KTXTextureLoader:()=>Ub});function Aj(s){switch(s){case 35916:return 33776;case 35918:return 33778;case 35919:return 33779;case 37493:return 37492;case 37497:return 37496;case 37495:return 37494;case 37840:return 37808;case 36493:return 36492}return null}var Ub,Vb=S(()=>{c1();_1();Ee();Ub=class{constructor(){this.supportCascades=!1}loadCubeData(e,t,i,r){if(Array.isArray(e))return;t._invertVScale=!t.invertY;let n=t.getEngine(),a=new an(e,6),o=a.numberOfMipmapLevels>1&&t.generateMipMaps;n._unpackFlipY(!0),a.uploadLevels(t,t.generateMipMaps),t.width=a.pixelWidth,t.height=a.pixelHeight,n._setCubeMapTextureParams(t,o,a.numberOfMipmapLevels-1),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),r&&r()}loadData(e,t,i,r){if(an.IsValid(e)){t._invertVScale=!t.invertY;let n=new an(e,1),a=Aj(n.glInternalFormat);a?(t.format=a,t._useSRGBBuffer=t.getEngine()._getUseSRGBBuffer(!0,t.generateMipMaps),t._gammaSpace=!0):t.format=n.glInternalFormat,i(n.pixelWidth,n.pixelHeight,t.generateMipMaps,!0,()=>{n.uploadLevels(t,t.generateMipMaps)},n.isInvalid)}else Wa.IsValid(e)?new Wa(t.getEngine())._uploadAsync(e,t,r).then(()=>{i(t.width,t.height,t.generateMipMaps,!0,()=>{},!1)},a=>{P.Warn(`Failed to load KTX2 texture data: ${a.message}`),i(0,0,!1,!1,()=>{},!0)}):(P.Error("texture missing KTX identifier"),i(0,0,!1,!1,()=>{},!0))}}});function Ym(s){let e=0;return{id_length:s[e++],colormap_type:s[e++],image_type:s[e++],colormap_index:s[e++]|s[e++]<<8,colormap_length:s[e++]|s[e++]<<8,colormap_size:s[e++],origin:[s[e++]|s[e++]<<8,s[e++]|s[e++]<<8],width:s[e++]|s[e++]<<8,height:s[e++]|s[e++]<<8,pixel_size:s[e++],flags:s[e++]}}function kb(s,e){if(e.length<19){P.Error("Unable to load TGA file - Not enough data to contain header");return}let t=18,i=Ym(e);if(i.id_length+t>e.length){P.Error("Unable to load TGA file - Not enough data");return}t+=i.id_length;let r=!1,n=!1,a=!1;switch(i.image_type){case Ij:r=!0;case Rj:n=!0;break;case yj:r=!0;case bj:break;case Mj:r=!0;case Cj:a=!0;break}let o,l=i.pixel_size>>3,c=i.width*i.height*l,f;if(n&&(f=e.subarray(t,t+=i.colormap_length*(i.colormap_size>>3))),r){o=new Uint8Array(c);let I,R,b,M=0,F=new Uint8Array(l);for(;t<c&&M<c;)if(I=e[t++],R=(I&127)+1,I&128){for(b=0;b<l;++b)F[b]=e[t++];for(b=0;b<R;++b)o.set(F,M+b*l);M+=l*R}else{for(R*=l,b=0;b<R;++b)o[M+b]=e[t++];M+=R}}else o=e.subarray(t,t+=n?i.width*i.height:c);let h,u,d,p,m,_;switch((i.flags&Pj)>>Dj){default:case wj:h=0,d=1,_=i.width,u=0,p=1,m=i.height;break;case Oj:h=0,d=1,_=i.width,u=i.height-1,p=-1,m=-1;break;case Fj:h=i.width-1,d=-1,_=-1,u=0,p=1,m=i.height;break;case Lj:h=i.width-1,d=-1,_=-1,u=i.height-1,p=-1,m=-1;break}let v="_getImageData"+(a?"Grey":"")+i.pixel_size+"bits",T=Wj[v](i,f,o,u,p,m,h,d,_);s.getEngine()._uploadDataToTextureDirectly(s,T)}function Nj(s,e,t,i,r,n,a,o,l){let c=t,f=e,h=s.width,u=s.height,d,p=0,m,_,v=new Uint8Array(h*u*4);for(_=i;_!==n;_+=r)for(m=a;m!==l;m+=o,p++)d=c[p],v[(m+h*_)*4+3]=255,v[(m+h*_)*4+2]=f[d*3+0],v[(m+h*_)*4+1]=f[d*3+1],v[(m+h*_)*4+0]=f[d*3+2];return v}function Bj(s,e,t,i,r,n,a,o,l){let c=t,f=s.width,h=s.height,u,d=0,p,m,_=new Uint8Array(f*h*4);for(m=i;m!==n;m+=r)for(p=a;p!==l;p+=o,d+=2){u=c[d+0]+(c[d+1]<<8);let v=((u&31744)>>10)*255/31|0,T=((u&992)>>5)*255/31|0,C=(u&31)*255/31|0;_[(p+f*m)*4+0]=v,_[(p+f*m)*4+1]=T,_[(p+f*m)*4+2]=C,_[(p+f*m)*4+3]=u&32768?0:255}return _}function Uj(s,e,t,i,r,n,a,o,l){let c=t,f=s.width,h=s.height,u=0,d,p,m=new Uint8Array(f*h*4);for(p=i;p!==n;p+=r)for(d=a;d!==l;d+=o,u+=3)m[(d+f*p)*4+3]=255,m[(d+f*p)*4+2]=c[u+0],m[(d+f*p)*4+1]=c[u+1],m[(d+f*p)*4+0]=c[u+2];return m}function Gj(s,e,t,i,r,n,a,o,l){let c=t,f=s.width,h=s.height,u=0,d,p,m=new Uint8Array(f*h*4);for(p=i;p!==n;p+=r)for(d=a;d!==l;d+=o,u+=4)m[(d+f*p)*4+2]=c[u+0],m[(d+f*p)*4+1]=c[u+1],m[(d+f*p)*4+0]=c[u+2],m[(d+f*p)*4+3]=c[u+3];return m}function Vj(s,e,t,i,r,n,a,o,l){let c=t,f=s.width,h=s.height,u,d=0,p,m,_=new Uint8Array(f*h*4);for(m=i;m!==n;m+=r)for(p=a;p!==l;p+=o,d++)u=c[d],_[(p+f*m)*4+0]=u,_[(p+f*m)*4+1]=u,_[(p+f*m)*4+2]=u,_[(p+f*m)*4+3]=255;return _}function kj(s,e,t,i,r,n,a,o,l){let c=t,f=s.width,h=s.height,u=0,d,p,m=new Uint8Array(f*h*4);for(p=i;p!==n;p+=r)for(d=a;d!==l;d+=o,u+=2)m[(d+f*p)*4+0]=c[u+0],m[(d+f*p)*4+1]=c[u+0],m[(d+f*p)*4+2]=c[u+0],m[(d+f*p)*4+3]=c[u+1];return m}var Rj,bj,Cj,Ij,yj,Mj,Pj,Dj,Oj,Lj,wj,Fj,Wj,g1=S(()=>{Ee();Rj=1,bj=2,Cj=3,Ij=9,yj=10,Mj=11,Pj=48,Dj=4,Oj=0,Lj=1,wj=2,Fj=3;Wj={GetTGAHeader:Ym,UploadContent:kb,_getImageData8bits:Nj,_getImageData16bits:Bj,_getImageData24bits:Uj,_getImageData32bits:Gj,_getImageDataGrey8bits:Vj,_getImageDataGrey16bits:kj}});var v1={};V(v1,{_TGATextureLoader:()=>Wb});var Wb,S1=S(()=>{g1();Wb=class{constructor(){this.supportCascades=!1}loadCubeData(){throw".env not supported in Cube."}loadData(e,t,i){let r=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),n=Ym(r);i(n.width,n.height,t.generateMipMaps,!1,()=>{kb(t,r)})}}});var eu=S(()=>{});function zj(){let s=new ArrayBuffer(4),e=new Float32Array(s),t=new Uint32Array(s),i=new Uint32Array(512),r=new Uint32Array(512);for(let l=0;l<256;++l){let c=l-127;c<-27?(i[l]=0,i[l|256]=32768,r[l]=24,r[l|256]=24):c<-14?(i[l]=1024>>-c-14,i[l|256]=1024>>-c-14|32768,r[l]=-c-1,r[l|256]=-c-1):c<=15?(i[l]=c+15<<10,i[l|256]=c+15<<10|32768,r[l]=13,r[l|256]=13):c<128?(i[l]=31744,i[l|256]=64512,r[l]=24,r[l|256]=24):(i[l]=31744,i[l|256]=64512,r[l]=13,r[l|256]=13)}let n=new Uint32Array(2048),a=new Uint32Array(64),o=new Uint32Array(64);for(let l=1;l<1024;++l){let c=l<<13,f=0;for(;(c&8388608)===0;)c<<=1,f-=8388608;c&=-8388609,f+=947912704,n[l]=c|f}for(let l=1024;l<2048;++l)n[l]=939524096+(l-1024<<13);for(let l=1;l<31;++l)a[l]=l<<23;a[31]=1199570944,a[32]=2147483648;for(let l=33;l<63;++l)a[l]=2147483648+(l-32<<23);a[63]=3347054592;for(let l=1;l<64;++l)l!==32&&(o[l]=1024);return{floatView:e,uint32View:t,baseTable:i,shiftTable:r,mantissaTable:n,exponentTable:a,offsetTable:o}}function Qm(s,e){let t=new Uint8Array(s),i=0;for(;t[e.value+i]!=0;)i+=1;let r=new TextDecoder().decode(t.slice(e.value,e.value+i));return e.value=e.value+i+1,r}function on(s,e){let t=s.getInt32(e.value,!0);return e.value+=4,t}function ls(s,e){let t=s.getUint32(e.value,!0);return e.value+=4,t}function tu(s,e){let t=s.getUint8(e.value);return e.value+=1,t}function uf(s,e){let t=s.getUint16(e.value,!0);return e.value+=2,t}function zb(s,e){let t=s[e.value];return e.value+=1,t}function x1(s,e){let t;return"getBigInt64"in DataView.prototype?t=Number(s.getBigInt64(e.value,!0)):t=s.getUint32(e.value+4,!0)+Number(s.getUint32(e.value,!0)<<32),e.value+=8,t}function Ji(s,e){let t=s.getFloat32(e.value,!0);return e.value+=4,t}function A1(s,e){return Xj(uf(s,e))}function Xj(s){let e=(s&31744)>>10,t=s&1023;return(s>>15?-1:1)*(e?e===31?t?NaN:1/0:Math.pow(2,e-15)*(1+t/1024):6103515625e-14*(t/1024))}function Yj(s){if(Math.abs(s)>65504)throw new Error("Value out of range.Consider using float instead of half-float.");s=Fe(s,-65504,65504),Km.floatView[0]=s;let e=Km.uint32View[0],t=e>>23&511;return Km.baseTable[t]+((e&8388607)>>Km.shiftTable[t])}function R1(s,e){return Yj(Ji(s,e))}function Kj(s,e,t){let i=new TextDecoder().decode(new Uint8Array(s).slice(e.value,e.value+t));return e.value=e.value+t,i}function qj(s,e){let t=on(s,e),i=ls(s,e);return[t,i]}function Qj(s,e){let t=ls(s,e),i=ls(s,e);return[t,i]}function jj(s,e){let t=Ji(s,e),i=Ji(s,e);return[t,i]}function Zj(s,e){let t=Ji(s,e),i=Ji(s,e),r=Ji(s,e);return[t,i,r]}function Jj(s,e,t){let i=e.value,r=[];for(;e.value<i+t-1;){let n=Qm(s.buffer,e),a=on(s,e),o=tu(s,e);e.value+=3;let l=on(s,e),c=on(s,e);r.push({name:n,pixelType:a,pLinear:o,xSampling:l,ySampling:c})}return e.value+=1,r}function $j(s,e){let t=Ji(s,e),i=Ji(s,e),r=Ji(s,e),n=Ji(s,e),a=Ji(s,e),o=Ji(s,e),l=Ji(s,e),c=Ji(s,e);return{redX:t,redY:i,greenX:r,greenY:n,blueX:a,blueY:o,whiteX:l,whiteY:c}}function eZ(s,e){return tu(s,e)}function tZ(s,e){let t=on(s,e),i=on(s,e),r=on(s,e),n=on(s,e);return{xMin:t,yMin:i,xMax:r,yMax:n}}function iZ(s,e){let t=tu(s,e);return Hb[t]}function b1(s,e,t,i){switch(t){case"string":case"stringvector":case"iccProfile":return Kj(s.buffer,e,i);case"chlist":return Jj(s,e,i);case"chromaticities":return $j(s,e);case"compression":return eZ(s,e);case"box2i":return tZ(s,e);case"lineOrder":return iZ(s,e);case"float":return Ji(s,e);case"v2f":return jj(s,e);case"v3f":return Zj(s,e);case"int":return on(s,e);case"rational":return qj(s,e);case"timecode":return Qj(s,e);case"preview":return e.value+=i,"skipped";default:e.value+=i;return}}function Xb(s){for(let e=1;e<s.length;e++){let t=s[e-1]+s[e]-128;s[e]=t}}function Yb(s,e){let t=0,i=Math.floor((s.length+1)/2),r=0,n=s.length-1;for(;!(r>n||(e[r++]=s[t++],r>n));)e[r++]=s[i++]}var Hn,Hb,Km,iu=S(()=>{di();eu();(function(s){s[s.NO_COMPRESSION=0]="NO_COMPRESSION",s[s.RLE_COMPRESSION=1]="RLE_COMPRESSION",s[s.ZIPS_COMPRESSION=2]="ZIPS_COMPRESSION",s[s.ZIP_COMPRESSION=3]="ZIP_COMPRESSION",s[s.PIZ_COMPRESSION=4]="PIZ_COMPRESSION",s[s.PXR24_COMPRESSION=5]="PXR24_COMPRESSION"})(Hn||(Hn={}));(function(s){s[s.INCREASING_Y=0]="INCREASING_Y",s[s.DECREASING_Y=1]="DECREASING_Y"})(Hb||(Hb={}));Km=zj()});function Kb(s,e){if(s.getUint32(0,!0)!=rZ)throw new Error("Incorrect OpenEXR format");let t=s.getUint8(4),i=s.getUint8(5),r={singleTile:!!(i&2),longName:!!(i&4),deepFormat:!!(i&8),multiPart:!!(i&16)};e.value=8;let n={},a=!0;for(;a;){let o=Qm(s.buffer,e);if(!o)a=!1;else{let l=Qm(s.buffer,e),c=ls(s,e),f=b1(s,e,l,c);f===void 0?P.Warn(`Unknown header attribute type ${l}'.`):n[o]=f}}if((i&-5)!=0)throw new Error("Unsupported file format");return{version:t,spec:r,...n}}var rZ,C1=S(()=>{Ee();iu();rZ=20000630});function w1(s,e){let t=0;for(let r=0;r<65536;++r)(r==0||s[r>>3]&1<<(r&7))&&(e[t++]=r);let i=t-1;for(;t<65536;)e[t++]=0;return i}function oZ(s){for(let e=0;e<16384;e++)s[e]={},s[e].len=0,s[e].lit=0,s[e].p=null}function P1(s,e,t,i,r){for(;t<s;)e=e<<8|zb(i,r),t+=8;return t-=s,{l:e>>t&(1<<s)-1,c:e,lc:t}}function Qb(s,e,t,i){return s=s<<8|zb(t,i),e+=8,{c:s,lc:e}}function qb(s,e,t,i,r,n,a,o,l){if(s==e){if(i<8){let h=Qb(t,i,r,n);t=h.c,i=h.lc}i-=8;let c=t>>i;if(c=new Uint8Array([c])[0],o.value+c>l)return null;let f=a[o.value-1];for(;c-- >0;)a[o.value++]=f}else if(o.value<l)a[o.value++]=s;else return null;return{c:t,lc:i}}function lZ(s){for(let t=0;t<=58;++t)ru[t]=0;for(let t=0;t<65537;++t)ru[s[t]]+=1;let e=0;for(let t=58;t>0;--t){let i=e+ru[t]>>1;ru[t]=e,e=i}for(let t=0;t<65537;++t){let i=s[t];i>0&&(s[t]=i|ru[i]++<<6)}}function cZ(s,e,t,i,r,n){let a=e,o=0,l=0;for(;i<=r;i++){if(a.value-e.value>t)return;let c=P1(6,o,l,s,a),f=c.l;if(o=c.c,l=c.lc,n[i]=f,f==63){if(a.value-e.value>t)throw new Error("Error in HufUnpackEncTable");c=P1(8,o,l,s,a);let h=c.l+6;if(o=c.c,l=c.lc,i+h>r+1)throw new Error("Error in HufUnpackEncTable");for(;h--;)n[i++]=0;i--}else if(f>=59){let h=f-59+2;if(i+h>r+1)throw new Error("Error in HufUnpackEncTable");for(;h--;)n[i++]=0;i--}}lZ(n)}function F1(s){return s&63}function N1(s){return s>>6}function fZ(s,e,t,i){for(;e<=t;e++){let r=N1(s[e]),n=F1(s[e]);if(r>>n)throw new Error("Invalid table entry");if(n>14){let a=i[r>>n-14];if(a.len)throw new Error("Invalid table entry");if(a.lit++,a.p){let o=a.p;a.p=new Array(a.lit);for(let l=0;l<a.lit-1;++l)a.p[l]=o[l]}else a.p=new Array(1);a.p[a.lit-1]=e}else if(n){let a=0;for(let o=1<<14-n;o>0;o--){let l=i[(r<<14-n)+a];if(l.len||l.p)throw new Error("Invalid table entry");l.len=n,l.lit=e,a++}}}return!0}function hZ(s,e,t,i,r,n,a,o,l){let c=0,f=0,h=a,u=Math.trunc(i.value+(r+7)/8);for(;i.value<u;){let p=Qb(c,f,t,i);for(c=p.c,f=p.lc;f>=14;){let m=c>>f-14&16383,_=e[m];if(_.len){f-=_.len;let v=qb(_.lit,n,c,f,t,i,o,l,h);v&&(c=v.c,f=v.lc)}else{if(!_.p)throw new Error("hufDecode issues");let v;for(v=0;v<_.lit;v++){let T=F1(s[_.p[v]]);for(;f<T&&i.value<u;)p=Qb(c,f,t,i),c=p.c,f=p.lc;if(f>=T&&N1(s[_.p[v]])==(c>>f-T&(1<<T)-1)){f-=T;let C=qb(_.p[v],n,c,f,t,i,o,l,h);C&&(c=C.c,f=C.lc);break}}if(v==_.lit)throw new Error("HufDecode issues")}}}let d=8-r&7;for(c>>=d,f-=d;f>0;){let p=e[c<<14-f&16383];if(p.len){f-=p.len;let m=qb(p.lit,n,c,f,t,i,o,l,h);m&&(c=m.c,f=m.lc)}else throw new Error("HufDecode issues")}return!0}function B1(s,e,t,i,r,n){let a={value:0},o=t.value,l=ls(e,t),c=ls(e,t);t.value+=4;let f=ls(e,t);if(t.value+=4,l<0||l>=65537||c<0||c>=65537)throw new Error("Wrong HUF_ENCSIZE");let h=new Array(65537),u=new Array(16384);oZ(u);let d=i-(t.value-o);if(cZ(s,t,d,l,c,h),f>8*(i-(t.value-o)))throw new Error("Wrong hufUncompress");fZ(h,l,c,u),hZ(h,u,s,t,f,c,n,r,a)}function jb(s){return s&65535}function D1(s){let e=jb(s);return e>32767?e-65536:e}function df(s,e){let t=D1(s),r=D1(e),n=t+(r&1)+(r>>1),a=n,o=n-r;return{a,b:o}}function pf(s,e){let t=jb(s),i=jb(e),r=t-(i>>1)&M1;return{a:i+r-aZ&M1,b:r}}function U1(s,e,t,i,r,n,a){let o=a<16384,l=t>r?r:t,c=1,f,h;for(;c<=l;)c<<=1;for(c>>=1,f=c,c>>=1;c>=1;){h=0;let u=h+n*(r-f),d=n*c,p=n*f,m=i*c,_=i*f,v,T,C,I;for(;h<=u;h+=p){let R=h,b=h+i*(t-f);for(;R<=b;R+=_){let M=R+m,F=R+d,U=F+m;if(o){let D=df(s[R+e],s[F+e]);v=D.a,C=D.b,D=df(s[M+e],s[U+e]),T=D.a,I=D.b,D=df(v,T),s[R+e]=D.a,s[M+e]=D.b,D=df(C,I),s[F+e]=D.a,s[U+e]=D.b}else{let D=pf(s[R+e],s[F+e]);v=D.a,C=D.b,D=pf(s[M+e],s[U+e]),T=D.a,I=D.b,D=pf(v,T),s[R+e]=D.a,s[M+e]=D.b,D=pf(C,I),s[F+e]=D.a,s[U+e]=D.b}}if(t&c){let M=R+d,F;o?F=df(s[R+e],s[M+e]):F=pf(s[R+e],s[M+e]),v=F.a,s[M+e]=F.b,s[R+e]=v}}if(r&c){let R=h,b=h+i*(t-f);for(;R<=b;R+=_){let M=R+m,F;o?F=df(s[R+e],s[M+e]):F=pf(s[R+e],s[M+e]),v=F.a,s[M+e]=F.b,s[R+e]=v}}f=c,c>>=1}return h}function G1(s,e,t){for(let i=0;i<t;++i)e[i]=s[e[i]]}var L1,aZ,M1,ru,V1=S(()=>{iu();eu();L1=16,aZ=1<<L1-1,M1=(1<<L1)-1;ru=new Array(59)});function k1(s){let e=s.byteLength,t=[],i=0,r=new DataView(s);for(;e>0;){let n=r.getInt8(i++);if(n<0){let a=-n;e-=a+1;for(let o=0;o<a;o++)t.push(r.getUint8(i++))}else{let a=n;e-=2;let o=r.getUint8(i++);for(let l=0;l<a+1;l++)t.push(o)}}return t}var W1=S(()=>{});function Zb(s){return new DataView(s.array.buffer,s.offset.value,s.size)}function z1(s){let e=s.viewer.buffer.slice(s.offset.value,s.offset.value+s.size),t=new Uint8Array(k1(e)),i=new Uint8Array(t.length);return Xb(t),Yb(t,i),new DataView(i.buffer)}function Jb(s){let e=s.array.slice(s.offset.value,s.offset.value+s.size),t=fflate.unzlibSync(e),i=new Uint8Array(t.length);return Xb(t),Yb(t,i),new DataView(i.buffer)}function X1(s){let e=s.array.slice(s.offset.value,s.offset.value+s.size),t=fflate.unzlibSync(e),i=s.lines*s.channels*s.width,r=s.type==1?new Uint16Array(i):new Uint32Array(i),n=0,a=0,o=new Array(4);for(let l=0;l<s.lines;l++)for(let c=0;c<s.channels;c++){let f=0;switch(s.type){case 1:o[0]=n,o[1]=o[0]+s.width,n=o[1]+s.width;for(let h=0;h<s.width;++h){let u=t[o[0]++]<<8|t[o[1]++];f+=u,r[a]=f,a++}break;case 2:o[0]=n,o[1]=o[0]+s.width,o[2]=o[1]+s.width,n=o[2]+s.width;for(let h=0;h<s.width;++h){let u=t[o[0]++]<<24|t[o[1]++]<<16|t[o[2]++]<<8;f+=u,r[a]=f,a++}break}}return new DataView(r.buffer)}function Y1(s){let e=s.viewer,t={value:s.offset.value},i=new Uint16Array(s.width*s.scanlineBlockSize*(s.channels*s.type)),r=new Uint8Array(8192),n=0,a=new Array(s.channels);for(let p=0;p<s.channels;p++)a[p]={},a[p].start=n,a[p].end=a[p].start,a[p].nx=s.width,a[p].ny=s.lines,a[p].size=s.type,n+=a[p].nx*a[p].ny*a[p].size;let o=uf(e,t),l=uf(e,t);if(l>=8192)throw new Error("Wrong PIZ_COMPRESSION BITMAP_SIZE");if(o<=l)for(let p=0;p<l-o+1;p++)r[p+o]=tu(e,t);let c=new Uint16Array(65536),f=w1(r,c),h=ls(e,t);B1(s.array,e,t,h,i,n);for(let p=0;p<s.channels;++p){let m=a[p];for(let _=0;_<a[p].size;++_)U1(i,m.start+_,m.nx,m.size,m.ny,m.nx*m.size,f)}G1(c,i,n);let u=0,d=new Uint8Array(i.buffer.byteLength);for(let p=0;p<s.lines;p++)for(let m=0;m<s.channels;m++){let _=a[m],v=_.nx*_.size,T=new Uint8Array(i.buffer,_.end*2,v*2);d.set(T,u),u+=v*2,_.end+=v}return new DataView(d.buffer)}var K1=S(()=>{V1();W1();iu();eu()});var Ls,zn,$b=S(()=>{(function(s){s[s.Float=0]="Float",s[s.HalfFloat=1]="HalfFloat"})(Ls||(Ls={}));zn=class{};zn.DefaultOutputType=Ls.HalfFloat;zn.FFLATEUrl="https://unpkg.com/fflate@0.8.2"});async function eC(s,e,t,i){let r={size:0,viewer:e,array:new Uint8Array(e.buffer),offset:t,width:s.dataWindow.xMax-s.dataWindow.xMin+1,height:s.dataWindow.yMax-s.dataWindow.yMin+1,channels:s.channels.length,channelLineOffsets:{},scanOrder:()=>0,bytesPerLine:0,outLineWidth:0,lines:0,scanlineBlockSize:0,inputSize:null,type:0,uncompress:null,getter:()=>0,format:5,outputChannels:0,decodeChannels:{},blockCount:null,byteArray:null,linearSpace:!1,textureType:0};switch(s.compression){case Hn.NO_COMPRESSION:r.lines=1,r.uncompress=Zb;break;case Hn.RLE_COMPRESSION:r.lines=1,r.uncompress=z1;break;case Hn.ZIPS_COMPRESSION:r.lines=1,r.uncompress=Jb,await W.LoadScriptAsync(zn.FFLATEUrl);break;case Hn.ZIP_COMPRESSION:r.lines=16,r.uncompress=Jb,await W.LoadScriptAsync(zn.FFLATEUrl);break;case Hn.PIZ_COMPRESSION:r.lines=32,r.uncompress=Y1;break;case Hn.PXR24_COMPRESSION:r.lines=16,r.uncompress=X1,await W.LoadScriptAsync(zn.FFLATEUrl);break;default:throw new Error(Hn[s.compression]+" is unsupported")}r.scanlineBlockSize=r.lines;let n={};for(let c of s.channels)switch(c.name){case"R":case"G":case"B":case"A":n[c.name]=!0,r.type=c.pixelType;break;case"Y":n[c.name]=!0,r.type=c.pixelType;break;default:break}let a=!1;if(n.R&&n.G&&n.B&&n.A)r.outputChannels=4,r.decodeChannels={R:0,G:1,B:2,A:3};else if(n.R&&n.G&&n.B)a=!0,r.outputChannels=4,r.decodeChannels={R:0,G:1,B:2,A:3};else if(n.R&&n.G)r.outputChannels=2,r.decodeChannels={R:0,G:1};else if(n.R)r.outputChannels=1,r.decodeChannels={R:0};else if(n.Y)r.outputChannels=1,r.decodeChannels={Y:0};else throw new Error("EXRLoader.parse: file contains unsupported data channels.");if(r.type===1)switch(i){case Ls.Float:r.getter=A1,r.inputSize=2;break;case Ls.HalfFloat:r.getter=uf,r.inputSize=2;break}else if(r.type===2)switch(i){case Ls.Float:r.getter=Ji,r.inputSize=4;break;case Ls.HalfFloat:r.getter=R1,r.inputSize=4}else throw new Error("Unsupported pixelType "+r.type+" for "+s.compression);r.blockCount=r.height/r.scanlineBlockSize;for(let c=0;c<r.blockCount;c++)x1(e,t);let o=r.width*r.height*r.outputChannels;switch(i){case Ls.Float:r.byteArray=new Float32Array(o),r.textureType=1,a&&r.byteArray.fill(1,0,o);break;case Ls.HalfFloat:r.byteArray=new Uint16Array(o),r.textureType=2,a&&r.byteArray.fill(15360,0,o);break;default:throw new Error("Unsupported type: "+i)}let l=0;for(let c of s.channels)r.decodeChannels[c.name]!==void 0&&(r.channelLineOffsets[c.name]=l*r.width),l+=c.pixelType*2;return r.bytesPerLine=r.width*l,r.outLineWidth=r.width*r.outputChannels,s.lineOrder==="INCREASING_Y"?r.scanOrder=c=>c:r.scanOrder=c=>r.height-1-c,r.outputChannels==4?(r.format=5,r.linearSpace=!0):(r.format=6,r.linearSpace=!1),r}function tC(s,e,t,i){let r={value:0};for(let n=0;n<s.height/s.scanlineBlockSize;n++){let a=on(t,i)-e.dataWindow.yMin;s.size=ls(t,i),s.lines=a+s.scanlineBlockSize>s.height?s.height-a:s.scanlineBlockSize;let l=s.size<s.lines*s.bytesPerLine&&s.uncompress?s.uncompress(s):Zb(s);i.value+=s.size;for(let c=0;c<s.scanlineBlockSize;c++){let f=n*s.scanlineBlockSize,h=c+s.scanOrder(f);if(h>=s.height)continue;let u=c*s.bytesPerLine,d=(s.height-1-h)*s.outLineWidth;for(let p=0;p<s.channels;p++){let m=e.channels[p].name,_=s.channelLineOffsets[m],v=s.decodeChannels[m];if(v!==void 0){r.value=u+_;for(let T=0;T<s.width;T++){let C=d+T*s.outputChannels+v;s.byteArray&&(s.byteArray[C]=s.getter(l,r))}}}}}}var q1=S(()=>{iu();K1();eu();$e();$b()});var Q1={};V(Q1,{ReadExrDataAsync:()=>uZ,_ExrTextureLoader:()=>iC});async function uZ(s){let e=new DataView(s),t={value:0},i=Kb(e,t);try{let r=await eC(i,e,t,Ls.Float);return tC(r,i,e,t),r.byteArray?{width:i.dataWindow.xMax-i.dataWindow.xMin+1,height:i.dataWindow.yMax-i.dataWindow.yMin+1,data:new Float32Array(r.byteArray)}:(P.Error("Failed to decode EXR data: No byte array available."),{width:0,height:0,data:null})}catch(r){P.Error("Failed to load EXR data: ",r)}return{width:0,height:0,data:null}}var iC,j1=S(()=>{C1();q1();$b();Ee();iC=class{constructor(){this.supportCascades=!1}loadCubeData(e,t,i,r,n){throw".exr not supported in Cube."}loadData(e,t,i){let r=new DataView(e.buffer),n={value:0},a=Kb(r,n);eC(a,r,n,zn.DefaultOutputType).then(o=>{tC(o,a,r,n);let l=a.dataWindow.xMax-a.dataWindow.xMin+1,c=a.dataWindow.yMax-a.dataWindow.yMin+1;i(l,c,t.generateMipMaps,!1,()=>{let f=t.getEngine();t.format=a.format,t.type=o.textureType,t.invertY=!1,t._gammaSpace=!a.linearSpace,o.byteArray&&f._uploadDataToTextureDirectly(t,o.byteArray,0,0,void 0,!0)})}).catch(o=>{P.Error("Failed to load EXR texture: ",o)})}}});function Ha(s,e){dZ(s)&&P.Warn(`Extension with the name '${s}' already exists`),Zm.set(s,e)}function dZ(s){return Zm.delete(s)}function dm(s,e){(e==="image/ktx"||e==="image/ktx2")&&(s=".ktx"),Zm.has(s)||(s.endsWith(".ies")&&Ha(".ies",async()=>await Promise.resolve().then(()=>(hO(),fO)).then(i=>new i._IESTextureLoader)),s.endsWith(".dds")&&Ha(".dds",async()=>await Promise.resolve().then(()=>(AL(),xL)).then(i=>new i._DDSTextureLoader)),s.endsWith(".basis")&&Ha(".basis",async()=>await Promise.resolve().then(()=>(ML(),yL)).then(i=>new i._BasisTextureLoader)),s.endsWith(".env")&&Ha(".env",async()=>await Promise.resolve().then(()=>(r1(),i1)).then(i=>new i._ENVTextureLoader)),s.endsWith(".hdr")&&Ha(".hdr",async()=>await Promise.resolve().then(()=>(l1(),o1)).then(i=>new i._HDRTextureLoader)),(s.endsWith(".ktx")||s.endsWith(".ktx2"))&&(Ha(".ktx",async()=>await Promise.resolve().then(()=>(Vb(),Gb)).then(i=>new i._KTXTextureLoader)),Ha(".ktx2",async()=>await Promise.resolve().then(()=>(Vb(),Gb)).then(i=>new i._KTXTextureLoader))),s.endsWith(".tga")&&Ha(".tga",async()=>await Promise.resolve().then(()=>(S1(),v1)).then(i=>new i._TGATextureLoader)),s.endsWith(".exr")&&Ha(".exr",async()=>await Promise.resolve().then(()=>(j1(),Q1)).then(i=>new i._ExrTextureLoader)));let t=Zm.get(s);return t?Promise.resolve(t(e)):null}var Zm,IR=S(()=>{Ee();Zm=new Map});function Z1(s,e){if(jt()){let{requestAnimationFrame:t}=e||window;if(typeof t=="function")return t(s)}else if(typeof requestAnimationFrame=="function")return requestAnimationFrame(s);return setTimeout(s,16)}var k,Jt=S(()=>{gt();Ee();dl();IA();zs();HA();zA();nO();wp();Ii();vi();Cs();we();fa();IR();k=class s{get frameId(){return this._frameId}get isWebGPU(){return this._isWebGPU}_getShaderProcessor(e){return this._shaderProcessor}_resetAlphaMode(){this._alphaMode.fill(-1),this._alphaEquation.fill(-1)}get shaderPlatformName(){return this._shaderPlatformName}_clearEmptyResources(){this._emptyTexture=null,this._emptyCubeTexture=null,this._emptyTexture3D=null,this._emptyTexture2DArray=null}get useReverseDepthBuffer(){return this._useReverseDepthBuffer}set useReverseDepthBuffer(e){e!==this._useReverseDepthBuffer&&(this._useReverseDepthBuffer=e,e?this._depthCullingState.depthFunc=518:this._depthCullingState.depthFunc=515)}setColorWrite(e){e!==this._colorWrite&&(this._colorWriteChanged=!0,this._colorWrite=e)}getColorWrite(){return this._colorWrite}get depthCullingState(){return this._depthCullingState}get alphaState(){return this._alphaState}get stencilState(){return this._stencilState}get stencilStateComposer(){return this._stencilStateComposer}_getGlobalDefines(e){if(e){this.isNDCHalfZRange?e.IS_NDC_HALF_ZRANGE="":delete e.IS_NDC_HALF_ZRANGE,this.useReverseDepthBuffer?e.USE_REVERSE_DEPTHBUFFER="":delete e.USE_REVERSE_DEPTHBUFFER,this.useExactSrgbConversions?e.USE_EXACT_SRGB_CONVERSIONS="":delete e.USE_EXACT_SRGB_CONVERSIONS;return}else{let t="";return this.isNDCHalfZRange&&(t+="#define IS_NDC_HALF_ZRANGE"),this.useReverseDepthBuffer&&(t&&(t+=`
`),t+="#define USE_REVERSE_DEPTHBUFFER"),this.useExactSrgbConversions&&(t&&(t+=`
`),t+="#define USE_EXACT_SRGB_CONVERSIONS"),t}}_rebuildInternalTextures(){let e=this._internalTexturesCache.slice();for(let t of e)t._rebuild()}_rebuildRenderTargetWrappers(){let e=this._renderTargetWrapperCache.slice();for(let t of e)t._rebuild()}_rebuildEffects(){for(let e in this._compiledEffects){let t=this._compiledEffects[e];t._pipelineContext=null,t._prepareEffect()}li.ResetCache()}_rebuildGraphicsResources(){this.wipeCaches(!0),this._rebuildEffects(),this._rebuildComputeEffects?.(),this._rebuildBuffers(),this._rebuildInternalTextures(),this._rebuildTextures(),this._rebuildRenderTargetWrappers(),this.wipeCaches(!0)}_flagContextRestored(){P.Warn(this.name+" context successfully restored."),this.onContextRestoredObservable.notifyObservers(this),this._contextWasLost=!1}_restoreEngineAfterContextLost(e){setTimeout(()=>{this._clearEmptyResources();let t=this._depthCullingState.depthTest,i=this._depthCullingState.depthFunc,r=this._depthCullingState.depthMask,n=this._stencilState.stencilTest;e(),this._rebuildGraphicsResources(),this._depthCullingState.depthTest=t,this._depthCullingState.depthFunc=i,this._depthCullingState.depthMask=r,this._stencilState.stencilTest=n,this._flagContextRestored()},0)}get isDisposed(){return this._isDisposed}get snapshotRendering(){return!1}set snapshotRendering(e){}get snapshotRenderingMode(){return 0}set snapshotRenderingMode(e){}getClassName(){return"AbstractEngine"}get emptyTexture(){return this._emptyTexture||(this._emptyTexture=this.createRawTexture(new Uint8Array(4),1,1,5,!1,!1,1)),this._emptyTexture}get emptyTexture3D(){return this._emptyTexture3D||(this._emptyTexture3D=this.createRawTexture3D(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture3D}get emptyTexture2DArray(){return this._emptyTexture2DArray||(this._emptyTexture2DArray=this.createRawTexture2DArray(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture2DArray}get emptyCubeTexture(){if(!this._emptyCubeTexture){let e=new Uint8Array(4),t=[e,e,e,e,e,e];this._emptyCubeTexture=this.createRawCubeTexture(t,1,5,0,!1,!1,1)}return this._emptyCubeTexture}get activeRenderLoops(){return this._activeRenderLoops}stopRenderLoop(e){if(!e){this._activeRenderLoops.length=0,this._cancelFrame();return}let t=this._activeRenderLoops.indexOf(e);t>=0&&(this._activeRenderLoops.splice(t,1),this._activeRenderLoops.length==0&&this._cancelFrame())}_cancelFrame(){if(this._frameHandler!==0){let e=this._frameHandler;if(this._frameHandler=0,jt()){let{cancelAnimationFrame:t}=this.getHostWindow()||window;if(typeof t=="function")return t(e)}else if(typeof cancelAnimationFrame=="function")return cancelAnimationFrame(e);return clearTimeout(e)}}beginFrame(){this.onBeginFrameObservable.notifyObservers(this)}endFrame(){this._frameId++,this.onEndFrameObservable.notifyObservers(this)}get maxFPS(){return this._maxFPS}set maxFPS(e){if(this._maxFPS=e,e!==void 0){if(e<=0){this._minFrameTime=Number.MAX_VALUE;return}this._minFrameTime=1e3/e}}_isOverFrameTime(e){if(!e||this._maxFPS===void 0)return!1;let t=e-this._lastFrameTime;return this._lastFrameTime=e,this._renderAccumulator+=t,this._renderAccumulator<this._minFrameTime?!0:(this._renderAccumulator-=this._minFrameTime,this._renderAccumulator>this._minFrameTime&&(this._renderAccumulator=this._minFrameTime),!1)}_processFrame(e){if(this._frameHandler=0,!this._contextWasLost&&!this._isOverFrameTime(e)){let t=!0;(this.isDisposed||!this.renderEvenInBackground&&this._windowIsBackground)&&(t=!1),t&&(this.beginFrame(),!this.skipFrameRender&&!this._renderViews()&&this._renderFrame(),this.endFrame())}}_renderLoop(e){this._processFrame(e),this._activeRenderLoops.length>0&&this._frameHandler===0&&(this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()))}_renderFrame(){for(let e=0;e<this._activeRenderLoops.length;e++){let t=this._activeRenderLoops[e];t()}}_renderViews(){return!1}_queueNewFrame(e,t){return Z1(e,t)}runRenderLoop(e){this._activeRenderLoops.indexOf(e)===-1&&(this._activeRenderLoops.push(e),this._activeRenderLoops.length===1&&this._frameHandler===0&&(this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow())))}getDepthBuffer(){return this._depthCullingState.depthTest}setDepthBuffer(e){this._depthCullingState.depthTest=e}setZOffset(e){this._depthCullingState.zOffset=this.useReverseDepthBuffer?-e:e}getZOffset(){let e=this._depthCullingState.zOffset;return this.useReverseDepthBuffer?-e:e}setZOffsetUnits(e){this._depthCullingState.zOffsetUnits=this.useReverseDepthBuffer?-e:e}getZOffsetUnits(){let e=this._depthCullingState.zOffsetUnits;return this.useReverseDepthBuffer?-e:e}getHostWindow(){return jt()?this._renderingCanvas&&this._renderingCanvas.ownerDocument&&this._renderingCanvas.ownerDocument.defaultView?this._renderingCanvas.ownerDocument.defaultView:window:null}get compatibilityMode(){return this._compatibilityMode}set compatibilityMode(e){this._compatibilityMode=!0}_rebuildTextures(){for(let e of this.scenes)e._rebuildTextures();for(let e of this._virtualScenes)e._rebuildTextures()}_releaseRenderTargetWrapper(e){let t=this._renderTargetWrapperCache.indexOf(e);t!==-1&&this._renderTargetWrapperCache.splice(t,1)}get currentViewport(){return this._cachedViewport}setViewport(e,t,i){let r=t||this.getRenderWidth(),n=i||this.getRenderHeight(),a=e.x||0,o=e.y||0;this._cachedViewport=e,this._viewport(a*r,o*n,r*e.width,n*e.height)}createCanvasImage(){return document.createElement("img")}createCanvasPath2D(e){return new Path2D(e)}get description(){let e=this.name+this.version;return this._caps.parallelShaderCompile&&(e+=" - Parallel shader compilation"),e}_createTextureBase(e,t,i,r,n=3,a=null,o=null,l,c,f=null,h=null,u=null,d=null,p,m,_){e=e||"";let v=e.substring(0,5)==="data:",T=e.substring(0,5)==="blob:",C=v&&e.indexOf(";base64,")!==-1,I=h||new Je(this,1);I!==h&&(I.label=e.substring(0,60));let R=e;this._transformTextureUrl&&!C&&!h&&!f&&(e=this._transformTextureUrl(e)),R!==e&&(I._originalUrl=R);let b=e.lastIndexOf("."),M=d||(b>-1?e.substring(b).toLowerCase():"");M.indexOf("?")>-1&&(M=M.split("?")[0]);let U=dm(M,p);r&&r.addPendingData(I),I.url=e,I.generateMipMaps=!t,I.samplingMode=n,I.invertY=i,I._useSRGBBuffer=this._getUseSRGBBuffer(!!_,t),this._doNotHandleContextLost||(I._buffer=f);let D=null;a&&!h&&(D=I.onLoadedObservable.add(a)),h||this._internalTexturesCache.push(I);let $=(oe,re)=>{r&&r.removePendingData(I),e===R?(D&&I.onLoadedObservable.remove(D),Z.UseFallbackTexture&&e!==Z.FallbackTexture&&this._createTextureBase(Z.FallbackTexture,t,I.invertY,r,n,null,o,l,c,f,I),oe=(oe||"Unknown error")+(Z.UseFallbackTexture?" - Fallback texture was used":""),I.onErrorObservable.notifyObservers({message:oe,exception:re}),o&&o(oe,re)):(P.Warn(`Failed to load ${e}, falling back to ${R}`),this._createTextureBase(R,t,I.invertY,r,n,a,o,l,c,f,I,u,d,p,m,_))};if(U){let oe=async re=>{(await U).loadData(re,I,(be,Me,ke,de,Qe,Re)=>{Re?$("TextureLoader failed to load data"):l(I,M,r,{width:be,height:Me},I.invertY,!ke,de,()=>(Qe(),!1),n)},m)};f?f instanceof ArrayBuffer?oe(new Uint8Array(f)):ArrayBuffer.isView(f)?oe(f):o&&o("Unable to load: only ArrayBuffer or ArrayBufferView is supported",null):this._loadFile(e,re=>{oe(new Uint8Array(re))},void 0,r?r.offlineProvider:void 0,!0,(re,se)=>{$("Unable to load "+(re&&re.responseURL,se))})}else{let oe=re=>{T&&!this._doNotHandleContextLost&&(I._buffer=re),l(I,M,r,re,I.invertY,t,!1,c,n)};!v||C?f&&(typeof f.decoding=="string"||f.close)?oe(f):s._FileToolsLoadImage(e||"",oe,$,r?r.offlineProvider:null,p,I.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0,this):typeof f=="string"||f instanceof ArrayBuffer||ArrayBuffer.isView(f)||f instanceof Blob?s._FileToolsLoadImage(f,oe,$,r?r.offlineProvider:null,p,I.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0,this):f&&oe(f)}return I}_rebuildBuffers(){for(let e of this._uniformBuffers)e._rebuildAfterContextLost()}get _shouldUseHighPrecisionShader(){return!!(this._caps.highPrecisionShaderSupported&&this._highPrecisionShadersAllowed)}getHostDocument(){return this._renderingCanvas&&this._renderingCanvas.ownerDocument?this._renderingCanvas.ownerDocument:mo()?document:null}getLoadedTexturesCache(){return this._internalTexturesCache}clearInternalTexturesCache(){this._internalTexturesCache.length=0}getCaps(){return this._caps}resetTextureCache(){for(let e in this._boundTexturesCache)Object.prototype.hasOwnProperty.call(this._boundTexturesCache,e)&&(this._boundTexturesCache[e]=null);this._currentTextureChannel=-1}get name(){return this._name}set name(e){this._name=e}static get NpmPackage(){return"babylonjs@8.28.1"}static get Version(){return"8.28.1"}getRenderingCanvas(){return this._renderingCanvas}getAudioContext(){return this._audioContext}getAudioDestination(){return this._audioDestination}setHardwareScalingLevel(e){this._hardwareScalingLevel=e,this.resize()}getHardwareScalingLevel(){return this._hardwareScalingLevel}get doNotHandleContextLost(){return this._doNotHandleContextLost}set doNotHandleContextLost(e){this._doNotHandleContextLost=e}get isStencilEnable(){return this._isStencilEnable}getCreationOptions(){return this._creationOptions}constructor(e,t,i){this._colorWrite=!0,this._colorWriteChanged=!0,this._depthCullingState=new Oc,this._stencilStateComposer=new Lc,this._stencilState=new pl,this._alphaState=new go(!1),this._alphaMode=Array(8).fill(-1),this._alphaEquation=Array(8).fill(-1),this._activeRequests=[],this._badOS=!1,this._badDesktopOS=!1,this._compatibilityMode=!0,this._internalTexturesCache=new Array,this._currentRenderTarget=null,this._boundTexturesCache={},this._activeChannel=0,this._currentTextureChannel=-1,this._viewportCached={x:0,y:0,z:0,w:0},this._isWebGPU=!1,this.onCanvasBlurObservable=new N,this.onCanvasFocusObservable=new N,this.onNewSceneAddedObservable=new N,this.onResizeObservable=new N,this.onCanvasPointerOutObservable=new N,this.onEffectErrorObservable=new N,this.disablePerformanceMonitorInBackground=!1,this.disableVertexArrayObjects=!1,this._frameId=0,this.hostInformation={isMobile:!1},this.isFullscreen=!1,this.enableOfflineSupport=!1,this.disableManifestCheck=!1,this.disableContextMenu=!0,this.currentRenderPassId=0,this.isPointerLock=!1,this.postProcesses=[],this.canvasTabIndex=1,this._contextWasLost=!1,this._useReverseDepthBuffer=!1,this.isNDCHalfZRange=!1,this.hasOriginBottomLeft=!0,this._renderTargetWrapperCache=new Array,this._compiledEffects={},this._isDisposed=!1,this.scenes=[],this._virtualScenes=new Array,this.onBeforeTextureInitObservable=new N,this.renderEvenInBackground=!0,this.preventCacheWipeBetweenFrames=!1,this._frameHandler=0,this._activeRenderLoops=new Array,this._windowIsBackground=!1,this._boundRenderFunction=a=>this._renderLoop(a),this._lastFrameTime=0,this._renderAccumulator=0,this.skipFrameRender=!1,this.onBeforeShaderCompilationObservable=new N,this.onAfterShaderCompilationObservable=new N,this.onBeginFrameObservable=new N,this.onEndFrameObservable=new N,this._transformTextureUrl=null,this._uniformBuffers=new Array,this._storageBuffers=new Array,this._highPrecisionShadersAllowed=!0,this.onContextLostObservable=new N,this.onContextRestoredObservable=new N,this._name="",this.premultipliedAlpha=!0,this.adaptToDeviceRatio=!1,this._lastDevicePixelRatio=1,this._doNotHandleContextLost=!1,this.cullBackFaces=null,this._renderPassNames=["main"],this._fps=60,this._deltaTime=0,this._deterministicLockstep=!1,this._lockstepMaxSteps=4,this._timeStep=1/60,this.onDisposeObservable=new N,this.onReleaseEffectsObservable=new N,Z.Instances.push(this),this.startTime=Zt.Now,this._stencilStateComposer.stencilGlobal=this._stencilState,Ar.SetMatrixPrecision(!!t.useHighPrecisionMatrix),ca()&&navigator.userAgent&&(this._badOS=/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent),this._badDesktopOS=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)),this.adaptToDeviceRatio=i??!1,t.antialias=e??t.antialias,t.deterministicLockstep=t.deterministicLockstep??!1,t.lockstepMaxSteps=t.lockstepMaxSteps??4,t.timeStep=t.timeStep??1/60,t.stencil=t.stencil??!0,this._audioContext=t.audioEngineOptions?.audioContext??null,this._audioDestination=t.audioEngineOptions?.audioDestination??null,this.premultipliedAlpha=t.premultipliedAlpha??!0,this._doNotHandleContextLost=!!t.doNotHandleContextLost,this._isStencilEnable=!!t.stencil,this.useExactSrgbConversions=t.useExactSrgbConversions??!1;let r=jt()&&window.devicePixelRatio||1,n=t.limitDeviceRatio||r;i=i||t.adaptToDeviceRatio||!1,this._hardwareScalingLevel=i?1/Math.min(n,r):1,this._lastDevicePixelRatio=r,this._creationOptions=t}resize(e=!1){let t,i;if(this.adaptToDeviceRatio){let r=jt()&&window.devicePixelRatio||1,n=this._lastDevicePixelRatio/r;this._lastDevicePixelRatio=r,this._hardwareScalingLevel*=n}if(jt()&&mo())if(this._renderingCanvas){let r=this._renderingCanvas.getBoundingClientRect?.();t=this._renderingCanvas.clientWidth||r?.width||this._renderingCanvas.width*this._hardwareScalingLevel||100,i=this._renderingCanvas.clientHeight||r?.height||this._renderingCanvas.height*this._hardwareScalingLevel||100}else t=window.innerWidth,i=window.innerHeight;else t=this._renderingCanvas?this._renderingCanvas.width:100,i=this._renderingCanvas?this._renderingCanvas.height:100;this.setSize(t/this._hardwareScalingLevel,i/this._hardwareScalingLevel,e)}setSize(e,t,i=!1){if(!this._renderingCanvas||(e=e|0,t=t|0,!i&&this._renderingCanvas.width===e&&this._renderingCanvas.height===t))return!1;if(this._renderingCanvas.width=e,this._renderingCanvas.height=t,this.scenes){for(let r=0;r<this.scenes.length;r++){let n=this.scenes[r];for(let a=0;a<n.cameras.length;a++){let o=n.cameras[a];o._currentRenderId=0}}this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this)}return!0}createRawTexture(e,t,i,r,n,a,o,l,c,f,h){throw pe("engine.rawTexture")}createRawCubeTexture(e,t,i,r,n,a,o,l){throw pe("engine.rawTexture")}createRawTexture3D(e,t,i,r,n,a,o,l,c,f,h){throw pe("engine.rawTexture")}createRawTexture2DArray(e,t,i,r,n,a,o,l,c,f,h){throw pe("engine.rawTexture")}_sharedInit(e){this._renderingCanvas=e}_setupMobileChecks(){navigator&&navigator.userAgent&&(this._checkForMobile=()=>{let e=navigator.userAgent;this.hostInformation.isMobile=e.indexOf("Mobile")!==-1||e.indexOf("Mac")!==-1&&mo()&&"ontouchend"in document},this._checkForMobile(),jt()&&window.addEventListener("resize",this._checkForMobile))}createVideoElement(e){return document.createElement("video")}_reportDrawCall(e=1){this._drawCalls?.addCount(e,!1)}getFps(){return this._fps}getDeltaTime(){return this._deltaTime}isDeterministicLockStep(){return this._deterministicLockstep}getLockstepMaxSteps(){return this._lockstepMaxSteps}getTimeStep(){return this._timeStep*1e3}_createImageBitmapFromSource(e,t){throw new Error("createImageBitmapFromSource is not implemented")}createImageBitmap(e,t){return createImageBitmap(e,t)}resizeImageBitmap(e,t,i){throw new Error("resizeImageBitmap is not implemented")}getFontOffset(e){throw new Error("getFontOffset is not implemented")}static _CreateCanvas(e,t){if(typeof document>"u")return new OffscreenCanvas(e,t);let i=document.createElement("canvas");return i.width=e,i.height=t,i}createCanvas(e,t){return s._CreateCanvas(e,t)}static _FileToolsLoadImage(e,t,i,r,n,a,o){throw pe("FileTools")}_loadFile(e,t,i,r,n,a){let o=xp(e,t,i,r,n,a);return this._activeRequests.push(o),o.onCompleteObservable.add(()=>{let l=this._activeRequests.indexOf(o);l!==-1&&this._activeRequests.splice(l,1)}),o}static _FileToolsLoadFile(e,t,i,r,n,a){if(Mc.loadFile)return Mc.loadFile(e,t,i,r,n,a);throw pe("FileTools")}dispose(){for(this.releaseEffects(),this._isDisposed=!0,this.stopRenderLoop(),this._emptyTexture&&(this._releaseTexture(this._emptyTexture),this._emptyTexture=null),this._emptyCubeTexture&&(this._releaseTexture(this._emptyCubeTexture),this._emptyCubeTexture=null),this._renderingCanvas=null,this.onBeforeTextureInitObservable&&this.onBeforeTextureInitObservable.clear();this.postProcesses.length;)this.postProcesses[0].dispose();for(;this.scenes.length;)this.scenes[0].dispose();for(;this._virtualScenes.length;)this._virtualScenes[0].dispose();this.releaseComputeEffects?.(),li.ResetCache();for(let t of this._activeRequests)t.abort();this._boundRenderFunction=null,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onResizeObservable.clear(),this.onCanvasBlurObservable.clear(),this.onCanvasFocusObservable.clear(),this.onCanvasPointerOutObservable.clear(),this.onNewSceneAddedObservable.clear(),this.onEffectErrorObservable.clear(),jt()&&window.removeEventListener("resize",this._checkForMobile);let e=Z.Instances.indexOf(this);e>=0&&Z.Instances.splice(e,1),Z.Instances.length||(Z.OnEnginesDisposedObservable.notifyObservers(this),Z.OnEnginesDisposedObservable.clear()),this.onBeginFrameObservable.clear(),this.onEndFrameObservable.clear()}static DefaultLoadingScreenFactory(e){throw pe("LoadingScreen")}static MarkAllMaterialsAsDirty(e,t){for(let i=0;i<Z.Instances.length;i++){let r=Z.Instances[i];for(let n=0;n<r.scenes.length;n++)r.scenes[n].markAllMaterialsAsDirty(e,t)}}};k._RenderPassIdCounter=0;k._RescalePostProcessFactory=null;k.CollisionsEpsilon=.001;k.QueueNewFrame=Z1});function Xo(s){return BD(s.split(",")[1])}var $1,mf,Jm,rC,pZ,Xt,$m,J1,zc,Dl,kn,zm,eB,tB,wl,iB,rB,mZ,nu,_Z,To=S(()=>{bc();Cs();we();wD();FD();Cc();pp();Mh();gt();Ee();ys();fa();Jt();$1=new RegExp(/^data:([^,]+\/[^,]+)?;base64,/i),mf=class s extends Nr{constructor(e,t){super(e,Is.LoadFileError),this.name="LoadFileError",Xs._setPrototypeOf(this,s.prototype),t instanceof gi?this.request=t:this.file=t}},Jm=class s extends Nr{constructor(e,t){super(e,Is.RequestFileError),this.request=t,this.name="RequestFileError",Xs._setPrototypeOf(this,s.prototype)}},rC=class s extends Nr{constructor(e,t){super(e,Is.ReadFileError),this.file=t,this.name="ReadFileError",Xs._setPrototypeOf(this,s.prototype)}},pZ=s=>(s=s.replace(/#/gm,"%23"),s),Xt={DefaultRetryStrategy:up.ExponentialBackoff(),BaseUrl:"",CorsBehavior:"anonymous",PreprocessUrl:s=>s,ScriptBaseUrl:"",ScriptPreprocessUrl:s=>s,CleanUrl:pZ},$m=(s,e)=>{if(!(s&&s.indexOf("data:")===0)&&Xt.CorsBehavior)if(typeof Xt.CorsBehavior=="string"||Xt.CorsBehavior instanceof String)e.crossOrigin=Xt.CorsBehavior;else{let t=Xt.CorsBehavior(s);t&&(e.crossOrigin=t)}},J1={getRequiredSize:null},zc=(s,e,t,i,r="",n,a=Z.LastCreatedEngine)=>{if(typeof HTMLImageElement>"u"&&!a?._features.forceBitmapOverHTMLImageElement)return t("LoadImage is only supported in web or BabylonNative environments."),null;let o,l=!1;s instanceof ArrayBuffer||ArrayBuffer.isView(s)?typeof Blob<"u"&&typeof URL<"u"?(o=URL.createObjectURL(new Blob([s],{type:r})),l=!0):o=`data:${r};base64,`+dp(s):s instanceof Blob?(o=URL.createObjectURL(s),l=!0):(o=Xt.CleanUrl(s),o=Xt.PreprocessUrl(o));let c=R=>{if(t){let b=o||s.toString();t(`Error while trying to load image: ${b.indexOf("http")===0||b.length<=128?b:b.slice(0,128)+"..."}`,R)}};if(a?._features.forceBitmapOverHTMLImageElement)return kn(o,R=>{a.createImageBitmap(new Blob([R],{type:r}),{premultiplyAlpha:"none",...n}).then(b=>{e(b),l&&URL.revokeObjectURL(o)}).catch(b=>{t&&t("Error while trying to load image: "+s,b)})},void 0,i||void 0,!0,(R,b)=>{c(b)}),null;let f=new Image;if(J1.getRequiredSize){let R=J1.getRequiredSize(s);R.width&&(f.width=R.width),R.height&&(f.height=R.height)}$m(o,f);let h=[],u=()=>{for(let R of h)R.target.addEventListener(R.name,R.handler)},d=()=>{for(let R of h)R.target.removeEventListener(R.name,R.handler);h.length=0},p=()=>{d(),e(f),l&&f.src&&URL.revokeObjectURL(f.src)},m=R=>{d(),c(R),l&&f.src&&URL.revokeObjectURL(f.src)},_=R=>{if(R.blockedURI!==f.src||R.disposition==="report")return;d();let b=new Error(`CSP violation of policy ${R.effectiveDirective} ${R.blockedURI}. Current policy is ${R.originalPolicy}`);Z.UseFallbackTexture=!1,c(b),l&&f.src&&URL.revokeObjectURL(f.src),f.src=""};h.push({target:f,name:"load",handler:p}),h.push({target:f,name:"error",handler:m}),h.push({target:document,name:"securitypolicyviolation",handler:_}),u();let v=o.substring(0,5)==="blob:",T=o.substring(0,5)==="data:",C=()=>{v||T||!gi.IsCustomRequestAvailable?f.src=o:kn(o,(R,b,M)=>{let F=!r&&M?M:r,U=new Blob([R],{type:F}),D=URL.createObjectURL(U);l=!0,f.src=D},void 0,i||void 0,!0,(R,b)=>{c(b)})},I=()=>{i&&i.loadImage(o,f)};if(!v&&!T&&i&&i.enableTexturesOffline)i.open(I,C);else{if(o.indexOf("file:")!==-1){let R=decodeURIComponent(o.substring(5).toLowerCase());if(_o.FilesToLoad[R]&&typeof URL<"u"){try{let b;try{b=URL.createObjectURL(_o.FilesToLoad[R])}catch{b=URL.createObjectURL(_o.FilesToLoad[R])}f.src=b,l=!0}catch{f.src=""}return f}}C()}return f},Dl=(s,e,t,i,r)=>{let n=new FileReader,a={onCompleteObservable:new N,abort:()=>n.abort()};return n.onloadend=()=>a.onCompleteObservable.notifyObservers(a),r&&(n.onerror=()=>{r(new rC(`Unable to read ${s.name}`,s))}),n.onload=o=>{e(o.target.result)},t&&(n.onprogress=t),i?n.readAsArrayBuffer(s):n.readAsText(s),a},kn=(s,e,t,i,r,n,a)=>{if(s.name)return Dl(s,e,t,r,n?f=>{n(void 0,f)}:void 0);let o=s;if(o.indexOf("file:")!==-1){let f=decodeURIComponent(o.substring(5).toLowerCase());f.indexOf("./")===0&&(f=f.substring(2));let h=_o.FilesToLoad[f];if(h)return Dl(h,e,t,r,n?u=>n(void 0,new mf(u.message,u.file)):void 0)}let{match:l,type:c}=iB(o);if(l){let f={onCompleteObservable:new N,abort:()=>()=>{}};try{let h=r?Xo(o):rB(o);e(h,void 0,c)}catch(h){n?n(void 0,h):P.Error(h.message||"Failed to parse the Data URL")}return Ys.SetImmediate(()=>{f.onCompleteObservable.notifyObservers(f)}),f}return zm(o,(f,h)=>{e(f,h?.responseURL,h?.getResponseHeader("content-type"))},t,i,r,n?f=>{n(f.request,new mf(f.message,f.request))}:void 0,a)},zm=(s,e,t,i,r,n,a)=>{i!==null&&(i??(i=Z.LastCreatedScene?.offlineProvider)),s=Xt.CleanUrl(s),s=Xt.PreprocessUrl(s);let o=Xt.BaseUrl+s,l=!1,c={onCompleteObservable:new N,abort:()=>l=!0},f=()=>{let h=new gi,u=null,d,p=()=>{h&&(t&&h.removeEventListener("progress",t),d&&h.removeEventListener("readystatechange",d),h.removeEventListener("loadend",m))},m=()=>{p(),c.onCompleteObservable.notifyObservers(c),c.onCompleteObservable.clear(),t=void 0,d=null,m=null,n=void 0,a=void 0,e=void 0};c.abort=()=>{l=!0,m&&m(),h&&h.readyState!==(XMLHttpRequest.DONE||4)&&h.abort(),u!==null&&(clearTimeout(u),u=null),h=null};let _=T=>{let C=T.message||"Unknown error";n&&h?n(new Jm(C,h)):P.Error(C)},v=T=>{if(h){if(h.open("GET",o),a)try{a(h)}catch(C){_(C);return}r&&(h.responseType="arraybuffer"),t&&h.addEventListener("progress",t),m&&h.addEventListener("loadend",m),d=()=>{if(!(l||!h)&&h.readyState===(XMLHttpRequest.DONE||4)){if(d&&h.removeEventListener("readystatechange",d),h.status>=200&&h.status<300||h.status===0&&(!jt()||tB())){let R=r?h.response:h.responseText;if(R!==null){try{e&&e(R,h)}catch(b){_(b)}return}}let C=Xt.DefaultRetryStrategy;if(C){let R=C(o,h,T);if(R!==-1){p(),h=new gi,u=setTimeout(()=>v(T+1),R);return}}let I=new Jm("Error status: "+h.status+" "+h.statusText+" - Unable to load "+o,h);n&&n(I)}},h.addEventListener("readystatechange",d),h.send()}};v(0)};if(i&&i.enableSceneOffline&&!s.startsWith("blob:")){let h=d=>{d&&d.status>400?n&&n(d):f()},u=()=>{i&&i.loadFile(Xt.BaseUrl+s,d=>{!l&&e&&e(d),c.onCompleteObservable.notifyObservers(c)},t?d=>{!l&&t&&t(d)}:void 0,h,r)};i.open(u,h)}else f();return c},eB=s=>{let{match:e,type:t}=iB(s);if(e)return t||void 0;let i=s.lastIndexOf(".");switch(s.substring(i+1).toLowerCase()){case"glb":return"model/gltf-binary";case"bin":return"application/octet-stream";case"gltf":return"model/gltf+json";case"jpg":case"jpeg":return"image/jpeg";case"png":return"image/png";case"webp":return"image/webp";case"ktx":return"image/ktx";case"ktx2":return"image/ktx2";case"avif":return"image/avif";default:return}},tB=()=>typeof location<"u"&&location.protocol==="file:",wl=s=>$1.test(s),iB=s=>{let e=$1.exec(s);return e===null||e.length===0?{match:!1,type:""}:{match:!0,type:e[0].replace("data:","").replace(";base64,","")}};rB=s=>OA(s.split(",")[1]),mZ=()=>{k._FileToolsLoadImage=zc,Mc.loadFile=kn,BA.loadFile=kn};mZ();_Z=(s,e,t,i,r,n,a,o,l,c)=>{nu={DecodeBase64UrlToBinary:s,DecodeBase64UrlToString:e,DefaultRetryStrategy:t.DefaultRetryStrategy,BaseUrl:t.BaseUrl,CorsBehavior:t.CorsBehavior,PreprocessUrl:t.PreprocessUrl,IsBase64DataUrl:i,IsFileURL:r,LoadFile:n,LoadImage:a,ReadFile:o,RequestFile:l,SetCorsBehavior:c},Object.defineProperty(nu,"DefaultRetryStrategy",{get:function(){return t.DefaultRetryStrategy},set:function(f){t.DefaultRetryStrategy=f}}),Object.defineProperty(nu,"BaseUrl",{get:function(){return t.BaseUrl},set:function(f){t.BaseUrl=f}}),Object.defineProperty(nu,"PreprocessUrl",{get:function(){return t.PreprocessUrl},set:function(f){t.PreprocessUrl=f}}),Object.defineProperty(nu,"CorsBehavior",{get:function(){return t.CorsBehavior},set:function(f){t.CorsBehavior=f}})};_Z(Xo,rB,Xt,wl,tB,kn,zc,Dl,zm,$m)});var W,e_,$e=S(()=>{we();Cs();Ee();Ch();zs();Ii();bc();gt();To();ys();QA();pa();Ao();W=class s{static get BaseUrl(){return Xt.BaseUrl}static set BaseUrl(e){Xt.BaseUrl=e}static get CleanUrl(){return Xt.CleanUrl}static set CleanUrl(e){Xt.CleanUrl=e}static IsAbsoluteUrl(e){return e.indexOf("//")===0?!0:e.indexOf("://")===-1||e.indexOf(".")===-1||e.indexOf("/")===-1||e.indexOf(":")>e.indexOf("/")?!1:e.indexOf("://")<e.indexOf(".")||e.indexOf("data:")===0||e.indexOf("blob:")===0}static set ScriptBaseUrl(e){Xt.ScriptBaseUrl=e}static get ScriptBaseUrl(){return Xt.ScriptBaseUrl}static set CDNBaseUrl(e){s.ScriptBaseUrl=e,s.AssetBaseUrl=e}static set ScriptPreprocessUrl(e){Xt.ScriptPreprocessUrl=e}static get ScriptPreprocessUrl(){return Xt.ScriptPreprocessUrl}static get DefaultRetryStrategy(){return Xt.DefaultRetryStrategy}static set DefaultRetryStrategy(e){Xt.DefaultRetryStrategy=e}static get CorsBehavior(){return Xt.CorsBehavior}static set CorsBehavior(e){Xt.CorsBehavior=e}static get UseFallbackTexture(){return Z.UseFallbackTexture}static set UseFallbackTexture(e){Z.UseFallbackTexture=e}static get RegisteredExternalClasses(){return _a.RegisteredExternalClasses}static set RegisteredExternalClasses(e){_a.RegisteredExternalClasses=e}static get fallbackTexture(){return Z.FallbackTexture}static set fallbackTexture(e){Z.FallbackTexture=e}static FetchToRef(e,t,i,r,n,a){let o=Math.abs(e)*i%i|0,l=Math.abs(t)*r%r|0,c=(o+l*i)*4;a.r=n[c]/255,a.g=n[c+1]/255,a.b=n[c+2]/255,a.a=n[c+3]/255}static Mix(e,t,i){return 0}static Instantiate(e){return _a.Instantiate(e)}static SetImmediate(e){Ys.SetImmediate(e)}static IsExponentOfTwo(e){return!0}static FloatRound(e){return Math.fround(e)}static GetFilename(e){let t=e.lastIndexOf("/");return t<0?e:e.substring(t+1)}static GetFolderPath(e,t=!1){let i=e.lastIndexOf("/");return i<0?t?e:"":e.substring(0,i+1)}static ToDegrees(e){return e*180/Math.PI}static ToRadians(e){return e*Math.PI/180}static SmoothAngleChange(e,t,i=.9){let r=this.ToRadians(e),n=this.ToRadians(t);return this.ToDegrees(Math.atan2((1-i)*Math.sin(n)+i*Math.sin(r),(1-i)*Math.cos(n)+i*Math.cos(r)))}static MakeArray(e,t){return t!==!0&&(e===void 0||e==null)?null:Array.isArray(e)?e:[e]}static GetPointerPrefix(e){return jt()&&!window.PointerEvent?"mouse":"pointer"}static SetCorsBehavior(e,t){$m(e,t)}static SetReferrerPolicyBehavior(e,t){t.referrerPolicy=e}static get PreprocessUrl(){return Xt.PreprocessUrl}static set PreprocessUrl(e){Xt.PreprocessUrl=e}static LoadImage(e,t,i,r,n,a){return zc(e,t,i,r,n,a)}static LoadFile(e,t,i,r,n,a){return kn(e,t,i,r,n,a)}static async LoadFileAsync(e,t=!0){return await new Promise((i,r)=>{kn(e,n=>{i(n)},void 0,void 0,t,(n,a)=>{r(a)})})}static GetAssetUrl(e){if(!e)return"";if(s.AssetBaseUrl&&e.startsWith(s._DefaultAssetsUrl)){let t=s.AssetBaseUrl[s.AssetBaseUrl.length-1]==="/"?s.AssetBaseUrl.substring(0,s.AssetBaseUrl.length-1):s.AssetBaseUrl;return e.replace(s._DefaultAssetsUrl,t)}return e}static GetBabylonScriptURL(e,t){if(!e)return"";if(s.ScriptBaseUrl&&e.startsWith(s._DefaultCdnUrl)){let i=s.ScriptBaseUrl[s.ScriptBaseUrl.length-1]==="/"?s.ScriptBaseUrl.substring(0,s.ScriptBaseUrl.length-1):s.ScriptBaseUrl;e=e.replace(s._DefaultCdnUrl,i)}return e=s.ScriptPreprocessUrl(e),t&&!s.IsAbsoluteUrl(e)&&(e=s.GetAbsoluteUrl(e)),e}static LoadBabylonScript(e,t,i,r){e=s.GetBabylonScriptURL(e),s.LoadScript(e,t,i)}static async LoadBabylonScriptAsync(e){return e=s.GetBabylonScriptURL(e),await s.LoadScriptAsync(e)}static LoadScript(e,t,i,r,n=!1){if(typeof importScripts=="function"){try{importScripts(e),t&&t()}catch(l){i?.(`Unable to load script '${e}' in worker`,l)}return}else if(!jt()){i?.(`Cannot load script '${e}' outside of a window or a worker`);return}let a=document.getElementsByTagName("head")[0],o=document.createElement("script");n?(o.setAttribute("type","module"),o.innerText=e):(o.setAttribute("type","text/javascript"),o.setAttribute("src",e)),r&&(o.id=r),o.onload=()=>{t&&t()},o.onerror=l=>{i&&i(`Unable to load script '${e}'`,l)},a.appendChild(o)}static async LoadScriptAsync(e,t){return await new Promise((i,r)=>{this.LoadScript(e,()=>{i()},(n,a)=>{r(a||new Error(n))},t)})}static ReadFileAsDataURL(e,t,i){let r=new FileReader,n={onCompleteObservable:new N,abort:()=>r.abort()};return r.onloadend=()=>{n.onCompleteObservable.notifyObservers(n)},r.onload=a=>{t(a.target.result)},r.onprogress=i,r.readAsDataURL(e),n}static ReadFile(e,t,i,r,n){return Dl(e,t,i,r,n)}static FileAsURL(e){let t=new Blob([e]);return window.URL.createObjectURL(t)}static Format(e,t=2){return e.toFixed(t)}static DeepCopy(e,t,i,r){xn.DeepCopy(e,t,i,r)}static IsEmpty(e){for(let t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}static RegisterTopRootEvents(e,t){for(let i=0;i<t.length;i++){let r=t[i];e.addEventListener(r.name,r.handler,!1);try{window.parent&&window.parent.addEventListener(r.name,r.handler,!1)}catch{}}}static UnregisterTopRootEvents(e,t){for(let i=0;i<t.length;i++){let r=t[i];e.removeEventListener(r.name,r.handler);try{e.parent&&e.parent.removeEventListener(r.name,r.handler)}catch{}}}static async DumpFramebuffer(e,t,i,r,n="image/png",a,o){throw pe("DumpTools")}static DumpData(e,t,i,r,n="image/png",a,o=!1,l=!1,c){throw pe("DumpTools")}static async DumpDataAsync(e,t,i,r="image/png",n,a=!1,o=!1,l){throw pe("DumpTools")}static _IsOffScreenCanvas(e){return e.convertToBlob!==void 0}static ToBlob(e,t,i="image/png",r){!s._IsOffScreenCanvas(e)&&!e.toBlob&&(e.toBlob=function(n,a,o){setTimeout(()=>{let l=atob(this.toDataURL(a,o).split(",")[1]),c=l.length,f=new Uint8Array(c);for(let h=0;h<c;h++)f[h]=l.charCodeAt(h);n(new Blob([f]))})}),s._IsOffScreenCanvas(e)?e.convertToBlob({type:i,quality:r}).then(n=>t(n)):e.toBlob(function(n){t(n)},i,r)}static DownloadBlob(e,t){if("download"in document.createElement("a")){if(!t){let i=new Date;t="screenshot_"+((i.getFullYear()+"-"+(i.getMonth()+1)).slice(2)+"-"+i.getDate()+"_"+i.getHours()+"-"+("0"+i.getMinutes()).slice(-2))+".png"}s.Download(e,t)}else if(e&&typeof URL<"u"){let i=URL.createObjectURL(e),r=window.open("");if(!r)return;let n=r.document.createElement("img");n.onload=function(){URL.revokeObjectURL(i)},n.src=i,r.document.body.appendChild(n)}}static EncodeScreenshotCanvasData(e,t,i="image/png",r,n){if(typeof r=="string"||!t)this.ToBlob(e,function(a){a&&s.DownloadBlob(a,r),t&&t("")},i,n);else if(t){if(s._IsOffScreenCanvas(e)){e.convertToBlob({type:i,quality:n}).then(o=>{let l=new FileReader;l.readAsDataURL(o),l.onloadend=()=>{let c=l.result;t(c)}});return}let a=e.toDataURL(i,n);t(a)}}static Download(e,t){if(typeof URL>"u")return;let i=window.URL.createObjectURL(e),r=document.createElement("a");document.body.appendChild(r),r.style.display="none",r.href=i,r.download=t,r.addEventListener("click",()=>{r.parentElement&&r.parentElement.removeChild(r)}),r.click(),window.URL.revokeObjectURL(i)}static BackCompatCameraNoPreventDefault(e){return typeof e[0]=="boolean"?e[0]:typeof e[1]=="boolean"?e[1]:!1}static CreateScreenshot(e,t,i,r,n="image/png",a=!1,o){throw pe("ScreenshotTools")}static async CreateScreenshotAsync(e,t,i,r="image/png",n){throw pe("ScreenshotTools")}static CreateScreenshotUsingRenderTarget(e,t,i,r,n="image/png",a=1,o=!1,l,c=!1,f=!1,h=!0,u,d){throw pe("ScreenshotTools")}static async CreateScreenshotUsingRenderTargetAsync(e,t,i,r="image/png",n=1,a=!1,o,l=!1,c=!1,f=!0,h,u){throw pe("ScreenshotTools")}static RandomId(){return Vi()}static IsBase64(e){return wl(e)}static DecodeBase64(e){return Xo(e)}static get errorsCount(){return P.errorsCount}static Log(e){P.Log(e)}static Warn(e){P.Warn(e)}static Error(e){P.Error(e)}static get LogCache(){return P.LogCache}static ClearLogCache(){P.ClearLogCache()}static set LogLevels(e){P.LogLevels=e}static set PerformanceLogLevel(e){if((e&s.PerformanceUserMarkLogLevel)===s.PerformanceUserMarkLogLevel){s.StartPerformanceCounter=s._StartUserMark,s.EndPerformanceCounter=s._EndUserMark;return}if((e&s.PerformanceConsoleLogLevel)===s.PerformanceConsoleLogLevel){s.StartPerformanceCounter=s._StartPerformanceConsole,s.EndPerformanceCounter=s._EndPerformanceConsole;return}s.StartPerformanceCounter=s._StartPerformanceCounterDisabled,s.EndPerformanceCounter=s._EndPerformanceCounterDisabled}static _StartPerformanceCounterDisabled(e,t){}static _EndPerformanceCounterDisabled(e,t){}static _StartUserMark(e,t=!0){if(!s._Performance){if(!jt())return;s._Performance=window.performance}!t||!s._Performance.mark||s._Performance.mark(e+"-Begin")}static _EndUserMark(e,t=!0){!t||!s._Performance.mark||(s._Performance.mark(e+"-End"),s._Performance.measure(e,e+"-Begin",e+"-End"))}static _StartPerformanceConsole(e,t=!0){t&&(s._StartUserMark(e,t),console.time&&console.time(e))}static _EndPerformanceConsole(e,t=!0){t&&(s._EndUserMark(e,t),console.timeEnd(e))}static get Now(){return Zt.Now}static GetClassName(e,t=!1){let i=null;return!t&&e.getClassName?i=e.getClassName():(e instanceof Object&&(i=(t?e:Object.getPrototypeOf(e)).constructor.__bjsclassName__),i||(i=typeof e)),i}static First(e,t){for(let i of e)if(t(i))return i;return null}static getFullClassName(e,t=!1){let i=null,r=null;if(!t&&e.getClassName)i=e.getClassName();else{if(e instanceof Object){let n=t?e:Object.getPrototypeOf(e);i=n.constructor.__bjsclassName__,r=n.constructor.__bjsmoduleName__}i||(i=typeof e)}return i?(r!=null?r+".":"")+i:null}static async DelayAsync(e){await new Promise(t=>{setTimeout(()=>{t()},e)})}static IsSafari(){return ca()?/^((?!chrome|android).)*safari/i.test(navigator.userAgent):!1}};W.AssetBaseUrl="";W.UseCustomRequestHeaders=!1;W.CustomRequestHeaders=gi.CustomRequestHeaders;W.GetDOMTextContent=hp;W._DefaultCdnUrl="https://cdn.babylonjs.com";W._DefaultAssetsUrl="https://assets.babylonjs.com/core";W.GetAbsoluteUrl=typeof document=="object"?s=>{let e=document.createElement("a");return e.href=s,e.href}:typeof URL=="function"&&typeof location=="object"?s=>new URL(s,location.origin).href:()=>{throw new Error("Unable to get absolute URL. Override BABYLON.Tools.GetAbsoluteUrl to a custom implementation for the current context.")};W.NoneLogLevel=P.NoneLogLevel;W.MessageLogLevel=P.MessageLogLevel;W.WarningLogLevel=P.WarningLogLevel;W.ErrorLogLevel=P.ErrorLogLevel;W.AllLogLevel=P.AllLogLevel;W.IsWindowObjectExist=jt;W.PerformanceNoneLogLevel=0;W.PerformanceUserMarkLogLevel=1;W.PerformanceConsoleLogLevel=2;W.StartPerformanceCounter=W._StartPerformanceCounterDisabled;W.EndPerformanceCounter=W._EndPerformanceCounterDisabled;e_=class s{constructor(e,t,i,r=0){this.iterations=e,this.index=r-1,this._done=!1,this._fn=t,this._successCallback=i}executeNext(){this._done||(this.index+1<this.iterations?(++this.index,this._fn(this)):this.breakLoop())}breakLoop(){this._done=!0,this._successCallback()}static Run(e,t,i,r=0){let n=new s(e,t,i,r);return n.executeNext(),n}static SyncAsyncForLoop(e,t,i,r,n,a=0){return s.Run(Math.ceil(e/t),o=>{n&&n()?o.breakLoop():setTimeout(()=>{for(let l=0;l<t;++l){let c=o.index*t+l;if(c>=e)break;if(i(c),n&&n()){o.breakLoop();break}}o.executeNext()},a)},r)}};W.Mix=Oh;W.IsExponentOfTwo=Sl;Z.FallbackTexture="data:image/jpg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QBmRXhpZgAATU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAAExAAIAAAAQAAAATgAAAAAAAABgAAAAAQAAAGAAAAABcGFpbnQubmV0IDQuMC41AP/bAEMABAIDAwMCBAMDAwQEBAQFCQYFBQUFCwgIBgkNCw0NDQsMDA4QFBEODxMPDAwSGBITFRYXFxcOERkbGRYaFBYXFv/bAEMBBAQEBQUFCgYGChYPDA8WFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFv/AABEIAQABAAMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APH6KKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76P//Z"});function sC(s,e,t){try{let i=s.next();i.done?e(i):i.value?i.value.then(()=>{i.value=void 0,e(i)},t):e(i)}catch(i){t(i)}}function _f(s=25){let e;return(t,i,r)=>{let n=performance.now();e===void 0||n-e>s?(e=n,setTimeout(()=>{sC(t,i,r)},0)):sC(t,i,r)}}function sB(s,e,t,i,r){let n=()=>{let a,o=l=>{l.done?t(l.value):a===void 0?a=!0:n()};do a=void 0,!r||!r.aborted?e(s,o,i):i(new Error("Aborted")),a===void 0&&(a=!1);while(a)};n()}function Fl(s,e){let t;return sB(s,sC,i=>t=i,i=>{throw i},e),t}async function gf(s,e,t){return await new Promise((i,r)=>{sB(s,e,i,r,t)})}function nB(s,e){return(...t)=>Fl(s(...t),e)}var t_=S(()=>{});var Nl,nC=S(()=>{Nl=class{constructor(e,t,i){this.bu=e,this.bv=t,this.distance=i,this.faceId=0,this.subMeshId=0,this._internalSubMeshId=0}}});function aB(s,e,t,i,r=null){let n=new E(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),a=new E(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return vf.extractMinAndMaxIndexed(s,e,t,i,n,a),r&&(n.x-=n.x*r.x+r.y,n.y-=n.y*r.x+r.y,n.z-=n.z*r.x+r.y,a.x+=a.x*r.x+r.y,a.y+=a.y*r.x+r.y,a.z+=a.z*r.x+r.y),{minimum:n,maximum:a}}function i_(s,e,t,i=null,r){let n=new E(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),a=new E(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return r||(r=3),vf.extractMinAndMax(s,e,t,r,n,a),i&&(n.x-=n.x*i.x+i.y,n.y-=n.y*i.x+i.y,n.z-=n.z*i.x+i.y,a.x+=a.x*i.x+i.y,a.y+=a.y*i.x+i.y,a.z+=a.z*i.x+i.y),{minimum:n,maximum:a}}var vf,r_=S(()=>{Ye();ie();je();vf=class{static extractMinAndMaxIndexed(e,t,i,r,n,a){for(let o=i;o<i+r;o++){let l=t[o]*3,c=e[l],f=e[l+1],h=e[l+2];n.minimizeInPlaceFromFloats(c,f,h),a.maximizeInPlaceFromFloats(c,f,h)}}static extractMinAndMax(e,t,i,r,n,a){for(let o=t,l=t*r;o<t+i;o++,l+=r){let c=e[l],f=e[l+1],h=e[l+2];n.minimizeInPlaceFromFloats(c,f,h),a.maximizeInPlaceFromFloats(c,f,h)}}};x([Ts.filter((...[s,e])=>!Array.isArray(s)&&!Array.isArray(e))],vf,"extractMinAndMaxIndexed",null);x([Ts.filter((...[s])=>!Array.isArray(s))],vf,"extractMinAndMax",null)});var cr,Sf=S(()=>{yt();nC();Pl();r_();El();cr=class s{get materialDefines(){return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.defines:this._getDrawWrapper()?.defines}set materialDefines(e){let t=this._mainDrawWrapperOverride??this._getDrawWrapper(void 0,!0);t.defines=e}_getDrawWrapper(e,t=!1){e=e??this._engine.currentRenderPassId;let i=this._drawWrappers[e];return!i&&t&&(this._drawWrappers[e]=i=new Vr(this._mesh.getScene().getEngine())),i}_removeDrawWrapper(e,t=!0,i=!1){t&&this._drawWrappers[e]?.dispose(i),this._drawWrappers[e]=void 0}get effect(){return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.effect:this._getDrawWrapper()?.effect??null}get _drawWrapper(){return this._mainDrawWrapperOverride??this._getDrawWrapper(void 0,!0)}get _drawWrapperOverride(){return this._mainDrawWrapperOverride}_setMainDrawWrapperOverride(e){this._mainDrawWrapperOverride=e}setEffect(e,t=null,i,r=!0){let n=this._drawWrapper;n.setEffect(e,t,r),i!==void 0&&(n.materialContext=i),e||(n.defines=null,n.materialContext=void 0)}resetDrawCache(e,t=!1){if(this._drawWrappers)if(e!==void 0){this._removeDrawWrapper(e,!0,t);return}else for(let i of this._drawWrappers)i?.dispose(t);this._drawWrappers=[]}static AddToMesh(e,t,i,r,n,a,o,l=!0){return new s(e,t,i,r,n,a,o,l)}constructor(e,t,i,r,n,a,o,l=!0,c=!0){this.materialIndex=e,this.verticesStart=t,this.verticesCount=i,this.indexStart=r,this.indexCount=n,this._mainDrawWrapperOverride=null,this._linesIndexCount=0,this._linesIndexBuffer=null,this._lastColliderWorldVertices=null,this._lastColliderTransformMatrix=null,this._wasDispatched=!1,this._renderId=0,this._alphaIndex=0,this._distanceToCamera=0,this._currentMaterial=null,this._mesh=a,this._renderingMesh=o||a,c&&a.subMeshes.push(this),this._engine=this._mesh.getScene().getEngine(),this.resetDrawCache(),this._trianglePlanes=[],this._id=a.subMeshes.length-1,l&&(this.refreshBoundingInfo(),a.computeWorldMatrix(!0))}get IsGlobal(){return this.verticesStart===0&&this.verticesCount===this._mesh.getTotalVertices()&&this.indexStart===0&&this.indexCount===this._mesh.getTotalIndices()}getBoundingInfo(){return this.IsGlobal||this._mesh.hasThinInstances?this._mesh.getBoundingInfo():this._boundingInfo}setBoundingInfo(e){return this._boundingInfo=e,this}getMesh(){return this._mesh}getRenderingMesh(){return this._renderingMesh}getReplacementMesh(){return this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null}getEffectiveMesh(){let e=this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null;return e||this._renderingMesh}getMaterial(e=!0){let t=this._renderingMesh.getMaterialForRenderPass(this._engine.currentRenderPassId)??this._renderingMesh.material;if(t){if(this._isMultiMaterial(t)){let i=t.getSubMaterial(this.materialIndex);return this._currentMaterial!==i&&(this._currentMaterial=i,this.resetDrawCache()),i}}else return e&&this._mesh.getScene()._hasDefaultMaterial?this._mesh.getScene().defaultMaterial:null;return t}_isMultiMaterial(e){return e.getSubMaterial!==void 0}refreshBoundingInfo(e=null){if(this._lastColliderWorldVertices=null,this.IsGlobal||!this._renderingMesh||!this._renderingMesh.geometry)return this;if(e||(e=this._renderingMesh.getVerticesData(A.PositionKind)),!e)return this._boundingInfo=this._mesh.getBoundingInfo(),this;let t=this._renderingMesh.getIndices(),i;if(this.indexStart===0&&this.indexCount===t.length){let r=this._renderingMesh.getBoundingInfo();i={minimum:r.minimum.clone(),maximum:r.maximum.clone()}}else i=aB(e,t,this.indexStart,this.indexCount,this._renderingMesh.geometry.boundingBias);return this._boundingInfo?this._boundingInfo.reConstruct(i.minimum,i.maximum):this._boundingInfo=new Ei(i.minimum,i.maximum),this}_checkCollision(e){return this.getBoundingInfo()._checkCollision(e)}updateBoundingInfo(e){let t=this.getBoundingInfo();return t||(this.refreshBoundingInfo(),t=this.getBoundingInfo()),t&&t.update(e),this}isInFrustum(e){let t=this.getBoundingInfo();return t?t.isInFrustum(e,this._mesh.cullingStrategy):!1}isCompletelyInFrustum(e){let t=this.getBoundingInfo();return t?t.isCompletelyInFrustum(e):!1}render(e){return this._renderingMesh.render(this,e,this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:void 0),this}_getLinesIndexBuffer(e,t){if(!this._linesIndexBuffer){let i=Math.floor(this.indexCount/3)*6,n=this.verticesStart+this.verticesCount>65535?new Uint32Array(i):new Uint16Array(i),a=0;if(e.length===0)for(let o=this.indexStart;o<this.indexStart+this.indexCount;o+=3)n[a++]=o,n[a++]=o+1,n[a++]=o+1,n[a++]=o+2,n[a++]=o+2,n[a++]=o;else for(let o=this.indexStart;o<this.indexStart+this.indexCount;o+=3)n[a++]=e[o],n[a++]=e[o+1],n[a++]=e[o+1],n[a++]=e[o+2],n[a++]=e[o+2],n[a++]=e[o];this._linesIndexBuffer=t.createIndexBuffer(n),this._linesIndexCount=n.length}return this._linesIndexBuffer}canIntersects(e){let t=this.getBoundingInfo();return t?e.intersectsBox(t.boundingBox):!1}intersects(e,t,i,r,n){let a=this.getMaterial();if(!a)return null;let o=3,l=!1;switch(a.fillMode){case 3:case 5:case 6:case 8:return null;case 7:o=1,l=!0;break;default:break}return a.fillMode===4?i.length?this._intersectLines(e,t,i,this._mesh.intersectionThreshold,r):this._intersectUnIndexedLines(e,t,i,this._mesh.intersectionThreshold,r):!i.length&&this._mesh._unIndexed?this._intersectUnIndexedTriangles(e,t,i,r,n):this._intersectTriangles(e,t,i,o,l,r,n)}_intersectLines(e,t,i,r,n){let a=null;for(let o=this.indexStart;o<this.indexStart+this.indexCount;o+=2){let l=t[i[o]],c=t[i[o+1]],f=e.intersectionSegment(l,c,r);if(!(f<0)&&(n||!a||f<a.distance)&&(a=new Nl(null,null,f),a.faceId=o/2,n))break}return a}_intersectUnIndexedLines(e,t,i,r,n){let a=null;for(let o=this.verticesStart;o<this.verticesStart+this.verticesCount;o+=2){let l=t[o],c=t[o+1],f=e.intersectionSegment(l,c,r);if(!(f<0)&&(n||!a||f<a.distance)&&(a=new Nl(null,null,f),a.faceId=o/2,n))break}return a}_intersectTriangles(e,t,i,r,n,a,o){let l=null,c=-1;for(let f=this.indexStart;f<this.indexStart+this.indexCount-(3-r);f+=r){c++;let h=i[f],u=i[f+1],d=i[f+2];if(n&&d===4294967295){f+=2;continue}let p=t[h],m=t[u],_=t[d];if(!p||!m||!_||o&&!o(p,m,_,e,h,u,d))continue;let v=e.intersectsTriangle(p,m,_);if(v){if(v.distance<0)continue;if((a||!l||v.distance<l.distance)&&(l=v,l.faceId=c,a))break}}return l}_intersectUnIndexedTriangles(e,t,i,r,n){let a=null;for(let o=this.verticesStart;o<this.verticesStart+this.verticesCount;o+=3){let l=t[o],c=t[o+1],f=t[o+2];if(n&&!n(l,c,f,e,-1,-1,-1))continue;let h=e.intersectsTriangle(l,c,f);if(h){if(h.distance<0)continue;if((r||!a||h.distance<a.distance)&&(a=h,a.faceId=o/3,r))break}}return a}_rebuild(){this._linesIndexBuffer&&(this._linesIndexBuffer=null)}clone(e,t){let i=new s(this.materialIndex,this.verticesStart,this.verticesCount,this.indexStart,this.indexCount,e,t,!1);if(!this.IsGlobal){let r=this.getBoundingInfo();if(!r)return i;i._boundingInfo=new Ei(r.minimum,r.maximum)}return i}dispose(e=!1){this._linesIndexBuffer&&(this._mesh.getScene().getEngine()._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null);let t=this._mesh.subMeshes.indexOf(this);this._mesh.subMeshes.splice(t,1),this.resetDrawCache(void 0,e)}getClassName(){return"SubMesh"}static CreateFromIndices(e,t,i,r,n,a=!0){let o=Number.MAX_VALUE,l=-Number.MAX_VALUE,f=(n||r).getIndices();for(let h=t;h<t+i;h++){let u=f[h];u<o&&(o=u),u>l&&(l=u)}return new s(e,o,l-o+1,t,i,r,n,a)}}});var au,Ge,ln=S(()=>{Ye();ie();yt();Ii();it();Ee();je();t_();Cc();Sf();au=class{},Ge=class s{constructor(){this.uniqueId=0,this.metadata={},this._applyTo=nB(this._applyToCoroutine.bind(this)),this.uniqueId=s._UniqueIdGenerator,s._UniqueIdGenerator++}set(e,t){switch(e.length||P.Warn(`Setting vertex data kind '${t}' with an empty array`),t){case A.PositionKind:this.positions=e;break;case A.NormalKind:this.normals=e;break;case A.TangentKind:this.tangents=e;break;case A.UVKind:this.uvs=e;break;case A.UV2Kind:this.uvs2=e;break;case A.UV3Kind:this.uvs3=e;break;case A.UV4Kind:this.uvs4=e;break;case A.UV5Kind:this.uvs5=e;break;case A.UV6Kind:this.uvs6=e;break;case A.ColorKind:this.colors=e;break;case A.MatricesIndicesKind:this.matricesIndices=e;break;case A.MatricesWeightsKind:this.matricesWeights=e;break;case A.MatricesIndicesExtraKind:this.matricesIndicesExtra=e;break;case A.MatricesWeightsExtraKind:this.matricesWeightsExtra=e;break}}applyToMesh(e,t){return this._applyTo(e,t,!1),this}applyToGeometry(e,t){return this._applyTo(e,t,!1),this}updateMesh(e){return this._update(e),this}updateGeometry(e){return this._update(e),this}*_applyToCoroutine(e,t=!1,i){if(this.positions&&(e.setVerticesData(A.PositionKind,this.positions,t),i&&(yield)),this.normals&&(e.setVerticesData(A.NormalKind,this.normals,t),i&&(yield)),this.tangents&&(e.setVerticesData(A.TangentKind,this.tangents,t),i&&(yield)),this.uvs&&(e.setVerticesData(A.UVKind,this.uvs,t),i&&(yield)),this.uvs2&&(e.setVerticesData(A.UV2Kind,this.uvs2,t),i&&(yield)),this.uvs3&&(e.setVerticesData(A.UV3Kind,this.uvs3,t),i&&(yield)),this.uvs4&&(e.setVerticesData(A.UV4Kind,this.uvs4,t),i&&(yield)),this.uvs5&&(e.setVerticesData(A.UV5Kind,this.uvs5,t),i&&(yield)),this.uvs6&&(e.setVerticesData(A.UV6Kind,this.uvs6,t),i&&(yield)),this.colors){let r=this.positions&&this.colors.length===this.positions.length?3:4;e.setVerticesData(A.ColorKind,this.colors,t,r),this.hasVertexAlpha&&e.hasVertexAlpha!==void 0&&(e.hasVertexAlpha=!0),i&&(yield)}if(this.matricesIndices&&(e.setVerticesData(A.MatricesIndicesKind,this.matricesIndices,t),i&&(yield)),this.matricesWeights&&(e.setVerticesData(A.MatricesWeightsKind,this.matricesWeights,t),i&&(yield)),this.matricesIndicesExtra&&(e.setVerticesData(A.MatricesIndicesExtraKind,this.matricesIndicesExtra,t),i&&(yield)),this.matricesWeightsExtra&&(e.setVerticesData(A.MatricesWeightsExtraKind,this.matricesWeightsExtra,t),i&&(yield)),this.indices?(e.setIndices(this.indices,null,t),i&&(yield)):e.setIndices([],null),e.subMeshes&&this.materialInfos&&this.materialInfos.length>1){let r=e;r.subMeshes=[];for(let n of this.materialInfos)new cr(n.materialIndex,n.verticesStart,n.verticesCount,n.indexStart,n.indexCount,r)}return this}_update(e,t,i){return this.positions&&e.updateVerticesData(A.PositionKind,this.positions,t,i),this.normals&&e.updateVerticesData(A.NormalKind,this.normals,t,i),this.tangents&&e.updateVerticesData(A.TangentKind,this.tangents,t,i),this.uvs&&e.updateVerticesData(A.UVKind,this.uvs,t,i),this.uvs2&&e.updateVerticesData(A.UV2Kind,this.uvs2,t,i),this.uvs3&&e.updateVerticesData(A.UV3Kind,this.uvs3,t,i),this.uvs4&&e.updateVerticesData(A.UV4Kind,this.uvs4,t,i),this.uvs5&&e.updateVerticesData(A.UV5Kind,this.uvs5,t,i),this.uvs6&&e.updateVerticesData(A.UV6Kind,this.uvs6,t,i),this.colors&&e.updateVerticesData(A.ColorKind,this.colors,t,i),this.matricesIndices&&e.updateVerticesData(A.MatricesIndicesKind,this.matricesIndices,t,i),this.matricesWeights&&e.updateVerticesData(A.MatricesWeightsKind,this.matricesWeights,t,i),this.matricesIndicesExtra&&e.updateVerticesData(A.MatricesIndicesExtraKind,this.matricesIndicesExtra,t,i),this.matricesWeightsExtra&&e.updateVerticesData(A.MatricesWeightsExtraKind,this.matricesWeightsExtra,t,i),this.indices&&e.setIndices(this.indices,null),this}static _TransformVector3Coordinates(e,t,i=0,r=e.length){let n=w.Vector3[0],a=w.Vector3[1];for(let o=i;o<i+r;o+=3)E.FromArrayToRef(e,o,n),E.TransformCoordinatesToRef(n,t,a),e[o]=a.x,e[o+1]=a.y,e[o+2]=a.z}static _TransformVector3Normals(e,t,i=0,r=e.length){let n=w.Vector3[0],a=w.Vector3[1];for(let o=i;o<i+r;o+=3)E.FromArrayToRef(e,o,n),E.TransformNormalToRef(n,t,a),e[o]=a.x,e[o+1]=a.y,e[o+2]=a.z}static _TransformVector4Normals(e,t,i=0,r=e.length){let n=w.Vector4[0],a=w.Vector4[1];for(let o=i;o<i+r;o+=4)Oe.FromArrayToRef(e,o,n),Oe.TransformNormalToRef(n,t,a),e[o]=a.x,e[o+1]=a.y,e[o+2]=a.z,e[o+3]=a.w}static _FlipFaces(e,t=0,i=e.length){for(let r=t;r<t+i;r+=3){let n=e[r+1];e[r+1]=e[r+2],e[r+2]=n}}transform(e){let t=e.determinant()<0;return this.positions&&s._TransformVector3Coordinates(this.positions,e),this.normals&&s._TransformVector3Normals(this.normals,e),this.tangents&&s._TransformVector4Normals(this.tangents,e),t&&this.indices&&s._FlipFaces(this.indices),this}splitBasedOnMaterialID(){if(!this.materialInfos||this.materialInfos.length<2)return[this];let e=[];for(let t of this.materialInfos){let i=new s;if(this.positions&&(i.positions=this.positions.slice(t.verticesStart*3,(t.verticesCount+t.verticesStart)*3)),this.normals&&(i.normals=this.normals.slice(t.verticesStart*3,(t.verticesCount+t.verticesStart)*3)),this.tangents&&(i.tangents=this.tangents.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.colors&&(i.colors=this.colors.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.uvs&&(i.uvs=this.uvs.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.uvs2&&(i.uvs2=this.uvs2.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.uvs3&&(i.uvs3=this.uvs3.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.uvs4&&(i.uvs4=this.uvs4.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.uvs5&&(i.uvs5=this.uvs5.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.uvs6&&(i.uvs6=this.uvs6.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.matricesIndices&&(i.matricesIndices=this.matricesIndices.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.matricesIndicesExtra&&(i.matricesIndicesExtra=this.matricesIndicesExtra.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.matricesWeights&&(i.matricesWeights=this.matricesWeights.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.matricesWeightsExtra&&(i.matricesWeightsExtra=this.matricesWeightsExtra.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.indices){i.indices=[];for(let n=t.indexStart;n<t.indexStart+t.indexCount;n++)i.indices.push(this.indices[n]-t.verticesStart)}let r=new au;r.indexStart=0,r.indexCount=i.indices?i.indices.length:0,r.materialIndex=t.materialIndex,r.verticesStart=0,r.verticesCount=(i.positions?i.positions.length:0)/3,i.materialInfos=[r],e.push(i)}return e}merge(e,t=!1,i=!1,r=!1,n=!1){let a=Array.isArray(e)?e.map(o=>({vertexData:o})):[{vertexData:e}];return Fl(this._mergeCoroutine(void 0,a,t,!1,i,r,n))}*_mergeCoroutine(e,t,i=!1,r,n,a=!1,o=!1){this._validate();let l=t.map(d=>d.vertexData),c=this;if(o)for(let d of l)d&&(d._validate(),!this.normals&&d.normals&&(this.normals=new Float32Array(this.positions.length)),!this.tangents&&d.tangents&&(this.tangents=new Float32Array(this.positions.length/3*4)),!this.uvs&&d.uvs&&(this.uvs=new Float32Array(this.positions.length/3*2)),!this.uvs2&&d.uvs2&&(this.uvs2=new Float32Array(this.positions.length/3*2)),!this.uvs3&&d.uvs3&&(this.uvs3=new Float32Array(this.positions.length/3*2)),!this.uvs4&&d.uvs4&&(this.uvs4=new Float32Array(this.positions.length/3*2)),!this.uvs5&&d.uvs5&&(this.uvs5=new Float32Array(this.positions.length/3*2)),!this.uvs6&&d.uvs6&&(this.uvs6=new Float32Array(this.positions.length/3*2)),!this.colors&&d.colors&&(this.colors=new Float32Array(this.positions.length/3*4),this.colors.fill(1)),!this.matricesIndices&&d.matricesIndices&&(this.matricesIndices=new Float32Array(this.positions.length/3*4)),!this.matricesWeights&&d.matricesWeights&&(this.matricesWeights=new Float32Array(this.positions.length/3*4)),!this.matricesIndicesExtra&&d.matricesIndicesExtra&&(this.matricesIndicesExtra=new Float32Array(this.positions.length/3*4)),!this.matricesWeightsExtra&&d.matricesWeightsExtra&&(this.matricesWeightsExtra=new Float32Array(this.positions.length/3*4)));for(let d of l)if(d){if(o)this.normals&&!d.normals&&(d.normals=new Float32Array(d.positions.length)),this.tangents&&!d.tangents&&(d.tangents=new Float32Array(d.positions.length/3*4)),this.uvs&&!d.uvs&&(d.uvs=new Float32Array(d.positions.length/3*2)),this.uvs2&&!d.uvs2&&(d.uvs2=new Float32Array(d.positions.length/3*2)),this.uvs3&&!d.uvs3&&(d.uvs3=new Float32Array(d.positions.length/3*2)),this.uvs4&&!d.uvs4&&(d.uvs4=new Float32Array(d.positions.length/3*2)),this.uvs5&&!d.uvs5&&(d.uvs5=new Float32Array(d.positions.length/3*2)),this.uvs6&&!d.uvs6&&(d.uvs6=new Float32Array(d.positions.length/3*2)),this.colors&&!d.colors&&(d.colors=new Float32Array(d.positions.length/3*4),d.colors.fill(1)),this.matricesIndices&&!d.matricesIndices&&(d.matricesIndices=new Float32Array(d.positions.length/3*4)),this.matricesWeights&&!d.matricesWeights&&(d.matricesWeights=new Float32Array(d.positions.length/3*4)),this.matricesIndicesExtra&&!d.matricesIndicesExtra&&(d.matricesIndicesExtra=new Float32Array(d.positions.length/3*4)),this.matricesWeightsExtra&&!d.matricesWeightsExtra&&(d.matricesWeightsExtra=new Float32Array(d.positions.length/3*4));else if(d._validate(),!this.normals!=!d.normals||!this.tangents!=!d.tangents||!this.uvs!=!d.uvs||!this.uvs2!=!d.uvs2||!this.uvs3!=!d.uvs3||!this.uvs4!=!d.uvs4||!this.uvs5!=!d.uvs5||!this.uvs6!=!d.uvs6||!this.colors!=!d.colors||!this.matricesIndices!=!d.matricesIndices||!this.matricesWeights!=!d.matricesWeights||!this.matricesIndicesExtra!=!d.matricesIndicesExtra||!this.matricesWeightsExtra!=!d.matricesWeightsExtra)throw new Error("Cannot merge vertex data that do not have the same set of attributes")}if(a){let d=0,p=0,m=0,_=[],v=null,T=[];for(let I of this.splitBasedOnMaterialID())T.push({vertexData:I,transform:e});for(let I of t)if(I.vertexData)for(let R of I.vertexData.splitBasedOnMaterialID())T.push({vertexData:R,transform:I.transform});T.sort((I,R)=>{let b=I.vertexData.materialInfos?I.vertexData.materialInfos[0].materialIndex:0,M=R.vertexData.materialInfos?R.vertexData.materialInfos[0].materialIndex:0;return b>M?1:b===M?0:-1});for(let I of T){let R=I.vertexData;if(R.materialInfos?d=R.materialInfos[0].materialIndex:d=0,v&&v.materialIndex===d)v.indexCount+=R.indices.length,v.verticesCount+=R.positions.length/3;else{let b=new au;b.materialIndex=d,b.indexStart=p,b.indexCount=R.indices.length,b.verticesStart=m,b.verticesCount=R.positions.length/3,_.push(b),v=b}p+=R.indices.length,m+=R.positions.length/3}let C=T.splice(0,1)[0];c=C.vertexData,e=C.transform,l=T.map(I=>I.vertexData),t=T,this.materialInfos=_}let f=l.reduce((d,p)=>d+(p.indices?.length??0),c.indices?.length??0),u=n||l.some(d=>d.indices===c.indices)?c.indices?.slice():c.indices;if(f>0){let d=u?.length??0;if(u||(u=new Array(f)),u.length!==f){if(Array.isArray(u))u.length=f;else{let m=i||u instanceof Uint32Array?new Uint32Array(f):new Uint16Array(f);m.set(u),u=m}e&&e.determinant()<0&&s._FlipFaces(u,0,d)}let p=c.positions?c.positions.length/3:0;for(let{vertexData:m,transform:_}of t)if(m.indices){for(let v=0;v<m.indices.length;v++)u[d+v]=m.indices[v]+p;_&&_.determinant()<0&&s._FlipFaces(u,d,m.indices.length),p+=m.positions.length/3,d+=m.indices.length,r&&(yield)}}return this.indices=u,this.positions=s._MergeElement(A.PositionKind,c.positions,e,t.map(d=>[d.vertexData.positions,d.transform])),r&&(yield),c.normals&&(this.normals=s._MergeElement(A.NormalKind,c.normals,e,t.map(d=>[d.vertexData.normals,d.transform])),r&&(yield)),c.tangents&&(this.tangents=s._MergeElement(A.TangentKind,c.tangents,e,t.map(d=>[d.vertexData.tangents,d.transform])),r&&(yield)),c.uvs&&(this.uvs=s._MergeElement(A.UVKind,c.uvs,e,t.map(d=>[d.vertexData.uvs,d.transform])),r&&(yield)),c.uvs2&&(this.uvs2=s._MergeElement(A.UV2Kind,c.uvs2,e,t.map(d=>[d.vertexData.uvs2,d.transform])),r&&(yield)),c.uvs3&&(this.uvs3=s._MergeElement(A.UV3Kind,c.uvs3,e,t.map(d=>[d.vertexData.uvs3,d.transform])),r&&(yield)),c.uvs4&&(this.uvs4=s._MergeElement(A.UV4Kind,c.uvs4,e,t.map(d=>[d.vertexData.uvs4,d.transform])),r&&(yield)),c.uvs5&&(this.uvs5=s._MergeElement(A.UV5Kind,c.uvs5,e,t.map(d=>[d.vertexData.uvs5,d.transform])),r&&(yield)),c.uvs6&&(this.uvs6=s._MergeElement(A.UV6Kind,c.uvs6,e,t.map(d=>[d.vertexData.uvs6,d.transform])),r&&(yield)),c.colors&&(this.colors=s._MergeElement(A.ColorKind,c.colors,e,t.map(d=>[d.vertexData.colors,d.transform])),(c.hasVertexAlpha!==void 0||t.some(d=>d.vertexData.hasVertexAlpha!==void 0))&&(this.hasVertexAlpha=c.hasVertexAlpha||t.some(d=>d.vertexData.hasVertexAlpha)),r&&(yield)),c.matricesIndices&&(this.matricesIndices=s._MergeElement(A.MatricesIndicesKind,c.matricesIndices,e,t.map(d=>[d.vertexData.matricesIndices,d.transform])),r&&(yield)),c.matricesWeights&&(this.matricesWeights=s._MergeElement(A.MatricesWeightsKind,c.matricesWeights,e,t.map(d=>[d.vertexData.matricesWeights,d.transform])),r&&(yield)),c.matricesIndicesExtra&&(this.matricesIndicesExtra=s._MergeElement(A.MatricesIndicesExtraKind,c.matricesIndicesExtra,e,t.map(d=>[d.vertexData.matricesIndicesExtra,d.transform])),r&&(yield)),c.matricesWeightsExtra&&(this.matricesWeightsExtra=s._MergeElement(A.MatricesWeightsExtraKind,c.matricesWeightsExtra,e,t.map(d=>[d.vertexData.matricesWeightsExtra,d.transform]))),this}static _MergeElement(e,t,i,r){let n=r.filter(l=>l[0]!==null&&l[0]!==void 0);if(!t&&n.length==0)return t;if(!t)return this._MergeElement(e,n[0][0],n[0][1],n.slice(1));let a=n.reduce((l,c)=>l+c[0].length,t.length),o=e===A.PositionKind?s._TransformVector3Coordinates:e===A.NormalKind?s._TransformVector3Normals:e===A.TangentKind?s._TransformVector4Normals:()=>{};if(t instanceof Float32Array){let l=new Float32Array(a);l.set(t),i&&o(l,i,0,t.length);let c=t.length;for(let[f,h]of n)l.set(f,c),h&&o(l,h,c,f.length),c+=f.length;return l}else{let l=new Array(a);for(let f=0;f<t.length;f++)l[f]=t[f];i&&o(l,i,0,t.length);let c=t.length;for(let[f,h]of n){for(let u=0;u<f.length;u++)l[c+u]=f[u];h&&o(l,h,c,f.length),c+=f.length}return l}}_validate(){if(!this.positions)throw new Nr("Positions are required",Is.MeshInvalidPositionsError);let e=(r,n)=>{let a=A.DeduceStride(r);if(n.length%a!==0)throw new Error("The "+r+"s array count must be a multiple of "+a);return n.length/a},t=e(A.PositionKind,this.positions),i=(r,n)=>{let a=e(r,n);if(a!==t)throw new Error("The "+r+"s element count ("+a+") does not match the positions count ("+t+")")};this.normals&&i(A.NormalKind,this.normals),this.tangents&&i(A.TangentKind,this.tangents),this.uvs&&i(A.UVKind,this.uvs),this.uvs2&&i(A.UV2Kind,this.uvs2),this.uvs3&&i(A.UV3Kind,this.uvs3),this.uvs4&&i(A.UV4Kind,this.uvs4),this.uvs5&&i(A.UV5Kind,this.uvs5),this.uvs6&&i(A.UV6Kind,this.uvs6),this.colors&&i(A.ColorKind,this.colors),this.matricesIndices&&i(A.MatricesIndicesKind,this.matricesIndices),this.matricesWeights&&i(A.MatricesWeightsKind,this.matricesWeights),this.matricesIndicesExtra&&i(A.MatricesIndicesExtraKind,this.matricesIndicesExtra),this.matricesWeightsExtra&&i(A.MatricesWeightsExtraKind,this.matricesWeightsExtra)}clone(){let e=this.serialize();return s.Parse(e)}serialize(){let e={};if(this.positions&&(e.positions=Array.from(this.positions)),this.normals&&(e.normals=Array.from(this.normals)),this.tangents&&(e.tangents=Array.from(this.tangents)),this.uvs&&(e.uvs=Array.from(this.uvs)),this.uvs2&&(e.uvs2=Array.from(this.uvs2)),this.uvs3&&(e.uvs3=Array.from(this.uvs3)),this.uvs4&&(e.uvs4=Array.from(this.uvs4)),this.uvs5&&(e.uvs5=Array.from(this.uvs5)),this.uvs6&&(e.uvs6=Array.from(this.uvs6)),this.colors&&(e.colors=Array.from(this.colors),e.hasVertexAlpha=this.hasVertexAlpha),this.matricesIndices&&(e.matricesIndices=Array.from(this.matricesIndices),e.matricesIndicesExpanded=!0),this.matricesWeights&&(e.matricesWeights=Array.from(this.matricesWeights)),this.matricesIndicesExtra&&(e.matricesIndicesExtra=Array.from(this.matricesIndicesExtra),e.matricesIndicesExtraExpanded=!0),this.matricesWeightsExtra&&(e.matricesWeightsExtra=Array.from(this.matricesWeightsExtra)),e.indices=this.indices?Array.from(this.indices):[],this.materialInfos){e.materialInfos=[];for(let t of this.materialInfos){let i={indexStart:t.indexStart,indexCount:t.indexCount,materialIndex:t.materialIndex,verticesStart:t.verticesStart,verticesCount:t.verticesCount};e.materialInfos.push(i)}}return e}static ExtractFromMesh(e,t,i){return s._ExtractFrom(e,t,i)}static ExtractFromGeometry(e,t,i){return s._ExtractFrom(e,t,i)}static _ExtractFrom(e,t,i){let r=new s;if(e.isVerticesDataPresent(A.PositionKind)&&(r.positions=e.getVerticesData(A.PositionKind,t,i)),e.isVerticesDataPresent(A.NormalKind)&&(r.normals=e.getVerticesData(A.NormalKind,t,i)),e.isVerticesDataPresent(A.TangentKind)&&(r.tangents=e.getVerticesData(A.TangentKind,t,i)),e.isVerticesDataPresent(A.UVKind)&&(r.uvs=e.getVerticesData(A.UVKind,t,i)),e.isVerticesDataPresent(A.UV2Kind)&&(r.uvs2=e.getVerticesData(A.UV2Kind,t,i)),e.isVerticesDataPresent(A.UV3Kind)&&(r.uvs3=e.getVerticesData(A.UV3Kind,t,i)),e.isVerticesDataPresent(A.UV4Kind)&&(r.uvs4=e.getVerticesData(A.UV4Kind,t,i)),e.isVerticesDataPresent(A.UV5Kind)&&(r.uvs5=e.getVerticesData(A.UV5Kind,t,i)),e.isVerticesDataPresent(A.UV6Kind)&&(r.uvs6=e.getVerticesData(A.UV6Kind,t,i)),e.isVerticesDataPresent(A.ColorKind)){let n=e.geometry||e,a=n.getVertexBuffer(A.ColorKind),o=n.getVerticesData(A.ColorKind,t,i);if(a.getSize()===3){let l=new Float32Array(o.length*4/3);for(let c=0,f=0;c<o.length;c+=3,f+=4)l[f]=o[c],l[f+1]=o[c+1],l[f+2]=o[c+2],l[f+3]=1;r.colors=l}else if(a.getSize()===4)r.colors=o;else throw new Error(`Unexpected number of color components: ${a.getSize()}`)}return e.isVerticesDataPresent(A.MatricesIndicesKind)&&(r.matricesIndices=e.getVerticesData(A.MatricesIndicesKind,t,i)),e.isVerticesDataPresent(A.MatricesWeightsKind)&&(r.matricesWeights=e.getVerticesData(A.MatricesWeightsKind,t,i)),e.isVerticesDataPresent(A.MatricesIndicesExtraKind)&&(r.matricesIndicesExtra=e.getVerticesData(A.MatricesIndicesExtraKind,t,i)),e.isVerticesDataPresent(A.MatricesWeightsExtraKind)&&(r.matricesWeightsExtra=e.getVerticesData(A.MatricesWeightsExtraKind,t,i)),r.indices=e.getIndices(t,i),r}static CreateRibbon(e){throw pe("ribbonBuilder")}static CreateBox(e){throw pe("boxBuilder")}static CreateTiledBox(e){throw pe("tiledBoxBuilder")}static CreateTiledPlane(e){throw pe("tiledPlaneBuilder")}static CreateSphere(e){throw pe("sphereBuilder")}static CreateCylinder(e){throw pe("cylinderBuilder")}static CreateTorus(e){throw pe("torusBuilder")}static CreateLineSystem(e){throw pe("linesBuilder")}static CreateDashedLines(e){throw pe("linesBuilder")}static CreateGround(e){throw pe("groundBuilder")}static CreateTiledGround(e){throw pe("groundBuilder")}static CreateGroundFromHeightMap(e){throw pe("groundBuilder")}static CreatePlane(e){throw pe("planeBuilder")}static CreateDisc(e){throw pe("discBuilder")}static CreatePolygon(e,t,i,r,n,a,o){throw pe("polygonBuilder")}static CreateIcoSphere(e){throw pe("icoSphereBuilder")}static CreatePolyhedron(e){throw pe("polyhedronBuilder")}static CreateCapsule(e={orientation:E.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6}){throw pe("capsuleBuilder")}static CreateTorusKnot(e){throw pe("torusKnotBuilder")}static ComputeNormals(e,t,i,r){let n=0,a=0,o=0,l=0,c=0,f=0,h=0,u=0,d=0,p=0,m=0,_=0,v=0,T=0,C=0,I=0,R=0,b=0,M=0,F=0,U=!1,D=!1,$=!1,oe=!1,re=1,se=0,be=null;r&&(U=!!r.facetNormals,D=!!r.facetPositions,$=!!r.facetPartitioning,re=r.useRightHandedSystem===!0?-1:1,se=r.ratio||0,oe=!!r.depthSort,be=r.distanceTo,oe&&be===void 0&&(be=E.Zero()));let Me=0,ke=0,de=0,Qe=0;for($&&r&&r.bbSize&&(Me=r.subDiv.X*se/r.bbSize.x,ke=r.subDiv.Y*se/r.bbSize.y,de=r.subDiv.Z*se/r.bbSize.z,Qe=r.subDiv.max*r.subDiv.max,r.facetPartitioning.length=0),n=0;n<e.length;n++)i[n]=0;let Re=t.length/3|0;for(n=0;n<Re;n++){if(_=t[n*3]*3,v=_+1,T=_+2,C=t[n*3+1]*3,I=C+1,R=C+2,b=t[n*3+2]*3,M=b+1,F=b+2,a=e[_]-e[C],o=e[v]-e[I],l=e[T]-e[R],c=e[b]-e[C],f=e[M]-e[I],h=e[F]-e[R],u=re*(o*h-l*f),d=re*(l*c-a*h),p=re*(a*f-o*c),m=Math.sqrt(u*u+d*d+p*p),m=m===0?1:m,u/=m,d/=m,p/=m,U&&r&&(r.facetNormals[n].x=u,r.facetNormals[n].y=d,r.facetNormals[n].z=p),D&&r&&(r.facetPositions[n].x=(e[_]+e[C]+e[b])/3,r.facetPositions[n].y=(e[v]+e[I]+e[M])/3,r.facetPositions[n].z=(e[T]+e[R]+e[F])/3),$&&r){let Ae=Math.floor((r.facetPositions[n].x-r.bInfo.minimum.x*se)*Me),ut=Math.floor((r.facetPositions[n].y-r.bInfo.minimum.y*se)*ke),Et=Math.floor((r.facetPositions[n].z-r.bInfo.minimum.z*se)*de),Er=Math.floor((e[_]-r.bInfo.minimum.x*se)*Me),Tr=Math.floor((e[v]-r.bInfo.minimum.y*se)*ke),Le=Math.floor((e[T]-r.bInfo.minimum.z*se)*de),uo=Math.floor((e[C]-r.bInfo.minimum.x*se)*Me),Qt=Math.floor((e[I]-r.bInfo.minimum.y*se)*ke),vn=Math.floor((e[R]-r.bInfo.minimum.z*se)*de),Sn=Math.floor((e[b]-r.bInfo.minimum.x*se)*Me),En=Math.floor((e[M]-r.bInfo.minimum.y*se)*ke),Tn=Math.floor((e[F]-r.bInfo.minimum.z*se)*de),_s=Er+r.subDiv.max*Tr+Qe*Le,gs=uo+r.subDiv.max*Qt+Qe*vn,vs=Sn+r.subDiv.max*En+Qe*Tn,Ss=Ae+r.subDiv.max*ut+Qe*Et;r.facetPartitioning[Ss]=r.facetPartitioning[Ss]?r.facetPartitioning[Ss]:[],r.facetPartitioning[_s]=r.facetPartitioning[_s]?r.facetPartitioning[_s]:[],r.facetPartitioning[gs]=r.facetPartitioning[gs]?r.facetPartitioning[gs]:[],r.facetPartitioning[vs]=r.facetPartitioning[vs]?r.facetPartitioning[vs]:[],r.facetPartitioning[_s].push(n),gs!=_s&&r.facetPartitioning[gs].push(n),vs==gs||vs==_s||r.facetPartitioning[vs].push(n),Ss==_s||Ss==gs||Ss==vs||r.facetPartitioning[Ss].push(n)}if(oe&&r&&r.facetPositions){let Ae=r.depthSortedFacets[n];Ae.ind=n*3,Ae.sqDistance=E.DistanceSquared(r.facetPositions[n],be)}i[_]+=u,i[v]+=d,i[T]+=p,i[C]+=u,i[I]+=d,i[R]+=p,i[b]+=u,i[M]+=d,i[F]+=p}for(n=0;n<i.length/3;n++)u=i[n*3],d=i[n*3+1],p=i[n*3+2],m=Math.sqrt(u*u+d*d+p*p),m=m===0?1:m,u/=m,d/=m,p/=m,i[n*3]=u,i[n*3+1]=d,i[n*3+2]=p}static _ComputeSides(e,t,i,r,n,a,o){let l=i.length,c=r.length,f,h;switch(e=e||s.DEFAULTSIDE,e){case s.FRONTSIDE:break;case s.BACKSIDE:for(f=0;f<l;f+=3){let u=i[f];i[f]=i[f+2],i[f+2]=u}for(h=0;h<c;h++)r[h]=-r[h];break;case s.DOUBLESIDE:{let u=t.length,d=u/3;for(let _=0;_<u;_++)t[u+_]=t[_];for(f=0;f<l;f+=3)i[f+l]=i[f+2]+d,i[f+1+l]=i[f+1]+d,i[f+2+l]=i[f]+d;for(h=0;h<c;h++)r[c+h]=-r[h];let p=n.length,m=0;for(m=0;m<p;m++)n[m+p]=n[m];for(a=a||new Oe(0,0,1,1),o=o||new Oe(0,0,1,1),m=0,f=0;f<p/2;f++)n[m]=a.x+(a.z-a.x)*n[m],n[m+1]=a.y+(a.w-a.y)*n[m+1],n[m+p]=o.x+(o.z-o.x)*n[m+p],n[m+p+1]=o.y+(o.w-o.y)*n[m+p+1],m+=2;break}}}static Parse(e){let t=new s,i=e.positions;i&&t.set(i,A.PositionKind);let r=e.normals;r&&t.set(r,A.NormalKind);let n=e.tangents;n&&t.set(n,A.TangentKind);let a=e.uvs;a&&t.set(a,A.UVKind);let o=e.uvs2;o&&t.set(o,A.UV2Kind);let l=e.uvs3;l&&t.set(l,A.UV3Kind);let c=e.uvs4;c&&t.set(c,A.UV4Kind);let f=e.uvs5;f&&t.set(f,A.UV5Kind);let h=e.uvs6;h&&t.set(h,A.UV6Kind);let u=e.colors;u&&(t.set(me.CheckColors4(u,i.length/3),A.ColorKind),e.hasVertexAlpha!==void 0&&(t.hasVertexAlpha=e.hasVertexAlpha));let d=e.matricesIndices;d&&t.set(d,A.MatricesIndicesKind);let p=e.matricesWeights;p&&t.set(p,A.MatricesWeightsKind);let m=e.indices;m&&(t.indices=m);let _=e.materialInfos;if(_){t.materialInfos=[];for(let v of _){let T=new au;T.indexCount=v.indexCount,T.indexStart=v.indexStart,T.verticesCount=v.verticesCount,T.verticesStart=v.verticesStart,T.materialIndex=v.materialIndex,t.materialInfos.push(T)}}return t}static ImportVertexData(e,t){let i=s.Parse(e);t.setAllVerticesData(i,e.updatable)}};Ge.FRONTSIDE=0;Ge.BACKSIDE=1;Ge.DOUBLESIDE=2;Ge.DEFAULTSIDE=0;Ge._UniqueIdGenerator=0;x([Ts.filter((...[s])=>!Array.isArray(s))],Ge,"_TransformVector3Coordinates",null);x([Ts.filter((...[s])=>!Array.isArray(s))],Ge,"_TransformVector3Normals",null);x([Ts.filter((...[s])=>!Array.isArray(s))],Ge,"_TransformVector4Normals",null);x([Ts.filter((...[s])=>!Array.isArray(s))],Ge,"_FlipFaces",null)});var Ti,s_=S(()=>{Ti=class s{static get ForceFullSceneLoadingForIncremental(){return s._ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(e){s._ForceFullSceneLoadingForIncremental=e}static get ShowLoadingScreen(){return s._ShowLoadingScreen}static set ShowLoadingScreen(e){s._ShowLoadingScreen=e}static get loggingLevel(){return s._LoggingLevel}static set loggingLevel(e){s._LoggingLevel=e}static get CleanBoneMatrixWeights(){return s._CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(e){s._CleanBoneMatrixWeights=e}};Ti._ForceFullSceneLoadingForIncremental=!1;Ti._ShowLoadingScreen=!0;Ti._CleanBoneMatrixWeights=!1;Ti._LoggingLevel=0});var mi,ou=S(()=>{ie();it();ln();yt();Sf();s_();Pl();$e();po();r_();gt();Fc();Nc();mi=class s{get boundingBias(){return this._boundingBias}set boundingBias(e){this._boundingBias?this._boundingBias.copyFrom(e):this._boundingBias=e.clone(),this._updateBoundingInfo(!0,null)}static CreateGeometryForMesh(e){let t=new s(s.RandomId(),e.getScene());return t.applyToMesh(e),t}get meshes(){return this._meshes}constructor(e,t,i,r=!1,n=null){this.delayLoadState=0,this._totalVertices=0,this._isDisposed=!1,this._extend={minimum:new E(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),maximum:new E(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},this._indexBufferIsUpdatable=!1,this._positionsCache=[],this._parentContainer=null,this.useBoundingInfoFromGeometry=!1,this._scene=t||Z.LastCreatedScene,this._scene&&(this.id=e,this.uniqueId=this._scene.getUniqueId(),this._engine=this._scene.getEngine(),this._meshes=[],this._vertexBuffers={},this._indices=[],this._updatable=r,i?this.setAllVerticesData(i,r):this._totalVertices=0,this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObjects={}),n&&(this.applyToMesh(n),n.computeWorldMatrix(!0)))}get extend(){return this._extend}getScene(){return this._scene}getEngine(){return this._engine}isReady(){return this.delayLoadState===1||this.delayLoadState===0}get doNotSerialize(){for(let e=0;e<this._meshes.length;e++)if(!this._meshes[e].doNotSerialize)return!1;return!0}_rebuild(){this._vertexArrayObjects&&(this._vertexArrayObjects={}),this._meshes.length!==0&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable,"Geometry_"+this.id+"_IndexBuffer"));let e=new Set;for(let t in this._vertexBuffers)e.add(this._vertexBuffers[t].getWrapperBuffer());e.forEach(t=>{t._rebuild()})}setAllVerticesData(e,t){e.applyToGeometry(this,t),this._notifyUpdate()}setVerticesData(e,t,i=!1,r){i&&Array.isArray(t)&&(t=new Float32Array(t));let n=new A(this._engine,t,e,{updatable:i,postponeInternalCreation:this._meshes.length===0,stride:r,label:"Geometry_"+this.id+"_"+e});this.setVerticesBuffer(n)}removeVerticesData(e){this._vertexBuffers[e]&&(this._vertexBuffers[e].dispose(),delete this._vertexBuffers[e]),this._vertexArrayObjects&&this._disposeVertexArrayObjects()}setVerticesBuffer(e,t=null,i=!0){let r=e.getKind();this._vertexBuffers[r]&&i&&this._vertexBuffers[r].dispose(),e._buffer&&e._ownsBuffer&&e._buffer._increaseReferences(),this._vertexBuffers[r]=e;let n=this._meshes,a=n.length;if(r===A.PositionKind){this._totalVertices=t??e._maxVerticesCount,this._updateExtend(this.useBoundingInfoFromGeometry&&this._boundingInfo?null:e.getFloatData(this._totalVertices)),this._resetPointsArrayCache();let o=this._extend&&this._extend.minimum||new E(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),l=this._extend&&this._extend.maximum||new E(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);for(let c=0;c<a;c++){let f=n[c];f.buildBoundingInfo(o,l),f._createGlobalSubMesh(f.isUnIndexed),f.computeWorldMatrix(!0),f.synchronizeInstances()}}this._notifyUpdate(r)}updateVerticesDataDirectly(e,t,i,r=!1){let n=this.getVertexBuffer(e);n&&(n.updateDirectly(t,i,r),this._notifyUpdate(e))}updateVerticesData(e,t,i=!1){let r=this.getVertexBuffer(e);r&&(r.update(t),e===A.PositionKind&&this._updateBoundingInfo(i,t),this._notifyUpdate(e))}_updateBoundingInfo(e,t){if(e&&this._updateExtend(t),this._resetPointsArrayCache(),e){let i=this._meshes;for(let r of i){r.hasBoundingInfo?r.getBoundingInfo().reConstruct(this._extend.minimum,this._extend.maximum):r.buildBoundingInfo(this._extend.minimum,this._extend.maximum);let n=r.subMeshes;for(let a of n)a.refreshBoundingInfo()}}}_bind(e,t,i,r){if(!e)return;t===void 0&&(t=this._indexBuffer);let n=this.getVertexBuffers();if(!n)return;if(t!=this._indexBuffer||!this._vertexArrayObjects&&!r){this._engine.bindBuffers(n,t,e,i);return}let a=r||this._vertexArrayObjects,o=this._engine;a[e.key]||(a[e.key]=o.recordVertexArrayObject(n,t,e,i)),o.bindVertexArrayObject(a[e.key],t)}getTotalVertices(){return this.isReady()?this._totalVertices:0}getVerticesData(e,t,i){let r=this.getVertexBuffer(e);return r?r.getFloatData(this._totalVertices,i||t&&this._meshes.length!==1):null}copyVerticesData(e,t){let i=this.getVertexBuffer(e);if(!i)return;t[e]||(t[e]=new Float32Array(this._totalVertices*i.getSize()));let r=i.getData();r&&xO(r,i.getSize(),i.type,i.byteOffset,i.byteStride,i.normalized,this._totalVertices,t[e])}isVertexBufferUpdatable(e){let t=this._vertexBuffers[e];return t?t.isUpdatable():!1}getVertexBuffer(e){return this.isReady()?this._vertexBuffers[e]:null}getVertexBuffers(){return this.isReady()?this._vertexBuffers:null}isVerticesDataPresent(e){return this._vertexBuffers?this._vertexBuffers[e]!==void 0:this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1}getVerticesDataKinds(){let e=[],t;if(!this._vertexBuffers&&this._delayInfo)for(t in this._delayInfo)e.push(t);else for(t in this._vertexBuffers)e.push(t);return e}updateIndices(e,t,i=!1){if(this._indexBuffer)if(!this._indexBufferIsUpdatable)this.setIndices(e,null,!0);else{let r=e.length!==this._indices.length;if(i||(this._indices=e.slice()),this._engine.updateDynamicIndexBuffer(this._indexBuffer,e,t),r)for(let n of this._meshes)n._createGlobalSubMesh(!0)}}setIndexBuffer(e,t,i,r=null){this._indices=[],this._indexBufferIsUpdatable=!1,this._indexBuffer=e,this._totalVertices=t,this._totalIndices=i,r===null?e.is32Bits=t>65535:e.is32Bits=r;for(let n of this._meshes)n._createGlobalSubMesh(!0),n.synchronizeInstances();this._notifyUpdate()}setIndices(e,t=null,i=!1,r=!1){this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indices=e,this._indexBufferIsUpdatable=i,this._meshes.length!==0&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,i,"Geometry_"+this.id+"_IndexBuffer")),t!=null&&(this._totalVertices=t);for(let n of this._meshes)n._createGlobalSubMesh(!r),n.synchronizeInstances();this._notifyUpdate()}getTotalIndices(){return this.isReady()?this._totalIndices!==void 0?this._totalIndices:this._indices.length:0}getIndices(e,t){if(!this.isReady())return null;let i=this._indices;return!t&&(!e||this._meshes.length===1)?i:i.slice()}getIndexBuffer(){return this.isReady()?this._indexBuffer:null}_releaseVertexArrayObject(e=null){!e||!this._vertexArrayObjects||this._vertexArrayObjects[e.key]&&(this._engine.releaseVertexArrayObject(this._vertexArrayObjects[e.key]),delete this._vertexArrayObjects[e.key])}releaseForMesh(e,t){let i=this._meshes,r=i.indexOf(e);r!==-1&&(i.splice(r,1),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject(),e._geometry=null,i.length===0&&t&&this.dispose())}applyToMesh(e){if(e._geometry===this)return;let t=e._geometry;t&&t.releaseForMesh(e),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject();let i=this._meshes;e._geometry=this,e._internalAbstractMeshDataInfo._positions=null,this._scene.pushGeometry(this),i.push(e),this.isReady()?this._applyToMesh(e):this._boundingInfo&&e.setBoundingInfo(this._boundingInfo)}_updateExtend(e=null){if(this.useBoundingInfoFromGeometry&&this._boundingInfo)this._extend={minimum:this._boundingInfo.minimum.clone(),maximum:this._boundingInfo.maximum.clone()};else{if(!e&&(e=this.getVerticesData(A.PositionKind),!e))return;this._extend=i_(e,0,this._totalVertices,this.boundingBias,3)}}_applyToMesh(e){for(let t in this._vertexBuffers){let i=this._vertexBuffers[t];i._buffer.getBuffer()||i.create(),t===A.PositionKind&&(this._extend||this._updateExtend(),e.buildBoundingInfo(this._extend.minimum,this._extend.maximum),e._createGlobalSubMesh(e.isUnIndexed),e._updateBoundingInfo())}!this._indexBuffer&&this._indices&&this._indices.length>0&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable,"Geometry_"+this.id+"_IndexBuffer")),e._syncGeometryWithMorphTargetManager(),e.synchronizeInstances()}_notifyUpdate(e){this.onGeometryUpdated&&this.onGeometryUpdated(this,e),this._vertexArrayObjects&&this._disposeVertexArrayObjects();for(let t of this._meshes)t._markSubMeshesAsAttributesDirty()}load(e,t){if(this.delayLoadState!==2){if(this.isReady()){t&&t();return}this.delayLoadState=2,this._queueLoad(e,t)}}_queueLoad(e,t){this.delayLoadingFile&&(e.addPendingData(this),e._loadFile(this.delayLoadingFile,i=>{if(!this._delayLoadingFunction)return;this._delayLoadingFunction(JSON.parse(i),this),this.delayLoadState=1,this._delayInfo=[],e.removePendingData(this);let r=this._meshes,n=r.length;for(let a=0;a<n;a++)this._applyToMesh(r[a]);t&&t()},void 0,!0))}toLeftHanded(){let e=this.getIndices(!1);if(e!=null&&e.length>0){for(let r=0;r<e.length;r+=3){let n=e[r+0];e[r+0]=e[r+2],e[r+2]=n}this.setIndices(e)}let t=this.getVerticesData(A.PositionKind,!1);if(t!=null&&t.length>0){for(let r=0;r<t.length;r+=3)t[r+2]=-t[r+2];this.setVerticesData(A.PositionKind,t,!1)}let i=this.getVerticesData(A.NormalKind,!1);if(i!=null&&i.length>0){for(let r=0;r<i.length;r+=3)i[r+2]=-i[r+2];this.setVerticesData(A.NormalKind,i,!1)}}_resetPointsArrayCache(){this._positions=null}_generatePointsArray(){if(this._positions)return!0;let e=this.getVerticesData(A.PositionKind);if(!e||e.length===0)return!1;for(let t=this._positionsCache.length*3,i=this._positionsCache.length;t<e.length;t+=3,++i)this._positionsCache[i]=E.FromArray(e,t);for(let t=0,i=0;t<e.length;t+=3,++i)this._positionsCache[i].set(e[0+t],e[1+t],e[2+t]);return this._positionsCache.length=e.length/3,this._positions=this._positionsCache,!0}isDisposed(){return this._isDisposed}_disposeVertexArrayObjects(){if(this._vertexArrayObjects){for(let i in this._vertexArrayObjects)this._engine.releaseVertexArrayObject(this._vertexArrayObjects[i]);this._vertexArrayObjects={};let e=this._meshes,t=e.length;for(let i=0;i<t;i++)e[i]._invalidateInstanceVertexArrayObject()}}dispose(){let e=this._meshes,t=e.length,i;for(i=0;i<t;i++)this.releaseForMesh(e[i]);this._meshes.length=0,this._disposeVertexArrayObjects();for(let r in this._vertexBuffers)this._vertexBuffers[r].dispose();if(this._vertexBuffers={},this._totalVertices=0,this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null,this._indices=[],this.delayLoadState=0,this.delayLoadingFile=null,this._delayLoadingFunction=null,this._delayInfo=[],this._boundingInfo=null,this._scene.removeGeometry(this),this._parentContainer){let r=this._parentContainer.geometries.indexOf(this);r>-1&&this._parentContainer.geometries.splice(r,1),this._parentContainer=null}this._isDisposed=!0}copy(e){let t=new Ge;t.indices=[];let i=this.getIndices();if(i)for(let l=0;l<i.length;l++)t.indices.push(i[l]);let r=!1,n=!1,a;for(a in this._vertexBuffers){let l=this.getVerticesData(a);if(l&&(l instanceof Float32Array?t.set(new Float32Array(l),a):t.set(l.slice(0),a),!n)){let c=this.getVertexBuffer(a);c&&(r=c.isUpdatable(),n=!r)}}let o=new s(e,this._scene,t,r);o.delayLoadState=this.delayLoadState,o.delayLoadingFile=this.delayLoadingFile,o._delayLoadingFunction=this._delayLoadingFunction;for(a in this._delayInfo)o._delayInfo=o._delayInfo||[],o._delayInfo.push(a);return o._boundingInfo=new Ei(this._extend.minimum,this._extend.maximum),o}serialize(){let e={};return e.id=this.id,e.uniqueId=this.uniqueId,e.updatable=this._updatable,st&&st.HasTags(this)&&(e.tags=st.GetTags(this)),e}_toNumberArray(e){return Array.isArray(e)?e:Array.prototype.slice.call(e)}clearCachedData(){this._indices=[],this._resetPointsArrayCache();for(let e in this._vertexBuffers)Object.prototype.hasOwnProperty.call(this._vertexBuffers,e)&&(this._vertexBuffers[e]._buffer._data=null)}serializeVerticeData(){let e=this.serialize();return this.isVerticesDataPresent(A.PositionKind)&&(e.positions=this._toNumberArray(this.getVerticesData(A.PositionKind)),this.isVertexBufferUpdatable(A.PositionKind)&&(e.positionsUpdatable=!0)),this.isVerticesDataPresent(A.NormalKind)&&(e.normals=this._toNumberArray(this.getVerticesData(A.NormalKind)),this.isVertexBufferUpdatable(A.NormalKind)&&(e.normalsUpdatable=!0)),this.isVerticesDataPresent(A.TangentKind)&&(e.tangents=this._toNumberArray(this.getVerticesData(A.TangentKind)),this.isVertexBufferUpdatable(A.TangentKind)&&(e.tangentsUpdatable=!0)),this.isVerticesDataPresent(A.UVKind)&&(e.uvs=this._toNumberArray(this.getVerticesData(A.UVKind)),this.isVertexBufferUpdatable(A.UVKind)&&(e.uvsUpdatable=!0)),this.isVerticesDataPresent(A.UV2Kind)&&(e.uvs2=this._toNumberArray(this.getVerticesData(A.UV2Kind)),this.isVertexBufferUpdatable(A.UV2Kind)&&(e.uvs2Updatable=!0)),this.isVerticesDataPresent(A.UV3Kind)&&(e.uvs3=this._toNumberArray(this.getVerticesData(A.UV3Kind)),this.isVertexBufferUpdatable(A.UV3Kind)&&(e.uvs3Updatable=!0)),this.isVerticesDataPresent(A.UV4Kind)&&(e.uvs4=this._toNumberArray(this.getVerticesData(A.UV4Kind)),this.isVertexBufferUpdatable(A.UV4Kind)&&(e.uvs4Updatable=!0)),this.isVerticesDataPresent(A.UV5Kind)&&(e.uvs5=this._toNumberArray(this.getVerticesData(A.UV5Kind)),this.isVertexBufferUpdatable(A.UV5Kind)&&(e.uvs5Updatable=!0)),this.isVerticesDataPresent(A.UV6Kind)&&(e.uvs6=this._toNumberArray(this.getVerticesData(A.UV6Kind)),this.isVertexBufferUpdatable(A.UV6Kind)&&(e.uvs6Updatable=!0)),this.isVerticesDataPresent(A.ColorKind)&&(e.colors=this._toNumberArray(this.getVerticesData(A.ColorKind)),this.isVertexBufferUpdatable(A.ColorKind)&&(e.colorsUpdatable=!0)),this.isVerticesDataPresent(A.MatricesIndicesKind)&&(e.matricesIndices=this._toNumberArray(this.getVerticesData(A.MatricesIndicesKind)),e.matricesIndicesExpanded=!0,this.isVertexBufferUpdatable(A.MatricesIndicesKind)&&(e.matricesIndicesUpdatable=!0)),this.isVerticesDataPresent(A.MatricesWeightsKind)&&(e.matricesWeights=this._toNumberArray(this.getVerticesData(A.MatricesWeightsKind)),this.isVertexBufferUpdatable(A.MatricesWeightsKind)&&(e.matricesWeightsUpdatable=!0)),e.indices=this._toNumberArray(this.getIndices()),e}static ExtractFromMesh(e,t){let i=e._geometry;return i?i.copy(t):null}static RandomId(){return W.RandomId()}static _GetGeometryByLoadedUniqueId(e,t){for(let i=0;i<t.geometries.length;i++)if(t.geometries[i]._loadedUniqueId===e)return t.geometries[i];return null}static _ImportGeometry(e,t){let i=t.getScene(),r=e.geometryUniqueId,n=e.geometryId;if(r||n){let a=r?this._GetGeometryByLoadedUniqueId(r,i):i.getGeometryById(n);a&&a.applyToMesh(t)}else if(e instanceof ArrayBuffer){let a=t._binaryInfo;if(a.positionsAttrDesc&&a.positionsAttrDesc.count>0){let o=new Float32Array(e,a.positionsAttrDesc.offset,a.positionsAttrDesc.count);t.setVerticesData(A.PositionKind,o,!1)}if(a.normalsAttrDesc&&a.normalsAttrDesc.count>0){let o=new Float32Array(e,a.normalsAttrDesc.offset,a.normalsAttrDesc.count);t.setVerticesData(A.NormalKind,o,!1)}if(a.tangetsAttrDesc&&a.tangetsAttrDesc.count>0){let o=new Float32Array(e,a.tangetsAttrDesc.offset,a.tangetsAttrDesc.count);t.setVerticesData(A.TangentKind,o,!1)}if(a.uvsAttrDesc&&a.uvsAttrDesc.count>0){let o=new Float32Array(e,a.uvsAttrDesc.offset,a.uvsAttrDesc.count);if(Si)for(let l=1;l<o.length;l+=2)o[l]=1-o[l];t.setVerticesData(A.UVKind,o,!1)}if(a.uvs2AttrDesc&&a.uvs2AttrDesc.count>0){let o=new Float32Array(e,a.uvs2AttrDesc.offset,a.uvs2AttrDesc.count);if(Si)for(let l=1;l<o.length;l+=2)o[l]=1-o[l];t.setVerticesData(A.UV2Kind,o,!1)}if(a.uvs3AttrDesc&&a.uvs3AttrDesc.count>0){let o=new Float32Array(e,a.uvs3AttrDesc.offset,a.uvs3AttrDesc.count);if(Si)for(let l=1;l<o.length;l+=2)o[l]=1-o[l];t.setVerticesData(A.UV3Kind,o,!1)}if(a.uvs4AttrDesc&&a.uvs4AttrDesc.count>0){let o=new Float32Array(e,a.uvs4AttrDesc.offset,a.uvs4AttrDesc.count);if(Si)for(let l=1;l<o.length;l+=2)o[l]=1-o[l];t.setVerticesData(A.UV4Kind,o,!1)}if(a.uvs5AttrDesc&&a.uvs5AttrDesc.count>0){let o=new Float32Array(e,a.uvs5AttrDesc.offset,a.uvs5AttrDesc.count);if(Si)for(let l=1;l<o.length;l+=2)o[l]=1-o[l];t.setVerticesData(A.UV5Kind,o,!1)}if(a.uvs6AttrDesc&&a.uvs6AttrDesc.count>0){let o=new Float32Array(e,a.uvs6AttrDesc.offset,a.uvs6AttrDesc.count);if(Si)for(let l=1;l<o.length;l+=2)o[l]=1-o[l];t.setVerticesData(A.UV6Kind,o,!1)}if(a.colorsAttrDesc&&a.colorsAttrDesc.count>0){let o=new Float32Array(e,a.colorsAttrDesc.offset,a.colorsAttrDesc.count);t.setVerticesData(A.ColorKind,o,!1,a.colorsAttrDesc.stride)}if(a.matricesIndicesAttrDesc&&a.matricesIndicesAttrDesc.count>0){let o=new Int32Array(e,a.matricesIndicesAttrDesc.offset,a.matricesIndicesAttrDesc.count),l=[];for(let c=0;c<o.length;c++){let f=o[c];l.push(f&255),l.push((f&65280)>>8),l.push((f&16711680)>>16),l.push(f>>24&255)}t.setVerticesData(A.MatricesIndicesKind,l,!1)}if(a.matricesIndicesExtraAttrDesc&&a.matricesIndicesExtraAttrDesc.count>0){let o=new Int32Array(e,a.matricesIndicesExtraAttrDesc.offset,a.matricesIndicesExtraAttrDesc.count),l=[];for(let c=0;c<o.length;c++){let f=o[c];l.push(f&255),l.push((f&65280)>>8),l.push((f&16711680)>>16),l.push(f>>24&255)}t.setVerticesData(A.MatricesIndicesExtraKind,l,!1)}if(a.matricesWeightsAttrDesc&&a.matricesWeightsAttrDesc.count>0){let o=new Float32Array(e,a.matricesWeightsAttrDesc.offset,a.matricesWeightsAttrDesc.count);t.setVerticesData(A.MatricesWeightsKind,o,!1)}if(a.indicesAttrDesc&&a.indicesAttrDesc.count>0){let o=new Int32Array(e,a.indicesAttrDesc.offset,a.indicesAttrDesc.count);t.setIndices(o,null)}if(a.subMeshesAttrDesc&&a.subMeshesAttrDesc.count>0){let o=new Int32Array(e,a.subMeshesAttrDesc.offset,a.subMeshesAttrDesc.count*5);t.subMeshes=[];for(let l=0;l<a.subMeshesAttrDesc.count;l++){let c=o[l*5+0],f=o[l*5+1],h=o[l*5+2],u=o[l*5+3],d=o[l*5+4];cr.AddToMesh(c,f,h,u,d,t)}}}else if(e.positions&&e.normals&&e.indices){if(t.setVerticesData(A.PositionKind,e.positions,e.positions._updatable||e.positionsUpdatable),t.setVerticesData(A.NormalKind,e.normals,e.normals._updatable||e.normalsUpdatable),e.tangents&&t.setVerticesData(A.TangentKind,e.tangents,e.tangents._updatable||e.tangentsUpdatable),e.uvs&&t.setVerticesData(A.UVKind,e.uvs,e.uvs._updatable||e.uvsUpdatable),e.uvs2&&t.setVerticesData(A.UV2Kind,e.uvs2,e.uvs2._updatable||e.uvs2Updatable),e.uvs3&&t.setVerticesData(A.UV3Kind,e.uvs3,e.uvs3._updatable||e.uvs3Updatable),e.uvs4&&t.setVerticesData(A.UV4Kind,e.uvs4,e.uvs4._updatable||e.uvs4Updatable),e.uvs5&&t.setVerticesData(A.UV5Kind,e.uvs5,e.uvs5._updatable||e.uvs5Updatable),e.uvs6&&t.setVerticesData(A.UV6Kind,e.uvs6,e.uvs6._updatable||e.uvs6Updatable),e.colors&&t.setVerticesData(A.ColorKind,me.CheckColors4(e.colors,e.positions.length/3),e.colors._updatable),e.matricesIndices)if(!e.matricesIndices._isExpanded&&!e.matricesIndicesExpanded){let a=[];for(let o=0;o<e.matricesIndices.length;o++){let l=e.matricesIndices[o];a.push(l&255),a.push((l&65280)>>8),a.push((l&16711680)>>16),a.push(l>>24&255)}t.setVerticesData(A.MatricesIndicesKind,a,e.matricesIndices._updatable||e.matricesIndicesUpdatable)}else delete e.matricesIndices._isExpanded,delete e.matricesIndicesExpanded,t.setVerticesData(A.MatricesIndicesKind,e.matricesIndices,e.matricesIndices._updatable||e.matricesIndicesUpdatable);if(e.matricesIndicesExtra)if(e.matricesIndicesExtraExpanded||e.matricesIndicesExtra._isExpanded)delete e.matricesIndices._isExpanded,delete e.matricesIndicesExtraExpanded,t.setVerticesData(A.MatricesIndicesExtraKind,e.matricesIndicesExtra,e.matricesIndicesExtra._updatable||e.matricesIndicesExtraUpdatable);else{let a=[];for(let o=0;o<e.matricesIndicesExtra.length;o++){let l=e.matricesIndicesExtra[o];a.push(l&255),a.push((l&65280)>>8),a.push((l&16711680)>>16),a.push(l>>24&255)}t.setVerticesData(A.MatricesIndicesExtraKind,a,e.matricesIndicesExtra._updatable||e.matricesIndicesExtraUpdatable)}e.matricesWeights&&(s._CleanMatricesWeights(e,t),t.setVerticesData(A.MatricesWeightsKind,e.matricesWeights,e.matricesWeights._updatable)),e.matricesWeightsExtra&&t.setVerticesData(A.MatricesWeightsExtraKind,e.matricesWeightsExtra,e.matricesWeights._updatable),t.setIndices(e.indices,null)}if(e.subMeshes){t.subMeshes=[];for(let a=0;a<e.subMeshes.length;a++){let o=e.subMeshes[a];cr.AddToMesh(o.materialIndex,o.verticesStart,o.verticesCount,o.indexStart,o.indexCount,t)}}t._shouldGenerateFlatShading&&(t.convertToFlatShadedMesh(),t._shouldGenerateFlatShading=!1),t.computeWorldMatrix(!0),i.onMeshImportedObservable.notifyObservers(t)}static _CleanMatricesWeights(e,t){if(!Ti.CleanBoneMatrixWeights)return;let r=0;if(e.skeletonId>-1){let h=t.getScene().getLastSkeletonById(e.skeletonId);if(!h)return;r=h.bones.length}else return;let n=t.getVerticesData(A.MatricesIndicesKind),a=t.getVerticesData(A.MatricesIndicesExtraKind),o=e.matricesWeights,l=e.matricesWeightsExtra,c=e.numBoneInfluencer,f=o.length;for(let h=0;h<f;h+=4){let u=0,d=-1;for(let p=0;p<4;p++){let m=o[h+p];u+=m,m<.001&&d<0&&(d=p)}if(l)for(let p=0;p<4;p++){let m=l[h+p];u+=m,m<.001&&d<0&&(d=p+4)}if((d<0||d>c-1)&&(d=c-1),u>.001){let p=1/u;for(let m=0;m<4;m++)o[h+m]*=p;if(l)for(let m=0;m<4;m++)l[h+m]*=p}else d>=4?(l[h+d-4]=1-u,a[h+d-4]=r):(o[h+d]=1-u,n[h+d]=r)}t.setVerticesData(A.MatricesIndicesKind,n),e.matricesWeightsExtra&&t.setVerticesData(A.MatricesIndicesExtraKind,a)}static Parse(e,t,i){let r=new s(e.id,t,void 0,e.updatable);return r._loadedUniqueId=e.uniqueId,st&&st.AddTagsTo(r,e.tags),e.delayLoadingFile?(r.delayLoadState=4,r.delayLoadingFile=i+e.delayLoadingFile,r._boundingInfo=new Ei(E.FromArray(e.boundingBoxMinimum),E.FromArray(e.boundingBoxMaximum)),r._delayInfo=[],e.hasUVs&&r._delayInfo.push(A.UVKind),e.hasUVs2&&r._delayInfo.push(A.UV2Kind),e.hasUVs3&&r._delayInfo.push(A.UV3Kind),e.hasUVs4&&r._delayInfo.push(A.UV4Kind),e.hasUVs5&&r._delayInfo.push(A.UV5Kind),e.hasUVs6&&r._delayInfo.push(A.UV6Kind),e.hasColors&&r._delayInfo.push(A.ColorKind),e.hasMatricesIndices&&r._delayInfo.push(A.MatricesIndicesKind),e.hasMatricesWeights&&r._delayInfo.push(A.MatricesWeightsKind),r._delayLoadingFunction=Ge.ImportVertexData):Ge.ImportVertexData(e,r),t.pushGeometry(r,!0),r}}});var dt,lu=S(()=>{Ye();je();ei();we();ie();rs();Te();dt=class s extends _t{get billboardMode(){return this._billboardMode}set billboardMode(e){this._billboardMode!==e&&(this._billboardMode=e,this._cache.useBillboardPosition=(this._billboardMode&s.BILLBOARDMODE_USE_POSITION)!==0)}get infiniteDistance(){return this._infiniteDistance}set infiniteDistance(e){this._infiniteDistance!==e&&(this._infiniteDistance=e)}constructor(e,t=null,i=!0){super(e,t,!1),this._forward=new E(0,0,1),this._up=new E(0,1,0),this._right=new E(1,0,0),this._position=E.Zero(),this._rotation=E.Zero(),this._rotationQuaternion=null,this._scaling=E.One(),this._transformToBoneReferal=null,this._isAbsoluteSynced=!1,this._billboardMode=s.BILLBOARDMODE_NONE,this.scalingDeterminant=1,this._infiniteDistance=!1,this.ignoreNonUniformScaling=!1,this.reIntegrateRotationIntoRotationQuaternion=!1,this._poseMatrix=null,this._localMatrix=B.Zero(),this._usePivotMatrix=!1,this._absolutePosition=E.Zero(),this._absoluteScaling=E.Zero(),this._absoluteRotationQuaternion=K.Identity(),this._pivotMatrix=B.Identity(),this._postMultiplyPivotMatrix=!1,this._isWorldMatrixFrozen=!1,this._indexInSceneTransformNodesArray=-1,this.onAfterWorldMatrixUpdateObservable=new N,this._nonUniformScaling=!1,i&&this.getScene().addTransformNode(this)}getClassName(){return"TransformNode"}get position(){return this._position}set position(e){this._position=e,this._markAsDirtyInternal()}isUsingPivotMatrix(){return this._usePivotMatrix}isUsingPostMultiplyPivotMatrix(){return this._postMultiplyPivotMatrix}get rotation(){return this._rotation}set rotation(e){this._rotation=e,this._rotationQuaternion=null,this._markAsDirtyInternal()}get scaling(){return this._scaling}set scaling(e){this._scaling=e,this._markAsDirtyInternal()}get rotationQuaternion(){return this._rotationQuaternion}set rotationQuaternion(e){this._rotationQuaternion=e,e&&this._rotation.setAll(0),this._markAsDirtyInternal()}_markAsDirtyInternal(){this._isDirty||(this._isDirty=!0,this.customMarkAsDirty&&this.customMarkAsDirty())}get forward(){return E.TransformNormalFromFloatsToRef(0,0,this.getScene().useRightHandedSystem?-1:1,this.getWorldMatrix(),this._forward),this._forward.normalize()}get up(){return E.TransformNormalFromFloatsToRef(0,1,0,this.getWorldMatrix(),this._up),this._up.normalize()}get right(){return E.TransformNormalFromFloatsToRef(this.getScene().useRightHandedSystem?-1:1,0,0,this.getWorldMatrix(),this._right),this._right.normalize()}updatePoseMatrix(e){return this._poseMatrix?(this._poseMatrix.copyFrom(e),this):(this._poseMatrix=e.clone(),this)}getPoseMatrix(){return this._poseMatrix||(this._poseMatrix=B.Identity()),this._poseMatrix}_isSynchronized(){let e=this._cache;return!(this._billboardMode!==e.billboardMode||this._billboardMode!==s.BILLBOARDMODE_NONE||e.pivotMatrixUpdated||this._infiniteDistance||this._position._isDirty||this._scaling._isDirty||this._rotationQuaternion&&this._rotationQuaternion._isDirty||this._rotation._isDirty)}_initCache(){super._initCache();let e=this._cache;e.localMatrixUpdated=!1,e.billboardMode=-1,e.infiniteDistance=!1,e.useBillboardPosition=!1}get absolutePosition(){return this.getAbsolutePosition()}get absoluteScaling(){return this._syncAbsoluteScalingAndRotation(),this._absoluteScaling}get absoluteRotationQuaternion(){return this._syncAbsoluteScalingAndRotation(),this._absoluteRotationQuaternion}setPreTransformMatrix(e){return this.setPivotMatrix(e,!1)}setPivotMatrix(e,t=!0){return this._pivotMatrix.copyFrom(e),this._usePivotMatrix=!this._pivotMatrix.isIdentity(),this._cache.pivotMatrixUpdated=!0,this._postMultiplyPivotMatrix=t,this._postMultiplyPivotMatrix&&(this._pivotMatrixInverse?this._pivotMatrix.invertToRef(this._pivotMatrixInverse):this._pivotMatrixInverse=B.Invert(this._pivotMatrix)),this}getPivotMatrix(){return this._pivotMatrix}instantiateHierarchy(e=null,t,i){let r=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0);r&&i&&i(this,r);for(let n of this.getChildTransformNodes(!0))n.instantiateHierarchy(r,t,i);return r}freezeWorldMatrix(e=null,t=!1){return e?t?(this._rotation.setAll(0),this._rotationQuaternion=this._rotationQuaternion||K.Identity(),e.decompose(this._scaling,this._rotationQuaternion,this._position),this.computeWorldMatrix(!0)):(this._worldMatrix=e,this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._afterComputeWorldMatrix()):(this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0)),this._isDirty=!1,this._isWorldMatrixFrozen=!0,this}unfreezeWorldMatrix(){return this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0),this}get isWorldMatrixFrozen(){return this._isWorldMatrixFrozen}getAbsolutePosition(){return this.computeWorldMatrix(),this._absolutePosition}setAbsolutePosition(e){if(!e)return this;let t,i,r;if(e.x===void 0){if(arguments.length<3)return this;t=arguments[0],i=arguments[1],r=arguments[2]}else t=e.x,i=e.y,r=e.z;if(this.parent){let n=w.Matrix[0];this.parent.getWorldMatrix().invertToRef(n),E.TransformCoordinatesFromFloatsToRef(t,i,r,n,this.position)}else this.position.x=t,this.position.y=i,this.position.z=r;return this._absolutePosition.copyFrom(e),this}setPositionWithLocalVector(e){return this.computeWorldMatrix(),this.position=E.TransformNormal(e,this._localMatrix),this}getPositionExpressedInLocalSpace(){this.computeWorldMatrix();let e=w.Matrix[0];return this._localMatrix.invertToRef(e),E.TransformNormal(this.position,e)}locallyTranslate(e){return this.computeWorldMatrix(!0),this.position=E.TransformCoordinates(e,this._localMatrix),this}lookAt(e,t=0,i=0,r=0,n=0){let a=s._LookAtVectorCache,o=n===0?this.position:this.getAbsolutePosition();if(e.subtractToRef(o,a),this.setDirection(a,t,i,r),n===1&&this.parent)if(this.rotationQuaternion){let l=w.Matrix[0];this.rotationQuaternion.toRotationMatrix(l);let c=w.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(c),c.invert(),l.multiplyToRef(c,l),this.rotationQuaternion.fromRotationMatrix(l)}else{let l=w.Quaternion[0];K.FromEulerVectorToRef(this.rotation,l);let c=w.Matrix[0];l.toRotationMatrix(c);let f=w.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(f),f.invert(),c.multiplyToRef(f,c),l.fromRotationMatrix(c),l.toEulerAnglesToRef(this.rotation)}return this}getDirection(e){let t=E.Zero();return this.getDirectionToRef(e,t),t}getDirectionToRef(e,t){return E.TransformNormalToRef(e,this.getWorldMatrix(),t),this}setDirection(e,t=0,i=0,r=0){let n=-Math.atan2(e.z,e.x)+Math.PI/2,a=Math.sqrt(e.x*e.x+e.z*e.z),o=-Math.atan2(e.y,a);return this.rotationQuaternion?K.RotationYawPitchRollToRef(n+t,o+i,r,this.rotationQuaternion):(this.rotation.x=o+i,this.rotation.y=n+t,this.rotation.z=r),this}setPivotPoint(e,t=0){this.getScene().getRenderId()==0&&this.computeWorldMatrix(!0);let i=this.getWorldMatrix();if(t==1){let r=w.Matrix[0];i.invertToRef(r),e=E.TransformCoordinates(e,r)}return this.setPivotMatrix(B.Translation(-e.x,-e.y,-e.z),!0)}getPivotPoint(){let e=E.Zero();return this.getPivotPointToRef(e),e}getPivotPointToRef(e){return e.x=-this._pivotMatrix.m[12],e.y=-this._pivotMatrix.m[13],e.z=-this._pivotMatrix.m[14],this}getAbsolutePivotPoint(){let e=E.Zero();return this.getAbsolutePivotPointToRef(e),e}getAbsolutePivotPointToRef(e){return this.getPivotPointToRef(e),E.TransformCoordinatesToRef(e,this.getWorldMatrix(),e),this}markAsDirty(e){if(this._isDirty)return this;if(this._children)for(let t of this._children)t.markAsDirty(e);return super.markAsDirty(e)}setParent(e,t=!1,i=!1){if(!e&&!this.parent)return this;let r=w.Quaternion[0],n=w.Vector3[0],a=w.Vector3[1],o=w.Matrix[1];B.IdentityToRef(o);let l=w.Matrix[0];this.computeWorldMatrix(!0);let c=this.rotationQuaternion;return c||(c=s._TmpRotation,K.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,c)),B.ComposeToRef(this.scaling,c,this.position,l),this.parent&&l.multiplyToRef(this.parent.computeWorldMatrix(!0),l),e&&(e.computeWorldMatrix(!0).invertToRef(o),l.multiplyToRef(o,l)),l.decompose(a,r,n,t?this:void 0),this.rotationQuaternion?this.rotationQuaternion.copyFrom(r):r.toEulerAnglesToRef(this.rotation),this.scaling.copyFrom(a),this.position.copyFrom(n),this.parent=e,i&&this.setPivotMatrix(B.Identity()),this}addChild(e,t=!1){return e.setParent(this,t),this}removeChild(e,t=!1){return e.parent!==this?this:(e.setParent(null,t),this)}get nonUniformScaling(){return this._nonUniformScaling}_updateNonUniformScalingState(e){return this._nonUniformScaling===e?!1:(this._nonUniformScaling=e,!0)}attachToBone(e,t){return this._currentParentWhenAttachingToBone=this.parent,this._transformToBoneReferal=t,this.parent=e,e.getSkeleton().prepare(!0),e.getFinalMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this}detachFromBone(e=!1){return this.parent?(this.parent.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this._transformToBoneReferal=null,e?this.parent=this._currentParentWhenAttachingToBone:this.parent=null,this):(e&&(this.parent=this._currentParentWhenAttachingToBone),this)}rotate(e,t,i){e.normalize(),this.rotationQuaternion||(this.rotationQuaternion=this.rotation.toQuaternion(),this.rotation.setAll(0));let r;if(!i||i===0)r=K.RotationAxisToRef(e,t,s._RotationAxisCache),this.rotationQuaternion.multiplyToRef(r,this.rotationQuaternion);else{if(this.parent){let n=this.parent.getWorldMatrix(),a=w.Matrix[0];n.invertToRef(a),e=E.TransformNormal(e,a),n.determinant()<0&&(t*=-1)}r=K.RotationAxisToRef(e,t,s._RotationAxisCache),r.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}return this}rotateAround(e,t,i){t.normalize(),this.rotationQuaternion||(this.rotationQuaternion=K.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z),this.rotation.setAll(0));let r=w.Vector3[0],n=w.Vector3[1],a=w.Vector3[2],o=w.Quaternion[0],l=w.Matrix[0],c=w.Matrix[1],f=w.Matrix[2],h=w.Matrix[3];return e.subtractToRef(this.position,r),B.TranslationToRef(r.x,r.y,r.z,l),B.TranslationToRef(-r.x,-r.y,-r.z,c),B.RotationAxisToRef(t,i,f),c.multiplyToRef(f,h),h.multiplyToRef(l,h),h.decompose(n,o,a),this.position.addInPlace(a),o.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion),this}translate(e,t,i){let r=e.scale(t);if(!i||i===0){let n=this.getPositionExpressedInLocalSpace().add(r);this.setPositionWithLocalVector(n)}else this.setAbsolutePosition(this.getAbsolutePosition().add(r));return this}addRotation(e,t,i){let r;this.rotationQuaternion?r=this.rotationQuaternion:(r=w.Quaternion[1],K.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,r));let n=w.Quaternion[0];return K.RotationYawPitchRollToRef(t,e,i,n),r.multiplyInPlace(n),this.rotationQuaternion||r.toEulerAnglesToRef(this.rotation),this}_getEffectiveParent(){return this.parent}isWorldMatrixCameraDependent(){return this._infiniteDistance&&!this.parent||this._billboardMode!==s.BILLBOARDMODE_NONE}computeWorldMatrix(e=!1,t=null){if(this._isWorldMatrixFrozen&&!this._isDirty)return this._worldMatrix;let i=this.getScene().getRenderId();if(!this._isDirty&&!e&&(this._currentRenderId===i||this.isSynchronized()))return this._currentRenderId=i,this._worldMatrix;t=t||this.getScene().activeCamera,this._updateCache();let r=this._cache;r.pivotMatrixUpdated=!1,r.billboardMode=this.billboardMode,r.infiniteDistance=this.infiniteDistance,r.parent=this._parentNode,this._currentRenderId=i,this._childUpdateId+=1,this._isDirty=!1,this._position._isDirty=!1,this._rotation._isDirty=!1,this._scaling._isDirty=!1;let n=this._getEffectiveParent(),a=s._TmpScaling,o=this._position;if(this._infiniteDistance&&!this.parent&&t){let c=t.getWorldMatrix(),f=new E(c.m[12],c.m[13],c.m[14]);o=s._TmpTranslation,o.copyFromFloats(this._position.x+f.x,this._position.y+f.y,this._position.z+f.z)}a.copyFromFloats(this._scaling.x*this.scalingDeterminant,this._scaling.y*this.scalingDeterminant,this._scaling.z*this.scalingDeterminant);let l;if(this._rotationQuaternion?(this._rotationQuaternion._isDirty=!1,l=this._rotationQuaternion,this.reIntegrateRotationIntoRotationQuaternion&&this.rotation.lengthSquared()&&(this._rotationQuaternion.multiplyInPlace(K.RotationYawPitchRoll(this._rotation.y,this._rotation.x,this._rotation.z)),this._rotation.copyFromFloats(0,0,0))):(l=s._TmpRotation,K.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,l)),this._usePivotMatrix){let c=w.Matrix[1];B.ScalingToRef(a.x,a.y,a.z,c);let f=w.Matrix[0];l.toRotationMatrix(f),this._pivotMatrix.multiplyToRef(c,w.Matrix[4]),w.Matrix[4].multiplyToRef(f,this._localMatrix),this._postMultiplyPivotMatrix&&this._localMatrix.multiplyToRef(this._pivotMatrixInverse,this._localMatrix),this._localMatrix.addTranslationFromFloats(o.x,o.y,o.z)}else B.ComposeToRef(a,l,o,this._localMatrix);if(n&&n.getWorldMatrix){if(e&&n.computeWorldMatrix(e),this.billboardMode){if(this._transformToBoneReferal){let u=this.parent;u.getSkeleton().prepare(),u.getFinalMatrix().multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),w.Matrix[7])}else w.Matrix[7].copyFrom(n.getWorldMatrix());let c=w.Vector3[5],f=w.Vector3[6],h=w.Quaternion[0];w.Matrix[7].decompose(f,h,c),B.ScalingToRef(f.x,f.y,f.z,w.Matrix[7]),w.Matrix[7].setTranslation(c),s.BillboardUseParentOrientation&&(this._position.applyRotationQuaternionToRef(h,c),this._localMatrix.setTranslation(c)),this._localMatrix.multiplyToRef(w.Matrix[7],this._worldMatrix)}else if(this._transformToBoneReferal){let c=this.parent;c.getSkeleton().prepare(),this._localMatrix.multiplyToRef(c.getFinalMatrix(),w.Matrix[6]),w.Matrix[6].multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),this._worldMatrix)}else this._localMatrix.multiplyToRef(n.getWorldMatrix(),this._worldMatrix);this._markSyncedWithParent()}else this._worldMatrix.copyFrom(this._localMatrix);if(t&&this.billboardMode)if(r.useBillboardPosition){let c=w.Vector3[0];this._worldMatrix.getTranslationToRef(c);let f=t.globalPosition;this._worldMatrix.invertToRef(w.Matrix[1]);let h=w.Vector3[1];E.TransformCoordinatesToRef(f,w.Matrix[1],h),h.normalize();let u=-Math.atan2(h.z,h.x)+Math.PI/2,d=Math.sqrt(h.x*h.x+h.z*h.z),p=-Math.atan2(h.y,d);if(K.RotationYawPitchRollToRef(u,p,0,w.Quaternion[0]),(this.billboardMode&s.BILLBOARDMODE_ALL)!==s.BILLBOARDMODE_ALL){let m=w.Vector3[1];w.Quaternion[0].toEulerAnglesToRef(m),(this.billboardMode&s.BILLBOARDMODE_X)!==s.BILLBOARDMODE_X&&(m.x=0),(this.billboardMode&s.BILLBOARDMODE_Y)!==s.BILLBOARDMODE_Y&&(m.y=0),(this.billboardMode&s.BILLBOARDMODE_Z)!==s.BILLBOARDMODE_Z&&(m.z=0),B.RotationYawPitchRollToRef(m.y,m.x,m.z,w.Matrix[0])}else B.FromQuaternionToRef(w.Quaternion[0],w.Matrix[0]);this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(w.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(w.Vector3[0])}else{let c=w.Vector3[0];this._worldMatrix.getTranslationToRef(c),w.Matrix[1].copyFrom(t.getViewMatrix());let f=this.getScene().useRightHandedSystem;if(f&&w.Matrix[1].multiplyToRef(s._TmpRHRestore,w.Matrix[1]),w.Matrix[1].setTranslationFromFloats(0,0,0),w.Matrix[1].invertToRef(w.Matrix[0]),(this.billboardMode&s.BILLBOARDMODE_ALL)!==s.BILLBOARDMODE_ALL){w.Matrix[0].decompose(void 0,w.Quaternion[0],void 0);let h=w.Vector3[1];w.Quaternion[0].toEulerAnglesToRef(h),(this.billboardMode&s.BILLBOARDMODE_X)!==s.BILLBOARDMODE_X&&(h.x=0),(this.billboardMode&s.BILLBOARDMODE_Y)!==s.BILLBOARDMODE_Y&&(h.y=0),(this.billboardMode&s.BILLBOARDMODE_Z)!==s.BILLBOARDMODE_Z&&(h.z=0),f&&(h.y+=Math.PI),B.RotationYawPitchRollToRef(h.y,h.x,h.z,w.Matrix[0])}this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(w.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(w.Vector3[0])}return this.ignoreNonUniformScaling?this._updateNonUniformScalingState(!1):this._scaling.isNonUniformWithinEpsilon(1e-6)?this._updateNonUniformScalingState(!0):n&&n._nonUniformScaling?this._updateNonUniformScalingState(n._nonUniformScaling):this._updateNonUniformScalingState(!1),this._afterComputeWorldMatrix(),this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._isAbsoluteSynced=!1,this.onAfterWorldMatrixUpdateObservable.notifyObservers(this),this._poseMatrix||(this._poseMatrix=B.Invert(this._worldMatrix)),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix}resetLocalMatrix(e=!0){if(this.computeWorldMatrix(),e){let t=this.getChildren();for(let i=0;i<t.length;++i){let r=t[i];if(r){r.computeWorldMatrix();let n=w.Matrix[0];r._localMatrix.multiplyToRef(this._localMatrix,n);let a=w.Quaternion[0];n.decompose(r.scaling,a,r.position),r.rotationQuaternion?r.rotationQuaternion.copyFrom(a):a.toEulerAnglesToRef(r.rotation)}}}this.scaling.copyFromFloats(1,1,1),this.position.copyFromFloats(0,0,0),this.rotation.copyFromFloats(0,0,0),this.rotationQuaternion&&(this.rotationQuaternion=K.Identity()),this._worldMatrix=B.Identity()}_afterComputeWorldMatrix(){}registerAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.add(e),this}unregisterAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.removeCallback(e),this}getPositionInCameraSpace(e=null){return e||(e=this.getScene().activeCamera),E.TransformCoordinates(this.getAbsolutePosition(),e.getViewMatrix())}getDistanceToCamera(e=null){return e||(e=this.getScene().activeCamera),this.getAbsolutePosition().subtract(e.globalPosition).length()}clone(e,t,i){let r=_e.Clone(()=>new s(e,this.getScene()),this);if(r.name=e,r.id=e,t&&(r.parent=t),!i){let n=this.getDescendants(!0);for(let a=0;a<n.length;a++){let o=n[a];o.clone&&o.clone(e+"."+o.name,r)}}return r}serialize(e){let t=_e.Serialize(this,e);return t.type=this.getClassName(),t.uniqueId=this.uniqueId,this.parent&&this.parent._serializeAsParent(t),t.localMatrix=this.getPivotMatrix().asArray(),t.isEnabled=this.isEnabled(),_e.AppendSerializedAnimations(this,t),t.ranges=this.serializeAnimationRanges(),t}static Parse(e,t,i){let r=_e.Parse(()=>new s(e.name,t),e,t,i);if(e.localMatrix?r.setPreTransformMatrix(B.FromArray(e.localMatrix)):e.pivotMatrix&&r.setPivotMatrix(B.FromArray(e.pivotMatrix)),r.setEnabled(e.isEnabled),r._waitingParsedUniqueId=e.uniqueId,e.parentId!==void 0&&(r._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(r._waitingParentInstanceIndex=e.parentInstanceIndex),e.animations){for(let n=0;n<e.animations.length;n++){let a=e.animations[n],o=Ci("BABYLON.Animation");o&&r.animations.push(o.Parse(a))}_t.ParseAnimationRanges(r,e,t)}return e.autoAnimate&&t.beginAnimation(r,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),r}getChildTransformNodes(e,t){let i=[];return this._getDescendants(i,e,r=>(!t||t(r))&&r instanceof s),i}dispose(e,t=!1){if(this.getScene().stopAnimation(this),this.getScene().removeTransformNode(this),this._parentContainer){let i=this._parentContainer.transformNodes.indexOf(this);i>-1&&this._parentContainer.transformNodes.splice(i,1),this._parentContainer=null}if(this.onAfterWorldMatrixUpdateObservable.clear(),e){let i=this.getChildTransformNodes(!0);for(let r of i)r.parent=null,r.computeWorldMatrix(!0)}super.dispose(e,t)}normalizeToUnitCube(e=!0,t=!1,i){let r=null,n=null;t&&(this.rotationQuaternion?(n=this.rotationQuaternion.clone(),this.rotationQuaternion.copyFromFloats(0,0,0,1)):this.rotation&&(r=this.rotation.clone(),this.rotation.copyFromFloats(0,0,0)));let a=this.getHierarchyBoundingVectors(e,i),o=a.max.subtract(a.min),l=Math.max(o.x,o.y,o.z);if(l===0)return this;let c=1/l;return this.scaling.scaleInPlace(c),t&&(this.rotationQuaternion&&n?this.rotationQuaternion.copyFrom(n):this.rotation&&r&&this.rotation.copyFrom(r)),this}_syncAbsoluteScalingAndRotation(){this._isAbsoluteSynced||(this._worldMatrix.decompose(this._absoluteScaling,this._absoluteRotationQuaternion),this._isAbsoluteSynced=!0)}};dt.BILLBOARDMODE_NONE=0;dt.BILLBOARDMODE_X=1;dt.BILLBOARDMODE_Y=2;dt.BILLBOARDMODE_Z=4;dt.BILLBOARDMODE_ALL=7;dt.BILLBOARDMODE_USE_POSITION=128;dt.BillboardUseParentOrientation=!1;dt._TmpRotation=K.Zero();dt._TmpScaling=E.Zero();dt._TmpTranslation=E.Zero();dt._TmpRHRestore=B.Scaling(1,1,-1);dt._LookAtVectorCache=new E(0,0,0);dt._RotationAxisCache=new K;x([oi("position")],dt.prototype,"_position",void 0);x([oi("rotation")],dt.prototype,"_rotation",void 0);x([xD("rotationQuaternion")],dt.prototype,"_rotationQuaternion",void 0);x([oi("scaling")],dt.prototype,"_scaling",void 0);x([y("billboardMode")],dt.prototype,"_billboardMode",void 0);x([y()],dt.prototype,"scalingDeterminant",void 0);x([y("infiniteDistance")],dt.prototype,"_infiniteDistance",void 0);x([y()],dt.prototype,"ignoreNonUniformScaling",void 0);x([y()],dt.prototype,"reIntegrateRotationIntoRotationQuaternion",void 0)});var n_,oB=S(()=>{ie();n_=class{constructor(){this._checkCollisions=!1,this._collisionMask=-1,this._collisionGroup=-1,this._surroundingMeshes=null,this._collider=null,this._oldPositionForCollisions=new E(0,0,0),this._diffPositionForCollisions=new E(0,0,0),this._collisionResponse=!0}}});function lB(s){return Math.floor(s/8)}function cB(s){return 1<<s%8}var a_,fB=S(()=>{a_=class{constructor(e){this.size=e,this._byteArray=new Uint8Array(Math.ceil(this.size/8))}get(e){if(e>=this.size)throw new RangeError("Bit index out of range");let t=lB(e),i=cB(e);return(this._byteArray[t]&i)!==0}set(e,t){if(e>=this.size)throw new RangeError("Bit index out of range");let i=lB(e),r=cB(e);t?this._byteArray[i]|=r:this._byteArray[i]&=~r}}});var hB={};V(hB,{OptimizeIndices:()=>gZ});function gZ(s){let e=[],t=s.length/3;for(let l=0;l<t;l++)e.push([s[l*3],s[l*3+1],s[l*3+2]]);let i=new Map;for(let l=0;l<e.length;l++){let c=e[l];for(let f of c){let h=i.get(f);h||i.set(f,h=[]),h.push(l)}}let r=new a_(t),n=[],a=l=>{let c=[l];for(;c.length>0;){let f=c.pop();if(!r.get(f)){r.set(f,!0),n.push(e[f]);for(let h of e[f]){let u=i.get(h);if(!u)return;for(let d of u)r.get(d)||c.push(d)}}}};for(let l=0;l<t;l++)r.get(l)||a(l);let o=0;for(let l of n)s[o++]=l[0],s[o++]=l[1],s[o++]=l[2]}var uB=S(()=>{fB()});function vZ(s,e,t){let i=null;switch(e){case A.PositionKind:i=r=>r.getPositions();break;case A.NormalKind:i=r=>r.getNormals();break;case A.TangentKind:i=r=>r.getTangents();break;case A.UVKind:i=r=>r.getUVs();break;case A.UV2Kind:i=r=>r.getUV2s();break;case A.ColorKind:i=r=>r.getColors();break;default:return}for(let r=0;r<s.length;r++){let n=s[r];for(let a=0;a<t.numTargets;a++){let o=t.getTarget(a),l=o.influence;if(l!==0){let c=i(o);c&&(n+=(c[r]-s[r])*l)}}s[r]=n}}function SZ(s,e,t,i,r,n,a){let o=w.Vector3[0],l=w.Matrix[0],c=w.Matrix[1],f=e===A.NormalKind?E.TransformNormalFromFloatsToRef:E.TransformCoordinatesFromFloatsToRef;for(let h=0,u=0;h<s.length;h+=3,u+=4){l.reset();let d,p;for(d=0;d<4;d++)p=r[u+d],p>0&&(B.FromFloat32ArrayToRefScaled(t,Math.floor(i[u+d]*16),p,c),l.addToSelf(c));if(n&&a)for(d=0;d<4;d++)p=a[u+d],p>0&&(B.FromFloat32ArrayToRefScaled(t,Math.floor(n[u+d]*16),p,c),l.addToSelf(c));f(s[h],s[h+1],s[h+2],l,o),o.toArray(s,h)}}var aC,oC,Ct,Ef=S(()=>{Ye();we();ie();yt();ln();lu();Yc();Pl();Rl();oB();Ii();r_();it();xr();Ph();Te();je();Jt();aC=class{constructor(){this.facetNb=0,this.partitioningSubdivisions=10,this.partitioningBBoxRatio=1.01,this.facetDataEnabled=!1,this.facetParameters={},this.bbSize=E.Zero(),this.subDiv={max:1,X:1,Y:1,Z:1},this.facetDepthSort=!1,this.facetDepthSortEnabled=!1}},oC=class{constructor(){this._hasVertexAlpha=!1,this._useVertexColors=!0,this._numBoneInfluencers=4,this._applyFog=!0,this._receiveShadows=!1,this._facetData=new aC,this._visibility=1,this._skeleton=null,this._layerMask=268435455,this._computeBonesUsingShaders=!0,this._isActive=!1,this._onlyForInstances=!1,this._isActiveIntermediate=!1,this._onlyForInstancesIntermediate=!1,this._actAsRegularMesh=!1,this._currentLOD=new Map,this._collisionRetryCount=3,this._morphTargetManager=null,this._renderingGroupId=0,this._bakedVertexAnimationManager=null,this._material=null,this._positions=null,this._pointerOverDisableMeshTesting=!1,this._meshCollisionData=new n_,this._enableDistantPicking=!1,this._rawBoundingInfo=null,this._sideOrientationHint=!1,this._inheritVisibility=!1,this._wasActiveLastFrame=!1}},Ct=class s extends dt{static get BILLBOARDMODE_NONE(){return dt.BILLBOARDMODE_NONE}static get BILLBOARDMODE_X(){return dt.BILLBOARDMODE_X}static get BILLBOARDMODE_Y(){return dt.BILLBOARDMODE_Y}static get BILLBOARDMODE_Z(){return dt.BILLBOARDMODE_Z}static get BILLBOARDMODE_ALL(){return dt.BILLBOARDMODE_ALL}static get BILLBOARDMODE_USE_POSITION(){return dt.BILLBOARDMODE_USE_POSITION}get facetNb(){return this._internalAbstractMeshDataInfo._facetData.facetNb}get partitioningSubdivisions(){return this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions}set partitioningSubdivisions(e){this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions=e}get partitioningBBoxRatio(){return this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio}set partitioningBBoxRatio(e){this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio=e}get mustDepthSortFacets(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSort}set mustDepthSortFacets(e){this._internalAbstractMeshDataInfo._facetData.facetDepthSort=e}get facetDepthSortFrom(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom}set facetDepthSortFrom(e){this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom=e}get collisionRetryCount(){return this._internalAbstractMeshDataInfo._collisionRetryCount}set collisionRetryCount(e){this._internalAbstractMeshDataInfo._collisionRetryCount=e}get isFacetDataEnabled(){return this._internalAbstractMeshDataInfo._facetData.facetDataEnabled}get morphTargetManager(){return this._internalAbstractMeshDataInfo._morphTargetManager}set morphTargetManager(e){this._internalAbstractMeshDataInfo._morphTargetManager!==e&&(this._internalAbstractMeshDataInfo._morphTargetManager=e,this._syncGeometryWithMorphTargetManager())}get bakedVertexAnimationManager(){return this._internalAbstractMeshDataInfo._bakedVertexAnimationManager}set bakedVertexAnimationManager(e){this._internalAbstractMeshDataInfo._bakedVertexAnimationManager!==e&&(this._internalAbstractMeshDataInfo._bakedVertexAnimationManager=e,this._markSubMeshesAsAttributesDirty())}_syncGeometryWithMorphTargetManager(){}_updateNonUniformScalingState(e){return super._updateNonUniformScalingState(e)?(this._markSubMeshesAsMiscDirty(),!0):!1}get rawBoundingInfo(){return this._internalAbstractMeshDataInfo._rawBoundingInfo}set rawBoundingInfo(e){this._internalAbstractMeshDataInfo._rawBoundingInfo=e}set onCollide(e){this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver&&this.onCollideObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver=this.onCollideObservable.add(e)}set onCollisionPositionChange(e){this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver&&this.onCollisionPositionChangeObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver=this.onCollisionPositionChangeObservable.add(e)}get visibility(){return this._internalAbstractMeshDataInfo._visibility}set visibility(e){if(this._internalAbstractMeshDataInfo._visibility===e)return;let t=this._internalAbstractMeshDataInfo._visibility;this._internalAbstractMeshDataInfo._visibility=e,(t===1&&e!==1||t!==1&&e===1)&&this._markSubMeshesAsDirty(i=>{i.markAsMiscDirty(),i.markAsPrePassDirty()})}get inheritVisibility(){return this._internalAbstractMeshDataInfo._inheritVisibility}set inheritVisibility(e){this._internalAbstractMeshDataInfo._inheritVisibility=e}get isVisible(){if(!this._isVisible||!this.inheritVisibility||!this._parentNode)return this._isVisible;if(this._isVisible){let e=this._parentNode;for(;e;){let t=e.isVisible;if(typeof t<"u")return t;e=e.parent}}return this._isVisible}set isVisible(e){this._isVisible=e}get pointerOverDisableMeshTesting(){return this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting}set pointerOverDisableMeshTesting(e){this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting=e}get renderingGroupId(){return this._internalAbstractMeshDataInfo._renderingGroupId}set renderingGroupId(e){this._internalAbstractMeshDataInfo._renderingGroupId=e}get material(){return this._internalAbstractMeshDataInfo._material}set material(e){this._setMaterial(e)}_setMaterial(e){this._internalAbstractMeshDataInfo._material!==e&&(this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),this._internalAbstractMeshDataInfo._material=e,e&&e.meshMap&&(e.meshMap[this.uniqueId]=this),this.onMaterialChangedObservable.hasObservers()&&this.onMaterialChangedObservable.notifyObservers(this),this.subMeshes&&(this.resetDrawCache(void 0,e==null),this._unBindEffect()))}getMaterialForRenderPass(e){return this._internalAbstractMeshDataInfo._materialForRenderPass?.[e]}setMaterialForRenderPass(e,t){this.resetDrawCache(e),this._internalAbstractMeshDataInfo._materialForRenderPass||(this._internalAbstractMeshDataInfo._materialForRenderPass=[]);let i=this._internalAbstractMeshDataInfo._materialForRenderPass[e];i?.meshMap?.[this.uniqueId]&&(i.meshMap[this.uniqueId]=void 0),this._internalAbstractMeshDataInfo._materialForRenderPass[e]=t,t&&t.meshMap&&(t.meshMap[this.uniqueId]=this)}get receiveShadows(){return this._internalAbstractMeshDataInfo._receiveShadows}set receiveShadows(e){this._internalAbstractMeshDataInfo._receiveShadows!==e&&(this._internalAbstractMeshDataInfo._receiveShadows=e,this._markSubMeshesAsLightDirty())}get hasVertexAlpha(){return this._internalAbstractMeshDataInfo._hasVertexAlpha}set hasVertexAlpha(e){this._internalAbstractMeshDataInfo._hasVertexAlpha!==e&&(this._internalAbstractMeshDataInfo._hasVertexAlpha=e,this._markSubMeshesAsAttributesDirty(),this._markSubMeshesAsMiscDirty())}get useVertexColors(){return this._internalAbstractMeshDataInfo._useVertexColors}set useVertexColors(e){this._internalAbstractMeshDataInfo._useVertexColors!==e&&(this._internalAbstractMeshDataInfo._useVertexColors=e,this._markSubMeshesAsAttributesDirty())}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}get numBoneInfluencers(){return this._internalAbstractMeshDataInfo._numBoneInfluencers}set numBoneInfluencers(e){this._internalAbstractMeshDataInfo._numBoneInfluencers!==e&&(this._internalAbstractMeshDataInfo._numBoneInfluencers=e,this._markSubMeshesAsAttributesDirty())}get applyFog(){return this._internalAbstractMeshDataInfo._applyFog}set applyFog(e){this._internalAbstractMeshDataInfo._applyFog!==e&&(this._internalAbstractMeshDataInfo._applyFog=e,this._markSubMeshesAsMiscDirty())}get enableDistantPicking(){return this._internalAbstractMeshDataInfo._enableDistantPicking}set enableDistantPicking(e){this._internalAbstractMeshDataInfo._enableDistantPicking=e}get layerMask(){return this._internalAbstractMeshDataInfo._layerMask}set layerMask(e){e!==this._internalAbstractMeshDataInfo._layerMask&&(this._internalAbstractMeshDataInfo._layerMask=e,this._resyncLightSources())}get collisionMask(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask}set collisionMask(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask=isNaN(e)?-1:e}get collisionResponse(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse}set collisionResponse(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse=e}get collisionGroup(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup}set collisionGroup(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup=isNaN(e)?-1:e}get surroundingMeshes(){return this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes}set surroundingMeshes(e){this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes=e}get lightSources(){return this._lightSources}set skeleton(e){let t=this._internalAbstractMeshDataInfo._skeleton;t&&t.needInitialSkinMatrix&&t._unregisterMeshWithPoseMatrix(this),e&&e.needInitialSkinMatrix&&e._registerMeshWithPoseMatrix(this),this._internalAbstractMeshDataInfo._skeleton=e,this._internalAbstractMeshDataInfo._skeleton||(this._bonesTransformMatrices=null),this._markSubMeshesAsAttributesDirty()}get skeleton(){return this._internalAbstractMeshDataInfo._skeleton}constructor(e,t=null){switch(super(e,t,!1),this._internalAbstractMeshDataInfo=new oC,this._waitingMaterialId=null,this._waitingMorphTargetManagerId=null,this.cullingStrategy=s.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,this.onCollideObservable=new N,this.onCollisionPositionChangeObservable=new N,this.onMaterialChangedObservable=new N,this.definedFacingForward=!0,this._occlusionQuery=null,this._renderingGroup=null,this.alphaIndex=Number.MAX_VALUE,this._isVisible=!0,this.isPickable=!0,this.isNearPickable=!1,this.isNearGrabbable=!1,this.showSubMeshesBoundingBox=!1,this.isBlocker=!1,this.enablePointerMoveEvents=!1,this.outlineColor=j.Red(),this.outlineWidth=.02,this.overlayColor=j.Red(),this.overlayAlpha=.5,this.useOctreeForRenderingSelection=!0,this.useOctreeForPicking=!0,this.useOctreeForCollisions=!0,this.alwaysSelectAsActiveMesh=!1,this.doNotSyncBoundingInfo=!1,this.actionManager=null,this.ellipsoid=new E(.5,1,.5),this.ellipsoidOffset=new E(0,0,0),this.edgesWidth=1,this.edgesColor=new me(1,0,0,1),this._edgesRenderer=null,this._masterMesh=null,this._boundingInfo=null,this._boundingInfoIsDirty=!0,this._renderId=0,this._intersectionsInProgress=new Array,this._unIndexed=!1,this._lightSources=new Array,this._waitingData={lods:null,actions:null,freezeWorldMatrix:null},this._bonesTransformMatrices=null,this._transformMatrixTexture=null,this.onRebuildObservable=new N,this._onCollisionPositionChange=(i,r,n=null)=>{r.subtractToRef(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions.length()>k.CollisionsEpsilon&&this.position.addInPlace(this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),n&&this.onCollideObservable.notifyObservers(n),this.onCollisionPositionChangeObservable.notifyObservers(this.position)},t=this.getScene(),t.addMesh(this),this._resyncLightSources(),this._uniformBuffer=new ii(this.getScene().getEngine(),void 0,void 0,e,!this.getScene().getEngine().isWebGPU),this._buildUniformLayout(),t.performancePriority){case 2:this.doNotSyncBoundingInfo=!0;case 1:this.alwaysSelectAsActiveMesh=!0,this.isPickable=!1;break}}_buildUniformLayout(){this._uniformBuffer.addUniform("world",16),this._uniformBuffer.addUniform("visibility",1),this._uniformBuffer.create()}transferToEffect(e){let t=this._uniformBuffer;t.updateMatrix("world",e),t.updateFloat("visibility",this._internalAbstractMeshDataInfo._visibility),t.update()}getMeshUniformBuffer(){return this._uniformBuffer}getClassName(){return"AbstractMesh"}toString(e){let t="Name: "+this.name+", isInstance: "+(this.getClassName()==="InstancedMesh"?"YES":"NO");t+=", # of submeshes: "+(this.subMeshes?this.subMeshes.length:0);let i=this._internalAbstractMeshDataInfo._skeleton;return i&&(t+=", skeleton: "+i.name),e&&(t+=", billboard mode: "+["NONE","X","Y",null,"Z",null,null,"ALL"][this.billboardMode],t+=", freeze wrld mat: "+(this._isWorldMatrixFrozen||this._waitingData.freezeWorldMatrix?"YES":"NO")),t}_getEffectiveParent(){return this._masterMesh&&this.billboardMode!==dt.BILLBOARDMODE_NONE?this._masterMesh:super._getEffectiveParent()}_getActionManagerForTrigger(e,t=!0){if(this.actionManager&&(t||this.actionManager.isRecursive))if(e){if(this.actionManager.hasSpecificTrigger(e))return this.actionManager}else return this.actionManager;return this.parent?this.parent._getActionManagerForTrigger(e,!1):null}_rebuild(e=!1){if(this.onRebuildObservable.notifyObservers(this),this._occlusionQuery!==null&&(this._occlusionQuery=null),!!this.subMeshes){for(let t of this.subMeshes)t._rebuild();this.resetDrawCache()}}_resyncLightSources(){this._lightSources.length=0;for(let e of this.getScene().lights)e.isEnabled()&&e.canAffectMesh(this)&&this._lightSources.push(e);this._markSubMeshesAsLightDirty()}_resyncLightSource(e){let t=e.isEnabled()&&e.canAffectMesh(this),i=this._lightSources.indexOf(e),r=!1;if(i===-1){if(!t)return;this._lightSources.push(e)}else{if(t)return;r=!0,this._lightSources.splice(i,1)}this._markSubMeshesAsLightDirty(r)}_unBindEffect(){for(let e of this.subMeshes)e.setEffect(null)}_removeLightSource(e,t){let i=this._lightSources.indexOf(e);i!==-1&&(this._lightSources.splice(i,1),this._markSubMeshesAsLightDirty(t))}_markSubMeshesAsDirty(e){if(this.subMeshes)for(let t of this.subMeshes)for(let i=0;i<t._drawWrappers.length;++i){let r=t._drawWrappers[i];!r||!r.defines||!r.defines.markAllAsDirty||e(r.defines)}}_markSubMeshesAsLightDirty(e=!1){this._markSubMeshesAsDirty(t=>t.markAsLightDirty(e))}_markSubMeshesAsAttributesDirty(){this._markSubMeshesAsDirty(e=>e.markAsAttributesDirty())}_markSubMeshesAsMiscDirty(){this._markSubMeshesAsDirty(e=>e.markAsMiscDirty())}markAsDirty(e){return this._currentRenderId=Number.MAX_VALUE,super.markAsDirty(e),this._isDirty=!0,this}resetDrawCache(e,t=!1){if(this.subMeshes)for(let i of this.subMeshes)i.resetDrawCache(e,t)}get isBlocked(){return!1}getLOD(e){return this}getTotalVertices(){return 0}getTotalIndices(){return 0}getIndices(){return null}getVerticesData(e){return null}setVerticesData(e,t,i,r){return this}updateVerticesData(e,t,i,r){return this}setIndices(e,t){return this}isVerticesDataPresent(e){return!1}getBoundingInfo(){return this._masterMesh?this._masterMesh.getBoundingInfo():(this._boundingInfoIsDirty&&(this._boundingInfoIsDirty=!1,this._updateBoundingInfo()),this._boundingInfo)}getRawBoundingInfo(){return this.rawBoundingInfo??this.getBoundingInfo()}setBoundingInfo(e){return this._boundingInfo=e,this}get hasBoundingInfo(){return this._boundingInfo!==null}buildBoundingInfo(e,t,i){return this._boundingInfo=new Ei(e,t,i),this._boundingInfo}normalizeToUnitCube(e=!0,t=!1,i){return super.normalizeToUnitCube(e,t,i)}get useBones(){return this.skeleton&&this.getScene().skeletonsEnabled&&this.isVerticesDataPresent(A.MatricesIndicesKind)&&this.isVerticesDataPresent(A.MatricesWeightsKind)}_preActivate(){}_preActivateForIntermediateRendering(e){}_activate(e,t){return this._renderId=e,!0}_postActivate(){}_freeze(){}_unFreeze(){}getWorldMatrix(){return this._masterMesh&&this.billboardMode===dt.BILLBOARDMODE_NONE?this._masterMesh.getWorldMatrix():super.getWorldMatrix()}_getWorldMatrixDeterminant(){return this._masterMesh?this._masterMesh._getWorldMatrixDeterminant():super._getWorldMatrixDeterminant()}get isAnInstance(){return!1}get hasInstances(){return!1}get hasThinInstances(){return!1}movePOV(e,t,i){return this.position.addInPlace(this.calcMovePOV(e,t,i)),this}calcMovePOV(e,t,i){let r=new B;(this.rotationQuaternion?this.rotationQuaternion:K.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z)).toRotationMatrix(r);let a=E.Zero(),o=this.definedFacingForward?-1:1;return E.TransformCoordinatesFromFloatsToRef(e*o,t,i*o,r,a),a}rotatePOV(e,t,i){return this.rotation.addInPlace(this.calcRotatePOV(e,t,i)),this}calcRotatePOV(e,t,i){let r=this.definedFacingForward?1:-1;return new E(e*r,t,i*r)}_refreshBoundingInfo(e,t){if(e){let i=i_(e,0,this.getTotalVertices(),t);this._boundingInfo?this._boundingInfo.reConstruct(i.minimum,i.maximum):this._boundingInfo=new Ei(i.minimum,i.maximum)}if(this.subMeshes)for(let i=0;i<this.subMeshes.length;i++)this.subMeshes[i].refreshBoundingInfo(e);this._updateBoundingInfo()}_refreshBoundingInfoDirect(e){if(this._boundingInfo?this._boundingInfo.reConstruct(e.minimum,e.maximum):this._boundingInfo=new Ei(e.minimum,e.maximum),this.subMeshes)for(let t=0;t<this.subMeshes.length;t++)this.subMeshes[t].refreshBoundingInfo(null);this._updateBoundingInfo()}static _ApplySkeleton(e,t,i,r,n,a,o){SZ(e,t,i,r,n,a,o)}_getData(e,t,i=A.PositionKind){let r=e.cache,n=a=>{if(r){let o=r._vertexData||(r._vertexData={});return o[a]||this.copyVerticesData(a,o),o[a]}return this.getVerticesData(a)};if(t||(t=n(i)),!t)return null;if(r?(r._outputData?r._outputData.set(t):r._outputData=new Float32Array(t),t=r._outputData):(e.applyMorph&&this.morphTargetManager||e.applySkeleton&&this.skeleton)&&(t=t.slice()),e.applyMorph&&this.morphTargetManager&&vZ(t,i,this.morphTargetManager),e.applySkeleton&&this.skeleton){let a=n(A.MatricesIndicesKind),o=n(A.MatricesWeightsKind);if(o&&a){let l=this.numBoneInfluencers>4,c=l?n(A.MatricesIndicesExtraKind):null,f=l?n(A.MatricesWeightsExtraKind):null,h=this.skeleton.getTransformMatrices(this);s._ApplySkeleton(t,i,h,a,o,c,f)}}if(e.updatePositionsArray!==!1&&i===A.PositionKind){let a=this._internalAbstractMeshDataInfo._positions||[],o=a.length;if(a.length=t.length/3,o<a.length)for(let l=o;l<a.length;l++)a[l]=new E;for(let l=0,c=0;l<a.length;l++,c+=3)a[l].copyFromFloats(t[c],t[c+1],t[c+2]);this._internalAbstractMeshDataInfo._positions=a}return t}getNormalsData(e=!1,t=!1){return this._getData({applySkeleton:e,applyMorph:t,updatePositionsArray:!1},null,A.NormalKind)}getPositionData(e=!1,t=!1,i=null){return this._getData({applySkeleton:e,applyMorph:t,updatePositionsArray:!1},i,A.PositionKind)}_updateBoundingInfo(){return this._boundingInfo?this._boundingInfo.update(this.worldMatrixFromCache):this._boundingInfo=new Ei(E.Zero(),E.Zero(),this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}_updateSubMeshesBoundingInfo(e){if(!this.subMeshes)return this;let t=this.subMeshes.length;for(let i=0;i<t;i++){let r=this.subMeshes[i];(t>1||!r.IsGlobal)&&r.updateBoundingInfo(e)}return this}_afterComputeWorldMatrix(){this.doNotSyncBoundingInfo||(this._boundingInfoIsDirty=!0)}isInFrustum(e){return this.getBoundingInfo().isInFrustum(e,this.cullingStrategy)}isCompletelyInFrustum(e){return this.getBoundingInfo().isCompletelyInFrustum(e)}intersectsMesh(e,t=!1,i){let r=this.getBoundingInfo(),n=e.getBoundingInfo();if(r.intersects(n,t))return!0;if(i){for(let a of this.getChildMeshes())if(a.intersectsMesh(e,t,!0))return!0}return!1}intersectsPoint(e){return this.getBoundingInfo().intersectsPoint(e)}get checkCollisions(){return this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions}set checkCollisions(e){this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions=e}get collider(){return this._internalAbstractMeshDataInfo._meshCollisionData._collider}moveWithCollisions(e,t=!0){this.getAbsolutePosition().addToRef(this.ellipsoidOffset,this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions);let r=this.getScene().collisionCoordinator;return this._internalAbstractMeshDataInfo._meshCollisionData._collider||(this._internalAbstractMeshDataInfo._meshCollisionData._collider=r.createCollider()),this._internalAbstractMeshDataInfo._meshCollisionData._collider._radius=this.ellipsoid,r.getNewPosition(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,e,this._internalAbstractMeshDataInfo._meshCollisionData._collider,this.collisionRetryCount,this,this._onCollisionPositionChange,this.uniqueId,t),this}_collideForSubMesh(e,t,i){if(this._generatePointsArray(),!this._positions)return this;if(!e._lastColliderWorldVertices||!e._lastColliderTransformMatrix.equals(t)){e._lastColliderTransformMatrix=t.clone(),e._lastColliderWorldVertices=[],e._trianglePlanes=[];let r=e.verticesStart,n=e.verticesStart+e.verticesCount;for(let a=r;a<n;a++)e._lastColliderWorldVertices.push(E.TransformCoordinates(this._positions[a],t))}return i._collide(e._trianglePlanes,e._lastColliderWorldVertices,this.getIndices(),e.indexStart,e.indexStart+e.indexCount,e.verticesStart,!!e.getMaterial(),this,this._shouldConvertRHS(),e.getMaterial()?.fillMode===7),this}_processCollisionsForSubMeshes(e,t){let i=this._scene.getCollidingSubMeshCandidates(this,e),r=i.length;for(let n=0;n<r;n++){let a=i.data[n];r>1&&!a._checkCollision(e)||this._collideForSubMesh(a,t,e)}return this}_shouldConvertRHS(){return!1}_checkCollision(e){if(!this.getBoundingInfo()._checkCollision(e))return this;let t=w.Matrix[0],i=w.Matrix[1];return B.ScalingToRef(1/e._radius.x,1/e._radius.y,1/e._radius.z,t),this.worldMatrixFromCache.multiplyToRef(t,i),this._processCollisionsForSubMeshes(e,i),this}_generatePointsArray(){return!1}intersects(e,t,i,r=!1,n,a=!1){let o=new Zi,l=this.getClassName(),c=l==="InstancedLinesMesh"||l==="LinesMesh"||l==="GreasedLineMesh"?this.intersectionThreshold:0,f=this.getBoundingInfo();if(!this.subMeshes||!a&&(!e.intersectsSphere(f.boundingSphere,c)||!e.intersectsBox(f.boundingBox,c)))return o;if(r)return o.hit=!a,o.pickedMesh=a?null:this,o.distance=a?0:E.Distance(e.origin,f.boundingSphere.center),o.subMeshId=0,o;if(!this._generatePointsArray())return o;let h=null,u=this._scene.getIntersectingSubMeshCandidates(this,e),d=u.length,p=!1;for(let m=0;m<d;m++){let v=u.data[m].getMaterial();if(v&&(v.fillMode==7||v.fillMode==0||v.fillMode==1||v.fillMode==2||v.fillMode==4)){p=!0;break}}if(!p)return o.hit=!0,o.pickedMesh=this,o.distance=E.Distance(e.origin,f.boundingSphere.center),o.subMeshId=-1,o;for(let m=0;m<d;m++){let _=u.data[m];if(d>1&&!a&&!_.canIntersects(e))continue;let v=_.intersects(e,this._positions,this.getIndices(),t,i);if(v&&(t||!h||v.distance<h.distance)&&(h=v,h.subMeshId=_._id,h._internalSubMeshId=m,t))break}if(h){let m=n??this.getWorldMatrix(),_=w.Vector3[0],v=w.Vector3[1];E.TransformCoordinatesToRef(e.origin,m,_),e.direction.scaleToRef(h.distance,v);let C=E.TransformNormal(v,m).addInPlace(_);return o.hit=!0,o.distance=E.Distance(_,C),o.pickedPoint=C,o.pickedMesh=this,o.bu=h.bu||0,o.bv=h.bv||0,o.subMeshFaceId=h.faceId,o.faceId=h.faceId+u.data[h._internalSubMeshId].indexStart/(this.getClassName().indexOf("LinesMesh")!==-1?2:3),o.subMeshId=h.subMeshId,o}return o}clone(e,t,i){return null}releaseSubMeshes(e=!1){if(this.subMeshes)for(;this.subMeshes.length;)this.subMeshes[0].dispose(e);else this.subMeshes=[];return this}dispose(e,t=!1){let i,r=this.getScene();for(this._scene.useMaterialMeshMap&&this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),r.freeActiveMeshes(),r.freeRenderingGroups(),r.renderingManager.maintainStateBetweenFrames&&r.renderingManager.restoreDispachedFlags(),this.actionManager!==void 0&&this.actionManager!==null&&(this.actionManager.disposeWhenUnowned&&!this._scene.meshes.some(o=>o!==this&&o.actionManager===this.actionManager)&&this.actionManager.dispose(),this.actionManager=null),this._internalAbstractMeshDataInfo._skeleton=null,this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null),i=0;i<this._intersectionsInProgress.length;i++){let o=this._intersectionsInProgress[i],l=o._intersectionsInProgress.indexOf(this);o._intersectionsInProgress.splice(l,1)}this._intersectionsInProgress.length=0;let n=r.lights;for(let o of n){let l=o.includedOnlyMeshes.indexOf(this);l!==-1&&o.includedOnlyMeshes.splice(l,1),l=o.excludedMeshes.indexOf(this),l!==-1&&o.excludedMeshes.splice(l,1);let c=o.getShadowGenerators();if(c){let f=c.values();for(let h=f.next();h.done!==!0;h=f.next()){let d=h.value.getShadowMap();d&&d.renderList&&(l=d.renderList.indexOf(this),l!==-1&&d.renderList.splice(l,1))}}}(this.getClassName()!=="InstancedMesh"||this.getClassName()!=="InstancedLinesMesh")&&this.releaseSubMeshes(!0);let a=r.getEngine();if(this._occlusionQuery!==null&&(this.isOcclusionQueryInProgress=!1,a.deleteQuery(this._occlusionQuery),this._occlusionQuery=null),a.wipeCaches(),r.removeMesh(this),this._parentContainer){let o=this._parentContainer.meshes.indexOf(this);o>-1&&this._parentContainer.meshes.splice(o,1),this._parentContainer=null}if(t&&this.material&&(this.material.getClassName()==="MultiMaterial"?this.material.dispose(!1,!0,!0):this.material.dispose(!1,!0)),!e)for(i=0;i<r.particleSystems.length;i++)r.particleSystems[i].emitter===this&&(r.particleSystems[i].dispose(),i--);this._internalAbstractMeshDataInfo._facetData.facetDataEnabled&&this.disableFacetData(),this._uniformBuffer.dispose(),this.onAfterWorldMatrixUpdateObservable.clear(),this.onCollideObservable.clear(),this.onCollisionPositionChangeObservable.clear(),this.onRebuildObservable.clear(),super.dispose(e,t)}_initFacetData(){let e=this._internalAbstractMeshDataInfo._facetData;e.facetNormals||(e.facetNormals=[]),e.facetPositions||(e.facetPositions=[]),e.facetPartitioning||(e.facetPartitioning=new Array),e.facetNb=this.getIndices().length/3|0,e.partitioningSubdivisions=e.partitioningSubdivisions?e.partitioningSubdivisions:10,e.partitioningBBoxRatio=e.partitioningBBoxRatio?e.partitioningBBoxRatio:1.01;for(let t=0;t<e.facetNb;t++)e.facetNormals[t]=E.Zero(),e.facetPositions[t]=E.Zero();return e.facetDataEnabled=!0,this}updateFacetData(){let e=this._internalAbstractMeshDataInfo._facetData;e.facetDataEnabled||this._initFacetData();let t=this.getVerticesData(A.PositionKind),i=this.getIndices(),r=this.getVerticesData(A.NormalKind),n=this.getBoundingInfo();if(e.facetDepthSort&&!e.facetDepthSortEnabled){if(e.facetDepthSortEnabled=!0,i instanceof Uint16Array)e.depthSortedIndices=new Uint16Array(i);else if(i instanceof Uint32Array)e.depthSortedIndices=new Uint32Array(i);else{let o=!1;for(let l=0;l<i.length;l++)if(i[l]>65535){o=!0;break}o?e.depthSortedIndices=new Uint32Array(i):e.depthSortedIndices=new Uint16Array(i)}if(e.facetDepthSortFunction=function(o,l){return l.sqDistance-o.sqDistance},!e.facetDepthSortFrom){let o=this.getScene().activeCamera;e.facetDepthSortFrom=o?o.position:E.Zero()}e.depthSortedFacets=[];for(let o=0;o<e.facetNb;o++){let l={ind:o*3,sqDistance:0};e.depthSortedFacets.push(l)}e.invertedMatrix=B.Identity(),e.facetDepthSortOrigin=E.Zero()}e.bbSize.x=n.maximum.x-n.minimum.x>We?n.maximum.x-n.minimum.x:We,e.bbSize.y=n.maximum.y-n.minimum.y>We?n.maximum.y-n.minimum.y:We,e.bbSize.z=n.maximum.z-n.minimum.z>We?n.maximum.z-n.minimum.z:We;let a=e.bbSize.x>e.bbSize.y?e.bbSize.x:e.bbSize.y;if(a=a>e.bbSize.z?a:e.bbSize.z,e.subDiv.max=e.partitioningSubdivisions,e.subDiv.X=Math.floor(e.subDiv.max*e.bbSize.x/a),e.subDiv.Y=Math.floor(e.subDiv.max*e.bbSize.y/a),e.subDiv.Z=Math.floor(e.subDiv.max*e.bbSize.z/a),e.subDiv.X=e.subDiv.X<1?1:e.subDiv.X,e.subDiv.Y=e.subDiv.Y<1?1:e.subDiv.Y,e.subDiv.Z=e.subDiv.Z<1?1:e.subDiv.Z,e.facetParameters.facetNormals=this.getFacetLocalNormals(),e.facetParameters.facetPositions=this.getFacetLocalPositions(),e.facetParameters.facetPartitioning=this.getFacetLocalPartitioning(),e.facetParameters.bInfo=n,e.facetParameters.bbSize=e.bbSize,e.facetParameters.subDiv=e.subDiv,e.facetParameters.ratio=this.partitioningBBoxRatio,e.facetParameters.depthSort=e.facetDepthSort,e.facetDepthSort&&e.facetDepthSortEnabled&&(this.computeWorldMatrix(!0),this._worldMatrix.invertToRef(e.invertedMatrix),E.TransformCoordinatesToRef(e.facetDepthSortFrom,e.invertedMatrix,e.facetDepthSortOrigin),e.facetParameters.distanceTo=e.facetDepthSortOrigin),e.facetParameters.depthSortedFacets=e.depthSortedFacets,r&&Ge.ComputeNormals(t,i,r,e.facetParameters),e.facetDepthSort&&e.facetDepthSortEnabled){e.depthSortedFacets.sort(e.facetDepthSortFunction);let o=e.depthSortedIndices.length/3|0;for(let l=0;l<o;l++){let c=e.depthSortedFacets[l].ind;e.depthSortedIndices[l*3]=i[c],e.depthSortedIndices[l*3+1]=i[c+1],e.depthSortedIndices[l*3+2]=i[c+2]}this.updateIndices(e.depthSortedIndices,void 0,!0)}return this}getFacetLocalNormals(){let e=this._internalAbstractMeshDataInfo._facetData;return e.facetNormals||this.updateFacetData(),e.facetNormals}getFacetLocalPositions(){let e=this._internalAbstractMeshDataInfo._facetData;return e.facetPositions||this.updateFacetData(),e.facetPositions}getFacetLocalPartitioning(){let e=this._internalAbstractMeshDataInfo._facetData;return e.facetPartitioning||this.updateFacetData(),e.facetPartitioning}getFacetPosition(e){let t=E.Zero();return this.getFacetPositionToRef(e,t),t}getFacetPositionToRef(e,t){let i=this.getFacetLocalPositions()[e],r=this.getWorldMatrix();return E.TransformCoordinatesToRef(i,r,t),this}getFacetNormal(e){let t=E.Zero();return this.getFacetNormalToRef(e,t),t}getFacetNormalToRef(e,t){let i=this.getFacetLocalNormals()[e];return E.TransformNormalToRef(i,this.getWorldMatrix(),t),this}getFacetsAtLocalCoordinates(e,t,i){let r=this.getBoundingInfo(),n=this._internalAbstractMeshDataInfo._facetData,a=Math.floor((e-r.minimum.x*n.partitioningBBoxRatio)*n.subDiv.X*n.partitioningBBoxRatio/n.bbSize.x),o=Math.floor((t-r.minimum.y*n.partitioningBBoxRatio)*n.subDiv.Y*n.partitioningBBoxRatio/n.bbSize.y),l=Math.floor((i-r.minimum.z*n.partitioningBBoxRatio)*n.subDiv.Z*n.partitioningBBoxRatio/n.bbSize.z);return a<0||a>n.subDiv.max||o<0||o>n.subDiv.max||l<0||l>n.subDiv.max?null:n.facetPartitioning[a+n.subDiv.max*o+n.subDiv.max*n.subDiv.max*l]}getClosestFacetAtCoordinates(e,t,i,r,n=!1,a=!0){let o=this.getWorldMatrix(),l=w.Matrix[5];o.invertToRef(l);let c=w.Vector3[8];E.TransformCoordinatesFromFloatsToRef(e,t,i,l,c);let f=this.getClosestFacetAtLocalCoordinates(c.x,c.y,c.z,r,n,a);return r&&E.TransformCoordinatesFromFloatsToRef(r.x,r.y,r.z,o,r),f}getClosestFacetAtLocalCoordinates(e,t,i,r,n=!1,a=!0){let o=null,l=0,c=0,f=0,h=0,u=0,d=0,p=0,m=0,_=this.getFacetLocalPositions(),v=this.getFacetLocalNormals(),T=this.getFacetsAtLocalCoordinates(e,t,i);if(!T)return null;let C=Number.MAX_VALUE,I=C,R,b,M;for(let F=0;F<T.length;F++)R=T[F],b=v[R],M=_[R],h=(e-M.x)*b.x+(t-M.y)*b.y+(i-M.z)*b.z,(!n||n&&a&&h>=0||n&&!a&&h<=0)&&(h=b.x*M.x+b.y*M.y+b.z*M.z,u=-(b.x*e+b.y*t+b.z*i-h)/(b.x*b.x+b.y*b.y+b.z*b.z),d=e+b.x*u,p=t+b.y*u,m=i+b.z*u,l=d-e,c=p-t,f=m-i,I=l*l+c*c+f*f,I<C&&(C=I,o=R,r&&(r.x=d,r.y=p,r.z=m)));return o}getFacetDataParameters(){return this._internalAbstractMeshDataInfo._facetData.facetParameters}disableFacetData(){let e=this._internalAbstractMeshDataInfo._facetData;return e.facetDataEnabled&&(e.facetDataEnabled=!1,e.facetPositions=[],e.facetNormals=[],e.facetPartitioning=new Array,e.facetParameters={},e.depthSortedIndices=new Uint32Array(0)),this}updateIndices(e,t,i=!1){return this}createNormals(e){let t=this.getVerticesData(A.PositionKind),i=this.getIndices(),r;return this.isVerticesDataPresent(A.NormalKind)?r=this.getVerticesData(A.NormalKind):r=[],Ge.ComputeNormals(t,i,r,{useRightHandedSystem:this.getScene().useRightHandedSystem}),this.setVerticesData(A.NormalKind,r,e),this}async optimizeIndicesAsync(){let e=this.getIndices();if(!e)return this;let{OptimizeIndices:t}=await Promise.resolve().then(()=>(uB(),hB));return t(e),this.setIndices(e,this.getTotalVertices()),this}alignWithNormal(e,t){t||(t=Ms.Y);let i=w.Vector3[0],r=w.Vector3[1];return E.CrossToRef(t,e,r),E.CrossToRef(e,r,i),this.rotationQuaternion?K.RotationQuaternionFromAxisToRef(i,e,r,this.rotationQuaternion):E.RotationFromAxisToRef(i,e,r,this.rotation),this}_checkOcclusionQuery(){return!1}disableEdgesRendering(){throw pe("EdgesRenderer")}enableEdgesRendering(e,t,i){throw pe("EdgesRenderer")}getConnectedParticleSystems(){return this._scene.particleSystems.filter(e=>e.emitter===this)}};Ct.OCCLUSION_TYPE_NONE=0;Ct.OCCLUSION_TYPE_OPTIMISTIC=1;Ct.OCCLUSION_TYPE_STRICT=2;Ct.OCCLUSION_ALGORITHM_TYPE_ACCURATE=0;Ct.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE=1;Ct.CULLINGSTRATEGY_STANDARD=0;Ct.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1;Ct.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2;Ct.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3;x([Ts.filter((...[s,e,t,i,r])=>!Array.isArray(s)&&!Array.isArray(e)&&!Array.isArray(t)&&!Array.isArray(i)&&!Array.isArray(r))],Ct,"_ApplySkeleton",null);G("BABYLON.AbstractMesh",Ct)});var fr,dB=S(()=>{Ye();ei();je();fr=class{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.funcRef=1,this.funcMask=255,this.func=519,this.opStencilFail=7680,this.opDepthFail=7680,this.opStencilDepthPass=7681,this.backFunc=519,this.backOpStencilFail=7680,this.backOpDepthFail=7680,this.backOpStencilDepthPass=7681}get func(){return this._func}set func(e){this._func=e}get backFunc(){return this._backFunc}set backFunc(e){this._backFunc=e}get funcRef(){return this._funcRef}set funcRef(e){this._funcRef=e}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask=e}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail=e}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail=e}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass=e}get backOpStencilFail(){return this._backOpStencilFail}set backOpStencilFail(e){this._backOpStencilFail=e}get backOpDepthFail(){return this._backOpDepthFail}set backOpDepthFail(e){this._backOpDepthFail=e}get backOpStencilDepthPass(){return this._backOpStencilDepthPass}set backOpStencilDepthPass(e){this._backOpStencilDepthPass=e}get mask(){return this._mask}set mask(e){this._mask=e}get enabled(){return this._enabled}set enabled(e){this._enabled=e}getClassName(){return"MaterialStencilState"}copyTo(e){_e.Clone(()=>e,this)}serialize(){return _e.Serialize(this)}parse(e,t,i){_e.Parse(()=>this,e,t,i)}};x([y()],fr.prototype,"func",null);x([y()],fr.prototype,"backFunc",null);x([y()],fr.prototype,"funcRef",null);x([y()],fr.prototype,"funcMask",null);x([y()],fr.prototype,"opStencilFail",null);x([y()],fr.prototype,"opDepthFail",null);x([y()],fr.prototype,"opStencilDepthPass",null);x([y()],fr.prototype,"backOpStencilFail",null);x([y()],fr.prototype,"backOpDepthFail",null);x([y()],fr.prototype,"backOpStencilDepthPass",null);x([y()],fr.prototype,"mask",null);x([y()],fr.prototype,"enabled",null)});var Q,cs=S(()=>{Ye();je();$e();we();gt();Sf();Rl();Ee();wc();El();dB();Xi();ei();Yp();Q=class s{get useVertexPulling(){return this._useVertexPulling}set useVertexPulling(e){this._useVertexPulling!==e&&(this._useVertexPulling=e,this.markAsDirty(s.MiscDirtyFlag))}get _supportGlowLayer(){return!1}set _glowModeEnabled(e){}get shaderLanguage(){return this._shaderLanguage}get canRenderToMRT(){return!1}set alpha(e){if(this._alpha===e)return;let t=this._alpha;this._alpha=e,(t===1||e===1)&&this.markAsDirty(s.MiscDirtyFlag+s.PrePassDirtyFlag)}get alpha(){return this._alpha}set backFaceCulling(e){this._backFaceCulling!==e&&(this._backFaceCulling=e,this.markAsDirty(s.TextureDirtyFlag))}get backFaceCulling(){return this._backFaceCulling}set cullBackFaces(e){this._cullBackFaces!==e&&(this._cullBackFaces=e,this.markAsDirty(s.TextureDirtyFlag))}get cullBackFaces(){return this._cullBackFaces}get blockDirtyMechanism(){return this._blockDirtyMechanism}set blockDirtyMechanism(e){this._blockDirtyMechanism!==e&&(this._blockDirtyMechanism=e,e||this.markDirty())}atomicMaterialsUpdate(e){this.blockDirtyMechanism=!0;try{e(this)}finally{this.blockDirtyMechanism=!1}}get hasRenderTargetTextures(){return this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._eventInfo.hasRenderTargetTextures}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new N),this._onBindObservable}set onBind(e){this._onBindObserver&&this.onBindObservable.remove(this._onBindObserver),this._onBindObserver=this.onBindObservable.add(e)}get onUnBindObservable(){return this._onUnBindObservable||(this._onUnBindObservable=new N),this._onUnBindObservable}get onEffectCreatedObservable(){return this._onEffectCreatedObservable||(this._onEffectCreatedObservable=new N),this._onEffectCreatedObservable}set alphaMode(e){this._alphaMode[0]!==e&&(this._alphaMode[0]=e,this.markAsDirty(s.TextureDirtyFlag))}get alphaMode(){return this._alphaMode[0]}get alphaModes(){return this._alphaMode}setAlphaMode(e,t=0){this._alphaMode[t]!==e&&(this._alphaMode[t]=e,this.markAsDirty(s.TextureDirtyFlag))}set needDepthPrePass(e){this._needDepthPrePass!==e&&(this._needDepthPrePass=e,this._needDepthPrePass&&(this.checkReadyOnEveryCall=!0))}get needDepthPrePass(){return this._needDepthPrePass}get isPrePassCapable(){return!1}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAsDirty(s.MiscDirtyFlag))}get fogEnabled(){return this._fogEnabled}get wireframe(){switch(this._fillMode){case s.WireFrameFillMode:case s.LineListDrawMode:case s.LineLoopDrawMode:case s.LineStripDrawMode:return!0}return this._scene.forceWireframe}set wireframe(e){this.fillMode=e?s.WireFrameFillMode:s.TriangleFillMode}get pointsCloud(){switch(this._fillMode){case s.PointFillMode:case s.PointListDrawMode:return!0}return this._scene.forcePointsCloud}set pointsCloud(e){this.fillMode=e?s.PointFillMode:s.TriangleFillMode}get fillMode(){return this._fillMode}set fillMode(e){this._fillMode!==e&&(this._fillMode=e,this.markAsDirty(s.MiscDirtyFlag))}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){let t=this.getScene().getEngine().getCaps().fragmentDepthSupported;e&&!t&&P.Warn("Logarithmic depth has been requested for a material on a device that doesn't support it."),this._useLogarithmicDepth=e&&t,this._markAllSubMeshesAsMiscDirty()}get setVertexOutputInvariant(){return this._setVertexOutputInvariant}set setVertexOutputInvariant(e){this._setVertexOutputInvariant!==e&&(this._setVertexOutputInvariant=e,this._markAllSubMeshesAsMiscDirty())}_getDrawWrapper(){return this._drawWrapper}_setDrawWrapper(e){this._drawWrapper=e}constructor(e,t,i,r=!1){this.shadowDepthWrapper=null,this.allowShaderHotSwapping=!0,this._shaderLanguage=0,this._forceGLSL=!1,this._useVertexPulling=!1,this.metadata=null,this.reservedDataStore=null,this.checkReadyOnEveryCall=!1,this.checkReadyOnlyOnce=!1,this.state="",this._alpha=1,this._backFaceCulling=!0,this._cullBackFaces=!0,this._blockDirtyMechanism=!1,this.sideOrientation=null,this.onCompiled=null,this.onError=null,this.getRenderTargetTextures=null,this.doNotSerialize=!1,this._storeEffectOnSubMeshes=!1,this.animations=null,this.onDisposeObservable=new N,this._onDisposeObserver=null,this._onUnBindObservable=null,this._onBindObserver=null,this._alphaMode=[2],this._needDepthPrePass=!1,this.disableDepthWrite=!1,this.disableColorWrite=!1,this.forceDepthWrite=!1,this.depthFunction=0,this.separateCullingPass=!1,this._fogEnabled=!0,this.pointSize=1,this.zOffset=0,this.zOffsetUnits=0,this.stencil=new fr,this._setVertexOutputInvariant=!1,this._useUBO=!1,this._fillMode=s.TriangleFillMode,this._cachedDepthWriteState=!1,this._cachedColorWriteState=!1,this._cachedDepthFunctionState=0,this._indexInSceneMaterialArray=-1,this.meshMap=null,this._parentContainer=null,this._uniformBufferLayoutBuilt=!1,this._eventInfo={},this._callbackPluginEventGeneric=()=>{},this._callbackPluginEventIsReadyForSubMesh=()=>{},this._callbackPluginEventPrepareDefines=()=>{},this._callbackPluginEventPrepareDefinesBeforeAttributes=()=>{},this._callbackPluginEventHardBindForSubMesh=()=>{},this._callbackPluginEventBindForSubMesh=()=>{},this._callbackPluginEventHasRenderTargetTextures=()=>{},this._callbackPluginEventFillRenderTargetTextures=()=>{},this._transparencyMode=null,this.name=e;let n=t||Z.LastCreatedScene;n&&(this._scene=n,this._dirtyCallbacks={},this._forceGLSL=r,this._dirtyCallbacks[1]=this._markAllSubMeshesAsTexturesDirty.bind(this),this._dirtyCallbacks[2]=this._markAllSubMeshesAsLightsDirty.bind(this),this._dirtyCallbacks[4]=this._markAllSubMeshesAsFresnelDirty.bind(this),this._dirtyCallbacks[8]=this._markAllSubMeshesAsAttributesDirty.bind(this),this._dirtyCallbacks[16]=this._markAllSubMeshesAsMiscDirty.bind(this),this._dirtyCallbacks[32]=this._markAllSubMeshesAsPrePassDirty.bind(this),this._dirtyCallbacks[127]=this._markAllSubMeshesAsAllDirty.bind(this),this.id=e||W.RandomId(),this.uniqueId=this._scene.getUniqueId(),this._materialContext=this._scene.getEngine().createMaterialContext(),this._drawWrapper=new Vr(this._scene.getEngine(),!1),this._drawWrapper.materialContext=this._materialContext,this._uniformBuffer=new ii(this._scene.getEngine(),void 0,void 0,e),this._useUBO=this.getScene().getEngine().supportsUniformBuffers,this._createUniformBuffer(),i||this._scene.addMaterial(this),this._scene.useMaterialMeshMap&&(this.meshMap={}),s.OnEventObservable.notifyObservers(this,1))}_createUniformBuffer(){let e=this.getScene().getEngine();this._uniformBuffer?.dispose(),e.isWebGPU&&!this._forceGLSL?(this._uniformBuffer=new ii(e,void 0,void 0,this.name,!0),this._shaderLanguage=1):this._uniformBuffer=new ii(this._scene.getEngine(),void 0,void 0,this.name),this._uniformBufferLayoutBuilt=!1}toString(e){return"Name: "+this.name}getClassName(){return"Material"}get _isMaterial(){return!0}get isFrozen(){return this.checkReadyOnlyOnce}freeze(){this.markDirty(),this.checkReadyOnlyOnce=!0}unfreeze(){this.markDirty(),this.checkReadyOnlyOnce=!1}isReady(e,t){return!0}isReadyForSubMesh(e,t,i){let r=t.materialDefines;return r?(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=r,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),this._eventInfo.isReadyForSubMesh):!1}getEffect(){return this._drawWrapper.effect}getScene(){return this._scene}_getEffectiveOrientation(e){return this.sideOrientation!==null?this.sideOrientation:e.sideOrientation}get transparencyMode(){return this._transparencyMode}set transparencyMode(e){this._transparencyMode!==e&&(this._transparencyMode=e,this._markAllSubMeshesAsTexturesAndMiscDirty())}get _hasTransparencyMode(){return this._transparencyMode!=null}get _transparencyModeIsBlend(){return this._transparencyMode===s.MATERIAL_ALPHABLEND||this._transparencyMode===s.MATERIAL_ALPHATESTANDBLEND}get _transparencyModeIsTest(){return this._transparencyMode===s.MATERIAL_ALPHATEST||this._transparencyMode===s.MATERIAL_ALPHATESTANDBLEND}get _disableAlphaBlending(){return this._transparencyMode===s.MATERIAL_OPAQUE||this._transparencyMode===s.MATERIAL_ALPHATEST}needAlphaBlending(){return this._hasTransparencyMode?this._transparencyModeIsBlend:this._disableAlphaBlending?!1:this.alpha<1}needAlphaBlendingForMesh(e){return this._hasTransparencyMode?this._transparencyModeIsBlend:e.visibility<1?!0:this._disableAlphaBlending?!1:e.hasVertexAlpha||this.needAlphaBlending()}needAlphaTesting(){return this._hasTransparencyMode?this._transparencyModeIsTest:!1}needAlphaTestingForMesh(e){return this._hasTransparencyMode?this._transparencyModeIsTest:!this.needAlphaBlendingForMesh(e)&&this.needAlphaTesting()}getAlphaTestTexture(){return null}markDirty(e=!1){let t=this.getScene().meshes;for(let i of t)if(i.subMeshes){for(let r of i.subMeshes)if(r.getMaterial()===this)for(let n of r._drawWrappers)n&&this._materialContext===n.materialContext&&(n._wasPreviouslyReady=!1,n._wasPreviouslyUsingInstances=null,n._forceRebindOnNextCall=e)}e&&this.markAsDirty(s.AllDirtyFlag)}_preBind(e,t=null){let i=this._scene.getEngine(),n=(t??this.sideOrientation)===s.ClockWiseSideOrientation,a=e||this._getDrawWrapper();return Bc(a)&&a.materialContext&&(a.materialContext.useVertexPulling=this.useVertexPulling),i.enableEffect(a),i.setState(this.backFaceCulling,this.zOffset,!1,n,this._scene._mirroredCameraPosition?!this.cullBackFaces:this.cullBackFaces,this.stencil,this.zOffsetUnits),n}bind(e,t){}buildUniformLayout(){let e=this._uniformBuffer;this._eventInfo.ubo=e,this._callbackPluginEventGeneric(8,this._eventInfo),e.create(),this._uniformBufferLayoutBuilt=!0}bindForSubMesh(e,t,i){let r=i._drawWrapper;this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),r._forceRebindOnNextCall=!1}bindOnlyWorldMatrix(e){}bindView(e){this._useUBO?this._needToBindSceneUbo=!0:e.setMatrix("view",this.getScene().getViewMatrix())}bindViewProjection(e){this._useUBO?this._needToBindSceneUbo=!0:(e.setMatrix("viewProjection",this.getScene().getTransformMatrix()),e.setMatrix("projection",this.getScene().getProjectionMatrix()))}bindEyePosition(e,t){this._useUBO?this._needToBindSceneUbo=!0:this._scene.bindEyePosition(e,t)}_afterBind(e,t=null,i){if(this._scene._cachedMaterial=this,this._needToBindSceneUbo&&t&&(this._needToBindSceneUbo=!1,Co(t,this.getScene().getSceneUniformBuffer()),this._scene.finalizeSceneUbo()),e?this._scene._cachedVisibility=e.visibility:this._scene._cachedVisibility=1,this._onBindObservable&&e&&this._onBindObservable.notifyObservers(e),this.disableDepthWrite){let r=this._scene.getEngine();this._cachedDepthWriteState=r.getDepthWrite(),r.setDepthWrite(!1)}if(this.disableColorWrite){let r=this._scene.getEngine();this._cachedColorWriteState=r.getColorWrite(),r.setColorWrite(!1)}if(this.depthFunction!==0){let r=this._scene.getEngine();this._cachedDepthFunctionState=r.getDepthFunction()||0,r.setDepthFunction(this.depthFunction)}}unbind(){this._scene.getSceneUniformBuffer().unbindEffect(),this._onUnBindObservable&&this._onUnBindObservable.notifyObservers(this),this.depthFunction!==0&&this._scene.getEngine().setDepthFunction(this._cachedDepthFunctionState),this.disableDepthWrite&&this._scene.getEngine().setDepthWrite(this._cachedDepthWriteState),this.disableColorWrite&&this._scene.getEngine().setColorWrite(this._cachedColorWriteState)}getAnimatables(){return this._eventInfo.animatables=[],this._callbackPluginEventGeneric(256,this._eventInfo),this._eventInfo.animatables}getActiveTextures(){return this._eventInfo.activeTextures=[],this._callbackPluginEventGeneric(512,this._eventInfo),this._eventInfo.activeTextures}hasTexture(e){return this._eventInfo.hasTexture=!1,this._eventInfo.texture=e,this._callbackPluginEventGeneric(1024,this._eventInfo),this._eventInfo.hasTexture}clone(e){return null}_clonePlugins(e,t){let i={};if(this._serializePlugins(i),s._ParsePlugins(i,e,this._scene,t),this.pluginManager)for(let r of this.pluginManager._plugins){let n=e.pluginManager.getPlugin(r.name);n&&r.copyTo(n)}}getBindedMeshes(){if(this.meshMap){let e=[];for(let t in this.meshMap){let i=this.meshMap[t];i&&e.push(i)}return e}else return this._scene.meshes.filter(t=>t.material===this)}forceCompilation(e,t,i,r){let n={clipPlane:!1,useInstances:!1,...i},a=this.getScene(),o=this.allowShaderHotSwapping;this.allowShaderHotSwapping=!1;let l=()=>{if(!this._scene||!this._scene.getEngine())return;let c=a.clipPlane;if(n.clipPlane&&(a.clipPlane=new Ks(0,0,0,1)),this._storeEffectOnSubMeshes){let f=!0,h=null;if(e.subMeshes){let u=new cr(0,0,0,0,0,e,void 0,!1,!1);u.materialDefines&&(u.materialDefines._renderId=-1),this.isReadyForSubMesh(e,u,n.useInstances)||(u.effect&&u.effect.getCompilationError()&&u.effect.allFallbacksProcessed()?h=u.effect.getCompilationError():(f=!1,setTimeout(l,16)))}f&&(this.allowShaderHotSwapping=o,h&&r&&r(h),t&&t(this))}else this.isReady()?(this.allowShaderHotSwapping=o,t&&t(this)):setTimeout(l,16);n.clipPlane&&(a.clipPlane=c)};l()}async forceCompilationAsync(e,t){return await new Promise((i,r)=>{this.forceCompilation(e,()=>{i()},t,n=>{r(n)})})}markAsDirty(e){this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism||(s._DirtyCallbackArray.length=0,e&s.ImageProcessingDirtyFlag&&s._DirtyCallbackArray.push(s._ImageProcessingDirtyCallBack),e&s.TextureDirtyFlag&&s._DirtyCallbackArray.push(s._TextureDirtyCallBack),e&s.LightDirtyFlag&&s._DirtyCallbackArray.push(s._LightsDirtyCallBack),e&s.FresnelDirtyFlag&&s._DirtyCallbackArray.push(s._FresnelDirtyCallBack),e&s.AttributesDirtyFlag&&s._DirtyCallbackArray.push(s._AttributeDirtyCallBack),e&s.MiscDirtyFlag&&s._DirtyCallbackArray.push(s._MiscDirtyCallBack),e&s.PrePassDirtyFlag&&s._DirtyCallbackArray.push(s._PrePassDirtyCallBack),s._DirtyCallbackArray.length&&this._markAllSubMeshesAsDirty(s._RunDirtyCallBacks),this.getScene().resetCachedMaterial())}resetDrawCache(){let e=this.getScene().meshes;for(let t of e)if(t.subMeshes)for(let i of t.subMeshes)i.getMaterial()===this&&i.resetDrawCache()}_markAllSubMeshesAsDirty(e){let t=this.getScene();if(t.blockMaterialDirtyMechanism||this._blockDirtyMechanism)return;let i=t.meshes;for(let r of i)if(r.subMeshes){for(let n of r.subMeshes)if((n.getMaterial()||(t._hasDefaultMaterial?t.defaultMaterial:null))===this)for(let o of n._drawWrappers)!o||!o.defines||!o.defines.markAllAsDirty||this._materialContext===o.materialContext&&e(o.defines)}}_markScenePrePassDirty(){if(this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism)return;let e=this.getScene().enablePrePassRenderer();e&&e.markAsDirty()}_markAllSubMeshesAsAllDirty(){this._markAllSubMeshesAsDirty(s._AllDirtyCallBack)}_markAllSubMeshesAsImageProcessingDirty(){this._markAllSubMeshesAsDirty(s._ImageProcessingDirtyCallBack)}_markAllSubMeshesAsTexturesDirty(){this._markAllSubMeshesAsDirty(s._TextureDirtyCallBack)}_markAllSubMeshesAsFresnelDirty(){this._markAllSubMeshesAsDirty(s._FresnelDirtyCallBack)}_markAllSubMeshesAsFresnelAndMiscDirty(){this._markAllSubMeshesAsDirty(s._FresnelAndMiscDirtyCallBack)}_markAllSubMeshesAsLightsDirty(){this._markAllSubMeshesAsDirty(s._LightsDirtyCallBack)}_markAllSubMeshesAsAttributesDirty(){this._markAllSubMeshesAsDirty(s._AttributeDirtyCallBack)}_markAllSubMeshesAsMiscDirty(){this._markAllSubMeshesAsDirty(s._MiscDirtyCallBack)}_markAllSubMeshesAsPrePassDirty(){this._markAllSubMeshesAsDirty(s._PrePassDirtyCallBack)}_markAllSubMeshesAsTexturesAndMiscDirty(){this._markAllSubMeshesAsDirty(s._TextureAndMiscDirtyCallBack)}_checkScenePerformancePriority(){if(this._scene.performancePriority!==0){this.checkReadyOnlyOnce=!0;let e=this._scene.onScenePerformancePriorityChangedObservable.addOnce(()=>{this.checkReadyOnlyOnce=!1});this.onDisposeObservable.add(()=>{this._scene.onScenePerformancePriorityChangedObservable.remove(e)})}}setPrePassRenderer(e){return!1}dispose(e,t,i){let r=this.getScene();if(r.stopAnimation(this),r.freeProcessedMaterials(),r.removeMaterial(this),this._eventInfo.forceDisposeTextures=t,this._callbackPluginEventGeneric(2,this._eventInfo),this._parentContainer){let n=this._parentContainer.materials.indexOf(this);n>-1&&this._parentContainer.materials.splice(n,1),this._parentContainer=null}if(i!==!0)if(this.meshMap)for(let n in this.meshMap){let a=this.meshMap[n];this._disposeMeshResources(a)}else{let n=r.meshes;for(let a of n)this._disposeMeshResources(a)}this._uniformBuffer.dispose(),this._drawWrapper.effect&&(this._storeEffectOnSubMeshes||this._drawWrapper.effect.dispose(),this._drawWrapper.effect=null),this.metadata=null,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._onBindObservable&&this._onBindObservable.clear(),this._onUnBindObservable&&this._onUnBindObservable.clear(),this._onEffectCreatedObservable&&this._onEffectCreatedObservable.clear(),this._eventInfo&&(this._eventInfo={})}_disposeMeshResources(e){if(!e)return;let t=e.geometry,i=e._internalAbstractMeshDataInfo._materialForRenderPass;if(this._storeEffectOnSubMeshes){if(e.subMeshes&&i)for(let r of e.subMeshes){let n=r._drawWrappers;for(let a=0;a<n.length;a++){let o=n[a]?.effect;if(!o)continue;i[a]===this&&(t?._releaseVertexArrayObject(o),r._removeDrawWrapper(a,!0,!0))}}}else t?._releaseVertexArrayObject(this._drawWrapper.effect);e.material===this&&!e.sourceMesh&&(e.material=null)}serialize(){let e=_e.Serialize(this);return e.stencil=this.stencil.serialize(),e.uniqueId=this.uniqueId,this._serializePlugins(e),e}_serializePlugins(e){if(e.plugins={},this.pluginManager)for(let t of this.pluginManager._plugins)t.doNotSerialize||(e.plugins[t.getClassName()]=t.serialize())}static ParseAlphaMode(e,t){e._alphaMode!==void 0?t._alphaMode=Array.isArray(e._alphaMode)?e._alphaMode:[e._alphaMode]:e.alphaMode!==void 0?t._alphaMode=Array.isArray(e.alphaMode)?e.alphaMode:[e.alphaMode]:t._alphaMode=[2]}static Parse(e,t,i){if(!e.customType)e.customType="BABYLON.StandardMaterial";else if(e.customType==="BABYLON.PBRMaterial"&&e.overloadedAlbedo&&(e.customType="BABYLON.LegacyPBRMaterial",!BABYLON.LegacyPBRMaterial))return P.Error("Your scene is trying to load a legacy version of the PBRMaterial, please, include it from the materials library."),null;let n=W.Instantiate(e.customType).Parse(e,t,i);return n._loadedUniqueId=e.uniqueId,s.ParseAlphaMode(e,n),n}static _ParsePlugins(e,t,i,r){if(e.plugins)for(let n in e.plugins){let a=e.plugins[n],o=t.pluginManager?.getPlugin(a.name);if(!o){let l=W.Instantiate("BABYLON."+n);l&&(o=new l(t))}o?.parse(a,i,r)}}};Q.TriangleFillMode=0;Q.WireFrameFillMode=1;Q.PointFillMode=2;Q.PointListDrawMode=3;Q.LineListDrawMode=4;Q.LineLoopDrawMode=5;Q.LineStripDrawMode=6;Q.TriangleStripDrawMode=7;Q.TriangleFanDrawMode=8;Q.ClockWiseSideOrientation=0;Q.CounterClockWiseSideOrientation=1;Q.ImageProcessingDirtyFlag=64;Q.TextureDirtyFlag=1;Q.LightDirtyFlag=2;Q.FresnelDirtyFlag=4;Q.AttributesDirtyFlag=8;Q.MiscDirtyFlag=16;Q.PrePassDirtyFlag=32;Q.AllDirtyFlag=127;Q.MATERIAL_OPAQUE=0;Q.MATERIAL_ALPHATEST=1;Q.MATERIAL_ALPHABLEND=2;Q.MATERIAL_ALPHATESTANDBLEND=3;Q.MATERIAL_NORMALBLENDMETHOD_WHITEOUT=0;Q.MATERIAL_NORMALBLENDMETHOD_RNM=1;Q.OnEventObservable=new N;Q._AllDirtyCallBack=s=>s.markAllAsDirty();Q._ImageProcessingDirtyCallBack=s=>s.markAsImageProcessingDirty();Q._TextureDirtyCallBack=s=>s.markAsTexturesDirty();Q._FresnelDirtyCallBack=s=>s.markAsFresnelDirty();Q._MiscDirtyCallBack=s=>s.markAsMiscDirty();Q._PrePassDirtyCallBack=s=>s.markAsPrePassDirty();Q._LightsDirtyCallBack=s=>s.markAsLightDirty();Q._AttributeDirtyCallBack=s=>s.markAsAttributesDirty();Q._FresnelAndMiscDirtyCallBack=s=>{Q._FresnelDirtyCallBack(s),Q._MiscDirtyCallBack(s)};Q._TextureAndMiscDirtyCallBack=s=>{Q._TextureDirtyCallBack(s),Q._MiscDirtyCallBack(s)};Q._DirtyCallbackArray=[];Q._RunDirtyCallBacks=s=>{for(let e of Q._DirtyCallbackArray)e(s)};x([y()],Q.prototype,"id",void 0);x([y()],Q.prototype,"uniqueId",void 0);x([y()],Q.prototype,"name",void 0);x([y()],Q.prototype,"metadata",void 0);x([y()],Q.prototype,"checkReadyOnEveryCall",void 0);x([y()],Q.prototype,"checkReadyOnlyOnce",void 0);x([y()],Q.prototype,"state",void 0);x([y("alpha")],Q.prototype,"_alpha",void 0);x([y("backFaceCulling")],Q.prototype,"_backFaceCulling",void 0);x([y("cullBackFaces")],Q.prototype,"_cullBackFaces",void 0);x([y()],Q.prototype,"sideOrientation",void 0);x([y()],Q.prototype,"_alphaMode",void 0);x([y()],Q.prototype,"_needDepthPrePass",void 0);x([y()],Q.prototype,"disableDepthWrite",void 0);x([y()],Q.prototype,"disableColorWrite",void 0);x([y()],Q.prototype,"forceDepthWrite",void 0);x([y()],Q.prototype,"depthFunction",void 0);x([y()],Q.prototype,"separateCullingPass",void 0);x([y("fogEnabled")],Q.prototype,"_fogEnabled",void 0);x([y()],Q.prototype,"pointSize",void 0);x([y()],Q.prototype,"zOffset",void 0);x([y()],Q.prototype,"zOffsetUnits",void 0);x([y()],Q.prototype,"pointsCloud",null);x([y()],Q.prototype,"fillMode",null);x([y()],Q.prototype,"useLogarithmicDepth",null);x([y()],Q.prototype,"_setVertexOutputInvariant",void 0);x([y()],Q.prototype,"transparencyMode",null)});var Tf,pB=S(()=>{cs();po();Te();Tf=class s extends Q{get subMaterials(){return this._subMaterials}set subMaterials(e){this._subMaterials=e,this._hookArray(e)}getChildren(){return this.subMaterials}constructor(e,t){super(e,t,!0),this._waitingSubMaterialsUniqueIds=[],this.getScene().addMultiMaterial(this),this.subMaterials=[],this._storeEffectOnSubMeshes=!0}_hookArray(e){let t=e.push;e.push=(...r)=>{let n=t.apply(e,r);return this._markAllSubMeshesAsTexturesDirty(),n};let i=e.splice;e.splice=(r,n)=>{let a=i.apply(e,[r,n]);return this._markAllSubMeshesAsTexturesDirty(),a}}getSubMaterial(e){return e<0||e>=this.subMaterials.length?this.getScene().defaultMaterial:this.subMaterials[e]}getActiveTextures(){return super.getActiveTextures().concat(...this.subMaterials.map(e=>e?e.getActiveTextures():[]))}hasTexture(e){if(super.hasTexture(e))return!0;for(let t=0;t<this.subMaterials.length;t++)if(this.subMaterials[t]?.hasTexture(e))return!0;return!1}getClassName(){return"MultiMaterial"}isReadyForSubMesh(e,t,i){for(let r=0;r<this.subMaterials.length;r++){let n=this.subMaterials[r];if(n){if(n._storeEffectOnSubMeshes){if(!n.isReadyForSubMesh(e,t,i))return!1;continue}if(!n.isReady(e))return!1}}return!0}clone(e,t){let i=new s(e,this.getScene());for(let r=0;r<this.subMaterials.length;r++){let n=null,a=this.subMaterials[r];t&&a?n=a.clone(e+"-"+a.name):n=this.subMaterials[r],i.subMaterials.push(n)}return i}serialize(){let e={};e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,st&&(e.tags=st.GetTags(this)),e.materialsUniqueIds=[],e.materials=[];for(let t=0;t<this.subMaterials.length;t++){let i=this.subMaterials[t];i?(e.materialsUniqueIds.push(i.uniqueId),e.materials.push(i.id)):(e.materialsUniqueIds.push(null),e.materials.push(null))}return e}dispose(e,t,i){let r=this.getScene();if(!r)return;if(i)for(let a=0;a<this.subMaterials.length;a++){let o=this.subMaterials[a];o&&o.dispose(e,t)}let n=r.multiMaterials.indexOf(this);n>=0&&r.multiMaterials.splice(n,1),super.dispose(e,t)}static ParseMultiMaterial(e,t){let i=new s(e.name,t);if(i.id=e.id,i._loadedUniqueId=e.uniqueId,st&&st.AddTagsTo(i,e.tags),e.materialsUniqueIds)i._waitingSubMaterialsUniqueIds=e.materialsUniqueIds;else for(let r of e.materials)i.subMaterials.push(t.getLastMaterialById(r));return i}};G("BABYLON.MultiMaterial",Tf)});var o_,mB=S(()=>{o_=class{constructor(e,t){this.distanceOrScreenCoverage=e,this.mesh=t}}});var lC,cC,l_,fC,hC,Xn,fe,Ki=S(()=>{we();$e();Ch();po();t_();Vn();ie();it();rs();yt();ln();ou();Ef();Sf();cs();pB();s_();ei();Ee();Te();Ii();Pn();mB();lC=class{constructor(){this.batchCache=new l_(this),this.batchCacheReplacementModeInFrozenMode=new l_(this),this.instancesBufferSize=512*4}},cC=class{constructor(){this.renderPasses={}}},l_=class{constructor(e){this.parent=e,this.mustReturn=!1,this.visibleInstances=new Array,this.renderSelf=[],this.hardwareInstancedRendering=[]}},fC=class{constructor(){this.instancesCount=0,this.matrixBuffer=null,this.previousMatrixBuffer=null,this.matrixBufferSize=512,this.matrixData=null,this.boundingVectors=[],this.worldMatrices=null}},hC=class{constructor(){this._areNormalsFrozen=!1,this._source=null,this.meshMap=null,this._preActivateId=-1,this._LODLevels=new Array,this._useLODScreenCoverage=!1,this._effectiveMaterial=null,this._forcedInstanceCount=0,this._overrideRenderingFillMode=null}},Xn={source:null,parent:null,doNotCloneChildren:!1,clonePhysicsImpostor:!0,cloneThinInstances:!1},fe=class s extends Ct{static _GetDefaultSideOrientation(e){return e||s.FRONTSIDE}get useLODScreenCoverage(){return this._internalMeshDataInfo._useLODScreenCoverage}set useLODScreenCoverage(e){this._internalMeshDataInfo._useLODScreenCoverage=e,this._sortLODLevels()}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(e&&this._internalMeshDataInfo._sourcePositions&&(this.setVerticesData(A.PositionKind,this._internalMeshDataInfo._sourcePositions,!0),this._internalMeshDataInfo._sourceNormals&&this.setVerticesData(A.NormalKind,this._internalMeshDataInfo._sourceNormals,!0),this._internalMeshDataInfo._sourcePositions=null,this._internalMeshDataInfo._sourceNormals=null),this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}get onBeforeRenderObservable(){return this._internalMeshDataInfo._onBeforeRenderObservable||(this._internalMeshDataInfo._onBeforeRenderObservable=new N),this._internalMeshDataInfo._onBeforeRenderObservable}get onBeforeBindObservable(){return this._internalMeshDataInfo._onBeforeBindObservable||(this._internalMeshDataInfo._onBeforeBindObservable=new N),this._internalMeshDataInfo._onBeforeBindObservable}get onAfterRenderObservable(){return this._internalMeshDataInfo._onAfterRenderObservable||(this._internalMeshDataInfo._onAfterRenderObservable=new N),this._internalMeshDataInfo._onAfterRenderObservable}get onBetweenPassObservable(){return this._internalMeshDataInfo._onBetweenPassObservable||(this._internalMeshDataInfo._onBetweenPassObservable=new N),this._internalMeshDataInfo._onBetweenPassObservable}get onBeforeDrawObservable(){return this._internalMeshDataInfo._onBeforeDrawObservable||(this._internalMeshDataInfo._onBeforeDrawObservable=new N),this._internalMeshDataInfo._onBeforeDrawObservable}set onBeforeDraw(e){this._onBeforeDrawObserver&&this.onBeforeDrawObservable.remove(this._onBeforeDrawObserver),this._onBeforeDrawObserver=this.onBeforeDrawObservable.add(e)}get hasInstances(){return this.instances.length>0}get hasThinInstances(){return(this.forcedInstanceCount||this._thinInstanceDataStorage.instancesCount||0)>0}get forcedInstanceCount(){return this._internalMeshDataInfo._forcedInstanceCount}set forcedInstanceCount(e){this._internalMeshDataInfo._forcedInstanceCount=e}get sideOrientation(){return this._internalMeshDataInfo._sideOrientation}set sideOrientation(e){this._internalMeshDataInfo._sideOrientation=e,this._internalAbstractMeshDataInfo._sideOrientationHint=this._scene.useRightHandedSystem&&e===1||!this._scene.useRightHandedSystem&&e===0}get _effectiveSideOrientation(){return this._internalMeshDataInfo._effectiveSideOrientation}get overrideMaterialSideOrientation(){return this.sideOrientation}set overrideMaterialSideOrientation(e){this.sideOrientation=e,this.material&&(this.material.sideOrientation=null)}get overrideRenderingFillMode(){return this._internalMeshDataInfo._overrideRenderingFillMode}set overrideRenderingFillMode(e){this._internalMeshDataInfo._overrideRenderingFillMode=e}get material(){return this._internalAbstractMeshDataInfo._material}set material(e){e&&(this.material&&this.material.sideOrientation===null||this._internalAbstractMeshDataInfo._sideOrientationHint)&&(e.sideOrientation=null),this._setMaterial(e)}get source(){return this._internalMeshDataInfo._source}get cloneMeshMap(){return this._internalMeshDataInfo.meshMap}get isUnIndexed(){return this._unIndexed}set isUnIndexed(e){this._unIndexed!==e&&(this._unIndexed=e,this._markSubMeshesAsAttributesDirty())}get worldMatrixInstancedBuffer(){let e=this._instanceDataStorage.renderPasses[this._instanceDataStorage.engine.isWebGPU?this._instanceDataStorage.engine.currentRenderPassId:0];return e?e.instancesData:void 0}get previousWorldMatrixInstancedBuffer(){let e=this._instanceDataStorage.renderPasses[this._instanceDataStorage.engine.isWebGPU?this._instanceDataStorage.engine.currentRenderPassId:0];return e?e.instancesPreviousData:void 0}get manualUpdateOfWorldMatrixInstancedBuffer(){return this._instanceDataStorage.manualUpdate}set manualUpdateOfWorldMatrixInstancedBuffer(e){this._instanceDataStorage.manualUpdate=e}get manualUpdateOfPreviousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.previousManualUpdate}set manualUpdateOfPreviousWorldMatrixInstancedBuffer(e){this._instanceDataStorage.previousManualUpdate=e}get forceWorldMatrixInstancedBufferUpdate(){return this._instanceDataStorage.forceMatrixUpdates}set forceWorldMatrixInstancedBufferUpdate(e){this._instanceDataStorage.forceMatrixUpdates=e}_copySource(e,t,i=!0,r=!1){let n=this.getScene();if(e._geometry&&e._geometry.applyToMesh(this),xn.DeepCopy(e,this,["name","material","skeleton","instances","parent","uniqueId","source","metadata","morphTargetManager","hasInstances","worldMatrixInstancedBuffer","previousWorldMatrixInstancedBuffer","hasLODLevels","geometry","isBlocked","areNormalsFrozen","facetNb","isFacetDataEnabled","lightSources","useBones","isAnInstance","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","cloneMeshMap","hasBoundingInfo","physicsBody","physicsImpostor"],["_poseMatrix"]),this._internalMeshDataInfo._source=e,n.useClonedMeshMap&&(e._internalMeshDataInfo.meshMap||(e._internalMeshDataInfo.meshMap={}),e._internalMeshDataInfo.meshMap[this.uniqueId]=this),this._originalBuilderSideOrientation=e._originalBuilderSideOrientation,this._creationDataStorage=e._creationDataStorage,e._ranges){let a=e._ranges;for(let o in a)Object.prototype.hasOwnProperty.call(a,o)&&a[o]&&this.createAnimationRange(o,a[o].from,a[o].to)}if(e.metadata&&e.metadata.clone?this.metadata=e.metadata.clone():this.metadata=e.metadata,this._internalMetadata=e._internalMetadata,st&&st.HasTags(e)&&st.AddTagsTo(this,st.GetTags(e,!0)),this.setEnabled(e.isEnabled(!1)),this.parent=e.parent,this.setPivotMatrix(e.getPivotMatrix(),this._postMultiplyPivotMatrix),this.id=this.name+"."+e.id,this.material=e.material,!t){let a=e.getDescendants(!0);for(let o=0;o<a.length;o++){let l=a[o];l._isMesh?(Xn.parent=this,Xn.doNotCloneChildren=t,Xn.clonePhysicsImpostor=i,Xn.cloneThinInstances=r,l.clone(this.name+"."+l.name,Xn)):l.clone&&l.clone(this.name+"."+l.name,this)}}if(e.morphTargetManager&&(this.morphTargetManager=e.morphTargetManager),n.getPhysicsEngine){let a=n.getPhysicsEngine();if(i&&a)if(a.getPluginVersion()===1){let o=a.getImpostorForPhysicsObject(e);o&&(this.physicsImpostor=o.clone(this))}else a.getPluginVersion()===2&&e.physicsBody&&e.physicsBody.clone(this)}for(let a=0;a<n.particleSystems.length;a++){let o=n.particleSystems[a];o.emitter===e&&o.clone(o.name,this)}if(this.skeleton=e.skeleton,r&&(e._thinInstanceDataStorage.matrixData?(this.thinInstanceSetBuffer("matrix",new Float32Array(e._thinInstanceDataStorage.matrixData),16,!e._thinInstanceDataStorage.matrixBuffer.isUpdatable()),this._thinInstanceDataStorage.matrixBufferSize=e._thinInstanceDataStorage.matrixBufferSize,this._thinInstanceDataStorage.instancesCount=e._thinInstanceDataStorage.instancesCount):this._thinInstanceDataStorage.matrixBufferSize=e._thinInstanceDataStorage.matrixBufferSize,e._userThinInstanceBuffersStorage)){let a=e._userThinInstanceBuffersStorage;for(let o in a.data)this.thinInstanceSetBuffer(o,new Float32Array(a.data[o]),a.strides[o],!a.vertexBuffers?.[o]?.isUpdatable()),this._userThinInstanceBuffersStorage.sizes[o]=a.sizes[o]}this.refreshBoundingInfo(!0,!0),this.computeWorldMatrix(!0)}constructor(e,t=null,i=null,r=null,n,a=!0){super(e,t),this._internalMeshDataInfo=new hC,this.delayLoadState=0,this.instances=[],this._creationDataStorage=null,this._geometry=null,this._thinInstanceDataStorage=new fC,this._shouldGenerateFlatShading=!1,this._originalBuilderSideOrientation=s.DEFAULTSIDE,this.ignoreCameraMaxZ=!1,t=this.getScene(),this._instanceDataStorage=new cC,this._instanceDataStorage.engine=t.getEngine(),this._scene.useRightHandedSystem?this.sideOrientation=0:this.sideOrientation=1,this._onBeforeDraw=(c,f,h)=>{c&&h&&(this._uniformBuffer?this.transferToEffect(f):h.bindOnlyWorldMatrix(f))};let o=null,l=!1;if(i&&i._addToSceneRootNodes===void 0){let c=i;o=c.parent??null,r=c.source??null,n=c.doNotCloneChildren??!1,a=c.clonePhysicsImpostor??!0,l=c.cloneThinInstances??!1}else o=i;r&&this._copySource(r,n,a,l),o!==null&&(this.parent=o),this._instanceDataStorage.hardwareInstancedRendering=this.getEngine().getCaps().instancedArrays,this._internalMeshDataInfo._onMeshReadyObserverAdded=c=>{c.unregisterOnNextCall=!0,this.isReady(!0)?this.onMeshReadyObservable.notifyObservers(this):this._internalMeshDataInfo._checkReadinessObserver||(this._internalMeshDataInfo._checkReadinessObserver=this._scene.onBeforeRenderObservable.add(()=>{this.isReady(!0)&&(this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),this._internalMeshDataInfo._checkReadinessObserver=null,this.onMeshReadyObservable.notifyObservers(this))}))},this.onMeshReadyObservable=new N(this._internalMeshDataInfo._onMeshReadyObserverAdded),r&&r.onClonedObservable.notifyObservers(this)}instantiateHierarchy(e=null,t,i){let r=this.getTotalVertices()===0||t&&t.doNotInstantiate&&(t.doNotInstantiate===!0||t.doNotInstantiate(this))?this.clone("Clone of "+(this.name||this.id),e||this.parent,!0):this.createInstance("instance of "+(this.name||this.id));r.parent=e||this.parent,r.position=this.position.clone(),r.scaling=this.scaling.clone(),this.rotationQuaternion?r.rotationQuaternion=this.rotationQuaternion.clone():r.rotation=this.rotation.clone(),i&&i(this,r);for(let n of this.getChildTransformNodes(!0))n.getClassName()==="InstancedMesh"&&r.getClassName()==="Mesh"&&n.sourceMesh===this?n.instantiateHierarchy(r,{doNotInstantiate:t&&t.doNotInstantiate||!1,newSourcedMesh:r},i):n.instantiateHierarchy(r,t,i);return r}getClassName(){return"Mesh"}get _isMesh(){return!0}toString(e){let t=super.toString(e);if(t+=", n vertices: "+this.getTotalVertices(),t+=", parent: "+(this._waitingParentId?this._waitingParentId:this.parent?this.parent.name:"NONE"),this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);if(e)if(this._geometry){let i=this.getIndices(),r=this.getVerticesData(A.PositionKind);r&&i&&(t+=", flat shading: "+(r.length/3===i.length?"YES":"NO"))}else t+=", flat shading: UNKNOWN";return t}_unBindEffect(){super._unBindEffect();for(let e of this.instances)e._unBindEffect()}get hasLODLevels(){return this._internalMeshDataInfo._LODLevels.length>0}getLODLevels(){return this._internalMeshDataInfo._LODLevels}_sortLODLevels(){let e=this._internalMeshDataInfo._useLODScreenCoverage?-1:1;this._internalMeshDataInfo._LODLevels.sort((t,i)=>t.distanceOrScreenCoverage<i.distanceOrScreenCoverage?e:t.distanceOrScreenCoverage>i.distanceOrScreenCoverage?-e:0)}addLODLevel(e,t){if(t&&t._masterMesh)return P.Warn("You cannot use a mesh as LOD level twice"),this;let i=new o_(e,t);return this._internalMeshDataInfo._LODLevels.push(i),t&&(t._masterMesh=this),this._sortLODLevels(),this}getLODLevelAtDistance(e){let t=this._internalMeshDataInfo;for(let i=0;i<t._LODLevels.length;i++){let r=t._LODLevels[i];if(r.distanceOrScreenCoverage===e)return r.mesh}return null}removeLODLevel(e){let t=this._internalMeshDataInfo;for(let i=0;i<t._LODLevels.length;i++)t._LODLevels[i].mesh===e&&(t._LODLevels.splice(i,1),e&&(e._masterMesh=null));return this._sortLODLevels(),this}getLOD(e,t){let i=this._internalMeshDataInfo;if(!i._LODLevels||i._LODLevels.length===0)return this;let r=t||this.getBoundingInfo().boundingSphere,n=e.mode===ye.ORTHOGRAPHIC_CAMERA?e.minZ:r.centerWorld.subtract(e.globalPosition).length(),a=n,o=1;if(i._useLODScreenCoverage){let l=e.screenArea,c=r.radiusWorld*e.minZ/n;c=c*c*Math.PI,a=c/l,o=-1}if(o*i._LODLevels[i._LODLevels.length-1].distanceOrScreenCoverage>o*a)return this.onLODLevelSelection&&this.onLODLevelSelection(a,this,this),this;for(let l=0;l<i._LODLevels.length;l++){let c=i._LODLevels[l];if(o*c.distanceOrScreenCoverage<o*a){if(c.mesh){if(c.mesh.delayLoadState===4)return c.mesh._checkDelayState(),this;if(c.mesh.delayLoadState===2)return this;c.mesh._preActivate(),c.mesh._updateSubMeshesBoundingInfo(this.worldMatrixFromCache)}return this.onLODLevelSelection&&this.onLODLevelSelection(a,this,c.mesh),c.mesh}}return this.onLODLevelSelection&&this.onLODLevelSelection(a,this,this),this}get geometry(){return this._geometry}getTotalVertices(){return this._geometry===null||this._geometry===void 0?0:this._geometry.getTotalVertices()}getVerticesData(e,t,i,r){if(!this._geometry)return null;let n=r?void 0:this._userInstancedBuffersStorage?.vertexBuffers[e]?.getFloatData(this.instances.length+1,i||t&&this._geometry.meshes.length!==1);return n||(n=this._geometry.getVerticesData(e,t,i)),n}copyVerticesData(e,t){this._geometry&&this._geometry.copyVerticesData(e,t)}getVertexBuffer(e,t){return this._geometry?(t?void 0:this._userInstancedBuffersStorage?.vertexBuffers[e])??this._geometry.getVertexBuffer(e):null}isVerticesDataPresent(e,t){return this._geometry?!t&&this._userInstancedBuffersStorage?.vertexBuffers[e]!==void 0||this._geometry.isVerticesDataPresent(e):this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1}isVertexBufferUpdatable(e,t){if(!this._geometry)return this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1;if(!t){let i=this._userInstancedBuffersStorage?.vertexBuffers[e];if(i)return i.isUpdatable()}return this._geometry.isVertexBufferUpdatable(e)}getVerticesDataKinds(e){if(!this._geometry){let i=[];if(this._delayInfo)for(let r of this._delayInfo)i.push(r);return i}let t=this._geometry.getVerticesDataKinds();if(!e&&this._userInstancedBuffersStorage)for(let i in this._userInstancedBuffersStorage.vertexBuffers)t.indexOf(i)===-1&&t.push(i);return t}getTotalIndices(){return this._geometry?this._geometry.getTotalIndices():0}getIndices(e,t){return this._geometry?this._geometry.getIndices(e,t):[]}get isBlocked(){return this._masterMesh!==null&&this._masterMesh!==void 0}isReady(e=!1,t=!1){if(this.delayLoadState===2||!super.isReady(e))return!1;if(!this.subMeshes||this.subMeshes.length===0||!e)return!0;let i=this.getEngine(),r=this.getScene(),n=t||i.getCaps().instancedArrays&&(this.instances.length>0||this.hasThinInstances);this.computeWorldMatrix();let a=this.material||r.defaultMaterial;if(a){if(a._storeEffectOnSubMeshes)for(let l of this.subMeshes){let c=l.getMaterial();if(c){if(c._storeEffectOnSubMeshes){if(!c.isReadyForSubMesh(this,l,n))return!1}else if(!c.isReady(this,n))return!1}}else if(!a.isReady(this,n))return!1}let o=i.currentRenderPassId;for(let l of this.lightSources){let c=l.getShadowGenerators();if(!c)continue;let f=c.values();for(let h=f.next();h.done!==!0;h=f.next()){let u=h.value;if(u&&(!u.getShadowMap()?.renderList||u.getShadowMap()?.renderList&&u.getShadowMap()?.renderList?.indexOf(this)!==-1)){let p=u.getShadowMap().renderPassIds??[i.currentRenderPassId];for(let m=0;m<p.length;++m){i.currentRenderPassId=p[m];for(let _ of this.subMeshes)if(!u.isReady(_,n,_.getMaterial()?.needAlphaBlendingForMesh(this)??!1))return i.currentRenderPassId=o,!1}i.currentRenderPassId=o}}}for(let l of this._internalMeshDataInfo._LODLevels)if(l.mesh&&!l.mesh.isReady(n))return!1;return!0}get areNormalsFrozen(){return this._internalMeshDataInfo._areNormalsFrozen}freezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!0,this}unfreezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!1,this}set overridenInstanceCount(e){this._instanceDataStorage.overridenInstanceCount=e}_getInstanceDataStorage(){let e=this._instanceDataStorage.engine.isWebGPU?this._instanceDataStorage.engine.currentRenderPassId:0,t=this._instanceDataStorage.renderPasses[e];return t||(t=new lC,this._instanceDataStorage.renderPasses[e]=t),t}_preActivate(){let e=this._internalMeshDataInfo,t=this.getScene().getRenderId();return e._preActivateId===t?this:(e._preActivateId=t,this._getInstanceDataStorage().visibleInstances=null,this)}_preActivateForIntermediateRendering(e){let t=this._getInstanceDataStorage();return t.visibleInstances&&(t.visibleInstances.intermediateDefaultRenderId=e),this}_registerInstanceForRenderId(e,t){let i=this._getInstanceDataStorage();return i.visibleInstances||(i.visibleInstances={defaultRenderId:t,selfDefaultRenderId:this._renderId,intermediateDefaultRenderId:-1}),i.visibleInstances[t]||(i.previousRenderId!==void 0&&this._instanceDataStorage.isFrozen&&(i.visibleInstances[i.previousRenderId]=null),i.previousRenderId=t,i.visibleInstances[t]=new Array),i.visibleInstances[t].push(e),this}_afterComputeWorldMatrix(){super._afterComputeWorldMatrix(),this.hasThinInstances&&(this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1))}_postActivate(){this.edgesShareWithInstances&&this.edgesRenderer&&this.edgesRenderer.isEnabled&&this._renderingGroup&&(this._renderingGroup._edgesRenderers.pushNoDuplicate(this.edgesRenderer),this.edgesRenderer.customInstances.push(this.getWorldMatrix()))}refreshBoundingInfo(e=!1,t=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;let i;typeof e=="object"?i=e:i={applySkeleton:e,applyMorph:t};let r=this.geometry?this.geometry.boundingBias:null;return this._refreshBoundingInfo(this._getData(i,null,A.PositionKind),r),this}_createGlobalSubMesh(e){let t=this.getTotalVertices();if(!t||!this.getIndices())return null;if(this.subMeshes&&this.subMeshes.length>0){let i=this.getIndices();if(!i)return null;let r=i.length,n=!1;if(e)n=!0;else for(let a of this.subMeshes){if(a.indexStart+a.indexCount>r){n=!0;break}if(a.verticesStart+a.verticesCount>t){n=!0;break}}if(!n)return this.subMeshes[0]}return this.releaseSubMeshes(),new cr(0,0,t,0,this.getTotalIndices()||t,this)}subdivide(e){if(e<1)return;let t=this.getTotalIndices(),i=t/e|0,r=0;for(;i%3!==0;)i++;this.releaseSubMeshes();for(let n=0;n<e&&!(r>=t);n++)cr.CreateFromIndices(0,r,n===e-1?t-r:i,this,void 0,!1),r+=i;this.refreshBoundingInfo(),this.synchronizeInstances()}setVerticesData(e,t,i=!1,r){if(this._geometry)this._geometry.setVerticesData(e,t,i,r);else{let n=new Ge;n.set(t,e);let a=this.getScene();new mi(mi.RandomId(),a,n,i,this)}return this}removeVerticesData(e){this._geometry&&this._geometry.removeVerticesData(e)}markVerticesDataAsUpdatable(e,t=!0){let i=this.getVertexBuffer(e);!i||i.isUpdatable()===t||this.setVerticesData(e,this.getVerticesData(e),t)}setVerticesBuffer(e,t=!0){return this._geometry||(this._geometry=mi.CreateGeometryForMesh(this)),this._geometry.setVerticesBuffer(e,null,t),this}updateVerticesData(e,t,i,r){return this._geometry?(r?(this.makeGeometryUnique(),this.updateVerticesData(e,t,i,!1)):this._geometry.updateVerticesData(e,t,i),this):this}updateMeshPositions(e,t=!0){let i=this.getVerticesData(A.PositionKind);if(!i)return this;if(e(i),this.updateVerticesData(A.PositionKind,i,!1,!1),t){let r=this.getIndices(),n=this.getVerticesData(A.NormalKind);if(!n)return this;Ge.ComputeNormals(i,r,n),this.updateVerticesData(A.NormalKind,n,!1,!1)}return this}makeGeometryUnique(){if(!this._geometry)return this;if(this._geometry.meshes.length===1)return this;let e=this._geometry,t=this._geometry.copy(mi.RandomId());return e.releaseForMesh(this,!0),t.applyToMesh(this),this}setIndexBuffer(e,t,i,r=null){let n=this._geometry;n||(n=new mi(mi.RandomId(),this.getScene(),void 0,void 0,this)),n.setIndexBuffer(e,t,i,r)}setIndices(e,t=null,i=!1,r=!1){if(this._geometry)this._geometry.setIndices(e,t,i,r);else{let n=new Ge;n.indices=e;let a=this.getScene();new mi(mi.RandomId(),a,n,i,this)}return this}updateIndices(e,t,i=!1){return this._geometry?(this._geometry.updateIndices(e,t,i),this):this}toLeftHanded(){return this._geometry?(this._geometry.toLeftHanded(),this):this}_bind(e,t,i,r=!0){if(!this._geometry)return this;let n=this.getScene().getEngine(),a;if(this._unIndexed)switch(this._getRenderingFillMode(i)){case Q.WireFrameFillMode:a=e._getLinesIndexBuffer(this.getIndices(),n);break;default:a=null;break}else switch(this._getRenderingFillMode(i)){case Q.PointFillMode:a=null;break;case Q.WireFrameFillMode:a=e._getLinesIndexBuffer(this.getIndices(),n);break;default:case Q.TriangleFillMode:a=this._geometry.getIndexBuffer();break}return this._bindDirect(t,a,r)}_bindDirect(e,t,i=!0){if(!this._geometry)return this;if(this.morphTargetManager&&this.morphTargetManager.isUsingTextureForTargets&&this.morphTargetManager._bind(e),!i||!this._userInstancedBuffersStorage||this.hasThinInstances)this._geometry._bind(e,t);else{if(this._instanceDataStorage.engine.isWebGPU&&this._userInstancedBuffersStorage.renderPasses&&this._userInstancedBuffersStorage.renderPasses[this._instanceDataStorage.engine.currentRenderPassId]){let r=this._userInstancedBuffersStorage.renderPasses[this._instanceDataStorage.engine.currentRenderPassId];for(let n in r)this._userInstancedBuffersStorage.vertexBuffers[n]=r[n]}this._geometry._bind(e,t,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects)}return this}_draw(e,t,i){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;this._internalMeshDataInfo._onBeforeDrawObservable&&this._internalMeshDataInfo._onBeforeDrawObservable.notifyObservers(this);let n=this.getScene().getEngine(),a=n._currentMaterialContext,o=a&&a.useVertexPulling;return this._unIndexed&&t!==Q.WireFrameFillMode||t==Q.PointFillMode?n.drawArraysType(t,e.verticesStart,e.verticesCount,this.forcedInstanceCount||i):t==Q.WireFrameFillMode?n.drawElementsType(t,0,e._linesIndexCount,this.forcedInstanceCount||i):o?n.drawArraysType(t,e.indexStart,e.indexCount,this.forcedInstanceCount||i):n.drawElementsType(t,e.indexStart,e.indexCount,this.forcedInstanceCount||i),this}registerBeforeRender(e){return this.onBeforeRenderObservable.add(e),this}unregisterBeforeRender(e){return this.onBeforeRenderObservable.removeCallback(e),this}registerAfterRender(e){return this.onAfterRenderObservable.add(e),this}unregisterAfterRender(e){return this.onAfterRenderObservable.removeCallback(e),this}_getInstancesRenderList(e,t=!1){let i=this._getInstanceDataStorage();if(this._instanceDataStorage.isFrozen){if(t)return i.batchCacheReplacementModeInFrozenMode.hardwareInstancedRendering[e]=!1,i.batchCacheReplacementModeInFrozenMode.renderSelf[e]=!0,i.batchCacheReplacementModeInFrozenMode;if(i.previousBatch)return i.previousBatch}let r=this.getScene(),n=r._isInIntermediateRendering(),a=n?this._internalAbstractMeshDataInfo._onlyForInstancesIntermediate:this._internalAbstractMeshDataInfo._onlyForInstances,o=i.batchCache;if(o.mustReturn=!1,o.renderSelf[e]=t||!a&&this.isEnabled()&&this.isVisible,o.visibleInstances[e]=null,i.visibleInstances&&!t){let l=i.visibleInstances,c=r.getRenderId(),f=n?l.intermediateDefaultRenderId:l.defaultRenderId;o.visibleInstances[e]=l[c],!o.visibleInstances[e]&&f&&(o.visibleInstances[e]=l[f])}return o.hardwareInstancedRendering[e]=!t&&this._instanceDataStorage.hardwareInstancedRendering&&o.visibleInstances[e]!==null&&o.visibleInstances[e]!==void 0,i.previousBatch=o,o}_updateInstancedBuffers(e,t,i,r,n,a){let o=t.visibleInstances[e._id],l=o?o.length:0,c=t.parent,f=this._instanceDataStorage,h=c.instancesBuffer,u=c.instancesPreviousBuffer,d=0,p=0,m=t.renderSelf[e._id],_=!h||i!==c.instancesBufferSize||this._scene.needsPreviousWorldMatrices&&!c.instancesPreviousBuffer;if(!this._instanceDataStorage.manualUpdate&&(!f.isFrozen||_)){let v=this.getWorldMatrix();if(m&&(this._scene.needsPreviousWorldMatrices&&(f.masterMeshPreviousWorldMatrix?(f.masterMeshPreviousWorldMatrix.copyToArray(c.instancesPreviousData,d),f.masterMeshPreviousWorldMatrix.copyFrom(v)):(f.masterMeshPreviousWorldMatrix=v.clone(),f.masterMeshPreviousWorldMatrix.copyToArray(c.instancesPreviousData,d))),v.copyToArray(c.instancesData,d),d+=16,p++),o){if(s.INSTANCEDMESH_SORT_TRANSPARENT&&this._scene.activeCamera&&e.getMaterial()?.needAlphaBlendingForMesh(e.getRenderingMesh())){let T=this._scene.activeCamera.globalPosition;for(let C=0;C<o.length;C++){let I=o[C];I._distanceToCamera=E.Distance(I.getBoundingInfo().boundingSphere.centerWorld,T)}o.sort((C,I)=>C._distanceToCamera>I._distanceToCamera?-1:C._distanceToCamera<I._distanceToCamera?1:0)}for(let T=0;T<o.length;T++){let C=o[T],I=C.getWorldMatrix();I.copyToArray(c.instancesData,d),this._scene.needsPreviousWorldMatrices&&(C._previousWorldMatrix?(C._previousWorldMatrix.copyToArray(c.instancesPreviousData,d),C._previousWorldMatrix.copyFrom(I)):(C._previousWorldMatrix=I.clone(),C._previousWorldMatrix.copyToArray(c.instancesPreviousData,d))),d+=16,p++}}}else p=(m?1:0)+l;if(_){h&&h.dispose(),u&&u.dispose(),h=new Gr(r,c.instancesData,!0,16,!1,!0),c.instancesBuffer=h,this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0});let v;if(this._instanceDataStorage.engine.isWebGPU){this._userInstancedBuffersStorage.renderPasses||(this._userInstancedBuffersStorage.renderPasses={});let T=this._instanceDataStorage.engine.currentRenderPassId;v=this._userInstancedBuffersStorage.renderPasses[T],v||(this._userInstancedBuffersStorage.renderPasses[T]=v={})}else v=this._userInstancedBuffersStorage.vertexBuffers;v.world0=h.createVertexBuffer("world0",0,4),v.world1=h.createVertexBuffer("world1",4,4),v.world2=h.createVertexBuffer("world2",8,4),v.world3=h.createVertexBuffer("world3",12,4),this._scene.needsPreviousWorldMatrices&&(u=new Gr(r,c.instancesPreviousData,!0,16,!1,!0),c.instancesPreviousBuffer=u,v.previousWorld0=u.createVertexBuffer("previousWorld0",0,4),v.previousWorld1=u.createVertexBuffer("previousWorld1",4,4),v.previousWorld2=u.createVertexBuffer("previousWorld2",8,4),v.previousWorld3=u.createVertexBuffer("previousWorld3",12,4)),this._invalidateInstanceVertexArrayObject()}else(!this._instanceDataStorage.isFrozen||this._instanceDataStorage.forceMatrixUpdates)&&(h.updateDirectly(c.instancesData,0,p),this._scene.needsPreviousWorldMatrices&&(!this._instanceDataStorage.manualUpdate||this._instanceDataStorage.previousManualUpdate)&&u.updateDirectly(c.instancesPreviousData,0,p));this._processInstancedBuffers(o,m),a&&n!==void 0&&(this.getScene()._activeIndices.addCount(e.indexCount*p,!1),r._currentDrawContext&&(r._currentDrawContext.useInstancing=!0),this._bind(e,a,n),this._draw(e,n,p)),this._scene.needsPreviousWorldMatrices&&!_&&this._instanceDataStorage.manualUpdate&&(!this._instanceDataStorage.isFrozen||this._instanceDataStorage.forceMatrixUpdates)&&!this._instanceDataStorage.previousManualUpdate&&u.updateDirectly(c.instancesData,0,p)}_renderWithInstances(e,t,i,r,n){let a=i.visibleInstances[e._id],o=a?a.length:0,l=i.parent,c=l.instancesBufferSize,h=(o+1)*16*4;for(;l.instancesBufferSize<h;)l.instancesBufferSize*=2;return(!l.instancesData||c!=l.instancesBufferSize)&&(l.instancesData=new Float32Array(l.instancesBufferSize/4)),(this._scene.needsPreviousWorldMatrices&&!l.instancesPreviousData||c!=l.instancesBufferSize)&&(l.instancesPreviousData=new Float32Array(l.instancesBufferSize/4)),this._updateInstancedBuffers(e,i,c,n,t,r),n.unbindInstanceAttributes(),this}_renderWithThinInstances(e,t,i,r){let n=this._thinInstanceDataStorage?.instancesCount??0;this.getScene()._activeIndices.addCount(e.indexCount*n,!1),r._currentDrawContext&&(r._currentDrawContext.useInstancing=!0),this._bind(e,i,t),this._draw(e,t,n),this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&this._thinInstanceDataStorage.matrixData&&(this._thinInstanceDataStorage.previousMatrixBuffer?this._thinInstanceDataStorage.previousMatrixBuffer.updateDirectly(this._thinInstanceDataStorage.matrixData,0,n):this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.matrixData,!1)),r.unbindInstanceAttributes()}_processInstancedBuffers(e,t){}_processRendering(e,t,i,r,n,a,o,l){let c=this.getScene(),f=c.getEngine();if(r=this._getRenderingFillMode(r),a&&t.getRenderingMesh().hasThinInstances)return this._renderWithThinInstances(t,r,i,f),this;if(a)this._renderWithInstances(t,r,n,i,f);else{f._currentDrawContext&&(f._currentDrawContext.useInstancing=!1);let h=0;n.renderSelf[t._id]&&(o&&o(!1,e.getWorldMatrix(),l),h++,this._draw(t,r,this._instanceDataStorage.overridenInstanceCount));let u=n.visibleInstances[t._id];if(u){let d=u.length;h+=d;for(let p=0;p<d;p++){let _=u[p].getWorldMatrix();o&&o(!0,_,l),this._draw(t,r)}}c._activeIndices.addCount(t.indexCount*h,!1)}return this}_rebuild(e=!1){for(let t in this._instanceDataStorage.renderPasses){let i=this._instanceDataStorage.renderPasses[t];i.instancesBuffer&&(e&&i.instancesBuffer.dispose(),i.instancesBuffer=null)}if(this._userInstancedBuffersStorage){for(let t in this._userInstancedBuffersStorage.vertexBuffers){let i=this._userInstancedBuffersStorage.vertexBuffers[t];i&&(e&&i.dispose(),this._userInstancedBuffersStorage.vertexBuffers[t]=null)}this._userInstancedBuffersStorage.vertexArrayObjects&&(this._userInstancedBuffersStorage.vertexArrayObjects={})}this._internalMeshDataInfo._effectiveMaterial=null,super._rebuild(e)}_freeze(){if(this.subMeshes){for(let e=0;e<this.subMeshes.length;e++)this._getInstancesRenderList(e);this._internalMeshDataInfo._effectiveMaterial=null,this._instanceDataStorage.isFrozen=!0}}_unFreeze(){this._instanceDataStorage.isFrozen=!1;for(let e in this._instanceDataStorage.renderPasses){let t=this._instanceDataStorage.renderPasses[e];t.previousBatch=null}}renderWithRenderPassId(e,t,i,r,n=!0){let a=this._scene.getEngine(),o=a.currentRenderPassId;if(e!==void 0&&(a.currentRenderPassId=e),r)(!n||n&&r.isInFrustum(this._scene._frustumPlanes))&&this.render(r,!!t,i);else for(let l=0;l<this.subMeshes.length;l++){let c=this.subMeshes[l];(!n||n&&c.isInFrustum(this._scene._frustumPlanes))&&this.render(c,!!t,i)}return e!==void 0&&(a.currentRenderPassId=o),this}directRender(){if(!this.subMeshes)return this;for(let e of this.subMeshes)this.render(e,!1);return this}render(e,t,i){let r=this.getScene();this._internalAbstractMeshDataInfo._isActiveIntermediate?this._internalAbstractMeshDataInfo._isActiveIntermediate=!1:this._internalAbstractMeshDataInfo._isActive=!1;let n=r.activeCameras?.length??0;if((n>1&&r.activeCamera===r.activeCameras[0]||n<=1)&&this._checkOcclusionQuery()&&!this._occlusionDataStorage.forceRenderingWhenOccluded)return this;let o=this._getInstancesRenderList(e._id,!!i);if(o.mustReturn)return this;if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;let l=r.getEngine(),c=0,f=null;this.ignoreCameraMaxZ&&r.activeCamera&&!r._isInIntermediateRendering()&&(c=r.activeCamera.maxZ,f=r.activeCamera,r.activeCamera.maxZ=0,r.updateTransformMatrix(!0)),this._internalMeshDataInfo._onBeforeRenderObservable&&this._internalMeshDataInfo._onBeforeRenderObservable.notifyObservers(this);let h=e.getRenderingMesh(),u=o.hardwareInstancedRendering[e._id]||h.hasThinInstances||!!this._userInstancedBuffersStorage&&!e.getMesh()._internalAbstractMeshDataInfo._actAsRegularMesh,d=this._instanceDataStorage,p=e.getMaterial();if(!p)return f&&(f.maxZ=c,r.updateTransformMatrix(!0)),this;if(!d.isFrozen||!this._internalMeshDataInfo._effectiveMaterial||this._internalMeshDataInfo._effectiveMaterial!==p){if(p._storeEffectOnSubMeshes){if(!p.isReadyForSubMesh(this,e,u))return f&&(f.maxZ=c,r.updateTransformMatrix(!0)),this}else if(!p.isReady(this,u))return f&&(f.maxZ=c,r.updateTransformMatrix(!0)),this;this._internalMeshDataInfo._effectiveMaterial=p}else if(p._storeEffectOnSubMeshes&&!e._drawWrapper?._wasPreviouslyReady||!p._storeEffectOnSubMeshes&&!p._getDrawWrapper()._wasPreviouslyReady)return f&&(f.maxZ=c,r.updateTransformMatrix(!0)),this;if(t){let M=this._internalMeshDataInfo._effectiveMaterial;if(M.alphaModes.length===1)l.setAlphaMode(M.alphaMode);else for(let F=0;F<M.alphaModes.length;F++){let U=M.alphaModes[F];l.setAlphaMode(U!==void 0?U:2,!1,F)}}let m;this._internalMeshDataInfo._effectiveMaterial._storeEffectOnSubMeshes?m=e._drawWrapper:m=this._internalMeshDataInfo._effectiveMaterial._getDrawWrapper();let _=m?.effect??null;for(let M of r._beforeRenderingMeshStage)M.action(this,e,o,_);if(!m||!_)return f&&(f.maxZ=c,r.updateTransformMatrix(!0)),this;let v=i||this,T;if(!d.isFrozen&&(this._internalMeshDataInfo._effectiveMaterial.backFaceCulling||this._internalMeshDataInfo._effectiveMaterial.sideOrientation!==null||this._internalMeshDataInfo._effectiveMaterial.twoSidedLighting)){let M=v._getWorldMatrixDeterminant();T=this._internalMeshDataInfo._effectiveMaterial._getEffectiveOrientation(this),M<0&&(T=T===Q.ClockWiseSideOrientation?Q.CounterClockWiseSideOrientation:Q.ClockWiseSideOrientation),this._internalMeshDataInfo._effectiveSideOrientation=T}else T=this._internalMeshDataInfo._effectiveSideOrientation;let C=this._internalMeshDataInfo._effectiveMaterial._preBind(m,this._internalMeshDataInfo._effectiveSideOrientation);this._internalMeshDataInfo._effectiveMaterial.forceDepthWrite&&l.setDepthWrite(!0);let I=this._internalMeshDataInfo._effectiveMaterial,R=I.fillMode;this._internalMeshDataInfo._onBeforeBindObservable&&this._internalMeshDataInfo._onBeforeBindObservable.notifyObservers(this),u||this._bind(e,_,R,!1);let b=v.getWorldMatrix();I._storeEffectOnSubMeshes?I.bindForSubMesh(b,this,e):I.bind(b,this),!I.backFaceCulling&&I.separateCullingPass&&(l.setState(!0,I.zOffset,!1,!C,I.cullBackFaces,I.stencil,I.zOffsetUnits),this._processRendering(this,e,_,R,o,u,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),l.setState(!0,I.zOffset,!1,C,I.cullBackFaces,I.stencil,I.zOffsetUnits),this._internalMeshDataInfo._onBetweenPassObservable&&this._internalMeshDataInfo._onBetweenPassObservable.notifyObservers(e)),this._processRendering(this,e,_,R,o,u,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),this._internalMeshDataInfo._effectiveMaterial.unbind();for(let M of r._afterRenderingMeshStage)M.action(this,e,o,_);return this._internalMeshDataInfo._onAfterRenderObservable&&this._internalMeshDataInfo._onAfterRenderObservable.notifyObservers(this),f&&(f.maxZ=c,r.updateTransformMatrix(!0)),r.performancePriority===2&&!d.isFrozen&&this._freeze(),this}cleanMatrixWeights(){this.isVerticesDataPresent(A.MatricesWeightsKind)&&(this.isVerticesDataPresent(A.MatricesWeightsExtraKind)?this._normalizeSkinWeightsAndExtra():this._normalizeSkinFourWeights())}_normalizeSkinFourWeights(){let e=this.getVerticesData(A.MatricesWeightsKind),t=e.length;for(let i=0;i<t;i+=4){let r=e[i]+e[i+1]+e[i+2]+e[i+3];if(r===0)e[i]=1;else{let n=1/r;e[i]*=n,e[i+1]*=n,e[i+2]*=n,e[i+3]*=n}}this.setVerticesData(A.MatricesWeightsKind,e)}_normalizeSkinWeightsAndExtra(){let e=this.getVerticesData(A.MatricesWeightsExtraKind),t=this.getVerticesData(A.MatricesWeightsKind),i=t.length;for(let r=0;r<i;r+=4){let n=t[r]+t[r+1]+t[r+2]+t[r+3];if(n+=e[r]+e[r+1]+e[r+2]+e[r+3],n===0)t[r]=1;else{let a=1/n;t[r]*=a,t[r+1]*=a,t[r+2]*=a,t[r+3]*=a,e[r]*=a,e[r+1]*=a,e[r+2]*=a,e[r+3]*=a}}this.setVerticesData(A.MatricesWeightsKind,t),this.setVerticesData(A.MatricesWeightsKind,e)}validateSkinning(){let e=this.getVerticesData(A.MatricesWeightsExtraKind),t=this.getVerticesData(A.MatricesWeightsKind);if(t===null||this.skeleton==null)return{skinned:!1,valid:!0,report:"not skinned"};let i=t.length,r=0,n=0,a=0,o=0,l=e===null?4:8,c=[];for(let _=0;_<=l;_++)c[_]=0;let f=.001;for(let _=0;_<i;_+=4){let v=t[_],T=v,C=T===0?0:1;for(let I=1;I<l;I++){let R=I<4?t[_+I]:e[_+I-4];R>v&&r++,R!==0&&C++,T+=R,v=R}if(c[C]++,C>a&&(a=C),T===0)n++;else{let I=1/T,R=0;for(let b=0;b<l;b++)b<4?R+=Math.abs(t[_+b]-t[_+b]*I):R+=Math.abs(e[_+b-4]-e[_+b-4]*I);R>f&&o++}}let h=this.skeleton.bones.length,u=this.getVerticesData(A.MatricesIndicesKind),d=this.getVerticesData(A.MatricesIndicesExtraKind),p=0;for(let _=0;_<i;_+=4)for(let v=0;v<l;v++){let T=v<4?u[_+v]:d[_+v-4];(T>=h||T<0)&&p++}let m="Number of Weights = "+i/4+`
Maximum influences = `+a+`
Missing Weights = `+n+`
Not Sorted = `+r+`
Not Normalized = `+o+`
WeightCounts = [`+c+`]
Number of bones = `+h+`
Bad Bone Indices = `+p;return{skinned:!0,valid:n===0&&o===0&&p===0,report:m}}_checkDelayState(){let e=this.getScene();return this._geometry?this._geometry.load(e):this.delayLoadState===4&&(this.delayLoadState=2,this._queueLoad(e)),this}_queueLoad(e){e.addPendingData(this);let t=this.delayLoadingFile.indexOf(".babylonbinarymeshdata")!==-1;return W.LoadFile(this.delayLoadingFile,i=>{i instanceof ArrayBuffer?this._delayLoadingFunction(i,this):this._delayLoadingFunction(JSON.parse(i),this);for(let r of this.instances)r.refreshBoundingInfo(),r._syncSubMeshes();this.delayLoadState=1,e.removePendingData(this)},()=>{},e.offlineProvider,t),this}isInFrustum(e){return this.delayLoadState===2||!super.isInFrustum(e)?!1:(this._checkDelayState(),!0)}setMaterialById(e){let t=this.getScene().materials,i;for(i=t.length-1;i>-1;i--)if(t[i].id===e)return this.material=t[i],this;let r=this.getScene().multiMaterials;for(i=r.length-1;i>-1;i--)if(r[i].id===e)return this.material=r[i],this;return this}getAnimatables(){let e=[];return this.material&&e.push(this.material),this.skeleton&&e.push(this.skeleton),e}bakeTransformIntoVertices(e){if(!this.isVerticesDataPresent(A.PositionKind))return this;let t=this.subMeshes.splice(0);this._resetPointsArrayCache();let i=this.getVerticesData(A.PositionKind),r=E.Zero(),n;for(n=0;n<i.length;n+=3)E.TransformCoordinatesFromFloatsToRef(i[n],i[n+1],i[n+2],e,r).toArray(i,n);if(this.setVerticesData(A.PositionKind,i,this.getVertexBuffer(A.PositionKind).isUpdatable()),this.isVerticesDataPresent(A.NormalKind)){for(i=this.getVerticesData(A.NormalKind),n=0;n<i.length;n+=3)E.TransformNormalFromFloatsToRef(i[n],i[n+1],i[n+2],e,r).normalize().toArray(i,n);this.setVerticesData(A.NormalKind,i,this.getVertexBuffer(A.NormalKind).isUpdatable())}if(this.isVerticesDataPresent(A.TangentKind)){for(i=this.getVerticesData(A.TangentKind),n=0;n<i.length;n+=4)E.TransformNormalFromFloatsToRef(i[n],i[n+1],i[n+2],e,r).normalize().toArray(i,n);this.setVerticesData(A.TangentKind,i,this.getVertexBuffer(A.TangentKind).isUpdatable())}return e.determinant()<0&&this.flipFaces(),this.releaseSubMeshes(),this.subMeshes=t,this}bakeCurrentTransformIntoVertices(e=!0,t=!1){return t&&this.makeGeometryUnique(),this.bakeTransformIntoVertices(this.computeWorldMatrix(!0)),this.resetLocalMatrix(e),this}get _positions(){return this._internalAbstractMeshDataInfo._positions||this._geometry&&this._geometry._positions||null}_resetPointsArrayCache(){return this._geometry&&this._geometry._resetPointsArrayCache(),this}_generatePointsArray(){return this._geometry?this._geometry._generatePointsArray():!1}clone(e="",t=null,i,r=!0){if(t&&t._addToSceneRootNodes===void 0){let n=t;return Xn.source=this,Xn.doNotCloneChildren=n.doNotCloneChildren,Xn.clonePhysicsImpostor=n.clonePhysicsImpostor,Xn.cloneThinInstances=n.cloneThinInstances,new s(e,this.getScene(),Xn)}return new s(e,this.getScene(),t,this,i,r)}dispose(e,t=!1){this.morphTargetManager=null,this._geometry&&this._geometry.releaseForMesh(this,!0);let i=this._internalMeshDataInfo;if(i._onBeforeDrawObservable&&i._onBeforeDrawObservable.clear(),i._onBeforeBindObservable&&i._onBeforeBindObservable.clear(),i._onBeforeRenderObservable&&i._onBeforeRenderObservable.clear(),i._onAfterRenderObservable&&i._onAfterRenderObservable.clear(),i._onBetweenPassObservable&&i._onBetweenPassObservable.clear(),this._scene.useClonedMeshMap){if(i.meshMap)for(let r in i.meshMap){let n=i.meshMap[r];n&&(n._internalMeshDataInfo._source=null,i.meshMap[r]=void 0)}i._source&&i._source._internalMeshDataInfo.meshMap&&(i._source._internalMeshDataInfo.meshMap[this.uniqueId]=void 0)}else{let r=this.getScene().meshes;for(let n of r){let a=n;a._internalMeshDataInfo&&a._internalMeshDataInfo._source&&a._internalMeshDataInfo._source===this&&(a._internalMeshDataInfo._source=null)}}i._source=null,this._disposeInstanceSpecificData(),this._disposeThinInstanceSpecificData(),this._internalMeshDataInfo._checkReadinessObserver&&this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),super.dispose(e,t)}_disposeInstanceSpecificData(){}_disposeThinInstanceSpecificData(){}_invalidateInstanceVertexArrayObject(){}applyDisplacementMap(e,t,i,r,n,a,o=!1,l){let c=this.getScene(),f=h=>{let u=h.width,d=h.height,m=this.getEngine().createCanvas(u,d).getContext("2d");m.drawImage(h,0,0);let _=m.getImageData(0,0,u,d).data;this.applyDisplacementMapFromBuffer(_,u,d,t,i,n,a,o),r&&r(this)};return W.LoadImage(e,f,l||(()=>{}),c.offlineProvider),this}applyDisplacementMapFromBuffer(e,t,i,r,n,a,o,l=!1){if(!this.isVerticesDataPresent(A.PositionKind)||!this.isVerticesDataPresent(A.NormalKind)||!this.isVerticesDataPresent(A.UVKind))return P.Warn("Cannot call applyDisplacementMap: Given mesh is not complete. Position, Normal or UV are missing"),this;let c=this.getVerticesData(A.PositionKind,!0,!0),f=this.getVerticesData(A.NormalKind),h=this.getVerticesData(A.UVKind),u=E.Zero(),d=E.Zero(),p=he.Zero();a=a||he.Zero(),o=o||new he(1,1);for(let m=0;m<c.length;m+=3){E.FromArrayToRef(c,m,u),E.FromArrayToRef(f,m,d),he.FromArrayToRef(h,m/3*2,p);let _=Math.abs(p.x*o.x+a.x%1)*(t-1)%t|0,v=Math.abs(p.y*o.y+a.y%1)*(i-1)%i|0,T=(_+v*t)*4,C=e[T]/255,I=e[T+1]/255,R=e[T+2]/255,b=C*.3+I*.59+R*.11;d.normalize(),d.scaleInPlace(r+(n-r)*b),u=u.add(d),u.toArray(c,m)}return Ge.ComputeNormals(c,this.getIndices(),f),l?(this.setVerticesData(A.PositionKind,c),this.setVerticesData(A.NormalKind,f),this.setVerticesData(A.UVKind,h)):(this.updateVerticesData(A.PositionKind,c),this.updateVerticesData(A.NormalKind,f)),this}_getFlattenedNormals(e,t){let i=new Float32Array(e.length*3),r=0,n=this.sideOrientation===(this._scene.useRightHandedSystem?1:0);for(let a=0;a<e.length;a+=3){let o=E.FromArray(t,e[a]*3),l=E.FromArray(t,e[a+1]*3),c=E.FromArray(t,e[a+2]*3),f=o.subtract(l),h=c.subtract(l),u=E.Normalize(E.Cross(f,h));n&&u.scaleInPlace(-1);for(let d=0;d<3;d++)i[r++]=u.x,i[r++]=u.y,i[r++]=u.z}return i}_convertToUnIndexedMesh(e=!1){let t=this.getVerticesDataKinds().filter(l=>!this.getVertexBuffer(l)?.getIsInstanced()),i=this.getIndices(),r={},n=(l,c)=>{let f=new Float32Array(i.length*c),h=0;for(let u=0;u<i.length;u++)for(let d=0;d<c;d++)f[h++]=l[i[u]*c+d];return f},a=this.getBoundingInfo(),o=this.geometry?this.subMeshes.slice(0):[];for(let l of t)r[l]=this.getVerticesData(l);for(let l of t){let c=this.getVertexBuffer(l),f=c.getSize();if(e&&l===A.NormalKind){let h=this._getFlattenedNormals(i,r[A.PositionKind]);this.setVerticesData(A.NormalKind,h,c.isUpdatable(),f)}else this.setVerticesData(l,n(r[l],f),c.isUpdatable(),f)}if(this.morphTargetManager){for(let l=0;l<this.morphTargetManager.numTargets;l++){let c=this.morphTargetManager.getTarget(l),f=c.getPositions();c.setPositions(n(f,3));let h=c.getNormals();h&&c.setNormals(e?this._getFlattenedNormals(i,f):n(h,3));let u=c.getTangents();u&&c.setTangents(n(u,3));let d=c.getUVs();d&&c.setUVs(n(d,2));let p=c.getColors();p&&c.setColors(n(p,4))}this.morphTargetManager.synchronize()}for(let l=0;l<i.length;l++)i[l]=l;this.setIndices(i),this._unIndexed=!0,this.releaseSubMeshes();for(let l of o){let c=l.getBoundingInfo();cr.AddToMesh(l.materialIndex,l.indexStart,l.indexCount,l.indexStart,l.indexCount,this).setBoundingInfo(c)}return this.setBoundingInfo(a),this.synchronizeInstances(),this}convertToFlatShadedMesh(){return this._convertToUnIndexedMesh(!0)}convertToUnIndexedMesh(){return this._convertToUnIndexedMesh()}flipFaces(e=!1){let t=Ge.ExtractFromMesh(this),i;if(e&&this.isVerticesDataPresent(A.NormalKind)&&t.normals){for(i=0;i<t.normals.length;i++)t.normals[i]*=-1;this.setVerticesData(A.NormalKind,t.normals,this.isVertexBufferUpdatable(A.NormalKind))}if(t.indices){let r;for(i=0;i<t.indices.length;i+=3)r=t.indices[i+1],t.indices[i+1]=t.indices[i+2],t.indices[i+2]=r;this.setIndices(t.indices,null,this.isVertexBufferUpdatable(A.PositionKind),!0)}return this}increaseVertices(e=1){let t=Ge.ExtractFromMesh(this),i=t.indices&&!Array.isArray(t.indices)&&Array.from?Array.from(t.indices):t.indices,r=t.positions&&!Array.isArray(t.positions)&&Array.from?Array.from(t.positions):t.positions,n=t.uvs&&!Array.isArray(t.uvs)&&Array.from?Array.from(t.uvs):t.uvs,a=t.normals&&!Array.isArray(t.normals)&&Array.from?Array.from(t.normals):t.normals;if(!i||!r)P.Warn("Couldn't increase number of vertices : VertexData must contain at least indices and positions");else{t.indices=i,t.positions=r,n&&(t.uvs=n),a&&(t.normals=a);let o=e+1,l=[];for(let R=0;R<o+1;R++)l[R]=[];let c,f,h=new E(0,0,0),u=new E(0,0,0),d=new he(0,0),p=[],m=[],_=[],v,T=r.length,C;n&&(C=n.length);let I;a&&(I=a.length);for(let R=0;R<i.length;R+=3){m[0]=i[R],m[1]=i[R+1],m[2]=i[R+2];for(let b=0;b<3;b++)if(c=m[b],f=m[(b+1)%3],_[c]===void 0&&_[f]===void 0?(_[c]=[],_[f]=[]):(_[c]===void 0&&(_[c]=[]),_[f]===void 0&&(_[f]=[])),_[c][f]===void 0&&_[f][c]===void 0){_[c][f]=[],h.x=(r[3*f]-r[3*c])/o,h.y=(r[3*f+1]-r[3*c+1])/o,h.z=(r[3*f+2]-r[3*c+2])/o,a&&(u.x=(a[3*f]-a[3*c])/o,u.y=(a[3*f+1]-a[3*c+1])/o,u.z=(a[3*f+2]-a[3*c+2])/o),n&&(d.x=(n[2*f]-n[2*c])/o,d.y=(n[2*f+1]-n[2*c+1])/o),_[c][f].push(c);for(let M=1;M<o;M++)_[c][f].push(r.length/3),r[T++]=r[3*c]+M*h.x,r[T++]=r[3*c+1]+M*h.y,r[T++]=r[3*c+2]+M*h.z,a&&(a[I++]=a[3*c]+M*u.x,a[I++]=a[3*c+1]+M*u.y,a[I++]=a[3*c+2]+M*u.z),n&&(n[C++]=n[2*c]+M*d.x,n[C++]=n[2*c+1]+M*d.y);_[c][f].push(f),_[f][c]=[],v=_[c][f].length;for(let M=0;M<v;M++)_[f][c][M]=_[c][f][v-1-M]}l[0][0]=i[R],l[1][0]=_[i[R]][i[R+1]][1],l[1][1]=_[i[R]][i[R+2]][1];for(let b=2;b<o;b++){l[b][0]=_[i[R]][i[R+1]][b],l[b][b]=_[i[R]][i[R+2]][b],h.x=(r[3*l[b][b]]-r[3*l[b][0]])/b,h.y=(r[3*l[b][b]+1]-r[3*l[b][0]+1])/b,h.z=(r[3*l[b][b]+2]-r[3*l[b][0]+2])/b,a&&(u.x=(a[3*l[b][b]]-a[3*l[b][0]])/b,u.y=(a[3*l[b][b]+1]-a[3*l[b][0]+1])/b,u.z=(a[3*l[b][b]+2]-a[3*l[b][0]+2])/b),n&&(d.x=(n[2*l[b][b]]-n[2*l[b][0]])/b,d.y=(n[2*l[b][b]+1]-n[2*l[b][0]+1])/b);for(let M=1;M<b;M++)l[b][M]=r.length/3,r[T++]=r[3*l[b][0]]+M*h.x,r[T++]=r[3*l[b][0]+1]+M*h.y,r[T++]=r[3*l[b][0]+2]+M*h.z,a&&(a[I++]=a[3*l[b][0]]+M*u.x,a[I++]=a[3*l[b][0]+1]+M*u.y,a[I++]=a[3*l[b][0]+2]+M*u.z),n&&(n[C++]=n[2*l[b][0]]+M*d.x,n[C++]=n[2*l[b][0]+1]+M*d.y)}l[o]=_[i[R+1]][i[R+2]],p.push(l[0][0],l[1][0],l[1][1]);for(let b=1;b<o;b++){let M;for(M=0;M<b;M++)p.push(l[b][M],l[b+1][M],l[b+1][M+1]),p.push(l[b][M],l[b+1][M+1],l[b][M+1]);p.push(l[b][M],l[b+1][M],l[b+1][M+1])}}t.indices=p,t.applyToMesh(this,this.isVertexBufferUpdatable(A.PositionKind))}}forceSharedVertices(){let e=Ge.ExtractFromMesh(this),t=e.uvs,i=e.indices,r=e.positions,n=e.colors,a=e.matricesIndices,o=e.matricesWeights,l=e.matricesIndicesExtra,c=e.matricesWeightsExtra;if(i===void 0||r===void 0||i===null||r===null)P.Warn("VertexData contains empty entries");else{let f=[],h=[],u=[],d=[],p=[],m=[],_=[],v=[],T=[],C=0,I={},R,b;for(let F=0;F<i.length;F+=3){b=[i[F],i[F+1],i[F+2]],T=[];for(let U=0;U<3;U++){T[U]="";for(let D=0;D<3;D++)Math.abs(r[3*b[U]+D])<1e-8&&(r[3*b[U]+D]=0),T[U]+=r[3*b[U]+D]+"|"}if(!(T[0]==T[1]||T[0]==T[2]||T[1]==T[2]))for(let U=0;U<3;U++){if(R=I[T[U]],R===void 0){I[T[U]]=C,R=C++;for(let D=0;D<3;D++)f.push(r[3*b[U]+D]);if(n!=null)for(let D=0;D<4;D++)d.push(n[4*b[U]+D]);if(t!=null)for(let D=0;D<2;D++)u.push(t[2*b[U]+D]);if(a!=null)for(let D=0;D<4;D++)p.push(a[4*b[U]+D]);if(o!=null)for(let D=0;D<4;D++)m.push(o[4*b[U]+D]);if(l!=null)for(let D=0;D<4;D++)_.push(l[4*b[U]+D]);if(c!=null)for(let D=0;D<4;D++)v.push(c[4*b[U]+D])}h.push(R)}}let M=[];Ge.ComputeNormals(f,h,M),e.positions=f,e.indices=h,e.normals=M,t!=null&&(e.uvs=u),n!=null&&(e.colors=d),a!=null&&(e.matricesIndices=p),o!=null&&(e.matricesWeights=m),l!=null&&(e.matricesIndicesExtra=_),o!=null&&(e.matricesWeightsExtra=v),e.applyToMesh(this,this.isVertexBufferUpdatable(A.PositionKind))}}static _instancedMeshFactory(e,t){throw pe("InstancedMesh")}static _PhysicsImpostorParser(e,t,i){throw pe("PhysicsImpostor")}createInstance(e){let t=s._instancedMeshFactory(e,this);return t.parent=this.parent,t}synchronizeInstances(){for(let e=0;e<this.instances.length;e++)this.instances[e]._syncSubMeshes();return this}optimizeIndices(e){let t=this.getIndices(),i=this.getVerticesData(A.PositionKind);if(!i||!t)return this;let r=[];for(let a=0;a<i.length;a=a+3)r.push(E.FromArray(i,a));let n=[];return e_.SyncAsyncForLoop(r.length,40,a=>{let o=r.length-1-a,l=r[o];for(let c=0;c<o;++c){let f=r[c];if(l.equals(f)){n[o]=c;break}}},()=>{for(let o=0;o<t.length;++o)t[o]=n[t[o]]||t[o];let a=this.subMeshes.slice(0);this.setIndices(t),this.subMeshes=a,e&&e(this)}),this}serialize(e={}){e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,e.type=this.getClassName(),st&&st.HasTags(this)&&(e.tags=st.GetTags(this)),e.position=this.position.asArray(),this.rotationQuaternion?e.rotationQuaternion=this.rotationQuaternion.asArray():this.rotation&&(e.rotation=this.rotation.asArray()),e.scaling=this.scaling.asArray(),this._postMultiplyPivotMatrix?e.pivotMatrix=this.getPivotMatrix().asArray():e.localMatrix=this.getPivotMatrix().asArray(),e.isEnabled=this.isEnabled(!1),e.isVisible=this.isVisible,e.infiniteDistance=this.infiniteDistance,e.pickable=this.isPickable,e.receiveShadows=this.receiveShadows,e.billboardMode=this.billboardMode,e.visibility=this.visibility,e.alwaysSelectAsActiveMesh=this.alwaysSelectAsActiveMesh,e.checkCollisions=this.checkCollisions,e.ellipsoid=this.ellipsoid.asArray(),e.ellipsoidOffset=this.ellipsoidOffset.asArray(),e.doNotSyncBoundingInfo=this.doNotSyncBoundingInfo,e.isBlocker=this.isBlocker,e.sideOrientation=this.sideOrientation,this.parent&&this.parent._serializeAsParent(e),e.isUnIndexed=this.isUnIndexed;let t=this._geometry;if(t&&this.subMeshes){e.geometryUniqueId=t.uniqueId,e.geometryId=t.id,e.subMeshes=[];for(let i=0;i<this.subMeshes.length;i++){let r=this.subMeshes[i];e.subMeshes.push({materialIndex:r.materialIndex,verticesStart:r.verticesStart,verticesCount:r.verticesCount,indexStart:r.indexStart,indexCount:r.indexCount})}}if(this.material?this.material.doNotSerialize||(e.materialUniqueId=this.material.uniqueId,e.materialId=this.material.id):(this.material=null,e.materialUniqueId=this._scene.defaultMaterial.uniqueId,e.materialId=this._scene.defaultMaterial.id),this.morphTargetManager&&(e.morphTargetManagerId=this.morphTargetManager.uniqueId),this.skeleton&&(e.skeletonId=this.skeleton.id,e.numBoneInfluencers=this.numBoneInfluencers),this.getScene()._getComponent(ne.NAME_PHYSICSENGINE)){let i=this.getPhysicsImpostor();i&&(e.physicsMass=i.getParam("mass"),e.physicsFriction=i.getParam("friction"),e.physicsRestitution=i.getParam("mass"),e.physicsImpostor=i.type)}this.metadata&&(e.metadata=this.metadata),e.instances=[];for(let i=0;i<this.instances.length;i++){let r=this.instances[i];if(r.doNotSerialize)continue;let n={name:r.name,id:r.id,isEnabled:r.isEnabled(!1),isVisible:r.isVisible,isPickable:r.isPickable,checkCollisions:r.checkCollisions,position:r.position.asArray(),scaling:r.scaling.asArray()};if(r.parent&&r.parent._serializeAsParent(n),r.rotationQuaternion?n.rotationQuaternion=r.rotationQuaternion.asArray():r.rotation&&(n.rotation=r.rotation.asArray()),this.getScene()._getComponent(ne.NAME_PHYSICSENGINE)){let a=r.getPhysicsImpostor();a&&(n.physicsMass=a.getParam("mass"),n.physicsFriction=a.getParam("friction"),n.physicsRestitution=a.getParam("mass"),n.physicsImpostor=a.type)}r.metadata&&(n.metadata=r.metadata),r.actionManager&&(n.actions=r.actionManager.serialize(r.name)),e.instances.push(n),_e.AppendSerializedAnimations(r,n),n.ranges=r.serializeAnimationRanges()}if(this._thinInstanceDataStorage.instancesCount&&this._thinInstanceDataStorage.matrixData&&(e.thinInstances={instancesCount:this._thinInstanceDataStorage.instancesCount,matrixData:Array.from(this._thinInstanceDataStorage.matrixData),matrixBufferSize:this._thinInstanceDataStorage.matrixBufferSize,enablePicking:this.thinInstanceEnablePicking},this._userThinInstanceBuffersStorage)){let i={data:{},sizes:{},strides:{}};for(let r in this._userThinInstanceBuffersStorage.data)i.data[r]=Array.from(this._userThinInstanceBuffersStorage.data[r]),i.sizes[r]=this._userThinInstanceBuffersStorage.sizes[r],i.strides[r]=this._userThinInstanceBuffersStorage.strides[r];e.thinInstances.userThinInstance=i}return _e.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.layerMask=this.layerMask,e.alphaIndex=this.alphaIndex,e.hasVertexAlpha=this.hasVertexAlpha,e.overlayAlpha=this.overlayAlpha,e.overlayColor=this.overlayColor.asArray(),e.renderOverlay=this.renderOverlay,e.applyFog=this.applyFog,this.actionManager&&(e.actions=this.actionManager.serialize(this.name)),e}_syncGeometryWithMorphTargetManager(){if(!this.geometry)return;this._markSubMeshesAsAttributesDirty();let e=this._internalAbstractMeshDataInfo._morphTargetManager;if(e&&e.vertexCount){if(e.vertexCount!==this.getTotalVertices()){P.Error("Mesh is incompatible with morph targets. Targets and mesh must all have the same vertices count."),this.morphTargetManager=null;return}if(e.isUsingTextureForTargets)return;for(let t=0;t<e.numInfluencers;t++){let i=e.getActiveTarget(t),r=i.getPositions();if(!r){P.Error("Invalid morph target. Target must have positions.");return}this.geometry.setVerticesData(A.PositionKind+t,r,!1,3);let n=i.getNormals();n&&this.geometry.setVerticesData(A.NormalKind+t,n,!1,3);let a=i.getTangents();a&&this.geometry.setVerticesData(A.TangentKind+t,a,!1,3);let o=i.getUVs();o&&this.geometry.setVerticesData(A.UVKind+"_"+t,o,!1,2);let l=i.getUV2s();l&&this.geometry.setVerticesData(A.UV2Kind+"_"+t,l,!1,2);let c=i.getColors();c&&this.geometry.setVerticesData(A.ColorKind+t,c,!1,4)}}else{let t=0;for(;this.geometry.isVerticesDataPresent(A.PositionKind+t);)this.geometry.removeVerticesData(A.PositionKind+t),this.geometry.isVerticesDataPresent(A.NormalKind+t)&&this.geometry.removeVerticesData(A.NormalKind+t),this.geometry.isVerticesDataPresent(A.TangentKind+t)&&this.geometry.removeVerticesData(A.TangentKind+t),this.geometry.isVerticesDataPresent(A.UVKind+t)&&this.geometry.removeVerticesData(A.UVKind+"_"+t),this.geometry.isVerticesDataPresent(A.UV2Kind+t)&&this.geometry.removeVerticesData(A.UV2Kind+"_"+t),this.geometry.isVerticesDataPresent(A.ColorKind+t)&&this.geometry.removeVerticesData(A.ColorKind+t),t++}}static Parse(e,t,i){let r;if(e.type&&e.type==="LinesMesh"?r=s._LinesMeshParser(e,t):e.type&&e.type==="GroundMesh"?r=s._GroundMeshParser(e,t):e.type&&e.type==="GoldbergMesh"?r=s._GoldbergMeshParser(e,t):e.type&&e.type==="GreasedLineMesh"?r=s._GreasedLineMeshParser(e,t):e.type&&e.type==="TrailMesh"?r=s._TrailMeshParser(e,t):r=new s(e.name,t),r.id=e.id,r._waitingParsedUniqueId=e.uniqueId,st&&st.AddTagsTo(r,e.tags),r.position=E.FromArray(e.position),e.metadata!==void 0&&(r.metadata=e.metadata),e.rotationQuaternion?r.rotationQuaternion=K.FromArray(e.rotationQuaternion):e.rotation&&(r.rotation=E.FromArray(e.rotation)),r.scaling=E.FromArray(e.scaling),e.localMatrix?r.setPreTransformMatrix(B.FromArray(e.localMatrix)):e.pivotMatrix&&r.setPivotMatrix(B.FromArray(e.pivotMatrix)),r.setEnabled(e.isEnabled),r.isVisible=e.isVisible,r.infiniteDistance=e.infiniteDistance,r.alwaysSelectAsActiveMesh=!!e.alwaysSelectAsActiveMesh,r.showBoundingBox=e.showBoundingBox,r.showSubMeshesBoundingBox=e.showSubMeshesBoundingBox,e.applyFog!==void 0&&(r.applyFog=e.applyFog),e.pickable!==void 0&&(r.isPickable=e.pickable),e.alphaIndex!==void 0&&(r.alphaIndex=e.alphaIndex),r.receiveShadows=e.receiveShadows,e.billboardMode!==void 0&&(r.billboardMode=e.billboardMode),e.visibility!==void 0&&(r.visibility=e.visibility),r.checkCollisions=e.checkCollisions,r.doNotSyncBoundingInfo=!!e.doNotSyncBoundingInfo,e.ellipsoid&&(r.ellipsoid=E.FromArray(e.ellipsoid)),e.ellipsoidOffset&&(r.ellipsoidOffset=E.FromArray(e.ellipsoidOffset)),e.overrideMaterialSideOrientation!=null&&(r.sideOrientation=e.overrideMaterialSideOrientation),e.sideOrientation!==void 0&&(r.sideOrientation=e.sideOrientation),e.isBlocker!==void 0&&(r.isBlocker=e.isBlocker),r._shouldGenerateFlatShading=e.useFlatShading,e.freezeWorldMatrix&&(r._waitingData.freezeWorldMatrix=e.freezeWorldMatrix),e.parentId!==void 0&&(r._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(r._waitingParentInstanceIndex=e.parentInstanceIndex),e.actions!==void 0&&(r._waitingData.actions=e.actions),e.overlayAlpha!==void 0&&(r.overlayAlpha=e.overlayAlpha),e.overlayColor!==void 0&&(r.overlayColor=j.FromArray(e.overlayColor)),e.renderOverlay!==void 0&&(r.renderOverlay=e.renderOverlay),r.isUnIndexed=!!e.isUnIndexed,r.hasVertexAlpha=e.hasVertexAlpha,e.delayLoadingFile?(r.delayLoadState=4,r.delayLoadingFile=i+e.delayLoadingFile,r.buildBoundingInfo(E.FromArray(e.boundingBoxMinimum),E.FromArray(e.boundingBoxMaximum)),e._binaryInfo&&(r._binaryInfo=e._binaryInfo),r._delayInfo=[],e.hasUVs&&r._delayInfo.push(A.UVKind),e.hasUVs2&&r._delayInfo.push(A.UV2Kind),e.hasUVs3&&r._delayInfo.push(A.UV3Kind),e.hasUVs4&&r._delayInfo.push(A.UV4Kind),e.hasUVs5&&r._delayInfo.push(A.UV5Kind),e.hasUVs6&&r._delayInfo.push(A.UV6Kind),e.hasColors&&r._delayInfo.push(A.ColorKind),e.hasMatricesIndices&&r._delayInfo.push(A.MatricesIndicesKind),e.hasMatricesWeights&&r._delayInfo.push(A.MatricesWeightsKind),r._delayLoadingFunction=mi._ImportGeometry,Ti.ForceFullSceneLoadingForIncremental&&r._checkDelayState()):mi._ImportGeometry(e,r),e.materialUniqueId?r._waitingMaterialId=e.materialUniqueId:e.materialId&&(r._waitingMaterialId=e.materialId),e.morphTargetManagerId>-1&&(r._waitingMorphTargetManagerId=e.morphTargetManagerId),e.skeletonId!==void 0&&e.skeletonId!==null&&(r.skeleton=t.getLastSkeletonById(e.skeletonId),e.numBoneInfluencers&&(r.numBoneInfluencers=e.numBoneInfluencers)),e.animations){for(let n=0;n<e.animations.length;n++){let a=e.animations[n],o=Ci("BABYLON.Animation");o&&r.animations.push(o.Parse(a))}_t.ParseAnimationRanges(r,e,t)}if(e.autoAnimate&&t.beginAnimation(r,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.layerMask&&!isNaN(e.layerMask)?r.layerMask=Math.abs(parseInt(e.layerMask)):r.layerMask=268435455,e.physicsImpostor&&(r.physicsImpostor=s._PhysicsImpostorParser(t,r,e)),e.lodMeshIds&&(r._waitingData.lods={ids:e.lodMeshIds,distances:e.lodDistances?e.lodDistances:null,coverages:e.lodCoverages?e.lodCoverages:null}),e.instances)for(let n=0;n<e.instances.length;n++){let a=e.instances[n],o=r.createInstance(a.name);if(a.id&&(o.id=a.id),st&&(a.tags?st.AddTagsTo(o,a.tags):st.AddTagsTo(o,e.tags)),o.position=E.FromArray(a.position),a.metadata!==void 0&&(o.metadata=a.metadata),a.parentId!==void 0&&(o._waitingParentId=a.parentId),a.parentInstanceIndex!==void 0&&(o._waitingParentInstanceIndex=a.parentInstanceIndex),a.isEnabled!==void 0&&a.isEnabled!==null&&o.setEnabled(a.isEnabled),a.isVisible!==void 0&&a.isVisible!==null&&(o.isVisible=a.isVisible),a.isPickable!==void 0&&a.isPickable!==null&&(o.isPickable=a.isPickable),a.rotationQuaternion?o.rotationQuaternion=K.FromArray(a.rotationQuaternion):a.rotation&&(o.rotation=E.FromArray(a.rotation)),o.scaling=E.FromArray(a.scaling),a.checkCollisions!=null&&a.checkCollisions!=null&&(o.checkCollisions=a.checkCollisions),a.pickable!=null&&a.pickable!=null&&(o.isPickable=a.pickable),a.showBoundingBox!=null&&a.showBoundingBox!=null&&(o.showBoundingBox=a.showBoundingBox),a.showSubMeshesBoundingBox!=null&&a.showSubMeshesBoundingBox!=null&&(o.showSubMeshesBoundingBox=a.showSubMeshesBoundingBox),a.alphaIndex!=null&&a.showSubMeshesBoundingBox!=null&&(o.alphaIndex=a.alphaIndex),a.physicsImpostor&&(o.physicsImpostor=s._PhysicsImpostorParser(t,o,a)),a.actions!==void 0&&(o._waitingData.actions=a.actions),a.animations){for(let l=0;l<a.animations.length;l++){let c=a.animations[l],f=Ci("BABYLON.Animation");f&&o.animations.push(f.Parse(c))}_t.ParseAnimationRanges(o,a,t),a.autoAnimate&&t.beginAnimation(o,a.autoAnimateFrom,a.autoAnimateTo,a.autoAnimateLoop,a.autoAnimateSpeed||1)}}if(e.thinInstances){let n=e.thinInstances;if(r.thinInstanceEnablePicking=!!n.enablePicking,n.matrixData?(r.thinInstanceSetBuffer("matrix",new Float32Array(n.matrixData),16,!1),r._thinInstanceDataStorage.matrixBufferSize=n.matrixBufferSize,r._thinInstanceDataStorage.instancesCount=n.instancesCount):r._thinInstanceDataStorage.matrixBufferSize=n.matrixBufferSize,e.thinInstances.userThinInstance){let a=e.thinInstances.userThinInstance;for(let o in a.data)r.thinInstanceSetBuffer(o,new Float32Array(a.data[o]),a.strides[o],!1),r._userThinInstanceBuffersStorage.sizes[o]=a.sizes[o]}}return r}setPositionsForCPUSkinning(){let e=this._internalMeshDataInfo;if(!e._sourcePositions){let t=this.getVerticesData(A.PositionKind);if(!t)return e._sourcePositions;e._sourcePositions=new Float32Array(t),this.isVertexBufferUpdatable(A.PositionKind)||this.setVerticesData(A.PositionKind,t,!0)}return e._sourcePositions}setNormalsForCPUSkinning(){let e=this._internalMeshDataInfo;if(!e._sourceNormals){let t=this.getVerticesData(A.NormalKind);if(!t)return e._sourceNormals;e._sourceNormals=new Float32Array(t),this.isVertexBufferUpdatable(A.NormalKind)||this.setVerticesData(A.NormalKind,t,!0)}return e._sourceNormals}applySkeleton(e){if(!this.geometry)return this;if(this.geometry._softwareSkinningFrameId==this.getScene().getFrameId())return this;if(this.geometry._softwareSkinningFrameId=this.getScene().getFrameId(),!this.isVerticesDataPresent(A.PositionKind))return this;if(!this.isVerticesDataPresent(A.MatricesIndicesKind))return this;if(!this.isVerticesDataPresent(A.MatricesWeightsKind))return this;let t=this.isVerticesDataPresent(A.NormalKind),i=this._internalMeshDataInfo;if(!i._sourcePositions){let v=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=v}t&&!i._sourceNormals&&this.setNormalsForCPUSkinning();let r=this.getVerticesData(A.PositionKind);if(!r)return this;r instanceof Float32Array||(r=new Float32Array(r));let n=this.getVerticesData(A.NormalKind);if(t){if(!n)return this;n instanceof Float32Array||(n=new Float32Array(n))}let a=this.getVerticesData(A.MatricesIndicesKind),o=this.getVerticesData(A.MatricesWeightsKind);if(!o||!a)return this;let l=this.numBoneInfluencers>4,c=l?this.getVerticesData(A.MatricesIndicesExtraKind):null,f=l?this.getVerticesData(A.MatricesWeightsExtraKind):null,h=e.getTransformMatrices(this),u=E.Zero(),d=new B,p=new B,m=0,_;for(let v=0;v<r.length;v+=3,m+=4){let T;for(_=0;_<4;_++)T=o[m+_],T>0&&(B.FromFloat32ArrayToRefScaled(h,Math.floor(a[m+_]*16),T,p),d.addToSelf(p));if(l)for(_=0;_<4;_++)T=f[m+_],T>0&&(B.FromFloat32ArrayToRefScaled(h,Math.floor(c[m+_]*16),T,p),d.addToSelf(p));E.TransformCoordinatesFromFloatsToRef(i._sourcePositions[v],i._sourcePositions[v+1],i._sourcePositions[v+2],d,u),u.toArray(r,v),t&&(E.TransformNormalFromFloatsToRef(i._sourceNormals[v],i._sourceNormals[v+1],i._sourceNormals[v+2],d,u),u.toArray(n,v)),d.reset()}return this.updateVerticesData(A.PositionKind,r),t&&this.updateVerticesData(A.NormalKind,n),this}static MinMax(e){let t=null,i=null;for(let r of e){let a=r.getBoundingInfo().boundingBox;!t||!i?(t=a.minimumWorld,i=a.maximumWorld):(t.minimizeInPlace(a.minimumWorld),i.maximizeInPlace(a.maximumWorld))}return!t||!i?{min:E.Zero(),max:E.Zero()}:{min:t,max:i}}static Center(e){let t=e instanceof Array?s.MinMax(e):e;return E.Center(t.min,t.max)}static MergeMeshes(e,t=!0,i,r,n,a){return Fl(s._MergeMeshesCoroutine(e,t,i,r,n,a,!1))}static async MergeMeshesAsync(e,t=!0,i,r,n,a){return await gf(s._MergeMeshesCoroutine(e,t,i,r,n,a,!0),_f())}static*_MergeMeshesCoroutine(e,t=!0,i,r,n,a,o){if(e=e.filter(Boolean),e.length===0)return null;let l;if(!i){let M=0;for(l=0;l<e.length;l++)if(M+=e[l].getTotalVertices(),M>=65536)return P.Warn("Cannot merge meshes because resulting mesh will have more than 65536 vertices. Please use allow32BitsIndices = true to use 32 bits indices"),null}a&&(n=!1);let c=new Array,f=new Array,h=new Array,u=e[0].sideOrientation;for(l=0;l<e.length;l++){let M=e[l];if(M.isAnInstance)return P.Warn("Cannot merge instance meshes."),null;if(u!==M.sideOrientation)return P.Warn("Cannot merge meshes with different sideOrientation values."),null;if(n&&h.push({start:0,count:M.getTotalIndices()}),a){let F=h.reduce((U,D)=>Math.max(U,D.start+D.count),0);if(M.material){let U=M.material;if(U instanceof Tf){for(let D=0;D<U.subMaterials.length;D++)c.indexOf(U.subMaterials[D])<0&&c.push(U.subMaterials[D]);for(let D=0;D<M.subMeshes.length;D++)f.push(c.indexOf(U.subMaterials[M.subMeshes[D].materialIndex])),h.push({start:F+M.subMeshes[D].indexStart,count:M.subMeshes[D].indexCount})}else{c.indexOf(U)<0&&c.push(U);for(let D=0;D<M.subMeshes.length;D++)f.push(c.indexOf(U)),h.push({start:F+M.subMeshes[D].indexStart,count:M.subMeshes[D].indexCount})}}else for(let U=0;U<M.subMeshes.length;U++)f.push(0),h.push({start:F+M.subMeshes[U].indexStart,count:M.subMeshes[U].indexCount})}}let d=e[0],p=M=>{let F=M.computeWorldMatrix(!0);return{vertexData:Ge.ExtractFromMesh(M,!1,!1),transform:F}},{vertexData:m,transform:_}=p(d);o&&(yield);let v=new Array(e.length-1);for(let M=1;M<e.length;M++)v[M-1]=p(e[M]),o&&(yield);let T=m._mergeCoroutine(_,v,i,o,!t),C=T.next();for(;!C.done;)o&&(yield),C=T.next();let I=C.value;r||(r=new s(d.name+"_merged",d.getScene()));let R=I._applyToCoroutine(r,void 0,o),b=R.next();for(;!b.done;)o&&(yield),b=R.next();if(r.checkCollisions=d.checkCollisions,r.sideOrientation=d.sideOrientation,t)for(l=0;l<e.length;l++)e[l].dispose();if(n||a){for(r.releaseSubMeshes(),l=0;l<h.length;)cr.CreateFromIndices(0,h[l].start,h[l].count,r,void 0,!1),l++;for(let M of r.subMeshes)M.refreshBoundingInfo();r.computeWorldMatrix(!0)}if(a){let M=new Tf(d.name+"_merged",d.getScene());M.subMaterials=c;for(let F=0;F<r.subMeshes.length;F++)r.subMeshes[F].materialIndex=f[F];r.material=M}else r.material=d.material;return r}addInstance(e){e._indexInSourceMeshInstanceArray=this.instances.length,this.instances.push(e)}removeInstance(e){let t=e._indexInSourceMeshInstanceArray;if(t!=-1){if(t!==this.instances.length-1){let i=this.instances[this.instances.length-1];this.instances[t]=i,i._indexInSourceMeshInstanceArray=t}e._indexInSourceMeshInstanceArray=-1,this.instances.pop()}}_shouldConvertRHS(){return this._scene.useRightHandedSystem&&this.sideOrientation===Q.CounterClockWiseSideOrientation}_getRenderingFillMode(e){let t=this.getScene();return t.forcePointsCloud?Q.PointFillMode:t.forceWireframe?Q.WireFrameFillMode:this.overrideRenderingFillMode??e}setMaterialByID(e){return this.setMaterialById(e)}static CreateRibbon(e,t,i,r,n,a,o,l,c){throw new Error("Import MeshBuilder to populate this function")}static CreateDisc(e,t,i,r,n,a){throw new Error("Import MeshBuilder to populate this function")}static CreateBox(e,t,i,r,n){throw new Error("Import MeshBuilder to populate this function")}static CreateSphere(e,t,i,r,n,a){throw new Error("Import MeshBuilder to populate this function")}static CreateHemisphere(e,t,i,r){throw new Error("Import MeshBuilder to populate this function")}static CreateCylinder(e,t,i,r,n,a,o,l,c){throw new Error("Import MeshBuilder to populate this function")}static CreateTorus(e,t,i,r,n,a,o){throw new Error("Import MeshBuilder to populate this function")}static CreateTorusKnot(e,t,i,r,n,a,o,l,c,f){throw new Error("Import MeshBuilder to populate this function")}static CreateLines(e,t,i,r,n){throw new Error("Import MeshBuilder to populate this function")}static CreateDashedLines(e,t,i,r,n,a,o,l){throw new Error("Import MeshBuilder to populate this function")}static CreatePolygon(e,t,i,r,n,a,o){throw new Error("Import MeshBuilder to populate this function")}static ExtrudePolygon(e,t,i,r,n,a,o,l){throw new Error("Import MeshBuilder to populate this function")}static ExtrudeShape(e,t,i,r,n,a,o,l,c,f){throw new Error("Import MeshBuilder to populate this function")}static ExtrudeShapeCustom(e,t,i,r,n,a,o,l,c,f,h,u){throw new Error("Import MeshBuilder to populate this function")}static CreateLathe(e,t,i,r,n,a,o){throw new Error("Import MeshBuilder to populate this function")}static CreatePlane(e,t,i,r,n){throw new Error("Import MeshBuilder to populate this function")}static CreateGround(e,t,i,r,n,a){throw new Error("Import MeshBuilder to populate this function")}static CreateTiledGround(e,t,i,r,n,a,o,l,c){throw new Error("Import MeshBuilder to populate this function")}static CreateGroundFromHeightMap(e,t,i,r,n,a,o,l,c,f,h){throw new Error("Import MeshBuilder to populate this function")}static CreateTube(e,t,i,r,n,a,o,l,c,f){throw new Error("Import MeshBuilder to populate this function")}static CreatePolyhedron(e,t,i){throw new Error("Import MeshBuilder to populate this function")}static CreateIcoSphere(e,t,i){throw new Error("Import MeshBuilder to populate this function")}static CreateDecal(e,t,i,r,n,a){throw new Error("Import MeshBuilder to populate this function")}static CreateCapsule(e,t,i){throw new Error("Import MeshBuilder to populate this function")}static ExtendToGoldberg(e){throw new Error("Import MeshBuilder to populate this function")}};fe.FRONTSIDE=Ge.FRONTSIDE;fe.BACKSIDE=Ge.BACKSIDE;fe.DOUBLESIDE=Ge.DOUBLESIDE;fe.DEFAULTSIDE=Ge.DEFAULTSIDE;fe.NO_CAP=0;fe.CAP_START=1;fe.CAP_END=2;fe.CAP_ALL=3;fe.NO_FLIP=0;fe.FLIP_TILE=1;fe.ROTATE_TILE=2;fe.FLIP_ROW=3;fe.ROTATE_ROW=4;fe.FLIP_N_ROTATE_TILE=5;fe.FLIP_N_ROTATE_ROW=6;fe.CENTER=0;fe.LEFT=1;fe.RIGHT=2;fe.TOP=3;fe.BOTTOM=4;fe.INSTANCEDMESH_SORT_TRANSPARENT=!1;fe._GroundMeshParser=(s,e)=>{throw pe("GroundMesh")};fe._GoldbergMeshParser=(s,e)=>{throw pe("GoldbergMesh")};fe._LinesMeshParser=(s,e)=>{throw pe("LinesMesh")};fe._GreasedLineMeshParser=(s,e)=>{throw pe("GreasedLineMesh")};fe._GreasedLineRibbonMeshParser=(s,e)=>{throw pe("GreasedLineRibbonMesh")};fe._TrailMeshParser=(s,e)=>{throw pe("TrailMesh")};G("BABYLON.Mesh",fe)});var hr,f_,xf,h_,u_,d_,Af,Rf,cu=S(()=>{qA();hr=class s{constructor(){this._easingMode=s.EASINGMODE_EASEIN}setEasingMode(e){let t=Math.min(Math.max(e,0),2);this._easingMode=t}getEasingMode(){return this._easingMode}easeInCore(e){throw new Error("You must implement this method")}ease(e){switch(this._easingMode){case s.EASINGMODE_EASEIN:return this.easeInCore(e);case s.EASINGMODE_EASEOUT:return 1-this.easeInCore(1-e)}return e>=.5?(1-this.easeInCore((1-e)*2))*.5+.5:this.easeInCore(e*2)*.5}};hr.EASINGMODE_EASEIN=0;hr.EASINGMODE_EASEOUT=1;hr.EASINGMODE_EASEINOUT=2;f_=class extends hr{easeInCore(e){return e=Math.max(0,Math.min(1,e)),1-Math.sqrt(1-e*e)}},xf=class extends hr{constructor(e=1){super(),this.amplitude=e}easeInCore(e){let t=Math.max(0,this.amplitude);return Math.pow(e,3)-e*t*Math.sin(3.141592653589793*e)}},h_=class extends hr{constructor(e=3,t=2){super(),this.bounces=e,this.bounciness=t}easeInCore(e){let t=Math.max(0,this.bounces),i=this.bounciness;i<=1&&(i=1.001);let r=Math.pow(i,t),n=1-i,a=(1-r)/n+r*.5,o=e*a,l=Math.log(-o*(1-i)+1)/Math.log(i),c=Math.floor(l),f=c+1,h=(1-Math.pow(i,c))/(n*a),u=(1-Math.pow(i,f))/(n*a),d=(h+u)*.5,p=e-d,m=d-h;return-Math.pow(1/i,t-c)/(m*m)*(p-m)*(p+m)}},u_=class extends hr{easeInCore(e){return e*e*e}},d_=class extends hr{constructor(e=3,t=3){super(),this.oscillations=e,this.springiness=t}easeInCore(e){let t,i=Math.max(0,this.oscillations),r=Math.max(0,this.springiness);return r==0?t=e:t=(Math.exp(r*e)-1)/(Math.exp(r)-1),t*Math.sin((6.283185307179586*i+1.5707963267948966)*e)}},Af=class extends hr{constructor(e=2){super(),this.exponent=e}easeInCore(e){return this.exponent<=0?e:(Math.exp(this.exponent*e)-1)/(Math.exp(this.exponent)-1)}},Rf=class extends hr{constructor(e=0,t=0,i=1,r=1){super(),this.x1=e,this.y1=t,this.x2=i,this.y2=r}easeInCore(e){return Bp.Interpolate(e,this.x1,this.y1,this.x2,this.y2)}}});var Yo,uC=S(()=>{Yo=class s{constructor(e,t,i){this.name=e,this.from=t,this.to=i}clone(){return new s(this.name,this.from,this.to)}}});var dC,pC,mC,_C,gC,vC,cn,q,ws=S(()=>{ie();it();di();Te();uC();rs();Up();bc();ei();dC=Object.freeze(new K(0,0,0,0)),pC=Object.freeze(E.Zero()),mC=Object.freeze(he.Zero()),_C=Object.freeze(ha.Zero()),gC=Object.freeze(j.Black()),vC=Object.freeze(new me(0,0,0,0)),cn={key:0,repeatCount:0,loopMode:2},q=class s{static _PrepareAnimation(e,t,i,r,n,a,o,l){let c;if(!isNaN(parseFloat(n))&&isFinite(n)?c=s.ANIMATIONTYPE_FLOAT:n instanceof K?c=s.ANIMATIONTYPE_QUATERNION:n instanceof E?c=s.ANIMATIONTYPE_VECTOR3:n instanceof he?c=s.ANIMATIONTYPE_VECTOR2:n instanceof j?c=s.ANIMATIONTYPE_COLOR3:n instanceof me?c=s.ANIMATIONTYPE_COLOR4:n instanceof ha&&(c=s.ANIMATIONTYPE_SIZE),c==null)return null;let f=new s(e,t,i,c,o),h=[{frame:0,value:n},{frame:r,value:a}];return f.setKeys(h),l!==void 0&&f.setEasingFunction(l),f}static CreateAnimation(e,t,i,r){let n=new s(e+"Animation",e,i,t,s.ANIMATIONLOOPMODE_CONSTANT);return n.setEasingFunction(r),n}static CreateAndStartAnimation(e,t,i,r,n,a,o,l,c,f,h){let u=s._PrepareAnimation(e,i,r,n,a,o,l,c);return!u||(t.getScene&&(h=t.getScene()),!h)?null:h.beginDirectAnimation(t,[u],0,n,u.loopMode!==s.ANIMATIONLOOPMODE_CONSTANT,1,f)}static CreateAndStartHierarchyAnimation(e,t,i,r,n,a,o,l,c,f,h){let u=s._PrepareAnimation(e,r,n,a,o,l,c,f);return u?t.getScene().beginDirectHierarchyAnimation(t,i,[u],0,a,u.loopMode===1,1,h):null}static CreateMergeAndStartAnimation(e,t,i,r,n,a,o,l,c,f){let h=s._PrepareAnimation(e,i,r,n,a,o,l,c);return h?(t.animations.push(h),t.getScene().beginAnimation(t,0,n,h.loopMode===1,1,f)):null}static MakeAnimationAdditive(e,t,i,r=!1,n){let a;typeof t=="object"?a=t:a={referenceFrame:t??0,range:i,cloneOriginalAnimation:r,clonedAnimationName:n};let o=e;if(a.cloneOriginalAnimation&&(o=e.clone(),o.name=a.clonedAnimationName||o.name),!o._keys.length)return o;let l=a.referenceFrame&&a.referenceFrame>=0?a.referenceFrame:0,c=0,f=o._keys[0],h=o._keys.length-1,u=o._keys[h],d={referenceValue:f.value,referencePosition:w.Vector3[0],referenceQuaternion:w.Quaternion[0],referenceScaling:w.Vector3[1],keyPosition:w.Vector3[2],keyQuaternion:w.Quaternion[1],keyScaling:w.Vector3[3]},p=f.frame,m=u.frame;if(a.range){let T=o.getRange(a.range);T&&(p=T.from,m=T.to)}else p=a.fromFrame??p,m=a.toFrame??m;if(p!==f.frame&&(c=o.createKeyForFrame(p)),m!==u.frame&&(h=o.createKeyForFrame(m)),o._keys.length===1){let T=o._getKeyValue(o._keys[0]);d.referenceValue=T.clone?T.clone():T}else if(l<=f.frame){let T=o._getKeyValue(f.value);d.referenceValue=T.clone?T.clone():T}else if(l>=u.frame){let T=o._getKeyValue(u.value);d.referenceValue=T.clone?T.clone():T}else{cn.key=0;let T=o._interpolate(l,cn);d.referenceValue=T.clone?T.clone():T}o.dataType===s.ANIMATIONTYPE_QUATERNION?d.referenceValue.normalize().conjugateInPlace():o.dataType===s.ANIMATIONTYPE_MATRIX&&(d.referenceValue.decompose(d.referenceScaling,d.referenceQuaternion,d.referencePosition),d.referenceQuaternion.normalize().conjugateInPlace());let _=Number.MAX_VALUE,v=a.clipKeys?[]:null;for(let T=c;T<=h;T++){let C=o._keys[T];if((v||a.cloneOriginalAnimation)&&(C={frame:C.frame,value:C.value.clone?C.value.clone():C.value,inTangent:C.inTangent,outTangent:C.outTangent,interpolation:C.interpolation,lockedTangent:C.lockedTangent},v&&(_===Number.MAX_VALUE&&(_=C.frame),C.frame-=_,v.push(C))),!(T&&o.dataType!==s.ANIMATIONTYPE_FLOAT&&C.value===f.value))switch(o.dataType){case s.ANIMATIONTYPE_MATRIX:C.value.decompose(d.keyScaling,d.keyQuaternion,d.keyPosition),d.keyPosition.subtractInPlace(d.referencePosition),d.keyScaling.divideInPlace(d.referenceScaling),d.referenceQuaternion.multiplyToRef(d.keyQuaternion,d.keyQuaternion),B.ComposeToRef(d.keyScaling,d.keyQuaternion,d.keyPosition,C.value);break;case s.ANIMATIONTYPE_QUATERNION:d.referenceValue.multiplyToRef(C.value,C.value);break;case s.ANIMATIONTYPE_VECTOR2:case s.ANIMATIONTYPE_VECTOR3:case s.ANIMATIONTYPE_COLOR3:case s.ANIMATIONTYPE_COLOR4:C.value.subtractToRef(d.referenceValue,C.value);break;case s.ANIMATIONTYPE_SIZE:C.value.width-=d.referenceValue.width,C.value.height-=d.referenceValue.height;break;default:C.value-=d.referenceValue}}return v&&o.setKeys(v,!0),o}static TransitionTo(e,t,i,r,n,a,o,l=null){if(o<=0)return i[e]=t,l&&l(),null;let c=n*(o/1e3);a.setKeys([{frame:0,value:i[e].clone?i[e].clone():i[e]},{frame:c,value:t}]),i.animations||(i.animations=[]),i.animations.push(a);let f=r.beginAnimation(i,0,c,!1);return f.onAnimationEnd=l,f}get runtimeAnimations(){return this._runtimeAnimations}get hasRunningRuntimeAnimations(){for(let e of this._runtimeAnimations)if(!e.isStopped())return!0;return!1}constructor(e,t,i,r,n,a){this.name=e,this.targetProperty=t,this.framePerSecond=i,this.dataType=r,this.loopMode=n,this.enableBlending=a,this._easingFunction=null,this._runtimeAnimations=new Array,this._events=new Array,this.blendingSpeed=.01,this._ranges={},this._coreAnimation=null,this.targetPropertyPath=t.split("."),this.dataType=r,this.loopMode=n===void 0?s.ANIMATIONLOOPMODE_CYCLE:n,this.uniqueId=s._UniqueIdGenerator++}toString(e){let t="Name: "+this.name+", property: "+this.targetProperty;if(t+=", datatype: "+["Float","Vector3","Quaternion","Matrix","Color3","Vector2"][this.dataType],t+=", nKeys: "+(this._keys?this._keys.length:"none"),t+=", nRanges: "+(this._ranges?Object.keys(this._ranges).length:"none"),e){t+=", Ranges: {";let i=!0;for(let r in this._ranges)i&&(t+=", ",i=!1),t+=r;t+="}"}return t}addEvent(e){this._events.push(e),this._events.sort((t,i)=>t.frame-i.frame)}removeEvents(e){for(let t=0;t<this._events.length;t++)this._events[t].frame===e&&(this._events.splice(t,1),t--)}getEvents(){return this._events}createRange(e,t,i){this._ranges[e]||(this._ranges[e]=new Yo(e,t,i))}deleteRange(e,t=!0){let i=this._ranges[e];if(i){if(t){let r=i.from,n=i.to;for(let a=this._keys.length-1;a>=0;a--)this._keys[a].frame>=r&&this._keys[a].frame<=n&&this._keys.splice(a,1)}this._ranges[e]=null}}getRange(e){return this._ranges[e]}getKeys(){return this._keys}getHighestFrame(){let e=0;for(let t=0,i=this._keys.length;t<i;t++)e<this._keys[t].frame&&(e=this._keys[t].frame);return e}getEasingFunction(){return this._easingFunction}setEasingFunction(e){this._easingFunction=e}floatInterpolateFunction(e,t,i){return As(e,t,i)}floatInterpolateFunctionWithTangents(e,t,i,r,n){return yA(e,t,i,r,n)}quaternionInterpolateFunction(e,t,i){return K.Slerp(e,t,i)}quaternionInterpolateFunctionWithTangents(e,t,i,r,n){return K.Hermite(e,t,i,r,n).normalize()}vector3InterpolateFunction(e,t,i){return E.Lerp(e,t,i)}vector3InterpolateFunctionWithTangents(e,t,i,r,n){return E.Hermite(e,t,i,r,n)}vector2InterpolateFunction(e,t,i){return he.Lerp(e,t,i)}vector2InterpolateFunctionWithTangents(e,t,i,r,n){return he.Hermite(e,t,i,r,n)}sizeInterpolateFunction(e,t,i){return ha.Lerp(e,t,i)}color3InterpolateFunction(e,t,i){return j.Lerp(e,t,i)}color3InterpolateFunctionWithTangents(e,t,i,r,n){return j.Hermite(e,t,i,r,n)}color4InterpolateFunction(e,t,i){return me.Lerp(e,t,i)}color4InterpolateFunctionWithTangents(e,t,i,r,n){return me.Hermite(e,t,i,r,n)}_getKeyValue(e){return typeof e=="function"?e():e}evaluate(e){return cn.key=0,this._interpolate(e,cn)}_interpolate(e,t,i=!1){if(t.loopMode===s.ANIMATIONLOOPMODE_CONSTANT&&t.repeatCount>0)return t.highLimitValue.clone?t.highLimitValue.clone():t.highLimitValue;let r=this._keys,n;if(this._coreAnimation)n=this._coreAnimation._key;else{let p=r.length;for(n=t.key;n>=0&&e<r[n].frame;)--n;for(;n+1<=p-1&&e>=r[n+1].frame;)++n;if(t.key=n,n<0)return i?void 0:this._getKeyValue(r[0].value);if(n+1>p-1)return i?void 0:this._getKeyValue(r[p-1].value);this._key=n}let a=r[n],o=r[n+1];if(i&&(e===a.frame||e===o.frame))return;let l=this._getKeyValue(a.value),c=this._getKeyValue(o.value);if(a.interpolation===1)return o.frame>e?l:c;let f=a.outTangent!==void 0&&o.inTangent!==void 0,h=o.frame-a.frame,u=(e-a.frame)/h,d=a.easingFunction||this.getEasingFunction();switch(d&&(u=d.ease(u)),this.dataType){case s.ANIMATIONTYPE_FLOAT:{let p=f?this.floatInterpolateFunctionWithTangents(l,a.outTangent*h,c,o.inTangent*h,u):this.floatInterpolateFunction(l,c,u);switch(t.loopMode){case s.ANIMATIONLOOPMODE_CYCLE:case s.ANIMATIONLOOPMODE_CONSTANT:case s.ANIMATIONLOOPMODE_YOYO:return p;case s.ANIMATIONLOOPMODE_RELATIVE:case s.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return(t.offsetValue??0)*t.repeatCount+p}break}case s.ANIMATIONTYPE_QUATERNION:{let p=f?this.quaternionInterpolateFunctionWithTangents(l,a.outTangent.scale(h),c,o.inTangent.scale(h),u):this.quaternionInterpolateFunction(l,c,u);switch(t.loopMode){case s.ANIMATIONLOOPMODE_CYCLE:case s.ANIMATIONLOOPMODE_CONSTANT:case s.ANIMATIONLOOPMODE_YOYO:return p;case s.ANIMATIONLOOPMODE_RELATIVE:case s.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return p.addInPlace((t.offsetValue||dC).scale(t.repeatCount))}return p}case s.ANIMATIONTYPE_VECTOR3:{let p=f?this.vector3InterpolateFunctionWithTangents(l,a.outTangent.scale(h),c,o.inTangent.scale(h),u):this.vector3InterpolateFunction(l,c,u);switch(t.loopMode){case s.ANIMATIONLOOPMODE_CYCLE:case s.ANIMATIONLOOPMODE_CONSTANT:case s.ANIMATIONLOOPMODE_YOYO:return p;case s.ANIMATIONLOOPMODE_RELATIVE:case s.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return p.add((t.offsetValue||pC).scale(t.repeatCount))}break}case s.ANIMATIONTYPE_VECTOR2:{let p=f?this.vector2InterpolateFunctionWithTangents(l,a.outTangent.scale(h),c,o.inTangent.scale(h),u):this.vector2InterpolateFunction(l,c,u);switch(t.loopMode){case s.ANIMATIONLOOPMODE_CYCLE:case s.ANIMATIONLOOPMODE_CONSTANT:case s.ANIMATIONLOOPMODE_YOYO:return p;case s.ANIMATIONLOOPMODE_RELATIVE:case s.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return p.add((t.offsetValue||mC).scale(t.repeatCount))}break}case s.ANIMATIONTYPE_SIZE:{switch(t.loopMode){case s.ANIMATIONLOOPMODE_CYCLE:case s.ANIMATIONLOOPMODE_CONSTANT:case s.ANIMATIONLOOPMODE_YOYO:return this.sizeInterpolateFunction(l,c,u);case s.ANIMATIONLOOPMODE_RELATIVE:case s.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return this.sizeInterpolateFunction(l,c,u).add((t.offsetValue||_C).scale(t.repeatCount))}break}case s.ANIMATIONTYPE_COLOR3:{let p=f?this.color3InterpolateFunctionWithTangents(l,a.outTangent.scale(h),c,o.inTangent.scale(h),u):this.color3InterpolateFunction(l,c,u);switch(t.loopMode){case s.ANIMATIONLOOPMODE_CYCLE:case s.ANIMATIONLOOPMODE_CONSTANT:case s.ANIMATIONLOOPMODE_YOYO:return p;case s.ANIMATIONLOOPMODE_RELATIVE:case s.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return p.add((t.offsetValue||gC).scale(t.repeatCount))}break}case s.ANIMATIONTYPE_COLOR4:{let p=f?this.color4InterpolateFunctionWithTangents(l,a.outTangent.scale(h),c,o.inTangent.scale(h),u):this.color4InterpolateFunction(l,c,u);switch(t.loopMode){case s.ANIMATIONLOOPMODE_CYCLE:case s.ANIMATIONLOOPMODE_CONSTANT:case s.ANIMATIONLOOPMODE_YOYO:return p;case s.ANIMATIONLOOPMODE_RELATIVE:case s.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return p.add((t.offsetValue||vC).scale(t.repeatCount))}break}case s.ANIMATIONTYPE_MATRIX:{switch(t.loopMode){case s.ANIMATIONLOOPMODE_CYCLE:case s.ANIMATIONLOOPMODE_CONSTANT:case s.ANIMATIONLOOPMODE_YOYO:return s.AllowMatricesInterpolation?this.matrixInterpolateFunction(l,c,u,t.workValue):l;case s.ANIMATIONLOOPMODE_RELATIVE:case s.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return l}break}}return 0}matrixInterpolateFunction(e,t,i,r){return s.AllowMatrixDecomposeForInterpolation?r?(B.DecomposeLerpToRef(e,t,i,r),r):B.DecomposeLerp(e,t,i):r?(B.LerpToRef(e,t,i,r),r):B.Lerp(e,t,i)}clone(){let e=new s(this.name,this.targetPropertyPath.join("."),this.framePerSecond,this.dataType,this.loopMode);if(e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed,this._keys&&e.setKeys(this._keys),this._ranges){e._ranges={};for(let t in this._ranges){let i=this._ranges[t];i&&(e._ranges[t]=i.clone())}}return e}setKeys(e,t=!1){this._keys=t?e:e.slice(0)}createKeyForFrame(e){cn.key=0;let t=this._interpolate(e,cn,!0);if(!t)return this._keys[cn.key].frame===e?cn.key:cn.key+1;let i={frame:e,value:t.clone?t.clone():t};return this._keys.splice(cn.key+1,0,i),cn.key+1}serialize(){let e={};e.name=this.name,e.property=this.targetProperty,e.framePerSecond=this.framePerSecond,e.dataType=this.dataType,e.loopBehavior=this.loopMode,e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed;let t=this.dataType;e.keys=[];let i=this.getKeys();for(let r=0;r<i.length;r++){let n=i[r],a={};switch(a.frame=n.frame,t){case s.ANIMATIONTYPE_FLOAT:a.values=[n.value],n.inTangent!==void 0&&a.values.push(n.inTangent),n.outTangent!==void 0&&(n.inTangent===void 0&&a.values.push(void 0),a.values.push(n.outTangent)),n.interpolation!==void 0&&(n.inTangent===void 0&&a.values.push(void 0),n.outTangent===void 0&&a.values.push(void 0),a.values.push(n.interpolation));break;case s.ANIMATIONTYPE_QUATERNION:case s.ANIMATIONTYPE_MATRIX:case s.ANIMATIONTYPE_VECTOR3:case s.ANIMATIONTYPE_COLOR3:case s.ANIMATIONTYPE_COLOR4:a.values=n.value.asArray(),n.inTangent!=null&&a.values.push(n.inTangent.asArray()),n.outTangent!=null&&(n.inTangent===void 0&&a.values.push(void 0),a.values.push(n.outTangent.asArray())),n.interpolation!==void 0&&(n.inTangent===void 0&&a.values.push(void 0),n.outTangent===void 0&&a.values.push(void 0),a.values.push(n.interpolation));break}e.keys.push(a)}e.ranges=[];for(let r in this._ranges){let n=this._ranges[r];if(!n)continue;let a={};a.name=r,a.from=n.from,a.to=n.to,e.ranges.push(a)}return e}static _UniversalLerp(e,t,i){let r=e.constructor;return r.Lerp?r.Lerp(e,t,i):r.Slerp?r.Slerp(e,t,i):e.toFixed?e*(1-i)+i*t:t}static Parse(e){let t=new s(e.name,e.property,e.framePerSecond,e.dataType,e.loopBehavior),i=e.dataType,r=[],n,a;for(e.enableBlending&&(t.enableBlending=e.enableBlending),e.blendingSpeed&&(t.blendingSpeed=e.blendingSpeed),a=0;a<e.keys.length;a++){let o=e.keys[a],l,c,f;switch(i){case s.ANIMATIONTYPE_FLOAT:n=o.values[0],o.values.length>=2&&(l=o.values[1]),o.values.length>=3&&(c=o.values[2]),o.values.length>=4&&(f=o.values[3]);break;case s.ANIMATIONTYPE_QUATERNION:if(n=K.FromArray(o.values),o.values.length>=8){let u=K.FromArray(o.values.slice(4,8));u.equals(K.Zero())||(l=u)}if(o.values.length>=12){let u=K.FromArray(o.values.slice(8,12));u.equals(K.Zero())||(c=u)}o.values.length>=13&&(f=o.values[12]);break;case s.ANIMATIONTYPE_MATRIX:n=B.FromArray(o.values),o.values.length>=17&&(f=o.values[16]);break;case s.ANIMATIONTYPE_COLOR3:n=j.FromArray(o.values),o.values[3]&&(l=j.FromArray(o.values[3])),o.values[4]&&(c=j.FromArray(o.values[4])),o.values[5]&&(f=o.values[5]);break;case s.ANIMATIONTYPE_COLOR4:n=me.FromArray(o.values),o.values[4]&&(l=me.FromArray(o.values[4])),o.values[5]&&(c=me.FromArray(o.values[5])),o.values[6]&&(f=me.FromArray(o.values[6]));break;case s.ANIMATIONTYPE_VECTOR3:default:n=E.FromArray(o.values),o.values[3]&&(l=E.FromArray(o.values[3])),o.values[4]&&(c=E.FromArray(o.values[4])),o.values[5]&&(f=o.values[5]);break}let h={};h.frame=o.frame,h.value=n,l!=null&&(h.inTangent=l),c!=null&&(h.outTangent=c),f!=null&&(h.interpolation=f),r.push(h)}if(t.setKeys(r),e.ranges)for(a=0;a<e.ranges.length;a++)n=e.ranges[a],t.createRange(n.name,n.from,n.to);return t}static AppendSerializedAnimations(e,t){_e.AppendSerializedAnimations(e,t)}static async ParseFromFileAsync(e,t){return await new Promise((i,r)=>{let n=new gi;n.addEventListener("readystatechange",()=>{if(n.readyState==4)if(n.status==200){let a=JSON.parse(n.responseText);if(a.animations&&(a=a.animations),a.length){let o=[];for(let l of a)o.push(this.Parse(l));i(o)}else{let o=this.Parse(a);e&&(o.name=e),i(o)}}else r("Unable to load the animation")}),n.open("GET",t),n.send()})}static async ParseFromSnippetAsync(e){return await new Promise((t,i)=>{let r=new gi;r.addEventListener("readystatechange",()=>{if(r.readyState==4)if(r.status==200){let n=JSON.parse(JSON.parse(r.responseText).jsonPayload);if(n.animations){let a=JSON.parse(n.animations),o=[];for(let l of a.animations){let c=this.Parse(l);c.snippetId=e,o.push(c)}t(o)}else{let a=JSON.parse(n.animation),o=this.Parse(a);o.snippetId=e,t(o)}}else i("Unable to load the snippet "+e)}),r.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),r.send()})}};q._UniqueIdGenerator=0;q.AllowMatricesInterpolation=!1;q.AllowMatrixDecomposeForInterpolation=!0;q.SnippetUrl="https://snippet.babylonjs.com";q.ANIMATIONTYPE_FLOAT=0;q.ANIMATIONTYPE_VECTOR3=1;q.ANIMATIONTYPE_QUATERNION=2;q.ANIMATIONTYPE_MATRIX=3;q.ANIMATIONTYPE_COLOR3=4;q.ANIMATIONTYPE_COLOR4=7;q.ANIMATIONTYPE_VECTOR2=5;q.ANIMATIONTYPE_SIZE=6;q.ANIMATIONLOOPMODE_RELATIVE=0;q.ANIMATIONLOOPMODE_CYCLE=1;q.ANIMATIONLOOPMODE_CONSTANT=2;q.ANIMATIONLOOPMODE_YOYO=4;q.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT=5;q.CreateFromSnippetAsync=q.ParseFromSnippetAsync;G("BABYLON.Animation",q);_t._AnimationRangeFactory=(s,e,t)=>new Yo(s,e,t)});var p_,SC,Yr,EC=S(()=>{Ye();je();Vn();ie();xr();Ph();rs();_t.AddNodeConstructor("TargetCamera",(s,e)=>()=>new Yr(s,E.Zero(),e));p_=B.Zero(),SC=K.Identity(),Yr=class s extends ye{constructor(e,t,i,r=!0){super(e,t,i,r),this.cameraDirection=new E(0,0,0),this.cameraRotation=new he(0,0),this.updateUpVectorFromRotation=!1,this.speed=2,this.noRotationConstraint=!1,this.invertRotation=!1,this.inverseRotationSpeed=.2,this.lockedTarget=null,this._currentTarget=E.Zero(),this._initialFocalDistance=1,this._viewMatrix=B.Zero(),this._cameraTransformMatrix=B.Zero(),this._cameraRotationMatrix=B.Zero(),this._transformedReferencePoint=E.Zero(),this._deferredPositionUpdate=new E,this._deferredRotationQuaternionUpdate=new K,this._deferredRotationUpdate=new E,this._deferredUpdated=!1,this._deferOnly=!1,this._cachedRotationZ=0,this._cachedQuaternionRotationZ=0,this._referencePoint=E.Forward(this.getScene().useRightHandedSystem),this.rotation=new E(0,this.getScene().useRightHandedSystem?Math.PI:0,0)}getFrontPosition(e){this.getWorldMatrix();let t=w.Vector3[0],i=w.Vector3[1];return i.set(0,0,this._scene.useRightHandedSystem?-1:1),this.getDirectionToRef(i,t),t.scaleInPlace(e),this.globalPosition.add(t)}_getLockedTargetPosition(){if(!this.lockedTarget)return null;if(this.lockedTarget.absolutePosition){let e=this.lockedTarget;e.computeWorldMatrix().getTranslationToRef(e.absolutePosition)}return this.lockedTarget.absolutePosition||this.lockedTarget}storeState(){return this._storedPosition=this.position.clone(),this._storedRotation=this.rotation.clone(),this.rotationQuaternion&&(this._storedRotationQuaternion=this.rotationQuaternion.clone()),super.storeState()}_restoreStateValues(){return super._restoreStateValues()?(this.position=this._storedPosition.clone(),this.rotation=this._storedRotation.clone(),this.rotationQuaternion&&(this.rotationQuaternion=this._storedRotationQuaternion.clone()),this.cameraDirection.copyFromFloats(0,0,0),this.cameraRotation.copyFromFloats(0,0),!0):!1}_initCache(){super._initCache(),this._cache.lockedTarget=new E(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotation=new E(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotationQuaternion=new K(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)}_updateCache(e){e||super._updateCache();let t=this._getLockedTargetPosition();t?this._cache.lockedTarget?this._cache.lockedTarget.copyFrom(t):this._cache.lockedTarget=t.clone():this._cache.lockedTarget=null,this._cache.rotation.copyFrom(this.rotation),this.rotationQuaternion&&this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion)}_isSynchronizedViewMatrix(){if(!super._isSynchronizedViewMatrix())return!1;let e=this._getLockedTargetPosition();return(this._cache.lockedTarget?this._cache.lockedTarget.equals(e):!e)&&(this.rotationQuaternion?this.rotationQuaternion.equals(this._cache.rotationQuaternion):this._cache.rotation.equals(this.rotation))}_computeLocalCameraSpeed(){let e=this.getEngine();return this.speed*Math.sqrt(e.getDeltaTime()/(e.getFps()*100))}setTarget(e){this.upVector.normalize(),this._initialFocalDistance=e.subtract(this.position).length(),this.position.z===e.z&&(this.position.z+=We),this._referencePoint.normalize().scaleInPlace(this._initialFocalDistance),this.getScene().useRightHandedSystem?B.LookAtRHToRef(this.position,e,E.UpReadOnly,p_):B.LookAtLHToRef(this.position,e,E.UpReadOnly,p_),p_.invert();let t=this.rotationQuaternion||SC;K.FromRotationMatrixToRef(p_,t),t.toEulerAnglesToRef(this.rotation),this.rotation.z=0}get target(){return this.getTarget()}set target(e){this.setTarget(e)}getTarget(){return this._currentTarget}_decideIfNeedsToMove(){return Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){if(this.parent){this.parent.getWorldMatrix().invertToRef(w.Matrix[0]),E.TransformNormalToRef(this.cameraDirection,w.Matrix[0],w.Vector3[0]),this._deferredPositionUpdate.addInPlace(w.Vector3[0]),this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate);return}this._deferredPositionUpdate.addInPlace(this.cameraDirection),this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate)}_checkInputs(){let e=this.invertRotation?-this.inverseRotationSpeed:1,t=this._decideIfNeedsToMove(),i=this.cameraRotation.x||this.cameraRotation.y;this._deferredUpdated=!1,this._deferredRotationUpdate.copyFrom(this.rotation),this._deferredPositionUpdate.copyFrom(this.position),this.rotationQuaternion&&this._deferredRotationQuaternionUpdate.copyFrom(this.rotationQuaternion),t&&this._updatePosition(),i&&(this.rotationQuaternion&&this.rotationQuaternion.toEulerAnglesToRef(this._deferredRotationUpdate),this._deferredRotationUpdate.x+=this.cameraRotation.x*e,this._deferredRotationUpdate.y+=this.cameraRotation.y*e,this.noRotationConstraint||(this._deferredRotationUpdate.x>1.570796&&(this._deferredRotationUpdate.x=1.570796),this._deferredRotationUpdate.x<-1.570796&&(this._deferredRotationUpdate.x=-1.570796)),this._deferOnly?this._deferredUpdated=!0:this.rotation.copyFrom(this._deferredRotationUpdate),this.rotationQuaternion&&this._deferredRotationUpdate.lengthSquared()&&(K.RotationYawPitchRollToRef(this._deferredRotationUpdate.y,this._deferredRotationUpdate.x,this._deferredRotationUpdate.z,this._deferredRotationQuaternionUpdate),this._deferOnly?this._deferredUpdated=!0:this.rotationQuaternion.copyFrom(this._deferredRotationQuaternionUpdate))),t&&(Math.abs(this.cameraDirection.x)<this.speed*We&&(this.cameraDirection.x=0),Math.abs(this.cameraDirection.y)<this.speed*We&&(this.cameraDirection.y=0),Math.abs(this.cameraDirection.z)<this.speed*We&&(this.cameraDirection.z=0),this.cameraDirection.scaleInPlace(this.inertia)),i&&(Math.abs(this.cameraRotation.x)<this.speed*We&&(this.cameraRotation.x=0),Math.abs(this.cameraRotation.y)<this.speed*We&&(this.cameraRotation.y=0),this.cameraRotation.scaleInPlace(this.inertia)),super._checkInputs()}_updateCameraRotationMatrix(){this.rotationQuaternion?this.rotationQuaternion.toRotationMatrix(this._cameraRotationMatrix):B.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix)}_rotateUpVectorWithCameraRotationMatrix(){return E.TransformNormalToRef(E.UpReadOnly,this._cameraRotationMatrix,this.upVector),this}_getViewMatrix(){return this.lockedTarget&&this.setTarget(this._getLockedTargetPosition()),this._updateCameraRotationMatrix(),this.rotationQuaternion&&this._cachedQuaternionRotationZ!=this.rotationQuaternion.z?(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedQuaternionRotationZ=this.rotationQuaternion.z):this._cachedRotationZ!==this.rotation.z&&(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedRotationZ=this.rotation.z),E.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget),this.updateUpVectorFromRotation&&(this.rotationQuaternion?Ms.Y.rotateByQuaternionToRef(this.rotationQuaternion,this.upVector):(K.FromEulerVectorToRef(this.rotation,SC),Ms.Y.rotateByQuaternionToRef(SC,this.upVector))),this._computeViewMatrix(this.position,this._currentTarget,this.upVector),this._viewMatrix}_computeViewMatrix(e,t,i){if(this.getScene().useRightHandedSystem?B.LookAtRHToRef(e,t,i,this._viewMatrix):B.LookAtLHToRef(e,t,i,this._viewMatrix),this.parent){let r=this.parent.getWorldMatrix();this._viewMatrix.invert(),this._viewMatrix.multiplyToRef(r,this._viewMatrix),this._viewMatrix.getTranslationToRef(this._globalPosition),this._viewMatrix.invert(),this._markSyncedWithParent()}else this._globalPosition.copyFrom(e)}createRigCamera(e,t){if(this.cameraRigMode!==ye.RIG_MODE_NONE){let i=new s(e,this.position.clone(),this.getScene());return i.isRigCamera=!0,i.rigParent=this,this.cameraRigMode===ye.RIG_MODE_VR&&(this.rotationQuaternion||(this.rotationQuaternion=new K),i._cameraRigParams={},i.rotationQuaternion=new K),i.mode=this.mode,i.orthoLeft=this.orthoLeft,i.orthoRight=this.orthoRight,i.orthoTop=this.orthoTop,i.orthoBottom=this.orthoBottom,i}return null}_updateRigCameras(){let e=this._rigCameras[0],t=this._rigCameras[1];switch(this.computeWorldMatrix(),this.cameraRigMode){case ye.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case ye.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case ye.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:case ye.RIG_MODE_STEREOSCOPIC_OVERUNDER:case ye.RIG_MODE_STEREOSCOPIC_INTERLACED:{let i=this.cameraRigMode===ye.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?1:-1,r=this.cameraRigMode===ye.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?-1:1;this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*i,e),this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*r,t);break}case ye.RIG_MODE_VR:e.rotationQuaternion?(e.rotationQuaternion.copyFrom(this.rotationQuaternion),t.rotationQuaternion.copyFrom(this.rotationQuaternion)):(e.rotation.copyFrom(this.rotation),t.rotation.copyFrom(this.rotation)),e.position.copyFrom(this.position),t.position.copyFrom(this.position);break}super._updateRigCameras()}_getRigCamPositionAndTarget(e,t){this.getTarget().subtractToRef(this.position,s._TargetFocalPoint),s._TargetFocalPoint.normalize().scaleInPlace(this._initialFocalDistance);let r=s._TargetFocalPoint.addInPlace(this.position);B.TranslationToRef(-r.x,-r.y,-r.z,s._TargetTransformMatrix),s._TargetTransformMatrix.multiplyToRef(B.RotationAxis(t.upVector,e),s._RigCamTransformMatrix),B.TranslationToRef(r.x,r.y,r.z,s._TargetTransformMatrix),s._RigCamTransformMatrix.multiplyToRef(s._TargetTransformMatrix,s._RigCamTransformMatrix),E.TransformCoordinatesToRef(this.position,s._RigCamTransformMatrix,t.position),t.setTarget(r)}getClassName(){return"TargetCamera"}};Yr._RigCamTransformMatrix=new B;Yr._TargetTransformMatrix=new B;Yr._TargetFocalPoint=new E;x([y()],Yr.prototype,"updateUpVectorFromRotation",void 0);x([oi()],Yr.prototype,"rotation",void 0);x([y()],Yr.prototype,"speed",void 0);x([sp("lockedTargetId")],Yr.prototype,"lockedTarget",void 0)});var ur,Cf,Yn=S(()=>{Ee();ei();Vn();ur={},Cf=class{constructor(e){this.attachedToElement=!1,this.attached={},this.camera=e,this.checkInputs=()=>{}}add(e){let t=e.getSimpleName();if(this.attached[t]){P.Warn("camera input of type "+t+" already exists on camera");return}this.attached[t]=e,e.camera=this.camera,e.checkInputs&&(this.checkInputs=this._addCheckInputs(e.checkInputs.bind(e))),this.attachedToElement&&e.attachControl(this.noPreventDefault)}remove(e){for(let t in this.attached){let i=this.attached[t];if(i===e){i.detachControl(),i.camera=null,delete this.attached[t],this.rebuildInputCheck();return}}}removeByType(e){for(let t in this.attached){let i=this.attached[t];i.getClassName()===e&&(i.detachControl(),i.camera=null,delete this.attached[t],this.rebuildInputCheck())}}_addCheckInputs(e){let t=this.checkInputs;return()=>{t(),e()}}attachInput(e){this.attachedToElement&&e.attachControl(this.noPreventDefault)}attachElement(e=!1){if(!this.attachedToElement){e=ye.ForceAttachControlToAlwaysPreventDefault?!1:e,this.attachedToElement=!0,this.noPreventDefault=e;for(let t in this.attached)this.attached[t].attachControl(e)}}detachElement(e=!1){for(let t in this.attached)this.attached[t].detachControl(),e&&(this.attached[t].camera=null);this.attachedToElement=!1}rebuildInputCheck(){this.checkInputs=()=>{};for(let e in this.attached){let t=this.attached[e];t.checkInputs&&(this.checkInputs=this._addCheckInputs(t.checkInputs.bind(t)))}}clear(){this.attachedToElement&&this.detachElement(!0),this.attached={},this.attachedToElement=!1,this.checkInputs=()=>{}}serialize(e){let t={};for(let i in this.attached){let r=this.attached[i],n=_e.Serialize(r);t[r.getClassName()]=n}e.inputsmgr=t}parse(e){let t=e.inputsmgr;if(t){this.clear();for(let i in t){let r=ur[i];if(r){let n=t[i],a=_e.Parse(()=>new r,n,null);this.add(a)}}}else for(let i in this.attached){let r=ur[this.attached[i].getClassName()];if(r){let n=_e.Parse(()=>new r,e,null);this.remove(this.attached[i]),this.add(n)}}}}});var L,If=S(()=>{L=class{};L.AUTOSAMPLERSUFFIX="Sampler";L.DISABLEUA="#define DISABLE_UNIFORMITY_ANALYSIS";L.ALPHA_DISABLE=0;L.ALPHA_ADD=1;L.ALPHA_COMBINE=2;L.ALPHA_SUBTRACT=3;L.ALPHA_MULTIPLY=4;L.ALPHA_MAXIMIZED=5;L.ALPHA_ONEONE=6;L.ALPHA_PREMULTIPLIED=7;L.ALPHA_PREMULTIPLIED_PORTERDUFF=8;L.ALPHA_INTERPOLATE=9;L.ALPHA_SCREENMODE=10;L.ALPHA_ONEONE_ONEONE=11;L.ALPHA_ALPHATOCOLOR=12;L.ALPHA_REVERSEONEMINUS=13;L.ALPHA_SRC_DSTONEMINUSSRCALPHA=14;L.ALPHA_ONEONE_ONEZERO=15;L.ALPHA_EXCLUSION=16;L.ALPHA_LAYER_ACCUMULATE=17;L.ALPHA_MIN=18;L.ALPHA_MAX=19;L.ALPHA_DUAL_SRC0_ADD_SRC1xDST=20;L.ALPHA_EQUATION_ADD=0;L.ALPHA_EQUATION_SUBSTRACT=1;L.ALPHA_EQUATION_REVERSE_SUBTRACT=2;L.ALPHA_EQUATION_MAX=3;L.ALPHA_EQUATION_MIN=4;L.ALPHA_EQUATION_DARKEN=5;L.DELAYLOADSTATE_NONE=0;L.DELAYLOADSTATE_LOADED=1;L.DELAYLOADSTATE_LOADING=2;L.DELAYLOADSTATE_NOTLOADED=4;L.NEVER=512;L.ALWAYS=519;L.LESS=513;L.EQUAL=514;L.LEQUAL=515;L.GREATER=516;L.GEQUAL=518;L.NOTEQUAL=517;L.KEEP=7680;L.ZERO=0;L.REPLACE=7681;L.INCR=7682;L.DECR=7683;L.INVERT=5386;L.INCR_WRAP=34055;L.DECR_WRAP=34056;L.TEXTURE_CLAMP_ADDRESSMODE=0;L.TEXTURE_WRAP_ADDRESSMODE=1;L.TEXTURE_MIRROR_ADDRESSMODE=2;L.TEXTURE_CREATIONFLAG_STORAGE=1;L.TEXTUREFORMAT_ALPHA=0;L.TEXTUREFORMAT_LUMINANCE=1;L.TEXTUREFORMAT_LUMINANCE_ALPHA=2;L.TEXTUREFORMAT_RGB=4;L.TEXTUREFORMAT_RGBA=5;L.TEXTUREFORMAT_RED=6;L.TEXTUREFORMAT_R=6;L.TEXTUREFORMAT_R16_UNORM=33322;L.TEXTUREFORMAT_RG16_UNORM=33324;L.TEXTUREFORMAT_RGB16_UNORM=32852;L.TEXTUREFORMAT_RGBA16_UNORM=32859;L.TEXTUREFORMAT_R16_SNORM=36760;L.TEXTUREFORMAT_RG16_SNORM=36761;L.TEXTUREFORMAT_RGB16_SNORM=36762;L.TEXTUREFORMAT_RGBA16_SNORM=36763;L.TEXTUREFORMAT_RG=7;L.TEXTUREFORMAT_RED_INTEGER=8;L.TEXTUREFORMAT_R_INTEGER=8;L.TEXTUREFORMAT_RG_INTEGER=9;L.TEXTUREFORMAT_RGB_INTEGER=10;L.TEXTUREFORMAT_RGBA_INTEGER=11;L.TEXTUREFORMAT_BGRA=12;L.TEXTUREFORMAT_DEPTH24_STENCIL8=13;L.TEXTUREFORMAT_DEPTH32_FLOAT=14;L.TEXTUREFORMAT_DEPTH16=15;L.TEXTUREFORMAT_DEPTH24=16;L.TEXTUREFORMAT_DEPTH24UNORM_STENCIL8=17;L.TEXTUREFORMAT_DEPTH32FLOAT_STENCIL8=18;L.TEXTUREFORMAT_STENCIL8=19;L.TEXTUREFORMAT_UNDEFINED=4294967295;L.TEXTUREFORMAT_COMPRESSED_RGBA_BPTC_UNORM=36492;L.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_BPTC_UNORM=36493;L.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT=36495;L.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_SIGNED_FLOAT=36494;L.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT5=33779;L.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919;L.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT3=33778;L.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918;L.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT1=33777;L.TEXTUREFORMAT_COMPRESSED_RGB_S3TC_DXT1=33776;L.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917;L.TEXTUREFORMAT_COMPRESSED_SRGB_S3TC_DXT1_EXT=35916;L.TEXTUREFORMAT_COMPRESSED_RGBA_ASTC_4x4=37808;L.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840;L.TEXTUREFORMAT_COMPRESSED_RGB_ETC1_WEBGL=36196;L.TEXTUREFORMAT_COMPRESSED_RGB8_ETC2=37492;L.TEXTUREFORMAT_COMPRESSED_SRGB8_ETC2=37493;L.TEXTUREFORMAT_COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494;L.TEXTUREFORMAT_COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495;L.TEXTUREFORMAT_COMPRESSED_RGBA8_ETC2_EAC=37496;L.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497;L.TEXTURETYPE_UNSIGNED_BYTE=0;L.TEXTURETYPE_UNSIGNED_INT=0;L.TEXTURETYPE_FLOAT=1;L.TEXTURETYPE_HALF_FLOAT=2;L.TEXTURETYPE_BYTE=3;L.TEXTURETYPE_SHORT=4;L.TEXTURETYPE_UNSIGNED_SHORT=5;L.TEXTURETYPE_INT=6;L.TEXTURETYPE_UNSIGNED_INTEGER=7;L.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8;L.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9;L.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10;L.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11;L.TEXTURETYPE_UNSIGNED_INT_24_8=12;L.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13;L.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14;L.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15;L.TEXTURETYPE_UNDEFINED=16;L.TEXTURE_2D=3553;L.TEXTURE_2D_ARRAY=35866;L.TEXTURE_CUBE_MAP=34067;L.TEXTURE_CUBE_MAP_ARRAY=3735928559;L.TEXTURE_3D=32879;L.TEXTURE_NEAREST_SAMPLINGMODE=1;L.TEXTURE_NEAREST_NEAREST=1;L.TEXTURE_BILINEAR_SAMPLINGMODE=2;L.TEXTURE_LINEAR_LINEAR=2;L.TEXTURE_TRILINEAR_SAMPLINGMODE=3;L.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3;L.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4;L.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5;L.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6;L.TEXTURE_NEAREST_LINEAR=7;L.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8;L.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9;L.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10;L.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11;L.TEXTURE_LINEAR_NEAREST=12;L.TEXTURE_EXPLICIT_MODE=0;L.TEXTURE_SPHERICAL_MODE=1;L.TEXTURE_PLANAR_MODE=2;L.TEXTURE_CUBIC_MODE=3;L.TEXTURE_PROJECTION_MODE=4;L.TEXTURE_SKYBOX_MODE=5;L.TEXTURE_INVCUBIC_MODE=6;L.TEXTURE_EQUIRECTANGULAR_MODE=7;L.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8;L.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9;L.TEXTURE_FILTERING_QUALITY_OFFLINE=4096;L.TEXTURE_FILTERING_QUALITY_HIGH=64;L.TEXTURE_FILTERING_QUALITY_MEDIUM=16;L.TEXTURE_FILTERING_QUALITY_LOW=8;L.SCALEMODE_FLOOR=1;L.SCALEMODE_NEAREST=2;L.SCALEMODE_CEILING=3;L.MATERIAL_TextureDirtyFlag=1;L.MATERIAL_LightDirtyFlag=2;L.MATERIAL_FresnelDirtyFlag=4;L.MATERIAL_AttributesDirtyFlag=8;L.MATERIAL_MiscDirtyFlag=16;L.MATERIAL_PrePassDirtyFlag=32;L.MATERIAL_ImageProcessingDirtyFlag=64;L.MATERIAL_AllDirtyFlag=127;L.MATERIAL_TriangleFillMode=0;L.MATERIAL_WireFrameFillMode=1;L.MATERIAL_PointFillMode=2;L.MATERIAL_PointListDrawMode=3;L.MATERIAL_LineListDrawMode=4;L.MATERIAL_LineLoopDrawMode=5;L.MATERIAL_LineStripDrawMode=6;L.MATERIAL_TriangleStripDrawMode=7;L.MATERIAL_TriangleFanDrawMode=8;L.MATERIAL_ClockWiseSideOrientation=0;L.MATERIAL_CounterClockWiseSideOrientation=1;L.MATERIAL_DIFFUSE_MODEL_E_OREN_NAYAR=0;L.MATERIAL_DIFFUSE_MODEL_BURLEY=1;L.MATERIAL_DIFFUSE_MODEL_LAMBERT=2;L.MATERIAL_DIFFUSE_MODEL_LEGACY=3;L.MATERIAL_DIELECTRIC_SPECULAR_MODEL_GLTF=0;L.MATERIAL_DIELECTRIC_SPECULAR_MODEL_OPENPBR=1;L.MATERIAL_CONDUCTOR_SPECULAR_MODEL_GLTF=0;L.MATERIAL_CONDUCTOR_SPECULAR_MODEL_OPENPBR=1;L.ACTION_NothingTrigger=0;L.ACTION_OnPickTrigger=1;L.ACTION_OnLeftPickTrigger=2;L.ACTION_OnRightPickTrigger=3;L.ACTION_OnCenterPickTrigger=4;L.ACTION_OnPickDownTrigger=5;L.ACTION_OnDoublePickTrigger=6;L.ACTION_OnPickUpTrigger=7;L.ACTION_OnPickOutTrigger=16;L.ACTION_OnLongPressTrigger=8;L.ACTION_OnPointerOverTrigger=9;L.ACTION_OnPointerOutTrigger=10;L.ACTION_OnEveryFrameTrigger=11;L.ACTION_OnIntersectionEnterTrigger=12;L.ACTION_OnIntersectionExitTrigger=13;L.ACTION_OnKeyDownTrigger=14;L.ACTION_OnKeyUpTrigger=15;L.PARTICLES_BILLBOARDMODE_Y=2;L.PARTICLES_BILLBOARDMODE_ALL=7;L.PARTICLES_BILLBOARDMODE_STRETCHED=8;L.PARTICLES_BILLBOARDMODE_STRETCHED_LOCAL=9;L.MESHES_CULLINGSTRATEGY_STANDARD=0;L.MESHES_CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1;L.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2;L.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3;L.SCENELOADER_NO_LOGGING=0;L.SCENELOADER_MINIMAL_LOGGING=1;L.SCENELOADER_SUMMARY_LOGGING=2;L.SCENELOADER_DETAILED_LOGGING=3;L.PREPASS_IRRADIANCE_TEXTURE_TYPE=0;L.PREPASS_POSITION_TEXTURE_TYPE=1;L.PREPASS_VELOCITY_TEXTURE_TYPE=2;L.PREPASS_REFLECTIVITY_TEXTURE_TYPE=3;L.PREPASS_COLOR_TEXTURE_TYPE=4;L.PREPASS_DEPTH_TEXTURE_TYPE=5;L.PREPASS_NORMAL_TEXTURE_TYPE=6;L.PREPASS_ALBEDO_SQRT_TEXTURE_TYPE=7;L.PREPASS_WORLD_NORMAL_TEXTURE_TYPE=8;L.PREPASS_LOCAL_POSITION_TEXTURE_TYPE=9;L.PREPASS_SCREENSPACE_DEPTH_TEXTURE_TYPE=10;L.PREPASS_VELOCITY_LINEAR_TEXTURE_TYPE=11;L.PREPASS_ALBEDO_TEXTURE_TYPE=12;L.PREPASS_NORMALIZED_VIEW_DEPTH_TEXTURE_TYPE=13;L.BUFFER_CREATIONFLAG_READ=1;L.BUFFER_CREATIONFLAG_WRITE=2;L.BUFFER_CREATIONFLAG_READWRITE=3;L.BUFFER_CREATIONFLAG_UNIFORM=4;L.BUFFER_CREATIONFLAG_VERTEX=8;L.BUFFER_CREATIONFLAG_INDEX=16;L.BUFFER_CREATIONFLAG_STORAGE=32;L.BUFFER_CREATIONFLAG_INDIRECT=64;L.RENDERPASS_MAIN=0;L.INPUT_ALT_KEY=18;L.INPUT_CTRL_KEY=17;L.INPUT_META_KEY1=91;L.INPUT_META_KEY2=92;L.INPUT_META_KEY3=93;L.INPUT_SHIFT_KEY=16;L.SNAPSHOTRENDERING_STANDARD=0;L.SNAPSHOTRENDERING_FAST=1;L.PERSPECTIVE_CAMERA=0;L.ORTHOGRAPHIC_CAMERA=1;L.FOVMODE_VERTICAL_FIXED=0;L.FOVMODE_HORIZONTAL_FIXED=1;L.RIG_MODE_NONE=0;L.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10;L.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11;L.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12;L.RIG_MODE_STEREOSCOPIC_OVERUNDER=13;L.RIG_MODE_STEREOSCOPIC_INTERLACED=14;L.RIG_MODE_VR=20;L.RIG_MODE_CUSTOM=22;L.MAX_SUPPORTED_UV_SETS=6;L.GL_ALPHA_EQUATION_ADD=32774;L.GL_ALPHA_EQUATION_MIN=32775;L.GL_ALPHA_EQUATION_MAX=32776;L.GL_ALPHA_EQUATION_SUBTRACT=32778;L.GL_ALPHA_EQUATION_REVERSE_SUBTRACT=32779;L.GL_ALPHA_FUNCTION_SRC=768;L.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_COLOR=769;L.GL_ALPHA_FUNCTION_SRC_ALPHA=770;L.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_ALPHA=771;L.GL_ALPHA_FUNCTION_DST_ALPHA=772;L.GL_ALPHA_FUNCTION_ONE_MINUS_DST_ALPHA=773;L.GL_ALPHA_FUNCTION_DST_COLOR=774;L.GL_ALPHA_FUNCTION_ONE_MINUS_DST_COLOR=775;L.GL_ALPHA_FUNCTION_SRC_ALPHA_SATURATED=776;L.GL_ALPHA_FUNCTION_CONSTANT_COLOR=32769;L.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_COLOR=32770;L.GL_ALPHA_FUNCTION_CONSTANT_ALPHA=32771;L.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_ALPHA=32772;L.GL_ALPHA_FUNCTION_SRC1_COLOR=35065;L.GL_ALPHA_FUNCTION_ONE_MINUS_SRC1_COLOR=35066;L.GL_ALPHA_FUNCTION_SRC1_ALPHA=34185;L.GL_ALPHA_FUNCTION_ONE_MINUS_SRC1_ALPHA=35067;L.SnippetUrl="https://snippet.babylonjs.com";L.FOGMODE_NONE=0;L.FOGMODE_EXP=1;L.FOGMODE_EXP2=2;L.FOGMODE_LINEAR=3;L.BYTE=5120;L.UNSIGNED_BYTE=5121;L.SHORT=5122;L.UNSIGNED_SHORT=5123;L.INT=5124;L.UNSIGNED_INT=5125;L.FLOAT=5126;L.PositionKind="position";L.NormalKind="normal";L.TangentKind="tangent";L.UVKind="uv";L.UV2Kind="uv2";L.UV3Kind="uv3";L.UV4Kind="uv4";L.UV5Kind="uv5";L.UV6Kind="uv6";L.ColorKind="color";L.ColorInstanceKind="instanceColor";L.MatricesIndicesKind="matricesIndices";L.MatricesWeightsKind="matricesWeights";L.MatricesIndicesExtraKind="matricesIndicesExtra";L.MatricesWeightsExtraKind="matricesWeightsExtra";L.ANIMATIONTYPE_FLOAT=0;L.ANIMATIONTYPE_VECTOR3=1;L.ANIMATIONTYPE_QUATERNION=2;L.ANIMATIONTYPE_MATRIX=3;L.ANIMATIONTYPE_COLOR3=4;L.ANIMATIONTYPE_COLOR4=7;L.ANIMATIONTYPE_VECTOR2=5;L.ANIMATIONTYPE_SIZE=6;L.ShadowMinZ=0;L.ShadowMaxZ=1e4});async function _B(s,e){let t=e.method||"GET";return await new Promise((i,r)=>{let n=new gi;n.addEventListener("readystatechange",()=>{if(n.readyState==4)if(n.status==200){let a={};if(e.responseHeaders)for(let o of e.responseHeaders)a[o]=n.getResponseHeader(o)||"";i({response:n.response,headerValues:a})}else r(`Unable to fetch data from ${s}. Error code: ${n.status}`)}),n.open(t,s),n.send()})}var gB=S(()=>{bc()});function TZ(s){return!!s.createPlugin}function xZ(s){return!!s.name}function __(){return qn[".babylon"]}function AZ(s){for(let e in qn){let t=qn[e];if(t.mimeType===s)return t}}function RC(s,e){let t=qn[s];return t||(P.Warn("Unable to find a plugin to load "+s+" files. Trying to use .babylon default plugin. To load from a specific filetype (eg. gltf) see: https://doc.babylonjs.com/features/featuresDeepDive/importers/loadingFileTypes"),e?__():void 0)}function RZ(s){return!!qn[s]}function bZ(s){for(let e in qn){let t=qn[e].plugin;if(t.canDirectLoad&&t.canDirectLoad(s))return qn[e]}return __()}function CZ(s){let e=s.indexOf("?");e!==-1&&(s=s.substring(0,e));let t=s.lastIndexOf(".");return s.substring(t,s.length).toLowerCase()}function IZ(s){return s.substring(0,5)==="data:"?s.substring(5):null}function bC(s,e,t){let r="Unable to load from "+(s.rawData?"binary data":s.url);return e?r+=`: ${e}`:t&&(r+=`: ${t}`),r}async function CC(s,e,t,i,r,n,a,o,l){let c=IZ(s.url);if(s.rawData&&!a)throw"When using ArrayBufferView to load data the file extension must be provided.";let f=!c&&!a?CZ(s.url):"",h=a?RC(a,!0):c?bZ(s.url):RC(f,!1);if(!h&&f){if(s.url&&!s.url.startsWith("blob:")){let d=await _B(s.url,{method:"HEAD",responseHeaders:["Content-Type"]}),p=d.headerValues?d.headerValues["Content-Type"]:"";p&&(h=AZ(p))}h||(h=__())}if(!h)throw new Error(`No plugin or fallback for ${a??s.url}`);if(l?.[h.plugin.name]?.enabled===!1)throw new Error(`The '${h.plugin.name}' plugin is disabled via the loader options passed to the loading operation.`);if(s.rawData&&!h.isBinary)throw"Loading from ArrayBufferView can not be used with plugins that don't support binary loading.";return(d=>{if(TZ(h.plugin)){let m=h.plugin.createPlugin(l??{});return m instanceof Promise?(m.then(d).catch(_=>{r("Error instantiating plugin.",_)}),null):(d(m),m)}else return d(h.plugin),h.plugin})(d=>{if(!d)throw`The loader plugin corresponding to the '${a}' file type has not been found. If using es6, please import the plugin you wish to use before.`;if(SB.notifyObservers(d),c&&(d.canDirectLoad&&d.canDirectLoad(s.url)||!wl(s.url))){if(d.directLoad){let R=d.directLoad(e,c);R instanceof Promise?R.then(b=>{t(d,b)}).catch(b=>{r("Error in directLoad of _loadData: "+b,b)}):t(d,R)}else t(d,c);return}let p=h.isBinary,m=(R,b)=>{if(e.isDisposed){r("Scene has been disposed");return}t(d,R,b)},_=null,v=!1;d.onDisposeObservable?.add(()=>{v=!0,_&&(_.abort(),_=null),n()});let T=()=>{if(v)return;let R=(b,M)=>{r(b?.statusText,M)};if(!d.loadFile&&s.rawData)throw"Plugin does not support loading ArrayBufferView.";_=d.loadFile?d.loadFile(e,s.rawData||s.file||s.url,s.rootUrl,m,i,p,R,o):e._loadFile(s.file||s.url,m,i,!0,p,R)},C=e.getEngine(),I=C.enableOfflineSupport;if(I){let R=!1;for(let b of e.disableOfflineSupportExceptionRules)if(b.test(s.url)){R=!0;break}I=!R}I&&k.OfflineProviderFactory?e.offlineProvider=k.OfflineProviderFactory(s.url,T,C.disableManifestCheck):T()})}function IC(s,e){let t,i,r=null,n=null;if(!e)t=s,i=W.GetFilename(s),s=W.GetFolderPath(s);else if(xZ(e))t=`file:${e.name}`,i=e.name,r=e;else if(ArrayBuffer.isView(e))t="",i=Vi(),n=e;else if(e.startsWith("data:"))t=e,i="";else if(s){let a=e;if(a.substring(0,1)==="/")return W.Error("Wrong sceneFilename parameter"),null;t=s+a,i=a}else t=e,i=W.GetFilename(e),s=W.GetFolderPath(e);return{url:t,rootUrl:s,name:i,file:r,rawData:n}}function $i(s){if(typeof s.extensions=="string"){let e=s.extensions;qn[e.toLowerCase()]={plugin:s,isBinary:!1}}else{let e=s.extensions,t=Object.keys(e);for(let i of t)qn[i.toLowerCase()]={plugin:s,isBinary:e[i].isBinary,mimeType:e[i].mimeType}}}async function EB(s,e,t="",i=Z.LastCreatedScene,r=null,n=null,a=null,o=null,l="",c={}){if(!i)return P.Error("No scene available to import mesh to"),null;let f=IC(e,t);if(!f)return null;let h={};i.addPendingData(h);let u=()=>{i.removePendingData(h)},d=(_,v)=>{let T=bC(f,_,v);a?a(i,T,new Nr(T,Is.SceneLoaderError,v)):P.Error(T),u()},p=n?_=>{try{n(_)}catch(v){d("Error in onProgress callback: "+v,v)}}:void 0,m=(_,v,T,C,I,R,b,M)=>{if(i.importedMeshesFiles.push(f.url),r)try{r(_,v,T,C,I,R,b,M)}catch(F){d("Error in onSuccess callback: "+F,F)}i.removePendingData(h)};return await CC(f,i,(_,v,T)=>{if(_.rewriteRootURL&&(f.rootUrl=_.rewriteRootURL(f.rootUrl,T)),_.importMesh){let C=_,I=[],R=[],b=[];if(!C.importMesh(s,i,v,f.rootUrl,I,R,b,d))return;i.loadingPluginName=_.name,m(I,R,b,[],[],[],[],[])}else _.importMeshAsync(s,i,v,f.rootUrl,p,f.name).then(I=>{i.loadingPluginName=_.name,m(I.meshes,I.particleSystems,I.skeletons,I.animationGroups,I.transformNodes,I.geometries,I.lights,I.spriteManagers)}).catch(I=>{d(I.message,I)})},p,d,u,o,l,c)}async function yZ(s,e,t,i,r,n,a,o){return await new Promise((l,c)=>{try{EB(s,e,t,i,(f,h,u,d,p,m,_,v)=>{l({meshes:f,particleSystems:h,skeletons:u,animationGroups:d,transformNodes:p,geometries:m,lights:_,spriteManagers:v})},r,(f,h,u)=>{c(u||new Error(h))},n,a,o).catch(c)}catch(f){c(f)}})}async function TB(s,e="",t=Z.LastCreatedEngine,i=null,r=null,n=null,a=null,o="",l={}){if(!t){W.Error("No engine available");return}await yC(s,e,new ze(t),i,r,n,a,o,l)}async function MZ(s,e,t,i,r,n,a){return await new Promise((o,l)=>{TB(s,e,t,c=>{o(c)},i,(c,f,h)=>{l(h||new Error(f))},r,n,a)})}async function yC(s,e="",t=Z.LastCreatedScene,i=null,r=null,n=null,a=null,o="",l={}){if(!t)return P.Error("No scene available to append to"),null;let c=IC(s,e);if(!c)return null;let f={};t.addPendingData(f);let h=()=>{t.removePendingData(f)};Ti.ShowLoadingScreen&&!AC&&(AC=!0,t.getEngine().displayLoadingUI(),t.executeWhenReady(()=>{t.getEngine().hideLoadingUI(),AC=!1}));let u=(m,_)=>{let v=bC(c,m,_);n?n(t,v,new Nr(v,Is.SceneLoaderError,_)):P.Error(v),h()},d=r?m=>{try{r(m)}catch(_){u("Error in onProgress callback",_)}}:void 0,p=()=>{if(i)try{i(t)}catch(m){u("Error in onSuccess callback",m)}t.removePendingData(f)};return await CC(c,t,(m,_)=>{if(m.load){if(!m.load(t,_,c.rootUrl,u))return;t.loadingPluginName=m.name,p()}else m.loadAsync(t,_,c.rootUrl,d,c.name).then(()=>{t.loadingPluginName=m.name,p()}).catch(T=>{u(T.message,T)})},d,u,h,a,o,l)}async function PZ(s,e,t,i,r,n,a){return await new Promise((o,l)=>{try{yC(s,e,t,c=>{o(c)},i,(c,f,h)=>{l(h||new Error(f))},r,n,a).catch(l)}catch(c){l(c)}})}async function MC(s,e="",t=Z.LastCreatedScene,i=null,r=null,n=null,a=null,o="",l={}){if(!t)return P.Error("No scene available to load asset container to"),null;let c=IC(s,e);if(!c)return null;let f={};t.addPendingData(f);let h=()=>{t.removePendingData(f)},u=(m,_)=>{let v=bC(c,m,_);n?n(t,v,new Nr(v,Is.SceneLoaderError,_)):P.Error(v),h()},d=r?m=>{try{r(m)}catch(_){u("Error in onProgress callback",_)}}:void 0,p=m=>{if(i)try{i(m)}catch(_){u("Error in onSuccess callback",_)}t.removePendingData(f)};return await CC(c,t,(m,_)=>{if(m.loadAssetContainer){let T=m.loadAssetContainer(t,_,c.rootUrl,u);if(!T)return;T.populateRootNodes(),t.loadingPluginName=m.name,p(T)}else m.loadAssetContainerAsync?m.loadAssetContainerAsync(t,_,c.rootUrl,d,c.name).then(T=>{T.populateRootNodes(),t.loadingPluginName=m.name,p(T)}).catch(T=>{u(T.message,T)}):u("LoadAssetContainer is not supported by this plugin. Plugin did not provide a loadAssetContainer or loadAssetContainerAsync method.")},d,u,h,a,o,l)}async function xB(s,e,t){let{rootUrl:i="",onProgress:r,pluginExtension:n,name:a,pluginOptions:o}=t??{};return await AB(i,s,e,r,n,a,o)}async function AB(s,e,t,i,r,n,a){return await new Promise((o,l)=>{try{MC(s,e,t,c=>{o(c)},i,(c,f,h)=>{l(h||new Error(f))},r,n,a).catch(l)}catch(c){l(c)}})}async function RB(s,e="",t=Z.LastCreatedScene,i=!0,r=0,n=null,a=null,o=null,l=null,c=null,f="",h={}){if(!t){P.Error("No scene available to load animations to");return}if(i){for(let _ of t.animatables)_.reset();t.stopAllAnimations();let p=t.animationGroups.slice();for(let _ of p)_.dispose();let m=t.getNodes();for(let _ of m)_.animations&&(_.animations=[])}else switch(r){case 0:let p=t.animationGroups.slice();for(let m of p)m.dispose();break;case 1:for(let m of t.animationGroups)m.stop();break;case 2:for(let m of t.animationGroups)m.reset(),m.restart();break;case 3:break;default:P.Error("Unknown animation group loading mode value '"+r+"'");return}let u=t.animatables.length;await MC(s,e,t,p=>{p.mergeAnimationsTo(t,t.animatables.slice(u),n),p.dispose(),t.onAnimationFileImportedObservable.notifyObservers(t),a&&a(t)},o,l,c,f,h)}async function DZ(s,e,t,i,r,n,a,o,l,c){return await new Promise((f,h)=>{try{RB(s,e,t,i,r,n,u=>{f(u)},a,(u,d,p)=>{h(p||new Error(d))},o,l,c).catch(h)}catch(u){h(u)}})}var vB,SB,qn,AC,Bl,Qo=S(()=>{$e();we();Xr();gt();Ee();s_();To();Cc();pa();Jt();gB();(function(s){s[s.Clean=0]="Clean",s[s.Stop=1]="Stop",s[s.Sync=2]="Sync",s[s.NoSync=3]="NoSync"})(vB||(vB={}));SB=new N,qn={},AC=!1;Bl=class{static get ForceFullSceneLoadingForIncremental(){return Ti.ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(e){Ti.ForceFullSceneLoadingForIncremental=e}static get ShowLoadingScreen(){return Ti.ShowLoadingScreen}static set ShowLoadingScreen(e){Ti.ShowLoadingScreen=e}static get loggingLevel(){return Ti.loggingLevel}static set loggingLevel(e){Ti.loggingLevel=e}static get CleanBoneMatrixWeights(){return Ti.CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(e){Ti.CleanBoneMatrixWeights=e}static GetDefaultPlugin(){return __()}static GetPluginForExtension(e){return RC(e,!0)?.plugin}static IsPluginForExtensionAvailable(e){return RZ(e)}static RegisterPlugin(e){$i(e)}static ImportMesh(e,t,i,r,n,a,o,l,c,f){EB(e,t,i,r,n,a,o,l,c,f).catch(h=>o?.(Z.LastCreatedScene,h?.message,h))}static async ImportMeshAsync(e,t,i,r,n,a,o){return await yZ(e,t,i,r,n,a,o)}static Load(e,t,i,r,n,a,o,l){TB(e,t,i,r,n,a,o,l).catch(c=>a?.(Z.LastCreatedScene,c?.message,c))}static async LoadAsync(e,t,i,r,n,a){return await MZ(e,t,i,r,n,a)}static Append(e,t,i,r,n,a,o,l){yC(e,t,i,r,n,a,o,l).catch(c=>a?.(i??Z.LastCreatedScene,c?.message,c))}static async AppendAsync(e,t,i,r,n,a){return await PZ(e,t,i,r,n,a)}static LoadAssetContainer(e,t,i,r,n,a,o,l){MC(e,t,i,r,n,a,o,l).catch(c=>a?.(i??Z.LastCreatedScene,c?.message,c))}static async LoadAssetContainerAsync(e,t,i,r,n,a){return await AB(e,t,i,r,n,a)}static ImportAnimations(e,t,i,r,n,a,o,l,c,f,h){RB(e,t,i,r,n,a,o,l,c,f,h).catch(u=>c?.(i??Z.LastCreatedScene,u?.message,u))}static async ImportAnimationsAsync(e,t,i,r,n,a,o,l,c,f,h){return await DZ(e,t,i,r,n,a,l,f,h)}};Bl.NO_LOGGING=0;Bl.MINIMAL_LOGGING=1;Bl.SUMMARY_LOGGING=2;Bl.DETAILED_LOGGING=3;Bl.OnPluginActivatedObservable=SB});var ri,fs=S(()=>{ri=class{constructor(e){if(this.VERTEXOUTPUT_INVARIANT=!1,this._keys=[],this._isDirty=!0,this._areLightsDirty=!0,this._areLightsDisposed=!1,this._areAttributesDirty=!0,this._areTexturesDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._arePrePassDirty=!0,this._areImageProcessingDirty=!0,this._normals=!1,this._uvs=!1,this._needNormals=!1,this._needUVs=!1,this._externalProperties=e,e)for(let t in e)Object.prototype.hasOwnProperty.call(e,t)&&this._setDefaultValue(t)}get isDirty(){return this._isDirty}markAsProcessed(){this._isDirty=!1,this._areAttributesDirty=!1,this._areTexturesDirty=!1,this._areFresnelDirty=!1,this._areLightsDirty=!1,this._areLightsDisposed=!1,this._areMiscDirty=!1,this._arePrePassDirty=!1,this._areImageProcessingDirty=!1}markAsUnprocessed(){this._isDirty=!0}markAllAsDirty(){this._areTexturesDirty=!0,this._areAttributesDirty=!0,this._areLightsDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._arePrePassDirty=!0,this._areImageProcessingDirty=!0,this._isDirty=!0}markAsImageProcessingDirty(){this._areImageProcessingDirty=!0,this._isDirty=!0}markAsLightDirty(e=!1){this._areLightsDirty=!0,this._areLightsDisposed=this._areLightsDisposed||e,this._isDirty=!0}markAsAttributesDirty(){this._areAttributesDirty=!0,this._isDirty=!0}markAsTexturesDirty(){this._areTexturesDirty=!0,this._isDirty=!0}markAsFresnelDirty(){this._areFresnelDirty=!0,this._isDirty=!0}markAsMiscDirty(){this._areMiscDirty=!0,this._isDirty=!0}markAsPrePassDirty(){this._arePrePassDirty=!0,this._isDirty=!0}rebuild(){this._keys.length=0;for(let e of Object.keys(this))e[0]!=="_"&&this._keys.push(e);if(this._externalProperties)for(let e in this._externalProperties)this._keys.indexOf(e)===-1&&this._keys.push(e)}isEqual(e){if(this._keys.length!==e._keys.length)return!1;for(let t=0;t<this._keys.length;t++){let i=this._keys[t];if(this[i]!==e[i])return!1}return!0}cloneTo(e){this._keys.length!==e._keys.length&&(e._keys=this._keys.slice(0));for(let t=0;t<this._keys.length;t++){let i=this._keys[t];e[i]=this[i]}}reset(){for(let e of this._keys)this._setDefaultValue(e)}_setDefaultValue(e){let t=this._externalProperties?.[e]?.type??typeof this[e],i=this._externalProperties?.[e]?.default;switch(t){case"number":this[e]=i??0;break;case"string":this[e]=i??"";break;default:this[e]=i??!1;break}}toString(){let e="";for(let t=0;t<this._keys.length;t++){let i=this._keys[t],r=this[i];switch(typeof r){case"number":case"string":e+="#define "+i+" "+r+`
`;break;default:r&&(e+="#define "+i+`
`);break}}return e}}});var Fs,yf=S(()=>{ie();cs();Fs=class extends Q{constructor(e,t,i=!0,r=!1){super(e,t,void 0,r),this._normalMatrix=new B,this._storeEffectOnSubMeshes=i}getEffect(){return this._storeEffectOnSubMeshes?this._activeEffect:super.getEffect()}isReady(e,t){return e?!this._storeEffectOnSubMeshes||!e.subMeshes||e.subMeshes.length===0?!0:this.isReadyForSubMesh(e,e.subMeshes[0],t):!1}_isReadyForSubMesh(e){let t=e.materialDefines;return!!(!this.checkReadyOnEveryCall&&e.effect&&t&&t._renderId===this.getScene().getRenderId())}bindOnlyWorldMatrix(e){this._activeEffect.setMatrix("world",e)}bindOnlyNormalMatrix(e){this._activeEffect.setMatrix("normalMatrix",e)}bind(e,t){t&&this.bindForSubMesh(e,t,t.subMeshes[0])}_afterBind(e,t=null,i){super._afterBind(e,t,i),this.getScene()._cachedEffect=t,i?i._drawWrapper._forceRebindOnNextCall=!1:this._drawWrapper._forceRebindOnNextCall=!1}_mustRebind(e,t,i,r=1){return i._drawWrapper._forceRebindOnNextCall||e.isCachedMaterialInvalid(this,t,r)}dispose(e,t,i){this._activeEffect=void 0,super.dispose(e,t,i)}}});var X,fn=S(()=>{Jt();X=class{static get DiffuseTextureEnabled(){return this._DiffuseTextureEnabled}static set DiffuseTextureEnabled(e){this._DiffuseTextureEnabled!==e&&(this._DiffuseTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get BaseWeightTextureEnabled(){return this._BaseWeightTextureEnabled}static set BaseWeightTextureEnabled(e){this._BaseWeightTextureEnabled!==e&&(this._BaseWeightTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get BaseDiffuseRoughnessTextureEnabled(){return this._BaseDiffuseRoughnessTextureEnabled}static set BaseDiffuseRoughnessTextureEnabled(e){this._BaseDiffuseRoughnessTextureEnabled!==e&&(this._BaseDiffuseRoughnessTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get DetailTextureEnabled(){return this._DetailTextureEnabled}static set DetailTextureEnabled(e){this._DetailTextureEnabled!==e&&(this._DetailTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get DecalMapEnabled(){return this._DecalMapEnabled}static set DecalMapEnabled(e){this._DecalMapEnabled!==e&&(this._DecalMapEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get AmbientTextureEnabled(){return this._AmbientTextureEnabled}static set AmbientTextureEnabled(e){this._AmbientTextureEnabled!==e&&(this._AmbientTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get OpacityTextureEnabled(){return this._OpacityTextureEnabled}static set OpacityTextureEnabled(e){this._OpacityTextureEnabled!==e&&(this._OpacityTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get ReflectionTextureEnabled(){return this._ReflectionTextureEnabled}static set ReflectionTextureEnabled(e){this._ReflectionTextureEnabled!==e&&(this._ReflectionTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get EmissiveTextureEnabled(){return this._EmissiveTextureEnabled}static set EmissiveTextureEnabled(e){this._EmissiveTextureEnabled!==e&&(this._EmissiveTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get SpecularTextureEnabled(){return this._SpecularTextureEnabled}static set SpecularTextureEnabled(e){this._SpecularTextureEnabled!==e&&(this._SpecularTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get BumpTextureEnabled(){return this._BumpTextureEnabled}static set BumpTextureEnabled(e){this._BumpTextureEnabled!==e&&(this._BumpTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get LightmapTextureEnabled(){return this._LightmapTextureEnabled}static set LightmapTextureEnabled(e){this._LightmapTextureEnabled!==e&&(this._LightmapTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get RefractionTextureEnabled(){return this._RefractionTextureEnabled}static set RefractionTextureEnabled(e){this._RefractionTextureEnabled!==e&&(this._RefractionTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get ColorGradingTextureEnabled(){return this._ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(e){this._ColorGradingTextureEnabled!==e&&(this._ColorGradingTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get FresnelEnabled(){return this._FresnelEnabled}static set FresnelEnabled(e){this._FresnelEnabled!==e&&(this._FresnelEnabled=e,k.MarkAllMaterialsAsDirty(4))}static get ClearCoatTextureEnabled(){return this._ClearCoatTextureEnabled}static set ClearCoatTextureEnabled(e){this._ClearCoatTextureEnabled!==e&&(this._ClearCoatTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get ClearCoatBumpTextureEnabled(){return this._ClearCoatBumpTextureEnabled}static set ClearCoatBumpTextureEnabled(e){this._ClearCoatBumpTextureEnabled!==e&&(this._ClearCoatBumpTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get ClearCoatTintTextureEnabled(){return this._ClearCoatTintTextureEnabled}static set ClearCoatTintTextureEnabled(e){this._ClearCoatTintTextureEnabled!==e&&(this._ClearCoatTintTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get SheenTextureEnabled(){return this._SheenTextureEnabled}static set SheenTextureEnabled(e){this._SheenTextureEnabled!==e&&(this._SheenTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get AnisotropicTextureEnabled(){return this._AnisotropicTextureEnabled}static set AnisotropicTextureEnabled(e){this._AnisotropicTextureEnabled!==e&&(this._AnisotropicTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get ThicknessTextureEnabled(){return this._ThicknessTextureEnabled}static set ThicknessTextureEnabled(e){this._ThicknessTextureEnabled!==e&&(this._ThicknessTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get RefractionIntensityTextureEnabled(){return this._ThicknessTextureEnabled}static set RefractionIntensityTextureEnabled(e){this._RefractionIntensityTextureEnabled!==e&&(this._RefractionIntensityTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get TranslucencyIntensityTextureEnabled(){return this._TranslucencyIntensityTextureEnabled}static set TranslucencyIntensityTextureEnabled(e){this._TranslucencyIntensityTextureEnabled!==e&&(this._TranslucencyIntensityTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get TranslucencyColorTextureEnabled(){return this._TranslucencyColorTextureEnabled}static set TranslucencyColorTextureEnabled(e){this._TranslucencyColorTextureEnabled!==e&&(this._TranslucencyColorTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get IridescenceTextureEnabled(){return this._IridescenceTextureEnabled}static set IridescenceTextureEnabled(e){this._IridescenceTextureEnabled!==e&&(this._IridescenceTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}};X._DiffuseTextureEnabled=!0;X._BaseWeightTextureEnabled=!0;X._BaseDiffuseRoughnessTextureEnabled=!0;X._DetailTextureEnabled=!0;X._DecalMapEnabled=!0;X._AmbientTextureEnabled=!0;X._OpacityTextureEnabled=!0;X._ReflectionTextureEnabled=!0;X._EmissiveTextureEnabled=!0;X._SpecularTextureEnabled=!0;X._BumpTextureEnabled=!0;X._LightmapTextureEnabled=!0;X._RefractionTextureEnabled=!0;X._ColorGradingTextureEnabled=!0;X._FresnelEnabled=!0;X._ClearCoatTextureEnabled=!0;X._ClearCoatBumpTextureEnabled=!0;X._ClearCoatTintTextureEnabled=!0;X._SheenTextureEnabled=!0;X._AnisotropicTextureEnabled=!0;X._ThicknessTextureEnabled=!0;X._RefractionIntensityTextureEnabled=!0;X._TranslucencyIntensityTextureEnabled=!0;X._TranslucencyColorTextureEnabled=!0;X._IridescenceTextureEnabled=!0});var bB,OZ,PC=S(()=>{O();wo();bB="backgroundUboDeclaration",OZ=`uniform vPrimaryColor: vec4f;uniform vPrimaryColorShadow: vec4f;uniform vDiffuseInfos: vec2f;uniform vReflectionInfos: vec2f;uniform diffuseMatrix: mat4x4f;uniform reflectionMatrix: mat4x4f;uniform vReflectionMicrosurfaceInfos: vec3f;uniform fFovMultiplier: f32;uniform pointSize: f32;uniform shadowLevel: f32;uniform alpha: f32;uniform vBackgroundCenter: vec3f;uniform vReflectionControl: vec4f;uniform projectedGroundInfos: vec2f;
#include<sceneUboDeclaration>
`;g.IncludesShadersStoreWGSL[bB]||(g.IncludesShadersStoreWGSL[bB]=OZ)});var CB,LZ,hu=S(()=>{O();CB="fogVertexDeclaration",LZ=`#ifdef FOG
varying vFogDistance: vec3f;
#endif
`;g.IncludesShadersStoreWGSL[CB]||(g.IncludesShadersStoreWGSL[CB]=LZ)});var IB,wZ,g_=S(()=>{O();IB="lightVxUboDeclaration",wZ=`#ifdef LIGHT{X}
struct Light{X}
{vLightData: vec4f,
vLightDiffuse: vec4f,
vLightSpecular: vec4f,
#ifdef SPOTLIGHT{X}
vLightDirection: vec4f,
vLightFalloff: vec4f,
#elif defined(POINTLIGHT{X})
vLightFalloff: vec4f,
#elif defined(HEMILIGHT{X})
vLightGround: vec3f,
#elif defined(CLUSTLIGHT{X})
vSliceData: vec2f,
vSliceRanges: array<vec4f,CLUSTLIGHT_SLICES>,
#endif
#if defined(AREALIGHT{X})
vLightWidth: vec4f,
vLightHeight: vec4f,
#endif
shadowsInfo: vec4f,
depthValues: vec2f} ;var<uniform> light{X} : Light{X};
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform lightMatrix{X}: array<mat4x4f,SHADOWCSMNUM_CASCADES{X}>;varying vPositionFromLight{X}_0: vec4f;varying vDepthMetric{X}_0: f32;varying vPositionFromLight{X}_1: vec4f;varying vDepthMetric{X}_1: f32;varying vPositionFromLight{X}_2: vec4f;varying vDepthMetric{X}_2: f32;varying vPositionFromLight{X}_3: vec4f;varying vDepthMetric{X}_3: f32;varying vPositionFromCamera{X}: vec4f;
#elif defined(SHADOWCUBE{X})
#else
varying vPositionFromLight{X}: vec4f;varying vDepthMetric{X}: f32;uniform lightMatrix{X}: mat4x4f;
#endif
#endif
#endif
`;g.IncludesShadersStoreWGSL[IB]||(g.IncludesShadersStoreWGSL[IB]=wZ)});var yB,FZ,za=S(()=>{O();yB="logDepthDeclaration",FZ=`#ifdef LOGARITHMICDEPTH
uniform logarithmicDepthConstant: f32;varying vFragmentDepth: f32;
#endif
`;g.IncludesShadersStoreWGSL[yB]||(g.IncludesShadersStoreWGSL[yB]=FZ)});var MB,NZ,uu=S(()=>{O();MB="fogVertex",NZ=`#ifdef FOG
#ifdef SCENE_UBO
vertexOutputs.vFogDistance=(scene.view*worldPos).xyz;
#else
vertexOutputs.vFogDistance=(uniforms.view*worldPos).xyz;
#endif
#endif
`;g.IncludesShadersStoreWGSL[MB]||(g.IncludesShadersStoreWGSL[MB]=NZ)});var PB,BZ,v_=S(()=>{O();PB="shadowsVertex",BZ=`#ifdef SHADOWS
#if defined(SHADOWCSM{X})
vertexOutputs.vPositionFromCamera{X}=scene.view*worldPos;
#if SHADOWCSMNUM_CASCADES{X}>0
vertexOutputs.vPositionFromLight{X}_0=uniforms.lightMatrix{X}[0]*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vertexOutputs.vDepthMetric{X}_0=(-vertexOutputs.vPositionFromLight{X}_0.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vertexOutputs.vDepthMetric{X}_0= (vertexOutputs.vPositionFromLight{X}_0.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif
#if SHADOWCSMNUM_CASCADES{X}>1
vertexOutputs.vPositionFromLight{X}_1=uniforms.lightMatrix{X}[1]*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vertexOutputs.vDepthMetric{X}_1=(-vertexOutputs.vPositionFromLight{X}_1.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vertexOutputs.vDepthMetric{X}_1= (vertexOutputs.vPositionFromLight{X}_1.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif 
#if SHADOWCSMNUM_CASCADES{X}>2
vertexOutputs.vPositionFromLight{X}_2=uniforms.lightMatrix{X}[2]*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vertexOutputs.vDepthMetric{X}_2=(-vertexOutputs.vPositionFromLight{X}_2.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vertexOutputs.vDepthMetric{X}_2= (vertexOutputs.vPositionFromLight{X}_2.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif 
#if SHADOWCSMNUM_CASCADES{X}>3
vertexOutputs.vPositionFromLight{X}_3=uniforms.lightMatrix{X}[3]*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vertexOutputs.vDepthMetric{X}_3=(-vertexOutputs.vPositionFromLight{X}_3.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vertexOutputs.vDepthMetric{X}_3= (vertexOutputs.vPositionFromLight{X}_3.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif 
#elif defined(SHADOW{X}) && !defined(SHADOWCUBE{X})
vertexOutputs.vPositionFromLight{X}=uniforms.lightMatrix{X}*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vertexOutputs.vDepthMetric{X}=(-vertexOutputs.vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vertexOutputs.vDepthMetric{X}=(vertexOutputs.vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif
#endif
`;g.IncludesShadersStoreWGSL[PB]||(g.IncludesShadersStoreWGSL[PB]=BZ)});var DB,UZ,du=S(()=>{O();DB="logDepthVertex",UZ=`#ifdef LOGARITHMICDEPTH
vertexOutputs.vFragmentDepth=1.0+vertexOutputs.position.w;vertexOutputs.position.z=log2(max(0.000001,vertexOutputs.vFragmentDepth))*uniforms.logarithmicDepthConstant;
#endif
`;g.IncludesShadersStoreWGSL[DB]||(g.IncludesShadersStoreWGSL[DB]=UZ)});var LB={};V(LB,{backgroundVertexShaderWGSL:()=>GZ});var DC,OB,GZ,wB=S(()=>{O();PC();Pi();Ia();Bn();Va();ya();hu();g_();za();Un();Ma();Gn();Pa();uu();v_();du();DC="backgroundVertexShader",OB=`#include<backgroundUboDeclaration>
#include<helperFunctions>
attribute position: vec3f;
#ifdef NORMAL
attribute normal: vec3f;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
varying vPositionW: vec3f;
#ifdef NORMAL
varying vNormalW: vec3f;
#endif
#ifdef UV1
attribute uv: vec2f;
#endif
#ifdef UV2
attribute uv2: vec2f;
#endif
#ifdef MAINUV1
varying vMainUV1: vec2f;
#endif
#ifdef MAINUV2
varying vMainUV2: vec2f;
#endif
#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0
varying vDiffuseUV: vec2f;
#endif
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<lightVxUboDeclaration>[0..maxSimultaneousLights]
#ifdef REFLECTIONMAP_SKYBOX
varying vPositionUVW: vec3f;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vDirectionW: vec3f;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
#ifdef REFLECTIONMAP_SKYBOX
vertexOutputs.vPositionUVW=input.position;
#endif
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {vertexOutputs.position=scene.viewProjection*finalWorld* vec4f(input.position,1.0);} else {vertexOutputs.position=scene.viewProjectionR*finalWorld* vec4f(input.position,1.0);}
#else
vertexOutputs.position=scene.viewProjection*finalWorld* vec4f(input.position,1.0);
#endif
var worldPos: vec4f=finalWorld* vec4f(input.position,1.0);vertexOutputs.vPositionW= worldPos.xyz;
#ifdef NORMAL
var normalWorld: mat3x3f=mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vertexOutputs.vNormalW=normalize(normalWorld*input.normal);
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vertexOutputs.vDirectionW=normalize((finalWorld*vec4f(input.position,0.0)).xyz);
#ifdef EQUIRECTANGULAR_RELFECTION_FOV
var screenToWorld: mat3x3f=inverseMat3( mat3x3f(finalWorld*scene.viewProjection));var segment: vec3f=mix(vertexOutputs.vDirectionW,screenToWorld* vec3f(0.0,0.0,1.0),abs(fFovMultiplier-1.0));if (fFovMultiplier<=1.0) {vertexOutputs.vDirectionW=normalize(segment);} else {vertexOutputs.vDirectionW=normalize(vertexOutputs.vDirectionW+(vertexOutputs.vDirectionW-segment));}
#endif
#endif
#ifndef UV1
var uv: vec2f=vec2f(0.,0.);
#else
var uv=input.uv;
#endif
#ifndef UV2
var uv2: vec2f=vec2f(0.,0.);
#else
var uv2=input.uv2;
#endif
#ifdef MAINUV1
vertexOutputs.vMainUV1=uv;
#endif
#ifdef MAINUV2
vertexOutputs.vMainUV2=uv2;
#endif
#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0
if (uniforms.vDiffuseInfos.x==0.)
{vertexOutputs.vDiffuseUV= (uniforms.diffuseMatrix* vec4f(uv,1.0,0.0)).xy;}
else
{vertexOutputs.vDiffuseUV= (uniforms.diffuseMatrix* vec4f(uv2,1.0,0.0)).xy;}
#endif
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#ifdef VERTEXCOLOR
vertexOutputs.vColor=vertexInputs.color;
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}
`;g.ShadersStoreWGSL[DC]||(g.ShadersStoreWGSL[DC]=OB);GZ={name:DC,shader:OB}});var FB,VZ,S_=S(()=>{O();FB="reflectionFunction",VZ=`fn computeFixedEquirectangularCoords(worldPos: vec4f,worldNormal: vec3f,direction: vec3f)->vec3f
{var lon: f32=atan2(direction.z,direction.x);var lat: f32=acos(direction.y);var sphereCoords: vec2f= vec2f(lon,lat)*RECIPROCAL_PI2*2.0;var s: f32=sphereCoords.x*0.5+0.5;var t: f32=sphereCoords.y;return vec3f(s,t,0); }
fn computeMirroredFixedEquirectangularCoords(worldPos: vec4f,worldNormal: vec3f,direction: vec3f)->vec3f
{var lon: f32=atan2(direction.z,direction.x);var lat: f32=acos(direction.y);var sphereCoords: vec2f= vec2f(lon,lat)*RECIPROCAL_PI2*2.0;var s: f32=sphereCoords.x*0.5+0.5;var t: f32=sphereCoords.y;return vec3f(1.0-s,t,0); }
fn computeEquirectangularCoords(worldPos: vec4f,worldNormal: vec3f,eyePosition: vec3f,reflectionMatrix: mat4x4f)->vec3f
{var cameraToVertex: vec3f=normalize(worldPos.xyz-eyePosition);var r: vec3f=normalize(reflect(cameraToVertex,worldNormal));r= (reflectionMatrix* vec4f(r,0)).xyz;var lon: f32=atan2(r.z,r.x);var lat: f32=acos(r.y);var sphereCoords: vec2f= vec2f(lon,lat)*RECIPROCAL_PI2*2.0;var s: f32=sphereCoords.x*0.5+0.5;var t: f32=sphereCoords.y;return vec3f(s,t,0);}
fn computeSphericalCoords(worldPos: vec4f,worldNormal: vec3f,view: mat4x4f,reflectionMatrix: mat4x4f)->vec3f
{var viewDir: vec3f=normalize((view*worldPos).xyz);var viewNormal: vec3f=normalize((view* vec4f(worldNormal,0.0)).xyz);var r: vec3f=reflect(viewDir,viewNormal);r= (reflectionMatrix* vec4f(r,0)).xyz;r.z=r.z-1.0;var m: f32=2.0*length(r);return vec3f(r.x/m+0.5,1.0-r.y/m-0.5,0);}
fn computePlanarCoords(worldPos: vec4f,worldNormal: vec3f,eyePosition: vec3f,reflectionMatrix: mat4x4f)->vec3f
{var viewDir: vec3f=worldPos.xyz-eyePosition;var coords: vec3f=normalize(reflect(viewDir,worldNormal));return (reflectionMatrix* vec4f(coords,1)).xyz;}
fn computeCubicCoords(worldPos: vec4f,worldNormal: vec3f,eyePosition: vec3f,reflectionMatrix: mat4x4f)->vec3f
{var viewDir: vec3f=normalize(worldPos.xyz-eyePosition);var coords: vec3f=reflect(viewDir,worldNormal);coords= (reflectionMatrix* vec4f(coords,0)).xyz;
#ifdef INVERTCUBICMAP
coords.y*=-1.0;
#endif
return coords;}
fn computeCubicLocalCoords(worldPos: vec4f,worldNormal: vec3f,eyePosition: vec3f,reflectionMatrix: mat4x4f,reflectionSize: vec3f,reflectionPosition: vec3f)->vec3f
{var viewDir: vec3f=normalize(worldPos.xyz-eyePosition);var coords: vec3f=reflect(viewDir,worldNormal);coords=parallaxCorrectNormal(worldPos.xyz,coords,reflectionSize,reflectionPosition);coords=(reflectionMatrix* vec4f(coords,0)).xyz;
#ifdef INVERTCUBICMAP
coords.y*=-1.0;
#endif
return coords;}
fn computeProjectionCoords(worldPos: vec4f,view: mat4x4f,reflectionMatrix: mat4x4f)->vec3f
{return (reflectionMatrix*(view*worldPos)).xyz;}
fn computeSkyBoxCoords(positionW: vec3f,reflectionMatrix: mat4x4f)->vec3f
{return (reflectionMatrix* vec4f(positionW,1.)).xyz;}
#ifdef REFLECTION
fn computeReflectionCoords(worldPos: vec4f,worldNormal: vec3f)->vec3f
{
#ifdef REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED
var direction: vec3f=normalize(fragmentInputs.vDirectionW);return computeMirroredFixedEquirectangularCoords(worldPos,worldNormal,direction);
#endif
#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED
var direction: vec3f=normalize(fragmentInputs.vDirectionW);return computeFixedEquirectangularCoords(worldPos,worldNormal,direction);
#endif
#ifdef REFLECTIONMAP_EQUIRECTANGULAR
return computeEquirectangularCoords(worldPos,worldNormal,scene.vEyePosition.xyz,uniforms.reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_SPHERICAL
return computeSphericalCoords(worldPos,worldNormal,scene.view,uniforms.reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_PLANAR
return computePlanarCoords(worldPos,worldNormal,scene.vEyePosition.xyz,uniforms.reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_CUBIC
#ifdef USE_LOCAL_REFLECTIONMAP_CUBIC
return computeCubicLocalCoords(worldPos,worldNormal,scene.vEyePosition.xyz,uniforms.reflectionMatrix,uniforms.vReflectionSize,uniforms.vReflectionPosition);
#else
return computeCubicCoords(worldPos,worldNormal,scene.vEyePosition.xyz,uniforms.reflectionMatrix);
#endif
#endif
#ifdef REFLECTIONMAP_PROJECTION
return computeProjectionCoords(worldPos,scene.view,uniforms.reflectionMatrix);
#endif
#ifndef REFLECTIONMAP_CUBIC
#ifdef REFLECTIONMAP_SKYBOX
return computeSkyBoxCoords(fragmentInputs.vPositionUVW,uniforms.reflectionMatrix);
#endif
#endif
#ifdef REFLECTIONMAP_EXPLICIT
return vec3f(0,0,0);
#endif
}
#endif
`;g.IncludesShadersStoreWGSL[FB]||(g.IncludesShadersStoreWGSL[FB]=VZ)});var NB,kZ,E_=S(()=>{O();NB="imageProcessingDeclaration",kZ=`#ifdef EXPOSURE
uniform exposureLinear: f32;
#endif
#ifdef CONTRAST
uniform contrast: f32;
#endif
#if defined(VIGNETTE) || defined(DITHER)
uniform vInverseScreenSize: vec2f;
#endif
#ifdef VIGNETTE
uniform vignetteSettings1: vec4f;uniform vignetteSettings2: vec4f;
#endif
#ifdef COLORCURVES
uniform vCameraColorCurveNegative: vec4f;uniform vCameraColorCurveNeutral: vec4f;uniform vCameraColorCurvePositive: vec4f;
#endif
#ifdef COLORGRADING
#ifdef COLORGRADING3D
var txColorTransformSampler: sampler;var txColorTransform: texture_3d<f32>;
#else
var txColorTransformSampler: sampler;var txColorTransform: texture_2d<f32>;
#endif
uniform colorTransformSettings: vec4f;
#endif
#ifdef DITHER
uniform ditherIntensity: f32;
#endif
`;g.IncludesShadersStoreWGSL[NB]||(g.IncludesShadersStoreWGSL[NB]=kZ)});var BB,WZ,T_=S(()=>{O();BB="lightUboDeclaration",WZ=`#ifdef LIGHT{X}
struct Light{X}
{vLightData: vec4f,
vLightDiffuse: vec4f,
vLightSpecular: vec4f,
#ifdef SPOTLIGHT{X}
vLightDirection: vec4f,
vLightFalloff: vec4f,
#elif defined(POINTLIGHT{X})
vLightFalloff: vec4f,
#elif defined(HEMILIGHT{X})
vLightGround: vec3f,
#elif defined(CLUSTLIGHT{X})
vSliceData: vec2f,
vSliceRanges: array<vec4f,CLUSTLIGHT_SLICES>,
#endif
#if defined(AREALIGHT{X})
vLightWidth: vec4f,
vLightHeight: vec4f,
#endif
shadowsInfo: vec4f,
depthValues: vec2f} ;var<uniform> light{X} : Light{X};
#ifdef IESLIGHTTEXTURE{X}
var iesLightTexture{X}Sampler: sampler;var iesLightTexture{X}: texture_2d<f32>;
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
uniform textureProjectionMatrix{X}: mat4x4f;var projectionLightTexture{X}Sampler: sampler;var projectionLightTexture{X}: texture_2d<f32>;
#endif
#ifdef CLUSTLIGHT{X}
var lightDataTexture{X}: texture_2d<f32>;var<storage,read> tileMaskBuffer{X}: array<u32>;
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform lightMatrix{X}: array<mat4x4f,SHADOWCSMNUM_CASCADES{X}>;uniform viewFrustumZ{X}: array<f32,SHADOWCSMNUM_CASCADES{X}>;uniform frustumLengths{X}: array<f32,SHADOWCSMNUM_CASCADES{X}>;uniform cascadeBlendFactor{X}: f32;varying vPositionFromLight{X}_0: vec4f;varying vDepthMetric{X}_0: f32;varying vPositionFromLight{X}_1: vec4f;varying vDepthMetric{X}_1: f32;varying vPositionFromLight{X}_2: vec4f;varying vDepthMetric{X}_2: f32;varying vPositionFromLight{X}_3: vec4f;varying vDepthMetric{X}_3: f32;varying vPositionFromCamera{X}: vec4f;var<private> vPositionFromLight{X}: array<vec4f,4>;var<private> vDepthMetric{X} : array<f32,4>;
#if defined(SHADOWPCSS{X})
var shadowTexture{X}Sampler: sampler_comparison; 
var shadowTexture{X}: texture_depth_2d_array;var depthTexture{X}Sampler: sampler;var depthTexture{X}: texture_2d_array<f32>;uniform lightSizeUVCorrection{X}: array<vec2f,SHADOWCSMNUM_CASCADES{X}>;uniform depthCorrection{X}: array<f32,SHADOWCSMNUM_CASCADES{X}>;uniform penumbraDarkness{X}: f32;
#elif defined(SHADOWPCF{X})
var shadowTexture{X}Sampler: sampler_comparison;var shadowTexture{X}: texture_depth_2d_array;
#else 
var shadowTexture{X}Sampler: sampler; 
var shadowTexture{X}: texture_2d_array<f32>;
#endif
#ifdef SHADOWCSMDEBUG{X}
const vCascadeColorsMultiplier{X}: array<vec3f,8>=array<vec3f,8>
(
vec3f ( 1.5,0.0,0.0 ),
vec3f ( 0.0,1.5,0.0 ),
vec3f ( 0.0,0.0,5.5 ),
vec3f ( 1.5,0.0,5.5 ),
vec3f ( 1.5,1.5,0.0 ),
vec3f ( 1.0,1.0,1.0 ),
vec3f ( 0.0,1.0,5.5 ),
vec3f ( 0.5,3.5,0.75 )
);
#endif
#elif defined(SHADOWCUBE{X})
var shadowTexture{X}Sampler: sampler;var shadowTexture{X}: texture_cube<f32>;
#else
varying vPositionFromLight{X}: vec4f;varying vDepthMetric{X}: f32;
#if defined(SHADOWPCSS{X})
var shadowTexture{X}Sampler: sampler_comparison; 
var shadowTexture{X}: texture_depth_2d;var depthTexture{X}Sampler: sampler; 
var depthTexture{X}: texture_2d<f32>;
#elif defined(SHADOWPCF{X})
var shadowTexture{X}Sampler: sampler_comparison;var shadowTexture{X}: texture_depth_2d;
#else
var shadowTexture{X}Sampler: sampler; 
var shadowTexture{X}: texture_2d<f32>;
#endif
uniform lightMatrix{X}: mat4x4f;
#endif
#endif
#endif
`;g.IncludesShadersStoreWGSL[BB]||(g.IncludesShadersStoreWGSL[BB]=WZ)});var UB,HZ,OC=S(()=>{O();UB="ltcHelperFunctions",HZ=`fn LTCUv(N: vec3f,V: vec3f,roughness: f32)->vec2f {var LUTSIZE: f32=64.0;var LUTSCALE: f32=( LUTSIZE-1.0 )/LUTSIZE;var LUTBIAS:f32=0.5/LUTSIZE;var dotNV:f32=saturate( dot( N,V ) );var uv:vec2f=vec2f( roughness,sqrt( 1.0-dotNV ) );uv=uv*LUTSCALE+LUTBIAS;return uv;}
fn LTCClippedSphereFormFactor( f:vec3f )->f32 {var l: f32=length( f );return max( ( l*l+f.z )/( l+1.0 ),0.0 );}
fn LTCEdgeVectorFormFactor( v1:vec3f,v2:vec3f )->vec3f {var x:f32=dot( v1,v2 );var y:f32=abs( x );var a:f32=0.8543985+( 0.4965155+0.0145206*y )*y;var b:f32=3.4175940+( 4.1616724+y )*y;var v:f32=a/b;var thetaSintheta:f32=0.0;if( x>0.0 )
{thetaSintheta=v;}
else
{thetaSintheta=0.5*inverseSqrt( max( 1.0-x*x,0.00000001 ) )-v;}
return cross( v1,v2 )*thetaSintheta;}
fn LTCEvaluate( N:vec3f,V:vec3f,P:vec3f,mInv: mat3x3<f32>,rectCoords0:vec3f,rectCoords1:vec3f,rectCoords2:vec3f,rectCoords3:vec3f )->vec3f {var v1:vec3f=rectCoords1-rectCoords0;var v2:vec3f=rectCoords3-rectCoords0;var lightNormal:vec3f=cross( v1,v2 );if( dot( lightNormal,P-rectCoords0 )<0.0 ){return vec3f( 0.0 );}
var T1:vec3f=normalize( V-N*dot( V,N ) );var T2:vec3f=- cross( N,T1 ); 
var mat: mat3x3<f32>=mInv*transposeMat3( mat3x3<f32>( T1,T2,N ) );var coords0: vec3f=mat*( rectCoords0-P );var coords1: vec3f=mat*( rectCoords1-P );var coords2: vec3f=mat*( rectCoords2-P );var coords3: vec3f=mat*( rectCoords3-P );coords0=normalize( coords0 );coords1=normalize( coords1 );coords2=normalize( coords2 );coords3=normalize( coords3 );var vectorFormFactor:vec3f=vec3( 0.0 );vectorFormFactor+=LTCEdgeVectorFormFactor( coords0,coords1 );vectorFormFactor+=LTCEdgeVectorFormFactor( coords1,coords2 );vectorFormFactor+=LTCEdgeVectorFormFactor( coords2,coords3 );vectorFormFactor+=LTCEdgeVectorFormFactor( coords3,coords0 );var result:f32=LTCClippedSphereFormFactor( vectorFormFactor );return vec3f( result );}
struct areaLightData
{Diffuse: vec3f,
Specular: vec3f,
Fresnel: vec4f};fn computeAreaLightSpecularDiffuseFresnel(ltc1: texture_2d<f32>,ltc1Sampler:sampler,ltc2:texture_2d<f32>,ltc2Sampler:sampler,viewDir: vec3f,normal:vec3f,position:vec3f,lightPos:vec3f,halfWidth:vec3f, halfHeight:vec3f,roughness:f32)->areaLightData {var result: areaLightData;var rectCoords0:vec3f=lightPos+halfWidth-halfHeight; 
var rectCoords1:vec3f=lightPos-halfWidth-halfHeight;var rectCoords2:vec3f=lightPos-halfWidth+halfHeight;var rectCoords3:vec3f=lightPos+halfWidth+halfHeight;
#ifdef SPECULARTERM
var uv:vec2f=LTCUv( normal,viewDir,roughness );var t1:vec4f=textureSample( ltc1,ltc1Sampler,uv );var t2:vec4f=textureSample( ltc2,ltc2Sampler,uv );var mInv:mat3x3<f32>=mat3x3<f32>(
vec3f( t1.x,0,t1.y ),
vec3f( 0,1, 0 ),
vec3f( t1.z,0,t1.w )
);result.Fresnel=t2;result.Specular=LTCEvaluate( normal,viewDir,position,mInv,rectCoords0,rectCoords1,rectCoords2,rectCoords3 );
#endif
var mInvEmpty:mat3x3<f32>=mat3x3<f32>(
vec3f( 1,0,0 ),
vec3f( 0,1,0 ),
vec3f( 0,0,1 )
);result.Diffuse+=LTCEvaluate( normal,viewDir,position,mInvEmpty,rectCoords0,rectCoords1,rectCoords2,rectCoords3 );return result;}`;g.IncludesShadersStoreWGSL[UB]||(g.IncludesShadersStoreWGSL[UB]=HZ)});var GB,zZ,LC=S(()=>{O();GB="clusteredLightingFunctions",zZ=`struct ClusteredLight {vLightData: vec4f,
vLightDiffuse: vec4f,
vLightSpecular: vec4f,
vLightDirection: vec4f,
vLightFalloff: vec4f,}
fn getClusteredLight(lightDataTexture: texture_2d<f32>,index: u32)->ClusteredLight {return ClusteredLight(
textureLoad(lightDataTexture,vec2u(0,index),0),
textureLoad(lightDataTexture,vec2u(1,index),0),
textureLoad(lightDataTexture,vec2u(2,index),0),
textureLoad(lightDataTexture,vec2u(3,index),0),
textureLoad(lightDataTexture,vec2u(4,index),0)
);}
fn getClusteredSliceIndex(sliceData: vec2f,viewDepth: f32)->i32 {return i32(log(viewDepth)*sliceData.x+sliceData.y);}
`;g.IncludesShadersStoreWGSL[GB]||(g.IncludesShadersStoreWGSL[GB]=zZ)});var VB,XZ,wC=S(()=>{O();OC();LC();VB="lightsFragmentFunctions",XZ=`struct lightingInfo
{diffuse: vec3f,
#ifdef SPECULARTERM
specular: vec3f,
#endif
#ifdef NDOTL
ndl: f32,
#endif
};fn computeLighting(viewDirectionW: vec3f,vNormal: vec3f,lightData: vec4f,diffuseColor: vec3f,specularColor: vec3f,range: f32,glossiness: f32)->lightingInfo {var result: lightingInfo;var lightVectorW: vec3f;var attenuation: f32=1.0;if (lightData.w==0.)
{var direction: vec3f=lightData.xyz-fragmentInputs.vPositionW;attenuation=max(0.,1.0-length(direction)/range);lightVectorW=normalize(direction);}
else
{lightVectorW=normalize(-lightData.xyz);}
var ndl: f32=max(0.,dot(vNormal,lightVectorW));
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=ndl*diffuseColor*attenuation;
#ifdef SPECULARTERM
var angleW: vec3f=normalize(viewDirectionW+lightVectorW);var specComp: f32=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;
#endif
return result;}
fn getAttenuation(cosAngle: f32,exponent: f32)->f32 {return max(0.,pow(cosAngle,exponent));}
fn getIESAttenuation(cosAngle: f32,iesLightTexture: texture_2d<f32>,iesLightTextureSampler: sampler)->f32 {var angle=acos(cosAngle)/PI;return textureSampleLevel(iesLightTexture,iesLightTextureSampler,vec2f(angle,0),0.).r;}
fn computeBasicSpotLighting(viewDirectionW: vec3f,lightVectorW: vec3f,vNormal: vec3f,attenuation: f32,diffuseColor: vec3f,specularColor: vec3f,glossiness: f32)->lightingInfo {var result: lightingInfo;var ndl: f32=max(0.,dot(vNormal,lightVectorW));
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=ndl*diffuseColor*attenuation;
#ifdef SPECULARTERM
var angleW: vec3f=normalize(viewDirectionW+lightVectorW);var specComp: f32=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;
#endif
return result;}
fn computeIESSpotLighting(viewDirectionW: vec3f,vNormal: vec3f,lightData: vec4f,lightDirection: vec4f,diffuseColor: vec3f,specularColor: vec3f,range: f32,glossiness: f32,iesLightTexture: texture_2d<f32>,iesLightTextureSampler: sampler)->lightingInfo {var direction: vec3f=lightData.xyz-fragmentInputs.vPositionW;var lightVectorW: vec3f=normalize(direction);var attenuation: f32=max(0.,1.0-length(direction)/range);var dotProduct=dot(lightDirection.xyz,-lightVectorW);var cosAngle: f32=max(0.,dotProduct);if (cosAngle>=lightDirection.w)
{attenuation*=getIESAttenuation(dotProduct,iesLightTexture,iesLightTextureSampler);return computeBasicSpotLighting(viewDirectionW,lightVectorW,vNormal,attenuation,diffuseColor,specularColor,glossiness);}
var result: lightingInfo;result.diffuse=vec3f(0.);
#ifdef SPECULARTERM
result.specular=vec3f(0.);
#endif
#ifdef NDOTL
result.ndl=0.;
#endif
return result;}
fn computeSpotLighting(viewDirectionW: vec3f,vNormal: vec3f ,lightData: vec4f,lightDirection: vec4f,diffuseColor: vec3f,specularColor: vec3f,range: f32,glossiness: f32)->lightingInfo {var direction: vec3f=lightData.xyz-fragmentInputs.vPositionW;var lightVectorW: vec3f=normalize(direction);var attenuation: f32=max(0.,1.0-length(direction)/range);var cosAngle: f32=max(0.,dot(lightDirection.xyz,-lightVectorW));if (cosAngle>=lightDirection.w)
{attenuation*=getAttenuation(cosAngle,lightData.w);return computeBasicSpotLighting(viewDirectionW,lightVectorW,vNormal,attenuation,diffuseColor,specularColor,glossiness);}
var result: lightingInfo;result.diffuse=vec3f(0.);
#ifdef SPECULARTERM
result.specular=vec3f(0.);
#endif
#ifdef NDOTL
result.ndl=0.;
#endif
return result;}
fn computeHemisphericLighting(viewDirectionW: vec3f,vNormal: vec3f,lightData: vec4f,diffuseColor: vec3f,specularColor: vec3f,groundColor: vec3f,glossiness: f32)->lightingInfo {var result: lightingInfo;var ndl: f32=dot(vNormal,lightData.xyz)*0.5+0.5;
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=mix(groundColor,diffuseColor,ndl);
#ifdef SPECULARTERM
var angleW: vec3f=normalize(viewDirectionW+lightData.xyz);var specComp: f32=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor;
#endif
return result;}
fn computeProjectionTextureDiffuseLighting(projectionLightTexture: texture_2d<f32>,projectionLightSampler: sampler,textureProjectionMatrix: mat4x4f,posW: vec3f)->vec3f {var strq: vec4f=textureProjectionMatrix*vec4f(posW,1.0);strq/=strq.w;var textureColor: vec3f=textureSample(projectionLightTexture,projectionLightSampler,strq.xy).rgb;return textureColor;}
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
#include<ltcHelperFunctions>
var areaLightsLTC1SamplerSampler: sampler;var areaLightsLTC1Sampler: texture_2d<f32>;var areaLightsLTC2SamplerSampler: sampler;var areaLightsLTC2Sampler: texture_2d<f32>;fn computeAreaLighting(ltc1: texture_2d<f32>,ltc1Sampler:sampler,ltc2:texture_2d<f32>,ltc2Sampler:sampler,viewDirectionW: vec3f,vNormal:vec3f,vPosition:vec3f,lightPosition:vec3f,halfWidth:vec3f, halfHeight:vec3f,diffuseColor:vec3f,specularColor:vec3f,roughness:f32 )->lightingInfo
{var result: lightingInfo;var data: areaLightData=computeAreaLightSpecularDiffuseFresnel(ltc1,ltc1Sampler,ltc2,ltc2Sampler,viewDirectionW,vNormal,vPosition,lightPosition,halfWidth,halfHeight,roughness);
#ifdef SPECULARTERM
var fresnel:vec3f=( specularColor*data.Fresnel.x+( vec3f( 1.0 )-specularColor )*data.Fresnel.y );result.specular+=specularColor*fresnel*data.Specular;
#endif
result.diffuse+=diffuseColor*data.Diffuse;return result;}
#endif
#ifdef CLUSTLIGHT_BATCH
#include<clusteredLightingFunctions>
fn computeClusteredLighting(
lightDataTexture: texture_2d<f32>,
tileMaskBuffer: ptr<storage,array<u32>>,
viewDirectionW: vec3f,
vNormal: vec3f,
lightData: vec4f,
sliceRange: vec2u,
glossiness: f32
)->lightingInfo {var result: lightingInfo;let tilePosition=vec2u(fragmentInputs.position.xy*lightData.xy);let maskResolution=vec2u(lightData.zw);var tileIndex=(tilePosition.x*maskResolution.x+tilePosition.y)*maskResolution.y;let batchRange=sliceRange/CLUSTLIGHT_BATCH;var batchOffset=batchRange.x*CLUSTLIGHT_BATCH;tileIndex+=batchRange.x;for (var i=batchRange.x; i<=batchRange.y; i+=1) {var mask=tileMaskBuffer[tileIndex];tileIndex+=1;let maskOffset=max(sliceRange.x,batchOffset)-batchOffset; 
let maskWidth=min(sliceRange.y-batchOffset+1,CLUSTLIGHT_BATCH);mask=extractBits(mask,maskOffset,maskWidth);while mask != 0 {let trailing=firstTrailingBit(mask);mask ^= 1u<<trailing;let light=getClusteredLight(lightDataTexture,batchOffset+maskOffset+trailing);var info: lightingInfo;if light.vLightDirection.w<0.0 {info=computeLighting(viewDirectionW,vNormal,light.vLightData,light.vLightDiffuse.rgb,light.vLightSpecular.rgb,light.vLightDiffuse.a,glossiness);} else {info=computeSpotLighting(viewDirectionW,vNormal,light.vLightData,light.vLightDirection,light.vLightDiffuse.rgb,light.vLightSpecular.rgb,light.vLightDiffuse.a,glossiness);}
result.diffuse+=info.diffuse;
#ifdef SPECULARTERM
result.specular+=info.specular;
#endif
}
batchOffset+=CLUSTLIGHT_BATCH;}
return result;}
#endif
`;g.IncludesShadersStoreWGSL[VB]||(g.IncludesShadersStoreWGSL[VB]=XZ)});var kB,YZ,x_=S(()=>{O();kB="shadowsFragmentFunctions",YZ=`#ifdef SHADOWS
#ifndef SHADOWFLOAT
fn unpack(color: vec4f)->f32
{const bit_shift: vec4f= vec4f(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}
#endif
fn computeFallOff(value: f32,clipSpace: vec2f,frustumEdgeFalloff: f32)->f32
{var mask: f32=smoothstep(1.0-frustumEdgeFalloff,1.00000012,clamp(dot(clipSpace,clipSpace),0.,1.));return mix(value,1.0,mask);}
fn computeShadowCube(worldPos: vec3f,lightPosition: vec3f,shadowTexture: texture_cube<f32>,shadowSampler: sampler,darkness: f32,depthValues: vec2f)->f32
{var directionToLight: vec3f=worldPos-lightPosition;var depth: f32=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
var shadow: f32=unpack(textureSample(shadowTexture,shadowSampler,directionToLight));
#else
var shadow: f32=textureSample(shadowTexture,shadowSampler,directionToLight).x;
#endif
return select(1.0,darkness,depth>shadow);}
fn computeShadowWithPoissonSamplingCube(worldPos: vec3f,lightPosition: vec3f,shadowTexture: texture_cube<f32>,shadowSampler: sampler,mapSize: f32,darkness: f32,depthValues: vec2f)->f32
{var directionToLight: vec3f=worldPos-lightPosition;var depth: f32=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;var visibility: f32=1.;var poissonDisk: array<vec3f,4>;poissonDisk[0]= vec3f(-1.0,1.0,-1.0);poissonDisk[1]= vec3f(1.0,-1.0,-1.0);poissonDisk[2]= vec3f(-1.0,-1.0,-1.0);poissonDisk[3]= vec3f(1.0,-1.0,1.0);
#ifndef SHADOWFLOAT
if (unpack(textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[0]*mapSize))<depth) {visibility-=0.25;};if (unpack(textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[1]*mapSize))<depth) {visibility-=0.25;};if (unpack(textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[2]*mapSize))<depth) {visibility-=0.25;};if (unpack(textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[3]*mapSize))<depth) {visibility-=0.25;};
#else
if (textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<depth) {visibility-=0.25;};if (textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<depth) {visibility-=0.25;};if (textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<depth) {visibility-=0.25;};if (textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<depth) {visibility-=0.25;};
#endif
return min(1.0,visibility+darkness);}
fn computeShadowWithESMCube(worldPos: vec3f,lightPosition: vec3f,shadowTexture: texture_cube<f32>,shadowSampler: sampler,darkness: f32,depthScale: f32,depthValues: vec2f)->f32
{var directionToLight: vec3f=worldPos-lightPosition;var depth: f32=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);var shadowPixelDepth: f32=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
var shadowMapSample: f32=unpack(textureSample(shadowTexture,shadowSampler,directionToLight));
#else
var shadowMapSample: f32=textureSample(shadowTexture,shadowSampler,directionToLight).x;
#endif
var esm: f32=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return esm;}
fn computeShadowWithCloseESMCube(worldPos: vec3f,lightPosition: vec3f,shadowTexture: texture_cube<f32>,shadowSampler: sampler,darkness: f32,depthScale: f32,depthValues: vec2f)->f32
{var directionToLight: vec3f=worldPos-lightPosition;var depth: f32=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);var shadowPixelDepth: f32=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
var shadowMapSample: f32=unpack(textureSample(shadowTexture,shadowSampler,directionToLight));
#else
var shadowMapSample: f32=textureSample(shadowTexture,shadowSampler,directionToLight).x;
#endif
var esm: f32=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return esm;}
fn computeShadowCSM(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d_array<f32>,shadowSampler: sampler,darkness: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
var shadow: f32=unpack(textureSample(shadowTexture,shadowSampler,uv,layer));
#else
var shadow: f32=textureSample(shadowTexture,shadowSampler,uv,layer).x;
#endif
return select(1.,computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff),shadowPixelDepth>shadow );}
fn computeShadow(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d<f32>,shadowSampler: sampler,darkness: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
var shadow: f32=unpack(textureSampleLevel(shadowTexture,shadowSampler,uv,0.));
#else
var shadow: f32=textureSampleLevel(shadowTexture,shadowSampler,uv,0.).x;
#endif
return select(1.,computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff),shadowPixelDepth>shadow );}}
fn computeShadowWithPoissonSampling(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d<f32>,shadowSampler: sampler,mapSize: f32,darkness: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0);var visibility: f32=1.;var poissonDisk: array<vec2f,4>;poissonDisk[0]= vec2f(-0.94201624,-0.39906216);poissonDisk[1]= vec2f(0.94558609,-0.76890725);poissonDisk[2]= vec2f(-0.094184101,-0.92938870);poissonDisk[3]= vec2f(0.34495938,0.29387760);
#ifndef SHADOWFLOAT
if (unpack(textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[0]*mapSize,0.))<shadowPixelDepth) {visibility-=0.25;}
if (unpack(textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[1]*mapSize,0.))<shadowPixelDepth) {visibility-=0.25;}
if (unpack(textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[2]*mapSize,0.))<shadowPixelDepth) {visibility-=0.25;}
if (unpack(textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[3]*mapSize,0.))<shadowPixelDepth) {visibility-=0.25;}
#else
if (textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[0]*mapSize,0.).x<shadowPixelDepth) {visibility-=0.25;}
if (textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[1]*mapSize,0.).x<shadowPixelDepth) {visibility-=0.25;}
if (textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[2]*mapSize,0.).x<shadowPixelDepth) {visibility-=0.25;}
if (textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[3]*mapSize,0.).x<shadowPixelDepth) {visibility-=0.25;}
#endif
return computeFallOff(min(1.0,visibility+darkness),clipSpace.xy,frustumEdgeFalloff);}}
fn computeShadowWithESM(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d<f32>,shadowSampler: sampler,darkness: f32,depthScale: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
var shadowMapSample: f32=unpack(textureSampleLevel(shadowTexture,shadowSampler,uv,0.));
#else
var shadowMapSample: f32=textureSampleLevel(shadowTexture,shadowSampler,uv,0.).x;
#endif
var esm: f32=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}
fn computeShadowWithCloseESM(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d<f32>,shadowSampler: sampler,darkness: f32,depthScale: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0); 
#ifndef SHADOWFLOAT
var shadowMapSample: f32=unpack(textureSampleLevel(shadowTexture,shadowSampler,uv,0.));
#else
var shadowMapSample: f32=textureSampleLevel(shadowTexture,shadowSampler,uv,0.).x;
#endif
var esm: f32=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}
fn getZInClip(clipSpace: vec3f,uvDepth: vec3f)->f32
{
#ifdef IS_NDC_HALF_ZRANGE
return clipSpace.z;
#else
return uvDepth.z;
#endif
}
const GREATEST_LESS_THAN_ONE: f32=0.99999994;
#define DISABLE_UNIFORMITY_ANALYSIS
fn computeShadowWithCSMPCF1(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,darkness: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=clamp(getZInClip(clipSpace,uvDepth),0.,GREATEST_LESS_THAN_ONE);var shadow: f32=textureSampleCompare(shadowTexture,shadowSampler,uvDepth.xy,layer,uvDepth.z);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}
fn computeShadowWithCSMPCF3(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeAndInverse: vec2f,darkness: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=clamp(getZInClip(clipSpace,uvDepth),0.,GREATEST_LESS_THAN_ONE);var uv: vec2f=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
var st: vec2f=fract(uv); 
var base_uv: vec2f=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
var uvw0: vec2f=3.-2.*st;var uvw1: vec2f=1.+2.*st;var u: vec2f= vec2f((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;var v: vec2f= vec2f((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;var shadow: f32=0.;shadow+=uvw0.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[0]),layer,uvDepth.z);shadow+=uvw1.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[0]),layer,uvDepth.z);shadow+=uvw0.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[1]),layer,uvDepth.z);shadow+=uvw1.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[1]),layer,uvDepth.z);shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}
fn computeShadowWithCSMPCF5(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeAndInverse: vec2f,darkness: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=clamp(getZInClip(clipSpace,uvDepth),0.,GREATEST_LESS_THAN_ONE);var uv: vec2f=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
var st: vec2f=fract(uv); 
var base_uv: vec2f=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
var uvw0: vec2f=4.-3.*st;var uvw1: vec2f= vec2f(7.);var uvw2: vec2f=1.+3.*st;var u: vec3f= vec3f((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;var v: vec3f= vec3f((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;var shadow: f32=0.;shadow+=uvw0.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[0]),layer,uvDepth.z);shadow+=uvw1.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[0]),layer,uvDepth.z);shadow+=uvw2.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[0]),layer,uvDepth.z);shadow+=uvw0.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[1]),layer,uvDepth.z);shadow+=uvw1.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[1]),layer,uvDepth.z);shadow+=uvw2.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[1]),layer,uvDepth.z);shadow+=uvw0.x*uvw2.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[2]),layer,uvDepth.z);shadow+=uvw1.x*uvw2.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[2]),layer,uvDepth.z);shadow+=uvw2.x*uvw2.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[2]),layer,uvDepth.z);shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}
fn computeShadowWithPCF1(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,darkness: f32,frustumEdgeFalloff: f32)->f32
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=getZInClip(clipSpace,uvDepth);var shadow: f32=textureSampleCompareLevel(shadowTexture,shadowSampler,uvDepth.xy,uvDepth.z);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
fn computeShadowWithPCF3(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeAndInverse: vec2f,darkness: f32,frustumEdgeFalloff: f32)->f32
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=getZInClip(clipSpace,uvDepth);var uv: vec2f=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
var st: vec2f=fract(uv); 
var base_uv: vec2f=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
var uvw0: vec2f=3.-2.*st;var uvw1: vec2f=1.+2.*st;var u: vec2f= vec2f((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;var v: vec2f= vec2f((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;var shadow: f32=0.;shadow+=uvw0.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[0]),uvDepth.z);shadow+=uvw1.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[0]),uvDepth.z);shadow+=uvw0.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[1]),uvDepth.z);shadow+=uvw1.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[1]),uvDepth.z);shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
fn computeShadowWithPCF5(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeAndInverse: vec2f,darkness: f32,frustumEdgeFalloff: f32)->f32
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=getZInClip(clipSpace,uvDepth);var uv: vec2f=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
var st: vec2f=fract(uv); 
var base_uv: vec2f=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
var uvw0: vec2f=4.-3.*st;var uvw1: vec2f= vec2f(7.);var uvw2: vec2f=1.+3.*st;var u: vec3f= vec3f((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;var v: vec3f= vec3f((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;var shadow: f32=0.;shadow+=uvw0.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[0]),uvDepth.z);shadow+=uvw1.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[0]),uvDepth.z);shadow+=uvw2.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[0]),uvDepth.z);shadow+=uvw0.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[1]),uvDepth.z);shadow+=uvw1.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[1]),uvDepth.z);shadow+=uvw2.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[1]),uvDepth.z);shadow+=uvw0.x*uvw2.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[2]),uvDepth.z);shadow+=uvw1.x*uvw2.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[2]),uvDepth.z);shadow+=uvw2.x*uvw2.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[2]),uvDepth.z);shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
const PoissonSamplers32: array<vec3f,64>=array<vec3f,64> (
vec3f(0.06407013,0.05409927,0.),
vec3f(0.7366577,0.5789394,0.),
vec3f(-0.6270542,-0.5320278,0.),
vec3f(-0.4096107,0.8411095,0.),
vec3f(0.6849564,-0.4990818,0.),
vec3f(-0.874181,-0.04579735,0.),
vec3f(0.9989998,0.0009880066,0.),
vec3f(-0.004920578,-0.9151649,0.),
vec3f(0.1805763,0.9747483,0.),
vec3f(-0.2138451,0.2635818,0.),
vec3f(0.109845,0.3884785,0.),
vec3f(0.06876755,-0.3581074,0.),
vec3f(0.374073,-0.7661266,0.),
vec3f(0.3079132,-0.1216763,0.),
vec3f(-0.3794335,-0.8271583,0.),
vec3f(-0.203878,-0.07715034,0.),
vec3f(0.5912697,0.1469799,0.),
vec3f(-0.88069,0.3031784,0.),
vec3f(0.5040108,0.8283722,0.),
vec3f(-0.5844124,0.5494877,0.),
vec3f(0.6017799,-0.1726654,0.),
vec3f(-0.5554981,0.1559997,0.),
vec3f(-0.3016369,-0.3900928,0.),
vec3f(-0.5550632,-0.1723762,0.),
vec3f(0.925029,0.2995041,0.),
vec3f(-0.2473137,0.5538505,0.),
vec3f(0.9183037,-0.2862392,0.),
vec3f(0.2469421,0.6718712,0.),
vec3f(0.3916397,-0.4328209,0.),
vec3f(-0.03576927,-0.6220032,0.),
vec3f(-0.04661255,0.7995201,0.),
vec3f(0.4402924,0.3640312,0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.)
);const PoissonSamplers64: array<vec3f,64>=array<vec3f,64> (
vec3f(-0.613392,0.617481,0.),
vec3f(0.170019,-0.040254,0.),
vec3f(-0.299417,0.791925,0.),
vec3f(0.645680,0.493210,0.),
vec3f(-0.651784,0.717887,0.),
vec3f(0.421003,0.027070,0.),
vec3f(-0.817194,-0.271096,0.),
vec3f(-0.705374,-0.668203,0.),
vec3f(0.977050,-0.108615,0.),
vec3f(0.063326,0.142369,0.),
vec3f(0.203528,0.214331,0.),
vec3f(-0.667531,0.326090,0.),
vec3f(-0.098422,-0.295755,0.),
vec3f(-0.885922,0.215369,0.),
vec3f(0.566637,0.605213,0.),
vec3f(0.039766,-0.396100,0.),
vec3f(0.751946,0.453352,0.),
vec3f(0.078707,-0.715323,0.),
vec3f(-0.075838,-0.529344,0.),
vec3f(0.724479,-0.580798,0.),
vec3f(0.222999,-0.215125,0.),
vec3f(-0.467574,-0.405438,0.),
vec3f(-0.248268,-0.814753,0.),
vec3f(0.354411,-0.887570,0.),
vec3f(0.175817,0.382366,0.),
vec3f(0.487472,-0.063082,0.),
vec3f(-0.084078,0.898312,0.),
vec3f(0.488876,-0.783441,0.),
vec3f(0.470016,0.217933,0.),
vec3f(-0.696890,-0.549791,0.),
vec3f(-0.149693,0.605762,0.),
vec3f(0.034211,0.979980,0.),
vec3f(0.503098,-0.308878,0.),
vec3f(-0.016205,-0.872921,0.),
vec3f(0.385784,-0.393902,0.),
vec3f(-0.146886,-0.859249,0.),
vec3f(0.643361,0.164098,0.),
vec3f(0.634388,-0.049471,0.),
vec3f(-0.688894,0.007843,0.),
vec3f(0.464034,-0.188818,0.),
vec3f(-0.440840,0.137486,0.),
vec3f(0.364483,0.511704,0.),
vec3f(0.034028,0.325968,0.),
vec3f(0.099094,-0.308023,0.),
vec3f(0.693960,-0.366253,0.),
vec3f(0.678884,-0.204688,0.),
vec3f(0.001801,0.780328,0.),
vec3f(0.145177,-0.898984,0.),
vec3f(0.062655,-0.611866,0.),
vec3f(0.315226,-0.604297,0.),
vec3f(-0.780145,0.486251,0.),
vec3f(-0.371868,0.882138,0.),
vec3f(0.200476,0.494430,0.),
vec3f(-0.494552,-0.711051,0.),
vec3f(0.612476,0.705252,0.),
vec3f(-0.578845,-0.768792,0.),
vec3f(-0.772454,-0.090976,0.),
vec3f(0.504440,0.372295,0.),
vec3f(0.155736,0.065157,0.),
vec3f(0.391522,0.849605,0.),
vec3f(-0.620106,-0.328104,0.),
vec3f(0.789239,-0.419965,0.),
vec3f(-0.545396,0.538133,0.),
vec3f(-0.178564,-0.596057,0.)
);fn computeShadowWithCSMPCSS(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d_array<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,searchTapCount: i32,pcfTapCount: i32,poissonSamplers: array<vec3f,64>,lightSizeUVCorrection: vec2f,depthCorrection: f32,penumbraDarkness: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=clamp(getZInClip(clipSpace,uvDepth),0.,GREATEST_LESS_THAN_ONE);var uvDepthLayer: vec4f= vec4f(uvDepth.x,uvDepth.y,f32(layer),uvDepth.z);var blockerDepth: f32=0.0;var sumBlockerDepth: f32=0.0;var numBlocker: f32=0.0;for (var i: i32=0; i<searchTapCount; i ++) {blockerDepth=textureSample(depthTexture,depthSampler, uvDepth.xy+(lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse*PoissonSamplers32[i].xy),layer).r;numBlocker+=select(0.,1.,blockerDepth<depthMetric);sumBlockerDepth+=select(0.,blockerDepth,blockerDepth<depthMetric);}
var avgBlockerDepth: f32=sumBlockerDepth/numBlocker;var AAOffset: f32=shadowMapSizeInverse*10.;var penumbraRatio: f32=((depthMetric-avgBlockerDepth)*depthCorrection+AAOffset);var filterRadius: vec4f= vec4f(penumbraRatio*lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse,0.,0.);var random: f32=getRand(vPositionFromLight.xy);var rotationAngle: f32=random*3.1415926;var rotationVector: vec2f= vec2f(cos(rotationAngle),sin(rotationAngle));var shadow: f32=0.;for (var i: i32=0; i<pcfTapCount; i++) {var offset: vec4f= vec4f(poissonSamplers[i],0.);offset= vec4f(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.,0.);let coords=uvDepthLayer+offset*filterRadius;shadow+=textureSampleCompare(shadowTexture,shadowSampler,coords.xy,i32(coords.z),coords.w);}
shadow/= f32(pcfTapCount);shadow=mix(shadow,1.,min((depthMetric-avgBlockerDepth)*depthCorrection*penumbraDarkness,1.));shadow=mix(darkness,1.,shadow);return select(computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff),1.0,numBlocker<1.0);}
fn computeShadowWithPCSS(vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,searchTapCount: i32,pcfTapCount: i32,poissonSamplers: array<vec3f,64>)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=getZInClip(clipSpace,uvDepth);var blockerDepth: f32=0.0;var sumBlockerDepth: f32=0.0;var numBlocker: f32=0.0;var exitCondition: bool=depthMetric>1.0 || depthMetric<0.0;for (var i: i32=0; i<searchTapCount; i ++) {if (exitCondition) {break;}
blockerDepth=textureSampleLevel(depthTexture,depthSampler,uvDepth.xy+(lightSizeUV*shadowMapSizeInverse*PoissonSamplers32[i].xy),0).r;numBlocker+=select(0.,1.,blockerDepth<depthMetric);sumBlockerDepth+=select(0.,blockerDepth,blockerDepth<depthMetric);}
exitCondition=exitCondition || numBlocker<1.0;var avgBlockerDepth: f32=sumBlockerDepth/numBlocker;var AAOffset: f32=shadowMapSizeInverse*10.;var penumbraRatio: f32=((depthMetric-avgBlockerDepth)+AAOffset);var filterRadius: f32=penumbraRatio*lightSizeUV*shadowMapSizeInverse;var random: f32=getRand(vPositionFromLight.xy);var rotationAngle: f32=random*3.1415926;var rotationVector: vec2f= vec2f(cos(rotationAngle),sin(rotationAngle));var shadow: f32=0.;for (var i: i32=0; i<pcfTapCount; i++) {if (exitCondition) {break;}
var offset: vec3f=poissonSamplers[i];offset= vec3f(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.);let coords=uvDepth+offset*filterRadius;shadow+=textureSampleCompareLevel(shadowTexture,shadowSampler,coords.xy,coords.z);}
shadow/= f32(pcfTapCount);shadow=mix(shadow,1.,depthMetric-avgBlockerDepth);shadow=mix(darkness,1.,shadow);return select(computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff),1.0,exitCondition);}
fn computeShadowWithPCSS16(vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32)->f32
{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32);}
fn computeShadowWithPCSS32(vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32)->f32
{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32);}
fn computeShadowWithPCSS64(vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32)->f32
{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64);}
fn computeShadowWithCSMPCSS16(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d_array<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,lightSizeUVCorrection: vec2f,depthCorrection: f32,penumbraDarkness: f32)->f32
{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}
fn computeShadowWithCSMPCSS32(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d_array<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,lightSizeUVCorrection: vec2f,depthCorrection: f32,penumbraDarkness: f32)->f32
{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}
fn computeShadowWithCSMPCSS64(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d_array<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,lightSizeUVCorrection: vec2f,depthCorrection: f32,penumbraDarkness: f32)->f32
{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}
#endif
`;g.IncludesShadersStoreWGSL[kB]||(g.IncludesShadersStoreWGSL[kB]=YZ)});var WB,KZ,A_=S(()=>{O();WB="imageProcessingFunctions",KZ=`#if TONEMAPPING==3
const PBRNeutralStartCompression: f32=0.8-0.04;const PBRNeutralDesaturation: f32=0.15;fn PBRNeutralToneMapping( color: vec3f )->vec3f {var x: f32=min(color.r,min(color.g,color.b));var offset: f32=select(0.04,x-6.25*x*x,x<0.08);var result=color;result-=offset;var peak: f32=max(result.r,max(result.g,result.b));if (peak<PBRNeutralStartCompression) {return result;}
var d: f32=1.-PBRNeutralStartCompression;var newPeak: f32=1.-d*d/(peak+d-PBRNeutralStartCompression);result*=newPeak/peak;var g: f32=1.-1./(PBRNeutralDesaturation*(peak-newPeak)+1.);return mix(result,newPeak* vec3f(1,1,1),g);}
#endif
#if TONEMAPPING==2
const ACESInputMat: mat3x3f= mat3x3f(
vec3f(0.59719,0.07600,0.02840),
vec3f(0.35458,0.90834,0.13383),
vec3f(0.04823,0.01566,0.83777)
);const ACESOutputMat: mat3x3f= mat3x3f(
vec3f( 1.60475,-0.10208,-0.00327),
vec3f(-0.53108, 1.10813,-0.07276),
vec3f(-0.07367,-0.00605, 1.07602)
);fn RRTAndODTFit(v: vec3f)->vec3f
{var a: vec3f=v*(v+0.0245786)-0.000090537;var b: vec3f=v*(0.983729*v+0.4329510)+0.238081;return a/b;}
fn ACESFitted(color: vec3f)->vec3f
{var output=ACESInputMat*color;output=RRTAndODTFit(output);output=ACESOutputMat*output;output=saturateVec3(output);return output;}
#endif
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_DEFINITIONS
fn applyImageProcessing(result: vec4f)->vec4f {
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATSTART
var rgb=result.rgb;;
#ifdef EXPOSURE
rgb*=uniforms.exposureLinear;
#endif
#ifdef VIGNETTE
var viewportXY: vec2f=fragmentInputs.position.xy*uniforms.vInverseScreenSize;viewportXY=viewportXY*2.0-1.0;var vignetteXY1: vec3f= vec3f(viewportXY*uniforms.vignetteSettings1.xy+uniforms.vignetteSettings1.zw,1.0);var vignetteTerm: f32=dot(vignetteXY1,vignetteXY1);var vignette: f32=pow(vignetteTerm,uniforms.vignetteSettings2.w);var vignetteColor: vec3f=uniforms.vignetteSettings2.rgb;
#ifdef VIGNETTEBLENDMODEMULTIPLY
var vignetteColorMultiplier: vec3f=mix(vignetteColor, vec3f(1,1,1),vignette);rgb*=vignetteColorMultiplier;
#endif
#ifdef VIGNETTEBLENDMODEOPAQUE
rgb=mix(vignetteColor,rgb,vignette);
#endif
#endif
#if TONEMAPPING==3
rgb=PBRNeutralToneMapping(rgb);
#elif TONEMAPPING==2
rgb=ACESFitted(rgb);
#elif TONEMAPPING==1
const tonemappingCalibration: f32=1.590579;rgb=1.0-exp2(-tonemappingCalibration*rgb);
#endif
rgb=toGammaSpaceVec3(rgb);rgb=saturateVec3(rgb);
#ifdef CONTRAST
var resultHighContrast: vec3f=rgb*rgb*(3.0-2.0*rgb);if (uniforms.contrast<1.0) {rgb=mix( vec3f(0.5,0.5,0.5),rgb,uniforms.contrast);} else {rgb=mix(rgb,resultHighContrast,uniforms.contrast-1.0);}
rgb=max(rgb,vec3f(0.));
#endif
#ifdef COLORGRADING
var colorTransformInput: vec3f=rgb*uniforms.colorTransformSettings.xxx+uniforms.colorTransformSettings.yyy;
#ifdef COLORGRADING3D
var colorTransformOutput: vec3f=textureSample(txColorTransform,txColorTransformSampler,colorTransformInput).rgb;
#else
var colorTransformOutput: vec3f=textureSample(txColorTransform,txColorTransformSampler,colorTransformInput,uniforms.colorTransformSettings.yz).rgb;
#endif
rgb=mix(rgb,colorTransformOutput,uniforms.colorTransformSettings.www);
#endif
#ifdef COLORCURVES
var luma: f32=getLuminance(rgb);var curveMix: vec2f=clamp( vec2f(luma*3.0-1.5,luma*-3.0+1.5), vec2f(0.0), vec2f(1.0));var colorCurve: vec4f=uniforms.vCameraColorCurveNeutral+curveMix.x*uniforms.vCameraColorCurvePositive-curveMix.y*uniforms.vCameraColorCurveNegative;rgb*=colorCurve.rgb;rgb=mix( vec3f(luma),rgb,colorCurve.a);
#endif
#ifdef DITHER
var rand: f32=getRand(fragmentInputs.position.xy*uniforms.vInverseScreenSize);var dither: f32=mix(-uniforms.ditherIntensity,uniforms.ditherIntensity,rand);rgb=saturateVec3(rgb+ vec3f(dither));
#endif
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATEND
return vec4f(rgb,result.a);}`;g.IncludesShadersStoreWGSL[WB]||(g.IncludesShadersStoreWGSL[WB]=KZ)});var HB,qZ,pu=S(()=>{O();HB="fogFragmentDeclaration",qZ=`#ifdef FOG
#define FOGMODE_NONE 0.
#define FOGMODE_EXP 1.
#define FOGMODE_EXP2 2.
#define FOGMODE_LINEAR 3.
const E=2.71828;uniform vFogInfos: vec4f;uniform vFogColor: vec3f;varying vFogDistance: vec3f;fn CalcFogFactor()->f32
{var fogCoeff: f32=1.0;var fogStart: f32=uniforms.vFogInfos.y;var fogEnd: f32=uniforms.vFogInfos.z;var fogDensity: f32=uniforms.vFogInfos.w;var fogDistance: f32=length(fragmentInputs.vFogDistance);if (FOGMODE_LINEAR==uniforms.vFogInfos.x)
{fogCoeff=(fogEnd-fogDistance)/(fogEnd-fogStart);}
else if (FOGMODE_EXP==uniforms.vFogInfos.x)
{fogCoeff=1.0/pow(E,fogDistance*fogDensity);}
else if (FOGMODE_EXP2==uniforms.vFogInfos.x)
{fogCoeff=1.0/pow(E,fogDistance*fogDistance*fogDensity*fogDensity);}
return clamp(fogCoeff,0.0,1.0);}
#endif
`;g.IncludesShadersStoreWGSL[HB]||(g.IncludesShadersStoreWGSL[HB]=qZ)});var zB,QZ,XB=S(()=>{O();zB="intersectionFunctions",QZ=`fn diskIntersectWithBackFaceCulling(ro: vec3f,rd: vec3f,c: vec3f,r: f32)->f32 {var d: f32=rd.y;if(d>0.0) { return 1e6; }
var o: vec3f=ro-c;var t: f32=-o.y/d;var q: vec3f=o+rd*t;return select(1e6,t,(dot(q,q)<r*r));}
fn sphereIntersect(ro: vec3f,rd: vec3f,ce: vec3f,ra: f32)->vec2f {var oc: vec3f=ro-ce;var b: f32=dot(oc,rd);var c: f32=dot(oc,oc)-ra*ra;var h: f32=b*b-c;if(h<0.0) { return vec2f(-1.,-1.); }
h=sqrt(h);return vec2f(-b+h,-b-h);}
fn sphereIntersectFromOrigin(ro: vec3f,rd: vec3f,ra: f32)->vec2f {var b: f32=dot(ro,rd);var c: f32=dot(ro,ro)-ra*ra;var h: f32=b*b-c;if(h<0.0) { return vec2f(-1.,-1.); }
h=sqrt(h);return vec2f(-b+h,-b-h);}`;g.IncludesShadersStoreWGSL[zB]||(g.IncludesShadersStoreWGSL[zB]=QZ)});var YB,jZ,R_=S(()=>{O();YB="lightFragment",jZ=`#ifdef LIGHT{X}
#if defined(SHADOWONLY) || defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})
#else
var diffuse{X}: vec4f=light{X}.vLightDiffuse;
#define CUSTOM_LIGHT{X}_COLOR 
#if defined(PBR) && defined(CLUSTLIGHT{X})
{let sliceIndex=min(getClusteredSliceIndex(light{X}.vSliceData,fragmentInputs.vViewDepth),CLUSTLIGHT_SLICES-1);info=computeClusteredLighting(
lightDataTexture{X},
&tileMaskBuffer{X},
light{X}.vLightData,
vec2u(light{X}.vSliceRanges[sliceIndex].xy),
viewDirectionW,
normalW,
fragmentInputs.vPositionW,
surfaceAlbedo,
reflectivityOut,
#ifdef IRIDESCENCE
iridescenceIntensity,
#endif
#ifdef SS_TRANSLUCENCY
subSurfaceOut,
#endif
#ifdef SPECULARTERM
AARoughnessFactors.x,
#endif
#ifdef ANISOTROPIC
anisotropicOut,
#endif
#ifdef SHEEN
sheenOut,
#endif
#ifdef CLEARCOAT
clearcoatOut,
#endif
);}
#elif defined(PBR)
#ifdef SPOTLIGHT{X}
preInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,fragmentInputs.vPositionW);
#elif defined(POINTLIGHT{X})
preInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,fragmentInputs.vPositionW);
#elif defined(HEMILIGHT{X})
preInfo=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(DIRLIGHT{X})
preInfo=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(AREALIGHT{X}) && defined(AREALIGHTSUPPORTED)
preInfo=computeAreaPreLightingInfo(areaLightsLTC1Sampler,areaLightsLTC1SamplerSampler,areaLightsLTC2Sampler,areaLightsLTC2SamplerSampler,viewDirectionW,normalW,fragmentInputs.vPositionW,light{X}.vLightData.xyz,light{X}.vLightWidth.xyz,light{X}.vLightHeight.xyz,roughness);
#endif
preInfo.NdotV=NdotV;
#ifdef SPOTLIGHT{X}
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);
#ifdef IESLIGHTTEXTURE{X}
preInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X},iesLightTexture{X}Sampler);
#else
preInfo.attenuation*=computeDirectionalLightFalloff_GLTF(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#endif
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);
#ifdef IESLIGHTTEXTURE{X}
preInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X},iesLightTexture{X}Sampler);
#else
preInfo.attenuation*=computeDirectionalLightFalloff_Physical(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w);
#endif
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);
#ifdef IESLIGHTTEXTURE{X}
preInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X},iesLightTexture{X}Sampler);
#else
preInfo.attenuation*=computeDirectionalLightFalloff_Standard(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w);
#endif
#else
preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
#ifdef IESLIGHTTEXTURE{X}
preInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X},iesLightTexture{X}Sampler);
#else
preInfo.attenuation*=computeDirectionalLightFalloff(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#endif
#endif
#elif defined(POINTLIGHT{X})
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);
#else
preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
#endif
#else
preInfo.attenuation=1.0;
#endif
#if defined(HEMILIGHT{X}) || defined(AREALIGHT{X})
preInfo.roughness=roughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(roughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
preInfo.diffuseRoughness=diffuseRoughness;preInfo.surfaceAlbedo=surfaceAlbedo;
#ifdef IRIDESCENCE
preInfo.iridescenceIntensity=iridescenceIntensity;
#endif
#ifdef SS_TRANSLUCENCY
info.diffuseTransmission=vec3f(0.0);
#endif
#ifdef HEMILIGHT{X}
info.diffuse=computeHemisphericDiffuseLighting(preInfo,diffuse{X}.rgb,light{X}.vLightGround);
#elif defined(AREALIGHT{X})
info.diffuse=computeAreaDiffuseLighting(preInfo,diffuse{X}.rgb);
#elif defined(SS_TRANSLUCENCY)
#ifndef SS_TRANSLUCENCY_LEGACY
info.diffuse=computeDiffuseLighting(preInfo,diffuse{X}.rgb)*(1.0-subSurfaceOut.translucencyIntensity);info.diffuseTransmission=computeDiffuseTransmittedLighting(preInfo,diffuse{X}.rgb,subSurfaceOut.transmittance); 
#else
info.diffuse=computeDiffuseTransmittedLighting(preInfo,diffuse{X}.rgb,subSurfaceOut.transmittance);
#endif
#else
info.diffuse=computeDiffuseLighting(preInfo,diffuse{X}.rgb);
#endif
#ifdef SPECULARTERM
#if AREALIGHT{X}
info.specular=computeAreaSpecularLighting(preInfo,light{X}.vLightSpecular.rgb,clearcoatOut.specularEnvironmentR0,reflectivityOut.colorReflectanceF90);
#else
#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)
{let metalFresnel: vec3f=vec3f(reflectivityOut.specularWeight)*getF82Specular(preInfo.VdotH,clearcoatOut.specularEnvironmentR0,reflectivityOut.colorReflectanceF90,reflectivityOut.roughness);let dielectricFresnel: vec3f=fresnelSchlickGGXVec3(preInfo.VdotH,reflectivityOut.dielectricColorF0,reflectivityOut.colorReflectanceF90);coloredFresnel=mix(dielectricFresnel,metalFresnel,reflectivityOut.metallic);}
#else
coloredFresnel=fresnelSchlickGGXVec3(preInfo.VdotH,clearcoatOut.specularEnvironmentR0,reflectivityOut.colorReflectanceF90);
#endif
#ifndef LEGACY_SPECULAR_ENERGY_CONSERVATION
{let NdotH: f32=dot(normalW,preInfo.H);let fresnel: vec3f=fresnelSchlickGGXVec3(NdotH,vec3f(reflectanceF0),specularEnvironmentR90);info.diffuse*=(vec3f(1.0)-fresnel);}
#endif
#ifdef ANISOTROPIC
info.specular=computeAnisotropicSpecularLighting(preInfo,viewDirectionW,normalW,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,diffuse{X}.rgb);
#else
info.specular=computeSpecularLighting(preInfo,normalW,clearcoatOut.specularEnvironmentR0,coloredFresnel,AARoughnessFactors.x,diffuse{X}.rgb);
#endif
#endif
#endif
#ifndef AREALIGHT{X}
#ifdef SHEEN
#ifdef SHEEN_LINKWITHALBEDO
preInfo.roughness=sheenOut.sheenIntensity;
#else
#ifdef HEMILIGHT{X}
preInfo.roughness=sheenOut.sheenRoughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
#endif
info.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactors.x,diffuse{X}.rgb);
#endif
#ifdef CLEARCOAT
#ifdef HEMILIGHT{X}
preInfo.roughness=clearcoatOut.clearCoatRoughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
info.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,diffuse{X}.rgb);
#ifdef CLEARCOAT_TINT
absorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);info.diffuse*=absorption;
#ifdef SS_TRANSLUCENCY
info.diffuseTransmission*=absorption;
#endif
#ifdef SPECULARTERM
info.specular*=absorption;
#endif
#endif
info.diffuse*=info.clearCoat.w;
#ifdef SS_TRANSLUCENCY
info.diffuseTransmission*=info.clearCoat.w;
#endif
#ifdef SPECULARTERM
info.specular*=info.clearCoat.w;
#endif
#ifdef SHEEN
info.sheen*=info.clearCoat.w;
#endif
#endif
#endif
#else
#ifdef SPOTLIGHT{X}
#ifdef IESLIGHTTEXTURE{X}
info=computeIESSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,diffuse{X}.a,glossiness,iesLightTexture{X},iesLightTexture{X}Sampler);
#else
info=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,diffuse{X}.a,glossiness);
#endif
#elif defined(HEMILIGHT{X})
info=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightGround,glossiness);
#elif defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})
info=computeLighting(viewDirectionW,normalW,light{X}.vLightData,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,diffuse{X}.a,glossiness);
#elif define(AREALIGHT{X}) && defined(AREALIGHTSUPPORTED)
info=computeAreaLighting(areaLightsLTC1Sampler,areaLightsLTC1SamplerSampler,areaLightsLTC2Sampler,areaLightsLTC2SamplerSampler,viewDirectionW,normalW,fragmentInputs.vPositionW,light{X}.vLightData.xyz,light{X}.vLightWidth.xyz,light{X}.vLightHeight.xyz,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,
#ifdef AREALIGHTNOROUGHTNESS
0.5
#else
uniforms.vReflectionInfos.y
#endif
);
#elif defined(CLUSTLIGHT{X})
{let sliceIndex=min(getClusteredSliceIndex(light{X}.vSliceData,fragmentInputs.vViewDepth),CLUSTLIGHT_SLICES-1);info=computeClusteredLighting(lightDataTexture{X},&tileMaskBuffer{X},viewDirectionW,normalW,light{X}.vLightData,vec2u(light{X}.vSliceRanges[sliceIndex].xy),glossiness);}
#endif
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
info.diffuse*=computeProjectionTextureDiffuseLighting(projectionLightTexture{X},projectionLightTexture{X}Sampler,uniforms.textureProjectionMatrix{X},fragmentInputs.vPositionW);
#endif
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSMDEBUG{X}
var shadowDebug{X}: vec3f;
#endif
#ifdef SHADOWCSM{X}
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
var index{X}: i32=-1;
#else
var index{X}: i32=SHADOWCSMNUM_CASCADES{X}-1;
#endif
var diff{X}: f32=0.;vPositionFromLight{X}[0]=fragmentInputs.vPositionFromLight{X}_0;vPositionFromLight{X}[1]=fragmentInputs.vPositionFromLight{X}_1;vPositionFromLight{X}[2]=fragmentInputs.vPositionFromLight{X}_2;vPositionFromLight{X}[3]=fragmentInputs.vPositionFromLight{X}_3;vDepthMetric{X}[0]=fragmentInputs.vDepthMetric{X}_0;vDepthMetric{X}[1]=fragmentInputs.vDepthMetric{X}_1;vDepthMetric{X}[2]=fragmentInputs.vDepthMetric{X}_2;vDepthMetric{X}[3]=fragmentInputs.vDepthMetric{X}_3;for (var i:i32=0; i<SHADOWCSMNUM_CASCADES{X}; i++)
{
#ifdef SHADOWCSM_RIGHTHANDED{X}
diff{X}=uniforms.viewFrustumZ{X}[i]+fragmentInputs.vPositionFromCamera{X}.z;
#else
diff{X}=uniforms.viewFrustumZ{X}[i]-fragmentInputs.vPositionFromCamera{X}.z;
#endif
if (diff{X}>=0.) {index{X}=i;break;}}
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
if (index{X}>=0)
#endif
{
#if defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithCSMPCF1(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithCSMPCF3(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithCSMPCF5(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithCSMPCSS16(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithCSMPCSS32(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});
#else
shadow=computeShadowWithCSMPCSS64(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});
#endif
#else
shadow=computeShadowCSM(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#ifdef SHADOWCSMDEBUG{X}
shadowDebug{X}=vec3f(shadow)*vCascadeColorsMultiplier{X}[index{X}];
#endif
#ifndef SHADOWCSMNOBLEND{X}
var frustumLength:f32=uniforms.frustumLengths{X}[index{X}];var diffRatio:f32=clamp(diff{X}/frustumLength,0.,1.)*uniforms.cascadeBlendFactor{X};if (index{X}<(SHADOWCSMNUM_CASCADES{X}-1) && diffRatio<1.)
{index{X}+=1;var nextShadow: f32=0.;
#if defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
nextShadow=computeShadowWithCSMPCF1(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],,shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
nextShadow=computeShadowWithCSMPCF3(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
nextShadow=computeShadowWithCSMPCF5(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
nextShadow=computeShadowWithCSMPCSS16(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});
#elif defined(SHADOWMEDIUMQUALITY{X})
nextShadow=computeShadowWithCSMPCSS32(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});
#else
nextShadow=computeShadowWithCSMPCSS64(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});
#endif
#else
nextShadow=computeShadowCSM(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
shadow=mix(nextShadow,shadow,diffRatio);
#ifdef SHADOWCSMDEBUG{X}
shadowDebug{X}=mix(vec3(nextShadow)*vCascadeColorsMultiplier{X}[index{X}],shadowDebug{X},diffRatio);
#endif
}
#endif
}
#elif defined(SHADOWCLOSEESM{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithCloseESMCube(fragmentInputs.vPositionW,light{X}.vLightData.xyz,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);
#else
shadow=computeShadowWithCloseESM(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWESM{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithESMCube(fragmentInputs.vPositionW,light{X}.vLightData.xyz,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);
#else
shadow=computeShadowWithESM(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPOISSON{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithPoissonSamplingCube(fragmentInputs.vPositionW,light{X}.vLightData.xyz,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.depthValues);
#else
shadow=computeShadowWithPoissonSampling(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithPCF1(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithPCF3(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithPCF5(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithPCSS16(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithPCSS32(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithPCSS64(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#else
#if defined(SHADOWCUBE{X})
shadow=computeShadowCube(fragmentInputs.vPositionW,light{X}.vLightData.xyz,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.depthValues);
#else
shadow=computeShadow(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#endif
#ifdef SHADOWONLY
#ifndef SHADOWINUSE
#define SHADOWINUSE
#endif
globalShadow+=shadow;shadowLightCount+=1.0;
#endif
#else
shadow=1.;
#endif
aggShadow+=shadow;numLights+=1.0;
#ifndef SHADOWONLY
#ifdef CUSTOMUSERLIGHTING
diffuseBase+=computeCustomDiffuseLighting(info,diffuseBase,shadow);
#ifdef SPECULARTERM
specularBase+=computeCustomSpecularLighting(info,specularBase,shadow);
#endif
#elif defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})
diffuseBase+=lightmapColor.rgb*shadow;
#ifdef SPECULARTERM
#ifndef LIGHTMAPNOSPECULAR{X}
specularBase+=info.specular*shadow*lightmapColor.rgb;
#endif
#endif
#ifdef CLEARCOAT
#ifndef LIGHTMAPNOSPECULAR{X}
clearCoatBase+=info.clearCoat.rgb*shadow*lightmapColor.rgb;
#endif
#endif
#ifdef SHEEN
#ifndef LIGHTMAPNOSPECULAR{X}
sheenBase+=info.sheen.rgb*shadow;
#endif
#endif
#else
#ifdef SHADOWCSMDEBUG{X}
diffuseBase+=info.diffuse*shadowDebug{X};
#else
diffuseBase+=info.diffuse*shadow;
#endif
#ifdef SS_TRANSLUCENCY
diffuseTransmissionBase+=info.diffuseTransmission*shadow;
#endif
#ifdef SPECULARTERM
specularBase+=info.specular*shadow;
#endif
#ifdef CLEARCOAT
clearCoatBase+=info.clearCoat.rgb*shadow;
#endif
#ifdef SHEEN
sheenBase+=info.sheen.rgb*shadow;
#endif
#endif
#endif
#endif
`;g.IncludesShadersStoreWGSL[YB]||(g.IncludesShadersStoreWGSL[YB]=jZ)});var KB,ZZ,mu=S(()=>{O();KB="logDepthFragment",ZZ=`#ifdef LOGARITHMICDEPTH
fragmentOutputs.fragDepth=log2(fragmentInputs.vFragmentDepth)*uniforms.logarithmicDepthConstant*0.5;
#endif
`;g.IncludesShadersStoreWGSL[KB]||(g.IncludesShadersStoreWGSL[KB]=ZZ)});var qB,JZ,_u=S(()=>{O();qB="fogFragment",JZ=`#ifdef FOG
var fog: f32=CalcFogFactor();
#ifdef PBR
fog=toLinearSpace(fog);
#endif
color= vec4f(mix(uniforms.vFogColor,color.rgb,fog),color.a);
#endif
`;g.IncludesShadersStoreWGSL[qB]||(g.IncludesShadersStoreWGSL[qB]=JZ)});var jB={};V(jB,{backgroundPixelShaderWGSL:()=>$Z});var FC,QB,$Z,ZB=S(()=>{O();PC();Pi();S_();E_();T_();wC();x_();A_();za();ba();pu();XB();Ca();R_();mu();_u();FC="backgroundPixelShader",QB=`#include<backgroundUboDeclaration>
#include<helperFunctions>
varying vPositionW: vec3f;
#ifdef MAINUV1
varying vMainUV1: vec2f;
#endif 
#ifdef MAINUV2 
varying vMainUV2: vec2f; 
#endif 
#ifdef NORMAL
varying vNormalW: vec3f;
#endif
#ifdef DIFFUSE
#if DIFFUSEDIRECTUV==1
#define vDiffuseUV vMainUV1
#elif DIFFUSEDIRECTUV==2
#define vDiffuseUV vMainUV2
#else
varying vDiffuseUV: vec2f;
#endif
var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;
#endif
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
var reflectionSamplerSampler: sampler;var reflectionSampler: texture_cube<f32>;
#ifdef TEXTURELODSUPPORT
#else
var reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_cube<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_cube<f32>;
#endif
#else
var reflectionSamplerSampler: sampler;var reflectionSampler: texture_2d<f32>;
#ifdef TEXTURELODSUPPORT
#else
var reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_2d<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_2d<f32>;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vPositionUVW: vec3f;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vDirectionW: vec3f;
#endif
#endif
#include<reflectionFunction>
#endif
#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE;
#endif
#ifndef SHADOWONLY
#define SHADOWONLY;
#endif
#include<imageProcessingDeclaration>
#include<lightUboDeclaration>[0..maxSimultaneousLights]
#include<lightsFragmentFunctions>
#include<shadowsFragmentFunctions>
#include<imageProcessingFunctions>
#include<logDepthDeclaration>
#include<clipPlaneFragmentDeclaration>
#include<fogFragmentDeclaration>
#ifdef REFLECTIONFRESNEL
#define FRESNEL_MAXIMUM_ON_ROUGH 0.25
fn fresnelSchlickEnvironmentGGX(VdotN: f32,reflectance0: vec3f,reflectance90: vec3f,smoothness: f32)->vec3f
{var weight: f32=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}
#endif
#ifdef PROJECTED_GROUND
#include<intersectionFunctions>
fn project(viewDirectionW: vec3f,eyePosition: vec3f)->vec3f {var radius: f32=uniforms.projectedGroundInfos.x;var height: f32=uniforms.projectedGroundInfos.y;var camDir: vec3f=-viewDirectionW;var skySphereDistance: f32=sphereIntersectFromOrigin(eyePosition,camDir,radius).x;var skySpherePositionW: vec3f=eyePosition+camDir*skySphereDistance;var p: vec3f=normalize(skySpherePositionW);var upEyePosition=vec3f(eyePosition.x,eyePosition.y-height,eyePosition.z);var sIntersection: f32=sphereIntersectFromOrigin(upEyePosition,p,radius).x;var h: vec3f= vec3f(0.0,-height,0.0);var dIntersection: f32=diskIntersectWithBackFaceCulling(upEyePosition,p,h,radius);p=(upEyePosition+min(sIntersection,dIntersection)*p);return p;}
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
var viewDirectionW: vec3f=normalize(scene.vEyePosition.xyz-input.vPositionW);
#ifdef NORMAL
var normalW: vec3f=normalize(fragmentInputs.vNormalW);
#else
var normalW: vec3f= vec3f(0.0,1.0,0.0);
#endif
var shadow: f32=1.;var globalShadow: f32=0.;var shadowLightCount: f32=0.;var aggShadow: f32=0.;var numLights: f32=0.;
#include<lightFragment>[0..maxSimultaneousLights]
#ifdef SHADOWINUSE
globalShadow/=shadowLightCount;
#else
globalShadow=1.0;
#endif
#ifndef BACKMAT_SHADOWONLY
var reflectionColor: vec4f= vec4f(1.,1.,1.,1.);
#ifdef REFLECTION
#ifdef PROJECTED_GROUND
var reflectionVector: vec3f=project(viewDirectionW,scene.vEyePosition.xyz);reflectionVector= (uniforms.reflectionMatrix*vec4f(reflectionVector,1.)).xyz;
#else
var reflectionVector: vec3f=computeReflectionCoords( vec4f(fragmentInputs.vPositionW,1.0),normalW);
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
var reflectionCoords: vec3f=reflectionVector;
#else
var reflectionCoords: vec2f=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
#ifdef REFLECTIONBLUR
var reflectionLOD: f32=uniforms.vReflectionInfos.y;
#ifdef TEXTURELODSUPPORT
reflectionLOD=reflectionLOD*log2(uniforms.vReflectionMicrosurfaceInfos.x)*uniforms.vReflectionMicrosurfaceInfos.y+uniforms.vReflectionMicrosurfaceInfos.z;reflectionColor=textureSampleLevel(reflectionSampler,reflectionSamplerSampler,reflectionCoords,reflectionLOD);
#else
var lodReflectionNormalized: f32=saturate(reflectionLOD);var lodReflectionNormalizedDoubled: f32=lodReflectionNormalized*2.0;var reflectionSpecularMid: vec4f=textureSample(reflectionSampler,reflectionSamplerSampler,reflectionCoords);if(lodReflectionNormalizedDoubled<1.0){reflectionColor=mix(
textureSample(reflectionrHighSampler,reflectionrHighSamplerSampler,reflectionCoords),
reflectionSpecularMid,
lodReflectionNormalizedDoubled
);} else {reflectionColor=mix(
reflectionSpecularMid,
textureSample(reflectionLowSampler,reflectionLowSamplerSampler,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);}
#endif
#else
var reflectionSample: vec4f=textureSample(reflectionSampler,reflectionSamplerSampler,reflectionCoords);reflectionColor=reflectionSample;
#endif
#ifdef RGBDREFLECTION
reflectionColor=vec4f(fromRGBD(reflectionColor).rgb,reflectionColor.a);
#endif
#ifdef GAMMAREFLECTION
reflectionColor=vec4f(toLinearSpaceVec3(reflectionColor.rgb),reflectionColor.a);
#endif
#ifdef REFLECTIONBGR
reflectionColor=vec4f(reflectionColor.bgr,reflectionColor.a);
#endif
reflectionColor=vec4f(reflectionColor.rgb*uniforms.vReflectionInfos.x,reflectionColor.a);
#endif
var diffuseColor: vec3f= vec3f(1.,1.,1.);var finalAlpha: f32=uniforms.alpha;
#ifdef DIFFUSE
var diffuseMap: vec4f=textureSample(diffuseSampler,diffuseSamplerSampler,input.vDiffuseUV);
#ifdef GAMMADIFFUSE
diffuseMap=vec4f(toLinearSpaceVec3(diffuseMap.rgb),diffuseMap.a);
#endif
diffuseMap=vec4f(diffuseMap.rgb *uniforms.vDiffuseInfos.y,diffuseMap.a);
#ifdef DIFFUSEHASALPHA
finalAlpha*=diffuseMap.a;
#endif
diffuseColor=diffuseMap.rgb;
#endif
#ifdef REFLECTIONFRESNEL
var colorBase: vec3f=diffuseColor;
#else
var colorBase: vec3f=reflectionColor.rgb*diffuseColor;
#endif
colorBase=max(colorBase,vec3f(0.0));
#ifdef USERGBCOLOR
var finalColor: vec3f=colorBase;
#else
#ifdef USEHIGHLIGHTANDSHADOWCOLORS
var mainColor: vec3f=mix(uniforms.vPrimaryColorShadow.rgb,uniforms.vPrimaryColor.rgb,colorBase);
#else
var mainColor: vec3f=uniforms.vPrimaryColor.rgb;
#endif
var finalColor: vec3f=colorBase*mainColor;
#endif
#ifdef REFLECTIONFRESNEL
var reflectionAmount: vec3f=uniforms.vReflectionControl.xxx;var reflectionReflectance0: vec3f=uniforms.vReflectionControl.yyy;var reflectionReflectance90: vec3f=uniforms.vReflectionControl.zzz;var VdotN: f32=dot(normalize(scene.vEyePosition.xyz),normalW);var planarReflectionFresnel: vec3f=fresnelSchlickEnvironmentGGX(saturate(VdotN),reflectionReflectance0,reflectionReflectance90,1.0);reflectionAmount*=planarReflectionFresnel;
#ifdef REFLECTIONFALLOFF
var reflectionDistanceFalloff: f32=1.0-saturate(length(vPositionW.xyz-uniforms.vBackgroundCenter)*uniforms.vReflectionControl.w);reflectionDistanceFalloff*=reflectionDistanceFalloff;reflectionAmount*=reflectionDistanceFalloff;
#endif
finalColor=mix(finalColor,reflectionColor.rgb,saturateVec3(reflectionAmount));
#endif
#ifdef OPACITYFRESNEL
var viewAngleToFloor: f32=dot(normalW,normalize(scene.vEyePosition.xyz-uniforms.vBackgroundCenter));const startAngle: f32=0.1;var fadeFactor: f32=saturate(viewAngleToFloor/startAngle);finalAlpha*=fadeFactor*fadeFactor;
#endif
#ifdef SHADOWINUSE
finalColor=mix(finalColor*uniforms.shadowLevel,finalColor,globalShadow);
#endif
var color: vec4f= vec4f(finalColor,finalAlpha);
#else
var color: vec4f= vec4f(uniforms.vPrimaryColor.rgb,(1.0-clamp(globalShadow,0.,1.))*uniforms.alpha);
#endif
#include<logDepthFragment>
#include<fogFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS
#if !defined(SKIPFINALCOLORCLAMP)
color=vec4f(clamp(color.rgb,vec3f(0.),vec3f(30.0)),color.a);
#endif
#else
color=applyImageProcessing(color);
#endif
#ifdef PREMULTIPLYALPHA
color=vec4f(color.rgb *color.a,color.a);
#endif
#ifdef NOISE
color=vec4f(color.rgb+dither(fragmentInputs.vPositionW.xy,0.5),color.a);color=max(color,vec4f(0.0));
#endif
fragmentOutputs.color=color;
#define CUSTOM_FRAGMENT_MAIN_END
}
`;g.ShadersStoreWGSL[FC]||(g.ShadersStoreWGSL[FC]=QB);$Z={name:FC,shader:QB}});var JB,eJ,$B=S(()=>{O();JB="backgroundVertexDeclaration",eJ=`uniform mat4 view;uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
uniform float shadowLevel;
#ifdef DIFFUSE
uniform mat4 diffuseMatrix;uniform vec2 vDiffuseInfos;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;uniform float fFovMultiplier;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
`;g.IncludesShadersStore[JB]||(g.IncludesShadersStore[JB]=eJ)});var e2,tJ,NC=S(()=>{O();Ml();e2="backgroundUboDeclaration",tJ=`layout(std140,column_major) uniform;uniform Material
{uniform vec4 vPrimaryColor;uniform vec4 vPrimaryColorShadow;uniform vec2 vDiffuseInfos;uniform vec2 vReflectionInfos;uniform mat4 diffuseMatrix;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;uniform float fFovMultiplier;uniform float pointSize;uniform float shadowLevel;uniform float alpha;uniform vec3 vBackgroundCenter;uniform vec4 vReflectionControl;uniform vec2 projectedGroundInfos;};
#include<sceneUboDeclaration>
`;g.IncludesShadersStore[e2]||(g.IncludesShadersStore[e2]=tJ)});var t2,iJ,gu=S(()=>{O();t2="fogVertexDeclaration",iJ=`#ifdef FOG
varying vec3 vFogDistance;
#endif
`;g.IncludesShadersStore[t2]||(g.IncludesShadersStore[t2]=iJ)});var i2,rJ,b_=S(()=>{O();i2="lightVxFragmentDeclaration",rJ=`#ifdef LIGHT{X}
uniform vec4 vLightData{X};uniform vec4 vLightDiffuse{X};
#ifdef SPECULARTERM
uniform vec4 vLightSpecular{X};
#else
vec4 vLightSpecular{X}=vec4(0.);
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};
#elif defined(SHADOWCUBE{X})
#else
varying vec4 vPositionFromLight{X};varying float vDepthMetric{X};uniform mat4 lightMatrix{X};
#endif
uniform vec4 shadowsInfo{X};uniform vec2 depthValues{X};
#endif
#ifdef SPOTLIGHT{X}
uniform vec4 vLightDirection{X};uniform vec4 vLightFalloff{X};
#elif defined(POINTLIGHT{X})
uniform vec4 vLightFalloff{X};
#elif defined(HEMILIGHT{X})
uniform vec3 vLightGround{X};
#endif
#if defined(AREALIGHT{X})
uniform vec4 vLightWidth{X};uniform vec4 vLightHeight{X};
#endif
#endif
`;g.IncludesShadersStore[i2]||(g.IncludesShadersStore[i2]=rJ)});var r2,sJ,C_=S(()=>{O();r2="lightVxUboDeclaration",sJ=`#ifdef LIGHT{X}
uniform Light{X}
{vec4 vLightData;vec4 vLightDiffuse;vec4 vLightSpecular;
#ifdef SPOTLIGHT{X}
vec4 vLightDirection;vec4 vLightFalloff;
#elif defined(POINTLIGHT{X})
vec4 vLightFalloff;
#elif defined(HEMILIGHT{X})
vec3 vLightGround;
#elif defined(CLUSTLIGHT{X})
vec2 vSliceData;vec2 vSliceRanges[CLUSTLIGHT_SLICES];
#endif
#if defined(AREALIGHT{X})
vec4 vLightWidth;vec4 vLightHeight;
#endif
vec4 shadowsInfo;vec2 depthValues;} light{X};
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};
#elif defined(SHADOWCUBE{X})
#else
varying vec4 vPositionFromLight{X};varying float vDepthMetric{X};uniform mat4 lightMatrix{X};
#endif
#endif
#endif
`;g.IncludesShadersStore[r2]||(g.IncludesShadersStore[r2]=sJ)});var s2,nJ,Xa=S(()=>{O();s2="logDepthDeclaration",nJ=`#ifdef LOGARITHMICDEPTH
uniform float logarithmicDepthConstant;varying float vFragmentDepth;
#endif
`;g.IncludesShadersStore[s2]||(g.IncludesShadersStore[s2]=nJ)});var n2,aJ,vu=S(()=>{O();n2="fogVertex",aJ=`#ifdef FOG
vFogDistance=(view*worldPos).xyz;
#endif
`;g.IncludesShadersStore[n2]||(g.IncludesShadersStore[n2]=aJ)});var a2,oJ,I_=S(()=>{O();a2="shadowsVertex",oJ=`#ifdef SHADOWS
#if defined(SHADOWCSM{X})
vPositionFromCamera{X}=view*worldPos;for (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) {vPositionFromLight{X}[i]=lightMatrix{X}[i]*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetric{X}[i]=(-vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vDepthMetric{X}[i]=(vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
}
#elif defined(SHADOW{X}) && !defined(SHADOWCUBE{X})
vPositionFromLight{X}=lightMatrix{X}*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetric{X}=(-vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vDepthMetric{X}=(vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif
#endif
`;g.IncludesShadersStore[a2]||(g.IncludesShadersStore[a2]=oJ)});var o2,lJ,Su=S(()=>{O();o2="logDepthVertex",lJ=`#ifdef LOGARITHMICDEPTH
vFragmentDepth=1.0+gl_Position.w;gl_Position.z=log2(max(0.000001,vFragmentDepth))*logarithmicDepthConstant;
#endif
`;g.IncludesShadersStore[o2]||(g.IncludesShadersStore[o2]=lJ)});var c2={};V(c2,{backgroundVertexShader:()=>cJ});var BC,l2,cJ,f2=S(()=>{O();$B();NC();Di();La();wa();ko();Fa();gu();b_();C_();Xa();Na();Ba();Ua();Ga();vu();I_();Su();BC="backgroundVertexShader",l2=`precision highp float;
#include<__decl__backgroundVertex>
#include<helperFunctions>
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#ifdef MAINUV1
varying vec2 vMainUV1;
#endif
#ifdef MAINUV2
varying vec2 vMainUV2;
#endif
#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0
varying vec2 vDiffuseUV;
#endif
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=position;
#endif
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {gl_Position=viewProjection*finalWorld*vec4(position,1.0);} else {gl_Position=viewProjectionR*finalWorld*vec4(position,1.0);}
#else
gl_Position=viewProjection*finalWorld*vec4(position,1.0);
#endif
vec4 worldPos=finalWorld*vec4(position,1.0);vPositionW=vec3(worldPos);
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normal);
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(position,0.0)));
#ifdef EQUIRECTANGULAR_RELFECTION_FOV
mat3 screenToWorld=inverseMat3(mat3(finalWorld*viewProjection));vec3 segment=mix(vDirectionW,screenToWorld*vec3(0.0,0.0,1.0),abs(fFovMultiplier-1.0));if (fFovMultiplier<=1.0) {vDirectionW=normalize(segment);} else {vDirectionW=normalize(vDirectionW+(vDirectionW-segment));}
#endif
#endif
#ifndef UV1
vec2 uv=vec2(0.,0.);
#endif
#ifndef UV2
vec2 uv2=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uv;
#endif
#ifdef MAINUV2
vMainUV2=uv2;
#endif
#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0
if (vDiffuseInfos.x==0.)
{vDiffuseUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));}
else
{vDiffuseUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));}
#endif
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#ifdef VERTEXCOLOR
vColor=colorUpdated;
#endif
#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}
`;g.ShadersStore[BC]||(g.ShadersStore[BC]=l2);cJ={name:BC,shader:l2}});var h2,fJ,u2=S(()=>{O();h2="backgroundFragmentDeclaration",fJ=`uniform vec4 vEyePosition;uniform vec4 vPrimaryColor;
#ifdef USEHIGHLIGHTANDSHADOWCOLORS
uniform vec4 vPrimaryColorShadow;
#endif
uniform float shadowLevel;uniform float alpha;
#ifdef DIFFUSE
uniform vec2 vDiffuseInfos;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;
#endif
#if defined(REFLECTIONFRESNEL) || defined(OPACITYFRESNEL)
uniform vec3 vBackgroundCenter;
#endif
#ifdef REFLECTIONFRESNEL
uniform vec4 vReflectionControl;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION)
uniform mat4 view;
#endif
#ifdef PROJECTED_GROUND
uniform vec2 projectedGroundInfos;
#endif
`;g.IncludesShadersStore[h2]||(g.IncludesShadersStore[h2]=fJ)});var d2,hJ,y_=S(()=>{O();d2="reflectionFunction",hJ=`vec3 computeFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)
{float lon=atan(direction.z,direction.x);float lat=acos(direction.y);vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;float s=sphereCoords.x*0.5+0.5;float t=sphereCoords.y;return vec3(s,t,0); }
vec3 computeMirroredFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)
{float lon=atan(direction.z,direction.x);float lat=acos(direction.y);vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;float s=sphereCoords.x*0.5+0.5;float t=sphereCoords.y;return vec3(1.0-s,t,0); }
vec3 computeEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{vec3 cameraToVertex=normalize(worldPos.xyz-eyePosition);vec3 r=normalize(reflect(cameraToVertex,worldNormal));r=vec3(reflectionMatrix*vec4(r,0));float lon=atan(r.z,r.x);float lat=acos(r.y);vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;float s=sphereCoords.x*0.5+0.5;float t=sphereCoords.y;return vec3(s,t,0);}
vec3 computeSphericalCoords(vec4 worldPos,vec3 worldNormal,mat4 view,mat4 reflectionMatrix)
{vec3 viewDir=normalize(vec3(view*worldPos));vec3 viewNormal=normalize(vec3(view*vec4(worldNormal,0.0)));vec3 r=reflect(viewDir,viewNormal);r=vec3(reflectionMatrix*vec4(r,0));r.z=r.z-1.0;float m=2.0*length(r);return vec3(r.x/m+0.5,1.0-r.y/m-0.5,0);}
vec3 computePlanarCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{vec3 viewDir=worldPos.xyz-eyePosition;vec3 coords=normalize(reflect(viewDir,worldNormal));return vec3(reflectionMatrix*vec4(coords,1));}
vec3 computeCubicCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{vec3 viewDir=normalize(worldPos.xyz-eyePosition);vec3 coords=reflect(viewDir,worldNormal);coords=vec3(reflectionMatrix*vec4(coords,0));
#ifdef INVERTCUBICMAP
coords.y*=-1.0;
#endif
return coords;}
vec3 computeCubicLocalCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix,vec3 reflectionSize,vec3 reflectionPosition)
{vec3 viewDir=normalize(worldPos.xyz-eyePosition);vec3 coords=reflect(viewDir,worldNormal);coords=parallaxCorrectNormal(worldPos.xyz,coords,reflectionSize,reflectionPosition);coords=vec3(reflectionMatrix*vec4(coords,0));
#ifdef INVERTCUBICMAP
coords.y*=-1.0;
#endif
return coords;}
vec3 computeProjectionCoords(vec4 worldPos,mat4 view,mat4 reflectionMatrix)
{return vec3(reflectionMatrix*(view*worldPos));}
vec3 computeSkyBoxCoords(vec3 positionW,mat4 reflectionMatrix)
{return vec3(reflectionMatrix*vec4(positionW,1.));}
#ifdef REFLECTION
vec3 computeReflectionCoords(vec4 worldPos,vec3 worldNormal)
{
#ifdef REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED
vec3 direction=normalize(vDirectionW);return computeMirroredFixedEquirectangularCoords(worldPos,worldNormal,direction);
#endif
#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED
vec3 direction=normalize(vDirectionW);return computeFixedEquirectangularCoords(worldPos,worldNormal,direction);
#endif
#ifdef REFLECTIONMAP_EQUIRECTANGULAR
return computeEquirectangularCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_SPHERICAL
return computeSphericalCoords(worldPos,worldNormal,view,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_PLANAR
return computePlanarCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_CUBIC
#ifdef USE_LOCAL_REFLECTIONMAP_CUBIC
return computeCubicLocalCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix,vReflectionSize,vReflectionPosition);
#else
return computeCubicCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#endif
#ifdef REFLECTIONMAP_PROJECTION
return computeProjectionCoords(worldPos,view,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_SKYBOX
return computeSkyBoxCoords(vPositionUVW,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_EXPLICIT
return vec3(0,0,0);
#endif
}
#endif
`;g.IncludesShadersStore[d2]||(g.IncludesShadersStore[d2]=hJ)});var p2,uJ,M_=S(()=>{O();p2="imageProcessingDeclaration",uJ=`#ifdef EXPOSURE
uniform float exposureLinear;
#endif
#ifdef CONTRAST
uniform float contrast;
#endif
#if defined(VIGNETTE) || defined(DITHER)
uniform vec2 vInverseScreenSize;
#endif
#ifdef VIGNETTE
uniform vec4 vignetteSettings1;uniform vec4 vignetteSettings2;
#endif
#ifdef COLORCURVES
uniform vec4 vCameraColorCurveNegative;uniform vec4 vCameraColorCurveNeutral;uniform vec4 vCameraColorCurvePositive;
#endif
#ifdef COLORGRADING
#ifdef COLORGRADING3D
uniform highp sampler3D txColorTransform;
#else
uniform sampler2D txColorTransform;
#endif
uniform vec4 colorTransformSettings;
#endif
#ifdef DITHER
uniform float ditherIntensity;
#endif
`;g.IncludesShadersStore[p2]||(g.IncludesShadersStore[p2]=uJ)});var m2,dJ,P_=S(()=>{O();m2="lightFragmentDeclaration",dJ=`#ifdef LIGHT{X}
uniform vec4 vLightData{X};uniform vec4 vLightDiffuse{X};
#ifdef SPECULARTERM
uniform vec4 vLightSpecular{X};
#else
vec4 vLightSpecular{X}=vec4(0.);
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];uniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];uniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];uniform float cascadeBlendFactor{X};varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DArrayShadow shadowTexture{X};uniform highp sampler2DArray depthTexture{X};uniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float penumbraDarkness{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DArrayShadow shadowTexture{X};
#else
uniform highp sampler2DArray shadowTexture{X};
#endif
#ifdef SHADOWCSMDEBUG{X}
const vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]
(
vec3 ( 1.5,0.0,0.0 ),
vec3 ( 0.0,1.5,0.0 ),
vec3 ( 0.0,0.0,5.5 ),
vec3 ( 1.5,0.0,5.5 ),
vec3 ( 1.5,1.5,0.0 ),
vec3 ( 1.0,1.0,1.0 ),
vec3 ( 0.0,1.0,5.5 ),
vec3 ( 0.5,3.5,0.75 )
);vec3 shadowDebug{X};
#endif
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
int index{X}=-1;
#else
int index{X}=SHADOWCSMNUM_CASCADES{X}-1;
#endif
float diff{X}=0.;
#elif defined(SHADOWCUBE{X})
uniform samplerCube shadowTexture{X};
#else
varying vec4 vPositionFromLight{X};varying float vDepthMetric{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DShadow shadowTexture{X};uniform highp sampler2D depthTexture{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DShadow shadowTexture{X};
#else
uniform sampler2D shadowTexture{X};
#endif
uniform mat4 lightMatrix{X};
#endif
uniform vec4 shadowsInfo{X};uniform vec2 depthValues{X};
#endif
#ifdef SPOTLIGHT{X}
uniform vec4 vLightDirection{X};uniform vec4 vLightFalloff{X};
#elif defined(POINTLIGHT{X})
uniform vec4 vLightFalloff{X};
#elif defined(HEMILIGHT{X})
uniform vec3 vLightGround{X};
#endif
#ifdef AREALIGHT{X}
uniform vec4 vLightWidth{X};uniform vec4 vLightHeight{X};
#endif
#ifdef IESLIGHTTEXTURE{X}
uniform sampler2D iesLightTexture{X};
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
uniform mat4 textureProjectionMatrix{X};uniform sampler2D projectionLightTexture{X};
#endif
#ifdef CLUSTLIGHT{X}
uniform vec2 vSliceData{X};uniform vec2 vSliceRanges{X}[CLUSTLIGHT_SLICES];uniform sampler2D lightDataTexture{X};uniform highp sampler2D tileMaskTexture{X};
#endif
#endif
`;g.IncludesShadersStore[m2]||(g.IncludesShadersStore[m2]=dJ)});var _2,pJ,D_=S(()=>{O();_2="lightUboDeclaration",pJ=`#ifdef LIGHT{X}
uniform Light{X}
{vec4 vLightData;vec4 vLightDiffuse;vec4 vLightSpecular;
#ifdef SPOTLIGHT{X}
vec4 vLightDirection;vec4 vLightFalloff;
#elif defined(POINTLIGHT{X})
vec4 vLightFalloff;
#elif defined(HEMILIGHT{X})
vec3 vLightGround;
#elif defined(CLUSTLIGHT{X})
vec2 vSliceData;vec2 vSliceRanges[CLUSTLIGHT_SLICES];
#endif
#if defined(AREALIGHT{X})
vec4 vLightWidth;vec4 vLightHeight;
#endif
vec4 shadowsInfo;vec2 depthValues;} light{X};
#ifdef IESLIGHTTEXTURE{X}
uniform sampler2D iesLightTexture{X};
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
uniform mat4 textureProjectionMatrix{X};uniform sampler2D projectionLightTexture{X};
#endif
#ifdef CLUSTLIGHT{X}
uniform sampler2D lightDataTexture{X};uniform highp sampler2D tileMaskTexture{X};
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];uniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];uniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];uniform float cascadeBlendFactor{X};varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DArrayShadow shadowTexture{X};uniform highp sampler2DArray depthTexture{X};uniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float penumbraDarkness{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DArrayShadow shadowTexture{X};
#else
uniform highp sampler2DArray shadowTexture{X};
#endif
#ifdef SHADOWCSMDEBUG{X}
const vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]
(
vec3 ( 1.5,0.0,0.0 ),
vec3 ( 0.0,1.5,0.0 ),
vec3 ( 0.0,0.0,5.5 ),
vec3 ( 1.5,0.0,5.5 ),
vec3 ( 1.5,1.5,0.0 ),
vec3 ( 1.0,1.0,1.0 ),
vec3 ( 0.0,1.0,5.5 ),
vec3 ( 0.5,3.5,0.75 )
);vec3 shadowDebug{X};
#endif
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
int index{X}=-1;
#else
int index{X}=SHADOWCSMNUM_CASCADES{X}-1;
#endif
float diff{X}=0.;
#elif defined(SHADOWCUBE{X})
uniform samplerCube shadowTexture{X}; 
#else
varying vec4 vPositionFromLight{X};varying float vDepthMetric{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DShadow shadowTexture{X};uniform highp sampler2D depthTexture{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DShadow shadowTexture{X};
#else
uniform sampler2D shadowTexture{X};
#endif
uniform mat4 lightMatrix{X};
#endif
#endif
#endif
`;g.IncludesShadersStore[_2]||(g.IncludesShadersStore[_2]=pJ)});var g2,mJ,UC=S(()=>{O();g2="ltcHelperFunctions",mJ=`vec2 LTCUv( const in vec3 N,const in vec3 V,const in float roughness ) {const float LUTSIZE=64.0;const float LUTSCALE=( LUTSIZE-1.0 )/LUTSIZE;const float LUTBIAS=0.5/LUTSIZE;float dotNV=saturate( dot( N,V ) );vec2 uv=vec2( roughness,sqrt( 1.0-dotNV ) );uv=uv*LUTSCALE+LUTBIAS;return uv;}
float LTCClippedSphereFormFactor( const in vec3 f ) {float l=length( f );return max( ( l*l+f.z )/( l+1.0 ),0.0 );}
vec3 LTCEdgeVectorFormFactor( const in vec3 v1,const in vec3 v2 ) {float x=dot( v1,v2 );float y=abs( x );float a=0.8543985+( 0.4965155+0.0145206*y )*y;float b=3.4175940+( 4.1616724+y )*y;float v=a/b;float thetaSintheta=0.0;if( x>0.0 )
{thetaSintheta=v;}
else
{thetaSintheta=0.5*inversesqrt( max( 1.0-x*x,1e-7 ) )-v;}
return cross( v1,v2 )*thetaSintheta;}
vec3 LTCEvaluate( const in vec3 N,const in vec3 V,const in vec3 P,const in mat3 mInv,const in vec3 rectCoords[ 4 ] ) {vec3 v1=rectCoords[ 1 ]-rectCoords[ 0 ];vec3 v2=rectCoords[ 3 ]-rectCoords[ 0 ];vec3 lightNormal=cross( v1,v2 );if( dot( lightNormal,P-rectCoords[ 0 ] )<0.0 ) return vec3( 0.0 );vec3 T1,T2;T1=normalize( V-N*dot( V,N ) );T2=- cross( N,T1 ); 
mat3 mat=mInv*transposeMat3( mat3( T1,T2,N ) );vec3 coords[ 4 ];coords[ 0 ]=mat*( rectCoords[ 0 ]-P );coords[ 1 ]=mat*( rectCoords[ 1 ]-P );coords[ 2 ]=mat*( rectCoords[ 2 ]-P );coords[ 3 ]=mat*( rectCoords[ 3 ]-P );coords[ 0 ]=normalize( coords[ 0 ] );coords[ 1 ]=normalize( coords[ 1 ] );coords[ 2 ]=normalize( coords[ 2 ] );coords[ 3 ]=normalize( coords[ 3 ] );vec3 vectorFormFactor=vec3( 0.0 );vectorFormFactor+=LTCEdgeVectorFormFactor( coords[ 0 ],coords[ 1 ] );vectorFormFactor+=LTCEdgeVectorFormFactor( coords[ 1 ],coords[ 2 ] );vectorFormFactor+=LTCEdgeVectorFormFactor( coords[ 2 ],coords[ 3 ] );vectorFormFactor+=LTCEdgeVectorFormFactor( coords[ 3 ],coords[ 0 ] );float result=LTCClippedSphereFormFactor( vectorFormFactor );return vec3( result );}
struct areaLightData
{vec3 Diffuse;vec3 Specular;vec4 Fresnel;};
#define inline
areaLightData computeAreaLightSpecularDiffuseFresnel(const in sampler2D ltc1,const in sampler2D ltc2,const in vec3 viewDir,const in vec3 normal,const in vec3 position,const in vec3 lightPos,const in vec3 halfWidth,const in vec3 halfHeight,const in float roughness) 
{areaLightData result;vec3 rectCoords[ 4 ];rectCoords[ 0 ]=lightPos+halfWidth-halfHeight; 
rectCoords[ 1 ]=lightPos-halfWidth-halfHeight;rectCoords[ 2 ]=lightPos-halfWidth+halfHeight;rectCoords[ 3 ]=lightPos+halfWidth+halfHeight;
#ifdef SPECULARTERM
vec2 uv=LTCUv( normal,viewDir,roughness );vec4 t1=texture2D( ltc1,uv );vec4 t2=texture2D( ltc2,uv );mat3 mInv=mat3(
vec3( t1.x,0,t1.y ),
vec3( 0,1, 0 ),
vec3( t1.z,0,t1.w )
);result.Specular=LTCEvaluate( normal,viewDir,position,mInv,rectCoords );result.Fresnel=t2;
#endif
result.Diffuse=LTCEvaluate( normal,viewDir,position,mat3( 1.0 ),rectCoords );return result;}`;g.IncludesShadersStore[g2]||(g.IncludesShadersStore[g2]=mJ)});var v2,_J,GC=S(()=>{O();v2="clusteredLightingFunctions",_J=`struct ClusteredLight {vec4 vLightData;vec4 vLightDiffuse;vec4 vLightSpecular;vec4 vLightDirection;vec4 vLightFalloff;};ClusteredLight getClusteredLight(sampler2D lightDataTexture,int index) {return ClusteredLight(
texelFetch(lightDataTexture,ivec2(0,index),0),
texelFetch(lightDataTexture,ivec2(1,index),0),
texelFetch(lightDataTexture,ivec2(2,index),0),
texelFetch(lightDataTexture,ivec2(3,index),0),
texelFetch(lightDataTexture,ivec2(4,index),0)
);}
int getClusteredSliceIndex(vec2 sliceData,float viewDepth) {return int(log(viewDepth)*sliceData.x+sliceData.y);}
`;g.IncludesShadersStore[v2]||(g.IncludesShadersStore[v2]=_J)});var S2,gJ,VC=S(()=>{O();UC();GC();S2="lightsFragmentFunctions",gJ=`struct lightingInfo
{vec3 diffuse;
#ifdef SPECULARTERM
vec3 specular;
#endif
#ifdef NDOTL
float ndl;
#endif
};lightingInfo computeLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {lightingInfo result;vec3 lightVectorW;float attenuation=1.0;if (lightData.w==0.)
{vec3 direction=lightData.xyz-vPositionW;attenuation=max(0.,1.0-length(direction)/range);lightVectorW=normalize(direction);}
else
{lightVectorW=normalize(-lightData.xyz);}
float ndl=max(0.,dot(vNormal,lightVectorW));
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=ndl*diffuseColor*attenuation;
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightVectorW);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;
#endif
return result;}
float getAttenuation(float cosAngle,float exponent) {return max(0.,pow(cosAngle,exponent));}
float getIESAttenuation(float cosAngle,sampler2D iesLightSampler) {float angle=acos(cosAngle)/PI;return texture2D(iesLightSampler,vec2(angle,0.)).r;}
lightingInfo basicSpotLighting(vec3 viewDirectionW,vec3 lightVectorW,vec3 vNormal,float attenuation,vec3 diffuseColor,vec3 specularColor,float glossiness) {lightingInfo result; 
float ndl=max(0.,dot(vNormal,lightVectorW));
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=ndl*diffuseColor*attenuation;
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightVectorW);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;
#endif
return result;}
lightingInfo computeIESSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float range,float glossiness,sampler2D iesLightSampler) { 
vec3 direction=lightData.xyz-vPositionW;vec3 lightVectorW=normalize(direction);float attenuation=max(0.,1.0-length(direction)/range);float dotProduct=dot(lightDirection.xyz,-lightVectorW);float cosAngle=max(0.,dotProduct);if (cosAngle>=lightDirection.w)
{ 
attenuation*=getIESAttenuation(dotProduct,iesLightSampler);return basicSpotLighting(viewDirectionW,lightVectorW,vNormal,attenuation,diffuseColor,specularColor,glossiness);}
lightingInfo result;result.diffuse=vec3(0.);
#ifdef SPECULARTERM
result.specular=vec3(0.);
#endif
#ifdef NDOTL
result.ndl=0.;
#endif
return result;}
lightingInfo computeSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {vec3 direction=lightData.xyz-vPositionW;vec3 lightVectorW=normalize(direction);float attenuation=max(0.,1.0-length(direction)/range);float cosAngle=max(0.,dot(lightDirection.xyz,-lightVectorW));if (cosAngle>=lightDirection.w)
{ 
attenuation*=getAttenuation(cosAngle,lightData.w);return basicSpotLighting(viewDirectionW,lightVectorW,vNormal,attenuation,diffuseColor,specularColor,glossiness);}
lightingInfo result;result.diffuse=vec3(0.);
#ifdef SPECULARTERM
result.specular=vec3(0.);
#endif
#ifdef NDOTL
result.ndl=0.;
#endif
return result;}
lightingInfo computeHemisphericLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,vec3 groundColor,float glossiness) {lightingInfo result;float ndl=dot(vNormal,lightData.xyz)*0.5+0.5;
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=mix(groundColor,diffuseColor,ndl);
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightData.xyz);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor;
#endif
return result;}
#define inline
vec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix,vec3 posW){vec4 strq=textureProjectionMatrix*vec4(posW,1.0);strq/=strq.w;vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;return textureColor;}
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
#include<ltcHelperFunctions>
uniform sampler2D areaLightsLTC1Sampler;uniform sampler2D areaLightsLTC2Sampler;
#define inline
lightingInfo computeAreaLighting(sampler2D ltc1,sampler2D ltc2,vec3 viewDirectionW,vec3 vNormal,vec3 vPosition,vec3 lightPosition,vec3 halfWidth,vec3 halfHeight,vec3 diffuseColor,vec3 specularColor,float roughness) 
{lightingInfo result;areaLightData data=computeAreaLightSpecularDiffuseFresnel(ltc1,ltc2,viewDirectionW,vNormal,vPosition,lightPosition,halfWidth,halfHeight,roughness);
#ifdef SPECULARTERM
vec3 fresnel=( specularColor*data.Fresnel.x+( vec3( 1.0 )-specularColor )*data.Fresnel.y );result.specular+=specularColor*fresnel*data.Specular;
#endif
result.diffuse+=diffuseColor*data.Diffuse;return result;}
#endif
#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0
#include<clusteredLightingFunctions>
lightingInfo computeClusteredLighting(
sampler2D lightDataTexture,
sampler2D tileMaskTexture,
vec3 viewDirectionW,
vec3 vNormal,
vec4 lightData,
ivec2 sliceRange,
float glossiness
) {lightingInfo result;ivec2 tilePosition=ivec2(gl_FragCoord.xy*lightData.xy);int maskHeight=int(lightData.z);tilePosition.y=min(tilePosition.y,maskHeight-1);ivec2 batchRange=sliceRange/CLUSTLIGHT_BATCH;int batchOffset=batchRange.x*CLUSTLIGHT_BATCH;tilePosition.y+=maskHeight*batchRange.x;for (int i=batchRange.x; i<=batchRange.y; i+=1) {uint mask=uint(texelFetch(tileMaskTexture,tilePosition,0).r);tilePosition.y+=maskHeight;int maskOffset=max(sliceRange.x-batchOffset,0);int maskWidth=min(sliceRange.y-batchOffset+1,CLUSTLIGHT_BATCH);mask=extractBits(mask,maskOffset,maskWidth);while (mask != 0u) {uint bit=mask & -mask;mask ^= bit;int position=onlyBitPosition(bit);ClusteredLight light=getClusteredLight(lightDataTexture,batchOffset+maskOffset+position);lightingInfo info;if (light.vLightDirection.w<0.0) {info=computeLighting(viewDirectionW,vNormal,light.vLightData,light.vLightDiffuse.rgb,light.vLightSpecular.rgb,light.vLightDiffuse.a,glossiness);} else {info=computeSpotLighting(viewDirectionW,vNormal,light.vLightData,light.vLightDirection,light.vLightDiffuse.rgb,light.vLightSpecular.rgb,light.vLightDiffuse.a,glossiness);}
result.diffuse+=info.diffuse;
#ifdef SPECULARTERM
result.specular+=info.specular;
#endif
}
batchOffset+=CLUSTLIGHT_BATCH;}
return result;}
#endif
`;g.IncludesShadersStore[S2]||(g.IncludesShadersStore[S2]=gJ)});var E2,vJ,O_=S(()=>{O();E2="shadowsFragmentFunctions",vJ=`#ifdef SHADOWS
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)
#else
#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)
#endif
#ifndef SHADOWFLOAT
float unpack(vec4 color)
{const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}
#endif
float computeFallOff(float value,vec2 clipSpace,float frustumEdgeFalloff)
{float mask=smoothstep(1.0-frustumEdgeFalloff,1.00000012,clamp(dot(clipSpace,clipSpace),0.,1.));return mix(value,1.0,mask);}
#define inline
float computeShadowCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float darkness,vec2 depthValues)
{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadow=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadow=textureCube(shadowSampler,directionToLight).x;
#endif
return depth>shadow ? darkness : 1.0;}
#define inline
float computeShadowWithPoissonSamplingCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float mapSize,float darkness,vec2 depthValues)
{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;float visibility=1.;vec3 poissonDisk[4];poissonDisk[0]=vec3(-1.0,1.0,-1.0);poissonDisk[1]=vec3(1.0,-1.0,-1.0);poissonDisk[2]=vec3(-1.0,-1.0,-1.0);poissonDisk[3]=vec3(1.0,-1.0,1.0);
#ifndef SHADOWFLOAT
if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize))<depth) visibility-=0.25;if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize))<depth) visibility-=0.25;if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize))<depth) visibility-=0.25;if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize))<depth) visibility-=0.25;
#else
if (textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<depth) visibility-=0.25;if (textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<depth) visibility-=0.25;if (textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<depth) visibility-=0.25;if (textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<depth) visibility-=0.25;
#endif
return min(1.0,visibility+darkness);}
#define inline
float computeShadowWithESMCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)
{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);float shadowPixelDepth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadowMapSample=textureCube(shadowSampler,directionToLight).x;
#endif
float esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return esm;}
#define inline
float computeShadowWithCloseESMCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)
{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);float shadowPixelDepth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadowMapSample=textureCube(shadowSampler,directionToLight).x;
#endif
float esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return esm;}
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define inline
float computeShadowCSM(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray shadowSampler,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);vec3 uvLayer=vec3(uv.x,uv.y,layer);float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadow=unpack(texture2D(shadowSampler,uvLayer));
#else
float shadow=texture2D(shadowSampler,uvLayer).x;
#endif
return shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;}
#endif
#define inline
float computeShadow(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadow=unpack(TEXTUREFUNC(shadowSampler,uv,0.));
#else
float shadow=TEXTUREFUNC(shadowSampler,uv,0.).x;
#endif
return shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;}}
#define inline
float computeShadowWithPoissonSampling(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float mapSize,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{float shadowPixelDepth=clamp(depthMetric,0.,1.0);float visibility=1.;vec2 poissonDisk[4];poissonDisk[0]=vec2(-0.94201624,-0.39906216);poissonDisk[1]=vec2(0.94558609,-0.76890725);poissonDisk[2]=vec2(-0.094184101,-0.92938870);poissonDisk[3]=vec2(0.34495938,0.29387760);
#ifndef SHADOWFLOAT
if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;
#else
if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;
#endif
return computeFallOff(min(1.0,visibility+darkness),clipSpace.xy,frustumEdgeFalloff);}}
#define inline
float computeShadowWithESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));
#else
float shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;
#endif
float esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}
#define inline
float computeShadowWithCloseESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{float shadowPixelDepth=clamp(depthMetric,0.,1.0); 
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));
#else
float shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;
#endif
float esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}
#ifdef IS_NDC_HALF_ZRANGE
#define ZINCLIP clipSpace.z
#else
#define ZINCLIP uvDepth.z
#endif
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define GREATEST_LESS_THAN_ONE 0.99999994
#define DISABLE_UNIFORMITY_ANALYSIS
#define inline
float computeShadowWithCSMPCF1(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);float shadow=texture2D(shadowSampler,uvDepthLayer);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}
#define inline
float computeShadowWithCSMPCF3(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=3.-2.*st;vec2 uvw1=1.+2.*st;vec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;vec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}
#define inline
float computeShadowWithCSMPCF5(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=4.-3.*st;vec2 uvw1=vec2(7.);vec2 uvw2=1.+3.*st;vec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;vec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));shadow+=uvw2.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[0]),layer,uvDepth.z));shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));shadow+=uvw2.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[1]),layer,uvDepth.z));shadow+=uvw0.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[2]),layer,uvDepth.z));shadow+=uvw1.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[2]),layer,uvDepth.z));shadow+=uvw2.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[2]),layer,uvDepth.z));shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}
#define inline
float computeShadowWithPCF1(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,float darkness,float frustumEdgeFalloff)
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;float shadow=TEXTUREFUNC(shadowSampler,uvDepth,0.);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
#define inline
float computeShadowWithPCF3(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=3.-2.*st;vec2 uvw1=1.+2.*st;vec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;vec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);shadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);shadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);shadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
#define inline
float computeShadowWithPCF5(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=4.-3.*st;vec2 uvw1=vec2(7.);vec2 uvw2=1.+3.*st;vec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;vec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);shadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);shadow+=uvw2.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[0]),uvDepth.z),0.);shadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);shadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);shadow+=uvw2.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[1]),uvDepth.z),0.);shadow+=uvw0.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[2]),uvDepth.z),0.);shadow+=uvw1.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[2]),uvDepth.z),0.);shadow+=uvw2.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[2]),uvDepth.z),0.);shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
const vec3 PoissonSamplers32[64]=vec3[64](
vec3(0.06407013,0.05409927,0.),
vec3(0.7366577,0.5789394,0.),
vec3(-0.6270542,-0.5320278,0.),
vec3(-0.4096107,0.8411095,0.),
vec3(0.6849564,-0.4990818,0.),
vec3(-0.874181,-0.04579735,0.),
vec3(0.9989998,0.0009880066,0.),
vec3(-0.004920578,-0.9151649,0.),
vec3(0.1805763,0.9747483,0.),
vec3(-0.2138451,0.2635818,0.),
vec3(0.109845,0.3884785,0.),
vec3(0.06876755,-0.3581074,0.),
vec3(0.374073,-0.7661266,0.),
vec3(0.3079132,-0.1216763,0.),
vec3(-0.3794335,-0.8271583,0.),
vec3(-0.203878,-0.07715034,0.),
vec3(0.5912697,0.1469799,0.),
vec3(-0.88069,0.3031784,0.),
vec3(0.5040108,0.8283722,0.),
vec3(-0.5844124,0.5494877,0.),
vec3(0.6017799,-0.1726654,0.),
vec3(-0.5554981,0.1559997,0.),
vec3(-0.3016369,-0.3900928,0.),
vec3(-0.5550632,-0.1723762,0.),
vec3(0.925029,0.2995041,0.),
vec3(-0.2473137,0.5538505,0.),
vec3(0.9183037,-0.2862392,0.),
vec3(0.2469421,0.6718712,0.),
vec3(0.3916397,-0.4328209,0.),
vec3(-0.03576927,-0.6220032,0.),
vec3(-0.04661255,0.7995201,0.),
vec3(0.4402924,0.3640312,0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.)
);const vec3 PoissonSamplers64[64]=vec3[64](
vec3(-0.613392,0.617481,0.),
vec3(0.170019,-0.040254,0.),
vec3(-0.299417,0.791925,0.),
vec3(0.645680,0.493210,0.),
vec3(-0.651784,0.717887,0.),
vec3(0.421003,0.027070,0.),
vec3(-0.817194,-0.271096,0.),
vec3(-0.705374,-0.668203,0.),
vec3(0.977050,-0.108615,0.),
vec3(0.063326,0.142369,0.),
vec3(0.203528,0.214331,0.),
vec3(-0.667531,0.326090,0.),
vec3(-0.098422,-0.295755,0.),
vec3(-0.885922,0.215369,0.),
vec3(0.566637,0.605213,0.),
vec3(0.039766,-0.396100,0.),
vec3(0.751946,0.453352,0.),
vec3(0.078707,-0.715323,0.),
vec3(-0.075838,-0.529344,0.),
vec3(0.724479,-0.580798,0.),
vec3(0.222999,-0.215125,0.),
vec3(-0.467574,-0.405438,0.),
vec3(-0.248268,-0.814753,0.),
vec3(0.354411,-0.887570,0.),
vec3(0.175817,0.382366,0.),
vec3(0.487472,-0.063082,0.),
vec3(-0.084078,0.898312,0.),
vec3(0.488876,-0.783441,0.),
vec3(0.470016,0.217933,0.),
vec3(-0.696890,-0.549791,0.),
vec3(-0.149693,0.605762,0.),
vec3(0.034211,0.979980,0.),
vec3(0.503098,-0.308878,0.),
vec3(-0.016205,-0.872921,0.),
vec3(0.385784,-0.393902,0.),
vec3(-0.146886,-0.859249,0.),
vec3(0.643361,0.164098,0.),
vec3(0.634388,-0.049471,0.),
vec3(-0.688894,0.007843,0.),
vec3(0.464034,-0.188818,0.),
vec3(-0.440840,0.137486,0.),
vec3(0.364483,0.511704,0.),
vec3(0.034028,0.325968,0.),
vec3(0.099094,-0.308023,0.),
vec3(0.693960,-0.366253,0.),
vec3(0.678884,-0.204688,0.),
vec3(0.001801,0.780328,0.),
vec3(0.145177,-0.898984,0.),
vec3(0.062655,-0.611866,0.),
vec3(0.315226,-0.604297,0.),
vec3(-0.780145,0.486251,0.),
vec3(-0.371868,0.882138,0.),
vec3(0.200476,0.494430,0.),
vec3(-0.494552,-0.711051,0.),
vec3(0.612476,0.705252,0.),
vec3(-0.578845,-0.768792,0.),
vec3(-0.772454,-0.090976,0.),
vec3(0.504440,0.372295,0.),
vec3(0.155736,0.065157,0.),
vec3(0.391522,0.849605,0.),
vec3(-0.620106,-0.328104,0.),
vec3(0.789239,-0.419965,0.),
vec3(-0.545396,0.538133,0.),
vec3(-0.178564,-0.596057,0.)
);
#define inline
float computeShadowWithCSMPCSS(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);float blockerDepth=0.0;float sumBlockerDepth=0.0;float numBlocker=0.0;for (int i=0; i<searchTapCount; i ++) {blockerDepth=texture2D(depthSampler,vec3(uvDepth.xy+(lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse*PoissonSamplers32[i].xy),layer)).r;if (blockerDepth<depthMetric) {sumBlockerDepth+=blockerDepth;numBlocker++;}}
float avgBlockerDepth=sumBlockerDepth/numBlocker;float AAOffset=shadowMapSizeInverse*10.;float penumbraRatio=((depthMetric-avgBlockerDepth)*depthCorrection+AAOffset);vec4 filterRadius=vec4(penumbraRatio*lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse,0.,0.);float random=getRand(vPositionFromLight.xy);float rotationAngle=random*3.1415926;vec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));float shadow=0.;for (int i=0; i<pcfTapCount; i++) {vec4 offset=vec4(poissonSamplers[i],0.);offset=vec4(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.,0.);shadow+=texture2D(shadowSampler,uvDepthLayer+offset*filterRadius);}
shadow/=float(pcfTapCount);shadow=mix(shadow,1.,min((depthMetric-avgBlockerDepth)*depthCorrection*penumbraDarkness,1.));shadow=mix(darkness,1.,shadow);if (numBlocker<1.0) {return 1.0;}
else
{return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
#define inline
float computeShadowWithPCSS(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers)
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;float blockerDepth=0.0;float sumBlockerDepth=0.0;float numBlocker=0.0;for (int i=0; i<searchTapCount; i ++) {blockerDepth=TEXTUREFUNC(depthSampler,uvDepth.xy+(lightSizeUV*shadowMapSizeInverse*PoissonSamplers32[i].xy),0.).r;if (blockerDepth<depthMetric) {sumBlockerDepth+=blockerDepth;numBlocker++;}}
if (numBlocker<1.0) {return 1.0;}
else
{float avgBlockerDepth=sumBlockerDepth/numBlocker;float AAOffset=shadowMapSizeInverse*10.;float penumbraRatio=((depthMetric-avgBlockerDepth)+AAOffset);float filterRadius=penumbraRatio*lightSizeUV*shadowMapSizeInverse;float random=getRand(vPositionFromLight.xy);float rotationAngle=random*3.1415926;vec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));float shadow=0.;for (int i=0; i<pcfTapCount; i++) {vec3 offset=poissonSamplers[i];offset=vec3(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.);shadow+=TEXTUREFUNC(shadowSampler,uvDepth+offset*filterRadius,0.);}
shadow/=float(pcfTapCount);shadow=mix(shadow,1.,depthMetric-avgBlockerDepth);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}}
#define inline
float computeShadowWithPCSS16(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32);}
#define inline
float computeShadowWithPCSS32(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32);}
#define inline
float computeShadowWithPCSS64(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64);}
#define inline
float computeShadowWithCSMPCSS16(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}
#define inline
float computeShadowWithCSMPCSS32(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}
#define inline
float computeShadowWithCSMPCSS64(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}
#endif
#endif
`;g.IncludesShadersStore[E2]||(g.IncludesShadersStore[E2]=vJ)});var T2,SJ,L_=S(()=>{O();T2="imageProcessingFunctions",SJ=`#if defined(COLORGRADING) && !defined(COLORGRADING3D)
/** 
* Polyfill for SAMPLE_TEXTURE_3D,which is unsupported in WebGL.
* sampler3dSetting.x=textureOffset (0.5/textureSize).
* sampler3dSetting.y=textureSize.
*/
#define inline
vec3 sampleTexture3D(sampler2D colorTransform,vec3 color,vec2 sampler3dSetting)
{float sliceSize=2.0*sampler3dSetting.x; 
#ifdef SAMPLER3DGREENDEPTH
float sliceContinuous=(color.g-sampler3dSetting.x)*sampler3dSetting.y;
#else
float sliceContinuous=(color.b-sampler3dSetting.x)*sampler3dSetting.y;
#endif
float sliceInteger=floor(sliceContinuous);float sliceFraction=sliceContinuous-sliceInteger;
#ifdef SAMPLER3DGREENDEPTH
vec2 sliceUV=color.rb;
#else
vec2 sliceUV=color.rg;
#endif
sliceUV.x*=sliceSize;sliceUV.x+=sliceInteger*sliceSize;sliceUV=saturate(sliceUV);vec4 slice0Color=texture2D(colorTransform,sliceUV);sliceUV.x+=sliceSize;sliceUV=saturate(sliceUV);vec4 slice1Color=texture2D(colorTransform,sliceUV);vec3 result=mix(slice0Color.rgb,slice1Color.rgb,sliceFraction);
#ifdef SAMPLER3DBGRMAP
color.rgb=result.rgb;
#else
color.rgb=result.bgr;
#endif
return color;}
#endif
#if TONEMAPPING==3
const float PBRNeutralStartCompression=0.8-0.04;const float PBRNeutralDesaturation=0.15;vec3 PBRNeutralToneMapping( vec3 color ) {float x=min(color.r,min(color.g,color.b));float offset=x<0.08 ? x-6.25*x*x : 0.04;color-=offset;float peak=max(color.r,max(color.g,color.b));if (peak<PBRNeutralStartCompression) return color;float d=1.-PBRNeutralStartCompression;float newPeak=1.-d*d/(peak+d-PBRNeutralStartCompression);color*=newPeak/peak;float g=1.-1./(PBRNeutralDesaturation*(peak-newPeak)+1.);return mix(color,newPeak*vec3(1,1,1),g);}
#endif
#if TONEMAPPING==2
const mat3 ACESInputMat=mat3(
vec3(0.59719,0.07600,0.02840),
vec3(0.35458,0.90834,0.13383),
vec3(0.04823,0.01566,0.83777)
);const mat3 ACESOutputMat=mat3(
vec3( 1.60475,-0.10208,-0.00327),
vec3(-0.53108, 1.10813,-0.07276),
vec3(-0.07367,-0.00605, 1.07602)
);vec3 RRTAndODTFit(vec3 v)
{vec3 a=v*(v+0.0245786)-0.000090537;vec3 b=v*(0.983729*v+0.4329510)+0.238081;return a/b;}
vec3 ACESFitted(vec3 color)
{color=ACESInputMat*color;color=RRTAndODTFit(color);color=ACESOutputMat*color;color=saturate(color);return color;}
#endif
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_DEFINITIONS
vec4 applyImageProcessing(vec4 result) {
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATSTART
#ifdef EXPOSURE
result.rgb*=exposureLinear;
#endif
#ifdef VIGNETTE
vec2 viewportXY=gl_FragCoord.xy*vInverseScreenSize;viewportXY=viewportXY*2.0-1.0;vec3 vignetteXY1=vec3(viewportXY*vignetteSettings1.xy+vignetteSettings1.zw,1.0);float vignetteTerm=dot(vignetteXY1,vignetteXY1);float vignette=pow(vignetteTerm,vignetteSettings2.w);vec3 vignetteColor=vignetteSettings2.rgb;
#ifdef VIGNETTEBLENDMODEMULTIPLY
vec3 vignetteColorMultiplier=mix(vignetteColor,vec3(1,1,1),vignette);result.rgb*=vignetteColorMultiplier;
#endif
#ifdef VIGNETTEBLENDMODEOPAQUE
result.rgb=mix(vignetteColor,result.rgb,vignette);
#endif
#endif
#if TONEMAPPING==3
result.rgb=PBRNeutralToneMapping(result.rgb);
#elif TONEMAPPING==2
result.rgb=ACESFitted(result.rgb);
#elif TONEMAPPING==1
const float tonemappingCalibration=1.590579;result.rgb=1.0-exp2(-tonemappingCalibration*result.rgb);
#endif
result.rgb=toGammaSpace(result.rgb);result.rgb=saturate(result.rgb);
#ifdef CONTRAST
vec3 resultHighContrast=result.rgb*result.rgb*(3.0-2.0*result.rgb);if (contrast<1.0) {result.rgb=mix(vec3(0.5,0.5,0.5),result.rgb,contrast);} else {result.rgb=mix(result.rgb,resultHighContrast,contrast-1.0);}
result.rgb=max(result.rgb,0.);
#endif
#ifdef COLORGRADING
vec3 colorTransformInput=result.rgb*colorTransformSettings.xxx+colorTransformSettings.yyy;
#ifdef COLORGRADING3D
vec3 colorTransformOutput=texture(txColorTransform,colorTransformInput).rgb;
#else
vec3 colorTransformOutput=sampleTexture3D(txColorTransform,colorTransformInput,colorTransformSettings.yz).rgb;
#endif
result.rgb=mix(result.rgb,colorTransformOutput,colorTransformSettings.www);
#endif
#ifdef COLORCURVES
float luma=getLuminance(result.rgb);vec2 curveMix=clamp(vec2(luma*3.0-1.5,luma*-3.0+1.5),vec2(0.0),vec2(1.0));vec4 colorCurve=vCameraColorCurveNeutral+curveMix.x*vCameraColorCurvePositive-curveMix.y*vCameraColorCurveNegative;result.rgb*=colorCurve.rgb;result.rgb=mix(vec3(luma),result.rgb,colorCurve.a);
#endif
#ifdef DITHER
float rand=getRand(gl_FragCoord.xy*vInverseScreenSize);float dither=mix(-ditherIntensity,ditherIntensity,rand);result.rgb=saturate(result.rgb+vec3(dither));
#endif
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATEND
return result;}`;g.IncludesShadersStore[T2]||(g.IncludesShadersStore[T2]=SJ)});var x2,EJ,Eu=S(()=>{O();x2="fogFragmentDeclaration",EJ=`#ifdef FOG
#define FOGMODE_NONE 0.
#define FOGMODE_EXP 1.
#define FOGMODE_EXP2 2.
#define FOGMODE_LINEAR 3.
#define E 2.71828
uniform vec4 vFogInfos;uniform vec3 vFogColor;varying vec3 vFogDistance;float CalcFogFactor()
{float fogCoeff=1.0;float fogStart=vFogInfos.y;float fogEnd=vFogInfos.z;float fogDensity=vFogInfos.w;float fogDistance=length(vFogDistance);if (FOGMODE_LINEAR==vFogInfos.x)
{fogCoeff=(fogEnd-fogDistance)/(fogEnd-fogStart);}
else if (FOGMODE_EXP==vFogInfos.x)
{fogCoeff=1.0/pow(E,fogDistance*fogDensity);}
else if (FOGMODE_EXP2==vFogInfos.x)
{fogCoeff=1.0/pow(E,fogDistance*fogDistance*fogDensity*fogDensity);}
return clamp(fogCoeff,0.0,1.0);}
#endif
`;g.IncludesShadersStore[x2]||(g.IncludesShadersStore[x2]=EJ)});var A2,TJ,R2=S(()=>{O();A2="intersectionFunctions",TJ=`float diskIntersectWithBackFaceCulling(vec3 ro,vec3 rd,vec3 c,float r) {float d=rd.y;if(d>0.0) { return 1e6; }
vec3 o=ro-c;float t=-o.y/d;vec3 q=o+rd*t;return (dot(q,q)<r*r) ? t : 1e6;}
vec2 sphereIntersect(vec3 ro,vec3 rd,vec3 ce,float ra) {vec3 oc=ro-ce;float b=dot(oc,rd);float c=dot(oc,oc)-ra*ra;float h=b*b-c;if(h<0.0) { return vec2(-1.0,-1.0); }
h=sqrt(h);return vec2(-b+h,-b-h);}
vec2 sphereIntersectFromOrigin(vec3 ro,vec3 rd,float ra) {float b=dot(ro,rd);float c=dot(ro,ro)-ra*ra;float h=b*b-c;if(h<0.0) { return vec2(-1.0,-1.0); }
h=sqrt(h);return vec2(-b+h,-b-h);}`;g.IncludesShadersStore[A2]||(g.IncludesShadersStore[A2]=TJ)});var b2,xJ,w_=S(()=>{O();b2="lightFragment",xJ=`#ifdef LIGHT{X}
#if defined(SHADOWONLY) || defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})
#else
vec4 diffuse{X}=light{X}.vLightDiffuse;
#define CUSTOM_LIGHT{X}_COLOR 
#if defined(PBR) && defined(CLUSTLIGHT{X}) && CLUSTLIGHT_BATCH>0
{int sliceIndex=min(getClusteredSliceIndex(light{X}.vSliceData,vViewDepth),CLUSTLIGHT_SLICES-1);info=computeClusteredLighting(
lightDataTexture{X},
tileMaskTexture{X},
light{X}.vLightData,
ivec2(light{X}.vSliceRanges[sliceIndex]),
viewDirectionW,
normalW,
vPositionW,
surfaceAlbedo,
reflectivityOut
#ifdef IRIDESCENCE
,iridescenceIntensity
#endif
#ifdef SS_TRANSLUCENCY
,subSurfaceOut
#endif
#ifdef SPECULARTERM
,AARoughnessFactors.x
#endif
#ifdef ANISOTROPIC
,anisotropicOut
#endif
#ifdef SHEEN
,sheenOut
#endif
#ifdef CLEARCOAT
,clearcoatOut
#endif
);}
#elif defined(PBR)
#ifdef SPOTLIGHT{X}
preInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,vPositionW);
#elif defined(POINTLIGHT{X})
preInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW,vPositionW);
#elif defined(HEMILIGHT{X})
preInfo=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(DIRLIGHT{X})
preInfo=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(AREALIGHT{X}) && defined(AREALIGHTSUPPORTED)
preInfo=computeAreaPreLightingInfo(areaLightsLTC1Sampler,areaLightsLTC2Sampler,viewDirectionW,normalW,vPositionW,light{X}.vLightData,light{X}.vLightWidth.xyz,light{X}.vLightHeight.xyz,roughness);
#endif
preInfo.NdotV=NdotV;
#ifdef SPOTLIGHT{X}
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);
#ifdef IESLIGHTTEXTURE{X}
preInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X});
#else
preInfo.attenuation*=computeDirectionalLightFalloff_GLTF(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#endif
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);
#ifdef IESLIGHTTEXTURE{X}
preInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X});
#else
preInfo.attenuation*=computeDirectionalLightFalloff_Physical(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w);
#endif
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);
#ifdef IESLIGHTTEXTURE{X}
preInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X});
#else
preInfo.attenuation*=computeDirectionalLightFalloff_Standard(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w);
#endif
#else
preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
#ifdef IESLIGHTTEXTURE{X}
preInfo.attenuation*=computeDirectionalLightFalloff_IES(light{X}.vLightDirection.xyz,preInfo.L,iesLightTexture{X});
#else
preInfo.attenuation*=computeDirectionalLightFalloff(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#endif
#endif
#elif defined(POINTLIGHT{X})
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);
#else
preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
#endif
#else
preInfo.attenuation=1.0;
#endif
#if defined(HEMILIGHT{X}) || defined(AREALIGHT{X})
preInfo.roughness=roughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(roughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
preInfo.diffuseRoughness=diffuseRoughness;preInfo.surfaceAlbedo=surfaceAlbedo;
#ifdef IRIDESCENCE
preInfo.iridescenceIntensity=iridescenceIntensity;
#endif
#ifdef SS_TRANSLUCENCY
info.diffuseTransmission=vec3(0.0);
#endif
#ifdef HEMILIGHT{X}
info.diffuse=computeHemisphericDiffuseLighting(preInfo,diffuse{X}.rgb,light{X}.vLightGround);
#elif defined(AREALIGHT{X})
info.diffuse=computeAreaDiffuseLighting(preInfo,diffuse{X}.rgb);
#elif defined(SS_TRANSLUCENCY)
#ifndef SS_TRANSLUCENCY_LEGACY
info.diffuse=computeDiffuseLighting(preInfo,diffuse{X}.rgb)*(1.0-subSurfaceOut.translucencyIntensity);info.diffuseTransmission=computeDiffuseTransmittedLighting(preInfo,diffuse{X}.rgb,subSurfaceOut.transmittance); 
#else
info.diffuse=computeDiffuseTransmittedLighting(preInfo,diffuse{X}.rgb,subSurfaceOut.transmittance);
#endif
#else
info.diffuse=computeDiffuseLighting(preInfo,diffuse{X}.rgb);
#endif
#ifdef SPECULARTERM
#if AREALIGHT{X}
info.specular=computeAreaSpecularLighting(preInfo,light{X}.vLightSpecular.rgb,clearcoatOut.specularEnvironmentR0,reflectivityOut.colorReflectanceF90);
#else
#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)
{vec3 metalFresnel=reflectivityOut.specularWeight*getF82Specular(preInfo.VdotH,clearcoatOut.specularEnvironmentR0,reflectivityOut.colorReflectanceF90,reflectivityOut.roughness);vec3 dielectricFresnel=fresnelSchlickGGX(preInfo.VdotH,reflectivityOut.dielectricColorF0,reflectivityOut.colorReflectanceF90);coloredFresnel=mix(dielectricFresnel,metalFresnel,reflectivityOut.metallic);}
#else
coloredFresnel=fresnelSchlickGGX(preInfo.VdotH,clearcoatOut.specularEnvironmentR0,reflectivityOut.colorReflectanceF90);
#endif
#ifndef LEGACY_SPECULAR_ENERGY_CONSERVATION
{float NdotH=dot(normalW,preInfo.H);vec3 fresnel=fresnelSchlickGGX(NdotH,vec3(reflectanceF0),specularEnvironmentR90);info.diffuse*=(vec3(1.0)-fresnel);}
#endif
#ifdef ANISOTROPIC
info.specular=computeAnisotropicSpecularLighting(preInfo,viewDirectionW,normalW,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,diffuse{X}.rgb);
#else
info.specular=computeSpecularLighting(preInfo,normalW,clearcoatOut.specularEnvironmentR0,coloredFresnel,AARoughnessFactors.x,diffuse{X}.rgb);
#endif
#endif
#endif
#ifndef AREALIGHT{X}
#ifdef SHEEN
#ifdef SHEEN_LINKWITHALBEDO
preInfo.roughness=sheenOut.sheenIntensity;
#else
#ifdef HEMILIGHT{X}
preInfo.roughness=sheenOut.sheenRoughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
#endif
info.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactors.x,diffuse{X}.rgb);
#endif
#ifdef CLEARCOAT
#ifdef HEMILIGHT{X}
preInfo.roughness=clearcoatOut.clearCoatRoughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
info.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,diffuse{X}.rgb);
#ifdef CLEARCOAT_TINT
absorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);info.diffuse*=absorption;
#ifdef SS_TRANSLUCENCY
info.diffuseTransmission*=absorption;
#endif
#ifdef SPECULARTERM
info.specular*=absorption;
#endif
#endif
info.diffuse*=info.clearCoat.w;
#ifdef SS_TRANSLUCENCY
info.diffuseTransmission*=info.clearCoat.w;
#endif
#ifdef SPECULARTERM
info.specular*=info.clearCoat.w;
#endif
#ifdef SHEEN
info.sheen*=info.clearCoat.w;
#endif
#endif
#endif
#else
#ifdef SPOTLIGHT{X}
#ifdef IESLIGHTTEXTURE{X}
info=computeIESSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,diffuse{X}.a,glossiness,iesLightTexture{X});
#else
info=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,diffuse{X}.a,glossiness);
#endif
#elif defined(HEMILIGHT{X})
info=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightGround,glossiness);
#elif defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})
info=computeLighting(viewDirectionW,normalW,light{X}.vLightData,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,diffuse{X}.a,glossiness);
#elif defined(AREALIGHT{X}) && defined(AREALIGHTSUPPORTED)
info=computeAreaLighting(areaLightsLTC1Sampler,areaLightsLTC2Sampler,viewDirectionW,normalW,vPositionW,light{X}.vLightData.xyz,light{X}.vLightWidth.rgb,light{X}.vLightHeight.rgb,diffuse{X}.rgb,light{X}.vLightSpecular.rgb,
#ifdef AREALIGHTNOROUGHTNESS
0.5
#else
vReflectionInfos.y
#endif
);
#elif defined(CLUSTLIGHT{X}) && CLUSTLIGHT_BATCH>0
{int sliceIndex=min(getClusteredSliceIndex(light{X}.vSliceData,vViewDepth),CLUSTLIGHT_SLICES-1);info=computeClusteredLighting(lightDataTexture{X},tileMaskTexture{X},viewDirectionW,normalW,light{X}.vLightData,ivec2(light{X}.vSliceRanges[sliceIndex]),glossiness);}
#endif
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
info.diffuse*=computeProjectionTextureDiffuseLighting(projectionLightTexture{X},textureProjectionMatrix{X},vPositionW);
#endif
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
for (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++)
{
#ifdef SHADOWCSM_RIGHTHANDED{X}
diff{X}=viewFrustumZ{X}[i]+vPositionFromCamera{X}.z;
#else
diff{X}=viewFrustumZ{X}[i]-vPositionFromCamera{X}.z;
#endif
if (diff{X}>=0.) {index{X}=i;break;}}
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
if (index{X}>=0)
#endif
{
#if defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#else
shadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#endif
#else
shadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#ifdef SHADOWCSMDEBUG{X}
shadowDebug{X}=vec3(shadow)*vCascadeColorsMultiplier{X}[index{X}];
#endif
#ifndef SHADOWCSMNOBLEND{X}
float frustumLength=frustumLengths{X}[index{X}];float diffRatio=clamp(diff{X}/frustumLength,0.,1.)*cascadeBlendFactor{X};if (index{X}<(SHADOWCSMNUM_CASCADES{X}-1) && diffRatio<1.)
{index{X}+=1;float nextShadow=0.;
#if defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
nextShadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
nextShadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
nextShadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
nextShadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#elif defined(SHADOWMEDIUMQUALITY{X})
nextShadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#else
nextShadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#endif
#else
nextShadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
shadow=mix(nextShadow,shadow,diffRatio);
#ifdef SHADOWCSMDEBUG{X}
shadowDebug{X}=mix(vec3(nextShadow)*vCascadeColorsMultiplier{X}[index{X}],shadowDebug{X},diffRatio);
#endif
}
#endif
}
#elif defined(SHADOWCLOSEESM{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithCloseESMCube(vPositionW,light{X}.vLightData.xyz,shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);
#else
shadow=computeShadowWithCloseESM(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWESM{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithESMCube(vPositionW,light{X}.vLightData.xyz,shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);
#else
shadow=computeShadowWithESM(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPOISSON{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithPoissonSamplingCube(vPositionW,light{X}.vLightData.xyz,shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.depthValues);
#else
shadow=computeShadowWithPoissonSampling(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithPCF1(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithPCF3(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithPCF5(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithPCSS16(vPositionFromLight{X},vDepthMetric{X},depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithPCSS32(vPositionFromLight{X},vDepthMetric{X},depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithPCSS64(vPositionFromLight{X},vDepthMetric{X},depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#else
#if defined(SHADOWCUBE{X})
shadow=computeShadowCube(vPositionW,light{X}.vLightData.xyz,shadowTexture{X},light{X}.shadowsInfo.x,light{X}.depthValues);
#else
shadow=computeShadow(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#endif
#ifdef SHADOWONLY
#ifndef SHADOWINUSE
#define SHADOWINUSE
#endif
globalShadow+=shadow;shadowLightCount+=1.0;
#endif
#else
shadow=1.;
#endif
aggShadow+=shadow;numLights+=1.0;
#ifndef SHADOWONLY
#ifdef CUSTOMUSERLIGHTING
diffuseBase+=computeCustomDiffuseLighting(info,diffuseBase,shadow);
#ifdef SPECULARTERM
specularBase+=computeCustomSpecularLighting(info,specularBase,shadow);
#endif
#elif defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})
diffuseBase+=lightmapColor.rgb*shadow;
#ifdef SPECULARTERM
#ifndef LIGHTMAPNOSPECULAR{X}
specularBase+=info.specular*shadow*lightmapColor.rgb;
#endif
#endif
#ifdef CLEARCOAT
#ifndef LIGHTMAPNOSPECULAR{X}
clearCoatBase+=info.clearCoat.rgb*shadow*lightmapColor.rgb;
#endif
#endif
#ifdef SHEEN
#ifndef LIGHTMAPNOSPECULAR{X}
sheenBase+=info.sheen.rgb*shadow;
#endif
#endif
#else
#ifdef SHADOWCSMDEBUG{X}
diffuseBase+=info.diffuse*shadowDebug{X};
#else
diffuseBase+=info.diffuse*shadow;
#endif
#ifdef SS_TRANSLUCENCY
diffuseTransmissionBase+=info.diffuseTransmission*shadow;
#endif
#ifdef SPECULARTERM
specularBase+=info.specular*shadow;
#endif
#ifdef CLEARCOAT
clearCoatBase+=info.clearCoat.rgb*shadow;
#endif
#ifdef SHEEN
sheenBase+=info.sheen.rgb*shadow;
#endif
#endif
#endif
#endif
`;g.IncludesShadersStore[b2]||(g.IncludesShadersStore[b2]=xJ)});var C2,AJ,Tu=S(()=>{O();C2="logDepthFragment",AJ=`#ifdef LOGARITHMICDEPTH
gl_FragDepthEXT=log2(vFragmentDepth)*logarithmicDepthConstant*0.5;
#endif
`;g.IncludesShadersStore[C2]||(g.IncludesShadersStore[C2]=AJ)});var I2,RJ,xu=S(()=>{O();I2="fogFragment",RJ=`#ifdef FOG
float fog=CalcFogFactor();
#ifdef PBR
fog=toLinearSpace(fog);
#endif
color.rgb=mix(vFogColor,color.rgb,fog);
#endif
`;g.IncludesShadersStore[I2]||(g.IncludesShadersStore[I2]=RJ)});var M2={};V(M2,{backgroundPixelShader:()=>bJ});var kC,y2,bJ,P2=S(()=>{O();u2();NC();Di();y_();M_();P_();D_();VC();O_();L_();Xa();Da();Eu();R2();Oa();w_();Tu();xu();kC="backgroundPixelShader",y2=`#ifdef TEXTURELODSUPPORT
#extension GL_EXT_shader_texture_lod : enable
#endif
precision highp float;
#include<__decl__backgroundFragment>
#include<helperFunctions>
varying vec3 vPositionW;
#ifdef MAINUV1
varying vec2 vMainUV1;
#endif 
#ifdef MAINUV2 
varying vec2 vMainUV2; 
#endif 
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#ifdef DIFFUSE
#if DIFFUSEDIRECTUV==1
#define vDiffuseUV vMainUV1
#elif DIFFUSEDIRECTUV==2
#define vDiffuseUV vMainUV2
#else
varying vec2 vDiffuseUV;
#endif
uniform sampler2D diffuseSampler;
#endif
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
#define sampleReflection(s,c) textureCube(s,c)
uniform samplerCube reflectionSampler;
#ifdef TEXTURELODSUPPORT
#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;
#endif
#else
#define sampleReflection(s,c) texture2D(s,c)
uniform sampler2D reflectionSampler;
#ifdef TEXTURELODSUPPORT
#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#include<reflectionFunction>
#endif
#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE;
#endif
#ifndef SHADOWONLY
#define SHADOWONLY;
#endif
#include<imageProcessingDeclaration>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<lightsFragmentFunctions>
#include<shadowsFragmentFunctions>
#include<imageProcessingFunctions>
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#include<logDepthDeclaration>
#include<clipPlaneFragmentDeclaration>
#include<fogFragmentDeclaration>
#ifdef REFLECTIONFRESNEL
#define FRESNEL_MAXIMUM_ON_ROUGH 0.25
vec3 fresnelSchlickEnvironmentGGX(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)
{float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}
#endif
#ifdef PROJECTED_GROUND
#include<intersectionFunctions>
vec3 project(vec3 viewDirectionW,vec3 eyePosition) {float radius=projectedGroundInfos.x;float height=projectedGroundInfos.y;vec3 camDir=-viewDirectionW;float skySphereDistance=sphereIntersectFromOrigin(eyePosition,camDir,radius).x;vec3 skySpherePositionW=eyePosition+camDir*skySphereDistance;vec3 p=normalize(skySpherePositionW);eyePosition.y-=height;float sIntersection=sphereIntersectFromOrigin(eyePosition,p,radius).x;vec3 h=vec3(0.0,-height,0.0);float dIntersection=diskIntersectWithBackFaceCulling(eyePosition,p,h,radius);p=(eyePosition+min(sIntersection,dIntersection)*p);return p;}
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=vec3(0.0,1.0,0.0);
#endif
float shadow=1.;float globalShadow=0.;float shadowLightCount=0.;float aggShadow=0.;float numLights=0.;
#include<lightFragment>[0..maxSimultaneousLights]
#ifdef SHADOWINUSE
globalShadow/=shadowLightCount;
#else
globalShadow=1.0;
#endif
#ifndef BACKMAT_SHADOWONLY
vec4 reflectionColor=vec4(1.,1.,1.,1.);
#ifdef REFLECTION
#ifdef PROJECTED_GROUND
vec3 reflectionVector=project(viewDirectionW,vEyePosition.xyz);reflectionVector=vec3(reflectionMatrix*vec4(reflectionVector,1.));
#else
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords=reflectionVector;
#else
vec2 reflectionCoords=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
#ifdef REFLECTIONBLUR
float reflectionLOD=vReflectionInfos.y;
#ifdef TEXTURELODSUPPORT
reflectionLOD=reflectionLOD*log2(vReflectionMicrosurfaceInfos.x)*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;reflectionColor=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);
#else
float lodReflectionNormalized=saturate(reflectionLOD);float lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;vec4 reflectionSpecularMid=sampleReflection(reflectionSampler,reflectionCoords);if(lodReflectionNormalizedDoubled<1.0){reflectionColor=mix(
sampleReflection(reflectionSamplerHigh,reflectionCoords),
reflectionSpecularMid,
lodReflectionNormalizedDoubled
);} else {reflectionColor=mix(
reflectionSpecularMid,
sampleReflection(reflectionSamplerLow,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);}
#endif
#else
vec4 reflectionSample=sampleReflection(reflectionSampler,reflectionCoords);reflectionColor=reflectionSample;
#endif
#ifdef RGBDREFLECTION
reflectionColor.rgb=fromRGBD(reflectionColor);
#endif
#ifdef GAMMAREFLECTION
reflectionColor.rgb=toLinearSpace(reflectionColor.rgb);
#endif
#ifdef REFLECTIONBGR
reflectionColor.rgb=reflectionColor.bgr;
#endif
reflectionColor.rgb*=vReflectionInfos.x;
#endif
vec3 diffuseColor=vec3(1.,1.,1.);float finalAlpha=alpha;
#ifdef DIFFUSE
vec4 diffuseMap=texture2D(diffuseSampler,vDiffuseUV);
#ifdef GAMMADIFFUSE
diffuseMap.rgb=toLinearSpace(diffuseMap.rgb);
#endif
diffuseMap.rgb*=vDiffuseInfos.y;
#ifdef DIFFUSEHASALPHA
finalAlpha*=diffuseMap.a;
#endif
diffuseColor=diffuseMap.rgb;
#endif
#ifdef REFLECTIONFRESNEL
vec3 colorBase=diffuseColor;
#else
vec3 colorBase=reflectionColor.rgb*diffuseColor;
#endif
colorBase=max(colorBase,0.0);
#ifdef USERGBCOLOR
vec3 finalColor=colorBase;
#else
#ifdef USEHIGHLIGHTANDSHADOWCOLORS
vec3 mainColor=mix(vPrimaryColorShadow.rgb,vPrimaryColor.rgb,colorBase);
#else
vec3 mainColor=vPrimaryColor.rgb;
#endif
vec3 finalColor=colorBase*mainColor;
#endif
#ifdef REFLECTIONFRESNEL
vec3 reflectionAmount=vReflectionControl.xxx;vec3 reflectionReflectance0=vReflectionControl.yyy;vec3 reflectionReflectance90=vReflectionControl.zzz;float VdotN=dot(normalize(vEyePosition.xyz),normalW);vec3 planarReflectionFresnel=fresnelSchlickEnvironmentGGX(saturate(VdotN),reflectionReflectance0,reflectionReflectance90,1.0);reflectionAmount*=planarReflectionFresnel;
#ifdef REFLECTIONFALLOFF
float reflectionDistanceFalloff=1.0-saturate(length(vPositionW.xyz-vBackgroundCenter)*vReflectionControl.w);reflectionDistanceFalloff*=reflectionDistanceFalloff;reflectionAmount*=reflectionDistanceFalloff;
#endif
finalColor=mix(finalColor,reflectionColor.rgb,saturate(reflectionAmount));
#endif
#ifdef OPACITYFRESNEL
float viewAngleToFloor=dot(normalW,normalize(vEyePosition.xyz-vBackgroundCenter));const float startAngle=0.1;float fadeFactor=saturate(viewAngleToFloor/startAngle);finalAlpha*=fadeFactor*fadeFactor;
#endif
#ifdef SHADOWINUSE
finalColor=mix(finalColor*shadowLevel,finalColor,globalShadow);
#endif
vec4 color=vec4(finalColor,finalAlpha);
#else
vec4 color=vec4(vPrimaryColor.rgb,(1.0-clamp(globalShadow,0.,1.))*alpha);
#endif
#include<logDepthFragment>
#include<fogFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS
#if !defined(SKIPFINALCOLORCLAMP)
color.rgb=clamp(color.rgb,0.,30.0);
#endif
#else
color=applyImageProcessing(color);
#endif
#ifdef PREMULTIPLYALPHA
color.rgb*=color.a;
#endif
#ifdef NOISE
color.rgb+=dither(vPositionW.xy,0.5);color=max(color,0.0);
#endif
gl_FragColor=color;
#define CUSTOM_FRAGMENT_MAIN_END
}
`;g.ShadersStore[kC]||(g.ShadersStore[kC]=y2);bJ={name:kC,shader:y2}});var CJ,IJ,F_,HC=S(()=>{Ut();Cb();CJ="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAgAElEQVR42u29yY5tWXIlZnbuiSaTbZFUkZRKrCKhElASQA0EoQABgn6hJvoXzfUP+gP9hWb6Bg00IgRoQJaKqUxmZmTEe8/v0uB2u7Fm2T7HIyIrnz88uPvt3f2a2WrMbOvf/u3PvvzP/sUf/N6//i8vf/lv/3v5H//d//Sb//Uq/5u8yf8hV/m/5Cp/L1f5hVzlG7nKJ7mKyJuIXN/hPwqXI/g++zq6rPI5u8z+WqfLre+zy7PrVv9L8brsMiGvk8XLmM/sdfHXal4e3ad6GXPdyu2ij8u/+uv/5cuf/OSLfdtEfvUr+dnf/d0X//t3H/7bf/hP//N/928h/0Yg/4VA/kogfyGQP5Wr/IFAvhbIlwK5CGQTPP+9z5uPeePJSW+yo2+s/GtN30Rnv1E+f5zxof9R/lSXv/nr//mrr3+i+5dfyX7ZZQP07Tffys//8R/l/9TtX7790T/7r/8G8pdy+/8XAvnnAvkzgfwzgfyxQP5AIL8vkJ8K5KsmMVzu1U7p5PA5AXxOAJ8TwPf7sX/51ZeXfcemqnp9w/W77/S7X/6T/vzf/7383RWCX3/z05/9i3/13/0PX//eX/2FyP8tIv+PiPy9iPy/IvIzEfm5iPxCRH4lIt/c/393//9BRD6KyKf7f488fP74/PH544dJAF9cLl98IZfLBZtuqterXr/7Dt9982v95S9+Lv+gF/3i7Spv/8lf/vnf/vGf/dF/JfKnIvLnIvLvReQ/NEngn0TklyLy6/v/34jIt00iGJOBlxAsdvv54/PH5493SQCXy9t2ueh2ueimKorrFbjq9eNH+fDtb+TXv/ol/vHyhX4Fxfbx7euPf/Lnf/PfiPyeiPyhiPxxkwB+fk8AvxzQgJcIrGTwFsiAEXH4/PH54/PHUgLY7whgu2C7bLqpQgHB2xvePn6SDx8+6G9+84384vKF/IPu8iVU9Y/+7C/+jWxffiHytYj8VER+X0T+oEEBvxqQwCMJeIngo5EI3goIwVMIPn98/vj8ESaAbbtu2ybbvl8u2ybbdtluSECA65u8ffqIDx8+6G++/VZ/efkV/sO261dQXP7wT/7kX8vl8qXIFyLylbySwe/dE0CLAr65B/9vGn0gQwRMMqgmhM/J4fPH548eAezbZd/lsm3YtssNAYiqiogAAkCvb5/k46cP8u2HD/rrb7+R/2/b9Wu9yJe//8d/9Ney6S5yEZFdRL68/38khG/uKOCnAwoYkcCoEXwkEgGDDq7CeQfyOTl8/vhd1QCum26ybZtu2yabbrKpQvXue1yvuF6v+vbpTT5+/CDffviAX1++1V9sO77WXb/66R/+4V/dgkbllQi+aBLBV/dE8LWRALwkYCWCNyMZXElkwLTMeMkga/P4/PH547ccAVwuctkvdxSw6bbdtYDbTfSZBN7e8PHTR/3u4wf55vKd/nL7DX6mu3791U9//5+/gkNFZGuSgZUQvnKowKgLWLTAQgRtEniTuEfwaELw0MJvf3LQzynud+53uG+X6y3gN9kul+2y6XVT1U27JCDAFVc8ksAn/e7jR/nN5YP+avtWfq6Xy9f7Vz/9w1dgRYngiyYhfNkkgzYBWHTg44AEMmqQUYQKOmDaiCIa8TmsfmzB+DnZDQjgcpGLbti2y3bZHjRAdRMVvb/dcYU8kcDbPQlsH/CrbddfbF98+RPZfvLFnAQeieCRDC5DMvju/vmD4JkEvjRQgKULeGggowdHkAHTYxihg89vu88I5UeGAPSOAFTlrgPopiqbKPSmCKreUoAAkCcSePukHz590m8vH+WbD9/JP335k6/+tA86KxFchv8jMvhiogE4JQm8XhfKqOAqx5qRPyeGzx8/cgSwbXcUoLJtim27C4Oi93+4v6VxQwKAvl2v+Hj9pB8+fZJvt4/yzfbF9lPdv/wJnsE2BogmyeCRED40tGFvksIXiSbgiYSRRpDNDZ6BDI6ghM+J4fPHeyKAO+zX7cb9t4tedMMNAQju5V+f1uAtBSiu1zsduMrHy5t8ePsk3376KN98sX/xE5FPAnm7/782o0DiUINXMkCXCB7/P94/e87AWUmARQWVvgMuKej9t1RLBp+Tw+ePgwngsutFFdu26WXbbl+rSvdfbnqAiuA23QcBgCugV1zl7e1NPm5v+LC96XfbJ/1W9y++fgXjA3bDYXV+MuhRwSPwL3JLMFYC+HS/LU8HYrGwIhwyNOF12SvgM4SgztdifP85MXz+KGsA2C6X7aJ6bXSAOwrY5OYIqGy3d5uq4P5GhABXuV6veLvRAf10fZMPb2/y3b7vX7+g+9v98/WOBq7GG7RNAlYy+Dgkhhb+Xxp0sE8IAC4SGAP/TbgVJK/PoJPBnAiwPKxsXfbbnRg+i3s/JAK4Q/4b9NfLtomBAqCickMBjy7BuywAUVyv8na94tMjCVzf9KNcLl/0SeA6oAEYb1i9g+FtSALb/bKL8/+t+wxXFMyswqiHoK4ToIgKqslgpg1qUC0QoYbvJZg/B/q5v4szHmPX7YEAsD0CX25OwEUVm9xag1+agKg+nxQArnKjAtDr9U0+Xd/k4/UqH7bL5YsewrcBBiMJZPRAp6TwQgWfjM9vgRbgUYGL8AvLWH2gqhesCokeUmCSwPsnhs8fP2YNYMO2XeSmAWxy2VQaXeDmDIhApf33rD4PTUCuV+DtCn27XuXT5ir8VmCJ2G5BpBM8/r/dEcJb8/0lEQMtJHA5TAlqNuLRhJChhEpSqFabH3di+G1AGj+W1/dyAR4IYJNNnuLf6+tWC9CHHiAtFhAIFLjK2/Uqn65X+SS67aK+3QeTDoy/IG2ogQ7fb/dAtz5vBgrYGqrwNtCHsVfgIvwK07OTQBURVNCBFpKCOjqCHn5L/67TgTN+fpySAC56nwSUi256kXsSuFGAVyLoUIDo8/Pz7fdoErr/v17lk162HbgHvFpIYDfoAJJfW4sGPjkU4VNAF8ZEcLmLhdc7kljdY1y1Dq9yLiI4IiRqcLujb138KIPn80ejATwRwIbtBvn1cqv+2J78/5EI5N4cJA8qIPcmwRsKAHDF9WYP6mV7VmrgLuTpxYTcMEW0LAmoQxFsuvAI8tv/a/C5fV2ZMMiKg++FCM7RDPRu8ebWY7VG6VJi+Bzk35MI2LsAckMAgwvQ0gC5DQjd3ABg2HQLAPpEAlZ1Bu7VV7MGHDFRAbo3VKsTbAY9sPWC/uvx86gBbDK3D1eEQS8pbAeSgSwmhepnJb6uBv/o/PzHLzxWA/X7TH77De5j6AGQi6o0CUGfCOD2X7cXAlCFQABtEsGLDtxuOyQB2UTQBKZe5GUPXgkUYCUAbZJRhBDeuq8xBf+bgwbehDm+BFQi2IJksOocvA8ysIMfxluVcRsY/eB3JzH8GFDAXQO48X/dcIf9jyDHptIigDsFkEe066tBSETQUYF7ElDdYEBytN4+rk9UcBPfrKaZqFHWcw3i4J8/X4ev2//bSXqAhwTay6OEIPLD2Ipt8OtAGzxkwLw9WVFRjTc/qC6H3+YK/b1oAA0KuOizHfieCLaHHiAb5NYTIC9EMEbZrVEQt1xwhVy1UfBh8PUOquMizwaap3tQXfY5B//tea/NZdfhsvbz+PURQTDSGWB87VX/7WSd4KxjUqrIgE0IUkoKGnhIvwvawpGf6eECXJ7tv4qbA7DJgwpsKthEmmYgfaAAffYF3HLxo0vwNjJ0SwRWMG4db4eh1gPNm18vQ+us/0eGmxDemu/fnM/X4evq/8342ksGHgLY5LyT/zg0wM8lcMjgGFXwqIOVFJBQw99eCvF9oZL9Mfl3QwAvIXDsBRC9R+fz8x0FPBLB0xJEpwUobrfAkARgIAF41h3wQgP6QAmX5E/7eI43IxGwwf/moIkRyWRJQIPgt9CA9b39nzt4bYUWjAlCjWDPgv8IEjgLJfzuaAsrv9VdVG4OwOXW/fdoA35qAdL0BDwvf6AAUVHd8LIEu94A3K+Q+2YxaB84MOH62P//qoo38fCRDERE2zf0JfmDa+MieElAjcDPKz+mRKCOtdgGtXaBjgNJ4H2owSpNeAW/rRH4CaHSpMwnBYYycjgSJwfie9CR6mPu20Uv8kABF206AvXlBMiIBPSlB9wjBW1fwEuSb94296VCqgMaGCt/G1BbExi3IG+r3a3J6P48Gv/J0YmEYoiGY7V/SxwFCwGoE/xa0AJ0CEiV9QPCJb1OJ5F1VTjEY2/MO9AEJvj1BJTQpqLfTlGwjABuzT962e4IoKnyrdh3+/6mzDVJ4PHOxj0JqGKoy20+wBMN6D1gLWi9NQHfVP5MEEPzjGYy8BMAOnTAJgEr8HUIejRo5xrA5xkR5AngmiSHs+zDDAmMgWzTg55GSJEmHE8IvWPAoYTfhWak/Wn/bQ0CGLSAjv83SUEfKp5q24LXuQICpzrjrgWoza8xVE00CQCORdhMJuTUT/rjuls0gO4Iby8BIEgK6gS7BsGuTtDrScH/fR68biUHNVGBnxjeNyHEvQe/ve3LZQqgG3rof6cEclsNflG9J4KtaQ8WHcVBHS1BtHE4QP9OBMS98mpbKTeDW7dJwRsnHpMBTFJpV4I+b0kY/NqInVFSyBLANbnMSgBM8F+Fqfxq/h657/Up+GaBnwV9hRqc9bZ/vA6vu+T9E8KPJWns94UfTeCj2QXwCHS9dNL8Xf3Ho/rfewSeFODGDV69AU0y6NFAE1DP3qK++rdB7/1HRxf86gT376zOr99T/h/ioBiXWQkgQgVeIrCC/WomhDmQK+hASI2ARQZKooHMLdCJwGEBBXC3+uERwg+VOHZ9ioAt9H80AI06wGgJ3nQA3BoCut6AhxYwgcPOFnxuFnrphk+NIKIGrWPQtgz3b0i7Y6D5rs1GKqTop0nQX52vmQC4BkjA+r4a7Kx9WLENGeegkhSETBCrNXIMdi/444Rw1n6E96ry7OPuj8UfLxtQ78NA2iSBbg7gIiIbdDLsb5agPhLC3RkYKv8NDbS2YGsatNRAG2oQwf9ZIOydgy1MAzBkAw8UwEEIDzSAqdPQ6za0PkeJAMH3Z0wXniUSZoHvBXU2mcjQgv56TedIKglCpIoQfgwCIjOytd8WgN0bfxoR8Fn9Gx0Aj5Zgq0lIZbsH/ibSJoFnS+C98g9ooHEELI3gliy25yONIiE6pb0NfBlyNEYyENoodkKwgl6I6s8kARgJ4ZoEfuYWHLEJa0LhSBXm7kImGeSfVdoJ1DO2G7WXsehAptupSOoyrCSF904k+6vt98X/ZcM98Hsd4JYIXhQAIg3/f9AAUYhsLQKAtkHVBnzjCKhOoYl2ym+iBtvzDzQ2DLXJ4PUmbJHAVnBQX4jkxfvHhNDqAdHXGQJgv0aSDGItgOseHIU+K9hXnIJzkoGlEKzNHagTdJ6VWEUH4iCKH4fd2AwDPaYBm4Wgng4gQ9V/CoGiuNmD04AQtNGMGzSAAQ2I2pzfogY9LRh7BrbOh4+D30sAencljFu2CUFrwY8UAWRfWwGvVOVfbx2uIILM0pwDv082dUTw8hYs8L+uIWiHGpWgClnAa1lMPJogovvvbePPs/q3Xr++kgCsfgB5oQF9WYKPJqEn6G+OE3i5AqouF59FQOmahQC8rlPLj38kg1c2f30vw+XaoIX24/pMGIgSBoZqoH3wo0sIIGlA9PWcCPrAtpPB8eBf6x1o6cHra+2+tpIFP4PgBfxZtZUJfo4qxELT948D9ucK8Mt9+ccjIQw6QJcEbrD/1g340ATuDgDkFfx6twSf1f9xvuBECYxq/7ythQQGm+5JDx6Brw4CkMGT3wgscCUoQ4sU2t6DR2ciBjTgtcpenQoZVX9NuL4Owc+dVaDursYVkVALX+shjSBKBuvCYDUZjE5BdNkxdHAUBexyHwB6NP7Iyw7sxUDViwge1t+mz8B/LAvVx/c3PeBBCToB8IUGOgqA3iV4yUg6UAOxaUFHDx6CYS8SorMOue0CCJGAf5YfRhoAI+A1CvwxqNkAY5yAIx2EQmkFfeWOXi+nEdSQQA0ZHMEItiagJArQxDXIrj8nCfQi4HZPAttrIahso9oPQ/2/JwV5JQU8zw+7I4D7/sBn4EO6rjw0FR+i3Z9fHtahzsFvJgM0X+tmVH5vaYiNDGAigewAz+gyNLThnjCURQFR1b9d3lZvnVqmj9mEPDKIUIC4KCCjBXywS4N+otp/Hk3QVthOkwEKlV9PQwXjT7s/zwF4Qf9toAAzFdjuaEB6S7D1//U5FIQu2MevO0rQQH8ZmoXE6B/IkgE60XCjVoq8gt2iCG0S8L5GdxkM1cGsfsCMArSCAnrr7dzAZxCEEpepvB8tqHJ/q+bmJGGts/AcAXFOMMeTwC7Pw0B6CtCtA2vWgonqBQJFSwH0JQK29OB2kvgj2HHXAoyeAIsCQO0kMNECAhFMqCBf8mElAkyBbX1tJQP2RJ/ha0gpAfS9l+/5n00CkrQpq0MZbOdAuxmMvHswog62jZj7BnYQe19b14kxNq2D/ehX/p68HEcF+x3yP7z/V/A/q/5DA3i5A/dzA5pdgbKp3v3/wQF4Bb70WkCTHGRAA6+KL0bFl6FJaFw0ImZwm6igSwbbwPn9RMBWf3sN2JgA/BVh/Rg0kQBgePf6HglAHLFQwqQQOwDjbdVxNZjR4iM6Qa3WxwvNxh0JFb3g/WzFQQS8b/ttKcDWoABtUMAd8j9hf0MB2uDXhzX4CHj03L9DBU3Qjz0C0l4mLSLQPicOOwZoVCB6P6dA7nDbGkVuxcNr8PU2JQO4wX5trEqmccZaHU4q8oCDFOpzAnOwqyMIMktNNNAHouDGxO37DgArQZzlmp/14W1QlqHTMaIIx7SCx0+5yza7AKJ3IXBrNAHVDcMZAU/BT/vgv/ULPOA+XiLggAREDF2g0ci6xNDRglegd7P7TWWH5oJfayliEg7bScQRBVgI4Ookg/F6rvpLWP29swREqA3CaG8/FpKqS8DTAV4TiBqIqtxfzaQRLys5I0XEFIFrPbZRQb+16Fgi2LvJv8EFUPW1gGfQv1T/F/d/HBnccP7rAwnIIyHI4ArgWeGbU4eHy6Tx/EeTZIb5bo/BsMBjmjBE08f/RB0PHYBd9eVRAGY7cHRwiBf8WeCPHY1bgBTa9xKTELzEkQX9CPtl0gJiqsAmCT7I8xbjivh3JGFI+D2nBcSJQJ8agDX+O9iBL7UfG4bzAkcaICrbtYHz1ycSmGmAjJfL3CMgT3tQpmrfB7gxSzC1DnvdhQMieG47u75+kTouKNkM8c/+vq/Q7ZYjO/hhVvRq8F/9gGfhP8aqE9EIdR6LTwJ1h0BItyDqB8iFwuNqASscRnYioxOg9ApvnYA35f8e9Ohbfe8J4rknoFkO0lmA2gmAG0YK0DkB4ieEjiLoMD8wBzom27ANZkzIoU8EMHk/uo1mzeVoEoRWKn8L/62EYAX/lsB7D/LXg74uAMr9oGivJ0CNJCGD6i9DhZdQF+gtOp4S+NODRzsDVbhdgv4BqTMNyIL9SCKwL9/FGPp5oQKxIf8A/UX6r231H7YIqLML0Ae2GtrADOvRQH5b/MPE9dt9BGLNG8jVTAQvIaK5TtvvvWQgDvyXIClUA78S9Nfg7VtIBlO7cbsEYkQDMot+ygQ7QwmOawTHnAM2XUSnJvPIYRYMmYPS+sv3J+cfP3d04JYIXsF/EwMbBKB9Q9AY+BiSwFj9mzrSXmcJhFPVHySTbgHJCPvRQ/z7G/SVUETsg0ZF+i3CRoCjhf7y1A9mOiDD7TwdwEoEXjLwAv+avLE2B7Jnb+OqDpBoAchoQJskxKnss0vu7Q2YhcDv4ySeLOg9GsCKiUIihP7yfW7zbTsBh0TQfN0iAWn9f72Z56/Ax9P7j5OAH/Qvv3/QxKfk0DgDuP+R3USg3bzBC7bO/QT9Eeh9QvDPG7glBQzJwK740lAFFgFk8P88CqDGAa223YckWYhr+c0BPdwetl2ocnsfzePAWcVnnAIp6gDVhDLyfV4nqFEDPxHsbWD3k4BDkN+pARqKMLYBPzYEvxp9xmCHQQdgWH/9EtH2TIFpu3AH/cdGydv1j0TQbRrq+D/mLcX3ZACZ15bF378CG0My6Kq/zoGOQwhASDFwFbxyNGBuSxbCEhQ/uEPe/6gAERWQObCVVfjPpQX+rexxYhYFxIkgpgX7Y/vPs+Pvxf9vwt8kAs7i32t3QCP+3SPaTwIytQXP38u0PESm+YER+o9B3vr8mETAUfDrEkPI80ck0FZ0dXh9U+HRbhey0cAc2H7A4y4egoD6y8JfkBiigLdFP8v2W00E8deT2IeAKujZ/QAVKpAtKI20gLWksHedfgPcb+0+NEHefd9vB9rayi8h7J91gBbaw20MsnWAF5xHkyDUCOoXp+yrOwwxcKj0aL6fFppaaKDv6OpHR5sgx5BAlK/+fYhuP1D196o8e7lFBaKqv5YIMnFQpd0FGVR35RJCnCDaABaXBtgbiSwtICMtalKC+1JQ6bx/PLcDPQL91QFodQNKpwOgF/9eqcBxBBqRcKAAVk+ArQOMx1RYGgB6naDhlK+uQQwJYx4meQbxtNnYQwMjt/d4f3M9ZE4UOld1LAh99fbfzOxiEkKFCkTJIUIMUeVnJ/9sDt8/e1NEJOi9oVHDGYhgnSLss9DX2IAqw1zALUncKcDr0FB5NP+0cBQNrEezDiyiADPkt9qGpwoPdL0AGPx/NOKeyf3b9WJNdfcFv6bKd2cLMJVfJ6Y3B6wB9WFUfWWEwKMfGiQL+3bz9XGQz2EHKhF41GCtZyDi/gUCsNhYoAr3UNJ58YidHKqnMb/6AB5J4N73/4L+t7mAkeeP3P+1LNSB/l0SkMEd8DcEuUlguEw6t2AU/PCE/q++Akw6QFf1u6SBrj1ZnnhG50AfkoGIdf7gJv1KcSfgzWWkQ9U33Z3tHXYASKJ9e/YhU90rvD+q9Ej69/wxYJVs506Eg/r3DkMDzEdDBRGgcZay49XihLA30P+l8N+hf1f57/0AoxbQbwYaan/rBMirE9Dk+sBzTkC8JNDEUlv5McB8PP19Y01Gayep+hC/2zvQ/2HGLAurowsNGlA1cnqGGzeH5weiYLZm7h3QQC4O2tXdhvMMk1ZS5ebpgI8eMrPvPGkwaxayk8Yc6PMOBPEdC1XZ+2UfbfOPtxLMQQAG9BcZFoF0gp/RKjxe7+oAw9T7ZPWhgedodgz0gf5KBtrtIZhQAZpAV1Bi36w6t98qVfH7hqGI318lLCjLCUFlxRHwqYEH9a2qb4XjWvDT7kBwfbZA5P0+PNuRuW1yf4yNQH3zzwv6b70QOJ0G9OT/dhoYRUGT15uQH/71MjQLtQlxfDuiCXrtM+SkA+icQdH6sU/xz7Ze7FlubV4TpoTQ2osdpaEjtqADmEU7OkBEFoLeC3IWFFeswJXKXzkboNL+wzcFHU8hTGKIboO7CLi1/P+5F+gydQhuvRbwEgxvtACmANikhLTbj0gCYk8KdlYgmj+4Ymaod7TwahwadICuX0Cm2fE5iNHPK0x/CDV66Kyg1MnqjNFBnhBoLQCgUULfaVe5nq/6EQWY67bXCszUb+7232fVPz51iGB12owK9peyP1T4raMFF/OEYJP792mgXYfZ04GHMAhBkCSmSj+dKqRPgVFGHbpLEGMiGFeQWfSgrY52VxaeDUPSNJI0P7NoisG729HHl78z6hxfs9rV3m4JjgM/lsui2qmThjCfDFSb+I9vwUqG5wwL55U7C+6ot8B+7N2o6r3q37T9trfpjgmTvv7PSQATLLeRAOZhIJHBQfDQQJPBdUwEbVW3+L08EcEE/9G4ANrCeWcnPKRHDupbNynMx5AA9IRYLmrc/YLSiD5EaEBS/s/TgnU9ILcH19n+CpHwegLejx7Mn/d25fdN+e9U/1vgb7bqf08MOtf8EXxaoh+GY8L6gDfhvs4i6HQ7seYI2sv1GchdMsBIG3xlvxcCRzdgCPTn+6q/TW00VE8Q9FaFv+R2VlOM1vm/hhjhDCdgNflVKME5B47I9xT8z0YgPAJ8myb/LqHy36j/Mwqw9AALxuO1JVjiuQAYLcFzIhiEPe05fk8tRjGw7yWQbsfuLAT2VqOId1osnr0F49VM8INACPHDoBz4B5mqqSnUgyh3ArjXxfQH5BbgUS8gP7aU+w0zHD9GGD0CGHf+P1p/DeivlhU4BbxR9a2kYFR58YaDZCUR2P0DMmgED2eg77puegy6PgDphEB0CwlG/i9d+/Hs34pBEQrBn0W51mqGnJAk3ACCHeiqkQ1XFQA5AlKH7Lk8yJKWY3/nym14h2C3JvxeMwD9ZVMz0BPMi1n1RbKl1cYhIVblF3G0ATsRiCMUvoK9//OgcwYMoe+ZKOLlC6/Xk50br9NFz9fanqA8UIYSpCwlBO4kHc4WLLBfBHVaKwKgLQjmP4Un61Vq+3s7Bsyi0WztmLjJwJwFeE0I2vD/1Q6MVwefxfUf32skCPbCnxQqf+QMPEUDHZ7vGeyj020JgkPXXwsldA7SYR1RE3h94NvNtugswcgxXEkIcBPCGZ1rmrgDC0A4K88nm2fn/eTnpQtWyZfybRoK8Dro4zYDIMGsf7saTBzvX0SMbkAD6o9CYbsfMK38cJKD9l2FJt9/VGs0h5Gib33pxMKWNsigFUh3G2un+/N1WUglI/EEx8fq27vUNnwsiOoKecL7kQS8VnWAGCFUgn6dBtQhv40CmIYggwK0uwDHRGAuBXVdfwzHUjZzATLMAoyJ4FmBhzaWBlrHld9CCWpPHRqofBqMReMGTJ78q9rDes1Tv7/0m0v0AFHXNR6P6g30SHivin7V1BOhh3iWPwvps/yE836L2XiwnUT8x2iHgfqhnwn667QHEE8oLQjEvtEW7GYBZDrDVkwNIO4G5GiBDf9fGoFM6n+vbEtzXwP6u9AduaWnGYSLAlVdl/AU+ikrSeEIKgwdaZ4AACAASURBVKj4/wtgHcHtdO2nWKcBkPfxcvnNQvsj2Me9f02r76T8q0IBn9OLKfz1HX8yVXQYGoAB/2UeBQ5/5kCL6+H/OGGoRnLSwdd3oH8r7KkGTbgIxEwVWvnF8KOpHnyzfF9Jod5Px+IF1h8owyitDw/XEgRb5bPqbt1uvn7qBIQ16vtS/u+DP3cR7CH0WWJgd5mTJKYgNzoGjQrfvu99NDBC+bnyW1x/qhTatv2OaMKgJWPvv5kwnMgxHYGFRtJW8VMl3uP+MgoqSZyWFKr7+KIDw1d6+IiOgZI4+d5iYL3imzbgyO+tph9t2oSBxOM3ugHtPoFZ1LM0hF4kXNEBssvVgPdjdXZWK7uKvyS3q1Xb1WQwtVDqSUggq+Vw3t56JA2cz7PXOwGNW1ecwxPhfe3QEUsDsFaAz8jg0nf+iZMAHNg/XSazDuC18Iq1HBRrOsAQ8NLB+16g614jmuSgs3bROxE55D+WDDQNA4ivdMJ9M1b309UqknaDU8ObV9/PwmMPATvTMAxpABLBzugUtV9bLdhNDQA+7B9tQJ06/7QNDHGSwtgZOCIA47InIoDdROQGtt0U1HI3GaoUnCnC/rzBMQJteN17+VaAzYNA7e+PFqHQUyXPUYB7iQYa5ZFjq1Zqpx8Uqu/XT7+6BWC1Xaj0GlBIwMoHu7UzcI/6/Acb8KIq+hzmGWmAYnADrIpvKP7TZeLaf0LAeQkGgebbq9FToI44p654F47tekKkI0L5PQNZPsDwPBpy/ni+wKMN76Vav4+2cFZFf8+JwAraMt0DFB7beA/u4Zz/a+RXx0M/ct4/jwaNAS8G17eSwmta0Fhx0VRxJkHMivso+onMXr+YwdWKbgioy1jp4x4AzIKg5lEA7wvHEYCRmdx11TAuT6lDLVl4KvXkAET9P4RT8H2u+lg9EPQIpw+/NpJ7RwE8HaDv/Mu4f3OdNkq/EfAiEiOANjEALvcWL9gfFV4NZbgbQc6qPky4Pm35QZxtH1f4j+P/jXuaYPcWwIEH/fmEPBoAO4m4LGxV3txOQqDU+dXgey+UwSzuqP++uImO/u/6ogCb7wTc1n61sL+vZi87rxnrNas+giTg6QLzaUCjIp6JfhwtGI7AjBBB9JjDY4ePYVR6ZPgN4owVv6Q2N5hhVHwNeYrM+w6dN6K1sMHZm/Ce7bHe3dzKr1xw1w4JrSQMZtgnoQHlr18fzunAszD4qurNUg/TDqzx/lfCaO6t4tACMUQ6P6htWjDPC1hCoZ8kpODzJ70MUR9AODcgwyqyPhmE+wfHYB/hvSqt6qeXUShhXH+d9SR8DzrDaZZdpSp/HxqLMQuATgDU/qDPRgOIeT8cvz/h/XC6BtE7ACLOWPE0KIS4UUjmZaJ2grBphiWgT41BUVWZfP3AnEIT6OrfoF122l2rMycBoU5i/OXoUZ4/aglsXwLzHNU++FVF3qikOj5HXm2PBitT1WuvJRAB+6O//W0/PY8vQH5IrAsMs/WuVmAdHBrQgrbOxJShXwRSsu08h8JMBpo0+aDTALwV4tbswgzHrftG/dJKIAQb5h9KCssWIMeto+GYqG12/HWGjx8kzqNJaa0noMWOr2KwW01AMwJoNvhMQda2/RKQP/3ecABM3g9uD6BY68Ntz9+nDOMb5iV+hIE+dP/Zs/wwJhJ9mgBnohBuStABUXjugF3hkXF9ZZJAjefKdHZCc389LoStKvIl7QIEb1d9RyciQgFDI9Cjyccc/23Aam7/PZJBhgDgin5CtQvbCzX8ip9YgIFtOAt+w0owp/hOiCWgEGbVHuYjRigPGR/YOnEoqPDoV5z5YqB3mRq2ox5ICmSSgAP1Ne+XV2NE+/vuFbCTRADxtS70VRBCjgBk2OyDUQiUgfl77b7DwaHm2rAZ7osRSOOUoHgKfNBSLI767+oDYrfwZvqChSpGfj3pFwZFsCJg2jeIQQBUiyI4WgD68ww4qO8khuWkkIuDrxWv2nv+UTBpJYiPd0KemTA8qqFiuUF1jWS3BoG6pADJq751JqBI0wvAVPyMQvjcX1zbELltKK+zBiXRFiRxG+b7q3M9xuLdzR8g0gCGNzSM5gNYfqGO9CBT8OHct6oB3KsSDBisUnwsFuISQaRHxDSv0vptt2oeLHMERfRn/FG/Cx01EpgIQG8LP+/i37PKw53xn6sYCM4/JwSRrCnIeB1ZkLsawDhaPKv/njU3wnZ/dBdGE8+YTHSG8+ofGgIjsC19YnwdM/KAnTSsqj6ig7uGgIPw3nYFzhhIIvriAxFP9CQd4HSlnzgxONIdrE7A8ZDPx9fjib8ifgegNIliRgdx95+E1T7+3nQVNNhEzDgGA3T2rEDLduwtPpuuouPcs8swwXFjdTaMKt+jA5gUAQPcf95KJQxYU0cYxEDvsBSmYuukp7AwnqniC9Afa5z8vboI68ImT0t26CvwBzSggkj447r9IojvCn7U92J/Hw0QSdwZKNNjxPCfSxRqnATkdwpOwh88oc4J8KTSm/wdbZjrc+4iFP8YO0/5JJDCfaijK5xVXevqfg6zGRrQf83chvX4aRfAE//6vv5+6490U4ADdO7QgM/5bcHP/n4OtCQhBEFeDWSvos8DPq8/IwzLzjpa8/U6MMSkBklDm8e0mn3QIY7XG1Om8wzN48y7HwhOK3P0/ZwUQHHv4psbdoVeb9VlAjChBCdtDDpOKTh9ZfcagOYq31RFjN4/gwBYzp8lAwYNwBELhZoxECeZxMlAzWGdCRV0fQWGHo8+8Kx+AAxnCIzowAxy9KvNepWfsfp4RR9kUrD88CPVTuXRybhqqTHcnxEGndsgub1Gdug8yz9fHt3Hpl57x/mfCOC29FOSQ7/noAZR5W3Ob24UMpuPYAYiQrQgk1gnFoUIKr4vKFpV15pHUJO3Y5rfH3UFHU4bGkU+NKJ9f2hJyOMxDBDpjAgwiYqvk5TqNl9EH2Arb6fA3yaA4cBtPWewhkEcIQJBlGzYp6zRmr1v+e3Fv27xpzvyI44NGDkCIi7CGNV9Dw0M8NtHC2vUwHINumCGNG8erxOwtQINsW88Tlwdoc+F85nI559ngEDpt2F/Uu3hiXYrkN/pBFS26hYDAkFgErMK67y9mGBA3L5ore5izf8b3n805MOq/t7XU4WHv1DUF/5gugCSOAIW/59uMwl6CHWAib8bvfxWl9/rBGEMTTwDfG+ezEYG4yk6FvRPuPwE+wvc39IRjENWM+/cm5b0W4Pf4WuKUnw/vD6eDbB1ETs5vl77Dhnm/51g6wPWwQAqxnivgQaeS3gy/u/1H4hpTPrIgHAN0mSgXUX13YP5PMIuQAfBr/f70cdeE+QoCX3i8nFMLcAjInBoAIYqt1LhC1WdtvmSab28AYffaeivCB+ohdYQgfUa/WS4ToMsNLHLc9nnvPZLwn1/EefPVf+U/xvnCVSEQEkEQEnEQJO7S7RvYDxNeNYKrG7DKMhtsQ8cMmhgPKKKj+F7CiHYFR5KIIPxOmg5IVAtu3ACQSPh7CzUQOgAej5CWEkIe3vgxz0ROGO//qYfz/dnLT+ZxDr4QW0eNCJBorCFOVC312Ec2TiY5Bk0cAaQmiA1VH1MOwDHQ0kHdEDDf+2UTWhS4Z8diQMicLx8MLBfverLcP/jQzF0P8EJj5+NGK9RCz755S6F/f1+X/gxeP+Wsedv+vF8/54aSPJYFjIQd624MDz/UDLQnr8HU3ztKHRf8Qeno1vyAQJBaLcMtTV3cvgP56COCqd/QP9xLgBkH4BxO13n4hNUDtACC6G1S3zqooZ6Ba4lp/zcAFb7iERKQwQcF39IFJjdXECGADw0IE4gg674pYAnk4HoHPx54tD5daO5vxrugSkMjgiiqc7TVKAT6AT8R4ckbHEQCYR/IZBxJgA+XZjsR7vaoRpIxWqeqfXuGC2CxwudicwePEB1kNkaZCuwyF0DuKv/4sz9mzP/Qxdg3BDkBTMC8Q+loD6UGBzx0Kz6eAX/KArOQTlPHFoI4vVtf4rNuLrca9edRn4xBP7k8w+9AgZCgBfEUZWfEs8iFNZ3UO7TqmkjCO/rWdgco/yIqHcQWaC2EGTzgz5y/iXQAvyx3riyxxV/JeBriaGB9OrTA5g9/eokM+37GszqfA/UZk9iW5UnCtBqBl3XoNN6Ag/+zy6A5evPAp+TIFDn15gQw9rjrOzFX0s2JBVAxa/nP1a6AsNWYGjPNGPLTQgBsNUFvOA3Ht9o/rGDN0tWOCcxJGp+f7++kkP7PxcGv1+GjkaLt/fawpwwerQxBJNW4b+PJsYEgiAYYdEAGIlDNaAbRkIgK3ut0jKByp+8yz23X6GttmBmjwDvChgiYLP5V/zhH6/110sGcKo5CkggCngxnIPoPja0j2B+1BRkiYJiviaLJqghDI63G2nAgAxMCuDdnoD0wIQm+urMB3VuAwbBrFGgGgnhAFqg9+ujKsLxB3qGCQNEEtPinIQlAj4WgIw7/iXc9V/x/yUWFs2KH504bAh4aYWf4TrTLGTy9YbftyLeVOWNfYNyt/ji29mQnqMAltU3ioTtbX343yv/1u0YPUBz6zB702tQucnX0gWaFh6DgPdmhXaapGotw0SFz1qDiTMdd8h45HfcqCPRUhA3+NmKz1l9teCPaMd4urGaewRitNBDdahR5c3AfQmDCFT9vmtQEwqAYXX4XI2n23Z9B/Yb1FL+LWox6wHGbZSo6FR1LzyG+3hriSZvWT6jfXhl2cmQZJDrAbuYAqAHo1GA/EOgD8eGcU7A8eDvH4fQBuAhBL/Zp/vamPTrRENDGLTV/7E1WEPLDlP/PwzU4YhusIMUgfIPAr6Dhv5R4y2r8ldFwiFoYHnmr8TAHbhRQSZOctH598ZYhqt6wP7q/ouqe77RJxvzFYaji/z4vna4v5cUMDXqDAJ5ytktqtBDckyjvJg04hl16LB0xFfyMfD77PZjErGQRRjYIfSvoAXntks0ok8MsUC4KARWnYPlJBeIgLeFrUgDOHYCag0/XNAbWgRwQuLAsaQwIhC1g7+jCNKuT38JfnYSyTi+QQEwwHeT4/dWHYxJPxfOj5oAnRQqgU3YgGZSOaDyK3n/qkDYBKptzR3oD6B4fyRKjp2AzSl80YR/3P+/1vBjX18Jbu+YsrMRgbqPP8zrDLTAaupphfeZtyPs9BPztpLSBZjowF3woYRwBwOWaqbev15b7X4RWsiqYiY6ZkFEIoUwUA2OrkeEQE8HYNyD/rl3m88jCGgO/nPW3xy8x4Q/HBcM1dYg5q8N+B/SBSYhtD0EY1PRGLDoKIBHF3yLz4H/gSYQJRETgqeB2d4vC8L2NVnQn4PoVJJAcP0inahAfdXVI8CFszjRagCTtRdV7Sr895NBpRKXIT64RMFw/iw5eChhEvmmyUIH+k+Qu3cLzOAN6ILlFvgWnx3YWFDz0f38ze9GlfP6UQ3ojEY0gtqRIEbA5/WgQFhsEuIeL75uTzvqHktAWfj/OD6sQXssROcGiRgFn0QVkld7OznMDT7CJKzhMIqxW9B+LCOQdH4uyxIcE49VTSeLj0wKjzcp2oDXQA8YoDEGBLMW0BJw+eAxXejPV/IXd59/tp5rVyYXDw5BlRetSpQAcvgfOwVM8ObzBq/AQ2wX4lwkQV3vNhYFfn2LFgaoDU1ogqsfqGkJYmrj9Tr22KQwBLzbLuzDeA9yzyJjVRfwegWq0H+FThDPA6ZhZwX2M2Kh4waovCzAWJTzD/qY00c+6PM8coz08VNqglzx54LfHuTJK7z2rwX35ABLg1DzsZ7Qv7l/f2yXDlbf4C/irg0MJ0aCuD0wP74MrxfdFlX7tq+vtRdCpvt599EG9Yz3V+P+Oj/n4zLruZHcJ7oMt/MNp9eD6HEeFb6/TMfbWo85Pb79HJo8t3371/PuIAZqMvjPC34nVV6ZB4hEuA7AzA5cfU0y2n6ux89D/35/n2/vWY5Bf0qwf3tPLISO1Tap9qzFB6eap/beqI94NCCbGwgqOItY3CGl446CaQ8i2Q9g0AvmgJOnBoAA0gu17tsKtKS7D4udgCYERy2QIceCX/P7mBW+g/7D9S6Mn50CS0eAoQPDcBjopIA5+EcxEjLweRjXq0UbLIjcBxsGx2IZvlf0ATjz/6qypAmY7bhrk4ahsIis6ccXKHdueAfUgk+RWPCLh42c6zEeKyJpRTdRAOqBbl/Wq/uT+q+Fx3FoTIuCzc6+hN8j4veGjuAnhSE5gKnco3A3XwYlq2sq+lmP4yEOpqEoG0M+mGDYuYT0pKCFHgLHKt3T7T9p8GcWH+n1UwGa8X6kQt2x4CeqPexegT6o/Z4Cr313PHdgrsS2ZReLfpKIf+IMFnmVmwxQ9AhithYT73+p2s+JIVfrjwiHnpAZrSsr9CMstQXP1+1+510N/q8E/YoekMN9OMFvi5LvkRDsy9rgFCOoPdpgaQIWBZjf5KCSQszZJ1ivTvLokpen6tsJAVND0NFqb6GUGg2Im4Dyx9Pn7/0dm4pADAslJzTv+dKNrAPQ0wyySm7bj1RQgbAXsRa4R+mBJzpaQmHLmy0BLoL+Nh2ZRca8uUc6P37k97n451fvTieAE8BdZ2ItqFEK6oOJIYPsiU4woo140Oh+H/UC++gatHYcOFT+2y3AYvD1rM/fpxdUcsAi70c0OxAEP45X/hymE9XeoC0zfYhbcqfbhs09HpwnKMDR6g0mmYyKth/UcLl9ITGQ8N1S6s+gA1HvQCc2pluPvN2Br8SyZyfyxPP/VhCi1L1HWX2CQCuAE8TIq/sBYdANZmTIwqq0sb0HIzhhugBeUpBZLFyA8y+EErsBUYDZHYN9QAAooQwOws+uQlhdESSSqk5Qsh8LSYI6LDS1AbmOvLlRBqQIeITvM36+TP63VfE5hFClCTr9zEyVFwS3STQBy66DMHB+PJWIrfgGnYBx2dTboPa2X49GaBVlePA7CFx4iaGi4ns0aLVjMGvtPTDtmO4XEE8E5Kb/8qYai+NHl60LgAICcUCoJPVeiYG6Pxw/X9VFNVbFn9FNPzXoIRDTyzcpREYB5Fm1EQQn3KRi9wKApR8Tz48SwxnV3qM0q7ZhpdKvr0zfY+gO4oQf+EGPFYW/Xf5hwWsUgxiBbShGoGIx+D2eH1h2EeR3UQMH4zMaUKr4033nzkSkfQADelFbLOQCalxdxvN8mInhPas9bxtGJw29Fx3Y8429MAS0fL33Oeo7qFZeiToCC3B/VSNYuU0fgDnkhxGgMFdxiYEY7MYel+OHPH30IMeVFK1C79l+QdXVpFqHlMAXEf3EYDyfkkGdNvJ8f3RAXU0jpgM7jMNA5yCrtfzOicKG/M9bgEkEjqqPPDEcDfqVwGZv6zcO9avDfOhf4OmLFd9OLBHHdxp51HvOBlnAoQksYjASA1xnIhPsapTCPjbsGB2YevpPpgM73EYeSYIftgPgte6CWesVBB9QEgfnWYMgoeC8ql69bWoRIqYHvSIv/u26bj/jdqZ9KSGk74JRo6QS9PuTiSHm6Z62kLUGH0UO4rwWrhtRETkR4iKRdI8giJ2D2nUCMjsA0TXiVDb98NAf/rCMlajA9wesWHZrAe1dlwRyVI2jx4KkyUHSx7YDe6YD4tOC6XW01puEdAJwaEJzf1uATHi6ZlSCpBQscsh6C1xRcWEG4bCFeKcAVhVlDu54JQIkTT21hptIT/Afk0kMcS9BKfjBJozcDXCrtgbWXxbMAw3INQIxtQJPAGwXmYaBbYh4SCsuKwLOAQ5awKskCMmRg8P3xwlBfbosQaDqyZqBkyQe1CLQACoTgN4qbyHsPwkTiF2pYaj6MAXBmUosQHnUEYCsBL3MW39SNKMJ5PfoBsT33DVJCEbFnBCMOkHfvj6Xq8uw+dgRIhGgAiUqf5QgKDFyhe8nnYrlqn9sG1GoAfirubygX4H+8IM1CmQrMFAJ5ExzKIp54nPoVU2Auh6eBShDlTV4u5c4HE/fVvjFrsII0Ik6QX+Iq68jB19ziLoKC27FYe0gC+j1RSS+BgB7AvAM3m8HLdy5fV60C8RMVuhD1ieQB32MCCq0QPJuvuw5IHF/geMKwOPdpmsxBwVEfGEOgeincJqNmuSFIPhPq/xM81CWIIi+gCFBqDX3QPYd2OcCRo6GZBoA3AM+00aesAOQ7/2Pe/vBCXoguD4OBD1WfPwClzcui12AuH+gC0gEwW72KfjBCQRBr05D0IQc7N8PzOCMehPWK384MPVDJQim7yDdoiRTItzzFV/ZOX9sYFetP0fsQzb6O7wOoFjxk89YoQXv+BmSN+yYHYO+BsDRAXHhuJXsEFbdIEGZQWUkNVNzGA9NZUVBIQL7jASR0AclE4Pb7JN3BO72mG92+o8UG3nybj+mASh0FsLKn9GPxDrEcS2Au35BzHO1BksriIJdpqWjKR1wlpR4fN977rZqI+XbYjYDgVDpcYQalOYKMiuQbB3G6Pu/HlMbi9a0EMkksXtjvvXTfgMKAEZRN/i/O7yD8Da2S2Bdh3ICWfp8yuMkYl5a4df4vVWt4UF0yyqEnaT6swYyWB8/j111Y1ERS9oB0SLMtBGDEBD1PEHwtdjUEAHnqmoHU4wCDAoAS+lHwtu9eQLUAgmxVvAuMB9cELMV3m8EUtcBYYI9nkNIEEJYrQeUHfnzzRyC39j8CgSkir/E0P2odnAmAqDnDIhqrtV9BDNS2POjv/0pwKr6z1h/PMz3uf9ykFYq9TtoAXSwpz0HljdvBCVAPY6t7osv6gFhMpkX13rcfXQMIpuTsfTibkfOPRAC2meLRipI4mDPwMD5x+v3+Ey+qEfACwoUEkKQSMZxYJDz9R68PyP43yvo2aYf881rNQbZgRU/jp80QnW/hdXqJxMvCFxXQSNHpE8QiF4XI+wFfQcw7VL2Md7RRajsKgh2D+6SLAKPF356+/7yXYBTUgFy/38StUjFHweD+iiHh8/LV/i/TSvGk4L5x7F6AsIKbgb4C0YjgdGRIToGUx7cgS3JKP8pRcgak95BJGQbjaJdBYQ1qHYnYHL8F45QgHx2gLMQ2cDxBD/4SeR0LSDi5XzPQNjM4ySE/HGG6g+ugltLNSARn281BPtNO72eJLjdX4ITSEgpQvJYFEUg24f1qAYQNQdxx6Q/RcB85j9f+03zf2QV33IDPHegNgPABTfqFR8cZK9TA7/ll0EQbUUHW8Gr1d+MSadia+LRHwhunv87yWoJ3h/pRDwJAbDNQQFd2P2mH4kP/wDT/ZeN3CK3+ZjvgVpw4r20AMafb58j4N1UMknuj6iCx883PU9g2VHVH5JX2eEcPghSgRBCKPzK0Q3fknwPN0Hk0CyC0zBkz//7duEetgFjVtypASDI4CsknYJgYDhqsBxxy29+eyxrAZX75EEf8f+CkOcijMDDHx4ASYGGu8WHgPwpHJc0qOG8FgFTuVk0cRZVePFwHEIUEu8xSHoL5qWg4I7/HgOKXe2dcnu2SSdCGIDTA+AcxY1zYL6Q6AAFu+/1GvjKPSeEoJV3NiM4Dz9C6oWkEav+NWjPWXNOIkKgNTi2I8LeBgaZHJxqrC4oNXoB9pzzMws/OW3ghSyQJgjbygOVEDhoj4nHLld8HPD6UUMFVLIgKrTL7cFoBRLQgEdXIseZ2/HhFPKbk4d5tYWwwR0nIFQSD2P5gQhs6meVfB+Bkyz2fOIvX/zxqsSODuAGIOLtPNnmIPCrv6Kqvgz3q4tCwNl9lWYfnsdHj2HTgQw5IBHwULmfSu1jEV3gDFSxTBmqSEVqiYK2IkWcRiAkwV/cyW9YhqHXDw9dkNQAcO6HFNJT7oChfrPUYc3KY17zAd+evAwF2w5SCKLV4EuCEKsKfjBVWHu9Q9Arh4CoBqEMWYBsNX7YgKP/69uC3M7/mOOz232QT+ox4iCyJGEFP4oBHd+GVvXBwX35nqp7qeIbV6L6tdZub3ueJ+gBIKgC6S5gOQFxDoGr+Bv2nzqbknd7ph/EmXzO0o+kZdc/wqvQkAOUffVMzKtYgx5Vob1/+HAfCdzHSiXHenX35/2JTr3KZ9Ruj2lYiMhLIFoNyMq9hFroeYMTE0bSLbhb4l3YlFPa6hMd2jk8dmrDgdQCnC4/+ANFlYTB6ATlx2GDGXP1rvL+SnWHw+cJes5/rRWt4H2pw9GklD4uSMpwasIQiaYR92gIyFX5S8dtRZt/nCAH48VXW3hRE/HKOsGquj8EM85Q9cfeAV4XwNGAlmIFIwPYrfLKuxV476RRetzcdeAsRSZhiHizCKEIOHn3EMOWy5X4uIJnXX6sFiBFLaBm/THOQAkVJK9j6TKwiSDTBWpwHkSPQJX7U959uAkoaTUuug6oQCBz1Zlxm0OJSIoIw04M+7zCGuYiznCfHww9AN6Ir+HXA7lfn2oBSJ2FOOh8SzINfmcAyITq8JX/sOMPx6A9LeYtVfwgCBZhdu25OB9/XmWWNPUEPD5dUuJ68wd1AqD2+w1PI9KxE9BW5t3z/igdYGWiL7L+wPv9jgVY8f0ZcbCKCuLAHN+c5wa69Zpr0J9t2KnpAGzyiAIPiFalJ8/xXrrA6Y+/8NoDnWCPNwFJzf5DpVkHte8hx76P+HU1+HEytEeSEIzAsu5r6wPJGu6oLz8VrKofXLce+ywIHhNa/Dmw8LrptWXZ4NKZm4pr/QQ7Qk8ehMrPtAF7PQCD309QgRgRZMKgAbFREAfBBXNalbHA9cEHMo4IgIUuPjjBWEUFEQpYTkhVO43eRiynJw9Jjj8TOUIlJExK+0wA4gWgQvcFBHAc7P4/u78/Ff4CC5ATB3P3oUwFClYgcALcxzp/B9Ez4DUV8RjBbsCBrMH4dLNwIDaCGhA6o3pXksdBvYBsktrXDgNJKAFy1Z+ZGIy5NXgXoBT8a3ZgVSPIUAMV6DjLxhsV8wX4n4ibbONObHNyCr8Z4FinNFjg8ziiF5zSV8A99u7Zdf5OisvVaAAAG3VJREFU/kIPAJLWX3hUIFD6o7MD4WkHIMXBk4IftSrPNBJVk0OoC7ice8HGS8XBKDoz/YFBLaQi392lGpCMJfhD9xVkx5Xbj73P9V4m1j0v73x9FjDDPlYvATkgFAVWcdNvJBamliOjAwRV0EpeRymAe717kMYRyy/j5FwFBX0fP7Dyx8gq8wn2ZXi8GfGYR+lFcGJSxa3Y84WgzBHetlU4cvKY44Ps4iP9fsgsPGEhQTAcHqwwGCj61SoPexKwasXFqtxq8qhD9SixoBBYcJEDNzmIoi3J7QkoJActVHocTVpPBCDhElAvMDK1PT/Sq3DwB/ygmyB9GNhYDH4so4Foy48kkPtZfZEv1PQTxYpyX0EI3Bu+/5krcN8fgwVdwWu2JNVNWAk+PcOOPMNdGFyAZ5Aj6gicgzNfwuHZg0HrLxBWfjSRl88fVCo/apX/IBrIvf65ZxtEoK9Bec4KZIPLe76osQns46NwW0pUPCPAyMc4A/KXOwZzFLGbAqD5xhhbgBcWfoJBAlarcCSQgdQJ+Movnih4gjZQTw51rz588y/ZgxVUEAQ8soCfX8OR26JwujCLGFAMsOjnwGrlPuQw9D/PPv8BYVR7pG/eeFtQpsLzR2KFI8SwKj9KlX++HeLOPuSBKrKeHBi7L4b+Kx184+ptAp4Trcscv69oARVYzWgaK01H1X0K3zNSmARKtxXYHvwJuT+8gLGGWgpHcWOmBeljFB2Ckg6wiAYOqfxEK3GMCAj6kIiTWdCBCXhkjUKMgJcLk271N9uLSbtvvK0S69OXAvoA5z94VsFubbmZvx4QAnXgBnJxENyQjy38wef81uPhxMpPJIQzr5ckuUTKe0wZyN57iFTWga8GvCwlh5UqvYgmaNV9XSxEVWs40kkosFwA70RgNOu8mLZfR6wDiwRa35y7j08NksqPQhcfkRBK/J8R75Iz+9C8gJpqzwiIeZII3QnYOkJWbVEI5jNuA+o2BwK82ifwnpSgHwaC+GNAdmW2VXfC+vPu6wR6lBj84C9WfvivZyUhZMJlJhjSukDlFJ3g4AvGJfC1iEpQJ/CaEd7G9wds7p71+odruKrHip/C7RdsxeVjzIxhoNkFGOW/+sk/YVAGtltfzZAIfzix8gcHhZCXpcGN2u69qWqD9OlRFAy7x2fQBhHUiETB+DocqvArYt98f+AEAXApsEmEcNLC0t2uPHCqPQIXwHYDfI4/9+8LMpchqr5HK39MJSrBXwnutNqjovjHFdq+fcHLp7YLR4mGgduW5hFpAXUoL4cTTuW5HJSkB5PC0S7A+8c+837DyoM1J9iv/po/o3BunlDqPjOSO/YbLFd+FGy9sxKFeT8b+nLNPrkAyD53FtT27yUS32yqUaEGTMBiASGcZ0FmK8nWxbvjC1q6WQC4VdWdAcBY8eFoAzIrC0b7Wt8wlPcIdE1FhUWeKU1Igv8Q/0dl4k/NnYSxdlDon8diUDeuQB4c8XVzcahRgyyZmNC+LAgeCfSVALde8/t1DCYawNoePGT83wlOpFUdOZKwxn89OsMEf0X8CxJCBN/dwKbFwkSMgx0ACJJDJD4iC1JEYh6XcEqVHpx4+J4I4UiAl26r5x64sttvSlAn3LBuQCz6edU8C+J5epBrC4YP52EFDgHrCw1B0eU9bOaTgh3wmYvQV3Oqqcf53XnVNXUBELX1xtSgFrirlII5d3HFulxBCNEfZx0h7K2f34XwdHpuYQcguN189Ow/nPXclaUcqMH5leCXjKOjbv3F0a7i2ZaRHmBe5zwnhA9S736ZC8AH8LHkg/T5znYgmES1dtuzGo92qwHIquiWX+4KgVLd8utv9Ml1BQNhEJW/FOgweiTguCUoQHkEwYhjfQIgm8eAzPKzHqAG5xGiiPyxeGRRaYetUpDVpHVC1T9bHGyaknb/TQTnuG7rDYwYCUT7/cMjtILzA+Go/FPw581F/mWeTkDuBsBCAK8ki+A29nMzPn4Rzjv6QV7xWW4fzQFUxb9jQQ1qc28kMi4mDl1NBr4usIsz5ltZqNm7AeJXfuTHd7nioLEyPBISU+8/tP1AC4Il/n+YGmjg2NiBRdl6yCw//zG5ph7bqaBuz8B4VMU/TqSsNPbwCeZA1cdxyG9SgKzRZPL+GXFOiH1/SFZ9wX8M3zUgvH8a4rMBjZj/h1W9MrwTiN6MlsCKiI4gycBzgV/xUaQGjGDHwHiYi0VIzeEAasCpNuL76AC7BIEl7i4AIxnAfoMxk35eJbZ68wWEUChs8IPz/EEE9BkUoNA4RCWSLJkY1h0Y/dG9bVCtUVPe7QRhtStXG4nOECDfUxc4Uw/Ik8JkA9o9+a83IrfHH11EdFUWc4phNgVFWkPsIHBnCvCCYBSgqEN9qtoXuwHhByYoJJA7BxIkkRwpDGgAHo+vQ3ZGOwCFJCJKUAx4MBpFZWvReeLgtBBkDDQu2OJxXa7SE/P4ZiUPHABjY1DsFIhPAaygWewiXK72hHjow/k8gCL6gKES8qcDZ7A+EhYlWCPGCX1wXIwzkQEKt8cP6iqkC0FEhFj/ZYtvXCtwuBLcDT5wXN+9H6ZEIkTwV/x/s78fXFX3siWHEKrC3tw7EFZ31Ll7ttknQyEMGgAqCaVe1bGk8r8nFWCQQR0h7CY0dsU/mIeIuA1AGCo02Q0YVXxub36sG1Qgfo0CBBUXxap+ECFEycQVyViBEBFPt14TK9rZHB9EwMG7DPXOv0OVHkdtx7OSCXfb3av4CFZGTwQBwT7/hKPHE4PzpJ4L4+FM9r1n8B+B+9R9I4Fu9brYUZgCunZWNxdQgIs8mASBQ4F8hJpEiaf4GPihk8FdAxin/kybjZjTj+mAQy6ihZ9whDvHAWB6BKrBXQr+5SBfqPaINwiz12UIwoTmbPACZY/fshBBBKNlW8ZCHwH/cVKSOZMm4Mxk4OwE9JeB+EFkn1IzcPQoiSB4vGgNeJSoik1A7m0TCmE/HrggB+/1M12C1Z18ACGoIeH1pH2IhAqFWgBq+kDFEWAvA3X8tpW0cnSD5WAOriOHhnYraF1eLTkS8P/QsHUBdtMPnOrMaANJE9AZiaKWII5Ue/8PTHn/UcCSTgIF2xN4zdmAQYIAKeBFl6FiO0aKfq5jcImHfPwTxcEdRmD3LcFoAva1Hdjm9UgGggI9YOoPkOBYLsT8HlG3nucMDGkOOJ8CkNOELdSO7D5qqAeJYBb2GpABgRi2gxLITgrOQ9C937HgB+0i7MeRx3gfPWCXLtgbLJAu/gCFBPzRX8eADJqCvA3FViC/BlOQC4LZyrBq8BdQAOUKoKjqR7v7EFfVFMojPgEoSlJesNIePyLHwW9NRgq7E6HvUN8A0yj0wyWDHRZ3J2A1jHdMyu3hCGwSDwdRir7h9VP7AKLgPoMCgKziOFLtrUm8aIFHlgxYfz8WBYUU55iAXauo+evJaIK/NTgRJM9sUcZRzcCnMdNKMJc7usnAyrpxHYkTRHK+n1HxS01LheAHqRWwKIDqLvQC0+PupHZgBawfVGsiniTVHwZHRqbUI/D4Cd+ftgyLAR1ehkIiqaKFw7MJEwUIuK5zsu4svoFYCFKgBJZACBuppOId2RDkPZas8H9kULcA9a0KTCQDGtpnzT+RMJiOGseHl4BQ1C29AWUXIIf/OIwwqoNEK3SCuA7FRiBrE9B4/PcrGJ1OQNj83F4Xbol/TgVHfMiIZLAdcaVkgh8sLrd+liNQH/FqsNTfj15m1J0X+ffZuq/gTY7QnvIfJz6UzBJLs83ItQpt3RfZz5iuGfNPajpngUm0R8DoA5jDlzsOTAwZjzsC3Jjxg7H914PjlcskGdghgx9HG4OOQH34uwQyzz61/0qiYNQjXxECuWYbGM/DrjtPH/Mw/K+gBLLSA+cEfPr4MroArzcDuybbr8Zc72i2UnzeHnTgzD4Ug78SzIvCoARVOQxaFFR3TzWnkkHUVFShEuqKxZnKz4p4YYcf8ZhYhuu8wFgSHcuuwCJagI4bgchJQK/qe9c/RT6nGcg6KGREJpb+MI0EY/b0jcsni3AJBeCQNsBOFVYoApcM2Aom4VFgIRdHpeIG8D3YaxBD+qCiQ+rBOSVnci8hzkAG1t/pgHA4uwDzmu8xFKkkkIqCfkIRs204r/hiDgutoAAcowBMZ9+KS0CcXVBOHCvJw2jMQSJyeoeExF2DuTuRcuWAo9sefyUQ6/oBaIjPtiRH1KvQKvygAHb171d+vc4GRMDPoxN/kL5pwlVh1mBQ1quQJAJ5j0TgOAis+h8d3mnC8xTKE34+8sDNjyVXE6nFMN+H39TQDmocHScENvN74LoGScGU4f7g6IG3n3C3qnG6JBS+Z5tHOOzRYQx+u7MZmAl0OSsRLAS/VIKfRAWU92+12aaVPksGDBWQuCMvgNy2M2Mt8EwqbjosZAec5xLEAmXmcFTHiOWARWglpNpjdEtBQRxJJU5VL5/7F1X86XntXgUK4q+KggsUoIIK8oA+kgy4+zLaACqQGTVOX6MBWdehL6BxHn+tlyBMDGAqufd7WOX5WTJwKYDfXJJP2GXDPk7Tj5Ed7BOG7DMFaBRAJgI/+H2Ngeb2SKb0zkoGlQBHkefDr7xMA5HZeJPtKIzyApI9gmnPgf1c3mulfhe0gFekDCdNFnrOwi4Gs6eTACNjB+Uegcgojog4V25P8bctRYY6RL8AJklE9ACFAGZdBEahd4d4CmghFhbzcwaXYH5qTlS6DY+KfNH5Avzjo2JJ0poDkSCMxLn73H/eB+ifvgvyIFCWAji7BWC8hd0qj0FziMdrS70BlVbgamIgcmotGZDNPwm0L9l5iHv7WRoAFx57ScFS2r2iwot8oKu8l+TOCOg2mZ2nFdjTgOFQENzKkJ8OjEnsE8f6AzyXwT6MNF3RDRnuj0Lwo6wTlBMDIyqaz6G+RiLJMg/KUrQV/rh9uH0tWduwoxmky0kSMQ+rnXxZsGadgnxfgk1pCnsIsGYltvfdzTOBIclIsN8MLAGcz5gBwj94AE8DuC9Molip/JGwB57nRyJiyD3pyk6q5ij+3TzRLohcqyqCEQBTepF15+WVmW8SEr5jMUUkx3oMIsrH3ndwAQganKzyMpOJNxMQooGBYwcByw7axIhgPRGEr6GSGJhkAELoQ1YRg+dPeD5IIRDIqq5PA2Jh0Rq0YcS8XBi0ghGRFpCtWTdum5+yLOsQf2EuYY8AfnbQZDgCjHxBSKwTGpt8QCIDVH3/4H5OwEvldhliINwAFLsEyyIfGKV+vm3eEehVqKTdNxtDiPoLHCRiuwTJxCECxMDqDjTvZ63KaPKvRgV2i/F3ohm88V8LN8hgJcXD5pVGIPPNn9EBqSQC0I4AMxBUcQNCkarkFgSn/oCs9GCVep4eUG5BRAOcQOCWlGSc3If0IFqRfURQGRrKewPKEJ9sLnIowKCcw+f48N6UHjqYtgInaCCkBbPSj8VEkCr2g8U43wY1xX/BNkwreQrzg+oaJghOCGTU8RBxuIp6VFOGoEXgEsBLIgV6gBgxoLSI5CgiYNT+GBHsU01GthrceiMUtv9KgAYktgVNeGrBbtiOQVi9x8WjiAW7UNUnm4Vet7WtsFgDCDYEwQ/EVL1PnQf/xCDLTowTh4c4HPRDoQaiwhKIAae4B7xgCBydI/CDPOrevK0FR4p6w3VfoXgQiB3T1N8Y1PCD0X19JqcHGfzB5WkQE4p/kdeXBcEVUXEIFqSij82lMyrWq/7c+LFHA7z5/dwOHHg8s/Y8C2CmhbmALtare+4UWLfb25BmXABKABTniC8gRAP2yvDAiUAsElnrxFzITQa/sAFecAOY7zPV/8jMQHSbWAiUPGkQNABhw85xrSCv+mMSzFR8+7mjw01A8f4F8S/td4jnDHYxpT8/OEyV3gz2+GTfdAeAszswfJNGlQhEIjB0Bls0BKn4Iw7WKu9f1gmSagmvqleEwJwnZwjO7npz1HdCJ1hS/mlBcRXyF3i/M7NxqJFoeH27z7nnJaBmpUZKHsTbGUc1ALEoIGsGYl9ixS50gjAT/VhB8IzvGTrBVfWEz1MzAkRFTtecW731VdjNQPukVdhdn0Y8d/a7WYH6i/TBPBzUFwAlHwtGHOQISrgb1AMUgDETTA3+THAdeRJhg59V/Ektofa9I8wxVICkC7QQSAd2O3cftzPzdMK6aA4iZI4ILfYRbb9RgqICt2AxVnYZ4kkBvHOBxT/zN9ybHx/f5Ql2fkGCX6ANm6F8WCfqAS+Eq5AGcHJd2IFHagTMHAAj+mWBnDXuc81CjhsAi5dL2K8QCYI1aJ/PJtSSxEFXASv7C2I3ZB9/a0j/7nDn/j1pHsz9Jr8fNpxPBUAUUYD4wz5GBlmyAiORjtAIGDFwzSUwqiNZ1d1tPiB7/Q9VeI9KeJU16/knkEeQJEALjY4rkp74fCZiMDSA/PgvT/aT2gYgp5E/P29AKBQAo6TRth5T4VesQFb0i4K7RA2MZpgyFXCEQHCOixuYMPgy2L7+45ezSSKt2oUkURlpXkEMOLSiXPuDQZjk63N5bmzOSxQdLHX7AhwUEA0BAeQPJIQzkAuFlOK/GtyLdiGDKEBdllQ7YouxV2Xdwza9So4Kp5Z0yAgUhTlJgFzSFrznIHYIwKcCu2/L3LsCg6UI1b1/CA+ApIV5/32HqOIjdQusE4azip5Wc1b0q/QGIAlaWEJbXP3r/L+AEipw/+BtkQVY9fIM2i/ZhgVEgJO6DZ1ksVtlYdoQAPhVO0oKmYBmnAYco4DRCRB3TwCziptaE0auER9/VzRqKNOEYINOQg2m1l9GpGNQAhh1v6UmxNQh2M4+LmlUzll0OTjYQOaGlZAEMCrdhmBphaMBwBADrSQQc3//He8KgFETT7p6BHnjj2X9EXsDjrgBS6ihoAmcSQVYmE4JgYWFpp1waAQRoqDzxDhU+HxSnZHz/9JEY6Y5MJA+cwoWrt99+U3Mc/9g/NQTFaigAEtwB1yBzwzucZSX7RZEILhR1d5GDCsBLVUdIQvsldZfEJt5i/MHx2hGJZFkVVyK242iFeh58oBUFqIQbkfp2DV2X0CkAYgv1sU+P+I/HmBu8nErugdRnUWhfp+A/ddlbEH3uQlBsNobUEMHasK1HOYn8BEEvCUaiuigXRIKj+sGOPA4KAWz9/s7WxcgB4+a6/fI2osEwv4yOENAiPf+wQhbc/5f0gGisWuQaRFmGoIqguARWsBQgTTocDLMT5OJUQnhqdCEig+/EShKSEgTVV0MBMnz04BcshPnLk/+OaV0/dwKzB4QUt1NB6uTDfGOP+cNm9mEsBAFiM7AQh9AKVEU75vy68jeOxrUC4mDEuYO0oLqoSdHaEF2eXYYSm0V+oEOwpLmYFOF3Z4CmAeBTIGueiIw2xoKPzDBJVBXQ5g5O8/twwA+QguIjJt3+g0NQEcDfUXgO5gsqlTBLkQLdl86K3CWneitQ8sg/5oWAUJP2C3V3RoEyji5n4b9lB4t9pz2CA+cAFn1Z9I/uzYsU/ELtEBOCHYQQqGcFejV+yeuRJX31zsKV5IGjway9z6PLDxKwNEPsBuOEiqw57jGgOtZ1Y++T50AuMFl7hPIbhskiOwsATtRoc7rS7dXrpcgrMCGJca6ELJo+Y0be0BW5ZKGcFz4y8W9BduwcDnK9iO5fagsKpp9ANnvDPxeP8THNyIVFo1AMas8Qk5v2Ytm0LCCYAXqn+wQsPTBh/5Bcnne14Os3uCQt28vsK1WUESJFviBgAW//3u9PLxusXchcCR2WsNzv/ImvgZzzkUByDUAIrjTvmSHAowpJBQE4SUlxMxnARlQbIqkArVAJ6pBBvELCCKlkyCDAP45BYfEPfcUpfMch3Vn4bheYK4E66BxAxHSVd5INgEPgU/NBCDfNQ8Ho1CoINAPQAW/QT8OCIZlNFCB84XhoDChFByHGjx35v9BLgyhmojqHYb5QYXnuAecvua0hZe6BV9f7v4ibvgvamrmAc1TmaEir0LQ9h97eYAYVoM/nWA60i8Q3Ifezha9BqaaL3zvqd6IAuwwLSCCuCLuJWch4h30giPtyiAphKEBcCu9BV5wwzkMxID8rhMwdwMhcSFgrBT3RUTQboAUg3+p+Qe1IGarOioVnazmefV3lHpwA0AcLWCahUiXwePHWJsP+GH1gnp/we5KfOhJAbsj0H/BIEb04TbrTPsAyb2LLu93KwfCvn5PLAwrOXAa72eEQRo1CNdw5IprsAZ3hApy9zlcITG2vpCihsRSYxNS+J4vdBZ6B52eqRcQ/QXmSjAWSfa/5GA5qEg4iJFtm624AqXLrSA2gx8p1Mdqcghv41S0lSp/xAYs9gakQc4Ie2RTUYwYgt748mV+FU1Xgp14eW3XYZ6cdqGTNHwHICTwEeTPl0jEZwIgP9gDEaogeg5IHWCF+1eoAhvEKPB/EAeTRsM/pSAP5wjWEUMM1/NJRhwJbpJSgK7S7zF3EOsI5jBQBK9DV80Z8Y0COzvmWzJXgDl40KEC6cqvqgi4OB5cpgLFYK/1CvDiItXqC6/S87wfAUfPtxqfGNzlYaOjlf1IsHPPvffHgDAoEeEST4ZLZUd/RSo91/BjXY5ggWgQ4In3fyj4mUqPrInHOCLKO3wUwRsfyXpt1nEIRLrqcWeTuk7bigsbid1zD4iDRQtnIdQsyIXnFCn1I9D7ADgxEhOvR5AJosoUbu1FkJyYCi9OhQERoIx+4AX/YqUXQhtYEwKN4Cy1HntLMmtaAQpqfrT/UCoLSxeswjA5UWPPi0mjajUWxMTdVusNvt/ChMdmILK5IRMFu90BMEzFYHdg2GAgeYVHMMJIBTA7EFTx/5fpgTFXz9w/en0ZjD8kCDoKPNGwlB01BmoWQbh+AxR689mBponGJOr9OwmMu3dtJ/ylW1Tik4ElUPmR9RqII+pVhD9ychABMQ51gOIZg+/G+5mGIzLB1JJC5WhzYjhJ7IWmLDpA8jzsAafUPkB2WnFBF4iSxkq1ty7f25rv/+EQLOxs2oUdTSA9HIR9swdBlCcFe9owPC3XWDDC0ISVzsEVbSCF/sWdA5Fu4HJqankp2SeQCYYrImNalfmhpVxYrGkUS4LeSUjg8dD7+D7w/ybIfy7vlB9/HJ978zr7/45Qgajzj+4EjIK/ULHPRAOlKr/aG0AFcqCyu0GcW45Igh6JMJmhA49/U+cEssHNJhtXDC1MOya3j/sAiAGcrEtqtgjBD6wEzSDc7D8o6C8rIqAZyPk+NQoNLAZ1hR64Yl1FBY648smUYKnSg1Xwk/0DyRyArByMUobyByhCcPnOaPyoegREFS4jNfYAw+IHCjdC1J2WDZBke/OyN85J24WiXwDYPoJyYuCD238ulvuzwt6KgHf0shWKsqCFFGjB/w8HU8eeTED9wAAAAABJRU5ErkJggg==",IJ=0,F_=s=>{if(!s.environmentBRDFTexture){let e=s.useDelayedTextureLoading;s.useDelayedTextureLoading=!1;let t=s._blockEntityCollection;s._blockEntityCollection=!1;let i=H.CreateFromBase64String(CJ,"EnvironmentBRDFTexture"+IJ++,s,!0,!1,H.BILINEAR_SAMPLINGMODE);s._blockEntityCollection=t;let r=s.getEngine().getLoadedTexturesCache(),n=r.indexOf(i.getInternalTexture());n!==-1&&r.splice(n,1),i.isRGBD=!0,i.wrapU=H.CLAMP_ADDRESSMODE,i.wrapV=H.CLAMP_ADDRESSMODE,s.environmentBRDFTexture=i,s.useDelayedTextureLoading=e,ff.ExpandRGBDTexture(i);let a=s.getEngine().onContextRestoredObservable.add(()=>{i.isRGBD=!0;let o=s.onBeforeRenderObservable.add(()=>{i.isReady()&&(s.onBeforeRenderObservable.remove(o),ff.ExpandRGBDTexture(i))})});s.onDisposeObservable.add(()=>{s.getEngine().onContextRestoredObservable.remove(a)})}return s.environmentBRDFTexture}});function DJ(){MJ.length=0,PJ=!1,Q.OnEventObservable.remove(D2),D2=null}var yJ,Mf,MJ,PJ,D2,O2=S(()=>{cs();gt();Mh();O();yJ=new RegExp("^([gimus]+)!"),Mf=class s{constructor(e){this._plugins=[],this._activePlugins=[],this._activePluginsForExtraEvents=[],this._material=e,this._scene=e.getScene(),this._engine=this._scene.getEngine()}_addPlugin(e){for(let r=0;r<this._plugins.length;++r)if(this._plugins[r].name===e.name)return!1;if(this._material._uniformBufferLayoutBuilt&&(this._material.resetDrawCache(),this._material._createUniformBuffer()),!e.isCompatible(this._material.shaderLanguage))throw`The plugin "${e.name}" can't be added to the material "${this._material.name}" because the plugin is not compatible with the shader language of the material.`;let t=e.getClassName();s._MaterialPluginClassToMainDefine[t]||(s._MaterialPluginClassToMainDefine[t]="MATERIALPLUGIN_"+ ++s._MaterialPluginCounter),this._material._callbackPluginEventGeneric=(r,n)=>this._handlePluginEvent(r,n),this._plugins.push(e),this._plugins.sort((r,n)=>r.priority-n.priority),this._codeInjectionPoints={};let i={};i[s._MaterialPluginClassToMainDefine[t]]={type:"boolean",default:!0};for(let r of this._plugins)r.collectDefines(i),this._collectPointNames("vertex",r.getCustomCode("vertex",this._material.shaderLanguage)),this._collectPointNames("fragment",r.getCustomCode("fragment",this._material.shaderLanguage));return this._defineNamesFromPlugins=i,!0}_activatePlugin(e){this._activePlugins.indexOf(e)===-1&&(this._activePlugins.push(e),this._activePlugins.sort((t,i)=>t.priority-i.priority),this._material._callbackPluginEventIsReadyForSubMesh=this._handlePluginEventIsReadyForSubMesh.bind(this),this._material._callbackPluginEventPrepareDefinesBeforeAttributes=this._handlePluginEventPrepareDefinesBeforeAttributes.bind(this),this._material._callbackPluginEventPrepareDefines=this._handlePluginEventPrepareDefines.bind(this),this._material._callbackPluginEventBindForSubMesh=this._handlePluginEventBindForSubMesh.bind(this),e.registerForExtraEvents&&(this._activePluginsForExtraEvents.push(e),this._activePluginsForExtraEvents.sort((t,i)=>t.priority-i.priority),this._material._callbackPluginEventHasRenderTargetTextures=this._handlePluginEventHasRenderTargetTextures.bind(this),this._material._callbackPluginEventFillRenderTargetTextures=this._handlePluginEventFillRenderTargetTextures.bind(this),this._material._callbackPluginEventHardBindForSubMesh=this._handlePluginEventHardBindForSubMesh.bind(this)))}getPlugin(e){for(let t=0;t<this._plugins.length;++t)if(this._plugins[t].name===e)return this._plugins[t];return null}_handlePluginEventIsReadyForSubMesh(e){let t=!0;for(let i of this._activePlugins)t=t&&i.isReadyForSubMesh(e.defines,this._scene,this._engine,e.subMesh);e.isReadyForSubMesh=t}_handlePluginEventPrepareDefinesBeforeAttributes(e){for(let t of this._activePlugins)t.prepareDefinesBeforeAttributes(e.defines,this._scene,e.mesh)}_handlePluginEventPrepareDefines(e){for(let t of this._activePlugins)t.prepareDefines(e.defines,this._scene,e.mesh)}_handlePluginEventHardBindForSubMesh(e){for(let t of this._activePluginsForExtraEvents)t.hardBindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,e.subMesh)}_handlePluginEventBindForSubMesh(e){for(let t of this._activePlugins)t.bindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,e.subMesh)}_handlePluginEventHasRenderTargetTextures(e){let t=!1;for(let i of this._activePluginsForExtraEvents)if(t=i.hasRenderTargetTextures(),t)break;e.hasRenderTargetTextures=t}_handlePluginEventFillRenderTargetTextures(e){for(let t of this._activePluginsForExtraEvents)t.fillRenderTargetTextures(e.renderTargets)}_handlePluginEvent(e,t){switch(e){case 512:{let i=t;for(let r of this._activePlugins)r.getActiveTextures(i.activeTextures);break}case 256:{let i=t;for(let r of this._activePlugins)r.getAnimatables(i.animatables);break}case 1024:{let i=t,r=!1;for(let n of this._activePlugins)if(r=n.hasTexture(i.texture),r)break;i.hasTexture=r;break}case 2:{let i=t;for(let r of this._plugins)r.dispose(i.forceDisposeTextures);break}case 4:{let i=t;i.defineNames=this._defineNamesFromPlugins;break}case 128:{let i=t;for(let r of this._activePlugins)i.fallbackRank=r.addFallbacks(i.defines,i.fallbacks,i.fallbackRank),r.getAttributes(i.attributes,this._scene,i.mesh);this._uniformList.length>0&&i.uniforms.push(...this._uniformList),this._samplerList.length>0&&i.samplers.push(...this._samplerList),this._uboList.length>0&&i.uniformBuffersNames.push(...this._uboList),i.customCode=this._injectCustomCode(i,i.customCode);break}case 8:{let i=t;this._uboDeclaration="",this._vertexDeclaration="",this._fragmentDeclaration="",this._uniformList=[],this._samplerList=[],this._uboList=[];let r=this._material.shaderLanguage===1;for(let n of this._plugins){let a=n.getUniforms(this._material.shaderLanguage);if(a){if(a.ubo)for(let o of a.ubo){if(o.size&&o.type){let l=o.arraySize??0;if(i.ubo.addUniform(o.name,o.size,l),r){let c;switch(o.type){case"mat4":c="mat4x4f";break;case"float":c="f32";break;default:c=`${o.type}f`;break}l>0?this._uboDeclaration+=`uniform ${o.name}: array<${c}, ${l}>;
`:this._uboDeclaration+=`uniform ${o.name}: ${c};
`}else this._uboDeclaration+=`${o.type} ${o.name}${l>0?`[${l}]`:""};
`}this._uniformList.push(o.name)}a.vertex&&(this._vertexDeclaration+=a.vertex+`
`),a.fragment&&(this._fragmentDeclaration+=a.fragment+`
`),a.externalUniforms&&this._uniformList.push(...a.externalUniforms)}n.getSamplers(this._samplerList),n.getUniformBuffersNames(this._uboList)}break}}}_collectPointNames(e,t){if(t)for(let i in t)this._codeInjectionPoints[e]||(this._codeInjectionPoints[e]={}),this._codeInjectionPoints[e][i]=!0}_injectCustomCode(e,t){return(i,r)=>{t&&(r=t(i,r)),this._uboDeclaration&&(r=r.replace("#define ADDITIONAL_UBO_DECLARATION",this._uboDeclaration)),this._vertexDeclaration&&(r=r.replace("#define ADDITIONAL_VERTEX_DECLARATION",this._vertexDeclaration)),this._fragmentDeclaration&&(r=r.replace("#define ADDITIONAL_FRAGMENT_DECLARATION",this._fragmentDeclaration));let n=this._codeInjectionPoints?.[i];if(!n)return r;let a=null;for(let o in n){let l="";for(let c of this._activePlugins){let f=c.getCustomCode(i,this._material.shaderLanguage)?.[o];f&&(c.resolveIncludes&&(a===null&&(a={defines:[],indexParameters:e.indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:void 0,supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:g.GetShadersRepository(0),includesShadersStore:g.GetIncludesShadersStore(0),version:void 0,platformName:this._engine.shaderPlatformName,processingContext:void 0,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:void 0}),a.isFragment=i==="fragment",yh(f,a,h=>f=h)),l+=f+`
`)}if(l.length>0)if(o.charAt(0)==="!"){o=o.substring(1);let c="g";if(o.charAt(0)==="!")c="",o=o.substring(1);else{let d=yJ.exec(o);d&&d.length>=2&&(c=d[1],o=o.substring(c.length+1))}c.indexOf("g")<0&&(c+="g");let f=r,h=new RegExp(o,c),u=h.exec(f);for(;u!==null;){let d=l;for(let p=0;p<u.length;++p)d=d.replace("$"+p,u[p]);r=r.replace(u[0],d),u=h.exec(f)}}else{let c="#define "+o;r=r.replace(c,`
`+l+`
`+c)}}return r}}};Mf._MaterialPluginClassToMainDefine={};Mf._MaterialPluginCounter=0;Z.OnEnginesDisposedObservable.add(()=>{DJ()});MJ=[],PJ=!1,D2=null});var hi,Ya=S(()=>{Ye();je();O2();ei();Te();hi=class{isCompatible(e){switch(e){case 0:return!0;default:return!1}}_enable(e){e&&this._pluginManager._activatePlugin(this)}constructor(e,t,i,r,n=!0,a=!1,o=!1){this.priority=500,this.resolveIncludes=!1,this.registerForExtraEvents=!1,this.doNotSerialize=!1,this._material=e,this.name=t,this.priority=i,this.resolveIncludes=o,e.pluginManager||(e.pluginManager=new Mf(e),e.onDisposeObservable.add(()=>{e.pluginManager=void 0})),this._pluginDefineNames=r,this._pluginManager=e.pluginManager,n&&this._pluginManager._addPlugin(this),a&&this._enable(!0),this.markAllDefinesAsDirty=e._dirtyCallbacks[127]}getClassName(){return"MaterialPluginBase"}isReadyForSubMesh(e,t,i,r){return!0}hardBindForSubMesh(e,t,i,r){}bindForSubMesh(e,t,i,r){}dispose(e){}getCustomCode(e,t=0){return null}collectDefines(e){if(this._pluginDefineNames)for(let t of Object.keys(this._pluginDefineNames)){if(t[0]==="_")continue;let i=typeof this._pluginDefineNames[t];e[t]={type:i==="number"?"number":i==="string"?"string":i==="boolean"?"boolean":"object",default:this._pluginDefineNames[t]}}}prepareDefinesBeforeAttributes(e,t,i){}prepareDefines(e,t,i){}hasTexture(e){return!1}hasRenderTargetTextures(){return!1}fillRenderTargetTextures(e){}getActiveTextures(e){}getAnimatables(e){}addFallbacks(e,t,i){return i}getSamplers(e){}getAttributes(e,t,i){}getUniformBuffersNames(e){}getUniforms(e=0){return{}}copyTo(e){_e.Clone(()=>e,this)}serialize(){return _e.Serialize(this)}parse(e,t,i){_e.Parse(()=>this,e,t,i)}};x([y()],hi.prototype,"name",void 0);x([y()],hi.prototype,"priority",void 0);x([y()],hi.prototype,"resolveIncludes",void 0);x([y()],hi.prototype,"registerForExtraEvents",void 0);G("BABYLON.MaterialPluginBase",hi)});var zC,pi,L2=S(()=>{Ye();je();fs();Ya();zC=class extends ri{constructor(){super(...arguments),this.BRDF_V_HEIGHT_CORRELATED=!1,this.MS_BRDF_ENERGY_CONSERVATION=!1,this.SPHERICAL_HARMONICS=!1,this.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=!1,this.MIX_IBL_RADIANCE_WITH_IRRADIANCE=!0,this.LEGACY_SPECULAR_ENERGY_CONSERVATION=!1,this.BASE_DIFFUSE_MODEL=0,this.DIELECTRIC_SPECULAR_MODEL=0,this.CONDUCTOR_SPECULAR_MODEL=0}},pi=class s extends hi{_markAllSubMeshesAsMiscDirty(){this._internalMarkAllSubMeshesAsMiscDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"PBRBRDF",90,new zC,t),this._useEnergyConservation=s.DEFAULT_USE_ENERGY_CONSERVATION,this.useEnergyConservation=s.DEFAULT_USE_ENERGY_CONSERVATION,this._useSmithVisibilityHeightCorrelated=s.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this.useSmithVisibilityHeightCorrelated=s.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this._useSphericalHarmonics=s.DEFAULT_USE_SPHERICAL_HARMONICS,this.useSphericalHarmonics=s.DEFAULT_USE_SPHERICAL_HARMONICS,this._useSpecularGlossinessInputEnergyConservation=s.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this.useSpecularGlossinessInputEnergyConservation=s.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this._mixIblRadianceWithIrradiance=s.DEFAULT_MIX_IBL_RADIANCE_WITH_IRRADIANCE,this.mixIblRadianceWithIrradiance=s.DEFAULT_MIX_IBL_RADIANCE_WITH_IRRADIANCE,this._useLegacySpecularEnergyConservation=s.DEFAULT_USE_LEGACY_SPECULAR_ENERGY_CONSERVATION,this.useLegacySpecularEnergyConservation=s.DEFAULT_USE_LEGACY_SPECULAR_ENERGY_CONSERVATION,this._baseDiffuseModel=s.DEFAULT_DIFFUSE_MODEL,this.baseDiffuseModel=s.DEFAULT_DIFFUSE_MODEL,this._dielectricSpecularModel=s.DEFAULT_DIELECTRIC_SPECULAR_MODEL,this.dielectricSpecularModel=s.DEFAULT_DIELECTRIC_SPECULAR_MODEL,this._conductorSpecularModel=s.DEFAULT_CONDUCTOR_SPECULAR_MODEL,this.conductorSpecularModel=s.DEFAULT_CONDUCTOR_SPECULAR_MODEL,this._internalMarkAllSubMeshesAsMiscDirty=e._dirtyCallbacks[16],this._enable(!0)}prepareDefines(e){e.BRDF_V_HEIGHT_CORRELATED=this._useSmithVisibilityHeightCorrelated,e.MS_BRDF_ENERGY_CONSERVATION=this._useEnergyConservation&&this._useSmithVisibilityHeightCorrelated,e.SPHERICAL_HARMONICS=this._useSphericalHarmonics,e.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=this._useSpecularGlossinessInputEnergyConservation,e.MIX_IBL_RADIANCE_WITH_IRRADIANCE=this._mixIblRadianceWithIrradiance,e.LEGACY_SPECULAR_ENERGY_CONSERVATION=this._useLegacySpecularEnergyConservation,e.BASE_DIFFUSE_MODEL=this._baseDiffuseModel,e.DIELECTRIC_SPECULAR_MODEL=this._dielectricSpecularModel,e.CONDUCTOR_SPECULAR_MODEL=this._conductorSpecularModel}getClassName(){return"PBRBRDFConfiguration"}};pi.DEFAULT_USE_ENERGY_CONSERVATION=!0;pi.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED=!0;pi.DEFAULT_USE_SPHERICAL_HARMONICS=!0;pi.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION=!0;pi.DEFAULT_MIX_IBL_RADIANCE_WITH_IRRADIANCE=!0;pi.DEFAULT_USE_LEGACY_SPECULAR_ENERGY_CONSERVATION=!0;pi.DEFAULT_DIFFUSE_MODEL=0;pi.DEFAULT_DIELECTRIC_SPECULAR_MODEL=0;pi.DEFAULT_CONDUCTOR_SPECULAR_MODEL=0;x([y(),z("_markAllSubMeshesAsMiscDirty")],pi.prototype,"useEnergyConservation",void 0);x([y(),z("_markAllSubMeshesAsMiscDirty")],pi.prototype,"useSmithVisibilityHeightCorrelated",void 0);x([y(),z("_markAllSubMeshesAsMiscDirty")],pi.prototype,"useSphericalHarmonics",void 0);x([y(),z("_markAllSubMeshesAsMiscDirty")],pi.prototype,"useSpecularGlossinessInputEnergyConservation",void 0);x([y(),z("_markAllSubMeshesAsMiscDirty")],pi.prototype,"mixIblRadianceWithIrradiance",void 0);x([y(),z("_markAllSubMeshesAsMiscDirty")],pi.prototype,"useLegacySpecularEnergyConservation",void 0);x([y("baseDiffuseModel"),z("_markAllSubMeshesAsMiscDirty")],pi.prototype,"baseDiffuseModel",void 0);x([y("dielectricSpecularModel"),z("_markAllSubMeshesAsMiscDirty")],pi.prototype,"dielectricSpecularModel",void 0);x([y("conductorSpecularModel"),z("_markAllSubMeshesAsMiscDirty")],pi.prototype,"conductorSpecularModel",void 0)});var Qn,XC=S(()=>{Qn=class{constructor(){this.previousWorldMatrices={},this.previousBones={}}static AddUniforms(e){e.push("previousWorld","previousViewProjection","mPreviousBones")}static AddSamplers(e){}bindForSubMesh(e,t,i,r,n){if(t.prePassRenderer&&t.prePassRenderer.enabled&&t.prePassRenderer.currentRTisSceneRT&&(t.prePassRenderer.getIndex(2)!==-1||t.prePassRenderer.getIndex(11)!==-1)){this.previousWorldMatrices[i.uniqueId]||(this.previousWorldMatrices[i.uniqueId]=r.clone()),this.previousViewProjection||(this.previousViewProjection=t.getTransformMatrix().clone(),this.currentViewProjection=t.getTransformMatrix().clone());let a=t.getEngine();this.currentViewProjection.updateFlag!==t.getTransformMatrix().updateFlag?(this._lastUpdateFrameId=a.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection),this.currentViewProjection.copyFrom(t.getTransformMatrix())):this._lastUpdateFrameId!==a.frameId&&(this._lastUpdateFrameId=a.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection)),e.setMatrix("previousWorld",this.previousWorldMatrices[i.uniqueId]),e.setMatrix("previousViewProjection",this.previousViewProjection),this.previousWorldMatrices[i.uniqueId]=r.clone()}}}});var YC,Oi,w2=S(()=>{Ye();je();it();fn();Ya();fs();Xi();YC=class extends ri{constructor(){super(...arguments),this.CLEARCOAT=!1,this.CLEARCOAT_DEFAULTIOR=!1,this.CLEARCOAT_TEXTURE=!1,this.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this.CLEARCOAT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,this.CLEARCOAT_BUMP=!1,this.CLEARCOAT_BUMPDIRECTUV=0,this.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,this.CLEARCOAT_REMAP_F0=!1,this.CLEARCOAT_TINT=!1,this.CLEARCOAT_TINT_TEXTURE=!1,this.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TINT_GAMMATEXTURE=!1}},Oi=class s extends hi{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"PBRClearCoat",100,new YC,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.roughness=0,this._indexOfRefraction=s._DefaultIndexOfRefraction,this.indexOfRefraction=s._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._textureRoughness=null,this.textureRoughness=null,this._remapF0OnInterfaceChange=!0,this.remapF0OnInterfaceChange=!0,this._bumpTexture=null,this.bumpTexture=null,this._isTintEnabled=!1,this.isTintEnabled=!1,this.tintColor=j.White(),this.tintColorAtDistance=1,this.tintThickness=1,this._tintTexture=null,this.tintTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i){if(!this._isEnabled)return!0;let r=this._material._disableBumpMap;return!(e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&X.ClearCoatTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._textureRoughness&&X.ClearCoatTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking()||i.getCaps().standardDerivatives&&this._bumpTexture&&X.ClearCoatBumpTextureEnabled&&!r&&!this._bumpTexture.isReady()||this._isTintEnabled&&this._tintTexture&&X.ClearCoatTintTextureEnabled&&!this._tintTexture.isReadyOrNotBlocking()))}prepareDefinesBeforeAttributes(e,t){this._isEnabled?(e.CLEARCOAT=!0,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e.CLEARCOAT_REMAP_F0=this._remapF0OnInterfaceChange,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&X.ClearCoatTextureEnabled?lt(this._texture,e,"CLEARCOAT_TEXTURE"):e.CLEARCOAT_TEXTURE=!1,this._textureRoughness&&X.ClearCoatTextureEnabled?lt(this._textureRoughness,e,"CLEARCOAT_TEXTURE_ROUGHNESS"):e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this._bumpTexture&&X.ClearCoatBumpTextureEnabled?lt(this._bumpTexture,e,"CLEARCOAT_BUMP"):e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_DEFAULTIOR=this._indexOfRefraction===s._DefaultIndexOfRefraction,this._isTintEnabled?(e.CLEARCOAT_TINT=!0,this._tintTexture&&X.ClearCoatTintTextureEnabled?(lt(this._tintTexture,e,"CLEARCOAT_TINT_TEXTURE"),e.CLEARCOAT_TINT_GAMMATEXTURE=this._tintTexture.gammaSpace):e.CLEARCOAT_TINT_TEXTURE=!1):(e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1))):(e.CLEARCOAT=!1,e.CLEARCOAT_TEXTURE=!1,e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.CLEARCOAT_DEFAULTIOR=!1,e.CLEARCOAT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,e.CLEARCOAT_BUMPDIRECTUV=0,e.CLEARCOAT_REMAP_F0=!1,e.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TINT_GAMMATEXTURE=!1)}bindForSubMesh(e,t,i,r){if(!this._isEnabled)return;let n=r.materialDefines,a=this._material.isFrozen,o=this._material._disableBumpMap,l=this._material._invertNormalMapX,c=this._material._invertNormalMapY;if(!e.useUbo||!a||!e.isSync){(this._texture||this._textureRoughness)&&X.ClearCoatTextureEnabled&&(e.updateFloat4("vClearCoatInfos",this._texture?.coordinatesIndex??0,this._texture?.level??0,this._textureRoughness?.coordinatesIndex??0,this._textureRoughness?.level??0),this._texture&&ct(this._texture,e,"clearCoat"),this._textureRoughness&&!n.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&ct(this._textureRoughness,e,"clearCoatRoughness")),this._bumpTexture&&i.getCaps().standardDerivatives&&X.ClearCoatTextureEnabled&&!o&&(e.updateFloat2("vClearCoatBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level),ct(this._bumpTexture,e,"clearCoatBump"),t._mirroredCameraPosition?e.updateFloat2("vClearCoatTangentSpaceParams",l?1:-1,c?1:-1):e.updateFloat2("vClearCoatTangentSpaceParams",l?-1:1,c?-1:1)),this._tintTexture&&X.ClearCoatTintTextureEnabled&&(e.updateFloat2("vClearCoatTintInfos",this._tintTexture.coordinatesIndex,this._tintTexture.level),ct(this._tintTexture,e,"clearCoatTint")),e.updateFloat2("vClearCoatParams",this.intensity,this.roughness);let f=1-this._indexOfRefraction,h=1+this._indexOfRefraction,u=Math.pow(-f/h,2),d=1/this._indexOfRefraction;e.updateFloat4("vClearCoatRefractionParams",u,d,f,h),this._isTintEnabled&&(e.updateFloat4("vClearCoatTintParams",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintThickness)),e.updateFloat("clearCoatColorAtDistance",Math.max(1e-5,this.tintColorAtDistance)))}t.texturesEnabled&&(this._texture&&X.ClearCoatTextureEnabled&&e.setTexture("clearCoatSampler",this._texture),this._textureRoughness&&!n.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&X.ClearCoatTextureEnabled&&e.setTexture("clearCoatRoughnessSampler",this._textureRoughness),this._bumpTexture&&i.getCaps().standardDerivatives&&X.ClearCoatBumpTextureEnabled&&!o&&e.setTexture("clearCoatBumpSampler",this._bumpTexture),this._isTintEnabled&&this._tintTexture&&X.ClearCoatTintTextureEnabled&&e.setTexture("clearCoatTintSampler",this._tintTexture))}hasTexture(e){return this._texture===e||this._textureRoughness===e||this._bumpTexture===e||this._tintTexture===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness),this._bumpTexture&&e.push(this._bumpTexture),this._tintTexture&&e.push(this._tintTexture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._tintTexture&&this._tintTexture.animations&&this._tintTexture.animations.length>0&&e.push(this._tintTexture)}dispose(e){e&&(this._texture?.dispose(),this._textureRoughness?.dispose(),this._bumpTexture?.dispose(),this._tintTexture?.dispose())}getClassName(){return"PBRClearCoatConfiguration"}addFallbacks(e,t,i){return e.CLEARCOAT_BUMP&&t.addFallback(i++,"CLEARCOAT_BUMP"),e.CLEARCOAT_TINT&&t.addFallback(i++,"CLEARCOAT_TINT"),e.CLEARCOAT&&t.addFallback(i++,"CLEARCOAT"),i}getSamplers(e){e.push("clearCoatSampler","clearCoatRoughnessSampler","clearCoatBumpSampler","clearCoatTintSampler")}getUniforms(){return{ubo:[{name:"vClearCoatParams",size:2,type:"vec2"},{name:"vClearCoatRefractionParams",size:4,type:"vec4"},{name:"vClearCoatInfos",size:4,type:"vec4"},{name:"clearCoatMatrix",size:16,type:"mat4"},{name:"clearCoatRoughnessMatrix",size:16,type:"mat4"},{name:"vClearCoatBumpInfos",size:2,type:"vec2"},{name:"vClearCoatTangentSpaceParams",size:2,type:"vec2"},{name:"clearCoatBumpMatrix",size:16,type:"mat4"},{name:"vClearCoatTintParams",size:4,type:"vec4"},{name:"clearCoatColorAtDistance",size:1,type:"float"},{name:"vClearCoatTintInfos",size:2,type:"vec2"},{name:"clearCoatTintMatrix",size:16,type:"mat4"}]}}};Oi._DefaultIndexOfRefraction=1.5;x([y(),z("_markAllSubMeshesAsTexturesDirty")],Oi.prototype,"isEnabled",void 0);x([y()],Oi.prototype,"intensity",void 0);x([y()],Oi.prototype,"roughness",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],Oi.prototype,"indexOfRefraction",void 0);x([He(),z("_markAllSubMeshesAsTexturesDirty")],Oi.prototype,"texture",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],Oi.prototype,"useRoughnessFromMainTexture",void 0);x([He(),z("_markAllSubMeshesAsTexturesDirty")],Oi.prototype,"textureRoughness",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],Oi.prototype,"remapF0OnInterfaceChange",void 0);x([He(),z("_markAllSubMeshesAsTexturesDirty")],Oi.prototype,"bumpTexture",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],Oi.prototype,"isTintEnabled",void 0);x([zt()],Oi.prototype,"tintColor",void 0);x([y()],Oi.prototype,"tintColorAtDistance",void 0);x([y()],Oi.prototype,"tintThickness",void 0);x([He(),z("_markAllSubMeshesAsTexturesDirty")],Oi.prototype,"tintTexture",void 0)});var KC,qr,F2=S(()=>{Ye();je();fn();Ya();fs();Xi();KC=class extends ri{constructor(){super(...arguments),this.IRIDESCENCE=!1,this.IRIDESCENCE_TEXTURE=!1,this.IRIDESCENCE_TEXTUREDIRECTUV=0,this.IRIDESCENCE_THICKNESS_TEXTURE=!1,this.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0}},qr=class s extends hi{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"PBRIridescence",110,new KC,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.minimumThickness=s._DefaultMinimumThickness,this.maximumThickness=s._DefaultMaximumThickness,this.indexOfRefraction=s._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._thicknessTexture=null,this.thicknessTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&X.IridescenceTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._thicknessTexture&&X.IridescenceTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking())):!0}prepareDefinesBeforeAttributes(e,t){this._isEnabled?(e.IRIDESCENCE=!0,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&X.IridescenceTextureEnabled?lt(this._texture,e,"IRIDESCENCE_TEXTURE"):e.IRIDESCENCE_TEXTURE=!1,this._thicknessTexture&&X.IridescenceTextureEnabled?lt(this._thicknessTexture,e,"IRIDESCENCE_THICKNESS_TEXTURE"):e.IRIDESCENCE_THICKNESS_TEXTURE=!1)):(e.IRIDESCENCE=!1,e.IRIDESCENCE_TEXTURE=!1,e.IRIDESCENCE_THICKNESS_TEXTURE=!1,e.IRIDESCENCE_TEXTUREDIRECTUV=0,e.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0)}bindForSubMesh(e,t){if(!this._isEnabled)return;let i=this._material.isFrozen;(!e.useUbo||!i||!e.isSync)&&((this._texture||this._thicknessTexture)&&X.IridescenceTextureEnabled&&(e.updateFloat4("vIridescenceInfos",this._texture?.coordinatesIndex??0,this._texture?.level??0,this._thicknessTexture?.coordinatesIndex??0,this._thicknessTexture?.level??0),this._texture&&ct(this._texture,e,"iridescence"),this._thicknessTexture&&ct(this._thicknessTexture,e,"iridescenceThickness")),e.updateFloat4("vIridescenceParams",this.intensity,this.indexOfRefraction,this.minimumThickness,this.maximumThickness)),t.texturesEnabled&&(this._texture&&X.IridescenceTextureEnabled&&e.setTexture("iridescenceSampler",this._texture),this._thicknessTexture&&X.IridescenceTextureEnabled&&e.setTexture("iridescenceThicknessSampler",this._thicknessTexture))}hasTexture(e){return this._texture===e||this._thicknessTexture===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._thicknessTexture&&e.push(this._thicknessTexture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture)}dispose(e){e&&(this._texture?.dispose(),this._thicknessTexture?.dispose())}getClassName(){return"PBRIridescenceConfiguration"}addFallbacks(e,t,i){return e.IRIDESCENCE&&t.addFallback(i++,"IRIDESCENCE"),i}getSamplers(e){e.push("iridescenceSampler","iridescenceThicknessSampler")}getUniforms(){return{ubo:[{name:"vIridescenceParams",size:4,type:"vec4"},{name:"vIridescenceInfos",size:4,type:"vec4"},{name:"iridescenceMatrix",size:16,type:"mat4"},{name:"iridescenceThicknessMatrix",size:16,type:"mat4"}]}}};qr._DefaultMinimumThickness=100;qr._DefaultMaximumThickness=400;qr._DefaultIndexOfRefraction=1.3;x([y(),z("_markAllSubMeshesAsTexturesDirty")],qr.prototype,"isEnabled",void 0);x([y()],qr.prototype,"intensity",void 0);x([y()],qr.prototype,"minimumThickness",void 0);x([y()],qr.prototype,"maximumThickness",void 0);x([y()],qr.prototype,"indexOfRefraction",void 0);x([He(),z("_markAllSubMeshesAsTexturesDirty")],qr.prototype,"texture",void 0);x([He(),z("_markAllSubMeshesAsTexturesDirty")],qr.prototype,"thicknessTexture",void 0)});var qC,Ka,N2=S(()=>{Ye();je();yt();ie();fn();Ya();fs();Xi();qC=class extends ri{constructor(){super(...arguments),this.ANISOTROPIC=!1,this.ANISOTROPIC_TEXTURE=!1,this.ANISOTROPIC_TEXTUREDIRECTUV=0,this.ANISOTROPIC_LEGACY=!1,this.MAINUV1=!1}},Ka=class extends hi{set angle(e){this.direction.x=Math.cos(e),this.direction.y=Math.sin(e)}get angle(){return Math.atan2(this.direction.y,this.direction.x)}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}_markAllSubMeshesAsMiscDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsMiscDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"PBRAnisotropic",110,new qC,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.direction=new he(1,0),this._texture=null,this.texture=null,this._legacy=!1,this.legacy=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._internalMarkAllSubMeshesAsMiscDirty=e._dirtyCallbacks[16]}isReadyForSubMesh(e,t){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&this._texture&&X.AnisotropicTextureEnabled&&!this._texture.isReadyOrNotBlocking()):!0}prepareDefinesBeforeAttributes(e,t,i){this._isEnabled?(e.ANISOTROPIC=this._isEnabled,this._isEnabled&&!i.isVerticesDataPresent(A.TangentKind)&&(e._needUVs=!0,e.MAINUV1=!0),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&X.AnisotropicTextureEnabled?lt(this._texture,e,"ANISOTROPIC_TEXTURE"):e.ANISOTROPIC_TEXTURE=!1),e._areMiscDirty&&(e.ANISOTROPIC_LEGACY=this._legacy)):(e.ANISOTROPIC=!1,e.ANISOTROPIC_TEXTURE=!1,e.ANISOTROPIC_TEXTUREDIRECTUV=0,e.ANISOTROPIC_LEGACY=!1)}bindForSubMesh(e,t){if(!this._isEnabled)return;let i=this._material.isFrozen;(!e.useUbo||!i||!e.isSync)&&(this._texture&&X.AnisotropicTextureEnabled&&(e.updateFloat2("vAnisotropyInfos",this._texture.coordinatesIndex,this._texture.level),ct(this._texture,e,"anisotropy")),e.updateFloat3("vAnisotropy",this.direction.x,this.direction.y,this.intensity)),t.texturesEnabled&&this._texture&&X.AnisotropicTextureEnabled&&e.setTexture("anisotropySampler",this._texture)}hasTexture(e){return this._texture===e}getActiveTextures(e){this._texture&&e.push(this._texture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)}dispose(e){e&&this._texture&&this._texture.dispose()}getClassName(){return"PBRAnisotropicConfiguration"}addFallbacks(e,t,i){return e.ANISOTROPIC&&t.addFallback(i++,"ANISOTROPIC"),i}getSamplers(e){e.push("anisotropySampler")}getUniforms(){return{ubo:[{name:"vAnisotropy",size:3,type:"vec3"},{name:"vAnisotropyInfos",size:2,type:"vec2"},{name:"anisotropyMatrix",size:16,type:"mat4"}]}}parse(e,t,i){super.parse(e,t,i),e.legacy===void 0&&(this.legacy=!0)}};x([y(),z("_markAllSubMeshesAsTexturesDirty")],Ka.prototype,"isEnabled",void 0);x([y()],Ka.prototype,"intensity",void 0);x([vc()],Ka.prototype,"direction",void 0);x([He(),z("_markAllSubMeshesAsTexturesDirty")],Ka.prototype,"texture",void 0);x([y(),z("_markAllSubMeshesAsMiscDirty")],Ka.prototype,"legacy",void 0)});var QC,hs,B2=S(()=>{Ye();je();it();fn();Ya();fs();Xi();QC=class extends ri{constructor(){super(...arguments),this.SHEEN=!1,this.SHEEN_TEXTURE=!1,this.SHEEN_GAMMATEXTURE=!1,this.SHEEN_TEXTURE_ROUGHNESS=!1,this.SHEEN_TEXTUREDIRECTUV=0,this.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0,this.SHEEN_LINKWITHALBEDO=!1,this.SHEEN_ROUGHNESS=!1,this.SHEEN_ALBEDOSCALING=!1,this.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1}},hs=class extends hi{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"Sheen",120,new QC,t),this._isEnabled=!1,this.isEnabled=!1,this._linkSheenWithAlbedo=!1,this.linkSheenWithAlbedo=!1,this.intensity=1,this.color=j.White(),this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._roughness=null,this.roughness=null,this._textureRoughness=null,this.textureRoughness=null,this._albedoScaling=!1,this.albedoScaling=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&X.SheenTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._textureRoughness&&X.SheenTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking())):!0}prepareDefinesBeforeAttributes(e,t){this._isEnabled?(e.SHEEN=!0,e.SHEEN_LINKWITHALBEDO=this._linkSheenWithAlbedo,e.SHEEN_ROUGHNESS=this._roughness!==null,e.SHEEN_ALBEDOSCALING=this._albedoScaling,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&X.SheenTextureEnabled?(lt(this._texture,e,"SHEEN_TEXTURE"),e.SHEEN_GAMMATEXTURE=this._texture.gammaSpace):e.SHEEN_TEXTURE=!1,this._textureRoughness&&X.SheenTextureEnabled?lt(this._textureRoughness,e,"SHEEN_TEXTURE_ROUGHNESS"):e.SHEEN_TEXTURE_ROUGHNESS=!1)):(e.SHEEN=!1,e.SHEEN_TEXTURE=!1,e.SHEEN_TEXTURE_ROUGHNESS=!1,e.SHEEN_LINKWITHALBEDO=!1,e.SHEEN_ROUGHNESS=!1,e.SHEEN_ALBEDOSCALING=!1,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.SHEEN_GAMMATEXTURE=!1,e.SHEEN_TEXTUREDIRECTUV=0,e.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0)}bindForSubMesh(e,t,i,r){if(!this._isEnabled)return;let n=r.materialDefines,a=this._material.isFrozen;(!e.useUbo||!a||!e.isSync)&&((this._texture||this._textureRoughness)&&X.SheenTextureEnabled&&(e.updateFloat4("vSheenInfos",this._texture?.coordinatesIndex??0,this._texture?.level??0,this._textureRoughness?.coordinatesIndex??0,this._textureRoughness?.level??0),this._texture&&ct(this._texture,e,"sheen"),this._textureRoughness&&!n.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&ct(this._textureRoughness,e,"sheenRoughness")),e.updateFloat4("vSheenColor",this.color.r,this.color.g,this.color.b,this.intensity),this._roughness!==null&&e.updateFloat("vSheenRoughness",this._roughness)),t.texturesEnabled&&(this._texture&&X.SheenTextureEnabled&&e.setTexture("sheenSampler",this._texture),this._textureRoughness&&!n.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&X.SheenTextureEnabled&&e.setTexture("sheenRoughnessSampler",this._textureRoughness))}hasTexture(e){return this._texture===e||this._textureRoughness===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness)}dispose(e){e&&(this._texture?.dispose(),this._textureRoughness?.dispose())}getClassName(){return"PBRSheenConfiguration"}addFallbacks(e,t,i){return e.SHEEN&&t.addFallback(i++,"SHEEN"),i}getSamplers(e){e.push("sheenSampler","sheenRoughnessSampler")}getUniforms(){return{ubo:[{name:"vSheenColor",size:4,type:"vec4"},{name:"vSheenRoughness",size:1,type:"float"},{name:"vSheenInfos",size:4,type:"vec4"},{name:"sheenMatrix",size:16,type:"mat4"},{name:"sheenRoughnessMatrix",size:16,type:"mat4"}]}}};x([y(),z("_markAllSubMeshesAsTexturesDirty")],hs.prototype,"isEnabled",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],hs.prototype,"linkSheenWithAlbedo",void 0);x([y()],hs.prototype,"intensity",void 0);x([zt()],hs.prototype,"color",void 0);x([He(),z("_markAllSubMeshesAsTexturesDirty")],hs.prototype,"texture",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],hs.prototype,"useRoughnessFromMainTexture",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],hs.prototype,"roughness",void 0);x([He(),z("_markAllSubMeshesAsTexturesDirty")],hs.prototype,"textureRoughness",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],hs.prototype,"albedoScaling",void 0)});var jC,Tt,U2=S(()=>{Ye();je();it();fn();ie();Ya();fs();Xi();jC=class extends ri{constructor(){super(...arguments),this.SUBSURFACE=!1,this.SS_REFRACTION=!1,this.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=!1,this.SS_TRANSLUCENCY=!1,this.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=!1,this.SS_SCATTERING=!1,this.SS_DISPERSION=!1,this.SS_THICKNESSANDMASK_TEXTURE=!1,this.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,this.SS_HAS_THICKNESS=!1,this.SS_REFRACTIONINTENSITY_TEXTURE=!1,this.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,this.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,this.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,this.SS_TRANSLUCENCYCOLOR_TEXTURE=!1,this.SS_TRANSLUCENCYCOLOR_TEXTUREDIRECTUV=0,this.SS_TRANSLUCENCYCOLOR_TEXTURE_GAMMA=!1,this.SS_REFRACTIONMAP_3D=!1,this.SS_REFRACTIONMAP_OPPOSITEZ=!1,this.SS_LODINREFRACTIONALPHA=!1,this.SS_GAMMAREFRACTION=!1,this.SS_RGBDREFRACTION=!1,this.SS_LINEARSPECULARREFRACTION=!1,this.SS_LINKREFRACTIONTOTRANSPARENCY=!1,this.SS_ALBEDOFORREFRACTIONTINT=!1,this.SS_ALBEDOFORTRANSLUCENCYTINT=!1,this.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.SS_USE_THICKNESS_AS_DEPTH=!1,this.SS_USE_GLTF_TEXTURES=!1,this.SS_APPLY_ALBEDO_AFTER_SUBSURFACE=!1,this.SS_TRANSLUCENCY_LEGACY=!1}},Tt=class s extends hi{get scatteringDiffusionProfile(){return this._scene.subSurfaceConfiguration?this._scene.subSurfaceConfiguration.ssDiffusionProfileColors[this._scatteringDiffusionProfileIndex]:null}set scatteringDiffusionProfile(e){this._scene.enableSubSurfaceForPrePass()&&e&&(this._scatteringDiffusionProfileIndex=this._scene.subSurfaceConfiguration.addDiffusionProfile(e))}get volumeIndexOfRefraction(){return this._volumeIndexOfRefraction>=1?this._volumeIndexOfRefraction:this._indexOfRefraction}set volumeIndexOfRefraction(e){e>=1?this._volumeIndexOfRefraction=e:this._volumeIndexOfRefraction=-1}get legacyTransluceny(){return this.legacyTranslucency}set legacyTransluceny(e){this.legacyTranslucency=e}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isRefractionEnabled||this._isTranslucencyEnabled||this._isScatteringEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}_markScenePrePassDirty(){this._enable(this._isRefractionEnabled||this._isTranslucencyEnabled||this._isScatteringEnabled),this._internalMarkAllSubMeshesAsTexturesDirty(),this._internalMarkScenePrePassDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"PBRSubSurface",130,new jC,t),this._isRefractionEnabled=!1,this.isRefractionEnabled=!1,this._isTranslucencyEnabled=!1,this.isTranslucencyEnabled=!1,this._isDispersionEnabled=!1,this.isDispersionEnabled=!1,this._isScatteringEnabled=!1,this.isScatteringEnabled=!1,this._scatteringDiffusionProfileIndex=0,this.refractionIntensity=1,this.translucencyIntensity=1,this.useAlbedoToTintRefraction=!1,this.useAlbedoToTintTranslucency=!1,this._thicknessTexture=null,this.thicknessTexture=null,this._refractionTexture=null,this.refractionTexture=null,this._indexOfRefraction=1.5,this.indexOfRefraction=1.5,this._volumeIndexOfRefraction=-1,this._invertRefractionY=!1,this.invertRefractionY=!1,this._linkRefractionWithTransparency=!1,this.linkRefractionWithTransparency=!1,this.minimumThickness=0,this.maximumThickness=1,this.useThicknessAsDepth=!1,this.tintColor=j.White(),this.tintColorAtDistance=1,this.dispersion=0,this.diffusionDistance=j.White(),this._useMaskFromThicknessTexture=!1,this.useMaskFromThicknessTexture=!1,this._refractionIntensityTexture=null,this.refractionIntensityTexture=null,this._translucencyIntensityTexture=null,this.translucencyIntensityTexture=null,this.translucencyColor=null,this._translucencyColorTexture=null,this.translucencyColorTexture=null,this._useGltfStyleTextures=!0,this.useGltfStyleTextures=!0,this.applyAlbedoAfterSubSurface=s.DEFAULT_APPLY_ALBEDO_AFTERSUBSURFACE,this.legacyTranslucency=s.DEFAULT_LEGACY_TRANSLUCENCY,this._scene=e.getScene(),this.registerForExtraEvents=!0,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._internalMarkScenePrePassDirty=e._dirtyCallbacks[32]}isReadyForSubMesh(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return!0;if(e._areTexturesDirty&&t.texturesEnabled){if(this._thicknessTexture&&X.ThicknessTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking()||this._refractionIntensityTexture&&X.RefractionIntensityTextureEnabled&&!this._refractionIntensityTexture.isReadyOrNotBlocking()||this._translucencyColorTexture&&X.TranslucencyColorTextureEnabled&&!this._translucencyColorTexture.isReadyOrNotBlocking()||this._translucencyIntensityTexture&&X.TranslucencyIntensityTextureEnabled&&!this._translucencyIntensityTexture.isReadyOrNotBlocking())return!1;let i=this._getRefractionTexture(t);if(i&&X.RefractionTextureEnabled&&!i.isReadyOrNotBlocking())return!1}return!0}prepareDefinesBeforeAttributes(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled){e.SUBSURFACE=!1,e.SS_DISPERSION=!1,e.SS_TRANSLUCENCY=!1,e.SS_SCATTERING=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=!1,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=!1,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,e.SS_HAS_THICKNESS=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,e.SS_REFRACTIONMAP_3D=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1,e.SS_USE_GLTF_TEXTURES=!1,e.SS_TRANSLUCENCYCOLOR_TEXTURE=!1,e.SS_TRANSLUCENCYCOLOR_TEXTUREDIRECTUV=0,e.SS_TRANSLUCENCYCOLOR_TEXTURE_GAMMA=!1,e.SS_APPLY_ALBEDO_AFTER_SUBSURFACE=!1;return}if(e._areTexturesDirty){if(e.SUBSURFACE=!0,e.SS_DISPERSION=this._isDispersionEnabled,e.SS_TRANSLUCENCY=this._isTranslucencyEnabled,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=!1,e.SS_TRANSLUCENCY_LEGACY=this.legacyTranslucency,e.SS_SCATTERING=this._isScatteringEnabled,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_HAS_THICKNESS=!1,e.SS_USE_GLTF_TEXTURES=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=!1,e.SS_REFRACTIONMAP_3D=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1,e.SS_TRANSLUCENCYCOLOR_TEXTURE=!1,e.SS_APPLY_ALBEDO_AFTER_SUBSURFACE=this.applyAlbedoAfterSubSurface,e._areTexturesDirty&&t.texturesEnabled&&(this._thicknessTexture&&X.ThicknessTextureEnabled&&lt(this._thicknessTexture,e,"SS_THICKNESSANDMASK_TEXTURE"),this._refractionIntensityTexture&&X.RefractionIntensityTextureEnabled&&lt(this._refractionIntensityTexture,e,"SS_REFRACTIONINTENSITY_TEXTURE"),this._translucencyIntensityTexture&&X.TranslucencyIntensityTextureEnabled&&lt(this._translucencyIntensityTexture,e,"SS_TRANSLUCENCYINTENSITY_TEXTURE"),this._translucencyColorTexture&&X.TranslucencyColorTextureEnabled&&(lt(this._translucencyColorTexture,e,"SS_TRANSLUCENCYCOLOR_TEXTURE"),e.SS_TRANSLUCENCYCOLOR_TEXTURE_GAMMA=this._translucencyColorTexture.gammaSpace)),e.SS_HAS_THICKNESS=this.maximumThickness-this.minimumThickness!==0,e.SS_USE_GLTF_TEXTURES=this._useGltfStyleTextures,e.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=this._useMaskFromThicknessTexture&&!this._refractionIntensityTexture,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=this._useMaskFromThicknessTexture&&!this._translucencyIntensityTexture,this._isRefractionEnabled&&t.texturesEnabled){let i=this._getRefractionTexture(t);i&&X.RefractionTextureEnabled&&(e.SS_REFRACTION=!0,e.SS_REFRACTIONMAP_3D=i.isCube,e.SS_GAMMAREFRACTION=i.gammaSpace,e.SS_RGBDREFRACTION=i.isRGBD,e.SS_LINEARSPECULARREFRACTION=i.linearSpecularLOD,e.SS_REFRACTIONMAP_OPPOSITEZ=this._scene.useRightHandedSystem&&i.isCube?!i.invertZ:i.invertZ,e.SS_LODINREFRACTIONALPHA=i.lodLevelInAlpha,e.SS_LINKREFRACTIONTOTRANSPARENCY=this._linkRefractionWithTransparency,e.SS_ALBEDOFORREFRACTIONTINT=this.useAlbedoToTintRefraction,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=i.isCube&&i.boundingBoxSize,e.SS_USE_THICKNESS_AS_DEPTH=this.useThicknessAsDepth)}this._isTranslucencyEnabled&&(e.SS_ALBEDOFORTRANSLUCENCYTINT=this.useAlbedoToTintTranslucency)}}hardBindForSubMesh(e,t,i,r){if(!(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled))if(this.maximumThickness===0&&this.minimumThickness===0)e.updateFloat2("vThicknessParam",0,0);else{r.getRenderingMesh().getWorldMatrix().decompose(w.Vector3[0]);let n=Math.max(Math.abs(w.Vector3[0].x),Math.abs(w.Vector3[0].y),Math.abs(w.Vector3[0].z));e.updateFloat2("vThicknessParam",this.minimumThickness*n,(this.maximumThickness-this.minimumThickness)*n)}}bindForSubMesh(e,t,i,r){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return;let n=r.materialDefines,a=this._material.isFrozen,o=this._material.realTimeFiltering,l=n.LODBASEDMICROSFURACE,c=this._getRefractionTexture(t);if(!e.useUbo||!a||!e.isSync){if(this._thicknessTexture&&X.ThicknessTextureEnabled&&(e.updateFloat2("vThicknessInfos",this._thicknessTexture.coordinatesIndex,this._thicknessTexture.level),ct(this._thicknessTexture,e,"thickness")),this._refractionIntensityTexture&&X.RefractionIntensityTextureEnabled&&n.SS_REFRACTIONINTENSITY_TEXTURE&&(e.updateFloat2("vRefractionIntensityInfos",this._refractionIntensityTexture.coordinatesIndex,this._refractionIntensityTexture.level),ct(this._refractionIntensityTexture,e,"refractionIntensity")),this._translucencyColorTexture&&X.TranslucencyColorTextureEnabled&&n.SS_TRANSLUCENCYCOLOR_TEXTURE&&(e.updateFloat2("vTranslucencyColorInfos",this._translucencyColorTexture.coordinatesIndex,this._translucencyColorTexture.level),ct(this._translucencyColorTexture,e,"translucencyColor")),this._translucencyIntensityTexture&&X.TranslucencyIntensityTextureEnabled&&n.SS_TRANSLUCENCYINTENSITY_TEXTURE&&(e.updateFloat2("vTranslucencyIntensityInfos",this._translucencyIntensityTexture.coordinatesIndex,this._translucencyIntensityTexture.level),ct(this._translucencyIntensityTexture,e,"translucencyIntensity")),c&&X.RefractionTextureEnabled){e.updateMatrix("refractionMatrix",c.getRefractionTextureMatrix());let f=1;c.isCube||c.depth&&(f=c.depth);let h=c.getSize().width,u=this.volumeIndexOfRefraction;if(e.updateFloat4("vRefractionInfos",c.level,1/u,f,this._invertRefractionY?-1:1),e.updateFloat4("vRefractionMicrosurfaceInfos",h,c.lodGenerationScale,c.lodGenerationOffset,1/this.indexOfRefraction),o&&e.updateFloat2("vRefractionFilteringInfo",h,Math.log2(h)),c.boundingBoxSize){let d=c;e.updateVector3("vRefractionPosition",d.boundingBoxPosition),e.updateVector3("vRefractionSize",d.boundingBoxSize)}}this._isScatteringEnabled&&e.updateFloat("scatteringDiffusionProfile",this._scatteringDiffusionProfileIndex),e.updateColor3("vDiffusionDistance",this.diffusionDistance),e.updateFloat4("vTintColor",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintColorAtDistance)),e.updateColor4("vTranslucencyColor",this.translucencyColor??this.tintColor,0),e.updateFloat3("vSubSurfaceIntensity",this.refractionIntensity,this.translucencyIntensity,0),e.updateFloat("dispersion",this.dispersion)}t.texturesEnabled&&(this._thicknessTexture&&X.ThicknessTextureEnabled&&e.setTexture("thicknessSampler",this._thicknessTexture),this._refractionIntensityTexture&&X.RefractionIntensityTextureEnabled&&n.SS_REFRACTIONINTENSITY_TEXTURE&&e.setTexture("refractionIntensitySampler",this._refractionIntensityTexture),this._translucencyIntensityTexture&&X.TranslucencyIntensityTextureEnabled&&n.SS_TRANSLUCENCYINTENSITY_TEXTURE&&e.setTexture("translucencyIntensitySampler",this._translucencyIntensityTexture),this._translucencyColorTexture&&X.TranslucencyColorTextureEnabled&&n.SS_TRANSLUCENCYCOLOR_TEXTURE&&e.setTexture("translucencyColorSampler",this._translucencyColorTexture),c&&X.RefractionTextureEnabled&&(l?e.setTexture("refractionSampler",c):(e.setTexture("refractionSampler",c._lodTextureMid||c),e.setTexture("refractionSamplerLow",c._lodTextureLow||c),e.setTexture("refractionSamplerHigh",c._lodTextureHigh||c))))}_getRefractionTexture(e){return this._refractionTexture?this._refractionTexture:this._isRefractionEnabled?e.environmentTexture:null}get disableAlphaBlending(){return this._isRefractionEnabled&&this._linkRefractionWithTransparency}fillRenderTargetTextures(e){X.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&e.push(this._refractionTexture)}hasTexture(e){return this._thicknessTexture===e||this._refractionTexture===e||this._refractionIntensityTexture===e||this._translucencyIntensityTexture===e||this._translucencyColorTexture===e}hasRenderTargetTextures(){return!!(X.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget)}getActiveTextures(e){this._thicknessTexture&&e.push(this._thicknessTexture),this._refractionTexture&&e.push(this._refractionTexture),this._refractionIntensityTexture&&e.push(this._refractionIntensityTexture),this._translucencyColorTexture&&e.push(this._translucencyColorTexture),this._translucencyIntensityTexture&&e.push(this._translucencyIntensityTexture)}getAnimatables(e){this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture),this._refractionIntensityTexture&&this._refractionIntensityTexture.animations&&this._refractionIntensityTexture.animations.length>0&&e.push(this._refractionIntensityTexture),this._translucencyColorTexture&&this._translucencyColorTexture.animations&&this._translucencyColorTexture.animations.length>0&&e.push(this._translucencyColorTexture),this._translucencyIntensityTexture&&this._translucencyIntensityTexture.animations&&this._translucencyIntensityTexture.animations.length>0&&e.push(this._translucencyIntensityTexture)}dispose(e){e&&(this._thicknessTexture&&this._thicknessTexture.dispose(),this._refractionTexture&&this._refractionTexture.dispose(),this._refractionIntensityTexture&&this._refractionIntensityTexture.dispose(),this._translucencyColorTexture&&this._translucencyColorTexture.dispose(),this._translucencyIntensityTexture&&this._translucencyIntensityTexture.dispose())}getClassName(){return"PBRSubSurfaceConfiguration"}addFallbacks(e,t,i){return e.SS_SCATTERING&&t.addFallback(i++,"SS_SCATTERING"),e.SS_TRANSLUCENCY&&t.addFallback(i++,"SS_TRANSLUCENCY"),i}getSamplers(e){e.push("thicknessSampler","refractionIntensitySampler","translucencyIntensitySampler","refractionSampler","refractionSamplerLow","refractionSamplerHigh","translucencyColorSampler")}getUniforms(){return{ubo:[{name:"vRefractionMicrosurfaceInfos",size:4,type:"vec4"},{name:"vRefractionFilteringInfo",size:2,type:"vec2"},{name:"vTranslucencyIntensityInfos",size:2,type:"vec2"},{name:"vRefractionInfos",size:4,type:"vec4"},{name:"refractionMatrix",size:16,type:"mat4"},{name:"vThicknessInfos",size:2,type:"vec2"},{name:"vRefractionIntensityInfos",size:2,type:"vec2"},{name:"thicknessMatrix",size:16,type:"mat4"},{name:"refractionIntensityMatrix",size:16,type:"mat4"},{name:"translucencyIntensityMatrix",size:16,type:"mat4"},{name:"vThicknessParam",size:2,type:"vec2"},{name:"vDiffusionDistance",size:3,type:"vec3"},{name:"vTintColor",size:4,type:"vec4"},{name:"vSubSurfaceIntensity",size:3,type:"vec3"},{name:"vRefractionPosition",size:3,type:"vec3"},{name:"vRefractionSize",size:3,type:"vec3"},{name:"scatteringDiffusionProfile",size:1,type:"float"},{name:"dispersion",size:1,type:"float"},{name:"vTranslucencyColor",size:4,type:"vec4"},{name:"vTranslucencyColorInfos",size:2,type:"vec2"},{name:"translucencyColorMatrix",size:16,type:"mat4"}]}}};Tt.DEFAULT_APPLY_ALBEDO_AFTERSUBSURFACE=!1;Tt.DEFAULT_LEGACY_TRANSLUCENCY=!1;x([y(),z("_markAllSubMeshesAsTexturesDirty")],Tt.prototype,"isRefractionEnabled",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],Tt.prototype,"isTranslucencyEnabled",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],Tt.prototype,"isDispersionEnabled",void 0);x([y(),z("_markScenePrePassDirty")],Tt.prototype,"isScatteringEnabled",void 0);x([y()],Tt.prototype,"_scatteringDiffusionProfileIndex",void 0);x([y()],Tt.prototype,"refractionIntensity",void 0);x([y()],Tt.prototype,"translucencyIntensity",void 0);x([y()],Tt.prototype,"useAlbedoToTintRefraction",void 0);x([y()],Tt.prototype,"useAlbedoToTintTranslucency",void 0);x([He(),z("_markAllSubMeshesAsTexturesDirty")],Tt.prototype,"thicknessTexture",void 0);x([He(),z("_markAllSubMeshesAsTexturesDirty")],Tt.prototype,"refractionTexture",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],Tt.prototype,"indexOfRefraction",void 0);x([y()],Tt.prototype,"_volumeIndexOfRefraction",void 0);x([z("_markAllSubMeshesAsTexturesDirty")],Tt.prototype,"volumeIndexOfRefraction",null);x([y(),z("_markAllSubMeshesAsTexturesDirty")],Tt.prototype,"invertRefractionY",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],Tt.prototype,"linkRefractionWithTransparency",void 0);x([y()],Tt.prototype,"minimumThickness",void 0);x([y()],Tt.prototype,"maximumThickness",void 0);x([y()],Tt.prototype,"useThicknessAsDepth",void 0);x([zt()],Tt.prototype,"tintColor",void 0);x([y()],Tt.prototype,"tintColorAtDistance",void 0);x([y()],Tt.prototype,"dispersion",void 0);x([zt()],Tt.prototype,"diffusionDistance",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],Tt.prototype,"useMaskFromThicknessTexture",void 0);x([He(),z("_markAllSubMeshesAsTexturesDirty")],Tt.prototype,"refractionIntensityTexture",void 0);x([He(),z("_markAllSubMeshesAsTexturesDirty")],Tt.prototype,"translucencyIntensityTexture",void 0);x([zt()],Tt.prototype,"translucencyColor",void 0);x([He(),z("_markAllSubMeshesAsTexturesDirty")],Tt.prototype,"translucencyColorTexture",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],Tt.prototype,"useGltfStyleTextures",void 0);x([y()],Tt.prototype,"applyAlbedoAfterSubSurface",void 0);x([y()],Tt.prototype,"legacyTranslucency",void 0)});var ZC,Ns,JC=S(()=>{Ye();cs();je();fn();fs();Ya();Xi();ZC=class extends ri{constructor(){super(...arguments),this.DETAIL=!1,this.DETAILDIRECTUV=0,this.DETAIL_NORMALBLENDMETHOD=0}},Ns=class extends hi{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"DetailMap",140,new ZC,t),this._texture=null,this.diffuseBlendLevel=1,this.roughnessBlendLevel=1,this.bumpLevel=1,this._normalBlendMethod=Q.MATERIAL_NORMALBLENDMETHOD_WHITEOUT,this._isEnabled=!1,this.isEnabled=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&i.getCaps().standardDerivatives&&this._texture&&X.DetailTextureEnabled&&!this._texture.isReady()):!0}prepareDefines(e,t){if(this._isEnabled){e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod;let i=t.getEngine();e._areTexturesDirty&&(i.getCaps().standardDerivatives&&this._texture&&X.DetailTextureEnabled&&this._isEnabled?(lt(this._texture,e,"DETAIL"),e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod):e.DETAIL=!1)}else e.DETAIL=!1}bindForSubMesh(e,t){if(!this._isEnabled)return;let i=this._material.isFrozen;(!e.useUbo||!i||!e.isSync)&&this._texture&&X.DetailTextureEnabled&&(e.updateFloat4("vDetailInfos",this._texture.coordinatesIndex,this.diffuseBlendLevel,this.bumpLevel,this.roughnessBlendLevel),ct(this._texture,e,"detail")),t.texturesEnabled&&this._texture&&X.DetailTextureEnabled&&e.setTexture("detailSampler",this._texture)}hasTexture(e){return this._texture===e}getActiveTextures(e){this._texture&&e.push(this._texture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)}dispose(e){e&&this._texture?.dispose()}getClassName(){return"DetailMapConfiguration"}getSamplers(e){e.push("detailSampler")}getUniforms(){return{ubo:[{name:"vDetailInfos",size:4,type:"vec4"},{name:"detailMatrix",size:16,type:"mat4"}]}}};x([He("detailTexture"),z("_markAllSubMeshesAsTexturesDirty")],Ns.prototype,"texture",void 0);x([y()],Ns.prototype,"diffuseBlendLevel",void 0);x([y()],Ns.prototype,"roughnessBlendLevel",void 0);x([y()],Ns.prototype,"bumpLevel",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],Ns.prototype,"normalBlendMethod",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],Ns.prototype,"isEnabled",void 0)});var G2,si,N_=S(()=>{ie();(function(s){s[s.Zero=0]="Zero",s[s.One=1]="One",s[s.MaxViewZ=2]="MaxViewZ"})(G2||(G2={}));si=class s{static CreateConfiguration(e){return s._Configurations[e]={defines:{},previousWorldMatrices:{},previousViewProjection:B.Zero(),currentViewProjection:B.Zero(),previousBones:{},lastUpdateFrameId:-1,excludedSkinnedMesh:[],reverseCulling:!1},s._Configurations[e]}static DeleteConfiguration(e){delete s._Configurations[e]}static GetConfiguration(e){return s._Configurations[e]}static AddUniformsAndSamplers(e,t){e.push("previousWorld","previousViewProjection","mPreviousBones")}static MarkAsDirty(e,t){for(let i of t)if(i.subMeshes)for(let r of i.subMeshes)r._removeDrawWrapper(e)}static PrepareDefines(e,t,i){if(!i._arePrePassDirty)return;let r=s._Configurations[e];if(!r)return;i.PREPASS=!0,i.PREPASS_COLOR=!1,i.PREPASS_COLOR_INDEX=-1;let n=0;for(let a=0;a<s.GeometryTextureDescriptions.length;a++){let o=s.GeometryTextureDescriptions[a],l=o.define,c=o.defineIndex,f=r.defines[c];f!==void 0?(i[l]=!0,i[c]=f,n++):(i[l]=!1,delete i[c])}i.SCENE_MRT_COUNT=n,i.BONES_VELOCITY_ENABLED=t.useBones&&t.computeBonesUsingShaders&&t.skeleton&&!t.skeleton.isUsingTextureForMatrices&&r.excludedSkinnedMesh.indexOf(t)===-1}static Bind(e,t,i,r,n){let a=s._Configurations[e];if(!a)return;let o=i.getScene(),l=o.getEngine();if(a.reverseCulling&&l.setStateCullFaceType(o._mirroredCameraPosition?n.cullBackFaces:!n.cullBackFaces),(a.defines.PREPASS_VELOCITY_INDEX!==void 0||a.defines.PREPASS_VELOCITY_LINEAR_INDEX!==void 0)&&(a.previousWorldMatrices[i.uniqueId]||(a.previousWorldMatrices[i.uniqueId]=r.clone()),a.previousViewProjection||(a.previousViewProjection=o.getTransformMatrix().clone(),a.currentViewProjection=o.getTransformMatrix().clone()),a.currentViewProjection.updateFlag!==o.getTransformMatrix().updateFlag?(a.lastUpdateFrameId=l.frameId,a.previousViewProjection.copyFrom(a.currentViewProjection),a.currentViewProjection.copyFrom(o.getTransformMatrix())):a.lastUpdateFrameId!==l.frameId&&(a.lastUpdateFrameId=l.frameId,a.previousViewProjection.copyFrom(a.currentViewProjection)),t.setMatrix("previousWorld",a.previousWorldMatrices[i.uniqueId]),t.setMatrix("previousViewProjection",a.previousViewProjection),a.previousWorldMatrices[i.uniqueId]=r.clone(),i.useBones&&i.computeBonesUsingShaders&&i.skeleton)){let c=i.skeleton;if(!c.isUsingTextureForMatrices||t.getUniformIndex("boneTextureWidth")===-1){let f=c.getTransformMatrices(i);f&&(a.previousBones[i.uniqueId]||(a.previousBones[i.uniqueId]=f.slice()),t.setMatrices("mPreviousBones",a.previousBones[i.uniqueId]),a.previousBones[i.uniqueId].set(f))}}}};si.GeometryTextureDescriptions=[{type:0,name:"Irradiance",clearType:0,define:"PREPASS_IRRADIANCE",defineIndex:"PREPASS_IRRADIANCE_INDEX"},{type:1,name:"WorldPosition",clearType:0,define:"PREPASS_POSITION",defineIndex:"PREPASS_POSITION_INDEX"},{type:2,name:"Velocity",clearType:0,define:"PREPASS_VELOCITY",defineIndex:"PREPASS_VELOCITY_INDEX"},{type:3,name:"Reflectivity",clearType:0,define:"PREPASS_REFLECTIVITY",defineIndex:"PREPASS_REFLECTIVITY_INDEX"},{type:5,name:"ViewDepth",clearType:2,define:"PREPASS_DEPTH",defineIndex:"PREPASS_DEPTH_INDEX"},{type:6,name:"ViewNormal",clearType:0,define:"PREPASS_NORMAL",defineIndex:"PREPASS_NORMAL_INDEX"},{type:7,name:"AlbedoSqrt",clearType:0,define:"PREPASS_ALBEDO_SQRT",defineIndex:"PREPASS_ALBEDO_SQRT_INDEX"},{type:8,name:"WorldNormal",clearType:0,define:"PREPASS_WORLD_NORMAL",defineIndex:"PREPASS_WORLD_NORMAL_INDEX"},{type:9,name:"LocalPosition",clearType:0,define:"PREPASS_LOCAL_POSITION",defineIndex:"PREPASS_LOCAL_POSITION_INDEX"},{type:10,name:"ScreenDepth",clearType:1,define:"PREPASS_SCREENSPACE_DEPTH",defineIndex:"PREPASS_SCREENSPACE_DEPTH_INDEX"},{type:11,name:"LinearVelocity",clearType:0,define:"PREPASS_VELOCITY_LINEAR",defineIndex:"PREPASS_VELOCITY_LINEAR_INDEX"},{type:12,name:"Albedo",clearType:0,define:"PREPASS_ALBEDO",defineIndex:"PREPASS_ALBEDO_INDEX"},{type:13,name:"NormalizedViewDepth",clearType:1,define:"PREPASS_NORMALIZED_VIEW_DEPTH",defineIndex:"PREPASS_NORMALIZED_VIEW_DEPTH_INDEX"}];si._Configurations={}});var V2,OJ,$C=S(()=>{O();wo();rf();V2="pbrUboDeclaration",OJ=`uniform vAlbedoInfos: vec2f;uniform vBaseWeightInfos: vec2f;uniform vBaseDiffuseRoughnessInfos: vec2f;uniform vAmbientInfos: vec4f;uniform vOpacityInfos: vec2f;uniform vEmissiveInfos: vec2f;uniform vLightmapInfos: vec2f;uniform vReflectivityInfos: vec3f;uniform vMicroSurfaceSamplerInfos: vec2f;uniform vReflectionInfos: vec2f;uniform vReflectionFilteringInfo: vec2f;uniform vReflectionPosition: vec3f;uniform vReflectionSize: vec3f;uniform vBumpInfos: vec3f;uniform albedoMatrix: mat4x4f;uniform baseWeightMatrix: mat4x4f;uniform baseDiffuseRoughnessMatrix: mat4x4f;uniform ambientMatrix: mat4x4f;uniform opacityMatrix: mat4x4f;uniform emissiveMatrix: mat4x4f;uniform lightmapMatrix: mat4x4f;uniform reflectivityMatrix: mat4x4f;uniform microSurfaceSamplerMatrix: mat4x4f;uniform bumpMatrix: mat4x4f;uniform vTangentSpaceParams: vec2f;uniform reflectionMatrix: mat4x4f;uniform vReflectionColor: vec3f;uniform vAlbedoColor: vec4f;uniform baseWeight: f32;uniform baseDiffuseRoughness: f32;uniform vLightingIntensity: vec4f;uniform vReflectionMicrosurfaceInfos: vec3f;uniform vReflectionDominantDirection: vec3f;uniform pointSize: f32;uniform vReflectivityColor: vec4f;uniform vEmissiveColor: vec3f;uniform vAmbientColor: vec3f;uniform vDebugMode: vec2f;uniform vMetallicReflectanceFactors: vec4f;uniform vMetallicReflectanceInfos: vec2f;uniform metallicReflectanceMatrix: mat4x4f;uniform vReflectanceInfos: vec2f;uniform reflectanceMatrix: mat4x4f;uniform vSphericalL00: vec3f;uniform vSphericalL1_1: vec3f;uniform vSphericalL10: vec3f;uniform vSphericalL11: vec3f;uniform vSphericalL2_2: vec3f;uniform vSphericalL2_1: vec3f;uniform vSphericalL20: vec3f;uniform vSphericalL21: vec3f;uniform vSphericalL22: vec3f;uniform vSphericalX: vec3f;uniform vSphericalY: vec3f;uniform vSphericalZ: vec3f;uniform vSphericalXX_ZZ: vec3f;uniform vSphericalYY_ZZ: vec3f;uniform vSphericalZZ: vec3f;uniform vSphericalXY: vec3f;uniform vSphericalYZ: vec3f;uniform vSphericalZX: vec3f;uniform cameraInfo: vec4f;
#define ADDITIONAL_UBO_DECLARATION
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;g.IncludesShadersStoreWGSL[V2]||(g.IncludesShadersStoreWGSL[V2]=OJ)});var k2,LJ,eI=S(()=>{O();k2="uvAttributeDeclaration",LJ=`#ifdef UV{X}
attribute uv{X}: vec2f;
#endif
`;g.IncludesShadersStoreWGSL[k2]||(g.IncludesShadersStoreWGSL[k2]=LJ)});var W2,wJ,Au=S(()=>{O();W2="mainUVVaryingDeclaration",wJ=`#ifdef MAINUV{X}
varying vMainUV{X}: vec2f;
#endif
`;g.IncludesShadersStoreWGSL[W2]||(g.IncludesShadersStoreWGSL[W2]=wJ)});var H2,FJ,Pf=S(()=>{O();H2="pbrBRDFFunctions",FJ=`#define FRESNEL_MAXIMUM_ON_ROUGH 0.25
#define BRDF_DIFFUSE_MODEL_EON 0
#define BRDF_DIFFUSE_MODEL_BURLEY 1
#define BRDF_DIFFUSE_MODEL_LAMBERT 2
#define BRDF_DIFFUSE_MODEL_LEGACY 3
#define DIELECTRIC_SPECULAR_MODEL_GLTF 0
#define DIELECTRIC_SPECULAR_MODEL_OPENPBR 1
#define CONDUCTOR_SPECULAR_MODEL_GLTF 0
#define CONDUCTOR_SPECULAR_MODEL_OPENPBR 1
#ifndef PBR_VERTEX_SHADER
#ifdef MS_BRDF_ENERGY_CONSERVATION
fn getEnergyConservationFactor(specularEnvironmentR0: vec3f,environmentBrdf: vec3f)->vec3f {return 1.0+specularEnvironmentR0*(1.0/environmentBrdf.y-1.0);}
#endif
#if CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR 
fn getF82Specular(NdotV: f32,F0: vec3f,edgeTint: vec3f,roughness: f32)->vec3f {const cos_theta_max: f32=0.142857143; 
const one_minus_cos_theta_max_to_the_fifth: f32=0.462664366; 
const one_minus_cos_theta_max_to_the_sixth: f32=0.396569457; 
let white_minus_F0: vec3f=vec3f(1.0f)-F0;let b_numerator: vec3f=(F0+white_minus_F0*one_minus_cos_theta_max_to_the_fifth)*(vec3f(1.0)-edgeTint);const b_denominator: f32=cos_theta_max*one_minus_cos_theta_max_to_the_sixth;const b_denominator_reciprocal: f32=1.0f/b_denominator;let b: vec3f=b_numerator*b_denominator_reciprocal; 
let cos_theta: f32=max(roughness,NdotV);let one_minus_cos_theta: f32=1.0-cos_theta;let offset_from_F0: vec3f=(white_minus_F0-b*cos_theta*one_minus_cos_theta)*pow(one_minus_cos_theta,5.0f);return clamp(F0+offset_from_F0,vec3f(0.0f),vec3f(1.0f));}
#endif
#ifdef ENVIRONMENTBRDF
fn getBRDFLookup(NdotV: f32,perceptualRoughness: f32)->vec3f {var UV: vec2f= vec2f(NdotV,perceptualRoughness);var brdfLookup: vec4f= textureSample(environmentBrdfSampler,environmentBrdfSamplerSampler,UV);
#ifdef ENVIRONMENTBRDF_RGBD
brdfLookup=vec4f(fromRGBD(brdfLookup.rgba),brdfLookup.a);
#endif
return brdfLookup.rgb;}
fn getReflectanceFromBRDFWithEnvLookup(specularEnvironmentR0: vec3f,specularEnvironmentR90: vec3f,environmentBrdf: vec3f)->vec3f {
#ifdef BRDF_V_HEIGHT_CORRELATED
var reflectance: vec3f=(specularEnvironmentR90-specularEnvironmentR0)*environmentBrdf.x+specularEnvironmentR0*environmentBrdf.y;
#else
var reflectance: vec3f=specularEnvironmentR0*environmentBrdf.x+specularEnvironmentR90*environmentBrdf.y;
#endif
return reflectance;}
fn getReflectanceFromBRDFLookup(specularEnvironmentR0: vec3f,environmentBrdf: vec3f)->vec3f {
#ifdef BRDF_V_HEIGHT_CORRELATED
var reflectance: vec3f=mix(environmentBrdf.xxx,environmentBrdf.yyy,specularEnvironmentR0);
#else
var reflectance: vec3f=specularEnvironmentR0*environmentBrdf.x+environmentBrdf.y;
#endif
return reflectance;}
#endif
/* NOT USED
#if defined(SHEEN) && defined(SHEEN_SOFTER)
fn getBRDFLookupCharlieSheen(NdotV: f32,perceptualRoughness: f32)->f32
{var c: f32=1.0-NdotV;var c3: f32=c*c*c;return 0.65584461*c3+1.0/(4.16526551+exp(-7.97291361*perceptualRoughness+6.33516894));}
#endif
*/
#if !defined(ENVIRONMENTBRDF) || defined(REFLECTIONMAP_SKYBOX) || defined(ALPHAFRESNEL)
fn getReflectanceFromAnalyticalBRDFLookup_Jones(VdotN: f32,reflectance0: vec3f,reflectance90: vec3f,smoothness: f32)->vec3f
{var weight: f32=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
/**
* The sheen BRDF not containing F can be easily stored in the blue channel of the BRDF texture.
* The blue channel contains DCharlie*VAshikhmin*NdotL as a lokkup table
*/
fn getSheenReflectanceFromBRDFLookup(reflectance0: vec3f,environmentBrdf: vec3f)->vec3f {var sheenEnvironmentReflectance: vec3f=reflectance0*environmentBrdf.b;return sheenEnvironmentReflectance;}
#endif
fn fresnelSchlickGGXVec3(VdotH: f32,reflectance0: vec3f,reflectance90: vec3f)->vec3f
{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}
fn fresnelSchlickGGX(VdotH: f32,reflectance0: f32,reflectance90: f32)->f32
{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}
#ifdef CLEARCOAT
fn getR0RemappedForClearCoat(f0: vec3f)->vec3f {
#ifdef CLEARCOAT_DEFAULTIOR
#ifdef MOBILE
return saturateVec3(f0*(f0*0.526868+0.529324)-0.0482256);
#else
return saturateVec3(f0*(f0*(0.941892-0.263008*f0)+0.346479)-0.0285998);
#endif
#else
var s: vec3f=sqrt(f0);var t: vec3f=(uniforms.vClearCoatRefractionParams.z+uniforms.vClearCoatRefractionParams.w*s)/(uniforms.vClearCoatRefractionParams.w+uniforms.vClearCoatRefractionParams.z*s);return squareVec3(t);
#endif
}
#endif
#ifdef IRIDESCENCE
const XYZ_TO_REC709: mat3x3f= mat3x3f(
3.2404542,-0.9692660, 0.0556434,
-1.5371385, 1.8760108,-0.2040259,
-0.4985314, 0.0415560, 1.0572252
);fn getIORTfromAirToSurfaceR0(f0: vec3f)->vec3f {var sqrtF0: vec3f=sqrt(f0);return (1.+sqrtF0)/(1.-sqrtF0);}
fn getR0fromIORsVec3(iorT: vec3f,iorI: f32)->vec3f {return squareVec3((iorT- vec3f(iorI))/(iorT+ vec3f(iorI)));}
fn getR0fromIORs(iorT: f32,iorI: f32)->f32 {return square((iorT-iorI)/(iorT+iorI));}
fn evalSensitivity(opd: f32,shift: vec3f)->vec3f {var phase: f32=2.0*PI*opd*1.0e-9;const val: vec3f= vec3f(5.4856e-13,4.4201e-13,5.2481e-13);const pos: vec3f= vec3f(1.6810e+06,1.7953e+06,2.2084e+06);const vr: vec3f= vec3f(4.3278e+09,9.3046e+09,6.6121e+09);var xyz: vec3f=val*sqrt(2.0*PI*vr)*cos(pos*phase+shift)*exp(-square(phase)*vr);xyz.x+=9.7470e-14*sqrt(2.0*PI*4.5282e+09)*cos(2.2399e+06*phase+shift[0])*exp(-4.5282e+09*square(phase));xyz/=1.0685e-7;var srgb: vec3f=XYZ_TO_REC709*xyz;return srgb;}
fn evalIridescence(outsideIOR: f32,eta2: f32,cosTheta1: f32,thinFilmThickness: f32,baseF0: vec3f)->vec3f {var I: vec3f= vec3f(1.0);var iridescenceIOR: f32=mix(outsideIOR,eta2,smoothstep(0.0,0.03,thinFilmThickness));var sinTheta2Sq: f32=square(outsideIOR/iridescenceIOR)*(1.0-square(cosTheta1));var cosTheta2Sq: f32=1.0-sinTheta2Sq;if (cosTheta2Sq<0.0) {return I;}
var cosTheta2: f32=sqrt(cosTheta2Sq);var R0: f32=getR0fromIORs(iridescenceIOR,outsideIOR);var R12: f32=fresnelSchlickGGX(cosTheta1,R0,1.);var R21: f32=R12;var T121: f32=1.0-R12;var phi12: f32=0.0;if (iridescenceIOR<outsideIOR) {phi12=PI;}
var phi21: f32=PI-phi12;var baseIOR: vec3f=getIORTfromAirToSurfaceR0(clamp(baseF0,vec3f(0.0),vec3f(0.9999))); 
var R1: vec3f=getR0fromIORsVec3(baseIOR,iridescenceIOR);var R23: vec3f=fresnelSchlickGGXVec3(cosTheta2,R1, vec3f(1.));var phi23: vec3f= vec3f(0.0);if (baseIOR[0]<iridescenceIOR) {phi23[0]=PI;}
if (baseIOR[1]<iridescenceIOR) {phi23[1]=PI;}
if (baseIOR[2]<iridescenceIOR) {phi23[2]=PI;}
var opd: f32=2.0*iridescenceIOR*thinFilmThickness*cosTheta2;var phi: vec3f= vec3f(phi21)+phi23;var R123: vec3f=clamp(R12*R23,vec3f(1e-5),vec3f(0.9999));var r123: vec3f=sqrt(R123);var Rs: vec3f=(T121*T121)*R23/( vec3f(1.0)-R123);var C0: vec3f=R12+Rs;I=C0;var Cm: vec3f=Rs-T121;for (var m: i32=1; m<=2; m++)
{Cm*=r123;var Sm: vec3f=2.0*evalSensitivity( f32(m)*opd, f32(m)*phi);I+=Cm*Sm;}
return max(I, vec3f(0.0));}
#endif
fn normalDistributionFunction_TrowbridgeReitzGGX(NdotH: f32,alphaG: f32)->f32
{var a2: f32=alphaG*alphaG;var d: f32=NdotH*NdotH*(a2-1.0)+1.0;return a2/(PI*d*d);}
#ifdef SHEEN
fn normalDistributionFunction_CharlieSheen(NdotH: f32,alphaG: f32)->f32
{var invR: f32=1./alphaG;var cos2h: f32=NdotH*NdotH;var sin2h: f32=1.-cos2h;return (2.+invR)*pow(sin2h,invR*.5)/(2.*PI);}
#endif
#ifdef ANISOTROPIC
fn normalDistributionFunction_BurleyGGX_Anisotropic(NdotH: f32,TdotH: f32,BdotH: f32,alphaTB: vec2f)->f32 {var a2: f32=alphaTB.x*alphaTB.y;var v: vec3f= vec3f(alphaTB.y*TdotH,alphaTB.x *BdotH,a2*NdotH);var v2: f32=dot(v,v);var w2: f32=a2/v2;return a2*w2*w2*RECIPROCAL_PI;}
#endif
#ifdef BRDF_V_HEIGHT_CORRELATED
fn smithVisibility_GGXCorrelated(NdotL: f32,NdotV: f32,alphaG: f32)->f32 {
#ifdef MOBILE
var GGXV: f32=NdotL*(NdotV*(1.0-alphaG)+alphaG);var GGXL: f32=NdotV*(NdotL*(1.0-alphaG)+alphaG);return 0.5/(GGXV+GGXL);
#else
var a2: f32=alphaG*alphaG;var GGXV: f32=NdotL*sqrt(NdotV*(NdotV-a2*NdotV)+a2);var GGXL: f32=NdotV*sqrt(NdotL*(NdotL-a2*NdotL)+a2);return 0.5/(GGXV+GGXL);
#endif
}
#else
fn smithVisibilityG1_TrowbridgeReitzGGXFast(dot: f32,alphaG: f32)->f32
{
#ifdef MOBILE
return 1.0/(dot+alphaG+(1.0-alphaG)*dot ));
#else
var alphaSquared: f32=alphaG*alphaG;return 1.0/(dot+sqrt(alphaSquared+(1.0-alphaSquared)*dot*dot));
#endif
}
fn smithVisibility_TrowbridgeReitzGGXFast(NdotL: f32,NdotV: f32,alphaG: f32)->f32
{var visibility: f32=smithVisibilityG1_TrowbridgeReitzGGXFast(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGXFast(NdotV,alphaG);return visibility;}
#endif
#ifdef ANISOTROPIC
fn smithVisibility_GGXCorrelated_Anisotropic(NdotL: f32,NdotV: f32,TdotV: f32,BdotV: f32,TdotL: f32,BdotL: f32,alphaTB: vec2f)->f32 {var lambdaV: f32=NdotL*length( vec3f(alphaTB.x*TdotV,alphaTB.y*BdotV,NdotV));var lambdaL: f32=NdotV*length( vec3f(alphaTB.x*TdotL,alphaTB.y*BdotL,NdotL));var v: f32=0.5/(lambdaV+lambdaL);return v;}
#endif
#ifdef CLEARCOAT
fn visibility_Kelemen(VdotH: f32)->f32 {return 0.25/(VdotH*VdotH); }
#endif
#ifdef SHEEN
fn visibility_Ashikhmin(NdotL: f32,NdotV: f32)->f32
{return 1./(4.*(NdotL+NdotV-NdotL*NdotV));}
/* NOT USED
#ifdef SHEEN_SOFTER
fn l(x: f32,alphaG: f32)->f32
{var oneMinusAlphaSq: f32=(1.0-alphaG)*(1.0-alphaG);var a: f32=mix(21.5473,25.3245,oneMinusAlphaSq);var b: f32=mix(3.82987,3.32435,oneMinusAlphaSq);var c: f32=mix(0.19823,0.16801,oneMinusAlphaSq);var d: f32=mix(-1.97760,-1.27393,oneMinusAlphaSq);var e: f32=mix(-4.32054,-4.85967,oneMinusAlphaSq);return a/(1.0+b*pow(x,c))+d*x+e;}
fn lambdaSheen(cosTheta: f32,alphaG: f32)->f32
{return abs(cosTheta)<0.5 ? exp(l(cosTheta,alphaG)) : exp(2.0*l(0.5,alphaG)-l(1.0-cosTheta,alphaG));}
fn visibility_CharlieSheen(NdotL: f32,NdotV: f32,alphaG: f32)->f32
{var G: f32=1.0/(1.0+lambdaSheen(NdotV,alphaG)+lambdaSheen(NdotL,alphaG));return G/(4.0*NdotV*NdotL);}
#endif
*/
#endif
const constant1_FON: f32=0.5f-2.0f/(3.0f*PI);const constant2_FON: f32=2.0f/3.0f-28.0f/(15.0f*PI);fn E_FON_approx(mu: f32,roughness: f32)->f32
{var sigma: f32=roughness; 
var mucomp: f32=1.0f-mu;var mucomp2: f32=mucomp*mucomp;const Gcoeffs: mat2x2f=mat2x2f(0.0571085289f,-0.332181442f,
0.491881867f,0.0714429953f);var GoverPi: f32=dot(Gcoeffs*vec2f(mucomp,mucomp2),vec2f(1.0f,mucomp2));return (1.0f+sigma*GoverPi)/(1.0f+constant1_FON*sigma);}
fn diffuseBRDF_EON(albedo: vec3f,roughness: f32,NdotL: f32,NdotV: f32,LdotV: f32)->vec3f
{var rho: vec3f=albedo;var sigma: f32=roughness; 
var mu_i: f32=NdotL; 
var mu_o: f32=NdotV; 
var s: f32=LdotV-mu_i*mu_o; 
var sovertF: f32=select(s,s/max(mu_i,mu_o),s>0.0f); 
var AF: f32=1.0f/(1.0f+constant1_FON*sigma); 
var f_ss: vec3f=(rho*RECIPROCAL_PI)*AF*(1.0f+sigma*sovertF); 
var EFo: f32=E_FON_approx(mu_o,sigma); 
var EFi: f32=E_FON_approx(mu_i,sigma); 
var avgEF: f32=AF*(1.0f+constant2_FON*sigma); 
var rho_ms: vec3f=(rho*rho)*avgEF/(vec3f(1.0f)-rho*(1.0f-avgEF));const eps: f32=1.0e-7f;var f_ms: vec3f=(rho_ms*RECIPROCAL_PI)*max(eps,1.0f-EFo) 
* max(eps,1.0f-EFi)
/ max(eps,1.0f-avgEF);return (f_ss+f_ms);}
fn diffuseBRDF_Burley(NdotL: f32,NdotV: f32,VdotH: f32,roughness: f32)->f32 {var diffuseFresnelNV: f32=pow5(saturateEps(1.0-NdotL));var diffuseFresnelNL: f32=pow5(saturateEps(1.0-NdotV));var diffuseFresnel90: f32=0.5+2.0*VdotH*VdotH*roughness;var fresnel: f32 =
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);return fresnel/PI;}
#ifdef SS_TRANSLUCENCY
fn transmittanceBRDF_Burley(tintColor: vec3f,diffusionDistance: vec3f,thickness: f32)->vec3f {var S: vec3f=1./maxEpsVec3(diffusionDistance);var temp: vec3f=exp((-0.333333333*thickness)*S);return tintColor.rgb*0.25*(temp*temp*temp+3.0*temp);}
fn computeWrappedDiffuseNdotL(NdotL: f32,w: f32)->f32 {var t: f32=1.0+w;var invt2: f32=1.0/(t*t);return saturate((NdotL+w)*invt2);}
#endif
#endif 
`;g.IncludesShadersStoreWGSL[H2]||(g.IncludesShadersStoreWGSL[H2]=FJ)});var z2,NJ,tI=S(()=>{O();z2="prePassVertexDeclaration",NJ=`#ifdef PREPASS
#ifdef PREPASS_LOCAL_POSITION
varying vPosition : vec3f;
#endif
#ifdef PREPASS_DEPTH
varying vViewPos: vec3f;
#endif
#ifdef PREPASS_NORMALIZED_VIEW_DEPTH
varying vNormViewDepth: f32;
#endif
#if defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)
uniform previousViewProjection: mat4x4f;varying vCurrentPosition: vec4f;varying vPreviousPosition: vec4f;
#endif
#endif
`;g.IncludesShadersStoreWGSL[z2]||(g.IncludesShadersStoreWGSL[z2]=NJ)});var X2,BJ,iI=S(()=>{O();X2="samplerVertexDeclaration",BJ=`#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0
varying v_VARYINGNAME_UV: vec2f;
#endif
`;g.IncludesShadersStoreWGSL[X2]||(g.IncludesShadersStoreWGSL[X2]=BJ)});var Y2,UJ,rI=S(()=>{O();Y2="harmonicsFunctions",UJ=`#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
fn computeEnvironmentIrradiance(normal: vec3f)->vec3f {return uniforms.vSphericalL00
+ uniforms.vSphericalL1_1*(normal.y)
+ uniforms.vSphericalL10*(normal.z)
+ uniforms.vSphericalL11*(normal.x)
+ uniforms.vSphericalL2_2*(normal.y*normal.x)
+ uniforms.vSphericalL2_1*(normal.y*normal.z)
+ uniforms.vSphericalL20*((3.0*normal.z*normal.z)-1.0)
+ uniforms.vSphericalL21*(normal.z*normal.x)
+ uniforms.vSphericalL22*(normal.x*normal.x-(normal.y*normal.y));}
#else
fn computeEnvironmentIrradiance(normal: vec3f)->vec3f {var Nx: f32=normal.x;var Ny: f32=normal.y;var Nz: f32=normal.z;var C1: vec3f=uniforms.vSphericalZZ.rgb;var Cx: vec3f=uniforms.vSphericalX.rgb;var Cy: vec3f=uniforms.vSphericalY.rgb;var Cz: vec3f=uniforms.vSphericalZ.rgb;var Cxx_zz: vec3f=uniforms.vSphericalXX_ZZ.rgb;var Cyy_zz: vec3f=uniforms.vSphericalYY_ZZ.rgb;var Cxy: vec3f=uniforms.vSphericalXY.rgb;var Cyz: vec3f=uniforms.vSphericalYZ.rgb;var Czx: vec3f=uniforms.vSphericalZX.rgb;var a1: vec3f=Cyy_zz*Ny+Cy;var a2: vec3f=Cyz*Nz+a1;var b1: vec3f=Czx*Nz+Cx;var b2: vec3f=Cxy*Ny+b1;var b3: vec3f=Cxx_zz*Nx+b2;var t1: vec3f=Cz *Nz+C1;var t2: vec3f=a2 *Ny+t1;var t3: vec3f=b3 *Nx+t2;return t3;}
#endif
#endif
`;g.IncludesShadersStoreWGSL[Y2]||(g.IncludesShadersStoreWGSL[Y2]=UJ)});var K2,GJ,sI=S(()=>{O();K2="bumpVertexDeclaration",GJ=`#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL) 
varying vTBN0: vec3f;varying vTBN1: vec3f;varying vTBN2: vec3f;
#endif
#endif
`;g.IncludesShadersStoreWGSL[K2]||(g.IncludesShadersStoreWGSL[K2]=GJ)});var q2,VJ,nI=S(()=>{O();q2="prePassVertex",VJ=`#ifdef PREPASS_DEPTH
vertexOutputs.vViewPos=(scene.view*worldPos).rgb;
#endif
#ifdef PREPASS_NORMALIZED_VIEW_DEPTH
vertexOutputs.vNormViewDepth=((scene.view*worldPos).z-uniforms.cameraInfo.x)/(uniforms.cameraInfo.y-uniforms.cameraInfo.x);
#endif
#ifdef PREPASS_LOCAL_POSITION
vertexOutputs.vPosition=positionUpdated.xyz;
#endif
#if (defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && defined(BONES_VELOCITY_ENABLED)
vertexOutputs.vCurrentPosition=scene.viewProjection*worldPos;
#if NUM_BONE_INFLUENCERS>0
var previousInfluence: mat4x4f;previousInfluence=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndices[0])]*vertexInputs.matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
previousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndices[1])]*vertexInputs.matricesWeights[1];
#endif 
#if NUM_BONE_INFLUENCERS>2
previousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndices[2])]*vertexInputs.matricesWeights[2];
#endif 
#if NUM_BONE_INFLUENCERS>3
previousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndices[3])]*vertexInputs.matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
previousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndicesExtra[0])]*vertexInputs.matricesWeightsExtra[0];
#endif 
#if NUM_BONE_INFLUENCERS>5
previousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndicesExtra[1])]*vertexInputs.matricesWeightsExtra[1];
#endif 
#if NUM_BONE_INFLUENCERS>6
previousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndicesExtra[2])]*vertexInputs.matricesWeightsExtra[2];
#endif 
#if NUM_BONE_INFLUENCERS>7
previousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndicesExtra[3])]*vertexInputs.matricesWeightsExtra[3];
#endif
vertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld*previousInfluence* vec4f(positionUpdated,1.0);
#else
vertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld* vec4f(positionUpdated,1.0);
#endif
#endif
`;g.IncludesShadersStoreWGSL[q2]||(g.IncludesShadersStoreWGSL[q2]=VJ)});var Q2,kJ,aI=S(()=>{O();Q2="uvVariableDeclaration",kJ=`#ifdef MAINUV{X}
#if !defined(UV{X})
var uv{X}: vec2f=vec2f(0.,0.);
#else
var uv{X}: vec2f=vertexInputs.uv{X};
#endif
vertexOutputs.vMainUV{X}=uv{X};
#endif
`;g.IncludesShadersStoreWGSL[Q2]||(g.IncludesShadersStoreWGSL[Q2]=kJ)});var j2,WJ,oI=S(()=>{O();j2="samplerVertexImplementation",WJ=`#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0
if (uniforms.v_INFONAME_==0.)
{vertexOutputs.v_VARYINGNAME_UV= (uniforms._MATRIXNAME_Matrix* vec4f(uvUpdated,1.0,0.0)).xy;}
#ifdef UV2
else if (uniforms.v_INFONAME_==1.)
{vertexOutputs.v_VARYINGNAME_UV= (uniforms._MATRIXNAME_Matrix* vec4f(uv2Updated,1.0,0.0)).xy;}
#endif
#ifdef UV3
else if (uniforms.v_INFONAME_==2.)
{vertexOutputs.v_VARYINGNAME_UV= (uniforms._MATRIXNAME_Matrix* vec4f(vertexInputs.uv3,1.0,0.0)).xy;}
#endif
#ifdef UV4
else if (uniforms.v_INFONAME_==3.)
{vertexOutputs.v_VARYINGNAME_UV= (uniforms._MATRIXNAME_Matrix* vec4f(vertexInputs.uv4,1.0,0.0)).xy;}
#endif
#ifdef UV5
else if (uniforms.v_INFONAME_==4.)
{vertexOutputs.v_VARYINGNAME_UV= (uniforms._MATRIXNAME_Matrix* vec4f(vertexInputs.uv5,1.0,0.0)).xy;}
#endif
#ifdef UV6
else if (uniforms.v_INFONAME_==5.)
{vertexOutputs.v_VARYINGNAME_UV= (uniforms._MATRIXNAME_Matrix* vec4f(vertexInputs.uv6,1.0,0.0)).xy;}
#endif
#endif
`;g.IncludesShadersStoreWGSL[j2]||(g.IncludesShadersStoreWGSL[j2]=WJ)});var Z2,HJ,B_=S(()=>{O();Z2="bumpVertex",HJ=`#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
var tbnNormal: vec3f=normalize(normalUpdated);var tbnTangent: vec3f=normalize(tangentUpdated.xyz);var tbnBitangent: vec3f=cross(tbnNormal,tbnTangent)*tangentUpdated.w;var matTemp= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz)* mat3x3f(tbnTangent,tbnBitangent,tbnNormal);vertexOutputs.vTBN0=matTemp[0];vertexOutputs.vTBN1=matTemp[1];vertexOutputs.vTBN2=matTemp[2];
#endif
#endif
`;g.IncludesShadersStoreWGSL[Z2]||(g.IncludesShadersStoreWGSL[Z2]=HJ)});var J2,zJ,lI=S(()=>{O();J2="vertexColorMixing",zJ=`#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
vertexOutputs.vColor=vec4f(1.0);
#ifdef VERTEXCOLOR
#ifdef VERTEXALPHA
vertexOutputs.vColor*=vertexInputs.color;
#else
vertexOutputs.vColor=vec4f(vertexOutputs.vColor.rgb*vertexInputs.color.rgb,vertexOutputs.vColor.a);
#endif
#endif
#ifdef INSTANCESCOLOR
vertexOutputs.vColor*=vertexInputs.instanceColor;
#endif
#endif
`;g.IncludesShadersStoreWGSL[J2]||(g.IncludesShadersStoreWGSL[J2]=zJ)});var eU={};V(eU,{pbrVertexShaderWGSL:()=>XJ});var cI,$2,XJ,tU=S(()=>{O();$C();eI();Au();Pi();Pf();Ia();Bn();Va();tI();iI();rI();sI();ya();hu();g_();Oo();Lo();za();Fo();No();Un();Ma();Gn();nI();aI();oI();B_();Pa();uu();v_();lI();du();cI="pbrVertexShader",$2=`#define PBR_VERTEX_SHADER
#include<pbrUboDeclaration>
#define CUSTOM_VERTEX_BEGIN
attribute position: vec3f;
#ifdef NORMAL
attribute normal: vec3f;
#endif
#ifdef TANGENT
attribute tangent: vec4f;
#endif
#ifdef UV1
attribute uv: vec2f;
#endif
#include<uvAttributeDeclaration>[2..7]
#include<mainUVVaryingDeclaration>[1..7]
#ifdef VERTEXCOLOR
attribute color: vec4f;
#endif
#include<helperFunctions>
#include<pbrBRDFFunctions>
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<prePassVertexDeclaration>
#include<samplerVertexDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo)
#include<samplerVertexDeclaration>(_DEFINENAME_,BASE_WEIGHT,_VARYINGNAME_,BaseWeight)
#include<samplerVertexDeclaration>(_DEFINENAME_,BASE_DIFFUSE_ROUGHNESS,_VARYINGNAME_,BaseDiffuseRoughness)
#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)
#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)
#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)
#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)
#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)
#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity)
#include<samplerVertexDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler)
#include<samplerVertexDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance)
#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance)
#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)
#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)
#ifdef CLEARCOAT
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint)
#endif
#ifdef IRIDESCENCE
#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence)
#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness)
#endif
#ifdef SHEEN
#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen)
#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)
#endif
#ifdef ANISOTROPIC
#include<samplerVertexDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy)
#endif
#ifdef SUBSURFACE
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor)
#endif
varying vPositionW: vec3f;
#if DEBUGMODE>0
varying vClipSpacePosition: vec4f;
#endif
#ifdef NORMAL
varying vNormalW: vec3f;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vEnvironmentIrradiance: vec3f;
#include<harmonicsFunctions>
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vColor: vec4f;
#endif
#include<bumpVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<lightVxUboDeclaration>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vPositionUVW: vec3f;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vDirectionW: vec3f;
#endif
#ifdef CLUSTLIGHT_BATCH
varying vViewDepth: f32;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
var positionUpdated: vec3f=vertexInputs.position;
#ifdef NORMAL
var normalUpdated: vec3f=vertexInputs.normal;
#endif
#ifdef TANGENT
var tangentUpdated: vec4f=vertexInputs.tangent;
#endif
#ifdef UV1
var uvUpdated: vec2f=vertexInputs.uv;
#endif
#ifdef UV2
var uv2Updated: vec2f=vertexInputs.uv2;
#endif
#ifdef VERTEXCOLOR
var colorUpdated: vec4f=vertexInputs.color;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vertexOutputs.vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && ((defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)
vertexOutputs.vCurrentPosition=scene.viewProjection*finalWorld*vec4f(positionUpdated,1.0);vertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld*vec4f(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
var worldPos: vec4f=finalWorld* vec4f(positionUpdated,1.0);vertexOutputs.vPositionW= worldPos.xyz;
#ifdef PREPASS
#include<prePassVertex>
#endif
#ifdef NORMAL
var normalWorld: mat3x3f= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vertexOutputs.vNormalW=normalUpdated/ vec3f(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vertexOutputs.vNormalW=normalize(normalWorld*vertexOutputs.vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vertexOutputs.vNormalW=normalize(normalWorld*normalUpdated);
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
#if BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LAMBERT && BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LEGACY
var viewDirectionW: vec3f=normalize(scene.vEyePosition.xyz-vertexOutputs.vPositionW);var NdotV: f32=max(dot(vertexOutputs.vNormalW,viewDirectionW),0.0);var roughNormal: vec3f=mix(vertexOutputs.vNormalW,viewDirectionW,(0.5*(1.0-NdotV))*uniforms.baseDiffuseRoughness);var reflectionVector: vec3f= (uniforms.reflectionMatrix* vec4f(roughNormal,0)).xyz;
#else
var reflectionVector: vec3f= (uniforms.reflectionMatrix* vec4f(vertexOutputs.vNormalW,0)).xyz;
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
vertexOutputs.vEnvironmentIrradiance=computeEnvironmentIrradiance(reflectionVector);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {vertexOutputs.position=scene.viewProjection*worldPos;} else {vertexOutputs.position=scene.viewProjectionR*worldPos;}
#else
vertexOutputs.position=scene.viewProjection*worldPos;
#endif
#if DEBUGMODE>0
vertexOutputs.vClipSpacePosition=vertexOutputs.position;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vertexOutputs.vDirectionW=normalize((finalWorld*vec4f(positionUpdated,0.0)).xyz);
#endif
#ifdef CLUSTLIGHT_BATCH
vertexOutputs.vViewDepth=(scene.view*worldPos).z;
#endif
#ifndef UV1
var uvUpdated: vec2f= vec2f(0.,0.);
#endif
#ifdef MAINUV1
vertexOutputs.vMainUV1=uvUpdated;
#endif
#ifndef UV2
var uv2Updated: vec2f= vec2f(0.,0.);
#endif
#ifdef MAINUV2
vertexOutputs.vMainUV2=uv2Updated;
#endif
#include<uvVariableDeclaration>[3..7]
#include<samplerVertexImplementation>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_MATRIXNAME_,albedo,_INFONAME_,AlbedoInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,BASE_WEIGHT,_VARYINGNAME_,BaseWeight,_MATRIXNAME_,baseWeight,_INFONAME_,BaseWeightInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,BASE_DIFFUSE_ROUGHNESS,_VARYINGNAME_,BaseDiffuseRoughness,_MATRIXNAME_,baseDiffuseRoughness,_INFONAME_,BaseDiffuseRoughnessInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_MATRIXNAME_,reflectivity,_INFONAME_,ReflectivityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_MATRIXNAME_,microSurfaceSampler,_INFONAME_,MicroSurfaceSamplerInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_MATRIXNAME_,metallicReflectance,_INFONAME_,MetallicReflectanceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_MATRIXNAME_,reflectance,_INFONAME_,ReflectanceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)
#ifdef CLEARCOAT
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_MATRIXNAME_,clearCoat,_INFONAME_,ClearCoatInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness,_MATRIXNAME_,clearCoatRoughness,_INFONAME_,ClearCoatInfos.z)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_MATRIXNAME_,clearCoatBump,_INFONAME_,ClearCoatBumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_MATRIXNAME_,clearCoatTint,_INFONAME_,ClearCoatTintInfos.x)
#endif
#ifdef IRIDESCENCE
#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_MATRIXNAME_,iridescence,_INFONAME_,IridescenceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_MATRIXNAME_,iridescenceThickness,_INFONAME_,IridescenceInfos.z)
#endif
#ifdef SHEEN
#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness,_MATRIXNAME_,sheenRoughness,_INFONAME_,SheenInfos.z)
#endif
#ifdef ANISOTROPIC
#include<samplerVertexImplementation>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_MATRIXNAME_,anisotropy,_INFONAME_,AnisotropyInfos.x)
#endif
#ifdef SUBSURFACE
#include<samplerVertexImplementation>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_MATRIXNAME_,thickness,_INFONAME_,ThicknessInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_MATRIXNAME_,refractionIntensity,_INFONAME_,RefractionIntensityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_MATRIXNAME_,translucencyIntensity,_INFONAME_,TranslucencyIntensityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_MATRIXNAME_,translucencyColor,_INFONAME_,TranslucencyColorInfos.x)
#endif
#include<bumpVertex>
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#include<vertexColorMixing>
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;g.ShadersStoreWGSL[cI]||(g.ShadersStoreWGSL[cI]=$2);XJ={name:cI,shader:$2}});var iU,YJ,fI=S(()=>{O();iU="prePassDeclaration",YJ=`#ifdef PREPASS
#ifdef PREPASS_LOCAL_POSITION
varying vPosition : vec3f;
#endif
#ifdef PREPASS_DEPTH
varying vViewPos: vec3f;
#endif
#ifdef PREPASS_NORMALIZED_VIEW_DEPTH
varying vNormViewDepth: f32;
#endif
#if defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)
varying vCurrentPosition: vec4f;varying vPreviousPosition: vec4f;
#endif
#endif
`;g.IncludesShadersStoreWGSL[iU]||(g.IncludesShadersStoreWGSL[iU]=YJ)});var rU,KJ,hI=S(()=>{O();rU="oitDeclaration",KJ=`#ifdef ORDER_INDEPENDENT_TRANSPARENCY
#define MAX_DEPTH 99999.0
var oitDepthSamplerSampler: sampler;var oitDepthSampler: texture_2d<f32>;var oitFrontColorSamplerSampler: sampler;var oitFrontColorSampler: texture_2d<f32>;
#endif
`;g.IncludesShadersStoreWGSL[rU]||(g.IncludesShadersStoreWGSL[rU]=KJ)});var sU,qJ,nU=S(()=>{O();Au();sU="pbrFragmentExtraDeclaration",qJ=`varying vPositionW: vec3f;
#if DEBUGMODE>0
varying vClipSpacePosition: vec4f;
#endif
#include<mainUVVaryingDeclaration>[1..7]
#ifdef NORMAL
varying vNormalW: vec3f;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vEnvironmentIrradiance: vec3f;
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vColor: vec4f;
#endif
#ifdef CLUSTLIGHT_BATCH
varying vViewDepth: f32;
#endif
`;g.IncludesShadersStoreWGSL[sU]||(g.IncludesShadersStoreWGSL[sU]=qJ)});var aU,QJ,U_=S(()=>{O();aU="samplerFragmentDeclaration",QJ=`#ifdef _DEFINENAME_
#if _DEFINENAME_DIRECTUV==1
#define v_VARYINGNAME_UV vMainUV1
#elif _DEFINENAME_DIRECTUV==2
#define v_VARYINGNAME_UV vMainUV2
#elif _DEFINENAME_DIRECTUV==3
#define v_VARYINGNAME_UV vMainUV3
#elif _DEFINENAME_DIRECTUV==4
#define v_VARYINGNAME_UV vMainUV4
#elif _DEFINENAME_DIRECTUV==5
#define v_VARYINGNAME_UV vMainUV5
#elif _DEFINENAME_DIRECTUV==6
#define v_VARYINGNAME_UV vMainUV6
#else
varying v_VARYINGNAME_UV: vec2f;
#endif
var _SAMPLERNAME_SamplerSampler: sampler;var _SAMPLERNAME_Sampler: texture_2d<f32>;
#endif
`;g.IncludesShadersStoreWGSL[aU]||(g.IncludesShadersStoreWGSL[aU]=QJ)});var oU,jJ,lU=S(()=>{O();oU="samplerFragmentAlternateDeclaration",jJ=`#ifdef _DEFINENAME_
#if _DEFINENAME_DIRECTUV==1
#define v_VARYINGNAME_UV vMainUV1
#elif _DEFINENAME_DIRECTUV==2
#define v_VARYINGNAME_UV vMainUV2
#elif _DEFINENAME_DIRECTUV==3
#define v_VARYINGNAME_UV vMainUV3
#elif _DEFINENAME_DIRECTUV==4
#define v_VARYINGNAME_UV vMainUV4
#elif _DEFINENAME_DIRECTUV==5
#define v_VARYINGNAME_UV vMainUV5
#elif _DEFINENAME_DIRECTUV==6
#define v_VARYINGNAME_UV vMainUV6
#else
varying v_VARYINGNAME_UV: vec2f;
#endif
#endif
`;g.IncludesShadersStoreWGSL[oU]||(g.IncludesShadersStoreWGSL[oU]=jJ)});var cU,ZJ,fU=S(()=>{O();U_();lU();cU="pbrFragmentSamplersDeclaration",ZJ=`#include<samplerFragmentDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_SAMPLERNAME_,albedo)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_WEIGHT,_VARYINGNAME_,BaseWeight,_SAMPLERNAME_,baseWeight)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_DIFFUSE_ROUGHNESS,_VARYINGNAME_,BaseDiffuseRoughness,_SAMPLERNAME_,baseDiffuseRoughness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)
#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)
#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)
#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_SAMPLERNAME_,reflectivity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_SAMPLERNAME_,microSurface)
#include<samplerFragmentDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_SAMPLERNAME_,metallicReflectance)
#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_SAMPLERNAME_,reflectance)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)
#ifdef CLEARCOAT
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_SAMPLERNAME_,clearCoat)
#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS)
var clearCoatRoughnessSamplerSampler: sampler;var clearCoatRoughnessSampler: texture_2d<f32>;
#endif
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_SAMPLERNAME_,clearCoatBump)
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_SAMPLERNAME_,clearCoatTint)
#endif
#ifdef IRIDESCENCE
#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_SAMPLERNAME_,iridescence)
#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_SAMPLERNAME_,iridescenceThickness)
#endif
#ifdef SHEEN
#include<samplerFragmentDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_SAMPLERNAME_,sheen)
#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS)
var sheenRoughnessSamplerSampler: sampler;var sheenRoughnessSampler: texture_2d<f32>;
#endif
#endif
#ifdef ANISOTROPIC
#include<samplerFragmentDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_SAMPLERNAME_,anisotropy)
#endif
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
var reflectionSamplerSampler: sampler;var reflectionSampler: texture_cube<f32>;
#ifdef LODBASEDMICROSFURACE
#else
var reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_cube<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_cube<f32>;
#endif
#ifdef USEIRRADIANCEMAP
var irradianceSamplerSampler: sampler;var irradianceSampler: texture_cube<f32>;
#endif
#else
var reflectionSamplerSampler: sampler;var reflectionSampler: texture_2d<f32>;
#ifdef LODBASEDMICROSFURACE
#else
var reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_2d<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_2d<f32>;
#endif
#ifdef USEIRRADIANCEMAP
var irradianceSamplerSampler: sampler;var irradianceSampler: texture_2d<f32>;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vPositionUVW: vec3f;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vDirectionW: vec3f;
#endif
#endif
#endif
#ifdef ENVIRONMENTBRDF
var environmentBrdfSamplerSampler: sampler;var environmentBrdfSampler: texture_2d<f32>;
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
#ifdef SS_REFRACTIONMAP_3D
var refractionSamplerSampler: sampler;var refractionSampler: texture_cube<f32>;
#ifdef LODBASEDMICROSFURACE
#else
var refractionLowSamplerSampler: sampler;var refractionLowSampler: texture_cube<f32>;var refractionHighSamplerSampler: sampler;var refractionHighSampler: texture_cube<f32>;
#endif
#else
var refractionSamplerSampler: sampler;var refractionSampler: texture_2d<f32>;
#ifdef LODBASEDMICROSFURACE
#else
var refractionLowSamplerSampler: sampler;var refractionLowSampler: texture_2d<f32>;var refractionHighSamplerSampler: sampler;var refractionHighSampler: texture_2d<f32>;
#endif
#endif
#endif
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_SAMPLERNAME_,thickness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_SAMPLERNAME_,refractionIntensity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_SAMPLERNAME_,translucencyIntensity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_SAMPLERNAME_,translucencyColor)
#endif
#ifdef IBL_CDF_FILTERING
var icdfSamplerSampler: sampler;var icdfSampler: texture_2d<f32>;
#endif
`;g.IncludesShadersStoreWGSL[cU]||(g.IncludesShadersStoreWGSL[cU]=ZJ)});var hU,JJ,uU=S(()=>{O();hU="subSurfaceScatteringFunctions",JJ=`fn testLightingForSSS(diffusionProfile: f32)->bool
{return diffusionProfile<1.;}`;g.IncludesShadersStoreWGSL[hU]||(g.IncludesShadersStoreWGSL[hU]=JJ)});var dU,$J,Ru=S(()=>{O();dU="importanceSampling",$J=`fn hemisphereCosSample(u: vec2f)->vec3f {var phi: f32=2.*PI*u.x;var cosTheta2: f32=1.-u.y;var cosTheta: f32=sqrt(cosTheta2);var sinTheta: f32=sqrt(1.-cosTheta2);return vec3f(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}
fn hemisphereImportanceSampleDggx(u: vec2f,a: f32)->vec3f {var phi: f32=2.*PI*u.x;var cosTheta2: f32=(1.-u.y)/(1.+(a+1.)*((a-1.)*u.y));var cosTheta: f32=sqrt(cosTheta2);var sinTheta: f32=sqrt(1.-cosTheta2);return vec3f(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}
fn hemisphereImportanceSampleDCharlie(u: vec2f,a: f32)->vec3f { 
var phi: f32=2.*PI*u.x;var sinTheta: f32=pow(u.y,a/(2.*a+1.));var cosTheta: f32=sqrt(1.-sinTheta*sinTheta);return vec3f(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}`;g.IncludesShadersStoreWGSL[dU]||(g.IncludesShadersStoreWGSL[dU]=$J)});var pU,e$,mU=S(()=>{O();pU="pbrHelperFunctions",e$=`#define MINIMUMVARIANCE 0.0005
fn convertRoughnessToAverageSlope(roughness: f32)->f32
{return roughness*roughness+MINIMUMVARIANCE;}
fn fresnelGrazingReflectance(reflectance0: f32)->f32 {var reflectance90: f32=saturate(reflectance0*25.0);return reflectance90;}
fn getAARoughnessFactors(normalVector: vec3f)->vec2f {
#ifdef SPECULARAA
var nDfdx: vec3f=dpdx(normalVector.xyz);var nDfdy: vec3f=dpdy(normalVector.xyz);var slopeSquare: f32=max(dot(nDfdx,nDfdx),dot(nDfdy,nDfdy));var geometricRoughnessFactor: f32=pow(saturate(slopeSquare),0.333);var geometricAlphaGFactor: f32=sqrt(slopeSquare);geometricAlphaGFactor*=0.75;return vec2f(geometricRoughnessFactor,geometricAlphaGFactor);
#else
return vec2f(0.);
#endif
}
#ifdef ANISOTROPIC
#ifdef ANISOTROPIC_LEGACY
fn getAnisotropicRoughness(alphaG: f32,anisotropy: f32)->vec2f {var alphaT: f32=max(alphaG*(1.0+anisotropy),MINIMUMVARIANCE);var alphaB: f32=max(alphaG*(1.0-anisotropy),MINIMUMVARIANCE);return vec2f(alphaT,alphaB);}
fn getAnisotropicBentNormals(T: vec3f,B: vec3f,N: vec3f,V: vec3f,anisotropy: f32,roughness: f32)->vec3f {var anisotropicFrameDirection: vec3f=select(T,B,anisotropy>=0.0);var anisotropicFrameTangent: vec3f=cross(normalize(anisotropicFrameDirection),V);var anisotropicFrameNormal: vec3f=cross(anisotropicFrameTangent,anisotropicFrameDirection);var anisotropicNormal: vec3f=normalize(mix(N,anisotropicFrameNormal,abs(anisotropy)));return anisotropicNormal;}
#else
fn getAnisotropicRoughness(alphaG: f32,anisotropy: f32)->vec2f {var alphaT: f32=max(mix(alphaG,1.0,anisotropy*anisotropy),MINIMUMVARIANCE);var alphaB: f32=max(alphaG,MINIMUMVARIANCE);return vec2f(alphaT,alphaB);}
fn getAnisotropicBentNormals(T: vec3f,B: vec3f,N: vec3f,V: vec3f,anisotropy: f32,roughness: f32)->vec3f {var bentNormal: vec3f=cross(B,V);bentNormal=normalize(cross(bentNormal,B));var sq=1.0-anisotropy*(1.0-roughness);var a: f32=sq*sq*sq*sq;bentNormal=normalize(mix(bentNormal,N,a));return bentNormal;}
#endif
#endif
#if defined(CLEARCOAT) || defined(SS_REFRACTION)
fn cocaLambertVec3(alpha: vec3f,distance: f32)->vec3f {return exp(-alpha*distance);}
fn cocaLambert(NdotVRefract: f32,NdotLRefract: f32,alpha: vec3f,thickness: f32)->vec3f {return cocaLambertVec3(alpha,(thickness*((NdotLRefract+NdotVRefract)/(NdotLRefract*NdotVRefract))));}
fn computeColorAtDistanceInMedia(color: vec3f,distance: f32)->vec3f {return -log(color)/distance;}
fn computeClearCoatAbsorption(NdotVRefract: f32,NdotLRefract: f32,clearCoatColor: vec3f,clearCoatThickness: f32,clearCoatIntensity: f32)->vec3f {var clearCoatAbsorption: vec3f=mix( vec3f(1.0),
cocaLambert(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness),
clearCoatIntensity);return clearCoatAbsorption;}
#endif
#ifdef MICROSURFACEAUTOMATIC
fn computeDefaultMicroSurface(microSurface: f32,reflectivityColor: vec3f)->f32
{const kReflectivityNoAlphaWorkflow_SmoothnessMax: f32=0.95;var reflectivityLuminance: f32=getLuminance(reflectivityColor);var reflectivityLuma: f32=sqrt(reflectivityLuminance);var resultMicroSurface=reflectivityLuma*kReflectivityNoAlphaWorkflow_SmoothnessMax;return resultMicroSurface;}
#endif
`;g.IncludesShadersStoreWGSL[pU]||(g.IncludesShadersStoreWGSL[pU]=e$)});var _U,t$,gU=S(()=>{O();OC();_U="pbrDirectLightingSetupFunctions",t$=`struct preLightingInfo
{lightOffset: vec3f,
lightDistanceSquared: f32,
lightDistance: f32,
attenuation: f32,
L: vec3f,
H: vec3f,
NdotV: f32,
NdotLUnclamped: f32,
NdotL: f32,
VdotH: f32,
LdotV: f32,
roughness: f32,
diffuseRoughness: f32,
surfaceAlbedo: vec3f,
#ifdef IRIDESCENCE
iridescenceIntensity: f32
#endif
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
areaLightDiffuse: vec3f,
#ifdef SPECULARTERM
areaLightSpecular: vec3f,
areaLightFresnel: vec4f
#endif
#endif
};fn computePointAndSpotPreLightingInfo(lightData: vec4f,V: vec3f,N: vec3f,posW: vec3f)->preLightingInfo {var result: preLightingInfo;result.lightOffset=lightData.xyz-posW;result.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);result.lightDistance=sqrt(result.lightDistanceSquared);result.L=normalize(result.lightOffset);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);return result;}
fn computeDirectionalPreLightingInfo(lightData: vec4f,V: vec3f,N: vec3f)->preLightingInfo {var result: preLightingInfo;result.lightDistance=length(-lightData.xyz);result.L=normalize(-lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);result.LdotV=dot(result.L,V);return result;}
fn computeHemisphericPreLightingInfo(lightData: vec4f,V: vec3f,N: vec3f)->preLightingInfo {var result: preLightingInfo;result.NdotL=dot(N,lightData.xyz)*0.5+0.5;result.NdotL=saturateEps(result.NdotL);result.NdotLUnclamped=result.NdotL;
#ifdef SPECULARTERM
result.L=normalize(lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));
#endif
return result;}
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
#include<ltcHelperFunctions>
var areaLightsLTC1SamplerSampler: sampler;var areaLightsLTC1Sampler: texture_2d<f32>;var areaLightsLTC2SamplerSampler: sampler;var areaLightsLTC2Sampler: texture_2d<f32>;fn computeAreaPreLightingInfo(ltc1: texture_2d<f32>,ltc1Sampler:sampler,ltc2:texture_2d<f32>,ltc2Sampler:sampler,viewDirectionW: vec3f,vNormal:vec3f,vPosition:vec3f,lightCenter:vec3f,halfWidth:vec3f, halfHeight:vec3f,roughness:f32)->preLightingInfo {var result: preLightingInfo;var data: areaLightData=computeAreaLightSpecularDiffuseFresnel(ltc1,ltc1Sampler,ltc2,ltc2Sampler,viewDirectionW,vNormal,vPosition,lightCenter,halfWidth,halfHeight,roughness);
#ifdef SPECULARTERM
result.areaLightFresnel=data.Fresnel;result.areaLightSpecular=data.Specular;
#endif
result.areaLightDiffuse+=data.Diffuse;return result;}
#endif
`;g.IncludesShadersStoreWGSL[_U]||(g.IncludesShadersStoreWGSL[_U]=t$)});var vU,i$,SU=S(()=>{O();vU="pbrDirectLightingFalloffFunctions",i$=`fn computeDistanceLightFalloff_Standard(lightOffset: vec3f,range: f32)->f32
{return max(0.,1.0-length(lightOffset)/range);}
fn computeDistanceLightFalloff_Physical(lightDistanceSquared: f32)->f32
{return 1.0/maxEps(lightDistanceSquared);}
fn computeDistanceLightFalloff_GLTF(lightDistanceSquared: f32,inverseSquaredRange: f32)->f32
{var lightDistanceFalloff: f32=1.0/maxEps(lightDistanceSquared);var factor: f32=lightDistanceSquared*inverseSquaredRange;var attenuation: f32=saturate(1.0-factor*factor);attenuation*=attenuation;lightDistanceFalloff*=attenuation;return lightDistanceFalloff;}
fn computeDirectionalLightFalloff_IES(lightDirection: vec3f,directionToLightCenterW: vec3f,iesLightTexture: texture_2d<f32>,iesLightTextureSampler: sampler)->f32
{var cosAngle: f32=dot(-lightDirection,directionToLightCenterW);var angle=acos(cosAngle)/PI;return textureSampleLevel(iesLightTexture,iesLightTextureSampler,vec2f(angle,0),0.).r;}
fn computeDistanceLightFalloff(lightOffset: vec3f,lightDistanceSquared: f32,range: f32,inverseSquaredRange: f32)->f32
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDistanceLightFalloff_Physical(lightDistanceSquared);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDistanceLightFalloff_GLTF(lightDistanceSquared,inverseSquaredRange);
#else
return computeDistanceLightFalloff_Standard(lightOffset,range);
#endif
}
fn computeDirectionalLightFalloff_Standard(lightDirection: vec3f,directionToLightCenterW: vec3f,cosHalfAngle: f32,exponent: f32)->f32
{var falloff: f32=0.0;var cosAngle: f32=maxEps(dot(-lightDirection,directionToLightCenterW));if (cosAngle>=cosHalfAngle)
{falloff=max(0.,pow(cosAngle,exponent));}
return falloff;}
fn computeDirectionalLightFalloff_Physical(lightDirection: vec3f,directionToLightCenterW: vec3f,cosHalfAngle: f32)->f32
{const kMinusLog2ConeAngleIntensityRatio: f32=6.64385618977; 
var concentrationKappa: f32=kMinusLog2ConeAngleIntensityRatio/(1.0-cosHalfAngle);var lightDirectionSpreadSG: vec4f= vec4f(-lightDirection*concentrationKappa,-concentrationKappa);var falloff: f32=exp2(dot( vec4f(directionToLightCenterW,1.0),lightDirectionSpreadSG));return falloff;}
fn computeDirectionalLightFalloff_GLTF(lightDirection: vec3f,directionToLightCenterW: vec3f,lightAngleScale: f32,lightAngleOffset: f32)->f32
{var cd: f32=dot(-lightDirection,directionToLightCenterW);var falloff: f32=saturate(cd*lightAngleScale+lightAngleOffset);falloff*=falloff;return falloff;}
fn computeDirectionalLightFalloff(lightDirection: vec3f,directionToLightCenterW: vec3f,cosHalfAngle: f32,exponent: f32,lightAngleScale: f32,lightAngleOffset: f32)->f32
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDirectionalLightFalloff_Physical(lightDirection,directionToLightCenterW,cosHalfAngle);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDirectionalLightFalloff_GLTF(lightDirection,directionToLightCenterW,lightAngleScale,lightAngleOffset);
#else
return computeDirectionalLightFalloff_Standard(lightDirection,directionToLightCenterW,cosHalfAngle,exponent);
#endif
}`;g.IncludesShadersStoreWGSL[vU]||(g.IncludesShadersStoreWGSL[vU]=i$)});var EU,r$,bu=S(()=>{O();EU="hdrFilteringFunctions",r$=`#ifdef NUM_SAMPLES
#if NUM_SAMPLES>0
fn radicalInverse_VdC(value: u32)->f32 
{var bits=(value<<16u) | (value>>16u);bits=((bits & 0x55555555u)<<1u) | ((bits & 0xAAAAAAAAu)>>1u);bits=((bits & 0x33333333u)<<2u) | ((bits & 0xCCCCCCCCu)>>2u);bits=((bits & 0x0F0F0F0Fu)<<4u) | ((bits & 0xF0F0F0F0u)>>4u);bits=((bits & 0x00FF00FFu)<<8u) | ((bits & 0xFF00FF00u)>>8u);return f32(bits)*2.3283064365386963e-10; }
fn hammersley(i: u32,N: u32)->vec2f
{return vec2f( f32(i)/ f32(N),radicalInverse_VdC(i));}
fn log4(x: f32)->f32 {return log2(x)/2.;}
fn uv_to_normal(uv: vec2f)->vec3f {var N: vec3f;var uvRange: vec2f=uv;var theta: f32=uvRange.x*2.0*PI;var phi: f32=uvRange.y*PI;N.x=cos(theta)*sin(phi);N.z=sin(theta)*sin(phi);N.y=cos(phi);return N;}
const NUM_SAMPLES_FLOAT: f32= f32(NUM_SAMPLES);const NUM_SAMPLES_FLOAT_INVERSED: f32=1./NUM_SAMPLES_FLOAT;const K: f32=4.;fn irradiance(
#ifdef CUSTOM_IRRADIANCE_FILTERING_INPUT
CUSTOM_IRRADIANCE_FILTERING_INPUT
#else
inputTexture: texture_cube<f32>,inputSampler: sampler,
#endif
inputN: vec3f,
filteringInfo: vec2f,
diffuseRoughness: f32,
surfaceAlbedo: vec3f,
inputV: vec3f
#ifdef IBL_CDF_FILTERING
,icdfSampler: texture_2d<f32>,icdfSamplerSampler: sampler
#endif
)->vec3f
{var n: vec3f=normalize(inputN);var result: vec3f= vec3f(0.0);
#ifndef IBL_CDF_FILTERING
var tangent: vec3f=select(vec3f(1.,0.,0.),vec3f(0.,0.,1.),abs(n.z)<0.999);tangent=normalize(cross(tangent,n));var bitangent: vec3f=cross(n,tangent);var tbn: mat3x3f= mat3x3f(tangent,bitangent,n);var tbnInverse: mat3x3f=transpose(tbn);
#endif
var maxLevel: f32=filteringInfo.y;var dim0: f32=filteringInfo.x;var omegaP: f32=(4.*PI)/(6.*dim0*dim0);var clampedAlbedo: vec3f=clamp(surfaceAlbedo,vec3f(0.1),vec3f(1.0));for(var i: u32=0u; i<NUM_SAMPLES; i++)
{var Xi: vec2f=hammersley(i,NUM_SAMPLES);
#ifdef IBL_CDF_FILTERING
var T: vec2f;T.x=textureSampleLevel(icdfSampler,icdfSamplerSampler,vec2(Xi.x,0.0),0.0).x;T.y=textureSampleLevel(icdfSampler,icdfSamplerSampler,vec2(T.x,Xi.y),0.0).y;var Ls: vec3f=uv_to_normal(vec2f(1.0-fract(T.x+0.25),T.y));var NoL: f32=dot(n,Ls);var NoV: f32=dot(n,inputV);
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
var LoV: f32=dot(Ls,inputV);
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
var H: vec3f=(inputV+Ls)*0.5;var VoH: f32=dot(inputV,H);
#endif 
#else
var Ls: vec3f=hemisphereCosSample(Xi);Ls=normalize(Ls);var Ns: vec3f= vec3f(0.,0.,1.);var NoL: f32=dot(Ns,Ls);var V: vec3f=tbnInverse*inputV;var NoV: f32=dot(Ns,V);
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
var LoV: f32=dot(Ls,V);
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
var H: vec3f=(V+Ls)*0.5;var VoH: f32=dot(V,H);
#endif
#endif
if (NoL>0.) {
#ifdef IBL_CDF_FILTERING
var pdf: f32=textureSampleLevel(icdfSampler,icdfSamplerSampler,T,0.0).z;var c: vec3f=textureSampleLevel(inputTexture,inputSampler,Ls,0.0).rgb;
#else
var pdf_inversed: f32=PI/NoL;var omegaS: f32=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;var l: f32=log4(omegaS)-log4(omegaP)+log4(K);var mipLevel: f32=clamp(l,0.0,maxLevel);
#ifdef CUSTOM_IRRADIANCE_FILTERING_FUNCTION
CUSTOM_IRRADIANCE_FILTERING_FUNCTION
#else
var c: vec3f=textureSampleLevel(inputTexture,inputSampler,tbn*Ls,mipLevel).rgb;
#endif
#endif
#ifdef GAMMA_INPUT
c=toLinearSpaceVec3(c);
#endif
var diffuseRoughnessTerm: vec3f=vec3f(1.0);
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
diffuseRoughnessTerm=diffuseBRDF_EON(clampedAlbedo,diffuseRoughness,NoL,NoV,LoV)*PI;
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
diffuseRoughnessTerm=vec3f(diffuseBRDF_Burley(NoL,NoV,VoH,diffuseRoughness)*PI);
#endif
#ifdef IBL_CDF_FILTERING
var light: vec3f=vec3f(0.0);if (pdf>1e-6) {light=vec3f(1.0)/vec3f(pdf)*c;}
result+=NoL*diffuseRoughnessTerm*light;
#else
result+=c*diffuseRoughnessTerm;
#endif
}}
result=result*NUM_SAMPLES_FLOAT_INVERSED;
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
result=result/clampedAlbedo;
#endif
return result;}
fn radiance(alphaG: f32,inputTexture: texture_cube<f32>,inputSampler: sampler,inputN: vec3f,filteringInfo: vec2f)->vec3f
{var n: vec3f=normalize(inputN);var c: vec3f=textureSample(inputTexture,inputSampler,n).rgb; 
if (alphaG==0.) {
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
return c;} else {var result: vec3f= vec3f(0.);var tangent: vec3f=select(vec3f(1.,0.,0.),vec3f(0.,0.,1.),abs(n.z)<0.999);tangent=normalize(cross(tangent,n));var bitangent: vec3f=cross(n,tangent);var tbn: mat3x3f= mat3x3f(tangent,bitangent,n);var maxLevel: f32=filteringInfo.y;var dim0: f32=filteringInfo.x;var omegaP: f32=(4.*PI)/(6.*dim0*dim0);var weight: f32=0.;for(var i: u32=0u; i<NUM_SAMPLES; i++)
{var Xi: vec2f=hammersley(i,NUM_SAMPLES);var H: vec3f=hemisphereImportanceSampleDggx(Xi,alphaG);var NoV: f32=1.;var NoH: f32=H.z;var NoH2: f32=H.z*H.z;var NoL: f32=2.*NoH2-1.;var L: vec3f= vec3f(2.*NoH*H.x,2.*NoH*H.y,NoL);L=normalize(L);if (NoL>0.) {var pdf_inversed: f32=4./normalDistributionFunction_TrowbridgeReitzGGX(NoH,alphaG);var omegaS: f32=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;var l: f32=log4(omegaS)-log4(omegaP)+log4(K);var mipLevel: f32=clamp( f32(l),0.0,maxLevel);weight+=NoL;var c: vec3f=textureSampleLevel(inputTexture,inputSampler,tbn*L,mipLevel).rgb;
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
result+=c*NoL;}}
result=result/weight;return result;}}
#endif
#endif
`;g.IncludesShadersStoreWGSL[EU]||(g.IncludesShadersStoreWGSL[EU]=r$)});var TU,s$,uI=S(()=>{O();TU="pbrBlockReflectance0",s$=`var reflectanceF0: f32=reflectivityOut.reflectanceF0;var specularEnvironmentR0: vec3f=reflectivityOut.colorReflectanceF0;var specularEnvironmentR90: vec3f= reflectivityOut.reflectanceF90;
#ifdef ALPHAFRESNEL
var reflectance90: f32=fresnelGrazingReflectance(reflectanceF0);specularEnvironmentR90=specularEnvironmentR90*reflectance90;
#endif
`;g.IncludesShadersStoreWGSL[TU]||(g.IncludesShadersStoreWGSL[TU]=s$)});var xU,n$,AU=S(()=>{O();LC();uI();xU="pbrDirectLightingFunctions",n$=`#define CLEARCOATREFLECTANCE90 1.0
struct lightingInfo
{diffuse: vec3f,
#ifdef SS_TRANSLUCENCY
diffuseTransmission: vec3f,
#endif
#ifdef SPECULARTERM
specular: vec3f,
#endif
#ifdef CLEARCOAT
clearCoat: vec4f,
#endif
#ifdef SHEEN
sheen: vec3f
#endif
};fn adjustRoughnessFromLightProperties(roughness: f32,lightRadius: f32,lightDistance: f32)->f32 {
#if defined(USEPHYSICALLIGHTFALLOFF) || defined(USEGLTFLIGHTFALLOFF)
var lightRoughness: f32=lightRadius/lightDistance;var totalRoughness: f32=saturate(lightRoughness+roughness);return totalRoughness;
#else
return roughness;
#endif
}
fn computeHemisphericDiffuseLighting(info: preLightingInfo,lightColor: vec3f,groundColor: vec3f)->vec3f {return mix(groundColor,lightColor,info.NdotL);}
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
fn computeAreaDiffuseLighting(info: preLightingInfo,lightColor: vec3f)->vec3f {return info.areaLightDiffuse*lightColor;}
#endif
fn computeDiffuseLighting(info: preLightingInfo,lightColor: vec3f)->vec3f {var diffuseTerm: vec3f=vec3f(1.0/PI);
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_LEGACY
diffuseTerm=vec3f(diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.roughness));
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
diffuseTerm=vec3f(diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.diffuseRoughness));
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
var clampedAlbedo: vec3f=clamp(info.surfaceAlbedo,vec3f(0.1),vec3f(1.0));diffuseTerm=diffuseBRDF_EON(clampedAlbedo,info.diffuseRoughness,info.NdotL,info.NdotV,info.LdotV);diffuseTerm/=clampedAlbedo;
#endif
return diffuseTerm*info.attenuation*info.NdotL*lightColor;}
fn computeProjectionTextureDiffuseLighting(projectionLightTexture: texture_2d<f32>,projectionLightSampler: sampler,textureProjectionMatrix: mat4x4f,posW: vec3f)->vec3f{var strq: vec4f=textureProjectionMatrix* vec4f(posW,1.0);strq/=strq.w;var textureColor: vec3f=textureSample(projectionLightTexture,projectionLightSampler,strq.xy).rgb;return toLinearSpaceVec3(textureColor);}
#ifdef SS_TRANSLUCENCY
fn computeDiffuseTransmittedLighting(info: preLightingInfo,lightColor: vec3f,transmittance: vec3f)->vec3f {var transmittanceNdotL=vec3f(0.0);var NdotL: f32=absEps(info.NdotLUnclamped);
#ifndef SS_TRANSLUCENCY_LEGACY
if (info.NdotLUnclamped<0.0) {
#endif
var wrapNdotL: f32=computeWrappedDiffuseNdotL(NdotL,0.02);var trAdapt: f32=step(0.,info.NdotLUnclamped);transmittanceNdotL=mix(transmittance*wrapNdotL, vec3f(wrapNdotL),trAdapt);
#ifndef SS_TRANSLUCENCY_LEGACY
}
var diffuseTerm : vec3f=vec3f(1.0/PI);
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_LEGACY
diffuseTerm=vec3f(diffuseBRDF_Burley(
info.NdotL,info.NdotV,info.VdotH,info.roughness));
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
diffuseTerm=vec3f(diffuseBRDF_Burley(
info.NdotL,info.NdotV,info.VdotH,info.diffuseRoughness));
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
var clampedAlbedo: vec3f=clamp(info.surfaceAlbedo,vec3f(0.1),vec3f(1.0));diffuseTerm=diffuseBRDF_EON(clampedAlbedo,info.diffuseRoughness,
info.NdotL,info.NdotV,info.LdotV);diffuseTerm/=clampedAlbedo;
#endif
return (transmittanceNdotL*diffuseTerm)*info.attenuation*lightColor;
#else
let diffuseTerm=diffuseBRDF_Burley(NdotL,info.NdotV,info.VdotH,info.roughness);return diffuseTerm*transmittanceNdotL*info.attenuation*lightColor;
#endif
}
#endif
#ifdef SPECULARTERM
fn computeSpecularLighting(info: preLightingInfo,N: vec3f,reflectance0: vec3f,fresnel: vec3f,geometricRoughnessFactor: f32,lightColor: vec3f)->vec3f {var NdotH: f32=saturateEps(dot(N,info.H));var roughness: f32=max(info.roughness,geometricRoughnessFactor);var alphaG: f32=convertRoughnessToAverageSlope(roughness);
#ifdef IRIDESCENCE
fresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);
#endif
var distribution: f32=normalDistributionFunction_TrowbridgeReitzGGX(NdotH,alphaG);
#ifdef BRDF_V_HEIGHT_CORRELATED
var smithVisibility: f32=smithVisibility_GGXCorrelated(info.NdotL,info.NdotV,alphaG);
#else
var smithVisibility: f32=smithVisibility_TrowbridgeReitzGGXFast(info.NdotL,info.NdotV,alphaG);
#endif
var specTerm: vec3f=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
fn computeAreaSpecularLighting(info: preLightingInfo,specularColor: vec3f,reflectance0: vec3f,reflectance90: vec3f)->vec3f {var fresnel:vec3f =reflectance0*specularColor*info.areaLightFresnel.x+( vec3f( 1.0 )-specularColor )*info.areaLightFresnel.y*reflectance90;return specularColor*fresnel*info.areaLightSpecular;}
#endif
#endif
#ifdef ANISOTROPIC
fn computeAnisotropicSpecularLighting(info: preLightingInfo,V: vec3f,N: vec3f,T: vec3f,B: vec3f,anisotropy: f32,reflectance0: vec3f,reflectance90: vec3f,geometricRoughnessFactor: f32,lightColor: vec3f)->vec3f {var NdotH: f32=saturateEps(dot(N,info.H));var TdotH: f32=dot(T,info.H);var BdotH: f32=dot(B,info.H);var TdotV: f32=dot(T,V);var BdotV: f32=dot(B,V);var TdotL: f32=dot(T,info.L);var BdotL: f32=dot(B,info.L);var alphaG: f32=convertRoughnessToAverageSlope(info.roughness);var alphaTB: vec2f=getAnisotropicRoughness(alphaG,anisotropy);alphaTB=max(alphaTB,vec2f(geometricRoughnessFactor*geometricRoughnessFactor));var fresnel: vec3f=fresnelSchlickGGXVec3(info.VdotH,reflectance0,reflectance90);
#ifdef IRIDESCENCE
fresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);
#endif
var distribution: f32=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);var smithVisibility: f32=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);var specTerm: vec3f=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}
#endif
#ifdef CLEARCOAT
fn computeClearCoatLighting(info: preLightingInfo,Ncc: vec3f,geometricRoughnessFactor: f32,clearCoatIntensity: f32,lightColor: vec3f)->vec4f {var NccdotL: f32=saturateEps(dot(Ncc,info.L));var NccdotH: f32=saturateEps(dot(Ncc,info.H));var clearCoatRoughness: f32=max(info.roughness,geometricRoughnessFactor);var alphaG: f32=convertRoughnessToAverageSlope(clearCoatRoughness);var fresnel: f32=fresnelSchlickGGX(info.VdotH,uniforms.vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnel*=clearCoatIntensity;var distribution: f32=normalDistributionFunction_TrowbridgeReitzGGX(NccdotH,alphaG);var kelemenVisibility: f32=visibility_Kelemen(info.VdotH);var clearCoatTerm: f32=fresnel*distribution*kelemenVisibility;return vec4f(
clearCoatTerm*info.attenuation*NccdotL*lightColor,
1.0-fresnel
);}
fn computeClearCoatLightingAbsorption(NdotVRefract: f32,L: vec3f,Ncc: vec3f,clearCoatColor: vec3f,clearCoatThickness: f32,clearCoatIntensity: f32)->vec3f {var LRefract: vec3f=-refract(L,Ncc,uniforms.vClearCoatRefractionParams.y);var NdotLRefract: f32=saturateEps(dot(Ncc,LRefract));var absorption: vec3f=computeClearCoatAbsorption(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness,clearCoatIntensity);return absorption;}
#endif
#ifdef SHEEN
fn computeSheenLighting(info: preLightingInfo,N: vec3f,reflectance0: vec3f,reflectance90: vec3f,geometricRoughnessFactor: f32,lightColor: vec3f)->vec3f {var NdotH: f32=saturateEps(dot(N,info.H));var roughness: f32=max(info.roughness,geometricRoughnessFactor);var alphaG: f32=convertRoughnessToAverageSlope(roughness);var fresnel: f32=1.;var distribution: f32=normalDistributionFunction_CharlieSheen(NdotH,alphaG);/*#ifdef SHEEN_SOFTER
var visibility: f32=visibility_CharlieSheen(info.NdotL,info.NdotV,alphaG);
#else */
var visibility: f32=visibility_Ashikhmin(info.NdotL,info.NdotV);/* #endif */
var sheenTerm: f32=fresnel*distribution*visibility;return sheenTerm*info.attenuation*info.NdotL*lightColor;}
#endif
#ifdef CLUSTLIGHT_BATCH
#include<clusteredLightingFunctions>
fn computeClusteredLighting(
lightDataTexture: texture_2d<f32>,
tileMaskBuffer: ptr<storage,array<u32>>,
lightData: vec4f,
sliceRange: vec2u,
V: vec3f,
N: vec3f,
posW: vec3f,
surfaceAlbedo: vec3f,
reflectivityOut: reflectivityOutParams,
#ifdef IRIDESCENCE
iridescenceIntensity: f32,
#endif
#ifdef SS_TRANSLUCENCY
subSurfaceOut: subSurfaceOutParams,
#endif
#ifdef SPECULARTERM
AARoughnessFactor: f32,
#endif
#ifdef ANISOTROPIC
anisotropicOut: anisotropicOutParams,
#endif
#ifdef SHEEN
sheenOut: sheenOutParams,
#endif
#ifdef CLEARCOAT
clearcoatOut: clearcoatOutParams,
#endif
)->lightingInfo {let NdotV=absEps(dot(N,V));
#include<pbrBlockReflectance0>
#ifdef CLEARCOAT
specularEnvironmentR0=clearcoatOut.specularEnvironmentR0;
#endif
var result: lightingInfo;let tilePosition=vec2u(fragmentInputs.position.xy*lightData.xy);let maskResolution=vec2u(lightData.zw);var tileIndex=(tilePosition.x*maskResolution.x+tilePosition.y)*maskResolution.y;let batchRange=sliceRange/CLUSTLIGHT_BATCH;var batchOffset=batchRange.x*CLUSTLIGHT_BATCH;tileIndex+=batchRange.x;for (var i=batchRange.x; i<=batchRange.y; i+=1) {var mask=tileMaskBuffer[tileIndex];tileIndex+=1;let maskOffset=max(sliceRange.x,batchOffset)-batchOffset; 
let maskWidth=min(sliceRange.y-batchOffset+1,CLUSTLIGHT_BATCH);mask=extractBits(mask,maskOffset,maskWidth);while mask != 0 {let trailing=firstTrailingBit(mask);mask ^= 1u<<trailing;let light=getClusteredLight(lightDataTexture,batchOffset+maskOffset+trailing);var preInfo=computePointAndSpotPreLightingInfo(light.vLightData,V,N,posW);preInfo.NdotV=NdotV;preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light.vLightFalloff.x,light.vLightFalloff.y);if light.vLightDirection.w>=0.0 {preInfo.attenuation*=computeDirectionalLightFalloff(light.vLightDirection.xyz,preInfo.L,light.vLightDirection.w,light.vLightData.w,light.vLightFalloff.z,light.vLightFalloff.w);}
preInfo.roughness=adjustRoughnessFromLightProperties(reflectivityOut.roughness,light.vLightSpecular.a,preInfo.lightDistance);preInfo.diffuseRoughness=reflectivityOut.diffuseRoughness;preInfo.surfaceAlbedo=surfaceAlbedo;
#ifdef IRIDESCENCE
preInfo.iridescenceIntensity=iridescenceIntensity;
#endif
var info: lightingInfo;
#ifdef SS_TRANSLUCENCY
#ifdef SS_TRANSLUCENCY_LEGACY
info.diffuse=computeDiffuseTransmittedLighting(preInfo,light.vLightDiffuse.rgb,subSurfaceOut.transmittance);info.diffuseTransmission=vec3(0);
#else
info.diffuse=computeDiffuseLighting(preInfo,light.vLightDiffuse.rgb)*(1.0-subSurfaceOut.translucencyIntensity);info.diffuseTransmission=computeDiffuseTransmittedLighting(preInfo,light.vLightDiffuse.rgb,subSurfaceOut.transmittance);
#endif
#else
info.diffuse=computeDiffuseLighting(preInfo,light.vLightDiffuse.rgb);
#endif
#ifdef SPECULARTERM
#if CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR
let metalFresnel=reflectivityOut.specularWeight*getF82Specular(preInfo.VdotH,specularEnvironmentR0,reflectivityOut.colorReflectanceF90,reflectivityOut.roughness);let dielectricFresnel=fresnelSchlickGGXVec3(preInfo.VdotH,reflectivityOut.dielectricColorF0,reflectivityOut.colorReflectanceF90);let coloredFresnel=mix(dielectricFresnel,metalFresnel,reflectivityOut.metallic);
#else
let coloredFresnel=fresnelSchlickGGXVec3(preInfo.VdotH,specularEnvironmentR0,reflectivityOut.colorReflectanceF90);
#endif
#ifndef LEGACY_SPECULAR_ENERGY_CONSERVATION
let NdotH=dot(N,preInfo.H);let fresnel=fresnelSchlickGGXVec3(NdotH,vec3(reflectanceF0),specularEnvironmentR90);info.diffuse*=(vec3(1.0)-fresnel);
#endif
#ifdef ANISOTROPIC
info.specular=computeAnisotropicSpecularLighting(preInfo,V,N,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactor,light.vLightDiffuse.rgb);
#else
info.specular=computeSpecularLighting(preInfo,N,specularEnvironmentR0,coloredFresnel,AARoughnessFactor,light.vLightDiffuse.rgb);
#endif
#endif
#ifdef SHEEN
#ifdef SHEEN_LINKWITHALBEDO
preInfo.roughness=sheenOut.sheenIntensity;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light.vLightSpecular.a,preInfo.lightDistance);
#endif
info.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactor,light.vLightDiffuse.rgb);
#endif
#ifdef CLEARCOAT
preInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light.vLightSpecular.a,preInfo.lightDistance);info.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,light.vLightDiffuse.rgb);
#ifdef CLEARCOAT_TINT
let absorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);info.diffuse*=absorption;
#ifdef SS_TRANSLUCENCY
info.diffuseTransmission*=absorption;
#endif
#ifdef SPECULARTERM
info.specular*=absorption;
#endif
#endif
info.diffuse*=info.clearCoat.w;
#ifdef SS_TRANSLUCENCY
info.diffuseTransmission*=info.clearCoat.w;
#endif
#ifdef SPECULARTERM
info.specular*=info.clearCoat.w;
#endif
#ifdef SHEEN
info.sheen*=info.clearCoat.w;
#endif
#endif
result.diffuse+=info.diffuse;
#ifdef SS_TRANSLUCENCY
result.diffuseTransmission+=info.diffuseTransmission;
#endif
#ifdef SPECULARTERM
result.specular+=info.specular;
#endif
#ifdef CLEARCOAT
result.clearCoat+=info.clearCoat;
#endif
#ifdef SHEEN
result.sheen+=info.sheen;
#endif
}
batchOffset+=CLUSTLIGHT_BATCH;}
return result;}
#endif
`;g.IncludesShadersStoreWGSL[xU]||(g.IncludesShadersStoreWGSL[xU]=n$)});var RU,a$,bU=S(()=>{O();RU="pbrIBLFunctions",a$=`#if defined(REFLECTION) || defined(SS_REFRACTION)
fn getLodFromAlphaG(cubeMapDimensionPixels: f32,microsurfaceAverageSlope: f32)->f32 {var microsurfaceAverageSlopeTexels: f32=cubeMapDimensionPixels*microsurfaceAverageSlope;var lod: f32=log2(microsurfaceAverageSlopeTexels);return lod;}
fn getLinearLodFromRoughness(cubeMapDimensionPixels: f32,roughness: f32)->f32 {var lod: f32=log2(cubeMapDimensionPixels)*roughness;return lod;}
#endif
#if defined(ENVIRONMENTBRDF) && defined(RADIANCEOCCLUSION)
fn environmentRadianceOcclusion(ambientOcclusion: f32,NdotVUnclamped: f32)->f32 {var temp: f32=NdotVUnclamped+ambientOcclusion;return saturate(temp*temp-1.0+ambientOcclusion);}
#endif
#if defined(ENVIRONMENTBRDF) && defined(HORIZONOCCLUSION)
fn environmentHorizonOcclusion(view: vec3f,normal: vec3f,geometricNormal: vec3f)->f32 {var reflection: vec3f=reflect(view,normal);var temp: f32=saturate(1.0+1.1*dot(reflection,geometricNormal));return temp*temp;}
#endif
#if defined(LODINREFLECTIONALPHA) || defined(SS_LODINREFRACTIONALPHA)
fn UNPACK_LOD(x: f32)->f32 {return (1.0-x)*255.0;}
fn getLodFromAlphaGNdotV(cubeMapDimensionPixels: f32,alphaG: f32,NdotV: f32)->f32 {var microsurfaceAverageSlope: f32=alphaG;microsurfaceAverageSlope*=sqrt(abs(NdotV));return getLodFromAlphaG(cubeMapDimensionPixels,microsurfaceAverageSlope);}
#endif
`;g.IncludesShadersStoreWGSL[RU]||(g.IncludesShadersStoreWGSL[RU]=a$)});var CU,o$,G_=S(()=>{O();CU="bumpFragmentMainFunctions",o$=`#if defined(BUMP) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC) || defined(DETAIL)
#if defined(TANGENT) && defined(NORMAL) 
varying vTBN0: vec3f;varying vTBN1: vec3f;varying vTBN2: vec3f;
#endif
#ifdef OBJECTSPACE_NORMALMAP
uniform normalMatrix: mat4x4f;fn toNormalMatrix(m: mat4x4f)->mat4x4f
{var a00=m[0][0];var a01=m[0][1];var a02=m[0][2];var a03=m[0][3];var a10=m[1][0];var a11=m[1][1];var a12=m[1][2];var a13=m[1][3];var a20=m[2][0]; 
var a21=m[2][1];var a22=m[2][2];var a23=m[2][3];var a30=m[3][0]; 
var a31=m[3][1];var a32=m[3][2];var a33=m[3][3];var b00=a00*a11-a01*a10;var b01=a00*a12-a02*a10;var b02=a00*a13-a03*a10;var b03=a01*a12-a02*a11;var b04=a01*a13-a03*a11;var b05=a02*a13-a03*a12;var b06=a20*a31-a21*a30;var b07=a20*a32-a22*a30;var b08=a20*a33-a23*a30;var b09=a21*a32-a22*a31;var b10=a21*a33-a23*a31;var b11=a22*a33-a23*a32;var det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;var mi=mat4x4<f32>(
(a11*b11-a12*b10+a13*b09)/det,
(a02*b10-a01*b11-a03*b09)/det,
(a31*b05-a32*b04+a33*b03)/det,
(a22*b04-a21*b05-a23*b03)/det,
(a12*b08-a10*b11-a13*b07)/det,
(a00*b11-a02*b08+a03*b07)/det,
(a32*b02-a30*b05-a33*b01)/det,
(a20*b05-a22*b02+a23*b01)/det,
(a10*b10-a11*b08+a13*b06)/det,
(a01*b08-a00*b10-a03*b06)/det,
(a30*b04-a31*b02+a33*b00)/det,
(a21*b02-a20*b04-a23*b00)/det,
(a11*b07-a10*b09-a12*b06)/det,
(a00*b09-a01*b07+a02*b06)/det,
(a31*b01-a30*b03-a32*b00)/det,
(a20*b03-a21*b01+a22*b00)/det);return mat4x4<f32>(mi[0][0],mi[1][0],mi[2][0],mi[3][0],
mi[0][1],mi[1][1],mi[2][1],mi[3][1],
mi[0][2],mi[1][2],mi[2][2],mi[3][2],
mi[0][3],mi[1][3],mi[2][3],mi[3][3]);}
#endif
fn perturbNormalBase(cotangentFrame: mat3x3f,normal: vec3f,scale: f32)->vec3f
{var output=normal;
#ifdef NORMALXYSCALE
output=normalize(output* vec3f(scale,scale,1.0));
#endif
return normalize(cotangentFrame*output);}
fn perturbNormal(cotangentFrame: mat3x3f,textureSample: vec3f,scale: f32)->vec3f
{return perturbNormalBase(cotangentFrame,textureSample*2.0-1.0,scale);}
fn cotangent_frame(normal: vec3f,p: vec3f,uv: vec2f,tangentSpaceParams: vec2f)->mat3x3f
{var dp1: vec3f=dpdx(p);var dp2: vec3f=dpdy(p);var duv1: vec2f=dpdx(uv);var duv2: vec2f=dpdy(uv);var dp2perp: vec3f=cross(dp2,normal);var dp1perp: vec3f=cross(normal,dp1);var tangent: vec3f=dp2perp*duv1.x+dp1perp*duv2.x;var bitangent: vec3f=dp2perp*duv1.y+dp1perp*duv2.y;tangent*=tangentSpaceParams.x;bitangent*=tangentSpaceParams.y;var det: f32=max(dot(tangent,tangent),dot(bitangent,bitangent));var invmax: f32=select(inverseSqrt(det),0.0,det==0.0);return mat3x3f(tangent*invmax,bitangent*invmax,normal);}
#endif
`;g.IncludesShadersStoreWGSL[CU]||(g.IncludesShadersStoreWGSL[CU]=o$)});var IU,l$,V_=S(()=>{O();U_();IU="bumpFragmentFunctions",l$=`#if defined(BUMP)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump)
#endif
#if defined(DETAIL)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_SAMPLERNAME_,detail)
#endif
#if defined(BUMP) && defined(PARALLAX)
const minSamples: f32=4.;const maxSamples: f32=15.;const iMaxSamples: i32=15;fn parallaxOcclusion(vViewDirCoT: vec3f,vNormalCoT: vec3f,texCoord: vec2f,parallaxScale: f32)->vec2f {var parallaxLimit: f32=length(vViewDirCoT.xy)/vViewDirCoT.z;parallaxLimit*=parallaxScale;var vOffsetDir: vec2f=normalize(vViewDirCoT.xy);var vMaxOffset: vec2f=vOffsetDir*parallaxLimit;var numSamples: f32=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));var stepSize: f32=1.0/numSamples;var currRayHeight: f32=1.0;var vCurrOffset: vec2f= vec2f(0,0);var vLastOffset: vec2f= vec2f(0,0);var lastSampledHeight: f32=1.0;var currSampledHeight: f32=1.0;var keepWorking: bool=true;for (var i: i32=0; i<iMaxSamples; i++)
{currSampledHeight=textureSample(bumpSampler,bumpSamplerSampler,texCoord+vCurrOffset).w;if (!keepWorking)
{}
else if (currSampledHeight>currRayHeight)
{var delta1: f32=currSampledHeight-currRayHeight;var delta2: f32=(currRayHeight+stepSize)-lastSampledHeight;var ratio: f32=delta1/(delta1+delta2);vCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;keepWorking=false;}
else
{currRayHeight-=stepSize;vLastOffset=vCurrOffset;
#ifdef PARALLAX_RHS
vCurrOffset-=stepSize*vMaxOffset;
#else
vCurrOffset+=stepSize*vMaxOffset;
#endif
lastSampledHeight=currSampledHeight;}}
return vCurrOffset;}
fn parallaxOffset(viewDir: vec3f,heightScale: f32)->vec2f
{var height: f32=textureSample(bumpSampler,bumpSamplerSampler,fragmentInputs.vBumpUV).w;var texCoordOffset: vec2f=heightScale*viewDir.xy*height;
#ifdef PARALLAX_RHS
return texCoordOffset;
#else
return -texCoordOffset;
#endif
}
#endif
`;g.IncludesShadersStoreWGSL[IU]||(g.IncludesShadersStoreWGSL[IU]=l$)});var yU,c$,k_=S(()=>{O();yU="decalFragment",c$=`#ifdef DECAL
var decalTempColor=decalColor.rgb;var decalTempAlpha=decalColor.a;
#ifdef GAMMADECAL
decalTempColor=toLinearSpaceVec3(decalColor.rgb);
#endif
#ifdef DECAL_SMOOTHALPHA
decalTempAlpha=decalColor.a*decalColor.a;
#endif
surfaceAlbedo=mix(surfaceAlbedo.rgb,decalTempColor,decalTempAlpha);
#endif
`;g.IncludesShadersStoreWGSL[yU]||(g.IncludesShadersStoreWGSL[yU]=c$)});var MU,f$,PU=S(()=>{O();k_();MU="pbrBlockAlbedoOpacity",f$=`struct albedoOpacityOutParams
{surfaceAlbedo: vec3f,
alpha: f32};
#define pbr_inline
fn albedoOpacityBlock(
vAlbedoColor: vec4f
#ifdef ALBEDO
,albedoTexture: vec4f
,albedoInfos: vec2f
#endif
,baseWeight: f32
#ifdef BASE_WEIGHT
,baseWeightTexture: vec4f
,vBaseWeightInfos: vec2f
#endif
#ifdef OPACITY
,opacityMap: vec4f
,vOpacityInfos: vec2f
#endif
#ifdef DETAIL
,detailColor: vec4f
,vDetailInfos: vec4f
#endif
#ifdef DECAL
,decalColor: vec4f
,vDecalInfos: vec4f
#endif
)->albedoOpacityOutParams
{var outParams: albedoOpacityOutParams;var surfaceAlbedo: vec3f=vAlbedoColor.rgb;var alpha: f32=vAlbedoColor.a;
#ifdef ALBEDO
#if defined(ALPHAFROMALBEDO) || defined(ALPHATEST)
alpha*=albedoTexture.a;
#endif
#ifdef GAMMAALBEDO
surfaceAlbedo*=toLinearSpaceVec3(albedoTexture.rgb);
#else
surfaceAlbedo*=albedoTexture.rgb;
#endif
surfaceAlbedo*=albedoInfos.y;
#endif
#ifndef DECAL_AFTER_DETAIL
#include<decalFragment>
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
surfaceAlbedo*=fragmentInputs.vColor.rgb;
#endif
#ifdef DETAIL
var detailAlbedo: f32=2.0*mix(0.5,detailColor.r,vDetailInfos.y);surfaceAlbedo=surfaceAlbedo.rgb*detailAlbedo*detailAlbedo; 
#endif
#ifdef DECAL_AFTER_DETAIL
#include<decalFragment>
#endif
#define CUSTOM_FRAGMENT_UPDATE_ALBEDO
surfaceAlbedo*=baseWeight;
#ifdef BASE_WEIGHT
surfaceAlbedo*=baseWeightTexture.r;
#endif
#ifdef OPACITY
#ifdef OPACITYRGB
alpha=getLuminance(opacityMap.rgb);
#else
alpha*=opacityMap.a;
#endif
alpha*=vOpacityInfos.y;
#endif
#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)
alpha*=fragmentInputs.vColor.a;
#endif
#if !defined(SS_LINKREFRACTIONTOTRANSPARENCY) && !defined(ALPHAFRESNEL)
#ifdef ALPHATEST
#if DEBUGMODE != 88
if (alpha<ALPHATESTVALUE) {discard;}
#endif
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
#endif
outParams.surfaceAlbedo=surfaceAlbedo;outParams.alpha=alpha;return outParams;}
`;g.IncludesShadersStoreWGSL[MU]||(g.IncludesShadersStoreWGSL[MU]=f$)});var DU,h$,OU=S(()=>{O();DU="pbrBlockReflectivity",h$=`struct reflectivityOutParams
{microSurface: f32,
roughness: f32,
diffuseRoughness: f32,
reflectanceF0: f32,
reflectanceF90: vec3f,
colorReflectanceF0: vec3f,
colorReflectanceF90: vec3f,
#ifdef METALLICWORKFLOW
surfaceAlbedo: vec3f,
metallic: f32,
specularWeight: f32,
dielectricColorF0: vec3f,
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
ambientOcclusionColor: vec3f,
#endif
#if DEBUGMODE>0
#ifdef METALLICWORKFLOW
#ifdef REFLECTIVITY
surfaceMetallicColorMap: vec4f,
#endif
metallicF0: vec3f,
#else
#ifdef REFLECTIVITY
surfaceReflectivityColorMap: vec4f,
#endif
#endif
#endif
};
#define pbr_inline
fn reflectivityBlock(
reflectivityColor: vec4f
#ifdef METALLICWORKFLOW
,surfaceAlbedo: vec3f
,metallicReflectanceFactors: vec4f
#endif
,baseDiffuseRoughness: f32
#ifdef BASE_DIFFUSE_ROUGHNESS
,baseDiffuseRoughnessTexture: f32
,baseDiffuseRoughnessInfos: vec2f
#endif
#ifdef REFLECTIVITY
,reflectivityInfos: vec3f
,surfaceMetallicOrReflectivityColorMap: vec4f
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
,ambientOcclusionColorIn: vec3f
#endif
#ifdef MICROSURFACEMAP
,microSurfaceTexel: vec4f
#endif
#ifdef DETAIL
,detailColor: vec4f
,vDetailInfos: vec4f
#endif
)->reflectivityOutParams
{var outParams: reflectivityOutParams;var microSurface: f32=reflectivityColor.a;var surfaceReflectivityColor: vec3f=reflectivityColor.rgb;
#ifdef METALLICWORKFLOW
var metallicRoughness: vec2f=surfaceReflectivityColor.rg;var ior: f32=surfaceReflectivityColor.b;
#ifdef REFLECTIVITY
#if DEBUGMODE>0
outParams.surfaceMetallicColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef AOSTOREINMETALMAPRED
var aoStoreInMetalMap: vec3f= vec3f(surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r);outParams.ambientOcclusionColor=mix(ambientOcclusionColorIn,aoStoreInMetalMap,reflectivityInfos.z);
#endif
#ifdef METALLNESSSTOREINMETALMAPBLUE
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.b;
#else
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.r;
#endif
#ifdef ROUGHNESSSTOREINMETALMAPALPHA
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.a;
#else
#ifdef ROUGHNESSSTOREINMETALMAPGREEN
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.g;
#endif
#endif
#endif
#ifdef DETAIL
var detailRoughness: f32=mix(0.5,detailColor.b,vDetailInfos.w);var loLerp: f32=mix(0.,metallicRoughness.g,detailRoughness*2.);var hiLerp: f32=mix(metallicRoughness.g,1.,(detailRoughness-0.5)*2.);metallicRoughness.g=mix(loLerp,hiLerp,step(detailRoughness,0.5));
#endif
#ifdef MICROSURFACEMAP
metallicRoughness.g*=microSurfaceTexel.r;
#endif
#define CUSTOM_FRAGMENT_UPDATE_METALLICROUGHNESS
microSurface=1.0-metallicRoughness.g;var baseColor: vec3f=surfaceAlbedo;outParams.metallic=metallicRoughness.r;outParams.specularWeight=metallicReflectanceFactors.a;var dielectricF0 : f32=reflectivityColor.a*outParams.specularWeight;surfaceReflectivityColor=metallicReflectanceFactors.rgb;
#if DEBUGMODE>0
outParams.metallicF0=dielectricF0*surfaceReflectivityColor;
#endif
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
outParams.surfaceAlbedo=baseColor.rgb*(vec3f(1.0)-vec3f(dielectricF0)*surfaceReflectivityColor)*(1.0-outParams.metallic);
#else
outParams.surfaceAlbedo=baseColor.rgb;
#endif
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
{let reflectivityColor: vec3f=mix(dielectricF0*surfaceReflectivityColor,baseColor.rgb,outParams.metallic);outParams.reflectanceF0=max(reflectivityColor.r,max(reflectivityColor.g,reflectivityColor.b));}
#else
#if DIELECTRIC_SPECULAR_MODEL==DIELECTRIC_SPECULAR_MODEL_GLTF
let maxF0: f32=max(surfaceReflectivityColor.r,max(surfaceReflectivityColor.g,surfaceReflectivityColor.b));outParams.reflectanceF0=mix(dielectricF0*maxF0,1.0f,outParams.metallic);
#else
outParams.reflectanceF0=mix(dielectricF0,1.0,outParams.metallic);
#endif
#endif
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
outParams.reflectanceF90=vec3(outParams.specularWeight);var f90Scale: f32=1.0;
#else
var f90Scale: f32=clamp(2.0*(ior-1.0),0.0,1.0);outParams.reflectanceF90=vec3(mix(
outParams.specularWeight*f90Scale,1.0,outParams.metallic));
#endif
outParams.dielectricColorF0=vec3f(dielectricF0*surfaceReflectivityColor);var metallicColorF0: vec3f=baseColor.rgb;outParams.colorReflectanceF0=mix(outParams.dielectricColorF0,metallicColorF0,outParams.metallic);
#if (DIELECTRIC_SPECULAR_MODEL==DIELECTRIC_SPECULAR_MODEL_OPENPBR)
let dielectricColorF90
: vec3f=surfaceReflectivityColor *
vec3f(outParams.specularWeight*f90Scale);
#else
let dielectricColorF90
: vec3f=vec3f(outParams.specularWeight*f90Scale);
#endif
#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)
let conductorColorF90: vec3f=surfaceReflectivityColor;
#else
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
let conductorColorF90: vec3f=outParams.reflectanceF90;
#else
let conductorColorF90: vec3f=vec3f(1.0f);
#endif
#endif
outParams.colorReflectanceF90=mix(dielectricColorF90,conductorColorF90,outParams.metallic);
#else
#ifdef REFLECTIVITY
surfaceReflectivityColor*=surfaceMetallicOrReflectivityColorMap.rgb;
#if DEBUGMODE>0
outParams.surfaceReflectivityColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef MICROSURFACEFROMREFLECTIVITYMAP
microSurface*=surfaceMetallicOrReflectivityColorMap.a;microSurface*=reflectivityInfos.z;
#else
#ifdef MICROSURFACEAUTOMATIC
microSurface*=computeDefaultMicroSurface(microSurface,surfaceReflectivityColor);
#endif
#ifdef MICROSURFACEMAP
microSurface*=microSurfaceTexel.r;
#endif
#define CUSTOM_FRAGMENT_UPDATE_MICROSURFACE
#endif
#endif
outParams.colorReflectanceF0=surfaceReflectivityColor;outParams.reflectanceF0=max(surfaceReflectivityColor.r,max(surfaceReflectivityColor.g,surfaceReflectivityColor.b));outParams.reflectanceF90=vec3f(1.0);
#if (DIELECTRIC_SPECULAR_MODEL==DIELECTRIC_SPECULAR_MODEL_OPENPBR)
outParams.colorReflectanceF90=surfaceReflectivityColor;
#else
outParams.colorReflectanceF90=vec3(1.0);
#endif
#endif
microSurface=saturate(microSurface);var roughness: f32=1.-microSurface;var diffuseRoughness: f32=baseDiffuseRoughness;
#ifdef BASE_DIFFUSE_ROUGHNESS
diffuseRoughness*=baseDiffuseRoughnessTexture*baseDiffuseRoughnessInfos.y;
#endif
outParams.microSurface=microSurface;outParams.roughness=roughness;outParams.diffuseRoughness=diffuseRoughness;return outParams;}
`;g.IncludesShadersStoreWGSL[DU]||(g.IncludesShadersStoreWGSL[DU]=h$)});var LU,u$,wU=S(()=>{O();LU="pbrBlockAmbientOcclusion",u$=`struct ambientOcclusionOutParams
{ambientOcclusionColor: vec3f,
#if DEBUGMODE>0 && defined(AMBIENT)
ambientOcclusionColorMap: vec3f
#endif
};
#define pbr_inline
fn ambientOcclusionBlock(
#ifdef AMBIENT
ambientOcclusionColorMap_: vec3f,
vAmbientInfos: vec4f
#endif
)->ambientOcclusionOutParams
{ 
var outParams: ambientOcclusionOutParams;var ambientOcclusionColor: vec3f= vec3f(1.,1.,1.);
#ifdef AMBIENT
var ambientOcclusionColorMap: vec3f=ambientOcclusionColorMap_*vAmbientInfos.y;
#ifdef AMBIENTINGRAYSCALE
ambientOcclusionColorMap= vec3f(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);
#endif
ambientOcclusionColor=mix(ambientOcclusionColor,ambientOcclusionColorMap,vAmbientInfos.z);
#if DEBUGMODE>0
outParams.ambientOcclusionColorMap=ambientOcclusionColorMap;
#endif
#endif
outParams.ambientOcclusionColor=ambientOcclusionColor;return outParams;}
`;g.IncludesShadersStoreWGSL[LU]||(g.IncludesShadersStoreWGSL[LU]=u$)});var FU,d$,NU=S(()=>{O();FU="pbrBlockAlphaFresnel",d$=`#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
struct alphaFresnelOutParams
{alpha: f32};fn faceforward(N: vec3<f32>,I: vec3<f32>,Nref: vec3<f32>)->vec3<f32> {return select(N,-N,dot(Nref,I)>0.0);}
#define pbr_inline
fn alphaFresnelBlock(
normalW: vec3f,
viewDirectionW: vec3f,
alpha: f32,
microSurface: f32
)->alphaFresnelOutParams
{var outParams: alphaFresnelOutParams;var opacityPerceptual: f32=alpha;
#ifdef LINEARALPHAFRESNEL
var opacity0: f32=opacityPerceptual;
#else
var opacity0: f32=opacityPerceptual*opacityPerceptual;
#endif
var opacity90: f32=fresnelGrazingReflectance(opacity0);var normalForward: vec3f=faceforward(normalW,-viewDirectionW,normalW);outParams.alpha=getReflectanceFromAnalyticalBRDFLookup_Jones(saturate(dot(viewDirectionW,normalForward)), vec3f(opacity0), vec3f(opacity90),sqrt(microSurface)).x;
#ifdef ALPHATEST
if (outParams.alpha<ALPHATESTVALUE) {discard;}
#ifndef ALPHABLEND
outParams.alpha=1.0;
#endif
#endif
return outParams;}
#endif
#endif
`;g.IncludesShadersStoreWGSL[FU]||(g.IncludesShadersStoreWGSL[FU]=d$)});var BU,p$,UU=S(()=>{O();BU="pbrBlockAnisotropic",p$=`#ifdef ANISOTROPIC
struct anisotropicOutParams
{anisotropy: f32,
anisotropicTangent: vec3f,
anisotropicBitangent: vec3f,
anisotropicNormal: vec3f,
#if DEBUGMODE>0 && defined(ANISOTROPIC_TEXTURE)
anisotropyMapData: vec3f
#endif
};
#define pbr_inline
fn anisotropicBlock(
vAnisotropy: vec3f,
roughness: f32,
#ifdef ANISOTROPIC_TEXTURE
anisotropyMapData: vec3f,
#endif
TBN: mat3x3f,
normalW: vec3f,
viewDirectionW: vec3f
)->anisotropicOutParams
{ 
var outParams: anisotropicOutParams;var anisotropy: f32=vAnisotropy.b;var anisotropyDirection: vec3f= vec3f(vAnisotropy.xy,0.);
#ifdef ANISOTROPIC_TEXTURE
var amd=anisotropyMapData.rg;anisotropy*=anisotropyMapData.b;
#if DEBUGMODE>0
outParams.anisotropyMapData=anisotropyMapData;
#endif
amd=amd*2.0-1.0;
#ifdef ANISOTROPIC_LEGACY
anisotropyDirection=vec3f(anisotropyDirection.xy*amd,anisotropyDirection.z);
#else
anisotropyDirection=vec3f(mat2x2f(anisotropyDirection.x,anisotropyDirection.y,-anisotropyDirection.y,anisotropyDirection.x)*normalize(amd),anisotropyDirection.z);
#endif
#endif
var anisoTBN: mat3x3f= mat3x3f(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));var anisotropicTangent: vec3f=normalize(anisoTBN*anisotropyDirection);var anisotropicBitangent: vec3f=normalize(cross(anisoTBN[2],anisotropicTangent));outParams.anisotropy=anisotropy;outParams.anisotropicTangent=anisotropicTangent;outParams.anisotropicBitangent=anisotropicBitangent;outParams.anisotropicNormal=getAnisotropicBentNormals(anisotropicTangent,anisotropicBitangent,normalW,viewDirectionW,anisotropy,roughness);return outParams;}
#endif
`;g.IncludesShadersStoreWGSL[BU]||(g.IncludesShadersStoreWGSL[BU]=p$)});var GU,m$,VU=S(()=>{O();GU="pbrBlockReflection",m$=`#ifdef REFLECTION
struct reflectionOutParams
{environmentRadiance: vec4f
,environmentIrradiance: vec3f
#ifdef REFLECTIONMAP_3D
,reflectionCoords: vec3f
#else
,reflectionCoords: vec2f
#endif
#ifdef SS_TRANSLUCENCY
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
,irradianceVector: vec3f
#endif
#endif
#endif
};
#define pbr_inline
#ifdef REFLECTIONMAP_3D
fn createReflectionCoords(
vPositionW: vec3f,
normalW: vec3f,
#ifdef ANISOTROPIC
anisotropicOut: anisotropicOutParams,
#endif
)->vec3f
{var reflectionCoords: vec3f;
#else
fn createReflectionCoords(
vPositionW: vec3f,
normalW: vec3f,
#ifdef ANISOTROPIC
anisotropicOut: anisotropicOutParams,
#endif
)->vec2f
{ 
var reflectionCoords: vec2f;
#endif
#ifdef ANISOTROPIC
var reflectionVector: vec3f=computeReflectionCoords( vec4f(vPositionW,1.0),anisotropicOut.anisotropicNormal);
#else
var reflectionVector: vec3f=computeReflectionCoords( vec4f(vPositionW,1.0),normalW);
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
reflectionCoords=reflectionVector;
#else
reflectionCoords=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
return reflectionCoords;}
#define pbr_inline
fn sampleReflectionTexture(
alphaG: f32
,vReflectionMicrosurfaceInfos: vec3f
,vReflectionInfos: vec2f
,vReflectionColor: vec3f
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,NdotVUnclamped: f32
#endif
#ifdef LINEARSPECULARREFLECTION
,roughness: f32
#endif
#ifdef REFLECTIONMAP_3D
,reflectionSampler: texture_cube<f32>
,reflectionSamplerSampler: sampler
,reflectionCoords: vec3f
#else
,reflectionSampler: texture_2d<f32>
,reflectionSamplerSampler: sampler
,reflectionCoords: vec2f
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,reflectionLowSampler: texture_cube<f32>
,reflectionLowSamplerSampler: sampler
,reflectionHighSampler: texture_cube<f32>
,reflectionHighSamplerSampler: sampler
#else
,reflectionLowSampler: texture_2d<f32>
,reflectionLowSamplerSampler: sampler
,reflectionHighSampler: texture_2d<f32>
,reflectionHighSamplerSampler: sampler
#endif
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo: vec2f
#endif 
)->vec4f
{var environmentRadiance: vec4f;
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
var reflectionLOD: f32=getLodFromAlphaGNdotV(vReflectionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);
#elif defined(LINEARSPECULARREFLECTION)
var reflectionLOD: f32=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);
#else
var reflectionLOD: f32=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);
#endif
#ifdef LODBASEDMICROSFURACE
reflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;
#ifdef LODINREFLECTIONALPHA
var automaticReflectionLOD: f32=UNPACK_LOD(textureSample(reflectionSampler,reflectionSamplerSampler,reflectionCoords).a);var requestedReflectionLOD: f32=max(automaticReflectionLOD,reflectionLOD);
#else
var requestedReflectionLOD: f32=reflectionLOD;
#endif
#ifdef REALTIME_FILTERING
environmentRadiance= vec4f(radiance(alphaG,reflectionSampler,reflectionSamplerSampler,reflectionCoords,vReflectionFilteringInfo),1.0);
#else
environmentRadiance=textureSampleLevel(reflectionSampler,reflectionSamplerSampler,reflectionCoords,reflectionLOD);
#endif
#else
var lodReflectionNormalized: f32=saturate(reflectionLOD/log2(vReflectionMicrosurfaceInfos.x));var lodReflectionNormalizedDoubled: f32=lodReflectionNormalized*2.0;var environmentMid: vec4f=textureSample(reflectionSampler,reflectionSamplerSampler,reflectionCoords);if (lodReflectionNormalizedDoubled<1.0){environmentRadiance=mix(
textureSample(reflectionHighSampler,reflectionHighSamplerSampler,reflectionCoords),
environmentMid,
lodReflectionNormalizedDoubled
);} else {environmentRadiance=mix(
environmentMid,
textureSample(reflectionLowSampler,reflectionLowSamplerSampler,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);}
#endif
var envRadiance=environmentRadiance.rgb;
#ifdef RGBDREFLECTION
envRadiance=fromRGBD(environmentRadiance);
#endif
#ifdef GAMMAREFLECTION
envRadiance=toLinearSpaceVec3(environmentRadiance.rgb);
#endif
envRadiance*=vReflectionInfos.x;envRadiance*=vReflectionColor.rgb;return vec4f(envRadiance,environmentRadiance.a);}
#define pbr_inline
fn reflectionBlock(
vPositionW: vec3f
,normalW: vec3f
,alphaG: f32
,vReflectionMicrosurfaceInfos: vec3f
,vReflectionInfos: vec2f
,vReflectionColor: vec3f
#ifdef ANISOTROPIC
,anisotropicOut: anisotropicOutParams
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,NdotVUnclamped: f32
#endif
#ifdef LINEARSPECULARREFLECTION
,roughness: f32
#endif
#ifdef REFLECTIONMAP_3D
,reflectionSampler: texture_cube<f32>
,reflectionSamplerSampler: sampler
#else
,reflectionSampler: texture_2d<f32>
,reflectionSamplerSampler: sampler
#endif
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
,vEnvironmentIrradiance: vec3f
#endif
#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))
,reflectionMatrix: mat4x4f
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
,irradianceSampler: texture_cube<f32>
,irradianceSamplerSampler: sampler 
#else
,irradianceSampler: texture_2d<f32>
,irradianceSamplerSampler: sampler 
#endif
#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION
,reflectionDominantDirection: vec3f
#endif
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,reflectionLowSampler: texture_cube<f32>
,reflectionLowSamplerSampler: sampler 
,reflectionHighSampler: texture_cube<f32>
,reflectionHighSamplerSampler: sampler 
#else
,reflectionLowSampler: texture_2d<f32>
,reflectionLowSamplerSampler: sampler 
,reflectionHighSampler: texture_2d<f32>
,reflectionHighSamplerSampler: sampler 
#endif
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo: vec2f
#ifdef IBL_CDF_FILTERING
,icdfSampler: texture_2d<f32>
,icdfSamplerSampler: sampler
#endif
#endif
,viewDirectionW: vec3f
,diffuseRoughness: f32
,surfaceAlbedo: vec3f
)->reflectionOutParams
{var outParams: reflectionOutParams;var environmentRadiance: vec4f= vec4f(0.,0.,0.,0.);
#ifdef REFLECTIONMAP_3D
var reflectionCoords: vec3f= vec3f(0.);
#else
var reflectionCoords: vec2f= vec2f(0.);
#endif
reflectionCoords=createReflectionCoords(
vPositionW,
normalW,
#ifdef ANISOTROPIC
anisotropicOut,
#endif 
);environmentRadiance=sampleReflectionTexture(
alphaG
,vReflectionMicrosurfaceInfos
,vReflectionInfos
,vReflectionColor
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,NdotVUnclamped
#endif
#ifdef LINEARSPECULARREFLECTION
,roughness
#endif
#ifdef REFLECTIONMAP_3D
,reflectionSampler
,reflectionSamplerSampler
,reflectionCoords
#else
,reflectionSampler
,reflectionSamplerSampler
,reflectionCoords
#endif
#ifndef LODBASEDMICROSFURACE
,reflectionLowSampler
,reflectionLowSamplerSampler
,reflectionHighSampler
,reflectionHighSamplerSampler
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif 
);var environmentIrradiance: vec3f= vec3f(0.,0.,0.);
#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))
#ifdef ANISOTROPIC
var irradianceVector: vec3f= (reflectionMatrix* vec4f(anisotropicOut.anisotropicNormal,0)).xyz;
#else
var irradianceVector: vec3f= (reflectionMatrix* vec4f(normalW,0)).xyz;
#endif
var irradianceView: vec3f= (reflectionMatrix* vec4f(viewDirectionW,0)).xyz;
#if !defined(USE_IRRADIANCE_DOMINANT_DIRECTION) && !defined(REALTIME_FILTERING)
#if BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LAMBERT && BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LEGACY
var NdotV: f32=max(dot(normalW,viewDirectionW),0.0);irradianceVector=mix(irradianceVector,irradianceView,(0.5*(1.0-NdotV))*diffuseRoughness);
#endif
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
environmentIrradiance=vEnvironmentIrradiance;
#else
#if defined(REALTIME_FILTERING)
environmentIrradiance=irradiance(reflectionSampler,reflectionSamplerSampler,irradianceVector,vReflectionFilteringInfo,diffuseRoughness,surfaceAlbedo,irradianceView
#ifdef IBL_CDF_FILTERING
,icdfSampler
,icdfSamplerSampler
#endif
);
#else
environmentIrradiance=computeEnvironmentIrradiance(irradianceVector);
#endif
#ifdef SS_TRANSLUCENCY
outParams.irradianceVector=irradianceVector;
#endif
#endif
#elif defined(USEIRRADIANCEMAP)
#ifdef REFLECTIONMAP_3D
var environmentIrradiance4: vec4f=textureSample(irradianceSampler,irradianceSamplerSampler,irradianceVector);
#else
var environmentIrradiance4: vec4f=textureSample(irradianceSampler,irradianceSamplerSampler,reflectionCoords);
#endif
#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION
var Ls: vec3f=normalize(reflectionDominantDirection);var NoL: f32=dot(irradianceVector,Ls);var NoV: f32=dot(irradianceVector,irradianceView);var diffuseRoughnessTerm: vec3f=vec3f(1.0);
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
var LoV: f32=dot(Ls,irradianceView);var mag: f32=length(reflectionDominantDirection)*2.0f;var clampedAlbedo: vec3f=clamp(surfaceAlbedo,vec3f(0.1),vec3f(1.0));diffuseRoughnessTerm=diffuseBRDF_EON(clampedAlbedo,diffuseRoughness,NoL,NoV,LoV)*PI;diffuseRoughnessTerm=diffuseRoughnessTerm/clampedAlbedo;diffuseRoughnessTerm=mix(vec3f(1.0),diffuseRoughnessTerm,sqrt(clamp(mag*NoV,0.0,1.0f)));
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
var H: vec3f=(irradianceView+Ls)*0.5f;var VoH: f32=dot(irradianceView,H);diffuseRoughnessTerm=vec3f(diffuseBRDF_Burley(NoL,NoV,VoH,diffuseRoughness)*PI);
#endif
environmentIrradiance=environmentIrradiance4.rgb*diffuseRoughnessTerm;
#else
environmentIrradiance=environmentIrradiance4.rgb;
#endif
#ifdef RGBDREFLECTION
environmentIrradiance=fromRGBD(environmentIrradiance4);
#endif
#ifdef GAMMAREFLECTION
environmentIrradiance=toLinearSpaceVec3(environmentIrradiance.rgb);
#endif
#endif
environmentIrradiance*=vReflectionColor.rgb*vReflectionInfos.x;
#ifdef MIX_IBL_RADIANCE_WITH_IRRADIANCE
outParams.environmentRadiance=vec4f(mix(environmentRadiance.rgb,environmentIrradiance,alphaG),environmentRadiance.a);
#else
outParams.environmentRadiance=environmentRadiance;
#endif
outParams.environmentIrradiance=environmentIrradiance;outParams.reflectionCoords=reflectionCoords;return outParams;}
#endif
`;g.IncludesShadersStoreWGSL[GU]||(g.IncludesShadersStoreWGSL[GU]=m$)});var kU,_$,WU=S(()=>{O();kU="pbrBlockSheen",_$=`#ifdef SHEEN
struct sheenOutParams
{sheenIntensity: f32
,sheenColor: vec3f
,sheenRoughness: f32
#ifdef SHEEN_LINKWITHALBEDO
,surfaceAlbedo: vec3f
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
,sheenAlbedoScaling: f32
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
,finalSheenRadianceScaled: vec3f
#endif
#if DEBUGMODE>0
#ifdef SHEEN_TEXTURE
,sheenMapData: vec4f
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
,sheenEnvironmentReflectance: vec3f
#endif
#endif
};
#define pbr_inline
fn sheenBlock(
vSheenColor: vec4f
#ifdef SHEEN_ROUGHNESS
,vSheenRoughness: f32
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
,sheenMapRoughnessData: vec4f
#endif
#endif
,roughness: f32
#ifdef SHEEN_TEXTURE
,sheenMapData: vec4f
,sheenMapLevel: f32
#endif
,reflectance: f32
#ifdef SHEEN_LINKWITHALBEDO
,baseColor: vec3f
,surfaceAlbedo: vec3f
#endif
#ifdef ENVIRONMENTBRDF
,NdotV: f32
,environmentBrdf: vec3f
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
,AARoughnessFactors: vec2f
,vReflectionMicrosurfaceInfos: vec3f
,vReflectionInfos: vec2f
,vReflectionColor: vec3f
,vLightingIntensity: vec4f
#ifdef REFLECTIONMAP_3D
,reflectionSampler: texture_cube<f32>
,reflectionSamplerSampler: sampler
,reflectionCoords: vec3f
#else
,reflectionSampler: texture_2d<f32>
,reflectionSamplerSampler: sampler
,reflectionCoords: vec2f
#endif
,NdotVUnclamped: f32
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,reflectionLowSampler: texture_cube<f32>
,reflectionLowSamplerSampler: sampler 
,reflectionHighSampler: texture_cube<f32>
,reflectionHighSamplerSampler: sampler 
#else
,reflectionLowSampler: texture_2d<f32>
,reflectionLowSamplerSampler: sampler 
,reflectionHighSampler: texture_2d<f32>
,reflectionHighSamplerSampler: sampler 
#endif
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo: vec2f
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
,seo: f32
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
,eho: f32
#endif
#endif
)->sheenOutParams
{var outParams: sheenOutParams;var sheenIntensity: f32=vSheenColor.a;
#ifdef SHEEN_TEXTURE
#if DEBUGMODE>0
outParams.sheenMapData=sheenMapData;
#endif
#endif
#ifdef SHEEN_LINKWITHALBEDO
var sheenFactor: f32=pow5(1.0-sheenIntensity);var sheenColor: vec3f=baseColor.rgb*(1.0-sheenFactor);var sheenRoughness: f32=sheenIntensity;outParams.surfaceAlbedo=surfaceAlbedo*sheenFactor;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#else
var sheenColor: vec3f=vSheenColor.rgb;
#ifdef SHEEN_TEXTURE
#ifdef SHEEN_GAMMATEXTURE
sheenColor*=toLinearSpaceVec3(sheenMapData.rgb);
#else
sheenColor*=sheenMapData.rgb;
#endif
sheenColor*=sheenMapLevel;
#endif
#ifdef SHEEN_ROUGHNESS
var sheenRoughness: f32=vSheenRoughness;
#ifdef SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE
#if defined(SHEEN_TEXTURE)
sheenRoughness*=sheenMapData.a;
#endif
#elif defined(SHEEN_TEXTURE_ROUGHNESS)
sheenRoughness*=sheenMapRoughnessData.a;
#endif
#else
var sheenRoughness: f32=roughness;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#endif
#if !defined(SHEEN_ALBEDOSCALING)
sheenIntensity*=(1.-reflectance);
#endif
sheenColor*=sheenIntensity;
#endif
#ifdef ENVIRONMENTBRDF
/*#ifdef SHEEN_SOFTER
var environmentSheenBrdf: vec3f= vec3f(0.,0.,getBRDFLookupCharlieSheen(NdotV,sheenRoughness));
#else*/
#ifdef SHEEN_ROUGHNESS
var environmentSheenBrdf: vec3f=getBRDFLookup(NdotV,sheenRoughness);
#else
var environmentSheenBrdf: vec3f=environmentBrdf;
#endif
/*#endif*/
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
var sheenAlphaG: f32=convertRoughnessToAverageSlope(sheenRoughness);
#ifdef SPECULARAA
sheenAlphaG+=AARoughnessFactors.y;
#endif
var environmentSheenRadiance: vec4f= vec4f(0.,0.,0.,0.);environmentSheenRadiance=sampleReflectionTexture(
sheenAlphaG
,vReflectionMicrosurfaceInfos
,vReflectionInfos
,vReflectionColor
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,NdotVUnclamped
#endif
#ifdef LINEARSPECULARREFLECTION
,sheenRoughness
#endif
,reflectionSampler
,reflectionSamplerSampler
,reflectionCoords
#ifndef LODBASEDMICROSFURACE
,reflectionLowSampler
,reflectionLowSamplerSampler
,reflectionHighSampler
,reflectionHighSamplerSampler
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif
);var sheenEnvironmentReflectance: vec3f=getSheenReflectanceFromBRDFLookup(sheenColor,environmentSheenBrdf);
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
sheenEnvironmentReflectance*=seo;
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
sheenEnvironmentReflectance*=eho;
#endif
#if DEBUGMODE>0
outParams.sheenEnvironmentReflectance=sheenEnvironmentReflectance;
#endif
outParams.finalSheenRadianceScaled=
environmentSheenRadiance.rgb *
sheenEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
outParams.sheenAlbedoScaling=1.0-sheenIntensity*max(max(sheenColor.r,sheenColor.g),sheenColor.b)*environmentSheenBrdf.b;
#endif
outParams.sheenIntensity=sheenIntensity;outParams.sheenColor=sheenColor;outParams.sheenRoughness=sheenRoughness;return outParams;}
#endif
`;g.IncludesShadersStoreWGSL[kU]||(g.IncludesShadersStoreWGSL[kU]=_$)});var HU,g$,zU=S(()=>{O();HU="pbrBlockClearcoat",g$=`struct clearcoatOutParams
{specularEnvironmentR0: vec3f,
conservationFactor: f32,
clearCoatNormalW: vec3f,
clearCoatAARoughnessFactors: vec2f,
clearCoatIntensity: f32,
clearCoatRoughness: f32,
#ifdef REFLECTION
finalClearCoatRadianceScaled: vec3f,
#endif
#ifdef CLEARCOAT_TINT
absorption: vec3f,
clearCoatNdotVRefract: f32,
clearCoatColor: vec3f,
clearCoatThickness: f32,
#endif
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
energyConservationFactorClearCoat: vec3f,
#endif
#if DEBUGMODE>0
#ifdef CLEARCOAT_BUMP
TBNClearCoat: mat3x3f,
#endif
#ifdef CLEARCOAT_TEXTURE
clearCoatMapData: vec2f,
#endif
#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
clearCoatTintMapData: vec4f,
#endif
#ifdef REFLECTION
environmentClearCoatRadiance: vec4f,
clearCoatEnvironmentReflectance: vec3f,
#endif
clearCoatNdotV: f32
#endif
};
#ifdef CLEARCOAT
#define pbr_inline
fn clearcoatBlock(
vPositionW: vec3f
,geometricNormalW: vec3f
,viewDirectionW: vec3f
,vClearCoatParams: vec2f
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
,clearCoatMapRoughnessData: vec4f
#endif
,specularEnvironmentR0: vec3f
#ifdef CLEARCOAT_TEXTURE
,clearCoatMapData: vec2f
#endif
#ifdef CLEARCOAT_TINT
,vClearCoatTintParams: vec4f
,clearCoatColorAtDistance: f32
,vClearCoatRefractionParams: vec4f
#ifdef CLEARCOAT_TINT_TEXTURE
,clearCoatTintMapData: vec4f
#endif
#endif
#ifdef CLEARCOAT_BUMP
,vClearCoatBumpInfos: vec2f
,clearCoatBumpMapData: vec4f
,vClearCoatBumpUV: vec2f
#if defined(TANGENT) && defined(NORMAL)
,vTBN: mat3x3f
#else
,vClearCoatTangentSpaceParams: vec2f
#endif
#ifdef OBJECTSPACE_NORMALMAP
,normalMatrix: mat4x4f
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
,faceNormal: vec3f
#endif
#ifdef REFLECTION
,vReflectionMicrosurfaceInfos: vec3f
,vReflectionInfos: vec2f
,vReflectionColor: vec3f
,vLightingIntensity: vec4f
#ifdef REFLECTIONMAP_3D
,reflectionSampler: texture_cube<f32>
,reflectionSamplerSampler: sampler
#else
,reflectionSampler: texture_2d<f32>
,reflectionSamplerSampler: sampler
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,reflectionLowSampler: texture_cube<f32>
,reflectionLowSamplerSampler: sampler 
,reflectionHighSampler: texture_cube<f32>
,reflectionHighSamplerSampler: sampler 
#else
,reflectionLowSampler: texture_2d<f32>
,reflectionLowSamplerSampler: sampler 
,reflectionHighSampler: texture_2d<f32>
,reflectionHighSamplerSampler: sampler 
#endif
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo: vec2f
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
,frontFacingMultiplier: f32
#endif 
)->clearcoatOutParams
{var outParams: clearcoatOutParams;var clearCoatIntensity: f32=vClearCoatParams.x;var clearCoatRoughness: f32=vClearCoatParams.y;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#ifdef CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE
clearCoatRoughness*=clearCoatMapData.y;
#endif
#if DEBUGMODE>0
outParams.clearCoatMapData=clearCoatMapData;
#endif
#endif
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
clearCoatRoughness*=clearCoatMapRoughnessData.y;
#endif
outParams.clearCoatIntensity=clearCoatIntensity;outParams.clearCoatRoughness=clearCoatRoughness;
#ifdef CLEARCOAT_TINT
var clearCoatColor: vec3f=vClearCoatTintParams.rgb;var clearCoatThickness: f32=vClearCoatTintParams.a;
#ifdef CLEARCOAT_TINT_TEXTURE
#ifdef CLEARCOAT_TINT_GAMMATEXTURE
clearCoatColor*=toLinearSpaceVec3(clearCoatTintMapData.rgb);
#else
clearCoatColor*=clearCoatTintMapData.rgb;
#endif
clearCoatThickness*=clearCoatTintMapData.a;
#if DEBUGMODE>0
outParams.clearCoatTintMapData=clearCoatTintMapData;
#endif
#endif
outParams.clearCoatColor=computeColorAtDistanceInMedia(clearCoatColor,clearCoatColorAtDistance);outParams.clearCoatThickness=clearCoatThickness;
#endif
#ifdef CLEARCOAT_REMAP_F0
var specularEnvironmentR0Updated: vec3f=getR0RemappedForClearCoat(specularEnvironmentR0);
#else
var specularEnvironmentR0Updated: vec3f=specularEnvironmentR0;
#endif
outParams.specularEnvironmentR0=mix(specularEnvironmentR0,specularEnvironmentR0Updated,clearCoatIntensity);var clearCoatNormalW: vec3f=geometricNormalW;
#ifdef CLEARCOAT_BUMP
#ifdef NORMALXYSCALE
var clearCoatNormalScale: f32=1.0;
#else
var clearCoatNormalScale: f32=vClearCoatBumpInfos.y;
#endif
#if defined(TANGENT) && defined(NORMAL)
var TBNClearCoat: mat3x3f=vTBN;
#else
var TBNClearCoatUV: vec2f=vClearCoatBumpUV*frontFacingMultiplier;var TBNClearCoat: mat3x3f=cotangent_frame(clearCoatNormalW*clearCoatNormalScale,vPositionW,TBNClearCoatUV,vClearCoatTangentSpaceParams);
#endif
#if DEBUGMODE>0
outParams.TBNClearCoat=TBNClearCoat;
#endif
#ifdef OBJECTSPACE_NORMALMAP
clearCoatNormalW=normalize(clearCoatBumpMapData.xyz *2.0-1.0);clearCoatNormalW=normalize( mat3x3f(normalMatrix[0].xyz,normalMatrix[1].xyz,normalMatrix[2].xyz)*clearCoatNormalW);
#else
clearCoatNormalW=perturbNormal(TBNClearCoat,clearCoatBumpMapData.xyz,vClearCoatBumpInfos.y);
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
clearCoatNormalW*=sign(dot(clearCoatNormalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
clearCoatNormalW=clearCoatNormalW*frontFacingMultiplier;
#endif
outParams.clearCoatNormalW=clearCoatNormalW;outParams.clearCoatAARoughnessFactors=getAARoughnessFactors(clearCoatNormalW.xyz);var clearCoatNdotVUnclamped: f32=dot(clearCoatNormalW,viewDirectionW);var clearCoatNdotV: f32=absEps(clearCoatNdotVUnclamped);
#if DEBUGMODE>0
outParams.clearCoatNdotV=clearCoatNdotV;
#endif
#ifdef CLEARCOAT_TINT
var clearCoatVRefract: vec3f=refract(-viewDirectionW,clearCoatNormalW,vClearCoatRefractionParams.y);outParams.clearCoatNdotVRefract=absEps(dot(clearCoatNormalW,clearCoatVRefract));
#endif
#if defined(ENVIRONMENTBRDF) && (!defined(REFLECTIONMAP_SKYBOX) || defined(MS_BRDF_ENERGY_CONSERVATION))
var environmentClearCoatBrdf: vec3f=getBRDFLookup(clearCoatNdotV,clearCoatRoughness);
#endif
#if defined(REFLECTION)
var clearCoatAlphaG: f32=convertRoughnessToAverageSlope(clearCoatRoughness);
#ifdef SPECULARAA
clearCoatAlphaG+=outParams.clearCoatAARoughnessFactors.y;
#endif
var environmentClearCoatRadiance: vec4f= vec4f(0.,0.,0.,0.);var clearCoatReflectionVector: vec3f=computeReflectionCoords( vec4f(vPositionW,1.0),clearCoatNormalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
clearCoatReflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
var clearCoatReflectionCoords: vec3f=clearCoatReflectionVector;
#else
var clearCoatReflectionCoords: vec2f=clearCoatReflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
clearCoatReflectionCoords/=clearCoatReflectionVector.z;
#endif
clearCoatReflectionCoords.y=1.0-clearCoatReflectionCoords.y;
#endif
environmentClearCoatRadiance=sampleReflectionTexture(
clearCoatAlphaG
,vReflectionMicrosurfaceInfos
,vReflectionInfos
,vReflectionColor
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,clearCoatNdotVUnclamped
#endif
#ifdef LINEARSPECULARREFLECTION
,clearCoatRoughness
#endif
,reflectionSampler
,reflectionSamplerSampler
,clearCoatReflectionCoords
#ifndef LODBASEDMICROSFURACE
,reflectionLowSampler
,reflectionLowSamplerSampler
,reflectionHighSampler
,reflectionHighSamplerSampler
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif 
);
#if DEBUGMODE>0
outParams.environmentClearCoatRadiance=environmentClearCoatRadiance;
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
var clearCoatEnvironmentReflectance: vec3f=getReflectanceFromBRDFLookup(vec3f(uniforms.vClearCoatRefractionParams.x),environmentClearCoatBrdf);
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
var clearCoatEho: f32=environmentHorizonOcclusion(-viewDirectionW,clearCoatNormalW,geometricNormalW);clearCoatEnvironmentReflectance*=clearCoatEho;
#endif
#endif
#endif
#else
var clearCoatEnvironmentReflectance: vec3f=getReflectanceFromAnalyticalBRDFLookup_Jones(clearCoatNdotV, vec3f(1.), vec3f(1.),sqrt(1.-clearCoatRoughness));
#endif
clearCoatEnvironmentReflectance*=clearCoatIntensity;
#if DEBUGMODE>0
outParams.clearCoatEnvironmentReflectance=clearCoatEnvironmentReflectance;
#endif
outParams.finalClearCoatRadianceScaled=
environmentClearCoatRadiance.rgb *
clearCoatEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(CLEARCOAT_TINT)
outParams.absorption=computeClearCoatAbsorption(outParams.clearCoatNdotVRefract,outParams.clearCoatNdotVRefract,outParams.clearCoatColor,clearCoatThickness,clearCoatIntensity);
#endif
var fresnelIBLClearCoat: f32=fresnelSchlickGGX(clearCoatNdotV,uniforms.vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnelIBLClearCoat*=clearCoatIntensity;outParams.conservationFactor=(1.-fresnelIBLClearCoat);
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
outParams.energyConservationFactorClearCoat=getEnergyConservationFactor(outParams.specularEnvironmentR0,environmentClearCoatBrdf);
#endif
return outParams;}
#endif
`;g.IncludesShadersStoreWGSL[HU]||(g.IncludesShadersStoreWGSL[HU]=g$)});var XU,v$,YU=S(()=>{O();XU="pbrBlockIridescence",v$=`struct iridescenceOutParams
{iridescenceIntensity: f32,
iridescenceIOR: f32,
iridescenceThickness: f32,
specularEnvironmentR0: vec3f};
#ifdef IRIDESCENCE
fn iridescenceBlock(
vIridescenceParams: vec4f
,viewAngle_: f32
,specularEnvironmentR0: vec3f
#ifdef IRIDESCENCE_TEXTURE
,iridescenceMapData: vec2f
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
,iridescenceThicknessMapData: vec2f
#endif
#ifdef CLEARCOAT
,NdotVUnclamped: f32
,vClearCoatParams: vec2f
#ifdef CLEARCOAT_TEXTURE
,clearCoatMapData: vec2f
#endif
#endif
)->iridescenceOutParams
{var outParams: iridescenceOutParams;var iridescenceIntensity: f32=vIridescenceParams.x;var iridescenceIOR: f32=vIridescenceParams.y;var iridescenceThicknessMin: f32=vIridescenceParams.z;var iridescenceThicknessMax: f32=vIridescenceParams.w;var iridescenceThicknessWeight: f32=1.;var viewAngle=viewAngle_;
#ifdef IRIDESCENCE_TEXTURE
iridescenceIntensity*=iridescenceMapData.x;
#endif
#if defined(IRIDESCENCE_THICKNESS_TEXTURE)
iridescenceThicknessWeight=iridescenceThicknessMapData.g;
#endif
var iridescenceThickness: f32=mix(iridescenceThicknessMin,iridescenceThicknessMax,iridescenceThicknessWeight);var topIor: f32=1.; 
#ifdef CLEARCOAT
var clearCoatIntensity: f32=vClearCoatParams.x;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#endif
topIor=mix(1.0,uniforms.vClearCoatRefractionParams.w-1.,clearCoatIntensity);viewAngle=sqrt(1.0+((1.0/topIor)*(1.0/topIor))*((NdotVUnclamped*NdotVUnclamped)-1.0));
#endif
var iridescenceFresnel: vec3f=evalIridescence(topIor,iridescenceIOR,viewAngle,iridescenceThickness,specularEnvironmentR0);outParams.specularEnvironmentR0=mix(specularEnvironmentR0,iridescenceFresnel,iridescenceIntensity);outParams.iridescenceIntensity=iridescenceIntensity;outParams.iridescenceThickness=iridescenceThickness;outParams.iridescenceIOR=iridescenceIOR;return outParams;}
#endif
`;g.IncludesShadersStoreWGSL[XU]||(g.IncludesShadersStoreWGSL[XU]=v$)});var KU,S$,qU=S(()=>{O();KU="pbrBlockSubSurface",S$=`struct subSurfaceOutParams
{specularEnvironmentReflectance: vec3f,
#ifdef SS_REFRACTION
finalRefraction: vec3f,
surfaceAlbedo: vec3f,
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
alpha: f32,
#endif
refractionOpacity: f32,
#endif
#ifdef SS_TRANSLUCENCY
transmittance: vec3f,
translucencyIntensity: f32,
#ifdef REFLECTION
refractionIrradiance: vec3f,
#endif
#endif
#if DEBUGMODE>0
#ifdef SS_THICKNESSANDMASK_TEXTURE
thicknessMap: vec4f,
#endif
#ifdef SS_REFRACTION
environmentRefraction: vec4f,
refractionTransmittance: vec3f
#endif
#endif
};
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
#define pbr_inline
fn sampleEnvironmentRefraction(
ior: f32
,thickness: f32
,refractionLOD: f32
,normalW: vec3f
,vPositionW: vec3f
,viewDirectionW: vec3f
,view: mat4x4f
,vRefractionInfos: vec4f
,refractionMatrix: mat4x4f
,vRefractionMicrosurfaceInfos: vec4f
,alphaG: f32
#ifdef SS_REFRACTIONMAP_3D
,refractionSampler: texture_cube<f32>
,refractionSamplerSampler: sampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler: texture_cube<f32>
,refractionLowSamplerSampler: sampler
,refractionHighSampler: texture_cube<f32>
,refractionHighSamplerSampler: sampler 
#endif
#else
,refractionSampler: texture_2d<f32>
,refractionSamplerSampler: sampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler: texture_2d<f32>
,refractionLowSamplerSampler: sampler
,refractionHighSampler: texture_2d<f32>
,refractionHighSamplerSampler: sampler 
#endif
#endif
#ifdef ANISOTROPIC
,anisotropicOut: anisotropicOutParams
#endif
#ifdef REALTIME_FILTERING
,vRefractionFilteringInfo: vec2f
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,refractionPosition: vec3f
,refractionSize: vec3f
#endif
)->vec4f {var environmentRefraction: vec4f= vec4f(0.,0.,0.,0.);
#ifdef ANISOTROPIC
var refractionVector: vec3f=refract(-viewDirectionW,anisotropicOut.anisotropicNormal,ior);
#else
var refractionVector: vec3f=refract(-viewDirectionW,normalW,ior);
#endif
#ifdef SS_REFRACTIONMAP_OPPOSITEZ
refractionVector.z*=-1.0;
#endif
#ifdef SS_REFRACTIONMAP_3D
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
refractionVector=parallaxCorrectNormal(vPositionW,refractionVector,refractionSize,refractionPosition);
#endif
refractionVector.y=refractionVector.y*vRefractionInfos.w;var refractionCoords: vec3f=refractionVector;refractionCoords= (refractionMatrix* vec4f(refractionCoords,0)).xyz;
#else
#ifdef SS_USE_THICKNESS_AS_DEPTH
var vRefractionUVW: vec3f= (refractionMatrix*(view* vec4f(vPositionW+refractionVector*thickness,1.0))).xyz;
#else
var vRefractionUVW: vec3f= (refractionMatrix*(view* vec4f(vPositionW+refractionVector*vRefractionInfos.z,1.0))).xyz;
#endif
var refractionCoords: vec2f=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;
#endif
#ifdef LODBASEDMICROSFURACE
var lod=refractionLOD*vRefractionMicrosurfaceInfos.y+vRefractionMicrosurfaceInfos.z;
#ifdef SS_LODINREFRACTIONALPHA
var automaticRefractionLOD: f32=UNPACK_LOD(textureSample(refractionSampler,refractionSamplerSampler,refractionCoords).a);var requestedRefractionLOD: f32=max(automaticRefractionLOD,lod);
#else
var requestedRefractionLOD: f32=lod;
#endif
#if defined(REALTIME_FILTERING) && defined(SS_REFRACTIONMAP_3D)
environmentRefraction= vec4f(radiance(alphaG,refractionSampler,refractionSamplerSampler,refractionCoords,vRefractionFilteringInfo),1.0);
#else
environmentRefraction=textureSampleLevel(refractionSampler,refractionSamplerSampler,refractionCoords,requestedRefractionLOD);
#endif
#else
var lodRefractionNormalized: f32=saturate(refractionLOD/log2(vRefractionMicrosurfaceInfos.x));var lodRefractionNormalizedDoubled: f32=lodRefractionNormalized*2.0;var environmentRefractionMid: vec4f=textureSample(refractionSampler,refractionSamplerSampler,refractionCoords);if (lodRefractionNormalizedDoubled<1.0){environmentRefraction=mix(
textureSample(refractionHighSampler,refractionHighSamplerSampler,refractionCoords),
environmentRefractionMid,
lodRefractionNormalizedDoubled
);} else {environmentRefraction=mix(
environmentRefractionMid,
textureSample(refractionLowSampler,refractionLowSamplerSampler,refractionCoords),
lodRefractionNormalizedDoubled-1.0
);}
#endif
var refraction=environmentRefraction.rgb;
#ifdef SS_RGBDREFRACTION
refraction=fromRGBD(environmentRefraction);
#endif
#ifdef SS_GAMMAREFRACTION
refraction=toLinearSpaceVec3(environmentRefraction.rgb);
#endif
return vec4f(refraction,environmentRefraction.a);}
#endif
#define pbr_inline
fn subSurfaceBlock(
vSubSurfaceIntensity: vec3f
,vThicknessParam: vec2f
,vTintColor: vec4f
,normalW: vec3f
,specularEnvironmentReflectance: vec3f
#ifdef SS_THICKNESSANDMASK_TEXTURE
,thicknessMap: vec4f
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
,refractionIntensityMap: vec4f
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
,translucencyIntensityMap: vec4f
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
,reflectionMatrix: mat4x4f
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
,irradianceVector_: vec3f
#endif
#if defined(REALTIME_FILTERING)
,reflectionSampler: texture_cube<f32>
,reflectionSamplerSampler: sampler
,vReflectionFilteringInfo: vec2f
#ifdef IBL_CDF_FILTERING
,icdfSampler: texture_2d<f32>
,icdfSamplerSampler: sampler
#endif
#endif
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
,irradianceSampler: texture_cube<f32>
,irradianceSamplerSampler: sampler
#else
,irradianceSampler: texture_2d<f32>
,irradianceSamplerSampler: sampler
#endif
#endif
#endif
#endif
#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
,surfaceAlbedo: vec3f
#endif
#ifdef SS_REFRACTION
,vPositionW: vec3f
,viewDirectionW: vec3f
,view: mat4x4f
,vRefractionInfos: vec4f
,refractionMatrix: mat4x4f
,vRefractionMicrosurfaceInfos: vec4f
,vLightingIntensity: vec4f
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
,alpha: f32
#endif
#ifdef SS_LODINREFRACTIONALPHA
,NdotVUnclamped: f32
#endif
#ifdef SS_LINEARSPECULARREFRACTION
,roughness: f32
#endif
,alphaG: f32
#ifdef SS_REFRACTIONMAP_3D
,refractionSampler: texture_cube<f32>
,refractionSamplerSampler: sampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler: texture_cube<f32>
,refractionLowSamplerSampler: sampler
,refractionHighSampler: texture_cube<f32>
,refractionHighSamplerSampler: sampler 
#endif
#else
,refractionSampler: texture_2d<f32>
,refractionSamplerSampler: sampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler: texture_2d<f32>
,refractionLowSamplerSampler: sampler
,refractionHighSampler: texture_2d<f32>
,refractionHighSamplerSampler: sampler 
#endif
#endif
#ifdef ANISOTROPIC
,anisotropicOut: anisotropicOutParams
#endif
#ifdef REALTIME_FILTERING
,vRefractionFilteringInfo: vec2f
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,refractionPosition: vec3f
,refractionSize: vec3f
#endif
#ifdef SS_DISPERSION
,dispersion: f32
#endif
#endif
#ifdef SS_TRANSLUCENCY
,vDiffusionDistance: vec3f
,vTranslucencyColor: vec4f
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
,translucencyColorMap: vec4f
#endif
#endif
)->subSurfaceOutParams
{var outParams: subSurfaceOutParams;outParams.specularEnvironmentReflectance=specularEnvironmentReflectance;
#ifdef SS_REFRACTION
var refractionIntensity: f32=vSubSurfaceIntensity.x;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
refractionIntensity*=(1.0-alpha);outParams.alpha=1.0;
#endif
#endif
#ifdef SS_TRANSLUCENCY
var translucencyIntensity: f32=vSubSurfaceIntensity.y;
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
#ifdef SS_USE_GLTF_TEXTURES
var thickness: f32=thicknessMap.g*vThicknessParam.y+vThicknessParam.x;
#else
var thickness: f32=thicknessMap.r*vThicknessParam.y+vThicknessParam.x;
#endif
#if DEBUGMODE>0
outParams.thicknessMap=thicknessMap;
#endif
#if defined(SS_REFRACTION) && defined(SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS)
#ifdef SS_USE_GLTF_TEXTURES
refractionIntensity*=thicknessMap.r;
#else
refractionIntensity*=thicknessMap.g;
#endif
#endif
#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS)
#ifdef SS_USE_GLTF_TEXTURES
translucencyIntensity*=thicknessMap.a;
#else
translucencyIntensity*=thicknessMap.b;
#endif
#endif
#else
var thickness: f32=vThicknessParam.y;
#endif
#if defined(SS_REFRACTION) && defined(SS_REFRACTIONINTENSITY_TEXTURE)
#ifdef SS_USE_GLTF_TEXTURES
refractionIntensity*=refractionIntensityMap.r;
#else
refractionIntensity*=refractionIntensityMap.g;
#endif
#endif
#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCYINTENSITY_TEXTURE)
#ifdef SS_USE_GLTF_TEXTURES
translucencyIntensity*=translucencyIntensityMap.a;
#else
translucencyIntensity*=translucencyIntensityMap.b;
#endif
#endif
#ifdef SS_TRANSLUCENCY
thickness=maxEps(thickness);var translucencyColor: vec4f=vTranslucencyColor;
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
translucencyColor*=translucencyColorMap;
#endif
var transmittance: vec3f=transmittanceBRDF_Burley(translucencyColor.rgb,vDiffusionDistance,thickness);transmittance*=translucencyIntensity;outParams.transmittance=transmittance;outParams.translucencyIntensity=translucencyIntensity;
#endif
#ifdef SS_REFRACTION
var environmentRefraction: vec4f= vec4f(0.,0.,0.,0.);
#ifdef SS_HAS_THICKNESS
var ior: f32=vRefractionInfos.y;
#else
var ior: f32=vRefractionMicrosurfaceInfos.w;
#endif
#ifdef SS_LODINREFRACTIONALPHA
var refractionAlphaG: f32=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));var refractionLOD: f32=getLodFromAlphaGNdotV(vRefractionMicrosurfaceInfos.x,refractionAlphaG,NdotVUnclamped);
#elif defined(SS_LINEARSPECULARREFRACTION)
var refractionRoughness: f32=alphaG;refractionRoughness=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));var refractionLOD: f32=getLinearLodFromRoughness(vRefractionMicrosurfaceInfos.x,refractionRoughness);
#else
var refractionAlphaG: f32=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));var refractionLOD: f32=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG);
#endif
var refraction_ior: f32=vRefractionInfos.y;
#ifdef SS_DISPERSION
var realIOR: f32=1.0/refraction_ior;var iorDispersionSpread: f32=0.04*dispersion*(realIOR-1.0);var iors: vec3f= vec3f(1.0/(realIOR-iorDispersionSpread),refraction_ior,1.0/(realIOR+iorDispersionSpread));for (var i: i32=0; i<3; i++) {refraction_ior=iors[i];
#endif
var envSample: vec4f=sampleEnvironmentRefraction(refraction_ior,thickness,refractionLOD,normalW,vPositionW,viewDirectionW,view,vRefractionInfos,refractionMatrix,vRefractionMicrosurfaceInfos,alphaG
#ifdef SS_REFRACTIONMAP_3D
,refractionSampler
,refractionSamplerSampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler
,refractionLowSamplerSampler
,refractionHighSampler
,refractionHighSamplerSampler
#endif
#else
,refractionSampler
,refractionSamplerSampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler
,refractionLowSamplerSampler
,refractionHighSampler
,refractionHighSamplerSampler
#endif
#endif
#ifdef ANISOTROPIC
,anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,refractionPosition
,refractionSize
#endif
);
#ifdef SS_DISPERSION
environmentRefraction[i]=envSample[i];}
#else
environmentRefraction=envSample;
#endif
environmentRefraction=vec4f(environmentRefraction.rgb*vRefractionInfos.x,environmentRefraction.a);
#endif
#ifdef SS_REFRACTION
var refractionTransmittance: vec3f= vec3f(refractionIntensity);
#ifdef SS_THICKNESSANDMASK_TEXTURE
var volumeAlbedo: vec3f=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambertVec3(volumeAlbedo,thickness);
#elif defined(SS_LINKREFRACTIONTOTRANSPARENCY)
var maxChannel: f32=max(max(surfaceAlbedo.r,surfaceAlbedo.g),surfaceAlbedo.b);var volumeAlbedo: vec3f=saturateVec3(maxChannel*surfaceAlbedo);environmentRefraction=vec4f(environmentRefraction.rgb*volumeAlbedo,environmentRefraction.a);
#else
var volumeAlbedo: vec3f=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambertVec3(volumeAlbedo,vThicknessParam.y);
#endif
#ifdef SS_ALBEDOFORREFRACTIONTINT
environmentRefraction=vec4f(environmentRefraction.rgb*surfaceAlbedo.rgb,environmentRefraction.a);
#endif
outParams.surfaceAlbedo=surfaceAlbedo;outParams.refractionOpacity=1.-refractionIntensity;
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
outParams.surfaceAlbedo*=outParams.refractionOpacity;
#endif
#ifdef UNUSED_MULTIPLEBOUNCES
var bounceSpecularEnvironmentReflectance: vec3f=(2.0*specularEnvironmentReflectance)/(1.0+specularEnvironmentReflectance);outParams.specularEnvironmentReflectance=mix(bounceSpecularEnvironmentReflectance,specularEnvironmentReflectance,refractionIntensity);
#endif
#if DEBUGMODE>0
outParams.refractionTransmittance=refractionTransmittance;
#endif
outParams.finalRefraction=environmentRefraction.rgb*refractionTransmittance*vLightingIntensity.z;outParams.finalRefraction*=vec3f(1.0)-specularEnvironmentReflectance;
#if DEBUGMODE>0
outParams.environmentRefraction=environmentRefraction;
#endif
#endif
#if defined(REFLECTION) && defined(SS_TRANSLUCENCY)
#if defined(NORMAL) && defined(USESPHERICALINVERTEX) || !defined(USESPHERICALFROMREFLECTIONMAP)
var irradianceVector: vec3f= (reflectionMatrix* vec4f(normalW,0)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#else
var irradianceVector: vec3f=irradianceVector_;
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP)
#if defined(REALTIME_FILTERING)
var refractionIrradiance: vec3f=irradiance(reflectionSampler,reflectionSamplerSampler,-irradianceVector,vReflectionFilteringInfo,0.0,surfaceAlbedo,irradianceVector
#ifdef IBL_CDF_FILTERING
,icdfSampler
,icdfSamplerSampler
#endif
);
#else
var refractionIrradiance: vec3f=computeEnvironmentIrradiance(-irradianceVector);
#endif
#elif defined(USEIRRADIANCEMAP)
#ifdef REFLECTIONMAP_3D
var irradianceCoords: vec3f=irradianceVector;
#else
var irradianceCoords: vec2f=irradianceVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
irradianceCoords/=irradianceVector.z;
#endif
irradianceCoords.y=1.0-irradianceCoords.y;
#endif
var temp: vec4f=textureSample(irradianceSampler,irradianceSamplerSampler,-irradianceCoords);var refractionIrradiance=temp.rgb;
#ifdef RGBDREFLECTION
refractionIrradiance=fromRGBD(temp).rgb;
#endif
#ifdef GAMMAREFLECTION
refractionIrradiance=toLinearSpaceVec3(refractionIrradiance);
#endif
#else
var refractionIrradiance: vec3f= vec3f(0.);
#endif
refractionIrradiance*=transmittance;
#ifdef SS_ALBEDOFORTRANSLUCENCYTINT
refractionIrradiance*=surfaceAlbedo.rgb;
#endif
outParams.refractionIrradiance=refractionIrradiance;
#endif
return outParams;}
#endif
`;g.IncludesShadersStoreWGSL[KU]||(g.IncludesShadersStoreWGSL[KU]=S$)});var QU,E$,jU=S(()=>{O();QU="pbrBlockNormalGeometric",E$=`var viewDirectionW: vec3f=normalize(scene.vEyePosition.xyz-input.vPositionW);
#ifdef NORMAL
var normalW: vec3f=normalize(input.vNormalW);
#else
var normalW: vec3f=normalize(cross(dpdx(input.vPositionW),dpdy(input.vPositionW)))*scene.vEyePosition.w;
#endif
var geometricNormalW: vec3f=normalW;
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
geometricNormalW=select(-geometricNormalW,geometricNormalW,fragmentInputs.frontFacing);
#endif
`;g.IncludesShadersStoreWGSL[QU]||(g.IncludesShadersStoreWGSL[QU]=E$)});var ZU,T$,W_=S(()=>{O();ZU="bumpFragment",T$=`var uvOffset: vec2f= vec2f(0.0,0.0);
#if defined(BUMP) || defined(PARALLAX) || defined(DETAIL)
#ifdef NORMALXYSCALE
var normalScale: f32=1.0;
#elif defined(BUMP)
var normalScale: f32=uniforms.vBumpInfos.y;
#else
var normalScale: f32=1.0;
#endif
#if defined(TANGENT) && defined(NORMAL)
var TBN: mat3x3f=mat3x3<f32>(input.vTBN0,input.vTBN1,input.vTBN2); 
#elif defined(BUMP)
var TBNUV: vec2f=select(-fragmentInputs.vBumpUV,fragmentInputs.vBumpUV,fragmentInputs.frontFacing);var TBN: mat3x3f=cotangent_frame(normalW*normalScale,input.vPositionW,TBNUV,uniforms.vTangentSpaceParams);
#else
var TBNUV: vec2f=select(-fragmentInputs.vDetailUV,fragmentInputs.vDetailUV,fragmentInputs.frontFacing);var TBN: mat3x3f=cotangent_frame(normalW*normalScale,input.vPositionW,TBNUV, vec2f(1.,1.));
#endif
#elif defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
var TBN: mat3x3f=mat3x3<f32>(input.vTBN0,input.vTBN1,input.vTBN2); 
#else
var TBNUV: vec2f=select( -fragmentInputs.vMainUV1,fragmentInputs.vMainUV1,fragmentInputs.frontFacing);var TBN: mat3x3f=cotangent_frame(normalW,input.vPositionW,TBNUV, vec2f(1.,1.));
#endif
#endif
#ifdef PARALLAX
var invTBN: mat3x3f=transposeMat3(TBN);
#ifdef PARALLAXOCCLUSION
uvOffset=parallaxOcclusion(invTBN*-viewDirectionW,invTBN*normalW,fragmentInputs.vBumpUV,uniforms.vBumpInfos.z);
#else
uvOffset=parallaxOffset(invTBN*viewDirectionW,uniforms.vBumpInfos.z);
#endif
#endif
#ifdef DETAIL
var detailColor: vec4f=textureSample(detailSampler,detailSamplerSampler,fragmentInputs.vDetailUV+uvOffset);var detailNormalRG: vec2f=detailColor.wy*2.0-1.0;var detailNormalB: f32=sqrt(1.-saturate(dot(detailNormalRG,detailNormalRG)));var detailNormal: vec3f= vec3f(detailNormalRG,detailNormalB);
#endif
#ifdef BUMP
#ifdef OBJECTSPACE_NORMALMAP
#define CUSTOM_FRAGMENT_BUMP_FRAGMENT
normalW=normalize(textureSample(bumpSampler,bumpSamplerSampler,fragmentInputs.vBumpUV).xyz *2.0-1.0);normalW=normalize(mat3x3f(uniforms.normalMatrix[0].xyz,uniforms.normalMatrix[1].xyz,uniforms.normalMatrix[2].xyz)*normalW);
#elif !defined(DETAIL)
normalW=perturbNormal(TBN,textureSample(bumpSampler,bumpSamplerSampler,fragmentInputs.vBumpUV+uvOffset).xyz,uniforms.vBumpInfos.y);
#else
var bumpNormal: vec3f=textureSample(bumpSampler,bumpSamplerSampler,fragmentInputs.vBumpUV+uvOffset).xyz*2.0-1.0;
#if DETAIL_NORMALBLENDMETHOD==0 
detailNormal=vec3f(detailNormal.xy*uniforms.vDetailInfos.z,detailNormal.z);var blendedNormal: vec3f=normalize( vec3f(bumpNormal.xy+detailNormal.xy,bumpNormal.z*detailNormal.z));
#elif DETAIL_NORMALBLENDMETHOD==1 
detailNormal=vec3f(detailNormal.xy*uniforms.vDetailInfos.z,detailNormal.z);bumpNormal+= vec3f(0.0,0.0,1.0);detailNormal*= vec3f(-1.0,-1.0,1.0);var blendedNormal: vec3f=bumpNormal*dot(bumpNormal,detailNormal)/bumpNormal.z-detailNormal;
#endif
normalW=perturbNormalBase(TBN,blendedNormal,uniforms.vBumpInfos.y);
#endif
#elif defined(DETAIL)
detailNormal=vec3f(detailNormal.xy*uniforms.vDetailInfos.z,detailNormal.z);normalW=perturbNormalBase(TBN,detailNormal,uniforms.vDetailInfos.z);
#endif
`;g.IncludesShadersStoreWGSL[ZU]||(g.IncludesShadersStoreWGSL[ZU]=T$)});var JU,x$,$U=S(()=>{O();JU="pbrBlockNormalFinal",x$=`#if defined(FORCENORMALFORWARD) && defined(NORMAL)
var faceNormal: vec3f=normalize(cross(dpdx(fragmentInputs.vPositionW),dpdy(fragmentInputs.vPositionW)))*scene.vEyePosition.w;
#if defined(TWOSIDEDLIGHTING)
faceNormal=select(-faceNormal,faceNormal,fragmentInputs.frontFacing);
#endif
normalW*=sign(dot(normalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
#if defined(MIRRORED)
normalW=select(normalW,-normalW,fragmentInputs.frontFacing);
#else
normalW=select(-normalW,normalW,fragmentInputs.frontFacing);
#endif
#endif
`;g.IncludesShadersStoreWGSL[JU]||(g.IncludesShadersStoreWGSL[JU]=x$)});var e3,A$,dI=S(()=>{O();e3="depthPrePass",A$=`#ifdef DEPTHPREPASS
fragmentOutputs.color= vec4f(0.,0.,0.,1.0);return fragmentOutputs;
#endif
`;g.IncludesShadersStoreWGSL[e3]||(g.IncludesShadersStoreWGSL[e3]=A$)});var t3,R$,i3=S(()=>{O();t3="pbrBlockLightmapInit",R$=`#ifdef LIGHTMAP
var lightmapColor: vec4f=textureSample(lightmapSampler,lightmapSamplerSampler,fragmentInputs.vLightmapUV+uvOffset);
#ifdef RGBDLIGHTMAP
lightmapColor=vec4f(fromRGBD(lightmapColor),lightmapColor.a);
#endif
#ifdef GAMMALIGHTMAP
lightmapColor=vec4f(toLinearSpaceVec3(lightmapColor.rgb),lightmapColor.a);
#endif
lightmapColor=vec4f(lightmapColor.rgb*uniforms.vLightmapInfos.y,lightmapColor.a);
#endif
`;g.IncludesShadersStoreWGSL[t3]||(g.IncludesShadersStoreWGSL[t3]=R$)});var r3,b$,s3=S(()=>{O();r3="pbrBlockGeometryInfo",b$=`var NdotVUnclamped: f32=dot(normalW,viewDirectionW);var NdotV: f32=absEps(NdotVUnclamped);var alphaG: f32=convertRoughnessToAverageSlope(roughness);var AARoughnessFactors: vec2f=getAARoughnessFactors(normalW.xyz);
#ifdef SPECULARAA
alphaG+=AARoughnessFactors.y;
#endif
#if defined(ENVIRONMENTBRDF)
var environmentBrdf: vec3f=getBRDFLookup(NdotV,roughness);
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
#ifdef AMBIENTINGRAYSCALE
var ambientMonochrome: f32=aoOut.ambientOcclusionColor.r;
#else
var ambientMonochrome: f32=getLuminance(aoOut.ambientOcclusionColor);
#endif
var seo: f32=environmentRadianceOcclusion(ambientMonochrome,NdotVUnclamped);
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
var eho: f32=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);
#endif
#endif
#endif
#endif
`;g.IncludesShadersStoreWGSL[r3]||(g.IncludesShadersStoreWGSL[r3]=b$)});var n3,C$,a3=S(()=>{O();n3="pbrBlockReflectance",C$=`#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
var baseSpecularEnvironmentReflectance: vec3f=getReflectanceFromBRDFWithEnvLookup(vec3f(reflectanceF0),vec3f(reflectivityOut.reflectanceF90),environmentBrdf);
#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)
let metalEnvironmentReflectance: vec3f=vec3f(reflectivityOut.specularWeight)*getF82Specular(NdotV,clearcoatOut.specularEnvironmentR0,reflectivityOut.colorReflectanceF90,reflectivityOut.roughness);let dielectricEnvironmentReflectance=getReflectanceFromBRDFWithEnvLookup(reflectivityOut.dielectricColorF0,reflectivityOut.colorReflectanceF90,environmentBrdf);var colorSpecularEnvironmentReflectance: vec3f=mix(dielectricEnvironmentReflectance,metalEnvironmentReflectance,reflectivityOut.metallic);
#else
var colorSpecularEnvironmentReflectance=getReflectanceFromBRDFWithEnvLookup(clearcoatOut.specularEnvironmentR0,reflectivityOut.colorReflectanceF90,environmentBrdf);
#endif
#ifdef RADIANCEOCCLUSION
colorSpecularEnvironmentReflectance*=seo;
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
colorSpecularEnvironmentReflectance*=eho;
#endif
#endif
#endif
#else
var colorSpecularEnvironmentReflectance: vec3f=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,sqrt(microSurface));var baseSpecularEnvironmentReflectance: vec3f=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,vec3f(reflectanceF0),vec3f(reflectivityOut.reflectanceF90),sqrt(microSurface));
#endif
#ifdef CLEARCOAT
colorSpecularEnvironmentReflectance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
colorSpecularEnvironmentReflectance*=clearcoatOut.absorption;
#endif
#endif
`;g.IncludesShadersStoreWGSL[n3]||(g.IncludesShadersStoreWGSL[n3]=C$)});var o3,I$,l3=S(()=>{O();o3="pbrBlockDirectLighting",I$=`var diffuseBase: vec3f=vec3f(0.,0.,0.);
#ifdef SS_TRANSLUCENCY
var diffuseTransmissionBase: vec3f=vec3f(0.,0.,0.);
#endif
#ifdef SPECULARTERM
var specularBase: vec3f=vec3f(0.,0.,0.);
#endif
#ifdef CLEARCOAT
var clearCoatBase: vec3f=vec3f(0.,0.,0.);
#endif
#ifdef SHEEN
var sheenBase: vec3f=vec3f(0.,0.,0.);
#endif
#if defined(SPECULARTERM) && defined(LIGHT0)
var coloredFresnel: vec3f=vec3f(0.,0.,0.);
#endif
var preInfo: preLightingInfo;var info: lightingInfo;var shadow: f32=1.; 
var aggShadow: f32=0.;var numLights: f32=0.;
#if defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
var absorption: vec3f=vec3f(0.);
#endif
`;g.IncludesShadersStoreWGSL[o3]||(g.IncludesShadersStoreWGSL[o3]=I$)});var c3,y$,f3=S(()=>{O();c3="pbrBlockFinalLitComponents",y$=`aggShadow=aggShadow/numLights;
#if defined(ENVIRONMENTBRDF)
#ifdef MS_BRDF_ENERGY_CONSERVATION
var baseSpecularEnergyConservationFactor: vec3f=getEnergyConservationFactor(vec3f(reflectanceF0),environmentBrdf);var coloredEnergyConservationFactor: vec3f=getEnergyConservationFactor(clearcoatOut.specularEnvironmentR0,environmentBrdf);
#endif
#endif
#if defined(SHEEN) && defined(SHEEN_ALBEDOSCALING) && defined(ENVIRONMENTBRDF)
surfaceAlbedo=sheenOut.sheenAlbedoScaling*surfaceAlbedo.rgb;
#endif
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
#ifndef METALLICWORKFLOW
#ifdef SPECULAR_GLOSSINESS_ENERGY_CONSERVATION
surfaceAlbedo=vec3f(1.-reflectanceF0)*surfaceAlbedo.rgb;
#endif
#endif
#endif
#ifdef REFLECTION
var finalIrradiance: vec3f=reflectionOut.environmentIrradiance;
#ifndef LEGACY_SPECULAR_ENERGY_CONSERVATION
#if defined(METALLICWORKFLOW) || defined(SPECULAR_GLOSSINESS_ENERGY_CONSERVATION)
var baseSpecularEnergy: vec3f=vec3f(baseSpecularEnvironmentReflectance);
#if defined(ENVIRONMENTBRDF)
#ifdef MS_BRDF_ENERGY_CONSERVATION
baseSpecularEnergy*=baseSpecularEnergyConservationFactor;
#endif
#endif
finalIrradiance*=clamp(vec3f(1.0)-baseSpecularEnergy,vec3f(0.0),vec3f(1.0));
#endif
#endif
#if defined(CLEARCOAT)
finalIrradiance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
finalIrradiance*=clearcoatOut.absorption;
#endif
#endif
#ifndef SS_APPLY_ALBEDO_AFTER_SUBSURFACE
finalIrradiance*=surfaceAlbedo.rgb;
#endif
#if defined(SS_REFRACTION)
finalIrradiance*=subSurfaceOut.refractionOpacity;
#endif
#if defined(SS_TRANSLUCENCY)
finalIrradiance*=(1.0-subSurfaceOut.translucencyIntensity);finalIrradiance+=subSurfaceOut.refractionIrradiance;
#endif
#ifdef SS_APPLY_ALBEDO_AFTER_SUBSURFACE
finalIrradiance*=surfaceAlbedo.rgb;
#endif
finalIrradiance*=uniforms.vLightingIntensity.z;finalIrradiance*=aoOut.ambientOcclusionColor;
#endif
#ifdef SPECULARTERM
var finalSpecular: vec3f=specularBase;finalSpecular=max(finalSpecular,vec3f(0.0));var finalSpecularScaled: vec3f=finalSpecular*uniforms.vLightingIntensity.x*uniforms.vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalSpecularScaled*=coloredEnergyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalSpecularScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif
#ifdef REFLECTION
var finalRadiance: vec3f=reflectionOut.environmentRadiance.rgb;finalRadiance*=colorSpecularEnvironmentReflectance;;var finalRadianceScaled: vec3f=finalRadiance*uniforms.vLightingIntensity.z;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalRadianceScaled*=coloredEnergyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalRadianceScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif
#ifdef SHEEN
var finalSheen: vec3f=sheenBase*sheenOut.sheenColor;finalSheen=max(finalSheen,vec3f(0.0));var finalSheenScaled: vec3f=finalSheen*uniforms.vLightingIntensity.x*uniforms.vLightingIntensity.w;
#if defined(CLEARCOAT) && defined(REFLECTION) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.absorption;
#endif
#endif
#endif
#ifdef CLEARCOAT
var finalClearCoat: vec3f=clearCoatBase;finalClearCoat=max(finalClearCoat,vec3f(0.0));var finalClearCoatScaled: vec3f=finalClearCoat*uniforms.vLightingIntensity.x*uniforms.vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalClearCoatScaled*=clearcoatOut.energyConservationFactorClearCoat;
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction*=clearcoatOut.conservationFactor;
#ifdef CLEARCOAT_TINT
subSurfaceOut.finalRefraction*=clearcoatOut.absorption;
#endif
#endif
#endif
#ifdef ALPHABLEND
var luminanceOverAlpha: f32=0.0;
#if defined(REFLECTION) && defined(RADIANCEOVERALPHA)
luminanceOverAlpha+=getLuminance(finalRadianceScaled);
#if defined(CLEARCOAT)
luminanceOverAlpha+=getLuminance(clearcoatOut.finalClearCoatRadianceScaled);
#endif
#endif
#if defined(SPECULARTERM) && defined(SPECULAROVERALPHA)
luminanceOverAlpha+=getLuminance(finalSpecularScaled);
#endif
#if defined(CLEARCOAT) && defined(CLEARCOATOVERALPHA)
luminanceOverAlpha+=getLuminance(finalClearCoatScaled);
#endif
#if defined(RADIANCEOVERALPHA) || defined(SPECULAROVERALPHA) || defined(CLEARCOATOVERALPHA)
alpha=saturate(alpha+luminanceOverAlpha*luminanceOverAlpha);
#endif
#endif
`;g.IncludesShadersStoreWGSL[c3]||(g.IncludesShadersStoreWGSL[c3]=y$)});var h3,M$,u3=S(()=>{O();h3="pbrBlockFinalUnlitComponents",M$=`var finalDiffuse: vec3f=diffuseBase;finalDiffuse*=surfaceAlbedo;
#if defined(SS_REFRACTION) && !defined(UNLIT) && !defined(LEGACY_SPECULAR_ENERGY_CONSERVATION)
finalDiffuse*=subSurfaceOut.refractionOpacity;
#endif
#if defined(SS_TRANSLUCENCY) && !defined(UNLIT)
finalDiffuse+=diffuseTransmissionBase;
#endif
finalDiffuse=max(finalDiffuse,vec3f(0.0));finalDiffuse*=uniforms.vLightingIntensity.x;var finalAmbient: vec3f=uniforms.vAmbientColor;finalAmbient*=surfaceAlbedo.rgb;var finalEmissive: vec3f=uniforms.vEmissiveColor;
#ifdef EMISSIVE
var emissiveColorTex: vec3f=textureSample(emissiveSampler,emissiveSamplerSampler,fragmentInputs.vEmissiveUV+uvOffset).rgb;
#ifdef GAMMAEMISSIVE
finalEmissive*=toLinearSpaceVec3(emissiveColorTex.rgb);
#else
finalEmissive*=emissiveColorTex.rgb;
#endif
finalEmissive*= uniforms.vEmissiveInfos.y;
#endif
finalEmissive*=uniforms.vLightingIntensity.y;
#ifdef AMBIENT
var ambientOcclusionForDirectDiffuse: vec3f=mix( vec3f(1.),aoOut.ambientOcclusionColor,uniforms.vAmbientInfos.w);
#else
var ambientOcclusionForDirectDiffuse: vec3f=aoOut.ambientOcclusionColor;
#endif
finalAmbient*=aoOut.ambientOcclusionColor;finalDiffuse*=ambientOcclusionForDirectDiffuse;
`;g.IncludesShadersStoreWGSL[h3]||(g.IncludesShadersStoreWGSL[h3]=M$)});var d3,P$,p3=S(()=>{O();d3="pbrBlockFinalColorComposition",P$=`var finalColor: vec4f= vec4f(
#ifndef UNLIT
#ifdef REFLECTION
finalIrradiance +
#endif
#ifdef SPECULARTERM
finalSpecularScaled +
#endif
#ifdef SHEEN
finalSheenScaled +
#endif
#ifdef CLEARCOAT
finalClearCoatScaled +
#endif
#ifdef REFLECTION
finalRadianceScaled +
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled +
#endif
#ifdef CLEARCOAT
clearcoatOut.finalClearCoatRadianceScaled +
#endif
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction +
#endif
#endif
finalAmbient +
finalDiffuse,
alpha);
#ifdef LIGHTMAP
#ifndef LIGHTMAPEXCLUDED
#ifdef USELIGHTMAPASSHADOWMAP
finalColor=vec4f(finalColor.rgb*lightmapColor.rgb,finalColor.a);
#else
finalColor=vec4f(finalColor.rgb+lightmapColor.rgb,finalColor.a);
#endif
#endif
#endif
finalColor=vec4f(finalColor.rgb+finalEmissive,finalColor.a);
#define CUSTOM_FRAGMENT_BEFORE_FOG
finalColor=max(finalColor,vec4f(0.0));
`;g.IncludesShadersStoreWGSL[d3]||(g.IncludesShadersStoreWGSL[d3]=P$)});var m3,D$,_3=S(()=>{O();m3="pbrBlockImageProcessing",D$=`#if defined(IMAGEPROCESSINGPOSTPROCESS) || defined(SS_SCATTERING)
#if !defined(SKIPFINALCOLORCLAMP)
finalColor=vec4f(clamp(finalColor.rgb,vec3f(0.),vec3f(30.0)),finalColor.a);
#endif
#else
finalColor=applyImageProcessing(finalColor);
#endif
finalColor=vec4f(finalColor.rgb,finalColor.a*mesh.visibility);
#ifdef PREMULTIPLYALPHA
finalColor=vec4f(finalColor.rgb*finalColor.a,finalColor.a);;
#endif
`;g.IncludesShadersStoreWGSL[m3]||(g.IncludesShadersStoreWGSL[m3]=D$)});var g3,O$,v3=S(()=>{O();g3="pbrBlockPrePass",O$=`#if SCENE_MRT_COUNT>0
var writeGeometryInfo: f32=select(0.0,1.0,finalColor.a>ALPHATESTVALUE);var fragData: array<vec4<f32>,SCENE_MRT_COUNT>;
#ifdef PREPASS_POSITION
fragData[PREPASS_POSITION_INDEX]= vec4f(fragmentInputs.vPositionW,writeGeometryInfo);
#endif
#ifdef PREPASS_LOCAL_POSITION
fragData[PREPASS_LOCAL_POSITION_INDEX]=vec4f(fragmentInputs.vPosition,writeGeometryInfo);
#endif
#ifdef PREPASS_VELOCITY
var a: vec2f=(fragmentInputs.vCurrentPosition.xy/fragmentInputs.vCurrentPosition.w)*0.5+0.5;var b: vec2f=(fragmentInputs.vPreviousPosition.xy/fragmentInputs.vPreviousPosition.w)*0.5+0.5;var velocity: vec2f=abs(a-b);velocity= vec2f(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;fragData[PREPASS_VELOCITY_INDEX]= vec4f(velocity,0.0,writeGeometryInfo);
#elif defined(PREPASS_VELOCITY_LINEAR)
var velocity : vec2f=vec2f(0.5)*((fragmentInputs.vPreviousPosition.xy/fragmentInputs.vPreviousPosition.w) -
(fragmentInputs.vCurrentPosition.xy/fragmentInputs.vCurrentPosition.w));fragData[PREPASS_VELOCITY_LINEAR_INDEX]=vec4f(velocity,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO
fragData[PREPASS_ALBEDO_INDEX]=vec4f(surfaceAlbedo,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO_SQRT
var sqAlbedo : vec3f=sqrt(surfaceAlbedo); 
#endif
#ifdef PREPASS_IRRADIANCE
var irradiance : vec3f=finalDiffuse;
#ifndef UNLIT
#ifdef REFLECTION
irradiance+=finalIrradiance;
#endif
#endif
#ifdef SS_SCATTERING
#ifdef PREPASS_COLOR
fragData[PREPASS_COLOR_INDEX]=vec4f(finalColor.rgb-irradiance,finalColor.a); 
#endif
irradiance/=sqAlbedo;fragData[PREPASS_IRRADIANCE_INDEX]=vec4f(clamp(irradiance,vec3f(0.),vec3f(1.)),writeGeometryInfo*uniforms.scatteringDiffusionProfile/255.); 
#else
#ifdef PREPASS_COLOR
fragData[PREPASS_COLOR_INDEX]=finalColor; 
#endif
fragData[PREPASS_IRRADIANCE_INDEX]=vec4f(clamp(irradiance,vec3f(0.),vec3f(1.)),writeGeometryInfo); 
#endif
#elif defined(PREPASS_COLOR)
fragData[PREPASS_COLOR_INDEX]=vec4f(finalColor.rgb,finalColor.a);
#endif
#ifdef PREPASS_DEPTH
fragData[PREPASS_DEPTH_INDEX]=vec4f(fragmentInputs.vViewPos.z,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_SCREENSPACE_DEPTH
fragData[PREPASS_SCREENSPACE_DEPTH_INDEX]=vec4f(fragmentInputs.position.z,0.0,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_NORMALIZED_VIEW_DEPTH
fragData[PREPASS_NORMALIZED_VIEW_DEPTH_INDEX]=vec4f(fragmentInputs.vNormViewDepth,0.0,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_NORMAL
#ifdef PREPASS_NORMAL_WORLDSPACE
fragData[PREPASS_NORMAL_INDEX]=vec4f(normalW,writeGeometryInfo);
#else
fragData[PREPASS_NORMAL_INDEX]=vec4f(normalize((scene.view*vec4f(normalW,0.0)).rgb),writeGeometryInfo);
#endif
#endif
#ifdef PREPASS_WORLD_NORMAL
fragData[PREPASS_WORLD_NORMAL_INDEX]=vec4f(normalW*0.5+0.5,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO_SQRT
fragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4f(sqAlbedo,writeGeometryInfo);
#endif
#ifdef PREPASS_REFLECTIVITY
#ifndef UNLIT
fragData[PREPASS_REFLECTIVITY_INDEX]=vec4f(specularEnvironmentR0,microSurface)*writeGeometryInfo;
#else
fragData[PREPASS_REFLECTIVITY_INDEX]=vec4f(0.0,0.0,0.0,1.0)*writeGeometryInfo;
#endif
#endif
#if SCENE_MRT_COUNT>0
fragmentOutputs.fragData0=fragData[0];
#endif
#if SCENE_MRT_COUNT>1
fragmentOutputs.fragData1=fragData[1];
#endif
#if SCENE_MRT_COUNT>2
fragmentOutputs.fragData2=fragData[2];
#endif
#if SCENE_MRT_COUNT>3
fragmentOutputs.fragData3=fragData[3];
#endif
#if SCENE_MRT_COUNT>4
fragmentOutputs.fragData4=fragData[4];
#endif
#if SCENE_MRT_COUNT>5
fragmentOutputs.fragData5=fragData[5];
#endif
#if SCENE_MRT_COUNT>6
fragmentOutputs.fragData6=fragData[6];
#endif
#if SCENE_MRT_COUNT>7
fragmentOutputs.fragData7=fragData[7];
#endif
#endif
`;g.IncludesShadersStoreWGSL[g3]||(g.IncludesShadersStoreWGSL[g3]=O$)});var S3,L$,pI=S(()=>{O();S3="oitFragment",L$=`#ifdef ORDER_INDEPENDENT_TRANSPARENCY
var fragDepth: f32=fragmentInputs.position.z; 
#ifdef ORDER_INDEPENDENT_TRANSPARENCY_16BITS
var halfFloat: u32=pack2x16float( vec2f(fragDepth));var full: vec2f=unpack2x16float(halfFloat);fragDepth=full.x;
#endif
var fragCoord: vec2i=vec2i(fragmentInputs.position.xy);var lastDepth: vec2f=textureLoad(oitDepthSampler,fragCoord,0).rg;var lastFrontColor: vec4f=textureLoad(oitFrontColorSampler,fragCoord,0);fragmentOutputs.depth=vec2f(-MAX_DEPTH);fragmentOutputs.frontColor=lastFrontColor;fragmentOutputs.backColor= vec4f(0.0);
#ifdef USE_REVERSE_DEPTHBUFFER
var furthestDepth: f32=-lastDepth.x;var nearestDepth: f32=lastDepth.y;
#else
var nearestDepth: f32=-lastDepth.x;var furthestDepth: f32=lastDepth.y;
#endif
var alphaMultiplier: f32=1.0-lastFrontColor.a;
#ifdef USE_REVERSE_DEPTHBUFFER
if (fragDepth>nearestDepth || fragDepth<furthestDepth) {
#else
if (fragDepth<nearestDepth || fragDepth>furthestDepth) {
#endif
return fragmentOutputs;}
#ifdef USE_REVERSE_DEPTHBUFFER
if (fragDepth<nearestDepth && fragDepth>furthestDepth) {
#else
if (fragDepth>nearestDepth && fragDepth<furthestDepth) {
#endif
fragmentOutputs.depth=vec2f(-fragDepth,fragDepth);return fragmentOutputs;}
#endif
`;g.IncludesShadersStoreWGSL[S3]||(g.IncludesShadersStoreWGSL[S3]=L$)});var E3,w$,T3=S(()=>{O();E3="pbrDebug",w$=`#if DEBUGMODE>0
if (input.vClipSpacePosition.x/input.vClipSpacePosition.w>=uniforms.vDebugMode.x) {var color: vec3f;
#if DEBUGMODE==1
color=fragmentInputs.vPositionW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==2 && defined(NORMAL)
color=fragmentInputs.vNormalW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==3 && defined(BUMP) || DEBUGMODE==3 && defined(PARALLAX) || DEBUGMODE==3 && defined(ANISOTROPIC)
color=TBN[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==4 && defined(BUMP) || DEBUGMODE==4 && defined(PARALLAX) || DEBUGMODE==4 && defined(ANISOTROPIC)
color=TBN[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==5
color=normalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==6 && defined(MAINUV1)
color= vec3f(input.vMainUV1,0.0);
#elif DEBUGMODE==7 && defined(MAINUV2)
color= vec3f(input.vMainUV2,0.0);
#elif DEBUGMODE==8 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)
color=clearcoatOut.TBNClearCoat[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==9 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)
color=clearcoatOut.TBNClearCoat[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==10 && defined(CLEARCOAT)
color=clearcoatOut.clearCoatNormalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==11 && defined(ANISOTROPIC)
color=anisotropicOut.anisotropicNormal;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==12 && defined(ANISOTROPIC)
color=anisotropicOut.anisotropicTangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==13 && defined(ANISOTROPIC)
color=anisotropicOut.anisotropicBitangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==20 && defined(ALBEDO)
color=albedoTexture.rgb;
#ifndef GAMMAALBEDO
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==21 && defined(AMBIENT)
color=aoOut.ambientOcclusionColorMap.rgb;
#elif DEBUGMODE==22 && defined(OPACITY)
color=opacityMap.rgb;
#elif DEBUGMODE==23 && defined(EMISSIVE)
color=emissiveColorTex.rgb;
#ifndef GAMMAEMISSIVE
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==24 && defined(LIGHTMAP)
color=lightmapColor;
#ifndef GAMMALIGHTMAP
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==25 && defined(REFLECTIVITY) && defined(METALLICWORKFLOW)
color=reflectivityOut.surfaceMetallicColorMap.rgb;
#elif DEBUGMODE==26 && defined(REFLECTIVITY) && !defined(METALLICWORKFLOW)
color=reflectivityOut.surfaceReflectivityColorMap.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==27 && defined(CLEARCOAT) && defined(CLEARCOAT_TEXTURE)
color= vec3f(clearcoatOut.clearCoatMapData.rg,0.0);
#elif DEBUGMODE==28 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
color=clearcoatOut.clearCoatTintMapData.rgb;
#elif DEBUGMODE==29 && defined(SHEEN) && defined(SHEEN_TEXTURE)
color=sheenOut.sheenMapData.rgb;
#elif DEBUGMODE==30 && defined(ANISOTROPIC) && defined(ANISOTROPIC_TEXTURE)
color=anisotropicOut.anisotropyMapData.rgb;
#elif DEBUGMODE==31 && defined(SUBSURFACE) && defined(SS_THICKNESSANDMASK_TEXTURE)
color=subSurfaceOut.thicknessMap.rgb;
#elif DEBUGMODE==32 && defined(BUMP)
color=textureSample(bumpSampler,bumpSamplerSampler,fragmentInputs.vBumpUV).rgb;
#elif DEBUGMODE==40 && defined(SS_REFRACTION)
color=subSurfaceOut.environmentRefraction.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==41 && defined(REFLECTION)
color=reflectionOut.environmentRadiance.rgb;
#ifndef GAMMAREFLECTION
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==42 && defined(CLEARCOAT) && defined(REFLECTION)
color=clearcoatOut.environmentClearCoatRadiance.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==50
color=diffuseBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==51 && defined(SPECULARTERM)
color=specularBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==52 && defined(CLEARCOAT)
color=clearCoatBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==53 && defined(SHEEN)
color=sheenBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==54 && defined(REFLECTION)
color=reflectionOut.environmentIrradiance.rgb;
#ifndef GAMMAREFLECTION
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==60
color=surfaceAlbedo.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==61
color=clearcoatOut.specularEnvironmentR0;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==62 && defined(METALLICWORKFLOW)
color= vec3f(reflectivityOut.metallic);
#elif DEBUGMODE==71 && defined(METALLICWORKFLOW)
color=reflectivityOut.metallicF0;
#elif DEBUGMODE==63
color= vec3f(roughness);
#elif DEBUGMODE==64
color= vec3f(alphaG);
#elif DEBUGMODE==65
color= vec3f(NdotV);
#elif DEBUGMODE==66 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
color=clearcoatOut.clearCoatColor;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==67 && defined(CLEARCOAT)
color= vec3f(clearcoatOut.clearCoatRoughness);
#elif DEBUGMODE==68 && defined(CLEARCOAT)
color= vec3f(clearcoatOut.clearCoatNdotV);
#elif DEBUGMODE==69 && defined(SUBSURFACE) && defined(SS_TRANSLUCENCY)
color=subSurfaceOut.transmittance;
#elif DEBUGMODE==70 && defined(SUBSURFACE) && defined(SS_REFRACTION)
color=subSurfaceOut.refractionTransmittance;
#elif DEBUGMODE==72
color= vec3f(microSurface);
#elif DEBUGMODE==73
color=uniforms.vAlbedoColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==74 && !defined(METALLICWORKFLOW)
color=uniforms.vReflectivityColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==75
color=uniforms.vEmissiveColor;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==80 && defined(RADIANCEOCCLUSION)
color= vec3f(seo);
#elif DEBUGMODE==81 && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
color= vec3f(eho);
#elif DEBUGMODE==82 && defined(MS_BRDF_ENERGY_CONSERVATION)
color= vec3f(energyConservationFactor);
#elif DEBUGMODE==83 && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
color=baseSpecularEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==84 && defined(CLEARCOAT) && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
color=clearcoatOut.clearCoatEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==85 && defined(SHEEN) && defined(REFLECTION)
color=sheenOut.sheenEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==86 && defined(ALPHABLEND)
color= vec3f(luminanceOverAlpha);
#elif DEBUGMODE==87
color= vec3f(alpha);
#elif DEBUGMODE==88 && defined(ALBEDO)
color= vec3f(albedoTexture.a);
#elif DEBUGMODE==89
color=aoOut.ambientOcclusionColor;
#else
var stripeWidth: f32=30.;var stripePos: f32=abs(floor(input.position.x/stripeWidth));var whichColor: f32=((stripePos)%(2.));var color1: vec3f= vec3f(.6,.2,.2);var color2: vec3f= vec3f(.3,.1,.1);color=mix(color1,color2,whichColor);
#endif
color*=uniforms.vDebugMode.y;
#ifdef DEBUGMODE_NORMALIZE
color=normalize(color)*0.5+0.5;
#endif
#ifdef DEBUGMODE_GAMMA
color=toGammaSpaceVec3(color);
#endif
fragmentOutputs.color=vec4f(color,1.0);
#ifdef PREPASS
fragmentOutputs.fragData0=toLinearSpaceVec3(color); 
fragmentOutputs.fragData1=vec4f(0.,0.,0.,0.); 
#endif
#ifdef DEBUGMODE_FORCERETURN
return fragmentOutputs;
#endif
}
#endif
`;g.IncludesShadersStoreWGSL[E3]||(g.IncludesShadersStoreWGSL[E3]=w$)});var A3={};V(A3,{pbrPixelShaderWGSL:()=>F$});var mI,x3,F$,R3=S(()=>{O();fI();hI();$C();nU();T_();fU();E_();ba();za();pu();Pi();uU();Ru();mU();A_();x_();rI();gU();SU();Pf();bu();AU();bU();G_();V_();S_();PU();OU();wU();NU();UU();VU();WU();zU();YU();qU();Ca();jU();W_();$U();dI();i3();s3();uI();a3();l3();R_();f3();u3();p3();mu();_u();_3();v3();pI();T3();mI="pbrPixelShader",x3=`#define PBR_FRAGMENT_SHADER
#define CUSTOM_FRAGMENT_BEGIN
#include<prePassDeclaration>[SCENE_MRT_COUNT]
#include<oitDeclaration>
#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE
#endif
#include<pbrUboDeclaration>
#include<pbrFragmentExtraDeclaration>
#include<lightUboDeclaration>[0..maxSimultaneousLights]
#include<pbrFragmentSamplersDeclaration>
#include<imageProcessingDeclaration>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#include<helperFunctions>
#include<subSurfaceScatteringFunctions>
#include<importanceSampling>
#include<pbrHelperFunctions>
#include<imageProcessingFunctions>
#include<shadowsFragmentFunctions>
#include<harmonicsFunctions>
#include<pbrDirectLightingSetupFunctions>
#include<pbrDirectLightingFalloffFunctions>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
#include<pbrDirectLightingFunctions>
#include<pbrIBLFunctions>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#ifdef REFLECTION
#include<reflectionFunction>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
#include<pbrBlockAlbedoOpacity>
#include<pbrBlockReflectivity>
#include<pbrBlockAmbientOcclusion>
#include<pbrBlockAlphaFresnel>
#include<pbrBlockAnisotropic>
#include<pbrBlockReflection>
#include<pbrBlockSheen>
#include<pbrBlockClearcoat>
#include<pbrBlockIridescence>
#include<pbrBlockSubSurface>
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#include<pbrBlockNormalGeometric>
#include<bumpFragment>
#include<pbrBlockNormalFinal>
var albedoOpacityOut: albedoOpacityOutParams;
#ifdef ALBEDO
var albedoTexture: vec4f=textureSample(albedoSampler,albedoSamplerSampler,fragmentInputs.vAlbedoUV+uvOffset);
#endif
#ifdef BASE_WEIGHT
var baseWeightTexture: vec4f=textureSample(baseWeightSampler,baseWeightSamplerSampler,fragmentInputs.vBaseWeightUV+uvOffset);
#endif
#ifdef OPACITY
var opacityMap: vec4f=textureSample(opacitySampler,opacitySamplerSampler,fragmentInputs.vOpacityUV+uvOffset);
#endif
#ifdef DECAL
var decalColor: vec4f=textureSample(decalSampler,decalSamplerSampler,fragmentInputs.vDecalUV+uvOffset);
#endif
albedoOpacityOut=albedoOpacityBlock(
uniforms.vAlbedoColor
#ifdef ALBEDO
,albedoTexture
,uniforms.vAlbedoInfos
#endif
,uniforms.baseWeight
#ifdef BASE_WEIGHT
,baseWeightTexture
,uniforms.vBaseWeightInfos
#endif
#ifdef OPACITY
,opacityMap
,uniforms.vOpacityInfos
#endif
#ifdef DETAIL
,detailColor
,uniforms.vDetailInfos
#endif
#ifdef DECAL
,decalColor
,uniforms.vDecalInfos
#endif
);var surfaceAlbedo: vec3f=albedoOpacityOut.surfaceAlbedo;var alpha: f32=albedoOpacityOut.alpha;
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
#include<depthPrePass>
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS
var aoOut: ambientOcclusionOutParams;
#ifdef AMBIENT
var ambientOcclusionColorMap: vec3f=textureSample(ambientSampler,ambientSamplerSampler,fragmentInputs.vAmbientUV+uvOffset).rgb;
#endif
aoOut=ambientOcclusionBlock(
#ifdef AMBIENT
ambientOcclusionColorMap,
uniforms.vAmbientInfos
#endif
);
#include<pbrBlockLightmapInit>
#ifdef UNLIT
var diffuseBase: vec3f= vec3f(1.,1.,1.);
#else
var baseColor: vec3f=surfaceAlbedo;var reflectivityOut: reflectivityOutParams;
#if defined(REFLECTIVITY)
var surfaceMetallicOrReflectivityColorMap: vec4f=textureSample(reflectivitySampler,reflectivitySamplerSampler,fragmentInputs.vReflectivityUV+uvOffset);var baseReflectivity: vec4f=surfaceMetallicOrReflectivityColorMap;
#ifndef METALLICWORKFLOW
#ifdef REFLECTIVITY_GAMMA
surfaceMetallicOrReflectivityColorMap=toLinearSpaceVec4(surfaceMetallicOrReflectivityColorMap);
#endif
surfaceMetallicOrReflectivityColorMap=vec4f(surfaceMetallicOrReflectivityColorMap.rgb*uniforms.vReflectivityInfos.y,surfaceMetallicOrReflectivityColorMap.a);
#endif
#endif
#if defined(MICROSURFACEMAP)
var microSurfaceTexel: vec4f=textureSample(microSurfaceSampler,microSurfaceSamplerSampler,fragmentInputs.vMicroSurfaceSamplerUV+uvOffset)*uniforms.vMicroSurfaceSamplerInfos.y;
#endif
#ifdef BASE_DIFFUSE_ROUGHNESS
var baseDiffuseRoughnessTexture: f32=textureSample(baseDiffuseRoughnessSampler,baseDiffuseRoughnessSamplerSampler,fragmentInputs.vBaseDiffuseRoughnessUV+uvOffset).x;
#endif
#ifdef METALLICWORKFLOW
var metallicReflectanceFactors: vec4f=uniforms.vMetallicReflectanceFactors;
#ifdef REFLECTANCE
var reflectanceFactorsMap: vec4f=textureSample(reflectanceSampler,reflectanceSamplerSampler,fragmentInputs.vReflectanceUV+uvOffset);
#ifdef REFLECTANCE_GAMMA
reflectanceFactorsMap=toLinearSpaceVec4(reflectanceFactorsMap);
#endif
metallicReflectanceFactors=vec4f(metallicReflectanceFactors.rgb*reflectanceFactorsMap.rgb,metallicReflectanceFactors.a);
#endif
#ifdef METALLIC_REFLECTANCE
var metallicReflectanceFactorsMap: vec4f=textureSample(metallicReflectanceSampler,metallicReflectanceSamplerSampler,fragmentInputs.vMetallicReflectanceUV+uvOffset);
#ifdef METALLIC_REFLECTANCE_GAMMA
metallicReflectanceFactorsMap=toLinearSpaceVec4(metallicReflectanceFactorsMap);
#endif
#ifndef METALLIC_REFLECTANCE_USE_ALPHA_ONLY
metallicReflectanceFactors=vec4f(metallicReflectanceFactors.rgb*metallicReflectanceFactorsMap.rgb,metallicReflectanceFactors.a);
#endif
metallicReflectanceFactors.a*=metallicReflectanceFactorsMap.a;
#endif
#endif
reflectivityOut=reflectivityBlock(
uniforms.vReflectivityColor
#ifdef METALLICWORKFLOW
,surfaceAlbedo
,metallicReflectanceFactors
#endif
,uniforms.baseDiffuseRoughness
#ifdef BASE_DIFFUSE_ROUGHNESS
,baseDiffuseRoughnessTexture
,uniforms.vBaseDiffuseRoughnessInfos
#endif
#ifdef REFLECTIVITY
,uniforms.vReflectivityInfos
,surfaceMetallicOrReflectivityColorMap
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
,aoOut.ambientOcclusionColor
#endif
#ifdef MICROSURFACEMAP
,microSurfaceTexel
#endif
#ifdef DETAIL
,detailColor
,uniforms.vDetailInfos
#endif
);var microSurface: f32=reflectivityOut.microSurface;var roughness: f32=reflectivityOut.roughness;var diffuseRoughness: f32=reflectivityOut.diffuseRoughness;
#ifdef METALLICWORKFLOW
surfaceAlbedo=reflectivityOut.surfaceAlbedo;
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
aoOut.ambientOcclusionColor=reflectivityOut.ambientOcclusionColor;
#endif
#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
var alphaFresnelOut: alphaFresnelOutParams;alphaFresnelOut=alphaFresnelBlock(
normalW,
viewDirectionW,
alpha,
microSurface
);alpha=alphaFresnelOut.alpha;
#endif
#endif
#include<pbrBlockGeometryInfo>
#ifdef ANISOTROPIC
var anisotropicOut: anisotropicOutParams;
#ifdef ANISOTROPIC_TEXTURE
var anisotropyMapData: vec3f=textureSample(anisotropySampler,anisotropySamplerSampler,fragmentInputs.vAnisotropyUV+uvOffset).rgb*uniforms.vAnisotropyInfos.y;
#endif
anisotropicOut=anisotropicBlock(
uniforms.vAnisotropy,
roughness,
#ifdef ANISOTROPIC_TEXTURE
anisotropyMapData,
#endif
TBN,
normalW,
viewDirectionW
);
#endif
#ifdef REFLECTION
var reflectionOut: reflectionOutParams;
#ifndef USE_CUSTOM_REFLECTION
reflectionOut=reflectionBlock(
fragmentInputs.vPositionW
,normalW
,alphaG
,uniforms.vReflectionMicrosurfaceInfos
,uniforms.vReflectionInfos
,uniforms.vReflectionColor
#ifdef ANISOTROPIC
,anisotropicOut
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,NdotVUnclamped
#endif
#ifdef LINEARSPECULARREFLECTION
,roughness
#endif
,reflectionSampler
,reflectionSamplerSampler
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
,fragmentInputs.vEnvironmentIrradiance
#endif
#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))
,uniforms.reflectionMatrix
#endif
#ifdef USEIRRADIANCEMAP
,irradianceSampler
,irradianceSamplerSampler
#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION
,uniforms.vReflectionDominantDirection
#endif
#endif
#ifndef LODBASEDMICROSFURACE
,reflectionLowSampler
,reflectionLowSamplerSampler
,reflectionHighSampler
,reflectionHighSamplerSampler
#endif
#ifdef REALTIME_FILTERING
,uniforms.vReflectionFilteringInfo
#ifdef IBL_CDF_FILTERING
,icdfSampler
,icdfSamplerSampler
#endif
#endif
,viewDirectionW
,diffuseRoughness
,surfaceAlbedo
);
#else
#define CUSTOM_REFLECTION
#endif
#endif
#include<pbrBlockReflectance0>
#ifdef SHEEN
var sheenOut: sheenOutParams;
#ifdef SHEEN_TEXTURE
var sheenMapData: vec4f=textureSample(sheenSampler,sheenSamplerSampler,fragmentInputs.vSheenUV+uvOffset);
#endif
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
var sheenMapRoughnessData: vec4f=textureSample(sheenRoughnessSampler,sheenRoughnessSamplerSampler,fragmentInputs.vSheenRoughnessUV+uvOffset)*uniforms.vSheenInfos.w;
#endif
sheenOut=sheenBlock(
uniforms.vSheenColor
#ifdef SHEEN_ROUGHNESS
,uniforms.vSheenRoughness
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
,sheenMapRoughnessData
#endif
#endif
,roughness
#ifdef SHEEN_TEXTURE
,sheenMapData
,uniforms.vSheenInfos.y
#endif
,reflectanceF0
#ifdef SHEEN_LINKWITHALBEDO
,baseColor
,surfaceAlbedo
#endif
#ifdef ENVIRONMENTBRDF
,NdotV
,environmentBrdf
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
,AARoughnessFactors
,uniforms.vReflectionMicrosurfaceInfos
,uniforms.vReflectionInfos
,uniforms.vReflectionColor
,uniforms.vLightingIntensity
,reflectionSampler
,reflectionSamplerSampler
,reflectionOut.reflectionCoords
,NdotVUnclamped
#ifndef LODBASEDMICROSFURACE
,reflectionLowSampler
,reflectionLowSamplerSampler
,reflectionHighSampler
,reflectionHighSamplerSampler
#endif
#ifdef REALTIME_FILTERING
,uniforms.vReflectionFilteringInfo
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
,seo
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
,eho
#endif
#endif
);
#ifdef SHEEN_LINKWITHALBEDO
surfaceAlbedo=sheenOut.surfaceAlbedo;
#endif
#endif
#ifdef CLEARCOAT
#ifdef CLEARCOAT_TEXTURE
var clearCoatMapData: vec2f=textureSample(clearCoatSampler,clearCoatSamplerSampler,fragmentInputs.vClearCoatUV+uvOffset).rg*uniforms.vClearCoatInfos.y;
#endif
#endif
#ifdef IRIDESCENCE
var iridescenceOut: iridescenceOutParams;
#ifdef IRIDESCENCE_TEXTURE
var iridescenceMapData: vec2f=textureSample(iridescenceSampler,iridescenceSamplerSampler,fragmentInputs.vIridescenceUV+uvOffset).rg*uniforms.vIridescenceInfos.y;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
var iridescenceThicknessMapData: vec2f=textureSample(iridescenceThicknessSampler,iridescenceThicknessSamplerSampler,fragmentInputs.vIridescenceThicknessUV+uvOffset).rg*uniforms.vIridescenceInfos.w;
#endif
iridescenceOut=iridescenceBlock(
uniforms.vIridescenceParams
,NdotV
,specularEnvironmentR0
#ifdef IRIDESCENCE_TEXTURE
,iridescenceMapData
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
,iridescenceThicknessMapData
#endif
#ifdef CLEARCOAT
,NdotVUnclamped
,uniforms.vClearCoatParams
#ifdef CLEARCOAT_TEXTURE
,clearCoatMapData
#endif
#endif
);var iridescenceIntensity: f32=iridescenceOut.iridescenceIntensity;specularEnvironmentR0=iridescenceOut.specularEnvironmentR0;
#endif
var clearcoatOut: clearcoatOutParams;
#ifdef CLEARCOAT
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
var clearCoatMapRoughnessData: vec4f=textureSample(clearCoatRoughnessSampler,clearCoatRoughnessSamplerSampler,fragmentInputs.vClearCoatRoughnessUV+uvOffset)*uniforms.vClearCoatInfos.w;
#endif
#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
var clearCoatTintMapData: vec4f=textureSample(clearCoatTintSampler,clearCoatTintSamplerSampler,fragmentInputs.vClearCoatTintUV+uvOffset);
#endif
#ifdef CLEARCOAT_BUMP
var clearCoatBumpMapData: vec4f=textureSample(clearCoatBumpSampler,clearCoatBumpSamplerSampler,fragmentInputs.vClearCoatBumpUV+uvOffset);
#endif
clearcoatOut=clearcoatBlock(
fragmentInputs.vPositionW
,geometricNormalW
,viewDirectionW
,uniforms.vClearCoatParams
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
,clearCoatMapRoughnessData
#endif
,specularEnvironmentR0
#ifdef CLEARCOAT_TEXTURE
,clearCoatMapData
#endif
#ifdef CLEARCOAT_TINT
,uniforms.vClearCoatTintParams
,uniforms.clearCoatColorAtDistance
,uniforms.vClearCoatRefractionParams
#ifdef CLEARCOAT_TINT_TEXTURE
,clearCoatTintMapData
#endif
#endif
#ifdef CLEARCOAT_BUMP
,uniforms.vClearCoatBumpInfos
,clearCoatBumpMapData
,fragmentInputs.vClearCoatBumpUV
#if defined(TANGENT) && defined(NORMAL)
,mat3x3<f32>(input.vTBN0,input.vTBN1,input.vTBN2)
#else
,uniforms.vClearCoatTangentSpaceParams
#endif
#ifdef OBJECTSPACE_NORMALMAP
,uniforms.normalMatrix
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
,faceNormal
#endif
#ifdef REFLECTION
,uniforms.vReflectionMicrosurfaceInfos
,uniforms.vReflectionInfos
,uniforms.vReflectionColor
,uniforms.vLightingIntensity
,reflectionSampler
,reflectionSamplerSampler
#ifndef LODBASEDMICROSFURACE
,reflectionLowSampler
,reflectionLowSamplerSampler
,reflectionHighSampler
,reflectionHighSamplerSampler
#endif
#ifdef REALTIME_FILTERING
,uniforms.vReflectionFilteringInfo
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
,select(-1.,1.,fragmentInputs.frontFacing)
#endif
);
#else
clearcoatOut.specularEnvironmentR0=specularEnvironmentR0;
#endif
#include<pbrBlockReflectance>
var subSurfaceOut: subSurfaceOutParams;
#ifdef SUBSURFACE
#ifdef SS_THICKNESSANDMASK_TEXTURE
var thicknessMap: vec4f=textureSample(thicknessSampler,thicknessSamplerSampler,fragmentInputs.vThicknessUV+uvOffset);
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
var refractionIntensityMap: vec4f=textureSample(refractionIntensitySampler,refractionIntensitySamplerSampler,fragmentInputs.vRefractionIntensityUV+uvOffset);
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
var translucencyIntensityMap: vec4f=textureSample(translucencyIntensitySampler,translucencyIntensitySamplerSampler,fragmentInputs.vTranslucencyIntensityUV+uvOffset);
#endif
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
var translucencyColorMap: vec4f=textureSample(translucencyColorSampler,translucencyColorSamplerSampler,fragmentInputs.vTranslucencyColorUV+uvOffset);
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE_GAMMA
translucencyColorMap=toLinearSpaceVec4(translucencyColorMap);
#endif
#endif
subSurfaceOut=subSurfaceBlock(
uniforms.vSubSurfaceIntensity
,uniforms.vThicknessParam
,uniforms.vTintColor
,normalW
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
,vec3f(max(colorSpecularEnvironmentReflectance.r,max(colorSpecularEnvironmentReflectance.g,colorSpecularEnvironmentReflectance.b)))
#else
,baseSpecularEnvironmentReflectance
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
,thicknessMap
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
,refractionIntensityMap
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
,translucencyIntensityMap
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
,uniforms.reflectionMatrix
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
,reflectionOut.irradianceVector
#endif
#if defined(REALTIME_FILTERING)
,reflectionSampler
,reflectionSamplerSampler
,uniforms.vReflectionFilteringInfo
#ifdef IBL_CDF_FILTERING
,icdfSampler
,icdfSamplerSampler
#endif
#endif
#endif
#ifdef USEIRRADIANCEMAP
,irradianceSampler
,irradianceSamplerSampler
#endif
#endif
#endif
#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
,surfaceAlbedo
#endif
#ifdef SS_REFRACTION
,fragmentInputs.vPositionW
,viewDirectionW
,scene.view
,uniforms.vRefractionInfos
,uniforms.refractionMatrix
,uniforms.vRefractionMicrosurfaceInfos
,uniforms.vLightingIntensity
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
,alpha
#endif
#ifdef SS_LODINREFRACTIONALPHA
,NdotVUnclamped
#endif
#ifdef SS_LINEARSPECULARREFRACTION
,roughness
#endif
,alphaG
,refractionSampler
,refractionSamplerSampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler
,refractionLowSamplerSampler
,refractionHighSampler
,refractionHighSamplerSampler
#endif
#ifdef ANISOTROPIC
,anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,uniforms.vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,uniforms.vRefractionPosition
,uniforms.vRefractionSize
#endif
#ifdef SS_DISPERSION
,dispersion
#endif
#endif
#ifdef SS_TRANSLUCENCY
,uniforms.vDiffusionDistance
,uniforms.vTranslucencyColor
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
,translucencyColorMap
#endif
#endif
);
#ifdef SS_REFRACTION
surfaceAlbedo=subSurfaceOut.surfaceAlbedo;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
alpha=subSurfaceOut.alpha;
#endif
#endif
#else
subSurfaceOut.specularEnvironmentReflectance=colorSpecularEnvironmentReflectance;
#endif
#include<pbrBlockDirectLighting>
#include<lightFragment>[0..maxSimultaneousLights]
#include<pbrBlockFinalLitComponents>
#endif 
#include<pbrBlockFinalUnlitComponents>
#define CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION
#include<pbrBlockFinalColorComposition>
#include<logDepthFragment>
#include<fogFragment>(color,finalColor)
#include<pbrBlockImageProcessing>
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
#include<pbrBlockPrePass>
#endif
#if !defined(PREPASS) && !defined(ORDER_INDEPENDENT_TRANSPARENCY)
fragmentOutputs.color=finalColor;
#endif
#include<oitFragment>
#if ORDER_INDEPENDENT_TRANSPARENCY
if (fragDepth==nearestDepth) {fragmentOutputs.frontColor=vec4f(fragmentOutputs.frontColor.rgb+finalColor.rgb*finalColor.a*alphaMultiplier,1.0-alphaMultiplier*(1.0-finalColor.a));} else {fragmentOutputs.backColor+=finalColor;}
#endif
#include<pbrDebug>
#define CUSTOM_FRAGMENT_MAIN_END
}
`;g.ShadersStoreWGSL[mI]||(g.ShadersStoreWGSL[mI]=x3);F$={name:mI,shader:x3}});var b3,N$,_I=S(()=>{O();b3="decalVertexDeclaration",N$=`#ifdef DECAL
uniform vec4 vDecalInfos;uniform mat4 decalMatrix;
#endif
`;g.IncludesShadersStore[b3]||(g.IncludesShadersStore[b3]=N$)});var C3,B$,I3=S(()=>{O();_I();C3="pbrVertexDeclaration",B$=`uniform mat4 view;uniform mat4 viewProjection;uniform vec4 vEyePosition;
#ifdef MULTIVIEW
mat4 viewProjectionR;
#endif
#ifdef ALBEDO
uniform mat4 albedoMatrix;uniform vec2 vAlbedoInfos;
#endif
#ifdef BASE_WEIGHT
uniform mat4 baseWeightMatrix;uniform vec2 vBaseWeightInfos;
#endif
uniform float baseDiffuseRoughness;
#ifdef BASE_DIFFUSE_ROUGHNESS
uniform mat4 baseDiffuseRoughnessMatrix;uniform vec2 vBaseDiffuseRoughnessInfos;
#endif
#ifdef AMBIENT
uniform mat4 ambientMatrix;uniform vec4 vAmbientInfos;
#endif
#ifdef OPACITY
uniform mat4 opacityMatrix;uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;uniform mat4 emissiveMatrix;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;uniform mat4 lightmapMatrix;
#endif
#ifdef REFLECTIVITY
uniform vec3 vReflectivityInfos;uniform mat4 reflectivityMatrix;
#endif
#ifdef METALLIC_REFLECTANCE
uniform vec2 vMetallicReflectanceInfos;uniform mat4 metallicReflectanceMatrix;
#endif
#ifdef REFLECTANCE
uniform vec2 vReflectanceInfos;uniform mat4 reflectanceMatrix;
#endif
#ifdef MICROSURFACEMAP
uniform vec2 vMicroSurfaceSamplerInfos;uniform mat4 microSurfaceSamplerMatrix;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;uniform mat4 bumpMatrix;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
uniform vec4 cameraInfo;
#ifdef REFLECTION
uniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;
#endif
#ifdef CLEARCOAT
#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)
uniform vec4 vClearCoatInfos;
#endif
#ifdef CLEARCOAT_TEXTURE
uniform mat4 clearCoatMatrix;
#endif
#ifdef CLEARCOAT_TEXTURE_ROUGHNESS
uniform mat4 clearCoatRoughnessMatrix;
#endif
#ifdef CLEARCOAT_BUMP
uniform vec2 vClearCoatBumpInfos;uniform mat4 clearCoatBumpMatrix;
#endif
#ifdef CLEARCOAT_TINT_TEXTURE
uniform vec2 vClearCoatTintInfos;uniform mat4 clearCoatTintMatrix;
#endif
#endif
#ifdef IRIDESCENCE
#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)
uniform vec4 vIridescenceInfos;
#endif
#ifdef IRIDESCENCE_TEXTURE
uniform mat4 iridescenceMatrix;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
uniform mat4 iridescenceThicknessMatrix;
#endif
#endif
#ifdef ANISOTROPIC
#ifdef ANISOTROPIC_TEXTURE
uniform vec2 vAnisotropyInfos;uniform mat4 anisotropyMatrix;
#endif
#endif
#ifdef SHEEN
#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)
uniform vec4 vSheenInfos;
#endif
#ifdef SHEEN_TEXTURE
uniform mat4 sheenMatrix;
#endif
#ifdef SHEEN_TEXTURE_ROUGHNESS
uniform mat4 sheenRoughnessMatrix;
#endif
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
uniform vec4 vRefractionInfos;uniform mat4 refractionMatrix;
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
uniform vec2 vThicknessInfos;uniform mat4 thicknessMatrix;
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
uniform vec2 vRefractionIntensityInfos;uniform mat4 refractionIntensityMatrix;
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
uniform vec2 vTranslucencyIntensityInfos;uniform mat4 translucencyIntensityMatrix;
#endif
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
uniform vec2 vTranslucencyColorInfos;uniform mat4 translucencyColorMatrix;
#endif
#endif
#ifdef NORMAL
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
uniform vec3 vSphericalL00;uniform vec3 vSphericalL1_1;uniform vec3 vSphericalL10;uniform vec3 vSphericalL11;uniform vec3 vSphericalL2_2;uniform vec3 vSphericalL2_1;uniform vec3 vSphericalL20;uniform vec3 vSphericalL21;uniform vec3 vSphericalL22;
#else
uniform vec3 vSphericalX;uniform vec3 vSphericalY;uniform vec3 vSphericalZ;uniform vec3 vSphericalXX_ZZ;uniform vec3 vSphericalYY_ZZ;uniform vec3 vSphericalZZ;uniform vec3 vSphericalXY;uniform vec3 vSphericalYZ;uniform vec3 vSphericalZX;
#endif
#endif
#endif
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;uniform mat4 detailMatrix;
#endif
#include<decalVertexDeclaration>
#define ADDITIONAL_VERTEX_DECLARATION
`;g.IncludesShadersStore[C3]||(g.IncludesShadersStore[C3]=B$)});var y3,U$,gI=S(()=>{O();Ml();qh();y3="pbrUboDeclaration",U$=`layout(std140,column_major) uniform;uniform Material {vec2 vAlbedoInfos;vec2 vBaseWeightInfos;vec2 vBaseDiffuseRoughnessInfos;vec4 vAmbientInfos;vec2 vOpacityInfos;vec2 vEmissiveInfos;vec2 vLightmapInfos;vec3 vReflectivityInfos;vec2 vMicroSurfaceSamplerInfos;vec2 vReflectionInfos;vec2 vReflectionFilteringInfo;vec3 vReflectionPosition;vec3 vReflectionSize;vec3 vBumpInfos;mat4 albedoMatrix;mat4 baseWeightMatrix;mat4 baseDiffuseRoughnessMatrix;mat4 ambientMatrix;mat4 opacityMatrix;mat4 emissiveMatrix;mat4 lightmapMatrix;mat4 reflectivityMatrix;mat4 microSurfaceSamplerMatrix;mat4 bumpMatrix;vec2 vTangentSpaceParams;mat4 reflectionMatrix;vec3 vReflectionColor;vec4 vAlbedoColor;float baseWeight;float baseDiffuseRoughness;vec4 vLightingIntensity;vec3 vReflectionMicrosurfaceInfos;vec3 vReflectionDominantDirection;float pointSize;vec4 vReflectivityColor;vec3 vEmissiveColor;vec3 vAmbientColor;vec2 vDebugMode;vec4 vMetallicReflectanceFactors;vec2 vMetallicReflectanceInfos;mat4 metallicReflectanceMatrix;vec2 vReflectanceInfos;mat4 reflectanceMatrix;vec3 vSphericalL00;vec3 vSphericalL1_1;vec3 vSphericalL10;vec3 vSphericalL11;vec3 vSphericalL2_2;vec3 vSphericalL2_1;vec3 vSphericalL20;vec3 vSphericalL21;vec3 vSphericalL22;vec3 vSphericalX;vec3 vSphericalY;vec3 vSphericalZ;vec3 vSphericalXX_ZZ;vec3 vSphericalYY_ZZ;vec3 vSphericalZZ;vec3 vSphericalXY;vec3 vSphericalYZ;vec3 vSphericalZX;vec4 cameraInfo;
#define ADDITIONAL_UBO_DECLARATION
};
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;g.IncludesShadersStore[y3]||(g.IncludesShadersStore[y3]=U$)});var M3,G$,vI=S(()=>{O();M3="uvAttributeDeclaration",G$=`#ifdef UV{X}
attribute vec2 uv{X};
#endif
`;g.IncludesShadersStore[M3]||(g.IncludesShadersStore[M3]=G$)});var P3,V$,Cu=S(()=>{O();P3="mainUVVaryingDeclaration",V$=`#ifdef MAINUV{X}
varying vec2 vMainUV{X};
#endif
`;g.IncludesShadersStore[P3]||(g.IncludesShadersStore[P3]=V$)});var D3,k$,Df=S(()=>{O();D3="pbrBRDFFunctions",k$=`#define FRESNEL_MAXIMUM_ON_ROUGH 0.25
#define BRDF_DIFFUSE_MODEL_EON 0
#define BRDF_DIFFUSE_MODEL_BURLEY 1
#define BRDF_DIFFUSE_MODEL_LAMBERT 2
#define BRDF_DIFFUSE_MODEL_LEGACY 3
#define DIELECTRIC_SPECULAR_MODEL_GLTF 0
#define DIELECTRIC_SPECULAR_MODEL_OPENPBR 1
#define CONDUCTOR_SPECULAR_MODEL_GLTF 0
#define CONDUCTOR_SPECULAR_MODEL_OPENPBR 1
#ifndef PBR_VERTEX_SHADER
#ifdef MS_BRDF_ENERGY_CONSERVATION
vec3 getEnergyConservationFactor(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {return 1.0+specularEnvironmentR0*(1.0/environmentBrdf.y-1.0);}
#endif
#if CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR 
vec3 getF82Specular(float NdotV,vec3 F0,vec3 edgeTint,float roughness) {const float cos_theta_max=0.142857143; 
const float one_minus_cos_theta_max_to_the_fifth=0.462664366; 
const float one_minus_cos_theta_max_to_the_sixth=0.396569457; 
vec3 white_minus_F0=vec3(1.0)-F0;vec3 b_numerator=(F0+white_minus_F0*one_minus_cos_theta_max_to_the_fifth)*(vec3(1.0)-edgeTint);const float b_denominator=cos_theta_max*one_minus_cos_theta_max_to_the_sixth;const float b_denominator_reciprocal=1.0/b_denominator;vec3 b=b_numerator*b_denominator_reciprocal; 
float cos_theta=max(roughness,NdotV);float one_minus_cos_theta=1.0-cos_theta;vec3 offset_from_F0=(white_minus_F0-b*cos_theta*one_minus_cos_theta)*pow(one_minus_cos_theta,5.0);return clamp(F0+offset_from_F0,0.0,1.0);}
#endif
#ifdef ENVIRONMENTBRDF
vec3 getBRDFLookup(float NdotV,float perceptualRoughness) {vec2 UV=vec2(NdotV,perceptualRoughness);vec4 brdfLookup=texture2D(environmentBrdfSampler,UV);
#ifdef ENVIRONMENTBRDF_RGBD
brdfLookup.rgb=fromRGBD(brdfLookup.rgba);
#endif
return brdfLookup.rgb;}
vec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 specularEnvironmentR90,const vec3 environmentBrdf) {
#ifdef BRDF_V_HEIGHT_CORRELATED
vec3 reflectance=(specularEnvironmentR90-specularEnvironmentR0)*environmentBrdf.x+specularEnvironmentR0*environmentBrdf.y;
#else
vec3 reflectance=specularEnvironmentR0*environmentBrdf.x+specularEnvironmentR90*environmentBrdf.y;
#endif
return reflectance;}
vec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {
#ifdef BRDF_V_HEIGHT_CORRELATED
vec3 reflectance=mix(environmentBrdf.xxx,environmentBrdf.yyy,specularEnvironmentR0);
#else
vec3 reflectance=specularEnvironmentR0*environmentBrdf.x+environmentBrdf.y;
#endif
return reflectance;}
#endif
/* NOT USED
#if defined(SHEEN) && defined(SHEEN_SOFTER)
float getBRDFLookupCharlieSheen(float NdotV,float perceptualRoughness)
{float c=1.0-NdotV;float c3=c*c*c;return 0.65584461*c3+1.0/(4.16526551+exp(-7.97291361*perceptualRoughness+6.33516894));}
#endif
*/
#if !defined(ENVIRONMENTBRDF) || defined(REFLECTIONMAP_SKYBOX) || defined(ALPHAFRESNEL)
vec3 getReflectanceFromAnalyticalBRDFLookup_Jones(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)
{float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
/**
* The sheen BRDF not containing F can be easily stored in the blue channel of the BRDF texture.
* The blue channel contains DCharlie*VAshikhmin*NdotL as a lokkup table
*/
vec3 getSheenReflectanceFromBRDFLookup(const vec3 reflectance0,const vec3 environmentBrdf) {vec3 sheenEnvironmentReflectance=reflectance0*environmentBrdf.b;return sheenEnvironmentReflectance;}
#endif
vec3 fresnelSchlickGGX(float VdotH,vec3 reflectance0,vec3 reflectance90)
{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}
float fresnelSchlickGGX(float VdotH,float reflectance0,float reflectance90)
{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}
#ifdef CLEARCOAT
vec3 getR0RemappedForClearCoat(vec3 f0) {
#ifdef CLEARCOAT_DEFAULTIOR
#ifdef MOBILE
return saturate(f0*(f0*0.526868+0.529324)-0.0482256);
#else
return saturate(f0*(f0*(0.941892-0.263008*f0)+0.346479)-0.0285998);
#endif
#else
vec3 s=sqrt(f0);vec3 t=(vClearCoatRefractionParams.z+vClearCoatRefractionParams.w*s)/(vClearCoatRefractionParams.w+vClearCoatRefractionParams.z*s);return square(t);
#endif
}
#endif
#ifdef IRIDESCENCE
const mat3 XYZ_TO_REC709=mat3(
3.2404542,-0.9692660, 0.0556434,
-1.5371385, 1.8760108,-0.2040259,
-0.4985314, 0.0415560, 1.0572252
);vec3 getIORTfromAirToSurfaceR0(vec3 f0) {vec3 sqrtF0=sqrt(f0);return (1.+sqrtF0)/(1.-sqrtF0);}
vec3 getR0fromIORs(vec3 iorT,float iorI) {return square((iorT-vec3(iorI))/(iorT+vec3(iorI)));}
float getR0fromIORs(float iorT,float iorI) {return square((iorT-iorI)/(iorT+iorI));}
vec3 evalSensitivity(float opd,vec3 shift) {float phase=2.0*PI*opd*1.0e-9;const vec3 val=vec3(5.4856e-13,4.4201e-13,5.2481e-13);const vec3 pos=vec3(1.6810e+06,1.7953e+06,2.2084e+06);const vec3 var=vec3(4.3278e+09,9.3046e+09,6.6121e+09);vec3 xyz=val*sqrt(2.0*PI*var)*cos(pos*phase+shift)*exp(-square(phase)*var);xyz.x+=9.7470e-14*sqrt(2.0*PI*4.5282e+09)*cos(2.2399e+06*phase+shift[0])*exp(-4.5282e+09*square(phase));xyz/=1.0685e-7;vec3 srgb=XYZ_TO_REC709*xyz;return srgb;}
vec3 evalIridescence(float outsideIOR,float eta2,float cosTheta1,float thinFilmThickness,vec3 baseF0) {vec3 I=vec3(1.0);float iridescenceIOR=mix(outsideIOR,eta2,smoothstep(0.0,0.03,thinFilmThickness));float sinTheta2Sq=square(outsideIOR/iridescenceIOR)*(1.0-square(cosTheta1));float cosTheta2Sq=1.0-sinTheta2Sq;if (cosTheta2Sq<0.0) {return I;}
float cosTheta2=sqrt(cosTheta2Sq);float R0=getR0fromIORs(iridescenceIOR,outsideIOR);float R12=fresnelSchlickGGX(cosTheta1,R0,1.);float R21=R12;float T121=1.0-R12;float phi12=0.0;if (iridescenceIOR<outsideIOR) phi12=PI;float phi21=PI-phi12;vec3 baseIOR=getIORTfromAirToSurfaceR0(clamp(baseF0,0.0,0.9999)); 
vec3 R1=getR0fromIORs(baseIOR,iridescenceIOR);vec3 R23=fresnelSchlickGGX(cosTheta2,R1,vec3(1.));vec3 phi23=vec3(0.0);if (baseIOR[0]<iridescenceIOR) phi23[0]=PI;if (baseIOR[1]<iridescenceIOR) phi23[1]=PI;if (baseIOR[2]<iridescenceIOR) phi23[2]=PI;float opd=2.0*iridescenceIOR*thinFilmThickness*cosTheta2;vec3 phi=vec3(phi21)+phi23;vec3 R123=clamp(R12*R23,1e-5,0.9999);vec3 r123=sqrt(R123);vec3 Rs=square(T121)*R23/(vec3(1.0)-R123);vec3 C0=R12+Rs;I=C0;vec3 Cm=Rs-T121;for (int m=1; m<=2; ++m)
{Cm*=r123;vec3 Sm=2.0*evalSensitivity(float(m)*opd,float(m)*phi);I+=Cm*Sm;}
return max(I,vec3(0.0));}
#endif
float normalDistributionFunction_TrowbridgeReitzGGX(float NdotH,float alphaG)
{float a2=square(alphaG);float d=NdotH*NdotH*(a2-1.0)+1.0;return a2/(PI*d*d);}
#ifdef SHEEN
float normalDistributionFunction_CharlieSheen(float NdotH,float alphaG)
{float invR=1./alphaG;float cos2h=NdotH*NdotH;float sin2h=1.-cos2h;return (2.+invR)*pow(sin2h,invR*.5)/(2.*PI);}
#endif
#ifdef ANISOTROPIC
float normalDistributionFunction_BurleyGGX_Anisotropic(float NdotH,float TdotH,float BdotH,const vec2 alphaTB) {float a2=alphaTB.x*alphaTB.y;vec3 v=vec3(alphaTB.y*TdotH,alphaTB.x *BdotH,a2*NdotH);float v2=dot(v,v);float w2=a2/v2;return a2*w2*w2*RECIPROCAL_PI;}
#endif
#ifdef BRDF_V_HEIGHT_CORRELATED
float smithVisibility_GGXCorrelated(float NdotL,float NdotV,float alphaG) {
#ifdef MOBILE
float GGXV=NdotL*(NdotV*(1.0-alphaG)+alphaG);float GGXL=NdotV*(NdotL*(1.0-alphaG)+alphaG);return 0.5/(GGXV+GGXL);
#else
float a2=alphaG*alphaG;float GGXV=NdotL*sqrt(NdotV*(NdotV-a2*NdotV)+a2);float GGXL=NdotV*sqrt(NdotL*(NdotL-a2*NdotL)+a2);return 0.5/(GGXV+GGXL);
#endif
}
#else
float smithVisibilityG1_TrowbridgeReitzGGXFast(float dot,float alphaG)
{
#ifdef MOBILE
return 1.0/(dot+alphaG+(1.0-alphaG)*dot ));
#else
float alphaSquared=alphaG*alphaG;return 1.0/(dot+sqrt(alphaSquared+(1.0-alphaSquared)*dot*dot));
#endif
}
float smithVisibility_TrowbridgeReitzGGXFast(float NdotL,float NdotV,float alphaG)
{float visibility=smithVisibilityG1_TrowbridgeReitzGGXFast(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGXFast(NdotV,alphaG);return visibility;}
#endif
#ifdef ANISOTROPIC
float smithVisibility_GGXCorrelated_Anisotropic(float NdotL,float NdotV,float TdotV,float BdotV,float TdotL,float BdotL,const vec2 alphaTB) {float lambdaV=NdotL*length(vec3(alphaTB.x*TdotV,alphaTB.y*BdotV,NdotV));float lambdaL=NdotV*length(vec3(alphaTB.x*TdotL,alphaTB.y*BdotL,NdotL));float v=0.5/(lambdaV+lambdaL);return v;}
#endif
#ifdef CLEARCOAT
float visibility_Kelemen(float VdotH) {return 0.25/(VdotH*VdotH); }
#endif
#ifdef SHEEN
float visibility_Ashikhmin(float NdotL,float NdotV)
{return 1./(4.*(NdotL+NdotV-NdotL*NdotV));}
/* NOT USED
#ifdef SHEEN_SOFTER
float l(float x,float alphaG)
{float oneMinusAlphaSq=(1.0-alphaG)*(1.0-alphaG);float a=mix(21.5473,25.3245,oneMinusAlphaSq);float b=mix(3.82987,3.32435,oneMinusAlphaSq);float c=mix(0.19823,0.16801,oneMinusAlphaSq);float d=mix(-1.97760,-1.27393,oneMinusAlphaSq);float e=mix(-4.32054,-4.85967,oneMinusAlphaSq);return a/(1.0+b*pow(x,c))+d*x+e;}
float lambdaSheen(float cosTheta,float alphaG)
{return abs(cosTheta)<0.5 ? exp(l(cosTheta,alphaG)) : exp(2.0*l(0.5,alphaG)-l(1.0-cosTheta,alphaG));}
float visibility_CharlieSheen(float NdotL,float NdotV,float alphaG)
{float G=1.0/(1.0+lambdaSheen(NdotV,alphaG)+lambdaSheen(NdotL,alphaG));return G/(4.0*NdotV*NdotL);}
#endif
*/
#endif
float diffuseBRDF_Burley(float NdotL,float NdotV,float VdotH,float roughness) {float diffuseFresnelNV=pow5(saturateEps(1.0-NdotL));float diffuseFresnelNL=pow5(saturateEps(1.0-NdotV));float diffuseFresnel90=0.5+2.0*VdotH*VdotH*roughness;float fresnel =
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);return fresnel/PI;}
const float constant1_FON=0.5-2.0/(3.0*PI);const float constant2_FON=2.0/3.0-28.0/(15.0*PI);float E_FON_approx(float mu,float roughness)
{float sigma=roughness; 
float mucomp=1.0-mu;float mucomp2=mucomp*mucomp;const mat2 Gcoeffs=mat2(0.0571085289,-0.332181442,
0.491881867,0.0714429953);float GoverPi=dot(Gcoeffs*vec2(mucomp,mucomp2),vec2(1.0,mucomp2));return (1.0+sigma*GoverPi)/(1.0+constant1_FON*sigma);}
vec3 diffuseBRDF_EON(vec3 albedo,float roughness,float NdotL,float NdotV,float LdotV)
{vec3 rho=albedo;float sigma=roughness; 
float mu_i=NdotL; 
float mu_o=NdotV; 
float s=LdotV-mu_i*mu_o; 
float sovertF=s>0.0 ? s/max(mu_i,mu_o) : s; 
float AF=1.0/(1.0+constant1_FON*sigma); 
vec3 f_ss=(rho*RECIPROCAL_PI)*AF*(1.0+sigma*sovertF); 
float EFo=E_FON_approx(mu_o,sigma); 
float EFi=E_FON_approx(mu_i,sigma); 
float avgEF=AF*(1.0+constant2_FON*sigma); 
vec3 rho_ms=(rho*rho)*avgEF/(vec3(1.0)-rho*(1.0-avgEF));const float eps=1.0e-7;vec3 f_ms=(rho_ms*RECIPROCAL_PI)*max(eps,1.0-EFo) 
* max(eps,1.0-EFi)
/ max(eps,1.0-avgEF);return (f_ss+f_ms);}
#ifdef SS_TRANSLUCENCY
vec3 transmittanceBRDF_Burley(const vec3 tintColor,const vec3 diffusionDistance,float thickness) {vec3 S=1./maxEps(diffusionDistance);vec3 temp=exp((-0.333333333*thickness)*S);return tintColor.rgb*0.25*(temp*temp*temp+3.0*temp);}
float computeWrappedDiffuseNdotL(float NdotL,float w) {float t=1.0+w;float invt2=1.0/square(t);return saturate((NdotL+w)*invt2);}
#endif
#endif 
`;g.IncludesShadersStore[D3]||(g.IncludesShadersStore[D3]=k$)});var O3,W$,SI=S(()=>{O();O3="prePassVertexDeclaration",W$=`#ifdef PREPASS
#ifdef PREPASS_LOCAL_POSITION
varying vec3 vPosition;
#endif
#ifdef PREPASS_DEPTH
varying vec3 vViewPos;
#endif
#ifdef PREPASS_NORMALIZED_VIEW_DEPTH
varying float vNormViewDepth;
#endif
#if defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)
uniform mat4 previousViewProjection;varying vec4 vCurrentPosition;varying vec4 vPreviousPosition;
#endif
#endif
`;g.IncludesShadersStore[O3]||(g.IncludesShadersStore[O3]=W$)});var L3,H$,EI=S(()=>{O();L3="samplerVertexDeclaration",H$=`#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0
varying vec2 v_VARYINGNAME_UV;
#endif
`;g.IncludesShadersStore[L3]||(g.IncludesShadersStore[L3]=H$)});var w3,z$,TI=S(()=>{O();w3="harmonicsFunctions",z$=`#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
vec3 computeEnvironmentIrradiance(vec3 normal) {return vSphericalL00
+ vSphericalL1_1*(normal.y)
+ vSphericalL10*(normal.z)
+ vSphericalL11*(normal.x)
+ vSphericalL2_2*(normal.y*normal.x)
+ vSphericalL2_1*(normal.y*normal.z)
+ vSphericalL20*((3.0*normal.z*normal.z)-1.0)
+ vSphericalL21*(normal.z*normal.x)
+ vSphericalL22*(normal.x*normal.x-(normal.y*normal.y));}
#else
vec3 computeEnvironmentIrradiance(vec3 normal) {float Nx=normal.x;float Ny=normal.y;float Nz=normal.z;vec3 C1=vSphericalZZ.rgb;vec3 Cx=vSphericalX.rgb;vec3 Cy=vSphericalY.rgb;vec3 Cz=vSphericalZ.rgb;vec3 Cxx_zz=vSphericalXX_ZZ.rgb;vec3 Cyy_zz=vSphericalYY_ZZ.rgb;vec3 Cxy=vSphericalXY.rgb;vec3 Cyz=vSphericalYZ.rgb;vec3 Czx=vSphericalZX.rgb;vec3 a1=Cyy_zz*Ny+Cy;vec3 a2=Cyz*Nz+a1;vec3 b1=Czx*Nz+Cx;vec3 b2=Cxy*Ny+b1;vec3 b3=Cxx_zz*Nx+b2;vec3 t1=Cz *Nz+C1;vec3 t2=a2 *Ny+t1;vec3 t3=b3 *Nx+t2;return t3;}
#endif
#endif
`;g.IncludesShadersStore[w3]||(g.IncludesShadersStore[w3]=z$)});var F3,X$,xI=S(()=>{O();F3="bumpVertexDeclaration",X$=`#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL) 
varying mat3 vTBN;
#endif
#endif
`;g.IncludesShadersStore[F3]||(g.IncludesShadersStore[F3]=X$)});var N3,Y$,AI=S(()=>{O();N3="prePassVertex",Y$=`#ifdef PREPASS_DEPTH
vViewPos=(view*worldPos).rgb;
#endif
#ifdef PREPASS_NORMALIZED_VIEW_DEPTH
vNormViewDepth=((view*worldPos).z-cameraInfo.x)/(cameraInfo.y-cameraInfo.x);
#endif
#ifdef PREPASS_LOCAL_POSITION
vPosition=positionUpdated.xyz;
#endif
#if (defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*worldPos;
#if NUM_BONE_INFLUENCERS>0
mat4 previousInfluence;previousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
previousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];
#endif 
#if NUM_BONE_INFLUENCERS>2
previousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];
#endif 
#if NUM_BONE_INFLUENCERS>3
previousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif 
#if NUM_BONE_INFLUENCERS>5
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif 
#if NUM_BONE_INFLUENCERS>6
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif 
#if NUM_BONE_INFLUENCERS>7
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif
vPreviousPosition=previousViewProjection*finalPreviousWorld*previousInfluence*vec4(positionUpdated,1.0);
#else
vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#endif
`;g.IncludesShadersStore[N3]||(g.IncludesShadersStore[N3]=Y$)});var B3,K$,RI=S(()=>{O();B3="uvVariableDeclaration",K$=`#if !defined(UV{X}) && defined(MAINUV{X})
vec2 uv{X}=vec2(0.,0.);
#endif
#ifdef MAINUV{X}
vMainUV{X}=uv{X};
#endif
`;g.IncludesShadersStore[B3]||(g.IncludesShadersStore[B3]=K$)});var U3,q$,bI=S(()=>{O();U3="samplerVertexImplementation",q$=`#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0
if (v_INFONAME_==0.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uvUpdated,1.0,0.0));}
#ifdef UV2
else if (v_INFONAME_==1.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv2Updated,1.0,0.0));}
#endif
#ifdef UV3
else if (v_INFONAME_==2.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv3,1.0,0.0));}
#endif
#ifdef UV4
else if (v_INFONAME_==3.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv4,1.0,0.0));}
#endif
#ifdef UV5
else if (v_INFONAME_==4.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv5,1.0,0.0));}
#endif
#ifdef UV6
else if (v_INFONAME_==5.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv6,1.0,0.0));}
#endif
#endif
`;g.IncludesShadersStore[U3]||(g.IncludesShadersStore[U3]=q$)});var G3,Q$,H_=S(()=>{O();G3="bumpVertex",Q$=`#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
vec3 tbnNormal=normalize(normalUpdated);vec3 tbnTangent=normalize(tangentUpdated.xyz);vec3 tbnBitangent=cross(tbnNormal,tbnTangent)*tangentUpdated.w;vTBN=mat3(finalWorld)*mat3(tbnTangent,tbnBitangent,tbnNormal);
#endif
#endif
`;g.IncludesShadersStore[G3]||(g.IncludesShadersStore[G3]=Q$)});var V3,j$,CI=S(()=>{O();V3="vertexColorMixing",j$=`#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
vColor=vec4(1.0);
#ifdef VERTEXCOLOR
#ifdef VERTEXALPHA
vColor*=colorUpdated;
#else
vColor.rgb*=colorUpdated.rgb;
#endif
#endif
#ifdef INSTANCESCOLOR
vColor*=instanceColor;
#endif
#endif
`;g.IncludesShadersStore[V3]||(g.IncludesShadersStore[V3]=j$)});var W3={};V(W3,{pbrVertexShader:()=>Z$});var II,k3,Z$,H3=S(()=>{O();I3();gI();vI();Cu();Di();Df();La();wa();ko();SI();EI();TI();xI();Fa();gu();b_();C_();Bo();Uo();Xa();Go();Vo();Na();Ba();Ua();AI();RI();bI();H_();Ga();vu();I_();CI();Su();II="pbrVertexShader",k3=`#define PBR_VERTEX_SHADER
#define CUSTOM_VERTEX_EXTENSION
precision highp float;
#include<__decl__pbrVertex>
#define CUSTOM_VERTEX_BEGIN
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#ifdef TANGENT
attribute vec4 tangent;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#include<uvAttributeDeclaration>[2..7]
#include<mainUVVaryingDeclaration>[1..7]
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<helperFunctions>
#include<pbrBRDFFunctions>
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<prePassVertexDeclaration>
#include<samplerVertexDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo)
#include<samplerVertexDeclaration>(_DEFINENAME_,BASE_WEIGHT,_VARYINGNAME_,BaseWeight)
#include<samplerVertexDeclaration>(_DEFINENAME_,BASE_DIFFUSE_ROUGHNESS,_VARYINGNAME_,BaseDiffuseRoughness)
#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)
#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)
#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)
#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)
#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)
#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity)
#include<samplerVertexDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler)
#include<samplerVertexDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance)
#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance)
#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)
#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)
#ifdef CLEARCOAT
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint)
#endif
#ifdef IRIDESCENCE
#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence)
#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness)
#endif
#ifdef SHEEN
#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen)
#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)
#endif
#ifdef ANISOTROPIC
#include<samplerVertexDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy)
#endif
#ifdef SUBSURFACE
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor)
#endif
varying vec3 vPositionW;
#if DEBUGMODE>0
varying vec4 vClipSpacePosition;
#endif
#ifdef NORMAL
varying vec3 vNormalW;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vec3 vEnvironmentIrradiance;
#include<harmonicsFunctions>
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#include<bumpVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0
varying float vViewDepth;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 positionUpdated=position;
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#ifdef TANGENT
vec4 tangentUpdated=tangent;
#endif
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#ifdef UV2
vec2 uv2Updated=uv2;
#endif
#ifdef VERTEXCOLOR
vec4 colorUpdated=color;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && ((defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);vPositionW=vec3(worldPos);
#ifdef PREPASS
#include<prePassVertex>
#endif
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vNormalW=normalize(normalWorld*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normalUpdated);
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
#if BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LAMBERT && BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LEGACY
vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);float NdotV=max(dot(vNormalW,viewDirectionW),0.0);vec3 roughNormal=mix(vNormalW,viewDirectionW,(0.5*(1.0-NdotV))*baseDiffuseRoughness);vec3 reflectionVector=vec3(reflectionMatrix*vec4(roughNormal,0)).xyz;
#else
vec3 reflectionVector=vec3(reflectionMatrix*vec4(vNormalW,0)).xyz;
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
vEnvironmentIrradiance=computeEnvironmentIrradiance(reflectionVector);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}
#else
gl_Position=viewProjection*worldPos;
#endif
#if DEBUGMODE>0
vClipSpacePosition=gl_Position;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));
#endif
#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0
vViewDepth=(view*worldPos).z;
#endif
#ifndef UV1
vec2 uvUpdated=vec2(0.,0.);
#endif
#ifndef UV2
vec2 uv2Updated=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uvUpdated;
#endif
#ifdef MAINUV2
vMainUV2=uv2Updated;
#endif
#include<uvVariableDeclaration>[3..7]
#include<samplerVertexImplementation>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_MATRIXNAME_,albedo,_INFONAME_,AlbedoInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,BASE_WEIGHT,_VARYINGNAME_,BaseWeight,_MATRIXNAME_,baseWeight,_INFONAME_,BaseWeightInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,BASE_DIFFUSE_ROUGHNESS,_VARYINGNAME_,BaseDiffuseRoughness,_MATRIXNAME_,baseDiffuseRoughness,_INFONAME_,BaseDiffuseRoughnessInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_MATRIXNAME_,reflectivity,_INFONAME_,ReflectivityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_MATRIXNAME_,microSurfaceSampler,_INFONAME_,MicroSurfaceSamplerInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_MATRIXNAME_,metallicReflectance,_INFONAME_,MetallicReflectanceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_MATRIXNAME_,reflectance,_INFONAME_,ReflectanceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)
#ifdef CLEARCOAT
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_MATRIXNAME_,clearCoat,_INFONAME_,ClearCoatInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness,_MATRIXNAME_,clearCoatRoughness,_INFONAME_,ClearCoatInfos.z)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_MATRIXNAME_,clearCoatBump,_INFONAME_,ClearCoatBumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_MATRIXNAME_,clearCoatTint,_INFONAME_,ClearCoatTintInfos.x)
#endif
#ifdef IRIDESCENCE
#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_MATRIXNAME_,iridescence,_INFONAME_,IridescenceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_MATRIXNAME_,iridescenceThickness,_INFONAME_,IridescenceInfos.z)
#endif
#ifdef SHEEN
#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness,_MATRIXNAME_,sheenRoughness,_INFONAME_,SheenInfos.z)
#endif
#ifdef ANISOTROPIC
#include<samplerVertexImplementation>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_MATRIXNAME_,anisotropy,_INFONAME_,AnisotropyInfos.x)
#endif
#ifdef SUBSURFACE
#include<samplerVertexImplementation>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_MATRIXNAME_,thickness,_INFONAME_,ThicknessInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_MATRIXNAME_,refractionIntensity,_INFONAME_,RefractionIntensityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_MATRIXNAME_,translucencyIntensity,_INFONAME_,TranslucencyIntensityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_MATRIXNAME_,translucencyColor,_INFONAME_,TranslucencyColorInfos.x)
#endif
#include<bumpVertex>
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#include<vertexColorMixing>
#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}
`;g.ShadersStore[II]||(g.ShadersStore[II]=k3);Z$={name:II,shader:k3}});var z3,J$,yI=S(()=>{O();z3="prePassDeclaration",J$=`#ifdef PREPASS
#extension GL_EXT_draw_buffers : require
layout(location=0) out highp vec4 glFragData[{X}];highp vec4 gl_FragColor;
#ifdef PREPASS_LOCAL_POSITION
varying highp vec3 vPosition;
#endif
#ifdef PREPASS_DEPTH
varying highp vec3 vViewPos;
#endif
#ifdef PREPASS_NORMALIZED_VIEW_DEPTH
varying highp float vNormViewDepth;
#endif
#if defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)
varying highp vec4 vCurrentPosition;varying highp vec4 vPreviousPosition;
#endif
#endif
`;g.IncludesShadersStore[z3]||(g.IncludesShadersStore[z3]=J$)});var X3,$$,MI=S(()=>{O();X3="oitDeclaration",$$=`#ifdef ORDER_INDEPENDENT_TRANSPARENCY
#extension GL_EXT_draw_buffers : require
layout(location=0) out vec2 depth; 
layout(location=1) out vec4 frontColor;layout(location=2) out vec4 backColor;
#define MAX_DEPTH 99999.0
highp vec4 gl_FragColor;uniform sampler2D oitDepthSampler;uniform sampler2D oitFrontColorSampler;
#endif
`;g.IncludesShadersStore[X3]||(g.IncludesShadersStore[X3]=$$)});var Y3,eee,PI=S(()=>{O();Y3="decalFragmentDeclaration",eee=`#ifdef DECAL
uniform vec4 vDecalInfos;
#endif
`;g.IncludesShadersStore[Y3]||(g.IncludesShadersStore[Y3]=eee)});var K3,tee,q3=S(()=>{O();PI();K3="pbrFragmentDeclaration",tee=`uniform vec4 vEyePosition;uniform vec3 vReflectionColor;uniform vec4 vAlbedoColor;uniform float baseWeight;uniform float baseDiffuseRoughness;uniform vec4 vLightingIntensity;uniform vec4 vReflectivityColor;uniform vec4 vMetallicReflectanceFactors;uniform vec3 vEmissiveColor;uniform float visibility;uniform vec3 vAmbientColor;
#ifdef ALBEDO
uniform vec2 vAlbedoInfos;
#endif
#ifdef BASE_WEIGHT
uniform vec2 vBaseWeightInfos;
#endif
#ifdef BASE_DIFFUSE_ROUGHNESS
uniform vec2 vBaseDiffuseRoughnessInfos;
#endif
#ifdef AMBIENT
uniform vec4 vAmbientInfos;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;uniform vec2 vTangentSpaceParams;
#endif
#ifdef OPACITY
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
#endif
#ifdef REFLECTIVITY
uniform vec3 vReflectivityInfos;
#endif
#ifdef MICROSURFACEMAP
uniform vec2 vMicroSurfaceSamplerInfos;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(SS_REFRACTION) || defined(PREPASS)
uniform mat4 view;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
#ifdef REALTIME_FILTERING
uniform vec2 vReflectionFilteringInfo;
#endif
uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;
#if defined(USEIRRADIANCEMAP) && defined(USE_IRRADIANCE_DOMINANT_DIRECTION)
uniform vec3 vReflectionDominantDirection;
#endif
#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)
uniform vec3 vReflectionPosition;uniform vec3 vReflectionSize;
#endif
#endif
#if defined(SS_REFRACTION) && defined(SS_USE_LOCAL_REFRACTIONMAP_CUBIC)
uniform vec3 vRefractionPosition;uniform vec3 vRefractionSize;
#endif
#ifdef CLEARCOAT
uniform vec2 vClearCoatParams;uniform vec4 vClearCoatRefractionParams;
#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)
uniform vec4 vClearCoatInfos;
#endif
#ifdef CLEARCOAT_TEXTURE
uniform mat4 clearCoatMatrix;
#endif
#ifdef CLEARCOAT_TEXTURE_ROUGHNESS
uniform mat4 clearCoatRoughnessMatrix;
#endif
#ifdef CLEARCOAT_BUMP
uniform vec2 vClearCoatBumpInfos;uniform vec2 vClearCoatTangentSpaceParams;uniform mat4 clearCoatBumpMatrix;
#endif
#ifdef CLEARCOAT_TINT
uniform vec4 vClearCoatTintParams;uniform float clearCoatColorAtDistance;
#ifdef CLEARCOAT_TINT_TEXTURE
uniform vec2 vClearCoatTintInfos;uniform mat4 clearCoatTintMatrix;
#endif
#endif
#endif
#ifdef IRIDESCENCE
uniform vec4 vIridescenceParams;
#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)
uniform vec4 vIridescenceInfos;
#endif
#ifdef IRIDESCENCE_TEXTURE
uniform mat4 iridescenceMatrix;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
uniform mat4 iridescenceThicknessMatrix;
#endif
#endif
#ifdef ANISOTROPIC
uniform vec3 vAnisotropy;
#ifdef ANISOTROPIC_TEXTURE
uniform vec2 vAnisotropyInfos;uniform mat4 anisotropyMatrix;
#endif
#endif
#ifdef SHEEN
uniform vec4 vSheenColor;
#ifdef SHEEN_ROUGHNESS
uniform float vSheenRoughness;
#endif
#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)
uniform vec4 vSheenInfos;
#endif
#ifdef SHEEN_TEXTURE
uniform mat4 sheenMatrix;
#endif
#ifdef SHEEN_TEXTURE_ROUGHNESS
uniform mat4 sheenRoughnessMatrix;
#endif
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
uniform vec4 vRefractionMicrosurfaceInfos;uniform vec4 vRefractionInfos;uniform mat4 refractionMatrix;
#ifdef REALTIME_FILTERING
uniform vec2 vRefractionFilteringInfo;
#endif
#ifdef SS_DISPERSION
uniform float dispersion;
#endif
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
uniform vec2 vThicknessInfos;uniform mat4 thicknessMatrix;
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
uniform vec2 vRefractionIntensityInfos;uniform mat4 refractionIntensityMatrix;
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
uniform vec2 vTranslucencyIntensityInfos;uniform mat4 translucencyIntensityMatrix;
#endif
uniform vec2 vThicknessParam;uniform vec3 vDiffusionDistance;uniform vec4 vTintColor;uniform vec3 vSubSurfaceIntensity;uniform vec4 vTranslucencyColor;
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
uniform vec2 vTranslucencyColorInfos;uniform mat4 translucencyColorMatrix;
#endif
#endif
#ifdef PREPASS
#ifdef SS_SCATTERING
uniform float scatteringDiffusionProfile;
#endif
#endif
#if DEBUGMODE>0
uniform vec2 vDebugMode;
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
#endif
#include<decalFragmentDeclaration>
#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
uniform vec3 vSphericalL00;uniform vec3 vSphericalL1_1;uniform vec3 vSphericalL10;uniform vec3 vSphericalL11;uniform vec3 vSphericalL2_2;uniform vec3 vSphericalL2_1;uniform vec3 vSphericalL20;uniform vec3 vSphericalL21;uniform vec3 vSphericalL22;
#else
uniform vec3 vSphericalX;uniform vec3 vSphericalY;uniform vec3 vSphericalZ;uniform vec3 vSphericalXX_ZZ;uniform vec3 vSphericalYY_ZZ;uniform vec3 vSphericalZZ;uniform vec3 vSphericalXY;uniform vec3 vSphericalYZ;uniform vec3 vSphericalZX;
#endif
#endif
#define ADDITIONAL_FRAGMENT_DECLARATION
`;g.IncludesShadersStore[K3]||(g.IncludesShadersStore[K3]=tee)});var Q3,iee,j3=S(()=>{O();Cu();Q3="pbrFragmentExtraDeclaration",iee=`varying vec3 vPositionW;
#if DEBUGMODE>0
varying vec4 vClipSpacePosition;
#endif
#include<mainUVVaryingDeclaration>[1..7]
#ifdef NORMAL
varying vec3 vNormalW;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vec3 vEnvironmentIrradiance;
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0
varying float vViewDepth;
#endif
`;g.IncludesShadersStore[Q3]||(g.IncludesShadersStore[Q3]=iee)});var Z3,ree,z_=S(()=>{O();Z3="samplerFragmentDeclaration",ree=`#ifdef _DEFINENAME_
#if _DEFINENAME_DIRECTUV==1
#define v_VARYINGNAME_UV vMainUV1
#elif _DEFINENAME_DIRECTUV==2
#define v_VARYINGNAME_UV vMainUV2
#elif _DEFINENAME_DIRECTUV==3
#define v_VARYINGNAME_UV vMainUV3
#elif _DEFINENAME_DIRECTUV==4
#define v_VARYINGNAME_UV vMainUV4
#elif _DEFINENAME_DIRECTUV==5
#define v_VARYINGNAME_UV vMainUV5
#elif _DEFINENAME_DIRECTUV==6
#define v_VARYINGNAME_UV vMainUV6
#else
varying vec2 v_VARYINGNAME_UV;
#endif
uniform sampler2D _SAMPLERNAME_Sampler;
#endif
`;g.IncludesShadersStore[Z3]||(g.IncludesShadersStore[Z3]=ree)});var J3,see,$3=S(()=>{O();J3="samplerFragmentAlternateDeclaration",see=`#ifdef _DEFINENAME_
#if _DEFINENAME_DIRECTUV==1
#define v_VARYINGNAME_UV vMainUV1
#elif _DEFINENAME_DIRECTUV==2
#define v_VARYINGNAME_UV vMainUV2
#elif _DEFINENAME_DIRECTUV==3
#define v_VARYINGNAME_UV vMainUV3
#elif _DEFINENAME_DIRECTUV==4
#define v_VARYINGNAME_UV vMainUV4
#elif _DEFINENAME_DIRECTUV==5
#define v_VARYINGNAME_UV vMainUV5
#elif _DEFINENAME_DIRECTUV==6
#define v_VARYINGNAME_UV vMainUV6
#else
varying vec2 v_VARYINGNAME_UV;
#endif
#endif
`;g.IncludesShadersStore[J3]||(g.IncludesShadersStore[J3]=see)});var eG,nee,tG=S(()=>{O();z_();$3();eG="pbrFragmentSamplersDeclaration",nee=`#include<samplerFragmentDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_SAMPLERNAME_,albedo)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_WEIGHT,_VARYINGNAME_,BaseWeight,_SAMPLERNAME_,baseWeight)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BASE_DIFFUSE_ROUGHNESS,_VARYINGNAME_,BaseDiffuseRoughness,_SAMPLERNAME_,baseDiffuseRoughness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)
#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)
#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)
#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_SAMPLERNAME_,reflectivity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_SAMPLERNAME_,microSurface)
#include<samplerFragmentDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_SAMPLERNAME_,metallicReflectance)
#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_SAMPLERNAME_,reflectance)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)
#ifdef CLEARCOAT
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_SAMPLERNAME_,clearCoat)
#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS)
uniform sampler2D clearCoatRoughnessSampler;
#endif
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_SAMPLERNAME_,clearCoatBump)
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_SAMPLERNAME_,clearCoatTint)
#endif
#ifdef IRIDESCENCE
#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_SAMPLERNAME_,iridescence)
#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_SAMPLERNAME_,iridescenceThickness)
#endif
#ifdef SHEEN
#include<samplerFragmentDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_SAMPLERNAME_,sheen)
#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS)
uniform sampler2D sheenRoughnessSampler;
#endif
#endif
#ifdef ANISOTROPIC
#include<samplerFragmentDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_SAMPLERNAME_,anisotropy)
#endif
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
#define sampleReflection(s,c) textureCube(s,c)
uniform samplerCube reflectionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;
#endif
#ifdef USEIRRADIANCEMAP
uniform samplerCube irradianceSampler;
#endif
#else
#define sampleReflection(s,c) texture2D(s,c)
uniform sampler2D reflectionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform sampler2D reflectionSamplerLow;uniform sampler2D reflectionSamplerHigh;
#endif
#ifdef USEIRRADIANCEMAP
uniform sampler2D irradianceSampler;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#endif
#ifdef ENVIRONMENTBRDF
uniform sampler2D environmentBrdfSampler;
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
#ifdef SS_REFRACTIONMAP_3D
#define sampleRefraction(s,c) textureCube(s,c)
uniform samplerCube refractionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleRefractionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube refractionSamplerLow;uniform samplerCube refractionSamplerHigh;
#endif
#else
#define sampleRefraction(s,c) texture2D(s,c)
uniform sampler2D refractionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleRefractionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform sampler2D refractionSamplerLow;uniform sampler2D refractionSamplerHigh;
#endif
#endif
#endif
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_SAMPLERNAME_,thickness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_SAMPLERNAME_,refractionIntensity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_SAMPLERNAME_,translucencyIntensity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_SAMPLERNAME_,translucencyColor)
#endif
#ifdef IBL_CDF_FILTERING
uniform sampler2D icdfSampler;
#endif
`;g.IncludesShadersStore[eG]||(g.IncludesShadersStore[eG]=nee)});var iG,aee,rG=S(()=>{O();iG="subSurfaceScatteringFunctions",aee=`bool testLightingForSSS(float diffusionProfile)
{return diffusionProfile<1.;}`;g.IncludesShadersStore[iG]||(g.IncludesShadersStore[iG]=aee)});var sG,oee,Iu=S(()=>{O();sG="importanceSampling",oee=`vec3 hemisphereCosSample(vec2 u) {float phi=2.*PI*u.x;float cosTheta2=1.-u.y;float cosTheta=sqrt(cosTheta2);float sinTheta=sqrt(1.-cosTheta2);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}
vec3 hemisphereImportanceSampleDggx(vec2 u,float a) {float phi=2.*PI*u.x;float cosTheta2=(1.-u.y)/(1.+(a+1.)*((a-1.)*u.y));float cosTheta=sqrt(cosTheta2);float sinTheta=sqrt(1.-cosTheta2);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}
vec3 hemisphereImportanceSampleDCharlie(vec2 u,float a) { 
float phi=2.*PI*u.x;float sinTheta=pow(u.y,a/(2.*a+1.));float cosTheta=sqrt(1.-sinTheta*sinTheta);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}`;g.IncludesShadersStore[sG]||(g.IncludesShadersStore[sG]=oee)});var nG,lee,aG=S(()=>{O();nG="pbrHelperFunctions",lee=`#define MINIMUMVARIANCE 0.0005
float convertRoughnessToAverageSlope(float roughness)
{return square(roughness)+MINIMUMVARIANCE;}
float fresnelGrazingReflectance(float reflectance0) {float reflectance90=saturate(reflectance0*25.0);return reflectance90;}
vec2 getAARoughnessFactors(vec3 normalVector) {
#ifdef SPECULARAA
vec3 nDfdx=dFdx(normalVector.xyz);vec3 nDfdy=dFdy(normalVector.xyz);float slopeSquare=max(dot(nDfdx,nDfdx),dot(nDfdy,nDfdy));float geometricRoughnessFactor=pow(saturate(slopeSquare),0.333);float geometricAlphaGFactor=sqrt(slopeSquare);geometricAlphaGFactor*=0.75;return vec2(geometricRoughnessFactor,geometricAlphaGFactor);
#else
return vec2(0.);
#endif
}
#ifdef ANISOTROPIC
#ifdef ANISOTROPIC_LEGACY
vec2 getAnisotropicRoughness(float alphaG,float anisotropy) {float alphaT=max(alphaG*(1.0+anisotropy),MINIMUMVARIANCE);float alphaB=max(alphaG*(1.0-anisotropy),MINIMUMVARIANCE);return vec2(alphaT,alphaB);}
vec3 getAnisotropicBentNormals(const vec3 T,const vec3 B,const vec3 N,const vec3 V,float anisotropy,float roughness) {vec3 anisotropicFrameDirection;if (anisotropy>=0.0) {anisotropicFrameDirection=B;} else {anisotropicFrameDirection=T;}
vec3 anisotropicFrameTangent=cross(normalize(anisotropicFrameDirection),V);vec3 anisotropicFrameNormal=cross(anisotropicFrameTangent,anisotropicFrameDirection);vec3 anisotropicNormal=normalize(mix(N,anisotropicFrameNormal,abs(anisotropy)));return anisotropicNormal;}
#else
vec2 getAnisotropicRoughness(float alphaG,float anisotropy) {float alphaT=max(mix(alphaG,1.0,anisotropy*anisotropy),MINIMUMVARIANCE);float alphaB=max(alphaG,MINIMUMVARIANCE);return vec2(alphaT,alphaB);}
vec3 getAnisotropicBentNormals(const vec3 T,const vec3 B,const vec3 N,const vec3 V,float anisotropy,float roughness) {vec3 bentNormal=cross(B,V);bentNormal=normalize(cross(bentNormal,B));float a=square(square(1.0-anisotropy*(1.0-roughness)));bentNormal=normalize(mix(bentNormal,N,a));return bentNormal;}
#endif
#endif
#if defined(CLEARCOAT) || defined(SS_REFRACTION)
vec3 cocaLambert(vec3 alpha,float distance) {return exp(-alpha*distance);}
vec3 cocaLambert(float NdotVRefract,float NdotLRefract,vec3 alpha,float thickness) {return cocaLambert(alpha,(thickness*((NdotLRefract+NdotVRefract)/(NdotLRefract*NdotVRefract))));}
vec3 computeColorAtDistanceInMedia(vec3 color,float distance) {return -log(color)/distance;}
vec3 computeClearCoatAbsorption(float NdotVRefract,float NdotLRefract,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {vec3 clearCoatAbsorption=mix(vec3(1.0),
cocaLambert(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness),
clearCoatIntensity);return clearCoatAbsorption;}
#endif
#ifdef MICROSURFACEAUTOMATIC
float computeDefaultMicroSurface(float microSurface,vec3 reflectivityColor)
{const float kReflectivityNoAlphaWorkflow_SmoothnessMax=0.95;float reflectivityLuminance=getLuminance(reflectivityColor);float reflectivityLuma=sqrt(reflectivityLuminance);microSurface=reflectivityLuma*kReflectivityNoAlphaWorkflow_SmoothnessMax;return microSurface;}
#endif
`;g.IncludesShadersStore[nG]||(g.IncludesShadersStore[nG]=lee)});var oG,cee,lG=S(()=>{O();UC();oG="pbrDirectLightingSetupFunctions",cee=`struct preLightingInfo
{vec3 lightOffset;float lightDistanceSquared;float lightDistance;float attenuation;vec3 L;vec3 H;float NdotV;float NdotLUnclamped;float NdotL;float VdotH;float LdotV;float roughness;float diffuseRoughness;vec3 surfaceAlbedo;
#ifdef IRIDESCENCE
float iridescenceIntensity;
#endif
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
vec3 areaLightDiffuse;
#ifdef SPECULARTERM
vec3 areaLightSpecular;vec4 areaLightFresnel;
#endif
#endif
};preLightingInfo computePointAndSpotPreLightingInfo(vec4 lightData,vec3 V,vec3 N,vec3 posW) {preLightingInfo result;result.lightOffset=lightData.xyz-posW;result.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);result.lightDistance=sqrt(result.lightDistanceSquared);result.L=normalize(result.lightOffset);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);result.LdotV=0.;result.roughness=0.;result.diffuseRoughness=0.;result.surfaceAlbedo=vec3(0.);return result;}
preLightingInfo computeDirectionalPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {preLightingInfo result;result.lightDistance=length(-lightData.xyz);result.L=normalize(-lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);result.LdotV=dot(result.L,V);result.roughness=0.;result.diffuseRoughness=0.;result.surfaceAlbedo=vec3(0.);return result;}
preLightingInfo computeHemisphericPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {preLightingInfo result;result.NdotL=dot(N,lightData.xyz)*0.5+0.5;result.NdotL=saturateEps(result.NdotL);result.NdotLUnclamped=result.NdotL;
#ifdef SPECULARTERM
result.L=normalize(lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));
#endif
result.LdotV=0.;result.roughness=0.;result.diffuseRoughness=0.;result.surfaceAlbedo=vec3(0.);return result;}
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
#include<ltcHelperFunctions>
uniform sampler2D areaLightsLTC1Sampler;uniform sampler2D areaLightsLTC2Sampler;preLightingInfo computeAreaPreLightingInfo(sampler2D ltc1,sampler2D ltc2,vec3 viewDirectionW,vec3 vNormal,vec3 vPosition,vec4 lightData,vec3 halfWidth,vec3 halfHeight,float roughness )
{preLightingInfo result;result.lightOffset=lightData.xyz-vPosition;result.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);result.lightDistance=sqrt(result.lightDistanceSquared);areaLightData data=computeAreaLightSpecularDiffuseFresnel(ltc1,ltc2,viewDirectionW,vNormal,vPosition,lightData.xyz,halfWidth,halfHeight,roughness);
#ifdef SPECULARTERM
result.areaLightFresnel=data.Fresnel;result.areaLightSpecular=data.Specular;
#endif
result.areaLightDiffuse=data.Diffuse;result.LdotV=0.;result.roughness=0.;result.diffuseRoughness=0.;result.surfaceAlbedo=vec3(0.);return result;}
#endif
`;g.IncludesShadersStore[oG]||(g.IncludesShadersStore[oG]=cee)});var cG,fee,fG=S(()=>{O();cG="pbrDirectLightingFalloffFunctions",fee=`float computeDistanceLightFalloff_Standard(vec3 lightOffset,float range)
{return max(0.,1.0-length(lightOffset)/range);}
float computeDistanceLightFalloff_Physical(float lightDistanceSquared)
{return 1.0/maxEps(lightDistanceSquared);}
float computeDistanceLightFalloff_GLTF(float lightDistanceSquared,float inverseSquaredRange)
{float lightDistanceFalloff=1.0/maxEps(lightDistanceSquared);float factor=lightDistanceSquared*inverseSquaredRange;float attenuation=saturate(1.0-factor*factor);attenuation*=attenuation;lightDistanceFalloff*=attenuation;return lightDistanceFalloff;}
float computeDistanceLightFalloff(vec3 lightOffset,float lightDistanceSquared,float range,float inverseSquaredRange)
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDistanceLightFalloff_Physical(lightDistanceSquared);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDistanceLightFalloff_GLTF(lightDistanceSquared,inverseSquaredRange);
#else
return computeDistanceLightFalloff_Standard(lightOffset,range);
#endif
}
float computeDirectionalLightFalloff_Standard(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent)
{float falloff=0.0;float cosAngle=maxEps(dot(-lightDirection,directionToLightCenterW));if (cosAngle>=cosHalfAngle)
{falloff=max(0.,pow(cosAngle,exponent));}
return falloff;}
float computeDirectionalLightFalloff_IES(vec3 lightDirection,vec3 directionToLightCenterW,sampler2D iesLightSampler)
{float cosAngle=dot(-lightDirection,directionToLightCenterW);float angle=acos(cosAngle)/PI;return texture2D(iesLightSampler,vec2(angle,0.)).r;}
float computeDirectionalLightFalloff_Physical(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle)
{const float kMinusLog2ConeAngleIntensityRatio=6.64385618977; 
float concentrationKappa=kMinusLog2ConeAngleIntensityRatio/(1.0-cosHalfAngle);vec4 lightDirectionSpreadSG=vec4(-lightDirection*concentrationKappa,-concentrationKappa);float falloff=exp2(dot(vec4(directionToLightCenterW,1.0),lightDirectionSpreadSG));return falloff;}
float computeDirectionalLightFalloff_GLTF(vec3 lightDirection,vec3 directionToLightCenterW,float lightAngleScale,float lightAngleOffset)
{float cd=dot(-lightDirection,directionToLightCenterW);float falloff=saturate(cd*lightAngleScale+lightAngleOffset);falloff*=falloff;return falloff;}
float computeDirectionalLightFalloff(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent,float lightAngleScale,float lightAngleOffset)
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDirectionalLightFalloff_Physical(lightDirection,directionToLightCenterW,cosHalfAngle);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDirectionalLightFalloff_GLTF(lightDirection,directionToLightCenterW,lightAngleScale,lightAngleOffset);
#else
return computeDirectionalLightFalloff_Standard(lightDirection,directionToLightCenterW,cosHalfAngle,exponent);
#endif
}`;g.IncludesShadersStore[cG]||(g.IncludesShadersStore[cG]=fee)});var hG,hee,yu=S(()=>{O();hG="hdrFilteringFunctions",hee=`#if NUM_SAMPLES
#if NUM_SAMPLES>0
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
float radicalInverse_VdC(uint bits) 
{bits=(bits<<16u) | (bits>>16u);bits=((bits & 0x55555555u)<<1u) | ((bits & 0xAAAAAAAAu)>>1u);bits=((bits & 0x33333333u)<<2u) | ((bits & 0xCCCCCCCCu)>>2u);bits=((bits & 0x0F0F0F0Fu)<<4u) | ((bits & 0xF0F0F0F0u)>>4u);bits=((bits & 0x00FF00FFu)<<8u) | ((bits & 0xFF00FF00u)>>8u);return float(bits)*2.3283064365386963e-10; }
vec2 hammersley(uint i,uint N)
{return vec2(float(i)/float(N),radicalInverse_VdC(i));}
#else
float vanDerCorpus(int n,int base)
{float invBase=1.0/float(base);float denom =1.0;float result =0.0;for(int i=0; i<32; ++i)
{if(n>0)
{denom =mod(float(n),2.0);result+=denom*invBase;invBase=invBase/2.0;n =int(float(n)/2.0);}}
return result;}
vec2 hammersley(int i,int N)
{return vec2(float(i)/float(N),vanDerCorpus(i,2));}
#endif
float log4(float x) {return log2(x)/2.;}
vec3 uv_to_normal(vec2 uv) {vec3 N;vec2 uvRange=uv;float theta=uvRange.x*2.*PI;float phi=uvRange.y*PI;float sinPhi=sin(phi);N.x=cos(theta)*sinPhi;N.z=sin(theta)*sinPhi;N.y=cos(phi);return N;}
const float NUM_SAMPLES_FLOAT=float(NUM_SAMPLES);const float NUM_SAMPLES_FLOAT_INVERSED=1./NUM_SAMPLES_FLOAT;const float K=4.;
#define inline
vec3 irradiance(
#ifdef CUSTOM_IRRADIANCE_FILTERING_INPUT
CUSTOM_IRRADIANCE_FILTERING_INPUT
#else
samplerCube inputTexture,
#endif
vec3 inputN,vec2 filteringInfo,
float diffuseRoughness,
vec3 surfaceAlbedo,
vec3 inputV
#if IBL_CDF_FILTERING
,sampler2D icdfSampler
#endif
)
{vec3 n=normalize(inputN);vec3 result=vec3(0.);
#ifndef IBL_CDF_FILTERING
vec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);tangent=normalize(cross(tangent,n));vec3 bitangent=cross(n,tangent);mat3 tbn=mat3(tangent,bitangent,n);mat3 tbnInverse=mat3(tangent.x,bitangent.x,n.x,tangent.y,bitangent.y,n.y,tangent.z,bitangent.z,n.z);
#endif
float maxLevel=filteringInfo.y;float dim0=filteringInfo.x;float omegaP=(4.*PI)/(6.*dim0*dim0);vec3 clampedAlbedo=clamp(surfaceAlbedo,vec3(0.1),vec3(1.0));
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
for(uint i=0u; i<NUM_SAMPLES; ++i)
#else
for(int i=0; i<NUM_SAMPLES; ++i)
#endif
{vec2 Xi=hammersley(i,NUM_SAMPLES);
#if IBL_CDF_FILTERING
vec2 T;T.x=texture2D(icdfSampler,vec2(Xi.x,0.)).x;T.y=texture2D(icdfSampler,vec2(T.x,Xi.y)).y;vec3 Ls=uv_to_normal(vec2(1.0-fract(T.x+0.25),T.y));float NoL=dot(n,Ls);float NoV=dot(n,inputV);
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
float LoV=dot (Ls,inputV);
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
vec3 H=(inputV+Ls)*0.5;float VoH=dot(inputV,H);
#endif
#else
vec3 Ls=hemisphereCosSample(Xi);Ls=normalize(Ls);float NoL=Ls.z; 
vec3 V=tbnInverse*inputV;float NoV=V.z; 
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
float LoV=dot (Ls,V);
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
vec3 H=(V+Ls)*0.5;float VoH=dot(V,H);
#endif
#endif
if (NoL>0.) {
#if IBL_CDF_FILTERING
float pdf=texture2D(icdfSampler,T).z;vec3 c=textureCubeLodEXT(inputTexture,Ls,0.).rgb;
#else
float pdf_inversed=PI/NoL;float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;float l=log4(omegaS)-log4(omegaP)+log4(K);float mipLevel=clamp(l,0.,maxLevel);
#ifdef CUSTOM_IRRADIANCE_FILTERING_FUNCTION
CUSTOM_IRRADIANCE_FILTERING_FUNCTION
#else
vec3 c=textureCubeLodEXT(inputTexture,tbn*Ls,mipLevel).rgb;
#endif
#endif
#if GAMMA_INPUT
c=toLinearSpace(c);
#endif
vec3 diffuseRoughnessTerm=vec3(1.0);
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
diffuseRoughnessTerm=diffuseBRDF_EON(clampedAlbedo,diffuseRoughness,NoL,NoV,LoV)*PI;
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
diffuseRoughnessTerm=vec3(diffuseBRDF_Burley(NoL,NoV,VoH,diffuseRoughness)*PI);
#endif
#if IBL_CDF_FILTERING
vec3 light=pdf<1e-6 ? vec3(0.0) : vec3(1.0)/vec3(pdf)*c;result+=NoL*diffuseRoughnessTerm*light;
#else
result+=c*diffuseRoughnessTerm;
#endif
}}
result=result*NUM_SAMPLES_FLOAT_INVERSED;
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
result=result/clampedAlbedo;
#endif
return result;}
#define inline
vec3 radiance(float alphaG,samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)
{vec3 n=normalize(inputN);vec3 c=textureCube(inputTexture,n).rgb; 
if (alphaG==0.) {
#if GAMMA_INPUT
c=toLinearSpace(c);
#endif
return c;} else {vec3 result=vec3(0.);vec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);tangent=normalize(cross(tangent,n));vec3 bitangent=cross(n,tangent);mat3 tbn=mat3(tangent,bitangent,n);float maxLevel=filteringInfo.y;float dim0=filteringInfo.x;float omegaP=(4.*PI)/(6.*dim0*dim0);float weight=0.;
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
for(uint i=0u; i<NUM_SAMPLES; ++i)
#else
for(int i=0; i<NUM_SAMPLES; ++i)
#endif
{vec2 Xi=hammersley(i,NUM_SAMPLES);vec3 H=hemisphereImportanceSampleDggx(Xi,alphaG);float NoV=1.;float NoH=H.z;float NoH2=H.z*H.z;float NoL=2.*NoH2-1.;vec3 L=vec3(2.*NoH*H.x,2.*NoH*H.y,NoL);L=normalize(L);if (NoL>0.) {float pdf_inversed=4./normalDistributionFunction_TrowbridgeReitzGGX(NoH,alphaG);float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;float l=log4(omegaS)-log4(omegaP)+log4(K);float mipLevel=clamp(float(l),0.0,maxLevel);weight+=NoL;vec3 c=textureCubeLodEXT(inputTexture,tbn*L,mipLevel).rgb;
#if GAMMA_INPUT
c=toLinearSpace(c);
#endif
result+=c*NoL;}}
result=result/weight;return result;}}
#endif
#endif
`;g.IncludesShadersStore[hG]||(g.IncludesShadersStore[hG]=hee)});var uG,uee,dG=S(()=>{O();uG="pbrDirectLightingFunctions",uee=`#define CLEARCOATREFLECTANCE90 1.0
struct lightingInfo
{vec3 diffuse;
#ifdef SS_TRANSLUCENCY
vec3 diffuseTransmission;
#endif
#ifdef SPECULARTERM
vec3 specular;
#endif
#ifdef CLEARCOAT
vec4 clearCoat;
#endif
#ifdef SHEEN
vec3 sheen;
#endif
};float adjustRoughnessFromLightProperties(float roughness,float lightRadius,float lightDistance) {
#if defined(USEPHYSICALLIGHTFALLOFF) || defined(USEGLTFLIGHTFALLOFF)
float lightRoughness=lightRadius/lightDistance;float totalRoughness=saturate(lightRoughness+roughness);return totalRoughness;
#else
return roughness;
#endif
}
vec3 computeHemisphericDiffuseLighting(preLightingInfo info,vec3 lightColor,vec3 groundColor) {return mix(groundColor,lightColor,info.NdotL);}
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
vec3 computeAreaDiffuseLighting(preLightingInfo info,vec3 lightColor) {return info.areaLightDiffuse*lightColor;}
#endif
vec3 computeDiffuseLighting(preLightingInfo info,vec3 lightColor) {vec3 diffuseTerm=vec3(1.0/PI);
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_LEGACY
diffuseTerm=vec3(diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.roughness));
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
diffuseTerm=vec3(diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.diffuseRoughness));
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
vec3 clampedAlbedo=clamp(info.surfaceAlbedo,vec3(0.1),vec3(1.0));diffuseTerm=diffuseBRDF_EON(clampedAlbedo,info.diffuseRoughness,info.NdotL,info.NdotV,info.LdotV);diffuseTerm/=clampedAlbedo;
#endif
return diffuseTerm*info.attenuation*info.NdotL*lightColor;}
#define inline
vec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix,vec3 posW){vec4 strq=textureProjectionMatrix*vec4(posW,1.0);strq/=strq.w;vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;return toLinearSpace(textureColor);}
#ifdef SS_TRANSLUCENCY
vec3 computeDiffuseTransmittedLighting(preLightingInfo info,vec3 lightColor,vec3 transmittance) {vec3 transmittanceNdotL=vec3(0.);float NdotL=absEps(info.NdotLUnclamped);
#ifndef SS_TRANSLUCENCY_LEGACY
if (info.NdotLUnclamped<0.0) {
#endif
float wrapNdotL=computeWrappedDiffuseNdotL(NdotL,0.02);float trAdapt=step(0.,info.NdotLUnclamped);transmittanceNdotL=mix(transmittance*wrapNdotL,vec3(wrapNdotL),trAdapt);
#ifndef SS_TRANSLUCENCY_LEGACY
}
vec3 diffuseTerm=vec3(1.0/PI);
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_LEGACY
diffuseTerm=vec3(diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.roughness));
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
diffuseTerm=vec3(diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.diffuseRoughness));
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
vec3 clampedAlbedo=clamp(info.surfaceAlbedo,vec3(0.1),vec3(1.0));diffuseTerm=diffuseBRDF_EON(clampedAlbedo,info.diffuseRoughness,info.NdotL,info.NdotV,info.LdotV);diffuseTerm/=clampedAlbedo;
#endif
#else
float diffuseTerm=diffuseBRDF_Burley(NdotL,info.NdotV,info.VdotH,info.roughness);
#endif
return diffuseTerm*transmittanceNdotL*info.attenuation*lightColor;}
#endif
#ifdef SPECULARTERM
vec3 computeSpecularLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 fresnel,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float roughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(roughness);
#ifdef IRIDESCENCE
fresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);
#endif
float distribution=normalDistributionFunction_TrowbridgeReitzGGX(NdotH,alphaG);
#ifdef BRDF_V_HEIGHT_CORRELATED
float smithVisibility=smithVisibility_GGXCorrelated(info.NdotL,info.NdotV,alphaG);
#else
float smithVisibility=smithVisibility_TrowbridgeReitzGGXFast(info.NdotL,info.NdotV,alphaG);
#endif
vec3 specTerm=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}
#if defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED)
vec3 computeAreaSpecularLighting(preLightingInfo info,vec3 specularColor,vec3 reflectance0,vec3 reflectance90) {vec3 fresnel=specularColor*info.areaLightFresnel.x*reflectance0+( vec3( 1.0 )-specularColor )*info.areaLightFresnel.y*reflectance90;return specularColor*fresnel*info.areaLightSpecular;}
#endif
#endif
#ifdef ANISOTROPIC
vec3 computeAnisotropicSpecularLighting(preLightingInfo info,vec3 V,vec3 N,vec3 T,vec3 B,float anisotropy,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float TdotH=dot(T,info.H);float BdotH=dot(B,info.H);float TdotV=dot(T,V);float BdotV=dot(B,V);float TdotL=dot(T,info.L);float BdotL=dot(B,info.L);float alphaG=convertRoughnessToAverageSlope(info.roughness);vec2 alphaTB=getAnisotropicRoughness(alphaG,anisotropy);alphaTB=max(alphaTB,square(geometricRoughnessFactor));vec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);
#ifdef IRIDESCENCE
fresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);
#endif
float distribution=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);float smithVisibility=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);vec3 specTerm=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}
#endif
#ifdef CLEARCOAT
vec4 computeClearCoatLighting(preLightingInfo info,vec3 Ncc,float geometricRoughnessFactor,float clearCoatIntensity,vec3 lightColor) {float NccdotL=saturateEps(dot(Ncc,info.L));float NccdotH=saturateEps(dot(Ncc,info.H));float clearCoatRoughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(clearCoatRoughness);float fresnel=fresnelSchlickGGX(info.VdotH,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnel*=clearCoatIntensity;float distribution=normalDistributionFunction_TrowbridgeReitzGGX(NccdotH,alphaG);float kelemenVisibility=visibility_Kelemen(info.VdotH);float clearCoatTerm=fresnel*distribution*kelemenVisibility;return vec4(
clearCoatTerm*info.attenuation*NccdotL*lightColor,
1.0-fresnel
);}
vec3 computeClearCoatLightingAbsorption(float NdotVRefract,vec3 L,vec3 Ncc,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {vec3 LRefract=-refract(L,Ncc,vClearCoatRefractionParams.y);float NdotLRefract=saturateEps(dot(Ncc,LRefract));vec3 absorption=computeClearCoatAbsorption(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness,clearCoatIntensity);return absorption;}
#endif
#ifdef SHEEN
vec3 computeSheenLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float roughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(roughness);float fresnel=1.;float distribution=normalDistributionFunction_CharlieSheen(NdotH,alphaG);/*#ifdef SHEEN_SOFTER
float visibility=visibility_CharlieSheen(info.NdotL,info.NdotV,alphaG);
#else */
float visibility=visibility_Ashikhmin(info.NdotL,info.NdotV);/* #endif */
float sheenTerm=fresnel*distribution*visibility;return sheenTerm*info.attenuation*info.NdotL*lightColor;}
#endif
`;g.IncludesShadersStore[uG]||(g.IncludesShadersStore[uG]=uee)});var pG,dee,mG=S(()=>{O();pG="pbrIBLFunctions",dee=`#if defined(REFLECTION) || defined(SS_REFRACTION)
float getLodFromAlphaG(float cubeMapDimensionPixels,float microsurfaceAverageSlope) {float microsurfaceAverageSlopeTexels=cubeMapDimensionPixels*microsurfaceAverageSlope;float lod=log2(microsurfaceAverageSlopeTexels);return lod;}
float getLinearLodFromRoughness(float cubeMapDimensionPixels,float roughness) {float lod=log2(cubeMapDimensionPixels)*roughness;return lod;}
#endif
#if defined(ENVIRONMENTBRDF) && defined(RADIANCEOCCLUSION)
float environmentRadianceOcclusion(float ambientOcclusion,float NdotVUnclamped) {float temp=NdotVUnclamped+ambientOcclusion;return saturate(square(temp)-1.0+ambientOcclusion);}
#endif
#if defined(ENVIRONMENTBRDF) && defined(HORIZONOCCLUSION)
float environmentHorizonOcclusion(vec3 view,vec3 normal,vec3 geometricNormal) {vec3 reflection=reflect(view,normal);float temp=saturate(1.0+1.1*dot(reflection,geometricNormal));return square(temp);}
#endif
#if defined(LODINREFLECTIONALPHA) || defined(SS_LODINREFRACTIONALPHA)
#define UNPACK_LOD(x) (1.0-x)*255.0
float getLodFromAlphaG(float cubeMapDimensionPixels,float alphaG,float NdotV) {float microsurfaceAverageSlope=alphaG;microsurfaceAverageSlope*=sqrt(abs(NdotV));return getLodFromAlphaG(cubeMapDimensionPixels,microsurfaceAverageSlope);}
#endif
`;g.IncludesShadersStore[pG]||(g.IncludesShadersStore[pG]=dee)});var _G,pee,X_=S(()=>{O();_G="bumpFragmentMainFunctions",pee=`#if defined(BUMP) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC) || defined(DETAIL)
#if defined(TANGENT) && defined(NORMAL) 
varying mat3 vTBN;
#endif
#ifdef OBJECTSPACE_NORMALMAP
uniform mat4 normalMatrix;
#if defined(WEBGL2) || defined(WEBGPU)
mat4 toNormalMatrix(mat4 wMatrix)
{mat4 ret=inverse(wMatrix);ret=transpose(ret);ret[0][3]=0.;ret[1][3]=0.;ret[2][3]=0.;ret[3]=vec4(0.,0.,0.,1.);return ret;}
#else
mat4 toNormalMatrix(mat4 m)
{float
a00=m[0][0],a01=m[0][1],a02=m[0][2],a03=m[0][3],
a10=m[1][0],a11=m[1][1],a12=m[1][2],a13=m[1][3],
a20=m[2][0],a21=m[2][1],a22=m[2][2],a23=m[2][3],
a30=m[3][0],a31=m[3][1],a32=m[3][2],a33=m[3][3],
b00=a00*a11-a01*a10,
b01=a00*a12-a02*a10,
b02=a00*a13-a03*a10,
b03=a01*a12-a02*a11,
b04=a01*a13-a03*a11,
b05=a02*a13-a03*a12,
b06=a20*a31-a21*a30,
b07=a20*a32-a22*a30,
b08=a20*a33-a23*a30,
b09=a21*a32-a22*a31,
b10=a21*a33-a23*a31,
b11=a22*a33-a23*a32,
det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;mat4 mi=mat4(
a11*b11-a12*b10+a13*b09,
a02*b10-a01*b11-a03*b09,
a31*b05-a32*b04+a33*b03,
a22*b04-a21*b05-a23*b03,
a12*b08-a10*b11-a13*b07,
a00*b11-a02*b08+a03*b07,
a32*b02-a30*b05-a33*b01,
a20*b05-a22*b02+a23*b01,
a10*b10-a11*b08+a13*b06,
a01*b08-a00*b10-a03*b06,
a30*b04-a31*b02+a33*b00,
a21*b02-a20*b04-a23*b00,
a11*b07-a10*b09-a12*b06,
a00*b09-a01*b07+a02*b06,
a31*b01-a30*b03-a32*b00,
a20*b03-a21*b01+a22*b00)/det;return mat4(mi[0][0],mi[1][0],mi[2][0],mi[3][0],
mi[0][1],mi[1][1],mi[2][1],mi[3][1],
mi[0][2],mi[1][2],mi[2][2],mi[3][2],
mi[0][3],mi[1][3],mi[2][3],mi[3][3]);}
#endif
#endif
vec3 perturbNormalBase(mat3 cotangentFrame,vec3 normal,float scale)
{
#ifdef NORMALXYSCALE
normal=normalize(normal*vec3(scale,scale,1.0));
#endif
return normalize(cotangentFrame*normal);}
vec3 perturbNormal(mat3 cotangentFrame,vec3 textureSample,float scale)
{return perturbNormalBase(cotangentFrame,textureSample*2.0-1.0,scale);}
mat3 cotangent_frame(vec3 normal,vec3 p,vec2 uv,vec2 tangentSpaceParams)
{vec3 dp1=dFdx(p);vec3 dp2=dFdy(p);vec2 duv1=dFdx(uv);vec2 duv2=dFdy(uv);vec3 dp2perp=cross(dp2,normal);vec3 dp1perp=cross(normal,dp1);vec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;vec3 bitangent=dp2perp*duv1.y+dp1perp*duv2.y;tangent*=tangentSpaceParams.x;bitangent*=tangentSpaceParams.y;float det=max(dot(tangent,tangent),dot(bitangent,bitangent));float invmax=det==0.0 ? 0.0 : inversesqrt(det);return mat3(tangent*invmax,bitangent*invmax,normal);}
#endif
`;g.IncludesShadersStore[_G]||(g.IncludesShadersStore[_G]=pee)});var gG,mee,Y_=S(()=>{O();z_();gG="bumpFragmentFunctions",mee=`#if defined(BUMP)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump)
#endif
#if defined(DETAIL)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_SAMPLERNAME_,detail)
#endif
#if defined(BUMP) && defined(PARALLAX)
const float minSamples=4.;const float maxSamples=15.;const int iMaxSamples=15;vec2 parallaxOcclusion(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale) {float parallaxLimit=length(vViewDirCoT.xy)/vViewDirCoT.z;parallaxLimit*=parallaxScale;vec2 vOffsetDir=normalize(vViewDirCoT.xy);vec2 vMaxOffset=vOffsetDir*parallaxLimit;float numSamples=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));float stepSize=1.0/numSamples;float currRayHeight=1.0;vec2 vCurrOffset=vec2(0,0);vec2 vLastOffset=vec2(0,0);float lastSampledHeight=1.0;float currSampledHeight=1.0;bool keepWorking=true;for (int i=0; i<iMaxSamples; i++)
{currSampledHeight=texture2D(bumpSampler,texCoord+vCurrOffset).w;if (!keepWorking)
{}
else if (currSampledHeight>currRayHeight)
{float delta1=currSampledHeight-currRayHeight;float delta2=(currRayHeight+stepSize)-lastSampledHeight;float ratio=delta1/(delta1+delta2);vCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;keepWorking=false;}
else
{currRayHeight-=stepSize;vLastOffset=vCurrOffset;
#ifdef PARALLAX_RHS
vCurrOffset-=stepSize*vMaxOffset;
#else
vCurrOffset+=stepSize*vMaxOffset;
#endif
lastSampledHeight=currSampledHeight;}}
return vCurrOffset;}
vec2 parallaxOffset(vec3 viewDir,float heightScale)
{float height=texture2D(bumpSampler,vBumpUV).w;vec2 texCoordOffset=heightScale*viewDir.xy*height;
#ifdef PARALLAX_RHS
return texCoordOffset;
#else
return -texCoordOffset;
#endif
}
#endif
`;g.IncludesShadersStore[gG]||(g.IncludesShadersStore[gG]=mee)});var vG,_ee,DI=S(()=>{O();vG="decalFragment",_ee=`#ifdef DECAL
#ifdef GAMMADECAL
decalColor.rgb=toLinearSpace(decalColor.rgb);
#endif
#ifdef DECAL_SMOOTHALPHA
decalColor.a*=decalColor.a;
#endif
surfaceAlbedo.rgb=mix(surfaceAlbedo.rgb,decalColor.rgb,decalColor.a);
#endif
`;g.IncludesShadersStore[vG]||(g.IncludesShadersStore[vG]=_ee)});var SG,gee,EG=S(()=>{O();DI();SG="pbrBlockAlbedoOpacity",gee=`struct albedoOpacityOutParams
{vec3 surfaceAlbedo;float alpha;};
#define pbr_inline
albedoOpacityOutParams albedoOpacityBlock(
in vec4 vAlbedoColor
#ifdef ALBEDO
,in vec4 albedoTexture
,in vec2 albedoInfos
#endif
,in float baseWeight
#ifdef BASE_WEIGHT
,in vec4 baseWeightTexture
,in vec2 vBaseWeightInfos
#endif
#ifdef OPACITY
,in vec4 opacityMap
,in vec2 vOpacityInfos
#endif
#ifdef DETAIL
,in vec4 detailColor
,in vec4 vDetailInfos
#endif
#ifdef DECAL
,in vec4 decalColor
,in vec4 vDecalInfos
#endif
)
{albedoOpacityOutParams outParams;vec3 surfaceAlbedo=vAlbedoColor.rgb;float alpha=vAlbedoColor.a;
#ifdef ALBEDO
#if defined(ALPHAFROMALBEDO) || defined(ALPHATEST)
alpha*=albedoTexture.a;
#endif
#ifdef GAMMAALBEDO
surfaceAlbedo*=toLinearSpace(albedoTexture.rgb);
#else
surfaceAlbedo*=albedoTexture.rgb;
#endif
surfaceAlbedo*=albedoInfos.y;
#endif
#ifndef DECAL_AFTER_DETAIL
#include<decalFragment>
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
surfaceAlbedo*=vColor.rgb;
#endif
#ifdef DETAIL
float detailAlbedo=2.0*mix(0.5,detailColor.r,vDetailInfos.y);surfaceAlbedo.rgb=surfaceAlbedo.rgb*detailAlbedo*detailAlbedo; 
#endif
#ifdef DECAL_AFTER_DETAIL
#include<decalFragment>
#endif
#define CUSTOM_FRAGMENT_UPDATE_ALBEDO
surfaceAlbedo*=baseWeight;
#ifdef BASE_WEIGHT
surfaceAlbedo*=baseWeightTexture.r;
#endif
#ifdef OPACITY
#ifdef OPACITYRGB
alpha=getLuminance(opacityMap.rgb);
#else
alpha*=opacityMap.a;
#endif
alpha*=vOpacityInfos.y;
#endif
#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)
alpha*=vColor.a;
#endif
#if !defined(SS_LINKREFRACTIONTOTRANSPARENCY) && !defined(ALPHAFRESNEL)
#ifdef ALPHATEST
#if DEBUGMODE != 88
if (alpha<ALPHATESTVALUE)
discard;
#endif
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
#endif
outParams.surfaceAlbedo=surfaceAlbedo;outParams.alpha=alpha;return outParams;}
`;g.IncludesShadersStore[SG]||(g.IncludesShadersStore[SG]=gee)});var TG,vee,xG=S(()=>{O();TG="pbrBlockReflectivity",vee=`struct reflectivityOutParams
{float microSurface;float roughness;float diffuseRoughness;float reflectanceF0;vec3 reflectanceF90;vec3 colorReflectanceF0;vec3 colorReflectanceF90;
#ifdef METALLICWORKFLOW
vec3 surfaceAlbedo;float metallic;float specularWeight;vec3 dielectricColorF0;
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
vec3 ambientOcclusionColor;
#endif
#if DEBUGMODE>0
#ifdef METALLICWORKFLOW
#ifdef REFLECTIVITY
vec4 surfaceMetallicColorMap;
#endif
vec3 metallicF0;
#else
#ifdef REFLECTIVITY
vec4 surfaceReflectivityColorMap;
#endif
#endif
#endif
};
#define pbr_inline
reflectivityOutParams reflectivityBlock(
in vec4 reflectivityColor
#ifdef METALLICWORKFLOW
,in vec3 surfaceAlbedo
,in vec4 metallicReflectanceFactors
#endif
,in float baseDiffuseRoughness
#ifdef BASE_DIFFUSE_ROUGHNESS
,in float baseDiffuseRoughnessTexture
,in vec2 baseDiffuseRoughnessInfos
#endif
#ifdef REFLECTIVITY
,in vec3 reflectivityInfos
,in vec4 surfaceMetallicOrReflectivityColorMap
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
,in vec3 ambientOcclusionColorIn
#endif
#ifdef MICROSURFACEMAP
,in vec4 microSurfaceTexel
#endif
#ifdef DETAIL
,in vec4 detailColor
,in vec4 vDetailInfos
#endif
)
{reflectivityOutParams outParams;float microSurface=reflectivityColor.a;vec3 surfaceReflectivityColor=reflectivityColor.rgb;
#ifdef METALLICWORKFLOW
vec2 metallicRoughness=surfaceReflectivityColor.rg;float ior=surfaceReflectivityColor.b;
#ifdef REFLECTIVITY
#if DEBUGMODE>0
outParams.surfaceMetallicColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef AOSTOREINMETALMAPRED
vec3 aoStoreInMetalMap=vec3(surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r);outParams.ambientOcclusionColor=mix(ambientOcclusionColorIn,aoStoreInMetalMap,reflectivityInfos.z);
#endif
#ifdef METALLNESSSTOREINMETALMAPBLUE
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.b;
#else
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.r;
#endif
#ifdef ROUGHNESSSTOREINMETALMAPALPHA
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.a;
#else
#ifdef ROUGHNESSSTOREINMETALMAPGREEN
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.g;
#endif
#endif
#endif
#ifdef DETAIL
float detailRoughness=mix(0.5,detailColor.b,vDetailInfos.w);float loLerp=mix(0.,metallicRoughness.g,detailRoughness*2.);float hiLerp=mix(metallicRoughness.g,1.,(detailRoughness-0.5)*2.);metallicRoughness.g=mix(loLerp,hiLerp,step(detailRoughness,0.5));
#endif
#ifdef MICROSURFACEMAP
metallicRoughness.g*=microSurfaceTexel.r;
#endif
#define CUSTOM_FRAGMENT_UPDATE_METALLICROUGHNESS
microSurface=1.0-metallicRoughness.g;vec3 baseColor=surfaceAlbedo;outParams.metallic=metallicRoughness.r;outParams.specularWeight=metallicReflectanceFactors.a;float dielectricF0=reflectivityColor.a*outParams.specularWeight;surfaceReflectivityColor=metallicReflectanceFactors.rgb;
#if DEBUGMODE>0
outParams.metallicF0=vec3(dielectricF0)*surfaceReflectivityColor;
#endif
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
outParams.surfaceAlbedo=baseColor.rgb*(vec3(1.0)-vec3(dielectricF0)*surfaceReflectivityColor)*(1.0-outParams.metallic);
#else
outParams.surfaceAlbedo=baseColor.rgb;
#endif
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
{vec3 reflectivityColor=mix(dielectricF0*surfaceReflectivityColor,baseColor.rgb,outParams.metallic);outParams.reflectanceF0=max(reflectivityColor.r,max(reflectivityColor.g,reflectivityColor.b));}
#else
#if DIELECTRIC_SPECULAR_MODEL==DIELECTRIC_SPECULAR_MODEL_GLTF
float maxF0=max(surfaceReflectivityColor.r,max(surfaceReflectivityColor.g,surfaceReflectivityColor.b));outParams.reflectanceF0=mix(dielectricF0*maxF0,1.0,outParams.metallic);
#else
outParams.reflectanceF0=mix(dielectricF0,1.0,outParams.metallic);
#endif
#endif
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
outParams.reflectanceF90=vec3(outParams.specularWeight);float f90Scale=1.0;
#else
float f90Scale=clamp(2.0*(ior-1.0),0.0,1.0);outParams.reflectanceF90=vec3(mix(outParams.specularWeight*f90Scale,1.0,outParams.metallic));
#endif
outParams.dielectricColorF0=vec3(dielectricF0*surfaceReflectivityColor);vec3 metallicColorF0=baseColor.rgb;outParams.colorReflectanceF0=mix(outParams.dielectricColorF0,metallicColorF0,outParams.metallic);
#if (DIELECTRIC_SPECULAR_MODEL==DIELECTRIC_SPECULAR_MODEL_OPENPBR)
vec3 dielectricColorF90=surfaceReflectivityColor*vec3(outParams.specularWeight)*vec3(f90Scale);
#else
vec3 dielectricColorF90=vec3(outParams.specularWeight*f90Scale);
#endif
#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)
vec3 conductorColorF90=surfaceReflectivityColor;
#else
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
vec3 conductorColorF90=outParams.reflectanceF90;
#else
vec3 conductorColorF90=vec3(1.0);
#endif
#endif
outParams.colorReflectanceF90=mix(dielectricColorF90,conductorColorF90,outParams.metallic);
#else
#ifdef REFLECTIVITY
surfaceReflectivityColor*=surfaceMetallicOrReflectivityColorMap.rgb;
#if DEBUGMODE>0
outParams.surfaceReflectivityColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef MICROSURFACEFROMREFLECTIVITYMAP
microSurface*=surfaceMetallicOrReflectivityColorMap.a;microSurface*=reflectivityInfos.z;
#else
#ifdef MICROSURFACEAUTOMATIC
microSurface*=computeDefaultMicroSurface(microSurface,surfaceReflectivityColor);
#endif
#ifdef MICROSURFACEMAP
microSurface*=microSurfaceTexel.r;
#endif
#define CUSTOM_FRAGMENT_UPDATE_MICROSURFACE
#endif
#endif
outParams.colorReflectanceF0=surfaceReflectivityColor;outParams.reflectanceF0=max(surfaceReflectivityColor.r,max(surfaceReflectivityColor.g,surfaceReflectivityColor.b));outParams.reflectanceF90=vec3(1.0);
#if (DIELECTRIC_SPECULAR_MODEL==DIELECTRIC_SPECULAR_MODEL_OPENPBR)
outParams.colorReflectanceF90=surfaceReflectivityColor;
#else
outParams.colorReflectanceF90=vec3(1.0);
#endif
#endif
microSurface=saturate(microSurface);float roughness=1.-microSurface;float diffuseRoughness=baseDiffuseRoughness;
#ifdef BASE_DIFFUSE_ROUGHNESS
diffuseRoughness*=baseDiffuseRoughnessTexture*baseDiffuseRoughnessInfos.y;
#endif
outParams.microSurface=microSurface;outParams.roughness=roughness;outParams.diffuseRoughness=diffuseRoughness;return outParams;}
`;g.IncludesShadersStore[TG]||(g.IncludesShadersStore[TG]=vee)});var AG,See,RG=S(()=>{O();AG="pbrBlockAmbientOcclusion",See=`struct ambientOcclusionOutParams
{vec3 ambientOcclusionColor;
#if DEBUGMODE>0 && defined(AMBIENT)
vec3 ambientOcclusionColorMap;
#endif
};ambientOcclusionOutParams ambientOcclusionBlock(
#ifdef AMBIENT
in vec3 ambientOcclusionColorMap_,
in vec4 vAmbientInfos
#endif
)
{ambientOcclusionOutParams outParams;vec3 ambientOcclusionColor=vec3(1.,1.,1.);
#ifdef AMBIENT
vec3 ambientOcclusionColorMap=ambientOcclusionColorMap_*vAmbientInfos.y;
#ifdef AMBIENTINGRAYSCALE
ambientOcclusionColorMap=vec3(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);
#endif
ambientOcclusionColor=mix(ambientOcclusionColor,ambientOcclusionColorMap,vAmbientInfos.z);
#if DEBUGMODE>0
outParams.ambientOcclusionColorMap=ambientOcclusionColorMap;
#endif
#endif
outParams.ambientOcclusionColor=ambientOcclusionColor;return outParams;}
`;g.IncludesShadersStore[AG]||(g.IncludesShadersStore[AG]=See)});var bG,Eee,CG=S(()=>{O();bG="pbrBlockAlphaFresnel",Eee=`#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
struct alphaFresnelOutParams
{float alpha;};
#define pbr_inline
alphaFresnelOutParams alphaFresnelBlock(
in vec3 normalW,
in vec3 viewDirectionW,
in float alpha,
in float microSurface
)
{alphaFresnelOutParams outParams;float opacityPerceptual=alpha;
#ifdef LINEARALPHAFRESNEL
float opacity0=opacityPerceptual;
#else
float opacity0=opacityPerceptual*opacityPerceptual;
#endif
float opacity90=fresnelGrazingReflectance(opacity0);vec3 normalForward=faceforward(normalW,-viewDirectionW,normalW);outParams.alpha=getReflectanceFromAnalyticalBRDFLookup_Jones(saturate(dot(viewDirectionW,normalForward)),vec3(opacity0),vec3(opacity90),sqrt(microSurface)).x;
#ifdef ALPHATEST
if (outParams.alpha<ALPHATESTVALUE)
discard;
#ifndef ALPHABLEND
outParams.alpha=1.0;
#endif
#endif
return outParams;}
#endif
#endif
`;g.IncludesShadersStore[bG]||(g.IncludesShadersStore[bG]=Eee)});var IG,Tee,yG=S(()=>{O();IG="pbrBlockAnisotropic",Tee=`#ifdef ANISOTROPIC
struct anisotropicOutParams
{float anisotropy;vec3 anisotropicTangent;vec3 anisotropicBitangent;vec3 anisotropicNormal;
#if DEBUGMODE>0 && defined(ANISOTROPIC_TEXTURE)
vec3 anisotropyMapData;
#endif
};
#define pbr_inline
anisotropicOutParams anisotropicBlock(
in vec3 vAnisotropy,
in float roughness,
#ifdef ANISOTROPIC_TEXTURE
in vec3 anisotropyMapData,
#endif
in mat3 TBN,
in vec3 normalW,
in vec3 viewDirectionW
)
{anisotropicOutParams outParams;float anisotropy=vAnisotropy.b;vec3 anisotropyDirection=vec3(vAnisotropy.xy,0.);
#ifdef ANISOTROPIC_TEXTURE
anisotropy*=anisotropyMapData.b;
#if DEBUGMODE>0
outParams.anisotropyMapData=anisotropyMapData;
#endif
anisotropyMapData.rg=anisotropyMapData.rg*2.0-1.0;
#ifdef ANISOTROPIC_LEGACY
anisotropyDirection.rg*=anisotropyMapData.rg;
#else
anisotropyDirection.xy=mat2(anisotropyDirection.x,anisotropyDirection.y,-anisotropyDirection.y,anisotropyDirection.x)*normalize(anisotropyMapData.rg);
#endif
#endif
mat3 anisoTBN=mat3(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));vec3 anisotropicTangent=normalize(anisoTBN*anisotropyDirection);vec3 anisotropicBitangent=normalize(cross(anisoTBN[2],anisotropicTangent));outParams.anisotropy=anisotropy;outParams.anisotropicTangent=anisotropicTangent;outParams.anisotropicBitangent=anisotropicBitangent;outParams.anisotropicNormal=getAnisotropicBentNormals(anisotropicTangent,anisotropicBitangent,normalW,viewDirectionW,anisotropy,roughness);return outParams;}
#endif
`;g.IncludesShadersStore[IG]||(g.IncludesShadersStore[IG]=Tee)});var MG,xee,PG=S(()=>{O();MG="pbrBlockReflection",xee=`#ifdef REFLECTION
struct reflectionOutParams
{vec4 environmentRadiance;vec3 environmentIrradiance;
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords;
#else
vec2 reflectionCoords;
#endif
#ifdef SS_TRANSLUCENCY
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
vec3 irradianceVector;
#endif
#endif
#endif
};
#define pbr_inline
void createReflectionCoords(
in vec3 vPositionW,
in vec3 normalW,
#ifdef ANISOTROPIC
in anisotropicOutParams anisotropicOut,
#endif
#ifdef REFLECTIONMAP_3D
out vec3 reflectionCoords
#else
out vec2 reflectionCoords
#endif
)
{
#ifdef ANISOTROPIC
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),anisotropicOut.anisotropicNormal);
#else
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
reflectionCoords=reflectionVector;
#else
reflectionCoords=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
}
#define pbr_inline
#define inline
void sampleReflectionTexture(
in float alphaG,
in vec3 vReflectionMicrosurfaceInfos,
in vec2 vReflectionInfos,
in vec3 vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
in float NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
in float roughness,
#endif
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSampler,
const vec3 reflectionCoords,
#else
in sampler2D reflectionSampler,
const vec2 reflectionCoords,
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSamplerLow,
in samplerCube reflectionSamplerHigh,
#else
in sampler2D reflectionSamplerLow,
in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
in vec2 vReflectionFilteringInfo,
#endif
out vec4 environmentRadiance
)
{
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
float reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);
#elif defined(LINEARSPECULARREFLECTION)
float reflectionLOD=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);
#else
float reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);
#endif
#ifdef LODBASEDMICROSFURACE
reflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;
#ifdef LODINREFLECTIONALPHA
float automaticReflectionLOD=UNPACK_LOD(sampleReflection(reflectionSampler,reflectionCoords).a);float requestedReflectionLOD=max(automaticReflectionLOD,reflectionLOD);
#else
float requestedReflectionLOD=reflectionLOD;
#endif
#ifdef REALTIME_FILTERING
environmentRadiance=vec4(radiance(alphaG,reflectionSampler,reflectionCoords,vReflectionFilteringInfo),1.0);
#else
environmentRadiance=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);
#endif
#else
float lodReflectionNormalized=saturate(reflectionLOD/log2(vReflectionMicrosurfaceInfos.x));float lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;vec4 environmentMid=sampleReflection(reflectionSampler,reflectionCoords);if (lodReflectionNormalizedDoubled<1.0){environmentRadiance=mix(
sampleReflection(reflectionSamplerHigh,reflectionCoords),
environmentMid,
lodReflectionNormalizedDoubled
);} else {environmentRadiance=mix(
environmentMid,
sampleReflection(reflectionSamplerLow,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);}
#endif
#ifdef RGBDREFLECTION
environmentRadiance.rgb=fromRGBD(environmentRadiance);
#endif
#ifdef GAMMAREFLECTION
environmentRadiance.rgb=toLinearSpace(environmentRadiance.rgb);
#endif
environmentRadiance.rgb*=vReflectionInfos.x;environmentRadiance.rgb*=vReflectionColor.rgb;}
#define pbr_inline
#define inline
reflectionOutParams reflectionBlock(
in vec3 vPositionW
,in vec3 normalW
,in float alphaG
,in vec3 vReflectionMicrosurfaceInfos
,in vec2 vReflectionInfos
,in vec3 vReflectionColor
#ifdef ANISOTROPIC
,in anisotropicOutParams anisotropicOut
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,in float NdotVUnclamped
#endif
#ifdef LINEARSPECULARREFLECTION
,in float roughness
#endif
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSampler
#else
,in sampler2D reflectionSampler
#endif
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
,in vec3 vEnvironmentIrradiance
#endif
#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))
,in mat4 reflectionMatrix
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
,in samplerCube irradianceSampler
#else
,in sampler2D irradianceSampler
#endif
#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION
,in vec3 reflectionDominantDirection
#endif
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSamplerLow
,in samplerCube reflectionSamplerHigh
#else
,in sampler2D reflectionSamplerLow
,in sampler2D reflectionSamplerHigh
#endif
#endif
#ifdef REALTIME_FILTERING
,in vec2 vReflectionFilteringInfo
#ifdef IBL_CDF_FILTERING
,in sampler2D icdfSampler
#endif
#endif
,in vec3 viewDirectionW
,in float diffuseRoughness
,in vec3 surfaceAlbedo
)
{reflectionOutParams outParams;vec4 environmentRadiance=vec4(0.,0.,0.,0.);
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords=vec3(0.);
#else
vec2 reflectionCoords=vec2(0.);
#endif
createReflectionCoords(
vPositionW,
normalW,
#ifdef ANISOTROPIC
anisotropicOut,
#endif
reflectionCoords
);sampleReflectionTexture(
alphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
roughness,
#endif
#ifdef REFLECTIONMAP_3D
reflectionSampler,
reflectionCoords,
#else
reflectionSampler,
reflectionCoords,
#endif
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentRadiance
);vec3 environmentIrradiance=vec3(0.,0.,0.);
#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))
#ifdef ANISOTROPIC
vec3 irradianceVector=vec3(reflectionMatrix*vec4(anisotropicOut.anisotropicNormal,0)).xyz;
#else
vec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;
#endif
vec3 irradianceView=vec3(reflectionMatrix*vec4(viewDirectionW,0)).xyz;
#if !defined(USE_IRRADIANCE_DOMINANT_DIRECTION) && !defined(REALTIME_FILTERING)
#if BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LAMBERT && BASE_DIFFUSE_MODEL != BRDF_DIFFUSE_MODEL_LEGACY
float NdotV=max(dot(normalW,viewDirectionW),0.0);irradianceVector=mix(irradianceVector,irradianceView,(0.5*(1.0-NdotV))*diffuseRoughness);
#endif
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
environmentIrradiance=vEnvironmentIrradiance;
#else
#if defined(REALTIME_FILTERING)
environmentIrradiance=irradiance(reflectionSampler,irradianceVector,vReflectionFilteringInfo,diffuseRoughness,surfaceAlbedo,irradianceView
#ifdef IBL_CDF_FILTERING
,icdfSampler
#endif
);
#else
environmentIrradiance=computeEnvironmentIrradiance(irradianceVector);
#endif
#ifdef SS_TRANSLUCENCY
outParams.irradianceVector=irradianceVector;
#endif
#endif
#elif defined(USEIRRADIANCEMAP)
#ifdef REFLECTIONMAP_3D
vec4 environmentIrradiance4=sampleReflection(irradianceSampler,irradianceVector);
#else
vec4 environmentIrradiance4=sampleReflection(irradianceSampler,reflectionCoords);
#endif
environmentIrradiance=environmentIrradiance4.rgb;
#ifdef RGBDREFLECTION
environmentIrradiance.rgb=fromRGBD(environmentIrradiance4);
#endif
#ifdef GAMMAREFLECTION
environmentIrradiance.rgb=toLinearSpace(environmentIrradiance.rgb);
#endif
#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION
vec3 Ls=normalize(reflectionDominantDirection);float NoL=dot(irradianceVector,Ls);float NoV=dot(irradianceVector,irradianceView);vec3 diffuseRoughnessTerm=vec3(1.0);
#if BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_EON
float LoV=dot (Ls,irradianceView);float mag=length(reflectionDominantDirection)*2.0;vec3 clampedAlbedo=clamp(surfaceAlbedo,vec3(0.1),vec3(1.0));diffuseRoughnessTerm=diffuseBRDF_EON(clampedAlbedo,diffuseRoughness,NoL,NoV,LoV)*PI;diffuseRoughnessTerm=diffuseRoughnessTerm/clampedAlbedo;diffuseRoughnessTerm=mix(vec3(1.0),diffuseRoughnessTerm,sqrt(clamp(mag*NoV,0.0,1.0)));
#elif BASE_DIFFUSE_MODEL==BRDF_DIFFUSE_MODEL_BURLEY
vec3 H=(irradianceView+Ls)*0.5;float VoH=dot(irradianceView,H);diffuseRoughnessTerm=vec3(diffuseBRDF_Burley(NoL,NoV,VoH,diffuseRoughness)*PI);
#endif
environmentIrradiance=environmentIrradiance.rgb*diffuseRoughnessTerm;
#endif
#endif
environmentIrradiance*=vReflectionColor.rgb*vReflectionInfos.x;
#ifdef MIX_IBL_RADIANCE_WITH_IRRADIANCE
outParams.environmentRadiance=vec4(mix(environmentRadiance.rgb,environmentIrradiance,alphaG),environmentRadiance.a);
#else
outParams.environmentRadiance=environmentRadiance;
#endif
outParams.environmentIrradiance=environmentIrradiance;outParams.reflectionCoords=reflectionCoords;return outParams;}
#endif
`;g.IncludesShadersStore[MG]||(g.IncludesShadersStore[MG]=xee)});var DG,Aee,OG=S(()=>{O();DG="pbrBlockSheen",Aee=`#ifdef SHEEN
struct sheenOutParams
{float sheenIntensity;vec3 sheenColor;float sheenRoughness;
#ifdef SHEEN_LINKWITHALBEDO
vec3 surfaceAlbedo;
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
float sheenAlbedoScaling;
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
vec3 finalSheenRadianceScaled;
#endif
#if DEBUGMODE>0
#ifdef SHEEN_TEXTURE
vec4 sheenMapData;
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
vec3 sheenEnvironmentReflectance;
#endif
#endif
};
#define pbr_inline
#define inline
sheenOutParams sheenBlock(
in vec4 vSheenColor
#ifdef SHEEN_ROUGHNESS
,in float vSheenRoughness
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
,in vec4 sheenMapRoughnessData
#endif
#endif
,in float roughness
#ifdef SHEEN_TEXTURE
,in vec4 sheenMapData
,in float sheenMapLevel
#endif
,in float reflectance
#ifdef SHEEN_LINKWITHALBEDO
,in vec3 baseColor
,in vec3 surfaceAlbedo
#endif
#ifdef ENVIRONMENTBRDF
,in float NdotV
,in vec3 environmentBrdf
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
,in vec2 AARoughnessFactors
,in vec3 vReflectionMicrosurfaceInfos
,in vec2 vReflectionInfos
,in vec3 vReflectionColor
,in vec4 vLightingIntensity
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSampler
,in vec3 reflectionCoords
#else
,in sampler2D reflectionSampler
,in vec2 reflectionCoords
#endif
,in float NdotVUnclamped
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSamplerLow
,in samplerCube reflectionSamplerHigh
#else
,in sampler2D reflectionSamplerLow
,in sampler2D reflectionSamplerHigh
#endif
#endif
#ifdef REALTIME_FILTERING
,in vec2 vReflectionFilteringInfo
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
,in float seo
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
,in float eho
#endif
#endif
)
{sheenOutParams outParams;float sheenIntensity=vSheenColor.a;
#ifdef SHEEN_TEXTURE
#if DEBUGMODE>0
outParams.sheenMapData=sheenMapData;
#endif
#endif
#ifdef SHEEN_LINKWITHALBEDO
float sheenFactor=pow5(1.0-sheenIntensity);vec3 sheenColor=baseColor.rgb*(1.0-sheenFactor);float sheenRoughness=sheenIntensity;outParams.surfaceAlbedo=surfaceAlbedo*sheenFactor;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#else
vec3 sheenColor=vSheenColor.rgb;
#ifdef SHEEN_TEXTURE
#ifdef SHEEN_GAMMATEXTURE
sheenColor.rgb*=toLinearSpace(sheenMapData.rgb);
#else
sheenColor.rgb*=sheenMapData.rgb;
#endif
sheenColor.rgb*=sheenMapLevel;
#endif
#ifdef SHEEN_ROUGHNESS
float sheenRoughness=vSheenRoughness;
#ifdef SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE
#if defined(SHEEN_TEXTURE)
sheenRoughness*=sheenMapData.a;
#endif
#elif defined(SHEEN_TEXTURE_ROUGHNESS)
sheenRoughness*=sheenMapRoughnessData.a;
#endif
#else
float sheenRoughness=roughness;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#endif
#if !defined(SHEEN_ALBEDOSCALING)
sheenIntensity*=(1.-reflectance);
#endif
sheenColor*=sheenIntensity;
#endif
#ifdef ENVIRONMENTBRDF
/*#ifdef SHEEN_SOFTER
vec3 environmentSheenBrdf=vec3(0.,0.,getBRDFLookupCharlieSheen(NdotV,sheenRoughness));
#else*/
#ifdef SHEEN_ROUGHNESS
vec3 environmentSheenBrdf=getBRDFLookup(NdotV,sheenRoughness);
#else
vec3 environmentSheenBrdf=environmentBrdf;
#endif
/*#endif*/
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
float sheenAlphaG=convertRoughnessToAverageSlope(sheenRoughness);
#ifdef SPECULARAA
sheenAlphaG+=AARoughnessFactors.y;
#endif
vec4 environmentSheenRadiance=vec4(0.,0.,0.,0.);sampleReflectionTexture(
sheenAlphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
sheenRoughness,
#endif
reflectionSampler,
reflectionCoords,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentSheenRadiance
);vec3 sheenEnvironmentReflectance=getSheenReflectanceFromBRDFLookup(sheenColor,environmentSheenBrdf);
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
sheenEnvironmentReflectance*=seo;
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
sheenEnvironmentReflectance*=eho;
#endif
#if DEBUGMODE>0
outParams.sheenEnvironmentReflectance=sheenEnvironmentReflectance;
#endif
outParams.finalSheenRadianceScaled=
environmentSheenRadiance.rgb *
sheenEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
outParams.sheenAlbedoScaling=1.0-sheenIntensity*max(max(sheenColor.r,sheenColor.g),sheenColor.b)*environmentSheenBrdf.b;
#endif
outParams.sheenIntensity=sheenIntensity;outParams.sheenColor=sheenColor;outParams.sheenRoughness=sheenRoughness;return outParams;}
#endif
`;g.IncludesShadersStore[DG]||(g.IncludesShadersStore[DG]=Aee)});var LG,Ree,wG=S(()=>{O();LG="pbrBlockClearcoat",Ree=`struct clearcoatOutParams
{vec3 specularEnvironmentR0;float conservationFactor;vec3 clearCoatNormalW;vec2 clearCoatAARoughnessFactors;float clearCoatIntensity;float clearCoatRoughness;
#ifdef REFLECTION
vec3 finalClearCoatRadianceScaled;
#endif
#ifdef CLEARCOAT_TINT
vec3 absorption;float clearCoatNdotVRefract;vec3 clearCoatColor;float clearCoatThickness;
#endif
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
vec3 energyConservationFactorClearCoat;
#endif
#if DEBUGMODE>0
#ifdef CLEARCOAT_BUMP
mat3 TBNClearCoat;
#endif
#ifdef CLEARCOAT_TEXTURE
vec2 clearCoatMapData;
#endif
#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
vec4 clearCoatTintMapData;
#endif
#ifdef REFLECTION
vec4 environmentClearCoatRadiance;vec3 clearCoatEnvironmentReflectance;
#endif
float clearCoatNdotV;
#endif
};
#ifdef CLEARCOAT
#define pbr_inline
#define inline
clearcoatOutParams clearcoatBlock(
in vec3 vPositionW
,in vec3 geometricNormalW
,in vec3 viewDirectionW
,in vec2 vClearCoatParams
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
,in vec4 clearCoatMapRoughnessData
#endif
,in vec3 specularEnvironmentR0
#ifdef CLEARCOAT_TEXTURE
,in vec2 clearCoatMapData
#endif
#ifdef CLEARCOAT_TINT
,in vec4 vClearCoatTintParams
,in float clearCoatColorAtDistance
,in vec4 vClearCoatRefractionParams
#ifdef CLEARCOAT_TINT_TEXTURE
,in vec4 clearCoatTintMapData
#endif
#endif
#ifdef CLEARCOAT_BUMP
,in vec2 vClearCoatBumpInfos
,in vec4 clearCoatBumpMapData
,in vec2 vClearCoatBumpUV
#if defined(TANGENT) && defined(NORMAL)
,in mat3 vTBN
#else
,in vec2 vClearCoatTangentSpaceParams
#endif
#ifdef OBJECTSPACE_NORMALMAP
,in mat4 normalMatrix
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
,in vec3 faceNormal
#endif
#ifdef REFLECTION
,in vec3 vReflectionMicrosurfaceInfos
,in vec2 vReflectionInfos
,in vec3 vReflectionColor
,in vec4 vLightingIntensity
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSampler
#else
,in sampler2D reflectionSampler
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSamplerLow
,in samplerCube reflectionSamplerHigh
#else
,in sampler2D reflectionSamplerLow
,in sampler2D reflectionSamplerHigh
#endif
#endif
#ifdef REALTIME_FILTERING
,in vec2 vReflectionFilteringInfo
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
,in float frontFacingMultiplier
#endif
)
{clearcoatOutParams outParams;float clearCoatIntensity=vClearCoatParams.x;float clearCoatRoughness=vClearCoatParams.y;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#ifdef CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE
clearCoatRoughness*=clearCoatMapData.y;
#endif
#if DEBUGMODE>0
outParams.clearCoatMapData=clearCoatMapData;
#endif
#endif
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
clearCoatRoughness*=clearCoatMapRoughnessData.y;
#endif
outParams.clearCoatIntensity=clearCoatIntensity;outParams.clearCoatRoughness=clearCoatRoughness;
#ifdef CLEARCOAT_TINT
vec3 clearCoatColor=vClearCoatTintParams.rgb;float clearCoatThickness=vClearCoatTintParams.a;
#ifdef CLEARCOAT_TINT_TEXTURE
#ifdef CLEARCOAT_TINT_GAMMATEXTURE
clearCoatColor*=toLinearSpace(clearCoatTintMapData.rgb);
#else
clearCoatColor*=clearCoatTintMapData.rgb;
#endif
clearCoatThickness*=clearCoatTintMapData.a;
#if DEBUGMODE>0
outParams.clearCoatTintMapData=clearCoatTintMapData;
#endif
#endif
outParams.clearCoatColor=computeColorAtDistanceInMedia(clearCoatColor,clearCoatColorAtDistance);outParams.clearCoatThickness=clearCoatThickness;
#endif
#ifdef CLEARCOAT_REMAP_F0
vec3 specularEnvironmentR0Updated=getR0RemappedForClearCoat(specularEnvironmentR0);
#else
vec3 specularEnvironmentR0Updated=specularEnvironmentR0;
#endif
outParams.specularEnvironmentR0=mix(specularEnvironmentR0,specularEnvironmentR0Updated,clearCoatIntensity);vec3 clearCoatNormalW=geometricNormalW;
#ifdef CLEARCOAT_BUMP
#ifdef NORMALXYSCALE
float clearCoatNormalScale=1.0;
#else
float clearCoatNormalScale=vClearCoatBumpInfos.y;
#endif
#if defined(TANGENT) && defined(NORMAL)
mat3 TBNClearCoat=vTBN;
#else
vec2 TBNClearCoatUV=vClearCoatBumpUV*frontFacingMultiplier;mat3 TBNClearCoat=cotangent_frame(clearCoatNormalW*clearCoatNormalScale,vPositionW,TBNClearCoatUV,vClearCoatTangentSpaceParams);
#endif
#if DEBUGMODE>0
outParams.TBNClearCoat=TBNClearCoat;
#endif
#ifdef OBJECTSPACE_NORMALMAP
clearCoatNormalW=normalize(clearCoatBumpMapData.xyz *2.0-1.0);clearCoatNormalW=normalize(mat3(normalMatrix)*clearCoatNormalW);
#else
clearCoatNormalW=perturbNormal(TBNClearCoat,clearCoatBumpMapData.xyz,vClearCoatBumpInfos.y);
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
clearCoatNormalW*=sign(dot(clearCoatNormalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
clearCoatNormalW=clearCoatNormalW*frontFacingMultiplier;
#endif
outParams.clearCoatNormalW=clearCoatNormalW;outParams.clearCoatAARoughnessFactors=getAARoughnessFactors(clearCoatNormalW.xyz);float clearCoatNdotVUnclamped=dot(clearCoatNormalW,viewDirectionW);float clearCoatNdotV=absEps(clearCoatNdotVUnclamped);
#if DEBUGMODE>0
outParams.clearCoatNdotV=clearCoatNdotV;
#endif
#ifdef CLEARCOAT_TINT
vec3 clearCoatVRefract=refract(-viewDirectionW,clearCoatNormalW,vClearCoatRefractionParams.y);outParams.clearCoatNdotVRefract=absEps(dot(clearCoatNormalW,clearCoatVRefract));
#endif
#if defined(ENVIRONMENTBRDF) && (!defined(REFLECTIONMAP_SKYBOX) || defined(MS_BRDF_ENERGY_CONSERVATION))
vec3 environmentClearCoatBrdf=getBRDFLookup(clearCoatNdotV,clearCoatRoughness);
#endif
#if defined(REFLECTION)
float clearCoatAlphaG=convertRoughnessToAverageSlope(clearCoatRoughness);
#ifdef SPECULARAA
clearCoatAlphaG+=outParams.clearCoatAARoughnessFactors.y;
#endif
vec4 environmentClearCoatRadiance=vec4(0.,0.,0.,0.);vec3 clearCoatReflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),clearCoatNormalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
clearCoatReflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
vec3 clearCoatReflectionCoords=clearCoatReflectionVector;
#else
vec2 clearCoatReflectionCoords=clearCoatReflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
clearCoatReflectionCoords/=clearCoatReflectionVector.z;
#endif
clearCoatReflectionCoords.y=1.0-clearCoatReflectionCoords.y;
#endif
sampleReflectionTexture(
clearCoatAlphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
clearCoatNdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
clearCoatRoughness,
#endif
reflectionSampler,
clearCoatReflectionCoords,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentClearCoatRadiance
);
#if DEBUGMODE>0
outParams.environmentClearCoatRadiance=environmentClearCoatRadiance;
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
vec3 clearCoatEnvironmentReflectance=getReflectanceFromBRDFLookup(vec3(vClearCoatRefractionParams.x),environmentClearCoatBrdf);
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
float clearCoatEho=environmentHorizonOcclusion(-viewDirectionW,clearCoatNormalW,geometricNormalW);clearCoatEnvironmentReflectance*=clearCoatEho;
#endif
#endif
#endif
#else
vec3 clearCoatEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(clearCoatNdotV,vec3(1.),vec3(1.),sqrt(1.-clearCoatRoughness));
#endif
clearCoatEnvironmentReflectance*=clearCoatIntensity;
#if DEBUGMODE>0
outParams.clearCoatEnvironmentReflectance=clearCoatEnvironmentReflectance;
#endif
outParams.finalClearCoatRadianceScaled=
environmentClearCoatRadiance.rgb *
clearCoatEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(CLEARCOAT_TINT)
outParams.absorption=computeClearCoatAbsorption(outParams.clearCoatNdotVRefract,outParams.clearCoatNdotVRefract,outParams.clearCoatColor,clearCoatThickness,clearCoatIntensity);
#endif
float fresnelIBLClearCoat=fresnelSchlickGGX(clearCoatNdotV,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnelIBLClearCoat*=clearCoatIntensity;outParams.conservationFactor=(1.-fresnelIBLClearCoat);
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
outParams.energyConservationFactorClearCoat=getEnergyConservationFactor(outParams.specularEnvironmentR0,environmentClearCoatBrdf);
#endif
return outParams;}
#endif
`;g.IncludesShadersStore[LG]||(g.IncludesShadersStore[LG]=Ree)});var FG,bee,NG=S(()=>{O();FG="pbrBlockIridescence",bee=`struct iridescenceOutParams
{float iridescenceIntensity;float iridescenceIOR;float iridescenceThickness;vec3 specularEnvironmentR0;};
#ifdef IRIDESCENCE
#define pbr_inline
#define inline
iridescenceOutParams iridescenceBlock(
in vec4 vIridescenceParams
,in float viewAngle
,in vec3 specularEnvironmentR0
#ifdef IRIDESCENCE_TEXTURE
,in vec2 iridescenceMapData
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
,in vec2 iridescenceThicknessMapData
#endif
#ifdef CLEARCOAT
,in float NdotVUnclamped
,in vec2 vClearCoatParams
#ifdef CLEARCOAT_TEXTURE
,in vec2 clearCoatMapData
#endif
#endif
)
{iridescenceOutParams outParams;float iridescenceIntensity=vIridescenceParams.x;float iridescenceIOR=vIridescenceParams.y;float iridescenceThicknessMin=vIridescenceParams.z;float iridescenceThicknessMax=vIridescenceParams.w;float iridescenceThicknessWeight=1.;
#ifdef IRIDESCENCE_TEXTURE
iridescenceIntensity*=iridescenceMapData.x;
#endif
#if defined(IRIDESCENCE_THICKNESS_TEXTURE)
iridescenceThicknessWeight=iridescenceThicknessMapData.g;
#endif
float iridescenceThickness=mix(iridescenceThicknessMin,iridescenceThicknessMax,iridescenceThicknessWeight);float topIor=1.; 
#ifdef CLEARCOAT
float clearCoatIntensity=vClearCoatParams.x;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#endif
topIor=mix(1.0,vClearCoatRefractionParams.w-1.,clearCoatIntensity);viewAngle=sqrt(1.0+square(1.0/topIor)*(square(NdotVUnclamped)-1.0));
#endif
vec3 iridescenceFresnel=evalIridescence(topIor,iridescenceIOR,viewAngle,iridescenceThickness,specularEnvironmentR0);outParams.specularEnvironmentR0=mix(specularEnvironmentR0,iridescenceFresnel,iridescenceIntensity);outParams.iridescenceIntensity=iridescenceIntensity;outParams.iridescenceThickness=iridescenceThickness;outParams.iridescenceIOR=iridescenceIOR;return outParams;}
#endif
`;g.IncludesShadersStore[FG]||(g.IncludesShadersStore[FG]=bee)});var BG,Cee,UG=S(()=>{O();BG="pbrBlockSubSurface",Cee=`struct subSurfaceOutParams
{vec3 specularEnvironmentReflectance;
#ifdef SS_REFRACTION
vec3 finalRefraction;vec3 surfaceAlbedo;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
float alpha;
#endif
float refractionOpacity;
#endif
#ifdef SS_TRANSLUCENCY
vec3 transmittance;float translucencyIntensity;
#ifdef REFLECTION
vec3 refractionIrradiance;
#endif
#endif
#if DEBUGMODE>0
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec4 thicknessMap;
#endif
#ifdef SS_REFRACTION
vec4 environmentRefraction;vec3 refractionTransmittance;
#endif
#endif
};
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
#define pbr_inline
#define inline
vec4 sampleEnvironmentRefraction(
in float ior
,in float thickness
,in float refractionLOD
,in vec3 normalW
,in vec3 vPositionW
,in vec3 viewDirectionW
,in mat4 view
,in vec4 vRefractionInfos
,in mat4 refractionMatrix
,in vec4 vRefractionMicrosurfaceInfos
,in float alphaG
#ifdef SS_REFRACTIONMAP_3D
,in samplerCube refractionSampler
#ifndef LODBASEDMICROSFURACE
,in samplerCube refractionSamplerLow
,in samplerCube refractionSamplerHigh
#endif
#else
,in sampler2D refractionSampler
#ifndef LODBASEDMICROSFURACE
,in sampler2D refractionSamplerLow
,in sampler2D refractionSamplerHigh
#endif
#endif
#ifdef ANISOTROPIC
,in anisotropicOutParams anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,in vec2 vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,in vec3 refractionPosition
,in vec3 refractionSize
#endif
) {vec4 environmentRefraction=vec4(0.,0.,0.,0.);
#ifdef ANISOTROPIC
vec3 refractionVector=refract(-viewDirectionW,anisotropicOut.anisotropicNormal,ior);
#else
vec3 refractionVector=refract(-viewDirectionW,normalW,ior);
#endif
#ifdef SS_REFRACTIONMAP_OPPOSITEZ
refractionVector.z*=-1.0;
#endif
#ifdef SS_REFRACTIONMAP_3D
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
refractionVector=parallaxCorrectNormal(vPositionW,refractionVector,refractionSize,refractionPosition);
#endif
refractionVector.y=refractionVector.y*vRefractionInfos.w;vec3 refractionCoords=refractionVector;refractionCoords=vec3(refractionMatrix*vec4(refractionCoords,0));
#else
#ifdef SS_USE_THICKNESS_AS_DEPTH
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*thickness,1.0)));
#else
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));
#endif
vec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;
#endif
#ifdef LODBASEDMICROSFURACE
refractionLOD=refractionLOD*vRefractionMicrosurfaceInfos.y+vRefractionMicrosurfaceInfos.z;
#ifdef SS_LODINREFRACTIONALPHA
float automaticRefractionLOD=UNPACK_LOD(sampleRefraction(refractionSampler,refractionCoords).a);float requestedRefractionLOD=max(automaticRefractionLOD,refractionLOD);
#else
float requestedRefractionLOD=refractionLOD;
#endif
#if defined(REALTIME_FILTERING) && defined(SS_REFRACTIONMAP_3D)
environmentRefraction=vec4(radiance(alphaG,refractionSampler,refractionCoords,vRefractionFilteringInfo),1.0);
#else
environmentRefraction=sampleRefractionLod(refractionSampler,refractionCoords,requestedRefractionLOD);
#endif
#else
float lodRefractionNormalized=saturate(refractionLOD/log2(vRefractionMicrosurfaceInfos.x));float lodRefractionNormalizedDoubled=lodRefractionNormalized*2.0;vec4 environmentRefractionMid=sampleRefraction(refractionSampler,refractionCoords);if (lodRefractionNormalizedDoubled<1.0){environmentRefraction=mix(
sampleRefraction(refractionSamplerHigh,refractionCoords),
environmentRefractionMid,
lodRefractionNormalizedDoubled
);} else {environmentRefraction=mix(
environmentRefractionMid,
sampleRefraction(refractionSamplerLow,refractionCoords),
lodRefractionNormalizedDoubled-1.0
);}
#endif
#ifdef SS_RGBDREFRACTION
environmentRefraction.rgb=fromRGBD(environmentRefraction);
#endif
#ifdef SS_GAMMAREFRACTION
environmentRefraction.rgb=toLinearSpace(environmentRefraction.rgb);
#endif
return environmentRefraction;}
#endif
#define pbr_inline
#define inline
subSurfaceOutParams subSurfaceBlock(
in vec3 vSubSurfaceIntensity
,in vec2 vThicknessParam
,in vec4 vTintColor
,in vec3 normalW
,in vec3 vSpecularEnvironmentReflectance
#ifdef SS_THICKNESSANDMASK_TEXTURE
,in vec4 thicknessMap
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
,in vec4 refractionIntensityMap
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
,in vec4 translucencyIntensityMap
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
,in mat4 reflectionMatrix
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
,in vec3 irradianceVector_
#endif
#if defined(REALTIME_FILTERING)
,in samplerCube reflectionSampler
,in vec2 vReflectionFilteringInfo
#ifdef IBL_CDF_FILTERING
,in sampler2D icdfSampler
#endif
#endif
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
,in samplerCube irradianceSampler
#else
,in sampler2D irradianceSampler
#endif
#endif
#endif
#endif
#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
,in vec3 surfaceAlbedo
#endif
#ifdef SS_REFRACTION
,in vec3 vPositionW
,in vec3 viewDirectionW
,in mat4 view
,in vec4 vRefractionInfos
,in mat4 refractionMatrix
,in vec4 vRefractionMicrosurfaceInfos
,in vec4 vLightingIntensity
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
,in float alpha
#endif
#ifdef SS_LODINREFRACTIONALPHA
,in float NdotVUnclamped
#endif
#ifdef SS_LINEARSPECULARREFRACTION
,in float roughness
#endif
,in float alphaG
#ifdef SS_REFRACTIONMAP_3D
,in samplerCube refractionSampler
#ifndef LODBASEDMICROSFURACE
,in samplerCube refractionSamplerLow
,in samplerCube refractionSamplerHigh
#endif
#else
,in sampler2D refractionSampler
#ifndef LODBASEDMICROSFURACE
,in sampler2D refractionSamplerLow
,in sampler2D refractionSamplerHigh
#endif
#endif
#ifdef ANISOTROPIC
,in anisotropicOutParams anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,in vec2 vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,in vec3 refractionPosition
,in vec3 refractionSize
#endif
#ifdef SS_DISPERSION
,in float dispersion
#endif
#endif
#ifdef SS_TRANSLUCENCY
,in vec3 vDiffusionDistance
,in vec4 vTranslucencyColor
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
,in vec4 translucencyColorMap
#endif
#endif
)
{subSurfaceOutParams outParams;outParams.specularEnvironmentReflectance=vSpecularEnvironmentReflectance;
#ifdef SS_REFRACTION
float refractionIntensity=vSubSurfaceIntensity.x;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
refractionIntensity*=(1.0-alpha);outParams.alpha=1.0;
#endif
#endif
#ifdef SS_TRANSLUCENCY
float translucencyIntensity=vSubSurfaceIntensity.y;
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
#ifdef SS_USE_GLTF_TEXTURES
float thickness=thicknessMap.g*vThicknessParam.y+vThicknessParam.x;
#else
float thickness=thicknessMap.r*vThicknessParam.y+vThicknessParam.x;
#endif
#if DEBUGMODE>0
outParams.thicknessMap=thicknessMap;
#endif
#if defined(SS_REFRACTION) && defined(SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS)
#ifdef SS_USE_GLTF_TEXTURES
refractionIntensity*=thicknessMap.r;
#else
refractionIntensity*=thicknessMap.g;
#endif
#endif
#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS)
#ifdef SS_USE_GLTF_TEXTURES
translucencyIntensity*=thicknessMap.a;
#else
translucencyIntensity*=thicknessMap.b;
#endif
#endif
#else
float thickness=vThicknessParam.y;
#endif
#if defined(SS_REFRACTION) && defined(SS_REFRACTIONINTENSITY_TEXTURE)
#ifdef SS_USE_GLTF_TEXTURES
refractionIntensity*=refractionIntensityMap.r;
#else
refractionIntensity*=refractionIntensityMap.g;
#endif
#endif
#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCYINTENSITY_TEXTURE)
#ifdef SS_USE_GLTF_TEXTURES
translucencyIntensity*=translucencyIntensityMap.a;
#else
translucencyIntensity*=translucencyIntensityMap.b;
#endif
#endif
#ifdef SS_TRANSLUCENCY
thickness=maxEps(thickness);vec4 translucencyColor=vTranslucencyColor;
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
translucencyColor*=translucencyColorMap;
#endif
vec3 transmittance=transmittanceBRDF_Burley(translucencyColor.rgb,vDiffusionDistance,thickness);transmittance*=translucencyIntensity;outParams.transmittance=transmittance;outParams.translucencyIntensity=translucencyIntensity;
#endif
#ifdef SS_REFRACTION
vec4 environmentRefraction=vec4(0.,0.,0.,0.);
#ifdef SS_HAS_THICKNESS
float ior=vRefractionInfos.y;
#else
float ior=vRefractionMicrosurfaceInfos.w;
#endif
#ifdef SS_LODINREFRACTIONALPHA
float refractionAlphaG=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG,NdotVUnclamped);
#elif defined(SS_LINEARSPECULARREFRACTION)
float refractionRoughness=alphaG;refractionRoughness=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLinearLodFromRoughness(vRefractionMicrosurfaceInfos.x,refractionRoughness);
#else
float refractionAlphaG=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG);
#endif
float refraction_ior=vRefractionInfos.y;
#ifdef SS_DISPERSION
float realIOR=1.0/refraction_ior;float iorDispersionSpread=0.04*dispersion*(realIOR-1.0);vec3 iors=vec3(1.0/(realIOR-iorDispersionSpread),refraction_ior,1.0/(realIOR+iorDispersionSpread));for (int i=0; i<3; i++) {refraction_ior=iors[i];
#endif
vec4 envSample=sampleEnvironmentRefraction(refraction_ior,thickness,refractionLOD,normalW,vPositionW,viewDirectionW,view,vRefractionInfos,refractionMatrix,vRefractionMicrosurfaceInfos,alphaG
#ifdef SS_REFRACTIONMAP_3D
,refractionSampler
#ifndef LODBASEDMICROSFURACE
,refractionSamplerLow
,refractionSamplerHigh
#endif
#else
,refractionSampler
#ifndef LODBASEDMICROSFURACE
,refractionSamplerLow
,refractionSamplerHigh
#endif
#endif
#ifdef ANISOTROPIC
,anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,refractionPosition
,refractionSize
#endif
);
#ifdef SS_DISPERSION
environmentRefraction[i]=envSample[i];}
#else
environmentRefraction=envSample;
#endif
environmentRefraction.rgb*=vRefractionInfos.x;
#endif
#ifdef SS_REFRACTION
vec3 refractionTransmittance=vec3(refractionIntensity);
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambert(volumeAlbedo,thickness);
#elif defined(SS_LINKREFRACTIONTOTRANSPARENCY)
float maxChannel=max(max(surfaceAlbedo.r,surfaceAlbedo.g),surfaceAlbedo.b);vec3 volumeAlbedo=saturate(maxChannel*surfaceAlbedo);environmentRefraction.rgb*=volumeAlbedo;
#else
vec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambert(volumeAlbedo,vThicknessParam.y);
#endif
#ifdef SS_ALBEDOFORREFRACTIONTINT
environmentRefraction.rgb*=surfaceAlbedo.rgb;
#endif
outParams.surfaceAlbedo=surfaceAlbedo;outParams.refractionOpacity=1.-refractionIntensity;
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
outParams.surfaceAlbedo*=outParams.refractionOpacity;
#endif
#ifdef UNUSED_MULTIPLEBOUNCES
vec3 bounceSpecularEnvironmentReflectance=(2.0*vSpecularEnvironmentReflectance)/(1.0+vSpecularEnvironmentReflectance);outParams.specularEnvironmentReflectance=mix(bounceSpecularEnvironmentReflectance,vSpecularEnvironmentReflectance,refractionIntensity);
#endif
#if DEBUGMODE>0
outParams.refractionTransmittance=refractionTransmittance;
#endif
outParams.finalRefraction=environmentRefraction.rgb*refractionTransmittance*vLightingIntensity.z;outParams.finalRefraction*=vec3(1.0)-vSpecularEnvironmentReflectance;
#if DEBUGMODE>0
outParams.environmentRefraction=environmentRefraction;
#endif
#endif
#if defined(REFLECTION) && defined(SS_TRANSLUCENCY)
#if defined(NORMAL) && defined(USESPHERICALINVERTEX) || !defined(USESPHERICALFROMREFLECTIONMAP)
vec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#else
vec3 irradianceVector=irradianceVector_;
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP)
#if defined(REALTIME_FILTERING)
vec3 refractionIrradiance=irradiance(reflectionSampler,-irradianceVector,vReflectionFilteringInfo,0.0,surfaceAlbedo,irradianceVector
#ifdef IBL_CDF_FILTERING
,icdfSampler
#endif
);
#else
vec3 refractionIrradiance=computeEnvironmentIrradiance(-irradianceVector);
#endif
#elif defined(USEIRRADIANCEMAP)
#ifdef REFLECTIONMAP_3D
vec3 irradianceCoords=irradianceVector;
#else
vec2 irradianceCoords=irradianceVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
irradianceCoords/=irradianceVector.z;
#endif
irradianceCoords.y=1.0-irradianceCoords.y;
#endif
vec4 refractionIrradiance=sampleReflection(irradianceSampler,-irradianceCoords);
#ifdef RGBDREFLECTION
refractionIrradiance.rgb=fromRGBD(refractionIrradiance);
#endif
#ifdef GAMMAREFLECTION
refractionIrradiance.rgb=toLinearSpace(refractionIrradiance.rgb);
#endif
#else
vec4 refractionIrradiance=vec4(0.);
#endif
refractionIrradiance.rgb*=transmittance;
#ifdef SS_ALBEDOFORTRANSLUCENCYTINT
refractionIrradiance.rgb*=surfaceAlbedo.rgb;
#endif
outParams.refractionIrradiance=refractionIrradiance.rgb;
#endif
return outParams;}
#endif
`;g.IncludesShadersStore[BG]||(g.IncludesShadersStore[BG]=Cee)});var GG,Iee,OI=S(()=>{O();GG="pbrBlockReflectance0",Iee=`float reflectanceF0=reflectivityOut.reflectanceF0;vec3 specularEnvironmentR0=reflectivityOut.colorReflectanceF0;vec3 specularEnvironmentR90=reflectivityOut.colorReflectanceF90;
#ifdef ALPHAFRESNEL
float reflectance90=fresnelGrazingReflectance(reflectanceF0);specularEnvironmentR90=specularEnvironmentR90*reflectance90;
#endif
`;g.IncludesShadersStore[GG]||(g.IncludesShadersStore[GG]=Iee)});var VG,yee,kG=S(()=>{O();GC();OI();VG="pbrClusteredLightingFunctions",yee=`#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0
#include<clusteredLightingFunctions>
lightingInfo computeClusteredLighting(
sampler2D lightDataTexture,
sampler2D tileMaskTexture,
vec4 lightData,
ivec2 sliceRange,
vec3 V,
vec3 N,
vec3 posW,
vec3 surfaceAlbedo,
reflectivityOutParams reflectivityOut
#ifdef IRIDESCENCE
,float iridescenceIntensity
#endif
#ifdef SS_TRANSLUCENCY
,subSurfaceOutParams subSurfaceOut
#endif
#ifdef SPECULARTERM
,float AARoughnessFactor
#endif
#ifdef ANISOTROPIC
,anisotropicOutParams anisotropicOut
#endif
#ifdef SHEEN
,sheenOutParams sheenOut
#endif
#ifdef CLEARCOAT
,clearcoatOutParams clearcoatOut
#endif
) {float NdotV=absEps(dot(N,V));
#include<pbrBlockReflectance0>
#ifdef CLEARCOAT
specularEnvironmentR0=clearcoatOut.specularEnvironmentR0;
#endif
lightingInfo result;ivec2 tilePosition=ivec2(gl_FragCoord.xy*lightData.xy);int maskHeight=int(lightData.z);tilePosition.y=min(tilePosition.y,maskHeight-1);ivec2 batchRange=sliceRange/CLUSTLIGHT_BATCH;int batchOffset=batchRange.x*CLUSTLIGHT_BATCH;tilePosition.y+=maskHeight*batchRange.x;for (int i=batchRange.x; i<=batchRange.y; i+=1) {uint mask=uint(texelFetch(tileMaskTexture,tilePosition,0).r);tilePosition.y+=maskHeight;int maskOffset=max(sliceRange.x-batchOffset,0);int maskWidth=min(sliceRange.y-batchOffset+1,CLUSTLIGHT_BATCH);mask=extractBits(mask,maskOffset,maskWidth);while (mask != 0u) {uint bit=mask & -mask;mask ^= bit;int position=onlyBitPosition(bit);ClusteredLight light=getClusteredLight(lightDataTexture,batchOffset+maskOffset+position);preLightingInfo preInfo=computePointAndSpotPreLightingInfo(light.vLightData,V,N,posW);preInfo.NdotV=NdotV;preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light.vLightFalloff.x,light.vLightFalloff.y);if (light.vLightDirection.w>=0.0) {preInfo.attenuation*=computeDirectionalLightFalloff(light.vLightDirection.xyz,preInfo.L,light.vLightDirection.w,light.vLightData.w,light.vLightFalloff.z,light.vLightFalloff.w);}
preInfo.roughness=adjustRoughnessFromLightProperties(reflectivityOut.roughness,light.vLightSpecular.a,preInfo.lightDistance);preInfo.diffuseRoughness=reflectivityOut.diffuseRoughness;preInfo.surfaceAlbedo=surfaceAlbedo;
#ifdef IRIDESCENCE
preInfo.iridescenceIntensity=iridescenceIntensity;
#endif
lightingInfo info;
#ifdef SS_TRANSLUCENCY
#ifdef SS_TRANSLUCENCY_LEGACY
info.diffuse=computeDiffuseTransmittedLighting(preInfo,light.vLightDiffuse.rgb,subSurfaceOut.transmittance);info.diffuseTransmission=vec3(0);
#else
info.diffuse=computeDiffuseLighting(preInfo,light.vLightDiffuse.rgb)*(1.0-subSurfaceOut.translucencyIntensity);info.diffuseTransmission=computeDiffuseTransmittedLighting(preInfo,light.vLightDiffuse.rgb,subSurfaceOut.transmittance);
#endif
#else
info.diffuse=computeDiffuseLighting(preInfo,light.vLightDiffuse.rgb);
#endif
#ifdef SPECULARTERM
#if CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR
vec3 metalFresnel=reflectivityOut.specularWeight*getF82Specular(preInfo.VdotH,specularEnvironmentR0,reflectivityOut.colorReflectanceF90,reflectivityOut.roughness);vec3 dielectricFresnel=fresnelSchlickGGX(preInfo.VdotH,reflectivityOut.dielectricColorF0,reflectivityOut.colorReflectanceF90);vec3 coloredFresnel=mix(dielectricFresnel,metalFresnel,reflectivityOut.metallic);
#else
vec3 coloredFresnel=fresnelSchlickGGX(preInfo.VdotH,specularEnvironmentR0,reflectivityOut.colorReflectanceF90);
#endif
#ifndef LEGACY_SPECULAR_ENERGY_CONSERVATION
float NdotH=dot(N,preInfo.H);vec3 fresnel=fresnelSchlickGGX(NdotH,vec3(reflectanceF0),specularEnvironmentR90);info.diffuse*=(vec3(1.0)-fresnel);
#endif
#ifdef ANISOTROPIC
info.specular=computeAnisotropicSpecularLighting(preInfo,V,N,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactor,light.vLightDiffuse.rgb);
#else
info.specular=computeSpecularLighting(preInfo,N,specularEnvironmentR0,coloredFresnel,AARoughnessFactor,light.vLightDiffuse.rgb);
#endif
#endif
#ifdef SHEEN
#ifdef SHEEN_LINKWITHALBEDO
preInfo.roughness=sheenOut.sheenIntensity;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light.vLightSpecular.a,preInfo.lightDistance);
#endif
info.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactor,light.vLightDiffuse.rgb);
#endif
#ifdef CLEARCOAT
preInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light.vLightSpecular.a,preInfo.lightDistance);info.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,light.vLightDiffuse.rgb);
#ifdef CLEARCOAT_TINT
float absorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);info.diffuse*=absorption;
#ifdef SS_TRANSLUCENCY
info.diffuseTransmission*=absorption;
#endif
#ifdef SPECULARTERM
info.specular*=absorption;
#endif
#endif
info.diffuse*=info.clearCoat.w;
#ifdef SS_TRANSLUCENCY
info.diffuseTransmission*=info.clearCoat.w;
#endif
#ifdef SPECULARTERM
info.specular*=info.clearCoat.w;
#endif
#ifdef SHEEN
info.sheen*=info.clearCoat.w;
#endif
#endif
result.diffuse+=info.diffuse;
#ifdef SS_TRANSLUCENCY
result.diffuseTransmission+=info.diffuseTransmission;
#endif
#ifdef SPECULARTERM
result.specular+=info.specular;
#endif
#ifdef CLEARCOAT
result.clearCoat+=info.clearCoat;
#endif
#ifdef SHEEN
result.sheen+=info.sheen;
#endif
}
batchOffset+=CLUSTLIGHT_BATCH;}
return result;}
#endif
`;g.IncludesShadersStore[VG]||(g.IncludesShadersStore[VG]=yee)});var WG,Mee,HG=S(()=>{O();WG="pbrBlockNormalGeometric",Mee=`vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;
#endif
vec3 geometricNormalW=normalW;
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
geometricNormalW=gl_FrontFacing ? geometricNormalW : -geometricNormalW;
#endif
`;g.IncludesShadersStore[WG]||(g.IncludesShadersStore[WG]=Mee)});var zG,Pee,K_=S(()=>{O();zG="bumpFragment",Pee=`vec2 uvOffset=vec2(0.0,0.0);
#if defined(BUMP) || defined(PARALLAX) || defined(DETAIL)
#ifdef NORMALXYSCALE
float normalScale=1.0;
#elif defined(BUMP)
float normalScale=vBumpInfos.y;
#else
float normalScale=1.0;
#endif
#if defined(TANGENT) && defined(NORMAL)
mat3 TBN=vTBN;
#elif defined(BUMP)
vec2 TBNUV=gl_FrontFacing ? vBumpUV : -vBumpUV;mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vTangentSpaceParams);
#else
vec2 TBNUV=gl_FrontFacing ? vDetailUV : -vDetailUV;mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vec2(1.,1.));
#endif
#elif defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
mat3 TBN=vTBN;
#else
vec2 TBNUV=gl_FrontFacing ? vMainUV1 : -vMainUV1;mat3 TBN=cotangent_frame(normalW,vPositionW,TBNUV,vec2(1.,1.));
#endif
#endif
#ifdef PARALLAX
mat3 invTBN=transposeMat3(TBN);
#ifdef PARALLAXOCCLUSION
uvOffset=parallaxOcclusion(invTBN*-viewDirectionW,invTBN*normalW,vBumpUV,vBumpInfos.z);
#else
uvOffset=parallaxOffset(invTBN*viewDirectionW,vBumpInfos.z);
#endif
#endif
#ifdef DETAIL
vec4 detailColor=texture2D(detailSampler,vDetailUV+uvOffset);vec2 detailNormalRG=detailColor.wy*2.0-1.0;float detailNormalB=sqrt(1.-saturate(dot(detailNormalRG,detailNormalRG)));vec3 detailNormal=vec3(detailNormalRG,detailNormalB);
#endif
#ifdef BUMP
#ifdef OBJECTSPACE_NORMALMAP
#define CUSTOM_FRAGMENT_BUMP_FRAGMENT
normalW=normalize(texture2D(bumpSampler,vBumpUV).xyz *2.0-1.0);normalW=normalize(mat3(normalMatrix)*normalW);
#elif !defined(DETAIL)
normalW=perturbNormal(TBN,texture2D(bumpSampler,vBumpUV+uvOffset).xyz,vBumpInfos.y);
#else
vec3 bumpNormal=texture2D(bumpSampler,vBumpUV+uvOffset).xyz*2.0-1.0;
#if DETAIL_NORMALBLENDMETHOD==0 
detailNormal.xy*=vDetailInfos.z;vec3 blendedNormal=normalize(vec3(bumpNormal.xy+detailNormal.xy,bumpNormal.z*detailNormal.z));
#elif DETAIL_NORMALBLENDMETHOD==1 
detailNormal.xy*=vDetailInfos.z;bumpNormal+=vec3(0.0,0.0,1.0);detailNormal*=vec3(-1.0,-1.0,1.0);vec3 blendedNormal=bumpNormal*dot(bumpNormal,detailNormal)/bumpNormal.z-detailNormal;
#endif
normalW=perturbNormalBase(TBN,blendedNormal,vBumpInfos.y);
#endif
#elif defined(DETAIL)
detailNormal.xy*=vDetailInfos.z;normalW=perturbNormalBase(TBN,detailNormal,vDetailInfos.z);
#endif
`;g.IncludesShadersStore[zG]||(g.IncludesShadersStore[zG]=Pee)});var XG,Dee,YG=S(()=>{O();XG="pbrBlockNormalFinal",Dee=`#if defined(FORCENORMALFORWARD) && defined(NORMAL)
vec3 faceNormal=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;
#if defined(TWOSIDEDLIGHTING)
faceNormal=gl_FrontFacing ? faceNormal : -faceNormal;
#endif
normalW*=sign(dot(normalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
#if defined(MIRRORED)
normalW=gl_FrontFacing ? -normalW : normalW;
#else
normalW=gl_FrontFacing ? normalW : -normalW;
#endif
#endif
`;g.IncludesShadersStore[XG]||(g.IncludesShadersStore[XG]=Dee)});var KG,Oee,LI=S(()=>{O();KG="depthPrePass",Oee=`#ifdef DEPTHPREPASS
gl_FragColor=vec4(0.,0.,0.,1.0);return;
#endif
`;g.IncludesShadersStore[KG]||(g.IncludesShadersStore[KG]=Oee)});var qG,Lee,QG=S(()=>{O();qG="pbrBlockLightmapInit",Lee=`#ifdef LIGHTMAP
vec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);
#ifdef RGBDLIGHTMAP
lightmapColor.rgb=fromRGBD(lightmapColor);
#endif
#ifdef GAMMALIGHTMAP
lightmapColor.rgb=toLinearSpace(lightmapColor.rgb);
#endif
lightmapColor.rgb*=vLightmapInfos.y;
#endif
`;g.IncludesShadersStore[qG]||(g.IncludesShadersStore[qG]=Lee)});var jG,wee,ZG=S(()=>{O();jG="pbrBlockGeometryInfo",wee=`float NdotVUnclamped=dot(normalW,viewDirectionW);float NdotV=absEps(NdotVUnclamped);float alphaG=convertRoughnessToAverageSlope(roughness);vec2 AARoughnessFactors=getAARoughnessFactors(normalW.xyz);
#ifdef SPECULARAA
alphaG+=AARoughnessFactors.y;
#endif
#if defined(ENVIRONMENTBRDF)
vec3 environmentBrdf=getBRDFLookup(NdotV,roughness);
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
#ifdef AMBIENTINGRAYSCALE
float ambientMonochrome=aoOut.ambientOcclusionColor.r;
#else
float ambientMonochrome=getLuminance(aoOut.ambientOcclusionColor);
#endif
float seo=environmentRadianceOcclusion(ambientMonochrome,NdotVUnclamped);
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
float eho=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);
#endif
#endif
#endif
#endif
`;g.IncludesShadersStore[jG]||(g.IncludesShadersStore[jG]=wee)});var JG,Fee,$G=S(()=>{O();JG="pbrBlockReflectance",Fee=`#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
vec3 baseSpecularEnvironmentReflectance=getReflectanceFromBRDFLookup(vec3(reflectanceF0),reflectivityOut.reflectanceF90,environmentBrdf);
#if (CONDUCTOR_SPECULAR_MODEL==CONDUCTOR_SPECULAR_MODEL_OPENPBR)
vec3 metalEnvironmentReflectance=reflectivityOut.specularWeight*getF82Specular(NdotV,clearcoatOut.specularEnvironmentR0,reflectivityOut.colorReflectanceF90,reflectivityOut.roughness);vec3 dielectricEnvironmentReflectance=getReflectanceFromBRDFLookup(reflectivityOut.dielectricColorF0,reflectivityOut.colorReflectanceF90,environmentBrdf);vec3 colorSpecularEnvironmentReflectance=mix(dielectricEnvironmentReflectance,metalEnvironmentReflectance,reflectivityOut.metallic);
#else
vec3 colorSpecularEnvironmentReflectance=getReflectanceFromBRDFLookup(clearcoatOut.specularEnvironmentR0,reflectivityOut.colorReflectanceF90,environmentBrdf);
#endif
#ifdef RADIANCEOCCLUSION
colorSpecularEnvironmentReflectance*=seo;
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
colorSpecularEnvironmentReflectance*=eho;
#endif
#endif
#endif
#else
vec3 colorSpecularEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,sqrt(microSurface));vec3 baseSpecularEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,vec3(reflectanceF0),reflectivityOut.reflectanceF90,sqrt(microSurface));
#endif
#ifdef CLEARCOAT
colorSpecularEnvironmentReflectance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
colorSpecularEnvironmentReflectance*=clearcoatOut.absorption;
#endif
#endif
`;g.IncludesShadersStore[JG]||(g.IncludesShadersStore[JG]=Fee)});var eV,Nee,tV=S(()=>{O();eV="pbrBlockDirectLighting",Nee=`vec3 diffuseBase=vec3(0.,0.,0.);
#ifdef SS_TRANSLUCENCY
vec3 diffuseTransmissionBase=vec3(0.,0.,0.);
#endif
#ifdef SPECULARTERM
vec3 specularBase=vec3(0.,0.,0.);
#endif
#ifdef CLEARCOAT
vec3 clearCoatBase=vec3(0.,0.,0.);
#endif
#ifdef SHEEN
vec3 sheenBase=vec3(0.,0.,0.);
#endif
#if defined(SPECULARTERM) && defined(LIGHT0)
vec3 coloredFresnel;
#endif
preLightingInfo preInfo;lightingInfo info;float shadow=1.; 
float aggShadow=0.;float numLights=0.;
#if defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
vec3 absorption=vec3(0.);
#endif
`;g.IncludesShadersStore[eV]||(g.IncludesShadersStore[eV]=Nee)});var iV,Bee,rV=S(()=>{O();iV="pbrBlockFinalLitComponents",Bee=`aggShadow=aggShadow/numLights;
#if defined(ENVIRONMENTBRDF)
#ifdef MS_BRDF_ENERGY_CONSERVATION
vec3 baseSpecularEnergyConservationFactor=getEnergyConservationFactor(vec3(reflectanceF0),environmentBrdf);vec3 coloredEnergyConservationFactor=getEnergyConservationFactor(clearcoatOut.specularEnvironmentR0,environmentBrdf);
#endif
#endif
#if defined(SHEEN) && defined(SHEEN_ALBEDOSCALING) && defined(ENVIRONMENTBRDF)
surfaceAlbedo.rgb=sheenOut.sheenAlbedoScaling*surfaceAlbedo.rgb;
#endif
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
#ifndef METALLICWORKFLOW
#ifdef SPECULAR_GLOSSINESS_ENERGY_CONSERVATION
surfaceAlbedo.rgb=(1.-reflectanceF0)*surfaceAlbedo.rgb;
#endif
#endif
#endif
#ifdef REFLECTION
vec3 finalIrradiance=reflectionOut.environmentIrradiance;
#ifndef LEGACY_SPECULAR_ENERGY_CONSERVATION
#if defined(METALLICWORKFLOW) || defined(SPECULAR_GLOSSINESS_ENERGY_CONSERVATION)
vec3 baseSpecularEnergy=vec3(baseSpecularEnvironmentReflectance);
#if defined(ENVIRONMENTBRDF)
#ifdef MS_BRDF_ENERGY_CONSERVATION
baseSpecularEnergy*=baseSpecularEnergyConservationFactor;
#endif
#endif
finalIrradiance*=clamp(vec3(1.0)-baseSpecularEnergy,0.0,1.0);
#endif
#endif
#if defined(CLEARCOAT)
finalIrradiance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
finalIrradiance*=clearcoatOut.absorption;
#endif
#endif
#ifndef SS_APPLY_ALBEDO_AFTER_SUBSURFACE
finalIrradiance*=surfaceAlbedo.rgb;
#endif
#if defined(SS_REFRACTION)
finalIrradiance*=subSurfaceOut.refractionOpacity;
#endif
#if defined(SS_TRANSLUCENCY)
finalIrradiance*=(1.0-subSurfaceOut.translucencyIntensity);finalIrradiance+=subSurfaceOut.refractionIrradiance;
#endif
#ifdef SS_APPLY_ALBEDO_AFTER_SUBSURFACE
finalIrradiance*=surfaceAlbedo.rgb;
#endif
finalIrradiance*=vLightingIntensity.z;finalIrradiance*=aoOut.ambientOcclusionColor;
#endif
#ifdef SPECULARTERM
vec3 finalSpecular=specularBase;finalSpecular=max(finalSpecular,0.0);vec3 finalSpecularScaled=finalSpecular*vLightingIntensity.x*vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalSpecularScaled*=coloredEnergyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalSpecularScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif
#ifdef REFLECTION
vec3 finalRadiance=reflectionOut.environmentRadiance.rgb;finalRadiance*=colorSpecularEnvironmentReflectance;vec3 finalRadianceScaled=finalRadiance*vLightingIntensity.z;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalRadianceScaled*=coloredEnergyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalRadianceScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif
#ifdef SHEEN
vec3 finalSheen=sheenBase*sheenOut.sheenColor;finalSheen=max(finalSheen,0.0);vec3 finalSheenScaled=finalSheen*vLightingIntensity.x*vLightingIntensity.w;
#if defined(CLEARCOAT) && defined(REFLECTION) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.absorption;
#endif
#endif
#endif
#ifdef CLEARCOAT
vec3 finalClearCoat=clearCoatBase;finalClearCoat=max(finalClearCoat,0.0);vec3 finalClearCoatScaled=finalClearCoat*vLightingIntensity.x*vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalClearCoatScaled*=clearcoatOut.energyConservationFactorClearCoat;
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction*=clearcoatOut.conservationFactor;
#ifdef CLEARCOAT_TINT
subSurfaceOut.finalRefraction*=clearcoatOut.absorption;
#endif
#endif
#endif
#ifdef ALPHABLEND
float luminanceOverAlpha=0.0;
#if defined(REFLECTION) && defined(RADIANCEOVERALPHA)
luminanceOverAlpha+=getLuminance(finalRadianceScaled);
#if defined(CLEARCOAT)
luminanceOverAlpha+=getLuminance(clearcoatOut.finalClearCoatRadianceScaled);
#endif
#endif
#if defined(SPECULARTERM) && defined(SPECULAROVERALPHA)
luminanceOverAlpha+=getLuminance(finalSpecularScaled);
#endif
#if defined(CLEARCOAT) && defined(CLEARCOATOVERALPHA)
luminanceOverAlpha+=getLuminance(finalClearCoatScaled);
#endif
#if defined(RADIANCEOVERALPHA) || defined(SPECULAROVERALPHA) || defined(CLEARCOATOVERALPHA)
alpha=saturate(alpha+luminanceOverAlpha*luminanceOverAlpha);
#endif
#endif
`;g.IncludesShadersStore[iV]||(g.IncludesShadersStore[iV]=Bee)});var sV,Uee,nV=S(()=>{O();sV="pbrBlockFinalUnlitComponents",Uee=`vec3 finalDiffuse=diffuseBase;finalDiffuse*=surfaceAlbedo;
#if defined(SS_REFRACTION) && !defined(UNLIT) && !defined(LEGACY_SPECULAR_ENERGY_CONSERVATION)
finalDiffuse*=subSurfaceOut.refractionOpacity;
#endif
#if defined(SS_TRANSLUCENCY) && !defined(UNLIT)
finalDiffuse+=diffuseTransmissionBase;
#endif
finalDiffuse=max(finalDiffuse,0.0);finalDiffuse*=vLightingIntensity.x;vec3 finalAmbient=vAmbientColor;finalAmbient*=surfaceAlbedo.rgb;vec3 finalEmissive=vEmissiveColor;
#ifdef EMISSIVE
vec3 emissiveColorTex=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb;
#ifdef GAMMAEMISSIVE
finalEmissive*=toLinearSpace(emissiveColorTex.rgb);
#else
finalEmissive*=emissiveColorTex.rgb;
#endif
finalEmissive*= vEmissiveInfos.y;
#endif
finalEmissive*=vLightingIntensity.y;
#ifdef AMBIENT
vec3 ambientOcclusionForDirectDiffuse=mix(vec3(1.),aoOut.ambientOcclusionColor,vAmbientInfos.w);
#else
vec3 ambientOcclusionForDirectDiffuse=aoOut.ambientOcclusionColor;
#endif
finalAmbient*=aoOut.ambientOcclusionColor;finalDiffuse*=ambientOcclusionForDirectDiffuse;
`;g.IncludesShadersStore[sV]||(g.IncludesShadersStore[sV]=Uee)});var aV,Gee,oV=S(()=>{O();aV="pbrBlockFinalColorComposition",Gee=`vec4 finalColor=vec4(
#ifndef UNLIT
#ifdef REFLECTION
finalIrradiance +
#endif
#ifdef SPECULARTERM
finalSpecularScaled +
#endif
#ifdef SHEEN
finalSheenScaled +
#endif
#ifdef CLEARCOAT
finalClearCoatScaled +
#endif
#ifdef REFLECTION
finalRadianceScaled +
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled +
#endif
#ifdef CLEARCOAT
clearcoatOut.finalClearCoatRadianceScaled +
#endif
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction +
#endif
#endif
finalAmbient +
finalDiffuse,
alpha);
#ifdef LIGHTMAP
#ifndef LIGHTMAPEXCLUDED
#ifdef USELIGHTMAPASSHADOWMAP
finalColor.rgb*=lightmapColor.rgb;
#else
finalColor.rgb+=lightmapColor.rgb;
#endif
#endif
#endif
finalColor.rgb+=finalEmissive;
#define CUSTOM_FRAGMENT_BEFORE_FOG
finalColor=max(finalColor,0.0);
`;g.IncludesShadersStore[aV]||(g.IncludesShadersStore[aV]=Gee)});var lV,Vee,cV=S(()=>{O();lV="pbrBlockImageProcessing",Vee=`#if defined(IMAGEPROCESSINGPOSTPROCESS) || defined(SS_SCATTERING)
#if !defined(SKIPFINALCOLORCLAMP)
finalColor.rgb=clamp(finalColor.rgb,0.,30.0);
#endif
#else
finalColor=applyImageProcessing(finalColor);
#endif
finalColor.a*=visibility;
#ifdef PREMULTIPLYALPHA
finalColor.rgb*=finalColor.a;
#endif
`;g.IncludesShadersStore[lV]||(g.IncludesShadersStore[lV]=Vee)});var fV,kee,hV=S(()=>{O();fV="pbrBlockPrePass",kee=`#if SCENE_MRT_COUNT>0
float writeGeometryInfo=finalColor.a>ALPHATESTVALUE ? 1.0 : 0.0;
#ifdef PREPASS_POSITION
gl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);
#endif
#ifdef PREPASS_LOCAL_POSITION
gl_FragData[PREPASS_LOCAL_POSITION_INDEX]=vec4(vPosition,writeGeometryInfo);
#endif
#if defined(PREPASS_VELOCITY)
vec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;vec2 velocity=abs(a-b);velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;gl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);
#elif defined(PREPASS_VELOCITY_LINEAR)
vec2 velocity=vec2(0.5)*((vPreviousPosition.xy/vPreviousPosition.w)-(vCurrentPosition.xy/vCurrentPosition.w));gl_FragData[PREPASS_VELOCITY_LINEAR_INDEX]=vec4(velocity,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO
gl_FragData[PREPASS_ALBEDO_INDEX]=vec4(surfaceAlbedo,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO_SQRT
vec3 sqAlbedo=sqrt(surfaceAlbedo); 
#endif
#ifdef PREPASS_IRRADIANCE
vec3 irradiance=finalDiffuse;
#ifndef UNLIT
#ifdef REFLECTION
irradiance+=finalIrradiance;
#endif
#endif
#ifdef SS_SCATTERING
#ifdef PREPASS_COLOR
gl_FragData[PREPASS_COLOR_INDEX]=vec4(finalColor.rgb-irradiance,finalColor.a); 
#endif
irradiance/=sqAlbedo;
#else
#ifdef PREPASS_COLOR
gl_FragData[PREPASS_COLOR_INDEX]=finalColor; 
#endif
float scatteringDiffusionProfile=255.;
#endif
gl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(clamp(irradiance,vec3(0.),vec3(1.)),writeGeometryInfo*scatteringDiffusionProfile/255.); 
#elif defined(PREPASS_COLOR)
gl_FragData[PREPASS_COLOR_INDEX]=vec4(finalColor.rgb,finalColor.a);
#endif
#ifdef PREPASS_DEPTH
gl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_SCREENSPACE_DEPTH
gl_FragData[PREPASS_SCREENSPACE_DEPTH_INDEX]=vec4(gl_FragCoord.z,0.0,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_NORMALIZED_VIEW_DEPTH
gl_FragData[PREPASS_NORMALIZED_VIEW_DEPTH_INDEX]=vec4(vNormViewDepth,0.0,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_NORMAL
#ifdef PREPASS_NORMAL_WORLDSPACE
gl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalW,writeGeometryInfo);
#else
gl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalize((view*vec4(normalW,0.0)).rgb),writeGeometryInfo);
#endif
#endif
#ifdef PREPASS_WORLD_NORMAL
gl_FragData[PREPASS_WORLD_NORMAL_INDEX]=vec4(normalW*0.5+0.5,writeGeometryInfo); 
#endif
#ifdef PREPASS_ALBEDO_SQRT
gl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(sqAlbedo,writeGeometryInfo); 
#endif
#ifdef PREPASS_REFLECTIVITY
#ifndef UNLIT
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(specularEnvironmentR0,microSurface)*writeGeometryInfo;
#else
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4( 0.0,0.0,0.0,1.0 )*writeGeometryInfo;
#endif
#endif
#endif
`;g.IncludesShadersStore[fV]||(g.IncludesShadersStore[fV]=kee)});var uV,Wee,wI=S(()=>{O();uV="oitFragment",Wee=`#ifdef ORDER_INDEPENDENT_TRANSPARENCY
float fragDepth=gl_FragCoord.z; 
#ifdef ORDER_INDEPENDENT_TRANSPARENCY_16BITS
uint halfFloat=packHalf2x16(vec2(fragDepth));vec2 full=unpackHalf2x16(halfFloat);fragDepth=full.x;
#endif
ivec2 fragCoord=ivec2(gl_FragCoord.xy);vec2 lastDepth=texelFetch(oitDepthSampler,fragCoord,0).rg;vec4 lastFrontColor=texelFetch(oitFrontColorSampler,fragCoord,0);depth.rg=vec2(-MAX_DEPTH);frontColor=lastFrontColor;backColor=vec4(0.0);
#ifdef USE_REVERSE_DEPTHBUFFER
float furthestDepth=-lastDepth.x;float nearestDepth=lastDepth.y;
#else
float nearestDepth=-lastDepth.x;float furthestDepth=lastDepth.y;
#endif
float alphaMultiplier=1.0-lastFrontColor.a;
#ifdef USE_REVERSE_DEPTHBUFFER
if (fragDepth>nearestDepth || fragDepth<furthestDepth) {
#else
if (fragDepth<nearestDepth || fragDepth>furthestDepth) {
#endif
return;}
#ifdef USE_REVERSE_DEPTHBUFFER
if (fragDepth<nearestDepth && fragDepth>furthestDepth) {
#else
if (fragDepth>nearestDepth && fragDepth<furthestDepth) {
#endif
depth.rg=vec2(-fragDepth,fragDepth);return;}
#endif
`;g.IncludesShadersStore[uV]||(g.IncludesShadersStore[uV]=Wee)});var dV,Hee,pV=S(()=>{O();dV="pbrDebug",Hee=`#if DEBUGMODE>0
if (vClipSpacePosition.x/vClipSpacePosition.w>=vDebugMode.x) {
#if DEBUGMODE==1
gl_FragColor.rgb=vPositionW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==2 && defined(NORMAL)
gl_FragColor.rgb=vNormalW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==3 && defined(BUMP) || DEBUGMODE==3 && defined(PARALLAX) || DEBUGMODE==3 && defined(ANISOTROPIC)
gl_FragColor.rgb=TBN[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==4 && defined(BUMP) || DEBUGMODE==4 && defined(PARALLAX) || DEBUGMODE==4 && defined(ANISOTROPIC)
gl_FragColor.rgb=TBN[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==5
gl_FragColor.rgb=normalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==6 && defined(MAINUV1)
gl_FragColor.rgb=vec3(vMainUV1,0.0);
#elif DEBUGMODE==7 && defined(MAINUV2)
gl_FragColor.rgb=vec3(vMainUV2,0.0);
#elif DEBUGMODE==8 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)
gl_FragColor.rgb=clearcoatOut.TBNClearCoat[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==9 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)
gl_FragColor.rgb=clearcoatOut.TBNClearCoat[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==10 && defined(CLEARCOAT)
gl_FragColor.rgb=clearcoatOut.clearCoatNormalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==11 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicNormal;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==12 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicTangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==13 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicBitangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==20 && defined(ALBEDO)
gl_FragColor.rgb=albedoTexture.rgb;
#ifndef GAMMAALBEDO
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==21 && defined(AMBIENT)
gl_FragColor.rgb=aoOut.ambientOcclusionColorMap.rgb;
#elif DEBUGMODE==22 && defined(OPACITY)
gl_FragColor.rgb=opacityMap.rgb;
#elif DEBUGMODE==23 && defined(EMISSIVE)
gl_FragColor.rgb=emissiveColorTex.rgb;
#ifndef GAMMAEMISSIVE
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==24 && defined(LIGHTMAP)
gl_FragColor.rgb=lightmapColor.rgb;
#ifndef GAMMALIGHTMAP
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==25 && defined(REFLECTIVITY) && defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.surfaceMetallicColorMap.rgb;
#elif DEBUGMODE==26 && defined(REFLECTIVITY) && !defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.surfaceReflectivityColorMap.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==27 && defined(CLEARCOAT) && defined(CLEARCOAT_TEXTURE)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatMapData.rg,0.0);
#elif DEBUGMODE==28 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
gl_FragColor.rgb=clearcoatOut.clearCoatTintMapData.rgb;
#elif DEBUGMODE==29 && defined(SHEEN) && defined(SHEEN_TEXTURE)
gl_FragColor.rgb=sheenOut.sheenMapData.rgb;
#elif DEBUGMODE==30 && defined(ANISOTROPIC) && defined(ANISOTROPIC_TEXTURE)
gl_FragColor.rgb=anisotropicOut.anisotropyMapData.rgb;
#elif DEBUGMODE==31 && defined(SUBSURFACE) && defined(SS_THICKNESSANDMASK_TEXTURE)
gl_FragColor.rgb=subSurfaceOut.thicknessMap.rgb;
#elif DEBUGMODE==32 && defined(BUMP)
gl_FragColor.rgb=texture2D(bumpSampler,vBumpUV).rgb;
#elif DEBUGMODE==40 && defined(SS_REFRACTION)
gl_FragColor.rgb=subSurfaceOut.environmentRefraction.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==41 && defined(REFLECTION)
gl_FragColor.rgb=reflectionOut.environmentRadiance.rgb;
#ifndef GAMMAREFLECTION
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==42 && defined(CLEARCOAT) && defined(REFLECTION)
gl_FragColor.rgb=clearcoatOut.environmentClearCoatRadiance.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==50
gl_FragColor.rgb=diffuseBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==51 && defined(SPECULARTERM)
gl_FragColor.rgb=specularBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==52 && defined(CLEARCOAT)
gl_FragColor.rgb=clearCoatBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==53 && defined(SHEEN)
gl_FragColor.rgb=sheenBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==54 && defined(REFLECTION)
gl_FragColor.rgb=reflectionOut.environmentIrradiance.rgb;
#ifndef GAMMAREFLECTION
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==60
gl_FragColor.rgb=surfaceAlbedo.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==61
gl_FragColor.rgb=clearcoatOut.specularEnvironmentR0;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==62 && defined(METALLICWORKFLOW)
gl_FragColor.rgb=vec3(reflectivityOut.metallic);
#elif DEBUGMODE==71 && defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.metallicF0;
#elif DEBUGMODE==63
gl_FragColor.rgb=vec3(roughness);
#elif DEBUGMODE==64
gl_FragColor.rgb=vec3(alphaG);
#elif DEBUGMODE==65
gl_FragColor.rgb=vec3(NdotV);
#elif DEBUGMODE==66 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
gl_FragColor.rgb=clearcoatOut.clearCoatColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==67 && defined(CLEARCOAT)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatRoughness);
#elif DEBUGMODE==68 && defined(CLEARCOAT)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatNdotV);
#elif DEBUGMODE==69 && defined(SUBSURFACE) && defined(SS_TRANSLUCENCY)
gl_FragColor.rgb=subSurfaceOut.transmittance;
#elif DEBUGMODE==70 && defined(SUBSURFACE) && defined(SS_REFRACTION)
gl_FragColor.rgb=subSurfaceOut.refractionTransmittance;
#elif DEBUGMODE==72
gl_FragColor.rgb=vec3(microSurface);
#elif DEBUGMODE==73
gl_FragColor.rgb=vAlbedoColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==74 && !defined(METALLICWORKFLOW)
gl_FragColor.rgb=vReflectivityColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==75
gl_FragColor.rgb=vEmissiveColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==80 && defined(RADIANCEOCCLUSION)
gl_FragColor.rgb=vec3(seo);
#elif DEBUGMODE==81 && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
gl_FragColor.rgb=vec3(eho);
#elif DEBUGMODE==82 && defined(MS_BRDF_ENERGY_CONSERVATION)
gl_FragColor.rgb=vec3(energyConservationFactor);
#elif DEBUGMODE==83 && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
gl_FragColor.rgb=baseSpecularEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==84 && defined(CLEARCOAT) && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
gl_FragColor.rgb=clearcoatOut.clearCoatEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==85 && defined(SHEEN) && defined(REFLECTION)
gl_FragColor.rgb=sheenOut.sheenEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==86 && defined(ALPHABLEND)
gl_FragColor.rgb=vec3(luminanceOverAlpha);
#elif DEBUGMODE==87
gl_FragColor.rgb=vec3(alpha);
#elif DEBUGMODE==88 && defined(ALBEDO)
gl_FragColor.rgb=vec3(albedoTexture.a);
#elif DEBUGMODE==89
gl_FragColor.rgb=aoOut.ambientOcclusionColor.rgb;
#else
float stripeWidth=30.;float stripePos=floor(gl_FragCoord.x/stripeWidth);float whichColor=mod(stripePos,2.);vec3 color1=vec3(.6,.2,.2);vec3 color2=vec3(.3,.1,.1);gl_FragColor.rgb=mix(color1,color2,whichColor);
#endif
gl_FragColor.rgb*=vDebugMode.y;
#ifdef DEBUGMODE_NORMALIZE
gl_FragColor.rgb=normalize(gl_FragColor.rgb)*0.5+0.5;
#endif
#ifdef DEBUGMODE_GAMMA
gl_FragColor.rgb=toGammaSpace(gl_FragColor.rgb);
#endif
gl_FragColor.a=1.0;
#ifdef PREPASS
gl_FragData[0]=toLinearSpace(gl_FragColor); 
gl_FragData[1]=vec4(0.,0.,0.,0.); 
#endif
#ifdef DEBUGMODE_FORCERETURN
return;
#endif
}
#endif
`;g.IncludesShadersStore[dV]||(g.IncludesShadersStore[dV]=Hee)});var _V={};V(_V,{pbrPixelShader:()=>zee});var FI,mV,zee,gV=S(()=>{O();yI();MI();q3();gI();j3();P_();D_();tG();M_();Da();Xa();Eu();Di();rG();Iu();aG();L_();O_();TI();lG();fG();Df();yu();dG();mG();X_();Y_();y_();EG();xG();RG();CG();yG();PG();OG();wG();NG();UG();kG();Oa();HG();K_();YG();LI();QG();ZG();OI();$G();tV();w_();rV();nV();oV();Tu();xu();cV();hV();wI();pV();FI="pbrPixelShader",mV=`#define PBR_FRAGMENT_SHADER
#define CUSTOM_FRAGMENT_EXTENSION
#if defined(BUMP) || !defined(NORMAL) || defined(FORCENORMALFORWARD) || defined(SPECULARAA) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#extension GL_OES_standard_derivatives : enable
#endif
#ifdef LODBASEDMICROSFURACE
#extension GL_EXT_shader_texture_lod : enable
#endif
#define CUSTOM_FRAGMENT_BEGIN
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#if SCENE_MRT_COUNT>0
#include<prePassDeclaration>[SCENE_MRT_COUNT]
#endif
precision highp float;
#include<oitDeclaration>
#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE
#endif
#include<__decl__pbrFragment>
#include<pbrFragmentExtraDeclaration>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<pbrFragmentSamplersDeclaration>
#include<imageProcessingDeclaration>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#include<helperFunctions>
#include<subSurfaceScatteringFunctions>
#include<importanceSampling>
#include<pbrHelperFunctions>
#include<imageProcessingFunctions>
#include<shadowsFragmentFunctions>
#include<harmonicsFunctions>
#include<pbrDirectLightingSetupFunctions>
#include<pbrDirectLightingFalloffFunctions>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
#include<pbrDirectLightingFunctions>
#include<pbrIBLFunctions>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#ifdef REFLECTION
#include<reflectionFunction>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
#include<pbrBlockAlbedoOpacity>
#include<pbrBlockReflectivity>
#include<pbrBlockAmbientOcclusion>
#include<pbrBlockAlphaFresnel>
#include<pbrBlockAnisotropic>
#include<pbrBlockReflection>
#include<pbrBlockSheen>
#include<pbrBlockClearcoat>
#include<pbrBlockIridescence>
#include<pbrBlockSubSurface>
#include<pbrClusteredLightingFunctions>
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#include<pbrBlockNormalGeometric>
#include<bumpFragment>
#include<pbrBlockNormalFinal>
albedoOpacityOutParams albedoOpacityOut;
#ifdef ALBEDO
vec4 albedoTexture=texture2D(albedoSampler,vAlbedoUV+uvOffset);
#endif
#ifdef BASE_WEIGHT
vec4 baseWeightTexture=texture2D(baseWeightSampler,vBaseWeightUV+uvOffset);
#endif
#ifdef OPACITY
vec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);
#endif
#ifdef DECAL
vec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);
#endif
albedoOpacityOut=albedoOpacityBlock(
vAlbedoColor
#ifdef ALBEDO
,albedoTexture
,vAlbedoInfos
#endif
,baseWeight
#ifdef BASE_WEIGHT
,baseWeightTexture
,vBaseWeightInfos
#endif
#ifdef OPACITY
,opacityMap
,vOpacityInfos
#endif
#ifdef DETAIL
,detailColor
,vDetailInfos
#endif
#ifdef DECAL
,decalColor
,vDecalInfos
#endif
);vec3 surfaceAlbedo=albedoOpacityOut.surfaceAlbedo;float alpha=albedoOpacityOut.alpha;
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
#include<depthPrePass>
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS
ambientOcclusionOutParams aoOut;
#ifdef AMBIENT
vec3 ambientOcclusionColorMap=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb;
#endif
aoOut=ambientOcclusionBlock(
#ifdef AMBIENT
ambientOcclusionColorMap,
vAmbientInfos
#endif
);
#include<pbrBlockLightmapInit>
#ifdef UNLIT
vec3 diffuseBase=vec3(1.,1.,1.);
#else 
vec3 baseColor=surfaceAlbedo;reflectivityOutParams reflectivityOut;
#if defined(REFLECTIVITY)
vec4 surfaceMetallicOrReflectivityColorMap=texture2D(reflectivitySampler,vReflectivityUV+uvOffset);vec4 baseReflectivity=surfaceMetallicOrReflectivityColorMap;
#ifndef METALLICWORKFLOW
#ifdef REFLECTIVITY_GAMMA
surfaceMetallicOrReflectivityColorMap=toLinearSpace(surfaceMetallicOrReflectivityColorMap);
#endif
surfaceMetallicOrReflectivityColorMap.rgb*=vReflectivityInfos.y;
#endif
#endif
#if defined(MICROSURFACEMAP)
vec4 microSurfaceTexel=texture2D(microSurfaceSampler,vMicroSurfaceSamplerUV+uvOffset)*vMicroSurfaceSamplerInfos.y;
#endif
#ifdef METALLICWORKFLOW
vec4 metallicReflectanceFactors=vMetallicReflectanceFactors;
#ifdef REFLECTANCE
vec4 reflectanceFactorsMap=texture2D(reflectanceSampler,vReflectanceUV+uvOffset);
#ifdef REFLECTANCE_GAMMA
reflectanceFactorsMap=toLinearSpace(reflectanceFactorsMap);
#endif
metallicReflectanceFactors.rgb*=reflectanceFactorsMap.rgb;
#endif
#ifdef METALLIC_REFLECTANCE
vec4 metallicReflectanceFactorsMap=texture2D(metallicReflectanceSampler,vMetallicReflectanceUV+uvOffset);
#ifdef METALLIC_REFLECTANCE_GAMMA
metallicReflectanceFactorsMap=toLinearSpace(metallicReflectanceFactorsMap);
#endif
#ifndef METALLIC_REFLECTANCE_USE_ALPHA_ONLY
metallicReflectanceFactors.rgb*=metallicReflectanceFactorsMap.rgb;
#endif
metallicReflectanceFactors.a*=metallicReflectanceFactorsMap.a;
#endif
#endif
#ifdef BASE_DIFFUSE_ROUGHNESS
float baseDiffuseRoughnessTexture=texture2D(baseDiffuseRoughnessSampler,vBaseDiffuseRoughnessUV+uvOffset).r;
#endif
reflectivityOut=reflectivityBlock(
vReflectivityColor
#ifdef METALLICWORKFLOW
,surfaceAlbedo
,metallicReflectanceFactors
#endif
,baseDiffuseRoughness
#ifdef BASE_DIFFUSE_ROUGHNESS
,baseDiffuseRoughnessTexture
,vBaseDiffuseRoughnessInfos
#endif
#ifdef REFLECTIVITY
,vReflectivityInfos
,surfaceMetallicOrReflectivityColorMap
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
,aoOut.ambientOcclusionColor
#endif
#ifdef MICROSURFACEMAP
,microSurfaceTexel
#endif
#ifdef DETAIL
,detailColor
,vDetailInfos
#endif
);float microSurface=reflectivityOut.microSurface;float roughness=reflectivityOut.roughness;float diffuseRoughness=reflectivityOut.diffuseRoughness;
#ifdef METALLICWORKFLOW
surfaceAlbedo=reflectivityOut.surfaceAlbedo;
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
aoOut.ambientOcclusionColor=reflectivityOut.ambientOcclusionColor;
#endif
#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
alphaFresnelOutParams alphaFresnelOut;alphaFresnelOut=alphaFresnelBlock(
normalW,
viewDirectionW,
alpha,
microSurface
);alpha=alphaFresnelOut.alpha;
#endif
#endif
#include<pbrBlockGeometryInfo>
#ifdef ANISOTROPIC
anisotropicOutParams anisotropicOut;
#ifdef ANISOTROPIC_TEXTURE
vec3 anisotropyMapData=texture2D(anisotropySampler,vAnisotropyUV+uvOffset).rgb*vAnisotropyInfos.y;
#endif
anisotropicOut=anisotropicBlock(
vAnisotropy,
roughness,
#ifdef ANISOTROPIC_TEXTURE
anisotropyMapData,
#endif
TBN,
normalW,
viewDirectionW
);
#endif
#ifdef REFLECTION
reflectionOutParams reflectionOut;
#ifndef USE_CUSTOM_REFLECTION
reflectionOut=reflectionBlock(
vPositionW
,normalW
,alphaG
,vReflectionMicrosurfaceInfos
,vReflectionInfos
,vReflectionColor
#ifdef ANISOTROPIC
,anisotropicOut
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,NdotVUnclamped
#endif
#ifdef LINEARSPECULARREFLECTION
,roughness
#endif
,reflectionSampler
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
,vEnvironmentIrradiance
#endif
#if (defined(USESPHERICALFROMREFLECTIONMAP) && (!defined(NORMAL) || !defined(USESPHERICALINVERTEX))) || (defined(USEIRRADIANCEMAP) && defined(REFLECTIONMAP_3D))
,reflectionMatrix
#endif
#ifdef USEIRRADIANCEMAP
,irradianceSampler
#ifdef USE_IRRADIANCE_DOMINANT_DIRECTION
,vReflectionDominantDirection
#endif
#endif
#ifndef LODBASEDMICROSFURACE
,reflectionSamplerLow
,reflectionSamplerHigh
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#ifdef IBL_CDF_FILTERING
,icdfSampler
#endif
#endif
,viewDirectionW
,diffuseRoughness
,baseColor
);
#else
#define CUSTOM_REFLECTION
#endif
#endif
#include<pbrBlockReflectance0>
#ifdef SHEEN
sheenOutParams sheenOut;
#ifdef SHEEN_TEXTURE
vec4 sheenMapData=texture2D(sheenSampler,vSheenUV+uvOffset);
#endif
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
vec4 sheenMapRoughnessData=texture2D(sheenRoughnessSampler,vSheenRoughnessUV+uvOffset)*vSheenInfos.w;
#endif
sheenOut=sheenBlock(
vSheenColor
#ifdef SHEEN_ROUGHNESS
,vSheenRoughness
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
,sheenMapRoughnessData
#endif
#endif
,roughness
#ifdef SHEEN_TEXTURE
,sheenMapData
,vSheenInfos.y
#endif
,reflectanceF0
#ifdef SHEEN_LINKWITHALBEDO
,baseColor
,surfaceAlbedo
#endif
#ifdef ENVIRONMENTBRDF
,NdotV
,environmentBrdf
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
,AARoughnessFactors
,vReflectionMicrosurfaceInfos
,vReflectionInfos
,vReflectionColor
,vLightingIntensity
,reflectionSampler
,reflectionOut.reflectionCoords
,NdotVUnclamped
#ifndef LODBASEDMICROSFURACE
,reflectionSamplerLow
,reflectionSamplerHigh
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
,seo
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
,eho
#endif
#endif
);
#ifdef SHEEN_LINKWITHALBEDO
surfaceAlbedo=sheenOut.surfaceAlbedo;
#endif
#endif
#ifdef CLEARCOAT
#ifdef CLEARCOAT_TEXTURE
vec2 clearCoatMapData=texture2D(clearCoatSampler,vClearCoatUV+uvOffset).rg*vClearCoatInfos.y;
#endif
#endif
#ifdef IRIDESCENCE
iridescenceOutParams iridescenceOut;
#ifdef IRIDESCENCE_TEXTURE
vec2 iridescenceMapData=texture2D(iridescenceSampler,vIridescenceUV+uvOffset).rg*vIridescenceInfos.y;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
vec2 iridescenceThicknessMapData=texture2D(iridescenceThicknessSampler,vIridescenceThicknessUV+uvOffset).rg*vIridescenceInfos.w;
#endif
iridescenceOut=iridescenceBlock(
vIridescenceParams
,NdotV
,specularEnvironmentR0
#ifdef IRIDESCENCE_TEXTURE
,iridescenceMapData
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
,iridescenceThicknessMapData
#endif
#ifdef CLEARCOAT
,NdotVUnclamped
,vClearCoatParams
#ifdef CLEARCOAT_TEXTURE
,clearCoatMapData
#endif
#endif
);float iridescenceIntensity=iridescenceOut.iridescenceIntensity;specularEnvironmentR0=iridescenceOut.specularEnvironmentR0;
#endif
clearcoatOutParams clearcoatOut;
#ifdef CLEARCOAT
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
vec4 clearCoatMapRoughnessData=texture2D(clearCoatRoughnessSampler,vClearCoatRoughnessUV+uvOffset)*vClearCoatInfos.w;
#endif
#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
vec4 clearCoatTintMapData=texture2D(clearCoatTintSampler,vClearCoatTintUV+uvOffset);
#endif
#ifdef CLEARCOAT_BUMP
vec4 clearCoatBumpMapData=texture2D(clearCoatBumpSampler,vClearCoatBumpUV+uvOffset);
#endif
clearcoatOut=clearcoatBlock(
vPositionW
,geometricNormalW
,viewDirectionW
,vClearCoatParams
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
,clearCoatMapRoughnessData
#endif
,specularEnvironmentR0
#ifdef CLEARCOAT_TEXTURE
,clearCoatMapData
#endif
#ifdef CLEARCOAT_TINT
,vClearCoatTintParams
,clearCoatColorAtDistance
,vClearCoatRefractionParams
#ifdef CLEARCOAT_TINT_TEXTURE
,clearCoatTintMapData
#endif
#endif
#ifdef CLEARCOAT_BUMP
,vClearCoatBumpInfos
,clearCoatBumpMapData
,vClearCoatBumpUV
#if defined(TANGENT) && defined(NORMAL)
,vTBN
#else
,vClearCoatTangentSpaceParams
#endif
#ifdef OBJECTSPACE_NORMALMAP
,normalMatrix
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
,faceNormal
#endif
#ifdef REFLECTION
,vReflectionMicrosurfaceInfos
,vReflectionInfos
,vReflectionColor
,vLightingIntensity
,reflectionSampler
#ifndef LODBASEDMICROSFURACE
,reflectionSamplerLow
,reflectionSamplerHigh
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
,(gl_FrontFacing ? 1. : -1.)
#endif
);
#else
clearcoatOut.specularEnvironmentR0=specularEnvironmentR0;
#endif
#include<pbrBlockReflectance>
subSurfaceOutParams subSurfaceOut;
#ifdef SUBSURFACE
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec4 thicknessMap=texture2D(thicknessSampler,vThicknessUV+uvOffset);
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
vec4 refractionIntensityMap=texture2D(refractionIntensitySampler,vRefractionIntensityUV+uvOffset);
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
vec4 translucencyIntensityMap=texture2D(translucencyIntensitySampler,vTranslucencyIntensityUV+uvOffset);
#endif
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
vec4 translucencyColorMap=texture2D(translucencyColorSampler,vTranslucencyColorUV+uvOffset);
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE_GAMMA
translucencyColorMap=toLinearSpace(translucencyColorMap);
#endif
#endif
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
vec3 vSpecularEnvironmentReflectance=vec3(max(colorSpecularEnvironmentReflectance.r,max(colorSpecularEnvironmentReflectance.g,colorSpecularEnvironmentReflectance.b)));
#endif
subSurfaceOut=subSurfaceBlock(
vSubSurfaceIntensity
,vThicknessParam
,vTintColor
,normalW
#ifdef LEGACY_SPECULAR_ENERGY_CONSERVATION
,vSpecularEnvironmentReflectance
#else
,baseSpecularEnvironmentReflectance
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
,thicknessMap
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
,refractionIntensityMap
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
,translucencyIntensityMap
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
,reflectionMatrix
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
,reflectionOut.irradianceVector
#endif
#if defined(REALTIME_FILTERING)
,reflectionSampler
,vReflectionFilteringInfo
#ifdef IBL_CDF_FILTERING
,icdfSampler
#endif
#endif
#endif
#ifdef USEIRRADIANCEMAP
,irradianceSampler
#endif
#endif
#endif
#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
,surfaceAlbedo
#endif
#ifdef SS_REFRACTION
,vPositionW
,viewDirectionW
,view
,vRefractionInfos
,refractionMatrix
,vRefractionMicrosurfaceInfos
,vLightingIntensity
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
,alpha
#endif
#ifdef SS_LODINREFRACTIONALPHA
,NdotVUnclamped
#endif
#ifdef SS_LINEARSPECULARREFRACTION
,roughness
#endif
,alphaG
,refractionSampler
#ifndef LODBASEDMICROSFURACE
,refractionSamplerLow
,refractionSamplerHigh
#endif
#ifdef ANISOTROPIC
,anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,vRefractionPosition
,vRefractionSize
#endif
#ifdef SS_DISPERSION
,dispersion
#endif
#endif
#ifdef SS_TRANSLUCENCY
,vDiffusionDistance
,vTranslucencyColor
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
,translucencyColorMap
#endif
#endif
);
#ifdef SS_REFRACTION
surfaceAlbedo=subSurfaceOut.surfaceAlbedo;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
alpha=subSurfaceOut.alpha;
#endif
#endif
#else
subSurfaceOut.specularEnvironmentReflectance=colorSpecularEnvironmentReflectance;
#endif
#include<pbrBlockDirectLighting>
#include<lightFragment>[0..maxSimultaneousLights]
#include<pbrBlockFinalLitComponents>
#endif 
#include<pbrBlockFinalUnlitComponents>
#define CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION
#include<pbrBlockFinalColorComposition>
#include<logDepthFragment>
#include<fogFragment>(color,finalColor)
#include<pbrBlockImageProcessing>
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
#include<pbrBlockPrePass>
#endif
#if !defined(PREPASS) || defined(WEBGL2)
gl_FragColor=finalColor;
#endif
#include<oitFragment>
#if ORDER_INDEPENDENT_TRANSPARENCY
if (fragDepth==nearestDepth) {frontColor.rgb+=finalColor.rgb*finalColor.a*alphaMultiplier;frontColor.a=1.0-alphaMultiplier*(1.0-finalColor.a);} else {backColor+=finalColor;}
#endif
#include<pbrDebug>
#define CUSTOM_FRAGMENT_MAIN_END
}
`;g.ShadersStore[FI]||(g.ShadersStore[FI]=mV);zee={name:FI,shader:mV}});var Of,q_,Ft,Q_=S(()=>{Ye();je();Ee();bn();HC();Xr();ie();yt();L2();XC();it();Xc();cs();fs();yf();Ut();fn();Zh();bo();w2();F2();N2();B2();U2();JC();rn();Xi();N_();Of={effect:null,subMesh:null},q_=class extends ri{constructor(e){super(e),this.PBR=!0,this.NUM_SAMPLES="0",this.REALTIME_FILTERING=!1,this.IBL_CDF_FILTERING=!1,this.MAINUV1=!1,this.MAINUV2=!1,this.MAINUV3=!1,this.MAINUV4=!1,this.MAINUV5=!1,this.MAINUV6=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.ALBEDO=!1,this.GAMMAALBEDO=!1,this.ALBEDODIRECTUV=0,this.VERTEXCOLOR=!1,this.BASE_WEIGHT=!1,this.BASE_WEIGHTDIRECTUV=0,this.BASE_DIFFUSE_ROUGHNESS=!1,this.BASE_DIFFUSE_ROUGHNESSDIRECTUV=0,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.AMBIENTINGRAYSCALE=!1,this.OPACITY=!1,this.VERTEXALPHA=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHABLEND=!1,this.ALPHAFROMALBEDO=!1,this.ALPHATESTVALUE="0.5",this.SPECULAROVERALPHA=!1,this.RADIANCEOVERALPHA=!1,this.ALPHAFRESNEL=!1,this.LINEARALPHAFRESNEL=!1,this.PREMULTIPLYALPHA=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.GAMMAEMISSIVE=!1,this.REFLECTIVITY=!1,this.REFLECTIVITY_GAMMA=!1,this.REFLECTIVITYDIRECTUV=0,this.SPECULARTERM=!1,this.MICROSURFACEFROMREFLECTIVITYMAP=!1,this.MICROSURFACEAUTOMATIC=!1,this.LODBASEDMICROSFURACE=!1,this.MICROSURFACEMAP=!1,this.MICROSURFACEMAPDIRECTUV=0,this.METALLICWORKFLOW=!1,this.ROUGHNESSSTOREINMETALMAPALPHA=!1,this.ROUGHNESSSTOREINMETALMAPGREEN=!1,this.METALLNESSSTOREINMETALMAPBLUE=!1,this.AOSTOREINMETALMAPRED=!1,this.METALLIC_REFLECTANCE=!1,this.METALLIC_REFLECTANCE_GAMMA=!1,this.METALLIC_REFLECTANCEDIRECTUV=0,this.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=!1,this.REFLECTANCE=!1,this.REFLECTANCE_GAMMA=!1,this.REFLECTANCEDIRECTUV=0,this.ENVIRONMENTBRDF=!1,this.ENVIRONMENTBRDF_RGBD=!1,this.NORMAL=!1,this.TANGENT=!1,this.BUMP=!1,this.BUMPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.PARALLAX=!1,this.PARALLAX_RHS=!1,this.PARALLAXOCCLUSION=!1,this.NORMALXYSCALE=!0,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.USELIGHTMAPASSHADOWMAP=!1,this.GAMMALIGHTMAP=!1,this.RGBDLIGHTMAP=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.USESPHERICALFROMREFLECTIONMAP=!1,this.USEIRRADIANCEMAP=!1,this.USE_IRRADIANCE_DOMINANT_DIRECTION=!1,this.USESPHERICALINVERTEX=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.LINEARSPECULARREFLECTION=!1,this.RADIANCEOCCLUSION=!1,this.HORIZONOCCLUSION=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.PREPASS=!1,this.PREPASS_COLOR=!1,this.PREPASS_COLOR_INDEX=-1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO=!1,this.PREPASS_ALBEDO_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_SCREENSPACE_DEPTH=!1,this.PREPASS_SCREENSPACE_DEPTH_INDEX=-1,this.PREPASS_NORMALIZED_VIEW_DEPTH=!1,this.PREPASS_NORMALIZED_VIEW_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_NORMAL_WORLDSPACE=!1,this.PREPASS_WORLD_NORMAL=!1,this.PREPASS_WORLD_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_LOCAL_POSITION=!1,this.PREPASS_LOCAL_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_VELOCITY_LINEAR=!1,this.PREPASS_VELOCITY_LINEAR_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.NONUNIFORMSCALING=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_POSITION=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.MORPHTARGETS_UV2=!1,this.MORPHTARGETS_COLOR=!1,this.MORPHTARGETTEXTURE_HASPOSITIONS=!1,this.MORPHTARGETTEXTURE_HASNORMALS=!1,this.MORPHTARGETTEXTURE_HASTANGENTS=!1,this.MORPHTARGETTEXTURE_HASUVS=!1,this.MORPHTARGETTEXTURE_HASUV2S=!1,this.MORPHTARGETTEXTURE_HASCOLORS=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=0,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.EXPOSURE=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.USEPHYSICALLIGHTFALLOFF=!1,this.USEGLTFLIGHTFALLOFF=!1,this.TWOSIDEDLIGHTING=!1,this.MIRRORED=!1,this.SHADOWFLOAT=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.LOGARITHMICDEPTH=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.AREALIGHTSUPPORTED=!0,this.FORCENORMALFORWARD=!1,this.SPECULARAA=!1,this.UNLIT=!1,this.DECAL_AFTER_DETAIL=!1,this.DEBUGMODE=0,this.USE_VERTEX_PULLING=!1,this.rebuild()}reset(){super.reset(),this.ALPHATESTVALUE="0.5",this.PBR=!0,this.NORMALXYSCALE=!0}},Ft=class s extends Fs{get realTimeFiltering(){return this._realTimeFiltering}set realTimeFiltering(e){this._realTimeFiltering=e,this.markAsDirty(1)}get realTimeFilteringQuality(){return this._realTimeFilteringQuality}set realTimeFilteringQuality(e){this._realTimeFilteringQuality=e,this.markAsDirty(1)}get canRenderToMRT(){return!0}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._markAllSubMeshesAsImageProcessingDirty()})))}constructor(e,t,i=!1){super(e,t,void 0,i||s.ForceGLSL),this._directIntensity=1,this._emissiveIntensity=1,this._environmentIntensity=1,this._specularIntensity=1,this._lightingInfos=new Oe(this._directIntensity,this._emissiveIntensity,this._environmentIntensity,this._specularIntensity),this._disableBumpMap=!1,this._albedoTexture=null,this._baseWeightTexture=null,this._baseDiffuseRoughnessTexture=null,this._ambientTexture=null,this._ambientTextureStrength=1,this._ambientTextureImpactOnAnalyticalLights=s.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._reflectivityTexture=null,this._metallicTexture=null,this._metallic=null,this._roughness=null,this._metallicF0Factor=1,this._metallicReflectanceColor=j.White(),this._useOnlyMetallicFromMetallicReflectanceTexture=!1,this._metallicReflectanceTexture=null,this._reflectanceTexture=null,this._microSurfaceTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._ambientColor=new j(0,0,0),this._albedoColor=new j(1,1,1),this._baseWeight=1,this._baseDiffuseRoughness=null,this._reflectivityColor=new j(1,1,1),this._reflectionColor=new j(1,1,1),this._emissiveColor=new j(0,0,0),this._microSurface=.9,this._useLightmapAsShadowmap=!1,this._useHorizonOcclusion=!0,this._useRadianceOcclusion=!0,this._useAlphaFromAlbedoTexture=!1,this._useSpecularOverAlpha=!0,this._useMicroSurfaceFromReflectivityMapAlpha=!1,this._useRoughnessFromMetallicTextureAlpha=!0,this._useRoughnessFromMetallicTextureGreen=!1,this._useMetallnessFromMetallicTextureBlue=!1,this._useAmbientOcclusionFromMetallicTextureRed=!1,this._useAmbientInGrayScale=!1,this._useAutoMicroSurfaceFromReflectivityMap=!1,this._lightFalloff=s.LIGHTFALLOFF_PHYSICAL,this._useRadianceOverAlpha=!0,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this._parallaxScaleBias=.05,this._disableLighting=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._alphaCutOff=.4,this._useAlphaFresnel=!1,this._useLinearAlphaFresnel=!1,this._environmentBRDFTexture=null,this._forceIrradianceInFragment=!1,this._realTimeFiltering=!1,this._realTimeFilteringQuality=8,this._forceNormalForward=!1,this._enableSpecularAntiAliasing=!1,this._imageProcessingObserver=null,this._renderTargets=new wt(16),this._globalAmbientColor=new j(0,0,0),this._unlit=!1,this._applyDecalMapAfterDetailMap=!1,this._debugMode=0,this._shadersLoaded=!1,this._breakShaderLoadedCheck=!1,this.debugMode=0,this.debugLimit=-1,this.debugFactor=1,this._cacheHasRenderTargetTextures=!1,this.brdf=new pi(this),this.clearCoat=new Oi(this),this.iridescence=new qr(this),this.anisotropy=new Ka(this),this.sheen=new hs(this),this.subSurface=new Tt(this),this.detailMap=new Ns(this),this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),X.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets),this._environmentBRDFTexture=F_(this.getScene()),this.prePassConfiguration=new Qn}get hasRenderTargetTextures(){return X.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget?!0:this._cacheHasRenderTargetTextures}get isPrePassCapable(){return!this.disableDepthWrite}getClassName(){return"PBRBaseMaterial"}get _disableAlphaBlending(){return this._transparencyMode===s.PBRMATERIAL_OPAQUE||this._transparencyMode===s.PBRMATERIAL_ALPHATEST||this.subSurface?.disableAlphaBlending}needAlphaBlending(){return this._hasTransparencyMode?this._transparencyModeIsBlend:this._disableAlphaBlending?!1:this.alpha<1||this._opacityTexture!=null||this._shouldUseAlphaFromAlbedoTexture()}needAlphaTesting(){return this._hasTransparencyMode?this._transparencyModeIsTest:this.subSurface?.disableAlphaBlending?!1:this._hasAlphaChannel()&&(this._transparencyMode==null||this._transparencyMode===s.PBRMATERIAL_ALPHATEST)}_shouldUseAlphaFromAlbedoTexture(){return this._albedoTexture!=null&&this._albedoTexture.hasAlpha&&this._useAlphaFromAlbedoTexture&&this._transparencyMode!==s.PBRMATERIAL_OPAQUE}_hasAlphaChannel(){return this._albedoTexture!=null&&this._albedoTexture.hasAlpha||this._opacityTexture!=null}getAlphaTestTexture(){return this._albedoTexture}isReadyForSubMesh(e,t,i){this._uniformBufferLayoutBuilt||this.buildUniformLayout();let r=t._drawWrapper;if(r.effect&&this.isFrozen&&r._wasPreviouslyReady&&r._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(this._callbackPluginEventGeneric(4,this._eventInfo),t.materialDefines=new q_(this._eventInfo.defineNames));let n=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;let a=this.getScene(),o=a.getEngine();if(n._areTexturesDirty&&(this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,a.texturesEnabled)){if(this._albedoTexture&&X.DiffuseTextureEnabled&&!this._albedoTexture.isReadyOrNotBlocking()||this._baseWeightTexture&&X.BaseWeightTextureEnabled&&!this._baseWeightTexture.isReadyOrNotBlocking()||this._baseDiffuseRoughnessTexture&&X.BaseDiffuseRoughnessTextureEnabled&&!this._baseDiffuseRoughnessTexture.isReadyOrNotBlocking()||this._ambientTexture&&X.AmbientTextureEnabled&&!this._ambientTexture.isReadyOrNotBlocking()||this._opacityTexture&&X.OpacityTextureEnabled&&!this._opacityTexture.isReadyOrNotBlocking())return!1;let u=this._getReflectionTexture();if(u&&X.ReflectionTextureEnabled){if(!u.isReadyOrNotBlocking())return!1;if(u.irradianceTexture){if(!u.irradianceTexture.isReadyOrNotBlocking())return!1}else if(!u.sphericalPolynomial&&u.getInternalTexture()?._sphericalPolynomialPromise)return!1}if(this._lightmapTexture&&X.LightmapTextureEnabled&&!this._lightmapTexture.isReadyOrNotBlocking()||this._emissiveTexture&&X.EmissiveTextureEnabled&&!this._emissiveTexture.isReadyOrNotBlocking())return!1;if(X.SpecularTextureEnabled){if(this._metallicTexture){if(!this._metallicTexture.isReadyOrNotBlocking())return!1}else if(this._reflectivityTexture&&!this._reflectivityTexture.isReadyOrNotBlocking())return!1;if(this._metallicReflectanceTexture&&!this._metallicReflectanceTexture.isReadyOrNotBlocking()||this._reflectanceTexture&&!this._reflectanceTexture.isReadyOrNotBlocking()||this._microSurfaceTexture&&!this._microSurfaceTexture.isReadyOrNotBlocking())return!1}if(o.getCaps().standardDerivatives&&this._bumpTexture&&X.BumpTextureEnabled&&!this._disableBumpMap&&!this._bumpTexture.isReady()||this._environmentBRDFTexture&&X.ReflectionTextureEnabled&&!this._environmentBRDFTexture.isReady())return!1}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=n,this._eventInfo.subMesh=t,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh||n._areImageProcessingDirty&&this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady())return!1;if(n.AREALIGHTUSED||n.CLUSTLIGHT_BATCH){for(let u=0;u<e.lightSources.length;u++)if(!e.lightSources[u]._isReady())return!1}!o.getCaps().standardDerivatives&&!e.isVerticesDataPresent(A.NormalKind)&&(e.createNormals(!0),P.Warn("PBRMaterial: Normals have been created for the mesh: "+e.name));let l=t.effect,c=n._areLightsDisposed,f=this._prepareEffect(e,t.getRenderingMesh(),n,this.onCompiled,this.onError,i,null),h=!1;if(f)if(this._onEffectCreatedObservable&&(Of.effect=f,Of.subMesh=t,this._onEffectCreatedObservable.notifyObservers(Of)),this.allowShaderHotSwapping&&l&&!f.isReady()){if(f=l,n.markAsUnprocessed(),h=this.isFrozen,c)return n._areLightsDisposed=!0,!1}else a.resetCachedMaterial(),t.setEffect(f,n,this._materialContext);return!t.effect||!t.effect.isReady()?!1:(n._renderId=a.getRenderId(),r._wasPreviouslyReady=!h,r._wasPreviouslyUsingInstances=!!i,this._checkScenePerformancePriority(),!0)}isMetallicWorkflow(){return!!(this._metallic!=null||this._roughness!=null||this._metallicTexture)}_prepareEffect(e,t,i,r=null,n=null,a=null,o=null){if(this._prepareDefines(e,t,i,a,o),!i.isDirty)return null;i.markAsProcessed();let c=this.getScene().getEngine(),f=new or,h=0;i.USESPHERICALINVERTEX&&f.addFallback(h++,"USESPHERICALINVERTEX"),i.FOG&&f.addFallback(h,"FOG"),i.SPECULARAA&&f.addFallback(h,"SPECULARAA"),i.POINTSIZE&&f.addFallback(h,"POINTSIZE"),i.LOGARITHMICDEPTH&&f.addFallback(h,"LOGARITHMICDEPTH"),i.PARALLAX&&f.addFallback(h,"PARALLAX"),i.PARALLAX_RHS&&f.addFallback(h,"PARALLAX_RHS"),i.PARALLAXOCCLUSION&&f.addFallback(h++,"PARALLAXOCCLUSION"),i.ENVIRONMENTBRDF&&f.addFallback(h++,"ENVIRONMENTBRDF"),i.TANGENT&&f.addFallback(h++,"TANGENT"),i.BUMP&&f.addFallback(h++,"BUMP"),h=$c(i,f,this._maxSimultaneousLights,h++),i.SPECULARTERM&&f.addFallback(h++,"SPECULARTERM"),i.USESPHERICALFROMREFLECTIONMAP&&f.addFallback(h++,"USESPHERICALFROMREFLECTIONMAP"),i.USEIRRADIANCEMAP&&f.addFallback(h++,"USEIRRADIANCEMAP"),i.LIGHTMAP&&f.addFallback(h++,"LIGHTMAP"),i.NORMAL&&f.addFallback(h++,"NORMAL"),i.AMBIENT&&f.addFallback(h++,"AMBIENT"),i.EMISSIVE&&f.addFallback(h++,"EMISSIVE"),i.VERTEXCOLOR&&f.addFallback(h++,"VERTEXCOLOR"),i.MORPHTARGETS&&f.addFallback(h++,"MORPHTARGETS"),i.MULTIVIEW&&f.addFallback(0,"MULTIVIEW");let u=[A.PositionKind];i.NORMAL&&u.push(A.NormalKind),i.TANGENT&&u.push(A.TangentKind);for(let R=1;R<=6;++R)i["UV"+R]&&u.push(`uv${R===1?"":R}`);i.VERTEXCOLOR&&u.push(A.ColorKind),Jc(u,e,i,f),Io(u,i),Kh(u,e,i),jc(u,e,i);let d="pbr",p=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vAlbedoColor","baseWeight","baseDiffuseRoughness","vReflectivityColor","vMetallicReflectanceFactors","vEmissiveColor","visibility","vReflectionColor","vFogInfos","vFogColor","pointSize","vAlbedoInfos","vBaseWeightInfos","vBaseDiffuseRoughnessInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vReflectionPosition","vReflectionSize","vEmissiveInfos","vReflectivityInfos","vReflectionFilteringInfo","vMetallicReflectanceInfos","vReflectanceInfos","vMicroSurfaceSamplerInfos","vBumpInfos","vLightmapInfos","mBones","albedoMatrix","baseWeightMatrix","baseDiffuseRoughnessMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","reflectivityMatrix","normalMatrix","microSurfaceSamplerMatrix","bumpMatrix","lightmapMatrix","metallicReflectanceMatrix","reflectanceMatrix","vLightingIntensity","logarithmicDepthConstant","vSphericalX","vSphericalY","vSphericalZ","vSphericalXX_ZZ","vSphericalYY_ZZ","vSphericalZZ","vSphericalXY","vSphericalYZ","vSphericalZX","vSphericalL00","vSphericalL1_1","vSphericalL10","vSphericalL11","vSphericalL2_2","vSphericalL2_1","vSphericalL20","vSphericalL21","vSphericalL22","vReflectionMicrosurfaceInfos","vReflectionDominantDirection","vTangentSpaceParams","boneTextureWidth","vDebugMode","morphTargetTextureInfo","morphTargetTextureIndices","cameraInfo"],m=["albedoSampler","baseWeightSampler","baseDiffuseRoughnessSampler","reflectivitySampler","ambientSampler","emissiveSampler","bumpSampler","lightmapSampler","opacitySampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh","irradianceSampler","microSurfaceSampler","environmentBrdfSampler","boneSampler","metallicReflectanceSampler","reflectanceSampler","morphTargets","oitDepthSampler","oitFrontColorSampler","icdfSampler","areaLightsLTC1Sampler","areaLightsLTC2Sampler"],_=["Material","Scene","Mesh"],v={maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:i.NUM_MORPH_INFLUENCERS};this._eventInfo.fallbacks=f,this._eventInfo.fallbackRank=h,this._eventInfo.defines=i,this._eventInfo.uniforms=p,this._eventInfo.attributes=u,this._eventInfo.samplers=m,this._eventInfo.uniformBuffersNames=_,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._eventInfo.indexParameters=v,this._callbackPluginEventGeneric(128,this._eventInfo),si.AddUniformsAndSamplers(p,m),Qn.AddUniforms(p),Qn.AddSamplers(m),Hi(p),Ve&&(Ve.PrepareUniforms(p,i),Ve.PrepareSamplers(m,i)),Do({uniformsNames:p,uniformBuffersNames:_,samplers:m,defines:i,maxSimultaneousLights:this._maxSimultaneousLights});let T={};this.customShaderNameResolve&&(d=this.customShaderNameResolve(d,p,_,m,i,u,T));let C=i.toString(),I=c.createEffect(d,{attributes:u,uniformsNames:p,uniformBuffersNames:_,samplers:m,defines:C,fallbacks:f,onCompiled:r,onError:n,indexParameters:v,processFinalCode:T.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:i.PREPASS,shaderLanguage:this._shaderLanguage,extraInitializationsAsync:this._shadersLoaded?void 0:async()=>{this.shaderLanguage===1?await Promise.all([Promise.resolve().then(()=>(tU(),eU)),Promise.resolve().then(()=>(R3(),A3))]):await Promise.all([Promise.resolve().then(()=>(H3(),W3)),Promise.resolve().then(()=>(gV(),_V))]),this._shadersLoaded=!0}},c);return this._eventInfo.customCode=void 0,I}_prepareDefines(e,t,i,r=null,n=null){let a=t.hasThinInstances,o=this.getScene(),l=o.getEngine();ef(o,e,i,!0,this._maxSimultaneousLights,this._disableLighting),i._needNormals=!0,tf(o,i);let c=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(wm(o,i,this.canRenderToMRT&&!c),Lm(o,i,c),si.PrepareDefines(l.currentRenderPassId,e,i),i.METALLICWORKFLOW=this.isMetallicWorkflow(),i._areTexturesDirty){i._needUVs=!1;for(let f=1;f<=6;++f)i["MAINUV"+f]=!1;if(o.texturesEnabled){i.ALBEDODIRECTUV=0,i.BASE_WEIGHTDIRECTUV=0,i.BASE_DIFFUSE_ROUGHNESSDIRECTUV=0,i.AMBIENTDIRECTUV=0,i.OPACITYDIRECTUV=0,i.EMISSIVEDIRECTUV=0,i.REFLECTIVITYDIRECTUV=0,i.MICROSURFACEMAPDIRECTUV=0,i.METALLIC_REFLECTANCEDIRECTUV=0,i.REFLECTANCEDIRECTUV=0,i.BUMPDIRECTUV=0,i.LIGHTMAPDIRECTUV=0,l.getCaps().textureLOD&&(i.LODBASEDMICROSFURACE=!0),this._albedoTexture&&X.DiffuseTextureEnabled?(lt(this._albedoTexture,i,"ALBEDO"),i.GAMMAALBEDO=this._albedoTexture.gammaSpace):i.ALBEDO=!1,this._baseWeightTexture&&X.BaseWeightTextureEnabled?lt(this._baseWeightTexture,i,"BASE_WEIGHT"):i.BASE_WEIGHT=!1,this._baseDiffuseRoughnessTexture&&X.BaseDiffuseRoughnessTextureEnabled?lt(this._baseDiffuseRoughnessTexture,i,"BASE_DIFFUSE_ROUGHNESS"):i.BASE_DIFFUSE_ROUGHNESS=!1,this._ambientTexture&&X.AmbientTextureEnabled?(lt(this._ambientTexture,i,"AMBIENT"),i.AMBIENTINGRAYSCALE=this._useAmbientInGrayScale):i.AMBIENT=!1,this._opacityTexture&&X.OpacityTextureEnabled?(lt(this._opacityTexture,i,"OPACITY"),i.OPACITYRGB=this._opacityTexture.getAlphaFromRGB):i.OPACITY=!1;let f=this._getReflectionTexture();if(f&&X.ReflectionTextureEnabled){switch(i.REFLECTION=!0,i.GAMMAREFLECTION=f.gammaSpace,i.RGBDREFLECTION=f.isRGBD,i.LODINREFLECTIONALPHA=f.lodLevelInAlpha,i.LINEARSPECULARREFLECTION=f.linearSpecularLOD,i.USEIRRADIANCEMAP=!1,this.realTimeFiltering&&this.realTimeFilteringQuality>0?(i.NUM_SAMPLES=""+this.realTimeFilteringQuality,l._features.needTypeSuffixInShaderConstants&&(i.NUM_SAMPLES=i.NUM_SAMPLES+"u"),i.REALTIME_FILTERING=!0,this.getScene().iblCdfGenerator&&(i.IBL_CDF_FILTERING=!0)):i.REALTIME_FILTERING=!1,i.INVERTCUBICMAP=f.coordinatesMode===H.INVCUBIC_MODE,i.REFLECTIONMAP_3D=f.isCube,i.REFLECTIONMAP_OPPOSITEZ=i.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!f.invertZ:f.invertZ,i.REFLECTIONMAP_CUBIC=!1,i.REFLECTIONMAP_EXPLICIT=!1,i.REFLECTIONMAP_PLANAR=!1,i.REFLECTIONMAP_PROJECTION=!1,i.REFLECTIONMAP_SKYBOX=!1,i.REFLECTIONMAP_SPHERICAL=!1,i.REFLECTIONMAP_EQUIRECTANGULAR=!1,i.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,i.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,f.coordinatesMode){case H.EXPLICIT_MODE:i.REFLECTIONMAP_EXPLICIT=!0;break;case H.PLANAR_MODE:i.REFLECTIONMAP_PLANAR=!0;break;case H.PROJECTION_MODE:i.REFLECTIONMAP_PROJECTION=!0;break;case H.SKYBOX_MODE:i.REFLECTIONMAP_SKYBOX=!0;break;case H.SPHERICAL_MODE:i.REFLECTIONMAP_SPHERICAL=!0;break;case H.EQUIRECTANGULAR_MODE:i.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case H.FIXED_EQUIRECTANGULAR_MODE:i.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case H.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:i.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case H.CUBIC_MODE:case H.INVCUBIC_MODE:default:i.REFLECTIONMAP_CUBIC=!0,i.USE_LOCAL_REFLECTIONMAP_CUBIC=!!f.boundingBoxSize;break}f.coordinatesMode!==H.SKYBOX_MODE&&(f.irradianceTexture?(i.USEIRRADIANCEMAP=!0,i.USESPHERICALFROMREFLECTIONMAP=!1,i.USESPHERICALINVERTEX=!1,f.irradianceTexture._dominantDirection&&(i.USE_IRRADIANCE_DOMINANT_DIRECTION=!0)):f.isCube&&(i.USESPHERICALFROMREFLECTIONMAP=!0,i.USEIRRADIANCEMAP=!1,i.USE_IRRADIANCE_DOMINANT_DIRECTION=!1,this._forceIrradianceInFragment||this.realTimeFiltering||this._twoSidedLighting||l.getCaps().maxVaryingVectors<=8||this._baseDiffuseRoughnessTexture?i.USESPHERICALINVERTEX=!1:i.USESPHERICALINVERTEX=!0))}else i.REFLECTION=!1,i.REFLECTIONMAP_3D=!1,i.REFLECTIONMAP_SPHERICAL=!1,i.REFLECTIONMAP_PLANAR=!1,i.REFLECTIONMAP_CUBIC=!1,i.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,i.REFLECTIONMAP_PROJECTION=!1,i.REFLECTIONMAP_SKYBOX=!1,i.REFLECTIONMAP_EXPLICIT=!1,i.REFLECTIONMAP_EQUIRECTANGULAR=!1,i.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,i.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,i.INVERTCUBICMAP=!1,i.USESPHERICALFROMREFLECTIONMAP=!1,i.USEIRRADIANCEMAP=!1,i.USE_IRRADIANCE_DOMINANT_DIRECTION=!1,i.USESPHERICALINVERTEX=!1,i.REFLECTIONMAP_OPPOSITEZ=!1,i.LODINREFLECTIONALPHA=!1,i.GAMMAREFLECTION=!1,i.RGBDREFLECTION=!1,i.LINEARSPECULARREFLECTION=!1;this._lightmapTexture&&X.LightmapTextureEnabled?(lt(this._lightmapTexture,i,"LIGHTMAP"),i.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,i.GAMMALIGHTMAP=this._lightmapTexture.gammaSpace,i.RGBDLIGHTMAP=this._lightmapTexture.isRGBD):i.LIGHTMAP=!1,this._emissiveTexture&&X.EmissiveTextureEnabled?(lt(this._emissiveTexture,i,"EMISSIVE"),i.GAMMAEMISSIVE=this._emissiveTexture.gammaSpace):i.EMISSIVE=!1,X.SpecularTextureEnabled?(this._metallicTexture?(lt(this._metallicTexture,i,"REFLECTIVITY"),i.ROUGHNESSSTOREINMETALMAPALPHA=this._useRoughnessFromMetallicTextureAlpha,i.ROUGHNESSSTOREINMETALMAPGREEN=!this._useRoughnessFromMetallicTextureAlpha&&this._useRoughnessFromMetallicTextureGreen,i.METALLNESSSTOREINMETALMAPBLUE=this._useMetallnessFromMetallicTextureBlue,i.AOSTOREINMETALMAPRED=this._useAmbientOcclusionFromMetallicTextureRed,i.REFLECTIVITY_GAMMA=!1):this._reflectivityTexture?(lt(this._reflectivityTexture,i,"REFLECTIVITY"),i.MICROSURFACEFROMREFLECTIVITYMAP=this._useMicroSurfaceFromReflectivityMapAlpha,i.MICROSURFACEAUTOMATIC=this._useAutoMicroSurfaceFromReflectivityMap,i.REFLECTIVITY_GAMMA=this._reflectivityTexture.gammaSpace):i.REFLECTIVITY=!1,this._metallicReflectanceTexture||this._reflectanceTexture?(i.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=this._useOnlyMetallicFromMetallicReflectanceTexture,this._metallicReflectanceTexture?(lt(this._metallicReflectanceTexture,i,"METALLIC_REFLECTANCE"),i.METALLIC_REFLECTANCE_GAMMA=this._metallicReflectanceTexture.gammaSpace):i.METALLIC_REFLECTANCE=!1,this._reflectanceTexture&&(!this._metallicReflectanceTexture||this._metallicReflectanceTexture&&this._useOnlyMetallicFromMetallicReflectanceTexture)?(lt(this._reflectanceTexture,i,"REFLECTANCE"),i.REFLECTANCE_GAMMA=this._reflectanceTexture.gammaSpace):i.REFLECTANCE=!1):(i.METALLIC_REFLECTANCE=!1,i.REFLECTANCE=!1),this._microSurfaceTexture?lt(this._microSurfaceTexture,i,"MICROSURFACEMAP"):i.MICROSURFACEMAP=!1):(i.REFLECTIVITY=!1,i.MICROSURFACEMAP=!1),l.getCaps().standardDerivatives&&this._bumpTexture&&X.BumpTextureEnabled&&!this._disableBumpMap?(lt(this._bumpTexture,i,"BUMP"),this._useParallax&&this._albedoTexture&&X.DiffuseTextureEnabled?(i.PARALLAX=!0,i.PARALLAX_RHS=o.useRightHandedSystem,i.PARALLAXOCCLUSION=!!this._useParallaxOcclusion):i.PARALLAX=!1,i.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap):(i.BUMP=!1,i.PARALLAX=!1,i.PARALLAX_RHS=!1,i.PARALLAXOCCLUSION=!1,i.OBJECTSPACE_NORMALMAP=!1),this._environmentBRDFTexture&&X.ReflectionTextureEnabled?(i.ENVIRONMENTBRDF=!0,i.ENVIRONMENTBRDF_RGBD=this._environmentBRDFTexture.isRGBD):(i.ENVIRONMENTBRDF=!1,i.ENVIRONMENTBRDF_RGBD=!1),this._shouldUseAlphaFromAlbedoTexture()?i.ALPHAFROMALBEDO=!0:i.ALPHAFROMALBEDO=!1}i.SPECULAROVERALPHA=this._useSpecularOverAlpha,this._lightFalloff===s.LIGHTFALLOFF_STANDARD?(i.USEPHYSICALLIGHTFALLOFF=!1,i.USEGLTFLIGHTFALLOFF=!1):this._lightFalloff===s.LIGHTFALLOFF_GLTF?(i.USEPHYSICALLIGHTFALLOFF=!1,i.USEGLTFLIGHTFALLOFF=!0):(i.USEPHYSICALLIGHTFALLOFF=!0,i.USEGLTFLIGHTFALLOFF=!1),i.RADIANCEOVERALPHA=this._useRadianceOverAlpha,!this.backFaceCulling&&this._twoSidedLighting?i.TWOSIDEDLIGHTING=!0:i.TWOSIDEDLIGHTING=!1,i.MIRRORED=!!o._mirroredCameraPosition,i.SPECULARAA=l.getCaps().standardDerivatives&&this._enableSpecularAntiAliasing}(i._areTexturesDirty||i._areMiscDirty)&&(i.ALPHATESTVALUE=`${this._alphaCutOff}${this._alphaCutOff%1===0?".":""}`,i.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,i.ALPHABLEND=this.needAlphaBlendingForMesh(e),i.ALPHAFRESNEL=this._useAlphaFresnel||this._useLinearAlphaFresnel,i.LINEARALPHAFRESNEL=this._useLinearAlphaFresnel),i._areImageProcessingDirty&&this._imageProcessingConfiguration&&this._imageProcessingConfiguration.prepareDefines(i),i.FORCENORMALFORWARD=this._forceNormalForward,i.RADIANCEOCCLUSION=this._useRadianceOcclusion,i.HORIZONOCCLUSION=this._useHorizonOcclusion,i._areMiscDirty&&(yo(e,o,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this.needAlphaTestingForMesh(e),i,this._applyDecalMapAfterDetailMap,this._useVertexPulling,t,this._setVertexOutputInvariant),i.UNLIT=this._unlit||(this.pointsCloud||this.wireframe)&&!e.isVerticesDataPresent(A.NormalKind),i.DEBUGMODE=this._debugMode),Mo(o,l,this,i,!!r,n,a),this._eventInfo.defines=i,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),Po(e,i,!0,!0,!0,this._transparencyMode!==s.PBRMATERIAL_OPAQUE),this._callbackPluginEventPrepareDefines(this._eventInfo)}forceCompilation(e,t,i){let r={clipPlane:!1,useInstances:!1,...i};this._uniformBufferLayoutBuilt||this.buildUniformLayout(),this._callbackPluginEventGeneric(4,this._eventInfo),(()=>{if(this._breakShaderLoadedCheck)return;let a=new q_(this._eventInfo.defineNames),o=this._prepareEffect(e,e,a,void 0,void 0,r.useInstances,r.clipPlane);this._onEffectCreatedObservable&&(Of.effect=o,Of.subMesh=null,this._onEffectCreatedObservable.notifyObservers(Of)),o.isReady()?t&&t(this):o.onCompileObservable.add(()=>{t&&t(this)})})()}buildUniformLayout(){let e=this._uniformBuffer;e.addUniform("vAlbedoInfos",2),e.addUniform("vBaseWeightInfos",2),e.addUniform("vBaseDiffuseRoughnessInfos",2),e.addUniform("vAmbientInfos",4),e.addUniform("vOpacityInfos",2),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vReflectivityInfos",3),e.addUniform("vMicroSurfaceSamplerInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionFilteringInfo",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vBumpInfos",3),e.addUniform("albedoMatrix",16),e.addUniform("baseWeightMatrix",16),e.addUniform("baseDiffuseRoughnessMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("reflectivityMatrix",16),e.addUniform("microSurfaceSamplerMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("reflectionMatrix",16),e.addUniform("vReflectionColor",3),e.addUniform("vAlbedoColor",4),e.addUniform("baseWeight",1),e.addUniform("baseDiffuseRoughness",1),e.addUniform("vLightingIntensity",4),e.addUniform("vReflectionMicrosurfaceInfos",3),e.addUniform("vReflectionDominantDirection",3),e.addUniform("pointSize",1),e.addUniform("vReflectivityColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vAmbientColor",3),e.addUniform("vDebugMode",2),e.addUniform("vMetallicReflectanceFactors",4),e.addUniform("vMetallicReflectanceInfos",2),e.addUniform("metallicReflectanceMatrix",16),e.addUniform("vReflectanceInfos",2),e.addUniform("reflectanceMatrix",16),e.addUniform("vSphericalL00",3),e.addUniform("vSphericalL1_1",3),e.addUniform("vSphericalL10",3),e.addUniform("vSphericalL11",3),e.addUniform("vSphericalL2_2",3),e.addUniform("vSphericalL2_1",3),e.addUniform("vSphericalL20",3),e.addUniform("vSphericalL21",3),e.addUniform("vSphericalL22",3),e.addUniform("vSphericalX",3),e.addUniform("vSphericalY",3),e.addUniform("vSphericalZ",3),e.addUniform("vSphericalXX_ZZ",3),e.addUniform("vSphericalYY_ZZ",3),e.addUniform("vSphericalZZ",3),e.addUniform("vSphericalXY",3),e.addUniform("vSphericalYZ",3),e.addUniform("vSphericalZX",3),e.addUniform("cameraInfo",4),super.buildUniformLayout()}bindForSubMesh(e,t,i){let r=this.getScene(),n=i.materialDefines;if(!n)return;let a=i.effect;if(!a)return;this._activeEffect=a,t.getMeshUniformBuffer().bindToEffect(a,"Mesh"),t.transferToEffect(e);let o=r.getEngine();this._uniformBuffer.bindToEffect(a,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,r,t,e,this.isFrozen),si.Bind(o.currentRenderPassId,this._activeEffect,t,e,this);let l=r.activeCamera;l?this._uniformBuffer.updateFloat4("cameraInfo",l.minZ,l.maxZ,0,0):this._uniformBuffer.updateFloat4("cameraInfo",0,0,0,0),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),n.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));let c=this._mustRebind(r,a,i,t.visibility);Nn(t,this._activeEffect,this.prePassConfiguration);let f=null,h=this._uniformBuffer;if(c){if(this.bindViewProjection(a),f=this._getReflectionTexture(),!h.useUbo||!this.isFrozen||!h.isSync||i._drawWrapper._forceRebindOnNextCall){if(r.texturesEnabled){if(this._albedoTexture&&X.DiffuseTextureEnabled&&(h.updateFloat2("vAlbedoInfos",this._albedoTexture.coordinatesIndex,this._albedoTexture.level),ct(this._albedoTexture,h,"albedo")),this._baseWeightTexture&&X.BaseWeightTextureEnabled&&(h.updateFloat2("vBaseWeightInfos",this._baseWeightTexture.coordinatesIndex,this._baseWeightTexture.level),ct(this._baseWeightTexture,h,"baseWeight")),this._baseDiffuseRoughnessTexture&&X.BaseDiffuseRoughnessTextureEnabled&&(h.updateFloat2("vBaseDiffuseRoughnessInfos",this._baseDiffuseRoughnessTexture.coordinatesIndex,this._baseDiffuseRoughnessTexture.level),ct(this._baseDiffuseRoughnessTexture,h,"baseDiffuseRoughness")),this._ambientTexture&&X.AmbientTextureEnabled&&(h.updateFloat4("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level,this._ambientTextureStrength,this._ambientTextureImpactOnAnalyticalLights),ct(this._ambientTexture,h,"ambient")),this._opacityTexture&&X.OpacityTextureEnabled&&(h.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),ct(this._opacityTexture,h,"opacity")),f&&X.ReflectionTextureEnabled){if(h.updateMatrix("reflectionMatrix",f.getReflectionTextureMatrix()),h.updateFloat2("vReflectionInfos",f.level*r.iblIntensity,0),f.boundingBoxSize){let u=f;h.updateVector3("vReflectionPosition",u.boundingBoxPosition),h.updateVector3("vReflectionSize",u.boundingBoxSize)}if(this.realTimeFiltering){let u=f.getSize().width;h.updateFloat2("vReflectionFilteringInfo",u,Math.log2(u))}if(n.USEIRRADIANCEMAP)n.USEIRRADIANCEMAP&&n.USE_IRRADIANCE_DOMINANT_DIRECTION&&h.updateVector3("vReflectionDominantDirection",f.irradianceTexture._dominantDirection);else{let u=f.sphericalPolynomial;if(n.USESPHERICALFROMREFLECTIONMAP&&u)if(n.SPHERICAL_HARMONICS){let d=u.preScaledHarmonics;h.updateVector3("vSphericalL00",d.l00),h.updateVector3("vSphericalL1_1",d.l1_1),h.updateVector3("vSphericalL10",d.l10),h.updateVector3("vSphericalL11",d.l11),h.updateVector3("vSphericalL2_2",d.l2_2),h.updateVector3("vSphericalL2_1",d.l2_1),h.updateVector3("vSphericalL20",d.l20),h.updateVector3("vSphericalL21",d.l21),h.updateVector3("vSphericalL22",d.l22)}else h.updateFloat3("vSphericalX",u.x.x,u.x.y,u.x.z),h.updateFloat3("vSphericalY",u.y.x,u.y.y,u.y.z),h.updateFloat3("vSphericalZ",u.z.x,u.z.y,u.z.z),h.updateFloat3("vSphericalXX_ZZ",u.xx.x-u.zz.x,u.xx.y-u.zz.y,u.xx.z-u.zz.z),h.updateFloat3("vSphericalYY_ZZ",u.yy.x-u.zz.x,u.yy.y-u.zz.y,u.yy.z-u.zz.z),h.updateFloat3("vSphericalZZ",u.zz.x,u.zz.y,u.zz.z),h.updateFloat3("vSphericalXY",u.xy.x,u.xy.y,u.xy.z),h.updateFloat3("vSphericalYZ",u.yz.x,u.yz.y,u.yz.z),h.updateFloat3("vSphericalZX",u.zx.x,u.zx.y,u.zx.z)}h.updateFloat3("vReflectionMicrosurfaceInfos",f.getSize().width,f.lodGenerationScale,f.lodGenerationOffset)}this._emissiveTexture&&X.EmissiveTextureEnabled&&(h.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),ct(this._emissiveTexture,h,"emissive")),this._lightmapTexture&&X.LightmapTextureEnabled&&(h.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),ct(this._lightmapTexture,h,"lightmap")),X.SpecularTextureEnabled&&(this._metallicTexture?(h.updateFloat3("vReflectivityInfos",this._metallicTexture.coordinatesIndex,this._metallicTexture.level,this._ambientTextureStrength),ct(this._metallicTexture,h,"reflectivity")):this._reflectivityTexture&&(h.updateFloat3("vReflectivityInfos",this._reflectivityTexture.coordinatesIndex,this._reflectivityTexture.level,1),ct(this._reflectivityTexture,h,"reflectivity")),this._metallicReflectanceTexture&&(h.updateFloat2("vMetallicReflectanceInfos",this._metallicReflectanceTexture.coordinatesIndex,this._metallicReflectanceTexture.level),ct(this._metallicReflectanceTexture,h,"metallicReflectance")),this._reflectanceTexture&&n.REFLECTANCE&&(h.updateFloat2("vReflectanceInfos",this._reflectanceTexture.coordinatesIndex,this._reflectanceTexture.level),ct(this._reflectanceTexture,h,"reflectance")),this._microSurfaceTexture&&(h.updateFloat2("vMicroSurfaceSamplerInfos",this._microSurfaceTexture.coordinatesIndex,this._microSurfaceTexture.level),ct(this._microSurfaceTexture,h,"microSurfaceSampler"))),this._bumpTexture&&o.getCaps().standardDerivatives&&X.BumpTextureEnabled&&!this._disableBumpMap&&(h.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level,this._parallaxScaleBias),ct(this._bumpTexture,h,"bump"),r._mirroredCameraPosition?h.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):h.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1))}if(this.pointsCloud&&h.updateFloat("pointSize",this.pointSize),n.METALLICWORKFLOW){Qi.Color4[0].r=this._metallic===void 0||this._metallic===null?1:this._metallic,Qi.Color4[0].g=this._roughness===void 0||this._roughness===null?1:this._roughness;let u=this.subSurface?._indexOfRefraction??1.5,d=1;Qi.Color4[0].b=u;let p=Math.pow((u-d)/(u+d),2);Qi.Color4[0].a=p,h.updateDirectColor4("vReflectivityColor",Qi.Color4[0]),h.updateColor4("vMetallicReflectanceFactors",this._metallicReflectanceColor,this._metallicF0Factor)}else h.updateColor4("vReflectivityColor",this._reflectivityColor,this._microSurface);h.updateColor3("vEmissiveColor",X.EmissiveTextureEnabled?this._emissiveColor:j.BlackReadOnly),h.updateColor3("vReflectionColor",this._reflectionColor),!n.SS_REFRACTION&&this.subSurface?._linkRefractionWithTransparency?h.updateColor4("vAlbedoColor",this._albedoColor,1):h.updateColor4("vAlbedoColor",this._albedoColor,this.alpha),h.updateFloat("baseWeight",this._baseWeight),h.updateFloat("baseDiffuseRoughness",this._baseDiffuseRoughness||0),this._lightingInfos.x=this._directIntensity,this._lightingInfos.y=this._emissiveIntensity,this._lightingInfos.z=this._environmentIntensity*r.environmentIntensity,this._lightingInfos.w=this._specularIntensity,h.updateVector4("vLightingIntensity",this._lightingInfos),r.ambientColor.multiplyToRef(this._ambientColor,this._globalAmbientColor),h.updateColor3("vAmbientColor",this._globalAmbientColor),h.updateFloat2("vDebugMode",this.debugLimit,this.debugFactor)}if(r.texturesEnabled){if(this._albedoTexture&&X.DiffuseTextureEnabled&&h.setTexture("albedoSampler",this._albedoTexture),this._baseWeightTexture&&X.BaseWeightTextureEnabled&&h.setTexture("baseWeightSampler",this._baseWeightTexture),this._baseDiffuseRoughnessTexture&&X.BaseDiffuseRoughnessTextureEnabled&&h.setTexture("baseDiffuseRoughnessSampler",this._baseDiffuseRoughnessTexture),this._ambientTexture&&X.AmbientTextureEnabled&&h.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&X.OpacityTextureEnabled&&h.setTexture("opacitySampler",this._opacityTexture),f&&X.ReflectionTextureEnabled){n.LODBASEDMICROSFURACE?h.setTexture("reflectionSampler",f):(h.setTexture("reflectionSampler",f._lodTextureMid||f),h.setTexture("reflectionSamplerLow",f._lodTextureLow||f),h.setTexture("reflectionSamplerHigh",f._lodTextureHigh||f)),n.USEIRRADIANCEMAP&&h.setTexture("irradianceSampler",f.irradianceTexture);let u=this.getScene().iblCdfGenerator;this.realTimeFiltering&&u&&h.setTexture("icdfSampler",u.getIcdfTexture())}n.ENVIRONMENTBRDF&&h.setTexture("environmentBrdfSampler",this._environmentBRDFTexture),this._emissiveTexture&&X.EmissiveTextureEnabled&&h.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&X.LightmapTextureEnabled&&h.setTexture("lightmapSampler",this._lightmapTexture),X.SpecularTextureEnabled&&(this._metallicTexture?h.setTexture("reflectivitySampler",this._metallicTexture):this._reflectivityTexture&&h.setTexture("reflectivitySampler",this._reflectivityTexture),this._metallicReflectanceTexture&&h.setTexture("metallicReflectanceSampler",this._metallicReflectanceTexture),this._reflectanceTexture&&n.REFLECTANCE&&h.setTexture("reflectanceSampler",this._reflectanceTexture),this._microSurfaceTexture&&h.setTexture("microSurfaceSampler",this._microSurfaceTexture)),this._bumpTexture&&o.getCaps().standardDerivatives&&X.BumpTextureEnabled&&!this._disableBumpMap&&h.setTexture("bumpSampler",this._bumpTexture)}this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(a),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),zi(this._activeEffect,this,r),this.bindEyePosition(a)}else r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);(c||!this.isFrozen)&&(r.lightsEnabled&&!this._disableLighting&&Zc(r,t,this._activeEffect,n,this._maxSimultaneousLights),(r.fogEnabled&&t.applyFog&&r.fogMode!==ze.FOGMODE_NONE||f||this.subSurface.refractionTexture||t.receiveShadows||n.PREPASS||n.CLUSTLIGHT_BATCH)&&this.bindView(a),wn(r,t,this._activeEffect,!0),n.NUM_MORPH_INFLUENCERS&&lr(t,this._activeEffect),n.BAKED_VERTEX_ANIMATION_TEXTURE&&t.bakedVertexAnimationManager?.bind(a,n.INSTANCES),this._imageProcessingConfiguration.bind(this._activeEffect),Ln(n,this._activeEffect,r)),this._afterBind(t,this._activeEffect,i),h.update()}getAnimatables(){let e=super.getAnimatables();return this._albedoTexture&&this._albedoTexture.animations&&this._albedoTexture.animations.length>0&&e.push(this._albedoTexture),this._baseWeightTexture&&this._baseWeightTexture.animations&&this._baseWeightTexture.animations.length>0&&e.push(this._baseWeightTexture),this._baseDiffuseRoughnessTexture&&this._baseDiffuseRoughnessTexture.animations&&this._baseDiffuseRoughnessTexture.animations.length>0&&e.push(this._baseDiffuseRoughnessTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._metallicTexture&&this._metallicTexture.animations&&this._metallicTexture.animations.length>0?e.push(this._metallicTexture):this._reflectivityTexture&&this._reflectivityTexture.animations&&this._reflectivityTexture.animations.length>0&&e.push(this._reflectivityTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._metallicReflectanceTexture&&this._metallicReflectanceTexture.animations&&this._metallicReflectanceTexture.animations.length>0&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&this._reflectanceTexture.animations&&this._reflectanceTexture.animations.length>0&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&this._microSurfaceTexture.animations&&this._microSurfaceTexture.animations.length>0&&e.push(this._microSurfaceTexture),e}_getReflectionTexture(){return this._reflectionTexture?this._reflectionTexture:this.getScene().environmentTexture}getActiveTextures(){let e=super.getActiveTextures();return this._albedoTexture&&e.push(this._albedoTexture),this._baseWeightTexture&&e.push(this._baseWeightTexture),this._baseDiffuseRoughnessTexture&&e.push(this._baseDiffuseRoughnessTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._reflectivityTexture&&e.push(this._reflectivityTexture),this._metallicTexture&&e.push(this._metallicTexture),this._metallicReflectanceTexture&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&e.push(this._microSurfaceTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),e}hasTexture(e){return!!(super.hasTexture(e)||this._albedoTexture===e||this._baseWeightTexture===e||this._baseDiffuseRoughnessTexture===e||this._ambientTexture===e||this._opacityTexture===e||this._reflectionTexture===e||this._emissiveTexture===e||this._reflectivityTexture===e||this._metallicTexture===e||this._metallicReflectanceTexture===e||this._reflectanceTexture===e||this._microSurfaceTexture===e||this._bumpTexture===e||this._lightmapTexture===e)}setPrePassRenderer(){if(!this.subSurface?.isScatteringEnabled)return!1;let e=this.getScene().enableSubSurfaceForPrePass();return e&&(e.enabled=!0),!0}dispose(e,t){this._breakShaderLoadedCheck=!0,t&&(this._environmentBRDFTexture&&this.getScene().environmentBRDFTexture!==this._environmentBRDFTexture&&this._environmentBRDFTexture.dispose(),this._albedoTexture?.dispose(),this._baseWeightTexture?.dispose(),this._baseDiffuseRoughnessTexture?.dispose(),this._ambientTexture?.dispose(),this._opacityTexture?.dispose(),this._reflectionTexture?.dispose(),this._emissiveTexture?.dispose(),this._metallicTexture?.dispose(),this._reflectivityTexture?.dispose(),this._bumpTexture?.dispose(),this._lightmapTexture?.dispose(),this._metallicReflectanceTexture?.dispose(),this._reflectanceTexture?.dispose(),this._microSurfaceTexture?.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t)}};Ft.PBRMATERIAL_OPAQUE=Q.MATERIAL_OPAQUE;Ft.PBRMATERIAL_ALPHATEST=Q.MATERIAL_ALPHATEST;Ft.PBRMATERIAL_ALPHABLEND=Q.MATERIAL_ALPHABLEND;Ft.PBRMATERIAL_ALPHATESTANDBLEND=Q.MATERIAL_ALPHATESTANDBLEND;Ft.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=0;Ft.LIGHTFALLOFF_PHYSICAL=0;Ft.LIGHTFALLOFF_GLTF=1;Ft.LIGHTFALLOFF_STANDARD=2;Ft.ForceGLSL=!1;x([ap()],Ft.prototype,"_imageProcessingConfiguration",void 0);x([z("_markAllSubMeshesAsMiscDirty")],Ft.prototype,"debugMode",void 0)});var J,Li=S(()=>{Ye();je();HC();it();Q_();Te();cs();ei();J=class s extends Ft{get refractionTexture(){return this.subSurface.refractionTexture}set refractionTexture(e){this.subSurface.refractionTexture=e,e?this.subSurface.isRefractionEnabled=!0:this.subSurface.linkRefractionWithTransparency||(this.subSurface.isRefractionEnabled=!1)}get indexOfRefraction(){return this.subSurface.indexOfRefraction}set indexOfRefraction(e){this.subSurface.indexOfRefraction=e}get invertRefractionY(){return this.subSurface.invertRefractionY}set invertRefractionY(e){this.subSurface.invertRefractionY=e}get linkRefractionWithTransparency(){return this.subSurface.linkRefractionWithTransparency}set linkRefractionWithTransparency(e){this.subSurface.linkRefractionWithTransparency=e,e&&(this.subSurface.isRefractionEnabled=!0)}get usePhysicalLightFalloff(){return this._lightFalloff===Ft.LIGHTFALLOFF_PHYSICAL}set usePhysicalLightFalloff(e){e!==this.usePhysicalLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),e?this._lightFalloff=Ft.LIGHTFALLOFF_PHYSICAL:this._lightFalloff=Ft.LIGHTFALLOFF_STANDARD)}get useGLTFLightFalloff(){return this._lightFalloff===Ft.LIGHTFALLOFF_GLTF}set useGLTFLightFalloff(e){e!==this.useGLTFLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),e?this._lightFalloff=Ft.LIGHTFALLOFF_GLTF:this._lightFalloff=Ft.LIGHTFALLOFF_STANDARD)}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsImageProcessingDirty()}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this._imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this._imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this._imageProcessingConfiguration.colorCurves=e}constructor(e,t,i=!1){super(e,t,i),this.directIntensity=1,this.emissiveIntensity=1,this.environmentIntensity=1,this.specularIntensity=1,this.disableBumpMap=!1,this.ambientTextureStrength=1,this.ambientTextureImpactOnAnalyticalLights=s.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this.metallicF0Factor=1,this.metallicReflectanceColor=j.White(),this.useOnlyMetallicFromMetallicReflectanceTexture=!1,this.ambientColor=new j(0,0,0),this.albedoColor=new j(1,1,1),this.baseWeight=1,this.reflectivityColor=new j(1,1,1),this.reflectionColor=new j(1,1,1),this.emissiveColor=new j(0,0,0),this.microSurface=1,this.useLightmapAsShadowmap=!1,this.useAlphaFromAlbedoTexture=!1,this.forceAlphaTest=!1,this.alphaCutOff=.4,this.useSpecularOverAlpha=!0,this.useMicroSurfaceFromReflectivityMapAlpha=!1,this.useRoughnessFromMetallicTextureAlpha=!0,this.useRoughnessFromMetallicTextureGreen=!1,this.useMetallnessFromMetallicTextureBlue=!1,this.useAmbientOcclusionFromMetallicTextureRed=!1,this.useAmbientInGrayScale=!1,this.useAutoMicroSurfaceFromReflectivityMap=!1,this.useRadianceOverAlpha=!0,this.useObjectSpaceNormalMap=!1,this.useParallax=!1,this.useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this.disableLighting=!1,this.forceIrradianceInFragment=!1,this.maxSimultaneousLights=4,this.invertNormalMapX=!1,this.invertNormalMapY=!1,this.twoSidedLighting=!1,this.useAlphaFresnel=!1,this.useLinearAlphaFresnel=!1,this.environmentBRDFTexture=null,this.forceNormalForward=!1,this.enableSpecularAntiAliasing=!1,this.useHorizonOcclusion=!0,this.useRadianceOcclusion=!0,this.unlit=!1,this.applyDecalMapAfterDetailMap=!1,this._environmentBRDFTexture=F_(this.getScene())}getClassName(){return"PBRMaterial"}clone(e,t=!0,i=""){let r=_e.Clone(()=>new s(e,this.getScene()),this,{cloneTexturesOnlyOnce:t});return r.id=e,r.name=e,this.stencil.copyTo(r.stencil),this._clonePlugins(r,i),r}serialize(){let e=super.serialize();return e.customType="BABYLON.PBRMaterial",e}static Parse(e,t,i){let r=_e.Parse(()=>new s(e.name,t),e,t,i);return e.stencil&&r.stencil.parse(e.stencil,t,i),Q._ParsePlugins(e,r,t,i),e.clearCoat&&r.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&r.anisotropy.parse(e.anisotropy,t,i),e.brdf&&r.brdf.parse(e.brdf,t,i),e.sheen&&r.sheen.parse(e.sheen,t,i),e.subSurface&&r.subSurface.parse(e.subSurface,t,i),e.iridescence&&r.iridescence.parse(e.iridescence,t,i),r}};J.PBRMATERIAL_OPAQUE=Ft.PBRMATERIAL_OPAQUE;J.PBRMATERIAL_ALPHATEST=Ft.PBRMATERIAL_ALPHATEST;J.PBRMATERIAL_ALPHABLEND=Ft.PBRMATERIAL_ALPHABLEND;J.PBRMATERIAL_ALPHATESTANDBLEND=Ft.PBRMATERIAL_ALPHATESTANDBLEND;J.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=Ft.DEFAULT_AO_ON_ANALYTICAL_LIGHTS;x([y(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"directIntensity",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"emissiveIntensity",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"environmentIntensity",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"specularIntensity",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"disableBumpMap",void 0);x([He(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"albedoTexture",void 0);x([He(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"baseWeightTexture",void 0);x([He(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"baseDiffuseRoughnessTexture",void 0);x([He(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"ambientTexture",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"ambientTextureStrength",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"ambientTextureImpactOnAnalyticalLights",void 0);x([He(),z("_markAllSubMeshesAsTexturesAndMiscDirty")],J.prototype,"opacityTexture",void 0);x([He(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"reflectionTexture",void 0);x([He(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"emissiveTexture",void 0);x([He(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"reflectivityTexture",void 0);x([He(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"metallicTexture",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"metallic",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"roughness",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"metallicF0Factor",void 0);x([zt(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"metallicReflectanceColor",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"useOnlyMetallicFromMetallicReflectanceTexture",void 0);x([He(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"metallicReflectanceTexture",void 0);x([He(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"reflectanceTexture",void 0);x([He(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"microSurfaceTexture",void 0);x([He(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"bumpTexture",void 0);x([He(),z("_markAllSubMeshesAsTexturesDirty",null)],J.prototype,"lightmapTexture",void 0);x([zt("ambient"),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"ambientColor",void 0);x([zt("albedo"),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"albedoColor",void 0);x([y("baseWeight"),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"baseWeight",void 0);x([y("baseDiffuseRoughness"),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"baseDiffuseRoughness",void 0);x([zt("reflectivity"),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"reflectivityColor",void 0);x([zt("reflection"),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"reflectionColor",void 0);x([zt("emissive"),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"emissiveColor",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"microSurface",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"useLightmapAsShadowmap",void 0);x([y(),z("_markAllSubMeshesAsTexturesAndMiscDirty")],J.prototype,"useAlphaFromAlbedoTexture",void 0);x([y(),z("_markAllSubMeshesAsTexturesAndMiscDirty")],J.prototype,"forceAlphaTest",void 0);x([y(),z("_markAllSubMeshesAsTexturesAndMiscDirty")],J.prototype,"alphaCutOff",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"useSpecularOverAlpha",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"useMicroSurfaceFromReflectivityMapAlpha",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"useRoughnessFromMetallicTextureAlpha",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"useRoughnessFromMetallicTextureGreen",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"useMetallnessFromMetallicTextureBlue",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"useAmbientOcclusionFromMetallicTextureRed",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"useAmbientInGrayScale",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"useAutoMicroSurfaceFromReflectivityMap",void 0);x([y()],J.prototype,"usePhysicalLightFalloff",null);x([y()],J.prototype,"useGLTFLightFalloff",null);x([y(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"useRadianceOverAlpha",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"useObjectSpaceNormalMap",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"useParallax",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"useParallaxOcclusion",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"parallaxScaleBias",void 0);x([y(),z("_markAllSubMeshesAsLightsDirty")],J.prototype,"disableLighting",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"forceIrradianceInFragment",void 0);x([y(),z("_markAllSubMeshesAsLightsDirty")],J.prototype,"maxSimultaneousLights",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"invertNormalMapX",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"invertNormalMapY",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"twoSidedLighting",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"useAlphaFresnel",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"useLinearAlphaFresnel",void 0);x([z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"environmentBRDFTexture",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"forceNormalForward",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"enableSpecularAntiAliasing",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"useHorizonOcclusion",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],J.prototype,"useRadianceOcclusion",void 0);x([y(),z("_markAllSubMeshesAsMiscDirty")],J.prototype,"unlit",void 0);x([y(),z("_markAllSubMeshesAsMiscDirty")],J.prototype,"applyDecalMapAfterDetailMap",void 0);G("BABYLON.PBRMaterial",J)});var Qr,Pu=S(()=>{Qr=class{get resolve(){return this._resolve}get reject(){return this._reject}constructor(){this.promise=new Promise((e,t)=>{this._resolve=e,this._reject=t})}}});function Du(...s){let e=t=>!!t&&typeof t=="object";return s.reduce((t,i)=>{let r=Object.keys(i);for(let n of r){let a=t[n],o=i[n];Array.isArray(a)&&Array.isArray(o)?t[n]=a.concat(...o):e(a)&&e(o)?t[n]=Du(a,o):t[n]=o}return t},{})}var UI=S(()=>{});var CV={};V(CV,{glowBlurPostProcessPixelShaderWGSL:()=>Qee});var VI,bV,Qee,IV=S(()=>{O();VI="glowBlurPostProcessPixelShader",bV=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform screenSize: vec2f;uniform direction: vec2f;uniform blurWidth: f32;fn getLuminance(color: vec3f)->f32
{return dot(color, vec3f(0.2126,0.7152,0.0722));}
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var weights: array<f32 ,7>;weights[0]=0.05;weights[1]=0.1;weights[2]=0.2;weights[3]=0.3;weights[4]=0.2;weights[5]=0.1;weights[6]=0.05;var texelSize: vec2f= vec2f(1.0/uniforms.screenSize.x,1.0/uniforms.screenSize.y);var texelStep: vec2f=texelSize*uniforms.direction*uniforms.blurWidth;var start: vec2f=input.vUV-3.0*texelStep;var baseColor: vec4f= vec4f(0.,0.,0.,0.);var texelOffset: vec2f= vec2f(0.,0.);for (var i: i32=0; i<7; i++)
{var texel: vec4f=textureSample(textureSampler,textureSamplerSampler,start+texelOffset);baseColor=vec4f(baseColor.rgb,baseColor.a+texel.a*weights[i]);var luminance: f32=getLuminance(baseColor.rgb);var luminanceTexel: f32=getLuminance(texel.rgb);var choice: f32=step(luminanceTexel,luminance);baseColor=vec4f(choice*baseColor.rgb+(1.0-choice)*texel.rgb,baseColor.a);texelOffset+=texelStep;}
fragmentOutputs.color=baseColor;}`;g.ShadersStoreWGSL[VI]||(g.ShadersStoreWGSL[VI]=bV);Qee={name:VI,shader:bV}});var MV={};V(MV,{glowBlurPostProcessPixelShader:()=>jee});var kI,yV,jee,PV=S(()=>{O();kI="glowBlurPostProcessPixelShader",yV=`varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 screenSize;uniform vec2 direction;uniform float blurWidth;float getLuminance(vec3 color)
{return dot(color,vec3(0.2126,0.7152,0.0722));}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{float weights[7];weights[0]=0.05;weights[1]=0.1;weights[2]=0.2;weights[3]=0.3;weights[4]=0.2;weights[5]=0.1;weights[6]=0.05;vec2 texelSize=vec2(1.0/screenSize.x,1.0/screenSize.y);vec2 texelStep=texelSize*direction*blurWidth;vec2 start=vUV-3.0*texelStep;vec4 baseColor=vec4(0.,0.,0.,0.);vec2 texelOffset=vec2(0.,0.);for (int i=0; i<7; i++)
{vec4 texel=texture2D(textureSampler,start+texelOffset);baseColor.a+=texel.a*weights[i];float luminance=getLuminance(baseColor.rgb);float luminanceTexel=getLuminance(texel.rgb);float choice=step(luminanceTexel,luminance);baseColor.rgb=choice*baseColor.rgb+(1.0-choice)*texel.rgb;texelOffset+=texelStep;}
gl_FragColor=baseColor;}`;g.ShadersStore[kI]||(g.ShadersStore[kI]=yV);jee={name:kI,shader:yV}});var OV={};V(OV,{glowMapGenerationVertexShaderWGSL:()=>Zee});var WI,DV,Zee,LV=S(()=>{O();Ia();Bn();Oo();Lo();ya();Va();Fo();No();Un();Ma();Gn();Pa();WI="glowMapGenerationVertexShader",DV=`attribute position: vec3f;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<clipPlaneVertexDeclaration>
#include<instancesDeclaration>
uniform viewProjection: mat4x4f;varying vPosition: vec4f;
#ifdef UV1
attribute uv: vec2f;
#endif
#ifdef UV2
attribute uv2: vec2f;
#endif
#ifdef DIFFUSE
varying vUVDiffuse: vec2f;uniform diffuseMatrix: mat4x4f;
#endif
#ifdef OPACITY
varying vUVOpacity: vec2f;uniform opacityMatrix: mat4x4f;
#endif
#ifdef EMISSIVE
varying vUVEmissive: vec2f;uniform emissiveMatrix: mat4x4f;
#endif
#ifdef VERTEXALPHA
attribute color: vec4f;varying vColor: vec4f;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {var positionUpdated: vec3f=input.position;
#ifdef UV1
var uvUpdated: vec2f=input.uv;
#endif
#ifdef UV2
var uv2Updated: vec2f=input.uv2;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
var worldPos: vec4f=finalWorld* vec4f(positionUpdated,1.0);
#ifdef CUBEMAP
vertexOutputs.vPosition=worldPos;vertexOutputs.position=uniforms.viewProjection*finalWorld* vec4f(input.position,1.0);
#else
vertexOutputs.vPosition=uniforms.viewProjection*worldPos;vertexOutputs.position=vertexOutputs.vPosition;
#endif
#ifdef DIFFUSE
#ifdef DIFFUSEUV1
vertexOutputs.vUVDiffuse= (uniforms.diffuseMatrix* vec4f(uvUpdated,1.0,0.0)).xy;
#endif
#ifdef DIFFUSEUV2
vertexOutputs.vUVDiffuse= (uniforms.diffuseMatrix* vec4f(uv2Updated,1.0,0.0)).xy;
#endif
#endif
#ifdef OPACITY
#ifdef OPACITYUV1
vertexOutputs.vUVOpacity= (uniforms.opacityMatrix* vec4f(uvUpdated,1.0,0.0)).xy;
#endif
#ifdef OPACITYUV2
vertexOutputs.vUVOpacity= (uniforms.opacityMatrix* vec4f(uv2Updated,1.0,0.0)).xy;
#endif
#endif
#ifdef EMISSIVE
#ifdef EMISSIVEUV1
vertexOutputs.vUVEmissive= (uniforms.emissiveMatrix* vec4f(uvUpdated,1.0,0.0)).xy;
#endif
#ifdef EMISSIVEUV2
vertexOutputs.vUVEmissive= (uniforms.emissiveMatrix* vec4f(uv2Updated,1.0,0.0)).xy;
#endif
#endif
#ifdef VERTEXALPHA
vertexOutputs.vColor=vertexInputs.color;
#endif
#include<clipPlaneVertex>
}`;g.ShadersStoreWGSL[WI]||(g.ShadersStoreWGSL[WI]=DV);Zee={name:WI,shader:DV}});var FV={};V(FV,{glowMapGenerationPixelShaderWGSL:()=>Jee});var HI,wV,Jee,NV=S(()=>{O();Pi();ba();Ca();HI="glowMapGenerationPixelShader",wV=`#if defined(DIFFUSE_ISLINEAR) || defined(EMISSIVE_ISLINEAR)
#include<helperFunctions>
#endif
#ifdef DIFFUSE
varying vUVDiffuse: vec2f;var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;
#endif
#ifdef OPACITY
varying vUVOpacity: vec2f;var opacitySamplerSampler: sampler;var opacitySampler: texture_2d<f32>;uniform opacityIntensity: f32;
#endif
#ifdef EMISSIVE
varying vUVEmissive: vec2f;var emissiveSamplerSampler: sampler;var emissiveSampler: texture_2d<f32>;
#endif
#ifdef VERTEXALPHA
varying vColor: vec4f;
#endif
uniform glowColor: vec4f;uniform glowIntensity: f32;
#include<clipPlaneFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#include<clipPlaneFragment>
var finalColor: vec4f=uniforms.glowColor;
#ifdef DIFFUSE
var albedoTexture: vec4f=textureSample(diffuseSampler,diffuseSamplerSampler,fragmentInputs.vUVDiffuse);
#ifdef DIFFUSE_ISLINEAR
albedoTexture=toGammaSpace(albedoTexture);
#endif
#ifdef GLOW
finalColor=vec4f(finalColor.rgb,finalColor.a*albedoTexture.a);
#endif
#ifdef HIGHLIGHT
finalColor=vec4f(finalColor.rgb,albedoTexture.a);
#endif
#endif
#ifdef OPACITY
var opacityMap: vec4f=textureSample(opacitySampler,opacitySamplerSampler,fragmentInputs.vUVOpacity);
#ifdef OPACITYRGB
finalColor=vec4f(finalColor.rgb,finalColor.a*getLuminance(opacityMap.rgb));
#else
finalColor=vec4f(finalColor.rgb,finalColor.a*opacityMap.a);
#endif
finalColor=vec4f(finalColor.rgb,finalColor.a*uniforms.opacityIntensity);
#endif
#ifdef VERTEXALPHA
finalColor=vec4f(finalColor.rgb,finalColor.a*fragmentInputs.vColor.a);
#endif
#ifdef ALPHATEST
if (finalColor.a<ALPHATESTVALUE) {discard;}
#endif
#ifdef EMISSIVE
var emissive: vec4f=textureSample(emissiveSampler,emissiveSamplerSampler,fragmentInputs.vUVEmissive);
#ifdef EMISSIVE_ISLINEAR
emissive=toGammaSpace(emissive);
#endif
fragmentOutputs.color=emissive*finalColor*uniforms.glowIntensity;
#else
fragmentOutputs.color=finalColor*uniforms.glowIntensity;
#endif
#ifdef HIGHLIGHT
fragmentOutputs.color=vec4f(fragmentOutputs.color.rgb,uniforms.glowColor.a);
#endif
}
`;g.ShadersStoreWGSL[HI]||(g.ShadersStoreWGSL[HI]=wV);Jee={name:HI,shader:wV}});var UV={};V(UV,{glowMapGenerationVertexShader:()=>$ee});var zI,BV,$ee,GV=S(()=>{O();La();wa();Bo();Uo();Fa();ko();Go();Vo();Na();Ba();Ua();Ga();zI="glowMapGenerationVertexShader",BV=`attribute vec3 position;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<clipPlaneVertexDeclaration>
#include<instancesDeclaration>
uniform mat4 viewProjection;varying vec4 vPosition;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#ifdef DIFFUSE
varying vec2 vUVDiffuse;uniform mat4 diffuseMatrix;
#endif
#ifdef OPACITY
varying vec2 vUVOpacity;uniform mat4 opacityMatrix;
#endif
#ifdef EMISSIVE
varying vec2 vUVEmissive;uniform mat4 emissiveMatrix;
#endif
#ifdef VERTEXALPHA
attribute vec4 color;varying vec4 vColor;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{vec3 positionUpdated=position;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#ifdef UV2
vec2 uv2Updated=uv2;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#ifdef CUBEMAP
vPosition=worldPos;gl_Position=viewProjection*finalWorld*vec4(position,1.0);
#else
vPosition=viewProjection*worldPos;gl_Position=vPosition;
#endif
#ifdef DIFFUSE
#ifdef DIFFUSEUV1
vUVDiffuse=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef DIFFUSEUV2
vUVDiffuse=vec2(diffuseMatrix*vec4(uv2Updated,1.0,0.0));
#endif
#endif
#ifdef OPACITY
#ifdef OPACITYUV1
vUVOpacity=vec2(opacityMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef OPACITYUV2
vUVOpacity=vec2(opacityMatrix*vec4(uv2Updated,1.0,0.0));
#endif
#endif
#ifdef EMISSIVE
#ifdef EMISSIVEUV1
vUVEmissive=vec2(emissiveMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef EMISSIVEUV2
vUVEmissive=vec2(emissiveMatrix*vec4(uv2Updated,1.0,0.0));
#endif
#endif
#ifdef VERTEXALPHA
vColor=color;
#endif
#include<clipPlaneVertex>
}`;g.ShadersStore[zI]||(g.ShadersStore[zI]=BV);$ee={name:zI,shader:BV}});var kV={};V(kV,{glowMapGenerationPixelShader:()=>ete});var XI,VV,ete,WV=S(()=>{O();Di();Da();Oa();XI="glowMapGenerationPixelShader",VV=`#if defined(DIFFUSE_ISLINEAR) || defined(EMISSIVE_ISLINEAR)
#include<helperFunctions>
#endif
#ifdef DIFFUSE
varying vec2 vUVDiffuse;uniform sampler2D diffuseSampler;
#endif
#ifdef OPACITY
varying vec2 vUVOpacity;uniform sampler2D opacitySampler;uniform float opacityIntensity;
#endif
#ifdef EMISSIVE
varying vec2 vUVEmissive;uniform sampler2D emissiveSampler;
#endif
#ifdef VERTEXALPHA
varying vec4 vColor;
#endif
uniform vec4 glowColor;uniform float glowIntensity;
#include<clipPlaneFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#include<clipPlaneFragment>
vec4 finalColor=glowColor;
#ifdef DIFFUSE
vec4 albedoTexture=texture2D(diffuseSampler,vUVDiffuse);
#ifdef DIFFUSE_ISLINEAR
albedoTexture=toGammaSpace(albedoTexture);
#endif
#ifdef GLOW
finalColor.a*=albedoTexture.a;
#endif
#ifdef HIGHLIGHT
finalColor.a=albedoTexture.a;
#endif
#endif
#ifdef OPACITY
vec4 opacityMap=texture2D(opacitySampler,vUVOpacity);
#ifdef OPACITYRGB
finalColor.a*=getLuminance(opacityMap.rgb);
#else
finalColor.a*=opacityMap.a;
#endif
finalColor.a*=opacityIntensity;
#endif
#ifdef VERTEXALPHA
finalColor.a*=vColor.a;
#endif
#ifdef ALPHATEST
if (finalColor.a<ALPHATESTVALUE)
discard;
#endif
#ifdef EMISSIVE
vec4 emissive=texture2D(emissiveSampler,vUVEmissive);
#ifdef EMISSIVE_ISLINEAR
emissive=toGammaSpace(emissive);
#endif
gl_FragColor=emissive*finalColor*glowIntensity;
#else
gl_FragColor=finalColor*glowIntensity;
#endif
#ifdef HIGHLIGHT
gl_FragColor.a=glowColor.a;
#endif
}`;g.ShadersStore[XI]||(g.ShadersStore[XI]=VV);ete={name:XI,shader:VV}});var Gl,KI=S(()=>{Gl={name:"bvh",extensions:{".bvh":{isBinary:!1}}}});var qa,Zo,qI=S(()=>{qa="Z2xURg",Zo={name:"gltf",extensions:{".gltf":{isBinary:!1,mimeType:"model/gltf+json"},".glb":{isBinary:!0,mimeType:"model/gltf-binary"}},canDirectLoad(s){return s.indexOf("asset")!==-1&&s.indexOf("version")!==-1||s.startsWith("data:base64,"+qa)||s.startsWith("data:;base64,"+qa)||s.startsWith("data:application/octet-stream;base64,"+qa)||s.startsWith("data:model/gltf-binary;base64,"+qa)}}});var Vl,QI=S(()=>{Vl={name:"obj",extensions:".obj"}});var kl,jI=S(()=>{kl={name:"splat",extensions:{".splat":{isBinary:!0},".ply":{isBinary:!0},".spz":{isBinary:!0}}}});var Vu,ZI=S(()=>{Vu={name:"stl",extensions:{".stl":{isBinary:!0}}}});function te(s,e,t){Ce(s)&&P.Warn(`Extension with the name '${s}' already exists`),JI.set(s,{isGLTFExtension:e,factory:t})}function Ce(s){return JI.delete(s)}var JI,HV,mt=S(()=>{Ee();JI=new Map,HV=JI});var XV={};V(XV,{CubeTexture:()=>mr});var zV,mr,$I=S(()=>{Ye();je();$e();ie();ma();Ut();Te();we();ei();CR();zV=.8,mr=class s extends nt{set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;let t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}set rotationY(e){this._rotationY=e,this.setReflectionTextureMatrix(B.RotationY(this._rotationY))}get rotationY(){return this._rotationY}get noMipmap(){return this._noMipmap}get forcedExtension(){return this._forcedExtension}static CreateFromImages(e,t,i){let r="";for(let n of e)r+=n;return new s(r,t,null,i,e)}static CreateFromPrefilteredData(e,t,i=null,r=!0){let n=t.useDelayedTextureLoading;t.useDelayedTextureLoading=!1;let a=new s(e,t,null,!1,null,null,null,void 0,!0,i,r);return t.useDelayedTextureLoading=n,a}constructor(e,t,i=null,r=!1,n=null,a=null,o=null,l=5,c=!1,f=null,h=!1,u=zV,d=0,p,m){super(t),this.onLoadObservable=new N,this.boundingBoxPosition=E.Zero(),this._rotationY=0,this._files=null,this._forcedExtension=null,this._extensions=null,this._textureMatrixRefraction=new B,this._buffer=null,this.name=e,this.url=e,this._noMipmap=r,this.hasAlpha=!1,this.isCube=!0,this._textureMatrix=B.Identity(),this.coordinatesMode=H.CUBIC_MODE;let _=null,v=null;i!==null&&!Array.isArray(i)?(_=i.extensions??null,this._noMipmap=i.noMipmap??!1,n=i.files??null,v=i.buffer??null,this._format=i.format??5,c=i.prefiltered??!1,f=i.forcedExtension??null,this._createPolynomials=i.createPolynomials??!1,this._lodScale=i.lodScale??zV,this._lodOffset=i.lodOffset??0,this._loaderOptions=i.loaderOptions,this._useSRGBBuffer=i.useSRGBBuffer,a=i.onLoad??null,o=i.onError??null):(this._noMipmap=r,this._format=l,this._createPolynomials=h,_=i,this._loaderOptions=p,this._useSRGBBuffer=m,this._lodScale=u,this._lodOffset=d),!(!e&&!n)&&this.updateURL(e,f,a,c,o,_,this.getScene()?.useDelayedTextureLoading,n,v)}getClassName(){return"CubeTexture"}updateURL(e,t=null,i=null,r=!1,n=null,a=null,o=!1,l=null,c=null){(!this.name||this.name.startsWith("data:"))&&(this.name=e),this.url=e,t&&(this._forcedExtension=t);let f=e.lastIndexOf("."),h=t||(f>-1?e.substring(f).toLowerCase():""),u=h.indexOf(".dds")===0,d=h.indexOf(".env")===0,p=h.indexOf(".basis")===0;if(d?(this.gammaSpace=!1,this._prefiltered=!1,this.anisotropicFilteringLevel=1):(this._prefiltered=r,r&&(this.gammaSpace=!1,this.anisotropicFilteringLevel=1)),l)this._files=l;else if(!p&&!d&&!u&&!a&&(a=["_px.jpg","_py.jpg","_pz.jpg","_nx.jpg","_ny.jpg","_nz.jpg"]),this._files=this._files||[],this._files.length=0,a){for(let m=0;m<a.length;m++)this._files.push(e+a[m]);this._extensions=a}this._buffer=c,o?(this.delayLoadState=4,this._delayedOnLoad=i,this._delayedOnError=n):this._loadTexture(i,n)}delayLoad(e){this.delayLoadState===4&&(e&&(this._forcedExtension=e),this.delayLoadState=1,this._loadTexture(this._delayedOnLoad,this._delayedOnError))}getReflectionTextureMatrix(){return this._textureMatrix}setReflectionTextureMatrix(e){if(e.updateFlag===this._textureMatrix.updateFlag||(e.isIdentity()!==this._textureMatrix.isIdentity()&&this.getScene()?.markAllMaterialsAsDirty(1,n=>n.getActiveTextures().indexOf(this)!==-1),this._textureMatrix=e,!this.getScene()?.useRightHandedSystem))return;let t=w.Vector3[0],i=w.Quaternion[0],r=w.Vector3[1];this._textureMatrix.decompose(t,i,r),i.z*=-1,i.w*=-1,B.ComposeToRef(t,i,r,this._textureMatrixRefraction)}getRefractionTextureMatrix(){return this.getScene()?.useRightHandedSystem?this._textureMatrixRefraction:this._textureMatrix}_loadTexture(e=null,t=null){let i=this.getScene(),r=this._texture;this._texture=this._getFromCache(this.url,this._noMipmap,void 0,void 0,this._useSRGBBuffer,this.isCube);let n=()=>{this.onLoadObservable.notifyObservers(this),r&&(r.dispose(),this.getScene()?.markAllMaterialsAsDirty(1)),e&&e()},a=(o,l)=>{this._loadingError=!0,this._errorObject={message:o,exception:l},t&&t(o,l),H.OnTextureLoadErrorObservable.notifyObservers(this)};this._texture?this._texture.isReady?W.SetImmediate(()=>n()):this._texture.onLoadedObservable.add(()=>n()):(this._prefiltered?this._texture=this._getEngine().createPrefilteredCubeTexture(this.url,i,this._lodScale,this._lodOffset,e,a,this._format,this._forcedExtension,this._createPolynomials):this._texture=this._getEngine().createCubeTexture(this.url,i,this._files,this._noMipmap,e,a,this._format,this._forcedExtension,!1,this._lodScale,this._lodOffset,null,this._loaderOptions,!!this._useSRGBBuffer,this._buffer),this._texture?.onLoadedObservable.add(()=>this.onLoadObservable.notifyObservers(this)))}static Parse(e,t,i){let r=_e.Parse(()=>{let n=!1;return e.prefiltered&&(n=e.prefiltered),new s(i+(e.url??e.name),t,e.extensions,!1,e.files||null,null,null,void 0,n,e.forcedExtension)},e,t);if(e.boundingBoxPosition&&(r.boundingBoxPosition=E.FromArray(e.boundingBoxPosition)),e.boundingBoxSize&&(r.boundingBoxSize=E.FromArray(e.boundingBoxSize)),e.animations)for(let n=0;n<e.animations.length;n++){let a=e.animations[n],o=Ci("BABYLON.Animation");o&&r.animations.push(o.Parse(a))}return r}clone(){let e=0,t=_e.Clone(()=>{let i=new s(this.url,this.getScene()||this._getEngine(),this._extensions,this._noMipmap,this._files);return e=i.uniqueId,i},this);return t.uniqueId=e,t}};x([y()],mr.prototype,"url",void 0);x([oi()],mr.prototype,"boundingBoxPosition",void 0);x([oi()],mr.prototype,"boundingBoxSize",null);x([y("rotationY")],mr.prototype,"rotationY",null);x([y("files")],mr.prototype,"_files",void 0);x([y("forcedExtension")],mr.prototype,"_forcedExtension",void 0);x([y("extensions")],mr.prototype,"_extensions",void 0);x([RA("textureMatrix")],mr.prototype,"_textureMatrix",void 0);x([RA("textureMatrixRefraction")],mr.prototype,"_textureMatrixRefraction",void 0);H._CubeTextureParser=mr.Parse;G("BABYLON.CubeTexture",mr)});var ag,YV=S(()=>{ei();yb();$I();ag=class s extends mr{constructor(e,t,i,r=5,n=0,a=!1,o=!1,l=3,c=null){super("",e),this._texture=e.getEngine().createRawCubeTexture(t,i,r,n,a,o,l,c)}update(e,t,i,r,n=null){this._texture.getEngine().updateRawCubeTexture(this._texture,e,t,i,r,n)}updateRGBDAsync(e,t=null,i=.8,r=0){return t1(this._texture,e,t,i,r).then(()=>{})}clone(){return _e.Clone(()=>{let e=this.getScene(),t=this._texture,i=new s(e,t._bufferViewArray,t.width,t.format,t.type,t.generateMipMaps,t.invertY,t.samplingMode,t._compression);return t.source===13&&i.updateRGBDAsync(t._bufferViewArrayArray,t._sphericalPolynomial,t._lodGenerationScale,t._lodGenerationOffset),i},this)}}});var _r,KV=S(()=>{Ye();je();Yn();Tm();ie();$e();_r=class{constructor(){this.keysUp=[38],this.keysUpward=[33],this.keysDown=[40],this.keysDownward=[34],this.keysLeft=[37],this.keysRight=[39],this.rotationSpeed=.5,this.keysRotateLeft=[],this.keysRotateRight=[],this.keysRotateUp=[],this.keysRotateDown=[],this._keys=new Array}attachControl(e){e=W.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{let i=t.event;if(!i.metaKey){if(t.type===$s.KEYDOWN)(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysUpward.indexOf(i.keyCode)!==-1||this.keysDownward.indexOf(i.keyCode)!==-1||this.keysRotateLeft.indexOf(i.keyCode)!==-1||this.keysRotateRight.indexOf(i.keyCode)!==-1||this.keysRotateUp.indexOf(i.keyCode)!==-1||this.keysRotateDown.indexOf(i.keyCode)!==-1)&&(this._keys.indexOf(i.keyCode)===-1&&this._keys.push(i.keyCode),e||i.preventDefault());else if(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysUpward.indexOf(i.keyCode)!==-1||this.keysDownward.indexOf(i.keyCode)!==-1||this.keysRotateLeft.indexOf(i.keyCode)!==-1||this.keysRotateRight.indexOf(i.keyCode)!==-1||this.keysRotateUp.indexOf(i.keyCode)!==-1||this.keysRotateDown.indexOf(i.keyCode)!==-1){let r=this._keys.indexOf(i.keyCode);r>=0&&this._keys.splice(r,1),e||i.preventDefault()}}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){let e=this.camera;for(let t=0;t<this._keys.length;t++){let i=this._keys[t],r=e._computeLocalCameraSpeed();this.keysLeft.indexOf(i)!==-1?e._localDirection.copyFromFloats(-r,0,0):this.keysUp.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,0,r):this.keysRight.indexOf(i)!==-1?e._localDirection.copyFromFloats(r,0,0):this.keysDown.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,0,-r):this.keysUpward.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,r,0):this.keysDownward.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,-r,0):this.keysRotateLeft.indexOf(i)!==-1?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y-=this._getLocalRotation()):this.keysRotateRight.indexOf(i)!==-1?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y+=this._getLocalRotation()):this.keysRotateUp.indexOf(i)!==-1?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x-=this._getLocalRotation()):this.keysRotateDown.indexOf(i)!==-1&&(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x+=this._getLocalRotation()),e.getScene().useRightHandedSystem&&(e._localDirection.z*=-1),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),E.TransformNormalToRef(e._localDirection,e._cameraTransformMatrix,e._transformedDirection),e.cameraDirection.addInPlace(e._transformedDirection)}}}getClassName(){return"FreeCameraKeyboardMoveInput"}_onLostFocus(){this._keys.length=0}getSimpleName(){return"keyboard"}_getLocalRotation(){let e=this.camera._calculateHandednessMultiplier();return this.rotationSpeed*this._engine.getDeltaTime()/1e3*e}};x([y()],_r.prototype,"keysUp",void 0);x([y()],_r.prototype,"keysUpward",void 0);x([y()],_r.prototype,"keysDown",void 0);x([y()],_r.prototype,"keysDownward",void 0);x([y()],_r.prototype,"keysLeft",void 0);x([y()],_r.prototype,"keysRight",void 0);x([y()],_r.prototype,"rotationSpeed",void 0);x([y()],_r.prototype,"keysRotateLeft",void 0);x([y()],_r.prototype,"keysRotateRight",void 0);x([y()],_r.prototype,"keysRotateUp",void 0);x([y()],_r.prototype,"keysRotateDown",void 0);ur.FreeCameraKeyboardMoveInput=_r});var Wl,qV=S(()=>{Ye();we();je();Yn();ns();$e();Wl=class{constructor(e=!0){this.touchEnabled=e,this.buttons=[0,1,2],this.angularSensibility=2e3,this._previousPosition=null,this.onPointerMovedObservable=new N,this._allowCameraRotation=!0,this._currentActiveButton=-1,this._activePointerId=-1}attachControl(e){e=W.BackCompatCameraNoPreventDefault(arguments);let t=this.camera.getEngine(),i=t.getInputElement();this._pointerInput||(this._pointerInput=r=>{let n=r.event,a=n.pointerType==="touch";if(!this.touchEnabled&&a||r.type!==ce.POINTERMOVE&&this.buttons.indexOf(n.button)===-1)return;let o=n.target;if(r.type===ce.POINTERDOWN){if(a&&this._activePointerId!==-1||!a&&this._currentActiveButton!==-1)return;this._activePointerId=n.pointerId;try{o?.setPointerCapture(n.pointerId)}catch{}this._currentActiveButton===-1&&(this._currentActiveButton=n.button),this._previousPosition={x:n.clientX,y:n.clientY},e||(n.preventDefault(),i&&i.focus()),t.isPointerLock&&this._onMouseMove&&this._onMouseMove(r.event)}else if(r.type===ce.POINTERUP){if(a&&this._activePointerId!==n.pointerId||!a&&this._currentActiveButton!==n.button)return;try{o?.releasePointerCapture(n.pointerId)}catch{}this._currentActiveButton=-1,this._previousPosition=null,e||n.preventDefault(),this._activePointerId=-1}else if(r.type===ce.POINTERMOVE&&(this._activePointerId===n.pointerId||!a)){if(t.isPointerLock&&this._onMouseMove)this._onMouseMove(r.event);else if(this._previousPosition){let l=this.camera._calculateHandednessMultiplier(),c=(n.clientX-this._previousPosition.x)*l,f=(n.clientY-this._previousPosition.y)*l;this._allowCameraRotation&&(this.camera.cameraRotation.y+=c/this.angularSensibility,this.camera.cameraRotation.x+=f/this.angularSensibility),this.onPointerMovedObservable.notifyObservers({offsetX:c,offsetY:f}),this._previousPosition={x:n.clientX,y:n.clientY},e||n.preventDefault()}}}),this._onMouseMove=r=>{if(!t.isPointerLock)return;let n=this.camera._calculateHandednessMultiplier();this.camera.cameraRotation.y+=r.movementX*n/this.angularSensibility,this.camera.cameraRotation.x+=r.movementY*n/this.angularSensibility,this._previousPosition=null,e||r.preventDefault()},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,ce.POINTERDOWN|ce.POINTERUP|ce.POINTERMOVE),i&&(this._contextMenuBind=r=>this.onContextMenu(r),i.addEventListener("contextmenu",this._contextMenuBind,!1))}onContextMenu(e){e.preventDefault()}detachControl(){if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._contextMenuBind){let t=this.camera.getEngine().getInputElement();t&&t.removeEventListener("contextmenu",this._contextMenuBind)}this.onPointerMovedObservable&&this.onPointerMovedObservable.clear(),this._observer=null,this._onMouseMove=null,this._previousPosition=null}this._activePointerId=-1,this._currentActiveButton=-1}getClassName(){return"FreeCameraMouseInput"}getSimpleName(){return"mouse"}};x([y()],Wl.prototype,"buttons",void 0);x([y()],Wl.prototype,"angularSensibility",void 0);ur.FreeCameraMouseInput=Wl});var Hl,QV=S(()=>{Ye();je();we();ns();xm();$e();Hl=class{constructor(){this.wheelPrecisionX=3,this.wheelPrecisionY=3,this.wheelPrecisionZ=3,this.onChangedObservable=new N,this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0,this._ffMultiplier=12,this._normalize=120}attachControl(e){e=W.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==ce.POINTERWHEEL)return;let i=t.event,r=i.deltaMode===en.DOM_DELTA_LINE?this._ffMultiplier:1;this._wheelDeltaX+=this.wheelPrecisionX*r*i.deltaX/this._normalize,this._wheelDeltaY-=this.wheelPrecisionY*r*i.deltaY/this._normalize,this._wheelDeltaZ+=this.wheelPrecisionZ*r*i.deltaZ/this._normalize,i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,ce.POINTERWHEEL)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null),this.onChangedObservable&&this.onChangedObservable.clear()}checkInputs(){this.onChangedObservable.notifyObservers({wheelDeltaX:this._wheelDeltaX,wheelDeltaY:this._wheelDeltaY,wheelDeltaZ:this._wheelDeltaZ}),this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0}getClassName(){return"BaseCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}};x([y()],Hl.prototype,"wheelPrecisionX",void 0);x([y()],Hl.prototype,"wheelPrecisionY",void 0);x([y()],Hl.prototype,"wheelPrecisionZ",void 0)});var Pt,jr,jV=S(()=>{Ye();je();Yn();QV();ie();(function(s){s[s.MoveRelative=0]="MoveRelative",s[s.RotateRelative=1]="RotateRelative",s[s.MoveScene=2]="MoveScene"})(Pt||(Pt={}));jr=class extends Hl{constructor(){super(...arguments),this._moveRelative=E.Zero(),this._rotateRelative=E.Zero(),this._moveScene=E.Zero(),this._wheelXAction=Pt.MoveRelative,this._wheelXActionCoordinate=0,this._wheelYAction=Pt.MoveRelative,this._wheelYActionCoordinate=2,this._wheelZAction=null,this._wheelZActionCoordinate=null}getClassName(){return"FreeCameraMouseWheelInput"}set wheelXMoveRelative(e){e===null&&this._wheelXAction!==Pt.MoveRelative||(this._wheelXAction=Pt.MoveRelative,this._wheelXActionCoordinate=e)}get wheelXMoveRelative(){return this._wheelXAction!==Pt.MoveRelative?null:this._wheelXActionCoordinate}set wheelYMoveRelative(e){e===null&&this._wheelYAction!==Pt.MoveRelative||(this._wheelYAction=Pt.MoveRelative,this._wheelYActionCoordinate=e)}get wheelYMoveRelative(){return this._wheelYAction!==Pt.MoveRelative?null:this._wheelYActionCoordinate}set wheelZMoveRelative(e){e===null&&this._wheelZAction!==Pt.MoveRelative||(this._wheelZAction=Pt.MoveRelative,this._wheelZActionCoordinate=e)}get wheelZMoveRelative(){return this._wheelZAction!==Pt.MoveRelative?null:this._wheelZActionCoordinate}set wheelXRotateRelative(e){e===null&&this._wheelXAction!==Pt.RotateRelative||(this._wheelXAction=Pt.RotateRelative,this._wheelXActionCoordinate=e)}get wheelXRotateRelative(){return this._wheelXAction!==Pt.RotateRelative?null:this._wheelXActionCoordinate}set wheelYRotateRelative(e){e===null&&this._wheelYAction!==Pt.RotateRelative||(this._wheelYAction=Pt.RotateRelative,this._wheelYActionCoordinate=e)}get wheelYRotateRelative(){return this._wheelYAction!==Pt.RotateRelative?null:this._wheelYActionCoordinate}set wheelZRotateRelative(e){e===null&&this._wheelZAction!==Pt.RotateRelative||(this._wheelZAction=Pt.RotateRelative,this._wheelZActionCoordinate=e)}get wheelZRotateRelative(){return this._wheelZAction!==Pt.RotateRelative?null:this._wheelZActionCoordinate}set wheelXMoveScene(e){e===null&&this._wheelXAction!==Pt.MoveScene||(this._wheelXAction=Pt.MoveScene,this._wheelXActionCoordinate=e)}get wheelXMoveScene(){return this._wheelXAction!==Pt.MoveScene?null:this._wheelXActionCoordinate}set wheelYMoveScene(e){e===null&&this._wheelYAction!==Pt.MoveScene||(this._wheelYAction=Pt.MoveScene,this._wheelYActionCoordinate=e)}get wheelYMoveScene(){return this._wheelYAction!==Pt.MoveScene?null:this._wheelYActionCoordinate}set wheelZMoveScene(e){e===null&&this._wheelZAction!==Pt.MoveScene||(this._wheelZAction=Pt.MoveScene,this._wheelZActionCoordinate=e)}get wheelZMoveScene(){return this._wheelZAction!==Pt.MoveScene?null:this._wheelZActionCoordinate}checkInputs(){if(this._wheelDeltaX===0&&this._wheelDeltaY===0&&this._wheelDeltaZ==0)return;this._moveRelative.setAll(0),this._rotateRelative.setAll(0),this._moveScene.setAll(0),this._updateCamera(),this.camera.getScene().useRightHandedSystem&&(this._moveRelative.z*=-1);let e=B.Zero();this.camera.getViewMatrix().invertToRef(e);let t=E.Zero();E.TransformNormalToRef(this._moveRelative,e,t),this.camera.cameraRotation.x+=this._rotateRelative.x/200,this.camera.cameraRotation.y+=this._rotateRelative.y/200,this.camera.cameraDirection.addInPlace(t),this.camera.cameraDirection.addInPlace(this._moveScene),super.checkInputs()}_updateCamera(){this._updateCameraProperty(this._wheelDeltaX,this._wheelXAction,this._wheelXActionCoordinate),this._updateCameraProperty(this._wheelDeltaY,this._wheelYAction,this._wheelYActionCoordinate),this._updateCameraProperty(this._wheelDeltaZ,this._wheelZAction,this._wheelZActionCoordinate)}_updateCameraProperty(e,t,i){if(e===0||t===null||i===null)return;let r=null;switch(t){case Pt.MoveRelative:r=this._moveRelative;break;case Pt.RotateRelative:r=this._rotateRelative;break;case Pt.MoveScene:r=this._moveScene;break}switch(i){case 0:r.set(e,0,0);break;case 1:r.set(0,e,0);break;case 2:r.set(0,0,e);break}}};x([y()],jr.prototype,"wheelXMoveRelative",null);x([y()],jr.prototype,"wheelYMoveRelative",null);x([y()],jr.prototype,"wheelZMoveRelative",null);x([y()],jr.prototype,"wheelXRotateRelative",null);x([y()],jr.prototype,"wheelYRotateRelative",null);x([y()],jr.prototype,"wheelZRotateRelative",null);x([y()],jr.prototype,"wheelXMoveScene",null);x([y()],jr.prototype,"wheelYMoveScene",null);x([y()],jr.prototype,"wheelZMoveScene",null);ur.FreeCameraMouseWheelInput=jr});var zl,ZV=S(()=>{Ye();je();Yn();ns();ie();$e();zl=class{constructor(e=!1){this.allowMouse=e,this.touchAngularSensibility=2e5,this.touchMoveSensibility=250,this.singleFingerRotate=!1,this._offsetX=null,this._offsetY=null,this._pointerPressed=new Array,this._isSafari=W.IsSafari()}attachControl(e){e=W.BackCompatCameraNoPreventDefault(arguments);let t=null;if(this._pointerInput===void 0&&(this._onLostFocus=()=>{this._offsetX=null,this._offsetY=null},this._pointerInput=i=>{let r=i.event,n=r.pointerType==="mouse"||this._isSafari&&typeof r.pointerType>"u";if(!(!this.allowMouse&&n)){if(i.type===ce.POINTERDOWN){if(e||r.preventDefault(),this._pointerPressed.push(r.pointerId),this._pointerPressed.length!==1)return;t={x:r.clientX,y:r.clientY}}else if(i.type===ce.POINTERUP){e||r.preventDefault();let a=this._pointerPressed.indexOf(r.pointerId);if(a===-1||(this._pointerPressed.splice(a,1),a!=0))return;t=null,this._offsetX=null,this._offsetY=null}else if(i.type===ce.POINTERMOVE){if(e||r.preventDefault(),!t||this._pointerPressed.indexOf(r.pointerId)!=0)return;this._offsetX=r.clientX-t.x,this._offsetY=-(r.clientY-t.y)}}}),this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,ce.POINTERDOWN|ce.POINTERUP|ce.POINTERMOVE),this._onLostFocus){let r=this.camera.getEngine().getInputElement();r&&r.addEventListener("blur",this._onLostFocus)}}detachControl(){if(this._pointerInput){if(this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null),this._onLostFocus){let t=this.camera.getEngine().getInputElement();t&&t.removeEventListener("blur",this._onLostFocus),this._onLostFocus=null}this._pointerPressed.length=0,this._offsetX=null,this._offsetY=null}}checkInputs(){if(this._offsetX===null||this._offsetY===null||this._offsetX===0&&this._offsetY===0)return;let e=this.camera,t=e._calculateHandednessMultiplier();if(e.cameraRotation.y=this._offsetX*t/this.touchAngularSensibility,this.singleFingerRotate&&this._pointerPressed.length===1||!this.singleFingerRotate&&this._pointerPressed.length>1)e.cameraRotation.x=-(this._offsetY*t)/this.touchAngularSensibility;else{let r=e._computeLocalCameraSpeed(),n=new E(0,0,this.touchMoveSensibility!==0?r*this._offsetY/this.touchMoveSensibility:0);B.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,e._cameraRotationMatrix),e.cameraDirection.addInPlace(E.TransformCoordinates(n,e._cameraRotationMatrix))}}getClassName(){return"FreeCameraTouchInput"}getSimpleName(){return"touch"}};x([y()],zl.prototype,"touchAngularSensibility",void 0);x([y()],zl.prototype,"touchMoveSensibility",void 0);ur.FreeCameraTouchInput=zl});var og,JV=S(()=>{Yn();KV();qV();jV();ZV();og=class extends Cf{constructor(e){super(e),this._mouseInput=null,this._mouseWheelInput=null}addKeyboard(){return this.add(new _r),this}addMouse(e=!0){return this._mouseInput||(this._mouseInput=new Wl(e),this.add(this._mouseInput)),this}removeMouse(){return this._mouseInput&&this.remove(this._mouseInput),this}addMouseWheel(){return this._mouseWheelInput||(this._mouseWheelInput=new jr,this.add(this._mouseWheelInput)),this}removeMouseWheel(){return this._mouseWheelInput&&this.remove(this._mouseWheelInput),this}addTouch(){return this.add(new zl),this}clear(){super.clear(),this._mouseInput=null}}});var Qa,$V=S(()=>{Ye();je();ie();EC();JV();$e();Te();Jt();Qa=class extends Yr{get angularSensibility(){let e=this.inputs.attached.mouse;return e?e.angularSensibility:0}set angularSensibility(e){let t=this.inputs.attached.mouse;t&&(t.angularSensibility=e)}get keysUp(){let e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){let t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysUpward(){let e=this.inputs.attached.keyboard;return e?e.keysUpward:[]}set keysUpward(e){let t=this.inputs.attached.keyboard;t&&(t.keysUpward=e)}get keysDown(){let e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){let t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysDownward(){let e=this.inputs.attached.keyboard;return e?e.keysDownward:[]}set keysDownward(e){let t=this.inputs.attached.keyboard;t&&(t.keysDownward=e)}get keysLeft(){let e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){let t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){let e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){let t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}get keysRotateLeft(){let e=this.inputs.attached.keyboard;return e?e.keysRotateLeft:[]}set keysRotateLeft(e){let t=this.inputs.attached.keyboard;t&&(t.keysRotateLeft=e)}get keysRotateRight(){let e=this.inputs.attached.keyboard;return e?e.keysRotateRight:[]}set keysRotateRight(e){let t=this.inputs.attached.keyboard;t&&(t.keysRotateRight=e)}get keysRotateUp(){let e=this.inputs.attached.keyboard;return e?e.keysRotateUp:[]}set keysRotateUp(e){let t=this.inputs.attached.keyboard;t&&(t.keysRotateUp=e)}get keysRotateDown(){let e=this.inputs.attached.keyboard;return e?e.keysRotateDown:[]}set keysRotateDown(e){let t=this.inputs.attached.keyboard;t&&(t.keysRotateDown=e)}constructor(e,t,i,r=!0){super(e,t,i,r),this.ellipsoid=new E(.5,1,.5),this.ellipsoidOffset=new E(0,0,0),this.checkCollisions=!1,this.applyGravity=!1,this._needMoveForGravity=!1,this._oldPosition=E.Zero(),this._diffPosition=E.Zero(),this._newPosition=E.Zero(),this._collisionMask=-1,this._onCollisionPositionChange=(n,a,o=null)=>{this._newPosition.copyFrom(a),this._newPosition.subtractToRef(this._oldPosition,this._diffPosition),this._diffPosition.length()>k.CollisionsEpsilon&&(this.position.addToRef(this._diffPosition,this._deferredPositionUpdate),this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate),this.onCollide&&o&&this.onCollide(o))},this.inputs=new og(this),this.inputs.addKeyboard().addMouse()}attachControl(e,t){t=W.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t)}detachControl(){this.inputs.detachElement(),this.cameraDirection=new E(0,0,0),this.cameraRotation=new he(0,0)}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}_collideWithWorld(e){let t;this.parent?t=E.TransformCoordinates(this.position,this.parent.getWorldMatrix()):t=this.position,t.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);let i=this.getScene().collisionCoordinator;this._collider||(this._collider=i.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;let r=e;this.applyGravity&&(r=e.add(this.getScene().gravity)),i.getNewPosition(this._oldPosition,r,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}_checkInputs(){this._localDirection||(this._localDirection=E.Zero(),this._transformedDirection=E.Zero()),this.inputs.checkInputs(),super._checkInputs()}set needMoveForGravity(e){this._needMoveForGravity=e}get needMoveForGravity(){return this._needMoveForGravity}_decideIfNeedsToMove(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):super._updatePosition()}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"FreeCamera"}};x([oi()],Qa.prototype,"ellipsoid",void 0);x([oi()],Qa.prototype,"ellipsoidOffset",void 0);x([y()],Qa.prototype,"checkCollisions",void 0);x([y()],Qa.prototype,"applyGravity",void 0);G("BABYLON.FreeCamera",Qa)});var Zr,ku=S(()=>{ie();Hs();rs();Zr=class s extends _t{get _matrix(){return this._compose(),this._localMatrix}set _matrix(e){e.updateFlag===this._localMatrix.updateFlag&&!this._needToCompose||(this._needToCompose=!1,this._localMatrix.copyFrom(e),this._markAsDirtyAndDecompose())}constructor(e,t,i=null,r=null,n=null,a=null,o=null){super(e,t.getScene(),!1),this.name=e,this.children=[],this.animations=[],this._index=null,this._scalingDeterminant=1,this._needToDecompose=!0,this._needToCompose=!1,this._linkedTransformNode=null,this._waitingTransformNodeId=null,this._skeleton=t,this._localMatrix=r?.clone()??B.Identity(),this._restMatrix=n??this._localMatrix.clone(),this._bindMatrix=a??this._localMatrix.clone(),this._index=o,this._absoluteMatrix=new B,this._absoluteBindMatrix=new B,this._absoluteInverseBindMatrix=new B,this._finalMatrix=new B,t.bones.push(this),this.setParent(i,!1),this._updateAbsoluteBindMatrices()}getClassName(){return"Bone"}getSkeleton(){return this._skeleton}get parent(){return this._parentNode}getParent(){return this.parent}getChildren(){return this.children}getIndex(){return this._index===null?this.getSkeleton().bones.indexOf(this):this._index}set parent(e){this.setParent(e)}setParent(e,t=!0){if(this.parent!==e){if(this.parent){let i=this.parent.children.indexOf(this);i!==-1&&this.parent.children.splice(i,1)}this._parentNode=e,this.parent&&this.parent.children.push(this),t&&this._updateAbsoluteBindMatrices(),this.markAsDirty()}}getLocalMatrix(){return this._compose(),this._localMatrix}getBindMatrix(){return this._bindMatrix}getBaseMatrix(){return this.getBindMatrix()}getRestMatrix(){return this._restMatrix}getRestPose(){return this.getRestMatrix()}setRestMatrix(e){this._restMatrix.copyFrom(e)}setRestPose(e){this.setRestMatrix(e)}getBindPose(){return this.getBindMatrix()}setBindMatrix(e){this.updateMatrix(e)}setBindPose(e){this.setBindMatrix(e)}getFinalMatrix(){return this._finalMatrix}getWorldMatrix(){return this.getFinalMatrix()}returnToRest(){if(this._linkedTransformNode){let e=w.Vector3[0],t=w.Quaternion[0],i=w.Vector3[1];this.getRestMatrix().decompose(e,t,i),this._linkedTransformNode.position.copyFrom(i),this._linkedTransformNode.rotationQuaternion=this._linkedTransformNode.rotationQuaternion??K.Identity(),this._linkedTransformNode.rotationQuaternion.copyFrom(t),this._linkedTransformNode.scaling.copyFrom(e)}else this._matrix=this._restMatrix}getAbsoluteInverseBindMatrix(){return this._absoluteInverseBindMatrix}getInvertedAbsoluteTransform(){return this.getAbsoluteInverseBindMatrix()}getAbsoluteMatrix(){return this._skeleton.computeAbsoluteMatrices(),this._absoluteMatrix}getAbsoluteTransform(){return this.getAbsoluteMatrix()}linkTransformNode(e){this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode--,this._linkedTransformNode=e,this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode++}getTransformNode(){return this._linkedTransformNode}get position(){return this._decompose(),this._localPosition}set position(e){this._decompose(),this._localPosition.copyFrom(e),this._markAsDirtyAndCompose()}get rotation(){return this.getRotation()}set rotation(e){this.setRotation(e)}get rotationQuaternion(){return this._decompose(),this._localRotation}set rotationQuaternion(e){this.setRotationQuaternion(e)}get scaling(){return this.getScale()}set scaling(e){this.setScale(e)}get animationPropertiesOverride(){return this._skeleton.animationPropertiesOverride}_decompose(){this._needToDecompose&&(this._needToDecompose=!1,this._localScaling||(this._localScaling=E.Zero(),this._localRotation=K.Zero(),this._localPosition=E.Zero()),this._localMatrix.decompose(this._localScaling,this._localRotation,this._localPosition))}_compose(){if(this._needToCompose){if(!this._localScaling){this._needToCompose=!1;return}this._needToCompose=!1,B.ComposeToRef(this._localScaling,this._localRotation,this._localPosition,this._localMatrix)}}updateMatrix(e,t=!0,i=!0){this._bindMatrix.copyFrom(e),t&&this._updateAbsoluteBindMatrices(),i?this._matrix=e:this.markAsDirty()}_updateAbsoluteBindMatrices(e,t=!0){if(e||(e=this._bindMatrix),this.parent?e.multiplyToRef(this.parent._absoluteBindMatrix,this._absoluteBindMatrix):this._absoluteBindMatrix.copyFrom(e),this._absoluteBindMatrix.invertToRef(this._absoluteInverseBindMatrix),t)for(let i=0;i<this.children.length;i++)this.children[i]._updateAbsoluteBindMatrices();this._scalingDeterminant=this._absoluteBindMatrix.determinant()<0?-1:1}markAsDirty(){return this._currentRenderId++,this._childUpdateId++,this._skeleton._markAsDirty(),this}_markAsDirtyAndCompose(){this.markAsDirty(),this._needToCompose=!0}_markAsDirtyAndDecompose(){this.markAsDirty(),this._needToDecompose=!0}_updatePosition(e,t=0,i,r=!0){let n=this.getLocalMatrix();if(t==0)r?(n.addAtIndex(12,e.x),n.addAtIndex(13,e.y),n.addAtIndex(14,e.z)):n.setTranslationFromFloats(e.x,e.y,e.z);else{let a=s._TmpMats[0],o=s._TmpVecs[0];this.parent?(a.copyFrom(this.parent.getAbsoluteMatrix()),i&&a.multiplyToRef(i.getWorldMatrix(),a)):B.IdentityToRef(a),r&&a.setTranslationFromFloats(0,0,0),a.invert(),E.TransformCoordinatesToRef(e,a,o),r?(n.addAtIndex(12,o.x),n.addAtIndex(13,o.y),n.addAtIndex(14,o.z)):n.setTranslationFromFloats(o.x,o.y,o.z)}this._markAsDirtyAndDecompose()}translate(e,t=0,i){this._updatePosition(e,t,i,!0)}setPosition(e,t=0,i){this._updatePosition(e,t,i,!1)}setAbsolutePosition(e,t){this.setPosition(e,1,t)}scale(e,t,i,r=!1){let n=this.getLocalMatrix(),a=s._TmpMats[0];B.ScalingToRef(e,t,i,a),a.multiplyToRef(n,n),a.invert();for(let o of this.children){let l=o.getLocalMatrix();l.multiplyToRef(a,l),l.multiplyAtIndex(12,e),l.multiplyAtIndex(13,t),l.multiplyAtIndex(14,i),o._markAsDirtyAndDecompose()}if(this._markAsDirtyAndDecompose(),r)for(let o of this.children)o.scale(e,t,i,r)}setScale(e){this._decompose(),this._localScaling.copyFrom(e),this._markAsDirtyAndCompose()}getScale(){return this._decompose(),this._localScaling}getScaleToRef(e){this._decompose(),e.copyFrom(this._localScaling)}setYawPitchRoll(e,t,i,r=0,n){if(r===0){let l=s._TmpQuat;K.RotationYawPitchRollToRef(e,t,i,l),this.setRotationQuaternion(l,r,n);return}let a=s._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(a,n))return;let o=s._TmpMats[1];B.RotationYawPitchRollToRef(e,t,i,o),a.multiplyToRef(o,o),this._rotateWithMatrix(o,r,n)}rotate(e,t,i=0,r){let n=s._TmpMats[0];n.setTranslationFromFloats(0,0,0),B.RotationAxisToRef(e,t,n),this._rotateWithMatrix(n,i,r)}setAxisAngle(e,t,i=0,r){if(i===0){let o=s._TmpQuat;K.RotationAxisToRef(e,t,o),this.setRotationQuaternion(o,i,r);return}let n=s._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(n,r))return;let a=s._TmpMats[1];B.RotationAxisToRef(e,t,a),n.multiplyToRef(a,a),this._rotateWithMatrix(a,i,r)}setRotation(e,t=0,i){this.setYawPitchRoll(e.y,e.x,e.z,t,i)}setRotationQuaternion(e,t=0,i){if(t===0){this._decompose(),this._localRotation.copyFrom(e),this._markAsDirtyAndCompose();return}let r=s._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(r,i))return;let n=s._TmpMats[1];B.FromQuaternionToRef(e,n),r.multiplyToRef(n,n),this._rotateWithMatrix(n,t,i)}setRotationMatrix(e,t=0,i){if(t===0){let a=s._TmpQuat;K.FromRotationMatrixToRef(e,a),this.setRotationQuaternion(a,t,i);return}let r=s._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(r,i))return;let n=s._TmpMats[1];n.copyFrom(e),r.multiplyToRef(e,n),this._rotateWithMatrix(n,t,i)}_rotateWithMatrix(e,t=0,i){let r=this.getLocalMatrix(),n=r.m[12],a=r.m[13],o=r.m[14],l=this.getParent(),c=s._TmpMats[3],f=s._TmpMats[4];l&&t==1?(i?(c.copyFrom(i.getWorldMatrix()),l.getAbsoluteMatrix().multiplyToRef(c,c)):c.copyFrom(l.getAbsoluteMatrix()),f.copyFrom(c),f.invert(),r.multiplyToRef(c,r),r.multiplyToRef(e,r),r.multiplyToRef(f,r)):t==1&&i?(c.copyFrom(i.getWorldMatrix()),f.copyFrom(c),f.invert(),r.multiplyToRef(c,r),r.multiplyToRef(e,r),r.multiplyToRef(f,r)):r.multiplyToRef(e,r),r.setTranslationFromFloats(n,a,o),this._markAsDirtyAndDecompose()}_getAbsoluteInverseMatrixUnscaledToRef(e,t){let i=s._TmpMats[2];return e.copyFrom(this.getAbsoluteMatrix()),t?(e.multiplyToRef(t.getWorldMatrix(),e),B.ScalingToRef(t.scaling.x,t.scaling.y,t.scaling.z,i)):B.IdentityToRef(i),e.invert(),isNaN(e.m[0])?!1:(i.multiplyAtIndex(0,this._scalingDeterminant),e.multiplyToRef(i,e),!0)}getPosition(e=0,t=null){let i=E.Zero();return this.getPositionToRef(e,t,i),i}getPositionToRef(e=0,t,i){if(e==0){let r=this.getLocalMatrix();i.x=r.m[12],i.y=r.m[13],i.z=r.m[14]}else{let r=s._TmpMats[0].copyFrom(this.getAbsoluteMatrix());t&&r.multiplyToRef(t.getWorldMatrix(),r),i.x=r.m[12],i.y=r.m[13],i.z=r.m[14]}}getAbsolutePosition(e=null){let t=E.Zero();return this.getPositionToRef(1,e,t),t}getAbsolutePositionToRef(e,t){this.getPositionToRef(1,e,t)}computeAbsoluteMatrices(){if(this._compose(),this.parent)this._localMatrix.multiplyToRef(this.parent._absoluteMatrix,this._absoluteMatrix);else{this._absoluteMatrix.copyFrom(this._localMatrix);let i=this._skeleton.getPoseMatrix();i&&this._absoluteMatrix.multiplyToRef(i,this._absoluteMatrix)}let e=this.children,t=e.length;for(let i=0;i<t;i++)e[i].computeAbsoluteMatrices()}computeAbsoluteTransforms(){this.computeAbsoluteMatrices()}getDirection(e,t=null){let i=E.Zero();return this.getDirectionToRef(e,t,i),i}getDirectionToRef(e,t=null,i){let r=s._TmpMats[0].copyFrom(this.getAbsoluteMatrix());t&&r.multiplyToRef(t.getWorldMatrix(),r),E.TransformNormalToRef(e,r,i),i.normalize()}getRotation(e=0,t=null){let i=E.Zero();return this.getRotationToRef(e,t,i),i}getRotationToRef(e=0,t=null,i){let r=s._TmpQuat;this.getRotationQuaternionToRef(e,t,r),r.toEulerAnglesToRef(i)}getRotationQuaternion(e=0,t=null){let i=K.Identity();return this.getRotationQuaternionToRef(e,t,i),i}getRotationQuaternionToRef(e=0,t=null,i){if(e==0)this._decompose(),i.copyFrom(this._localRotation);else{let r=s._TmpMats[0],n=this.getAbsoluteMatrix();t?n.multiplyToRef(t.getWorldMatrix(),r):r.copyFrom(n),r.multiplyAtIndex(0,this._scalingDeterminant),r.multiplyAtIndex(1,this._scalingDeterminant),r.multiplyAtIndex(2,this._scalingDeterminant),r.decompose(void 0,i,void 0)}}getRotationMatrix(e=0,t){let i=B.Identity();return this.getRotationMatrixToRef(e,t,i),i}getRotationMatrixToRef(e=0,t,i){if(e==0)this.getLocalMatrix().getRotationMatrixToRef(i);else{let r=s._TmpMats[0],n=this.getAbsoluteMatrix();t?n.multiplyToRef(t.getWorldMatrix(),r):r.copyFrom(n),r.multiplyAtIndex(0,this._scalingDeterminant),r.multiplyAtIndex(1,this._scalingDeterminant),r.multiplyAtIndex(2,this._scalingDeterminant),r.getRotationMatrixToRef(i)}}getAbsolutePositionFromLocal(e,t=null){let i=E.Zero();return this.getAbsolutePositionFromLocalToRef(e,t,i),i}getAbsolutePositionFromLocalToRef(e,t=null,i){let r=s._TmpMats[0].copyFrom(this.getAbsoluteMatrix());t&&r.multiplyToRef(t.getWorldMatrix(),r),E.TransformCoordinatesToRef(e,r,i)}getLocalPositionFromAbsolute(e,t=null){let i=E.Zero();return this.getLocalPositionFromAbsoluteToRef(e,t,i),i}getLocalPositionFromAbsoluteToRef(e,t=null,i){let r=s._TmpMats[0].copyFrom(this.getAbsoluteMatrix());t&&r.multiplyToRef(t.getWorldMatrix(),r),r.invert(),E.TransformCoordinatesToRef(e,r,i)}setCurrentPoseAsRest(){this.setRestMatrix(this.getLocalMatrix())}dispose(){this._linkedTransformNode=null;let e=this._skeleton.bones.indexOf(this);if(e!==-1&&this._skeleton.bones.splice(e,1),this._parentNode&&this._parentNode.children){let t=this._parentNode.children,i=t.indexOf(this);i!==-1&&t.splice(i,1)}super.dispose()}};Zr._TmpVecs=Gi(2,E.Zero);Zr._TmpQuat=K.Identity();Zr._TmpMats=Gi(5,B.Identity)});var yr,Wu=S(()=>{Ut();yr=class s extends H{constructor(e,t,i,r,n,a=!0,o=!1,l=3,c=0,f,h,u){super(null,n,!a,o,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,f),this.format=r,this._engine&&(!this._engine._caps.textureFloatLinearFiltering&&c===1&&(l=1),!this._engine._caps.textureHalfFloatLinearFiltering&&c===2&&(l=1),this._texture=this._engine.createRawTexture(e,t,i,r,a,o,l,null,c,f??0,h??!1),this.wrapU=H.CLAMP_ADDRESSMODE,this.wrapV=H.CLAMP_ADDRESSMODE,this._waitingForData=!!u&&!e)}update(e){this._getEngine().updateRawTexture(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type,this._texture._useSRGBBuffer),this._waitingForData=!1}clone(){if(!this._texture)return super.clone();let e=new s(null,this.getSize().width,this.getSize().height,this.format,this.getScene(),this._texture.generateMipMaps,this._invertY,this.samplingMode,this._texture.type,this._texture._creationFlags,this._useSRGBBuffer);return e._texture=this._texture,this._texture.incrementReferences(),e}isReady(){return super.isReady()&&!this._waitingForData}static CreateLuminanceTexture(e,t,i,r,n=!0,a=!1,o=3){return new s(e,t,i,1,r,n,a,o)}static CreateLuminanceAlphaTexture(e,t,i,r,n=!0,a=!1,o=3){return new s(e,t,i,2,r,n,a,o)}static CreateAlphaTexture(e,t,i,r,n=!0,a=!1,o=3){return new s(e,t,i,0,r,n,a,o)}static CreateRGBTexture(e,t,i,r,n=!0,a=!1,o=3,l=0,c=0,f=!1){return new s(e,t,i,4,r,n,a,o,l,c,f)}static CreateRGBATexture(e,t,i,r,n=!0,a=!1,o=3,l=0,c=0,f=!1,h=!1){return new s(e,t,i,5,r,n,a,o,l,c,f,h)}static CreateRGBAStorageTexture(e,t,i,r,n=!0,a=!1,o=3,l=0,c=!1){return new s(e,t,i,5,r,n,a,o,l,1,c)}static CreateRTexture(e,t,i,r,n=!0,a=!1,o=H.TRILINEAR_SAMPLINGMODE,l=1){return new s(e,t,i,6,r,n,a,o,l)}static CreateRStorageTexture(e,t,i,r,n=!0,a=!1,o=H.TRILINEAR_SAMPLINGMODE,l=1){return new s(e,t,i,6,r,n,a,o,l,1)}}});var Uf,ey=S(()=>{ku();we();ie();Wu();ws();uC();gt();Ee();Ch();Uf=class s{get useTextureToStoreBoneMatrices(){return this._useTextureToStoreBoneMatrices}set useTextureToStoreBoneMatrices(e){this._useTextureToStoreBoneMatrices=e,this._markAsDirty()}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}get isUsingTextureForMatrices(){return this.useTextureToStoreBoneMatrices&&this._canUseTextureForBones}get uniqueId(){return this._uniqueId}constructor(e,t,i){this.name=e,this.id=t,this.bones=[],this.needInitialSkinMatrix=!1,this._isDirty=!0,this._meshesWithPoseMatrix=new Array,this._identity=B.Identity(),this._currentRenderId=-1,this._ranges={},this._absoluteTransformIsDirty=!0,this._canUseTextureForBones=!1,this._uniqueId=0,this._numBonesWithLinkedTransformNode=0,this._hasWaitingData=null,this._parentContainer=null,this.doNotSerialize=!1,this._useTextureToStoreBoneMatrices=!0,this._animationPropertiesOverride=null,this.onBeforeComputeObservable=new N,this.metadata=null,this.bones=[],this._scene=i||Z.LastCreatedScene,this._uniqueId=this._scene.getUniqueId(),this._scene.addSkeleton(this),this._isDirty=!0;let r=this._scene.getEngine().getCaps();this._canUseTextureForBones=r.textureFloat&&r.maxVertexTextureImageUnits>0}getClassName(){return"Skeleton"}getChildren(){return this.bones.filter(e=>!e.getParent())}getTransformMatrices(e){if(this.needInitialSkinMatrix){if(!e)throw new Error("getTransformMatrices: When using the needInitialSkinMatrix flag, a mesh must be provided");return e._bonesTransformMatrices||this.prepare(!0),e._bonesTransformMatrices}return(!this._transformMatrices||this._isDirty)&&this.prepare(!this._transformMatrices),this._transformMatrices}getTransformMatrixTexture(e){return this.needInitialSkinMatrix&&e._transformMatrixTexture?e._transformMatrixTexture:this._transformMatrixTexture}getScene(){return this._scene}toString(e){let t=`Name: ${this.name}, nBones: ${this.bones.length}`;if(t+=`, nAnimationRanges: ${this._ranges?Object.keys(this._ranges).length:"none"}`,e){t+=", Ranges: {";let i=!0;for(let r in this._ranges)i&&(t+=", ",i=!1),t+=r;t+="}"}return t}getBoneIndexByName(e){for(let t=0,i=this.bones.length;t<i;t++)if(this.bones[t].name===e)return t;return-1}createAnimationRange(e,t,i){if(!this._ranges[e]){this._ranges[e]=new Yo(e,t,i);for(let r=0,n=this.bones.length;r<n;r++)this.bones[r].animations[0]&&this.bones[r].animations[0].createRange(e,t,i)}}deleteAnimationRange(e,t=!0){for(let i=0,r=this.bones.length;i<r;i++)this.bones[i].animations[0]&&this.bones[i].animations[0].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}getAnimationRanges(){let e=[],t;for(t in this._ranges)e.push(this._ranges[t]);return e}copyAnimationRange(e,t,i=!1){if(this._ranges[t]||!e.getAnimationRange(t))return!1;let r=!0,n=this._getHighestAnimationFrame()+1,a={},o=e.bones,l,c;for(c=0,l=o.length;c<l;c++)a[o[c].name]=o[c];this.bones.length!==o.length&&(P.Warn(`copyAnimationRange: this rig has ${this.bones.length} bones, while source as ${o.length}`),r=!1);let f=i&&this.dimensionsAtRest&&e.dimensionsAtRest?this.dimensionsAtRest.divide(e.dimensionsAtRest):null;for(c=0,l=this.bones.length;c<l;c++){let u=this.bones[c].name,d=a[u];d?r=r&&this.bones[c].copyAnimationRange(d,t,n,i,f):(P.Warn("copyAnimationRange: not same rig, missing source bone "+u),r=!1)}let h=e.getAnimationRange(t);return h&&(this._ranges[t]=new Yo(t,h.from+n,h.to+n)),r}returnToRest(){for(let e of this.bones)e._index!==-1&&e.returnToRest()}_getHighestAnimationFrame(){let e=0;for(let t=0,i=this.bones.length;t<i;t++)if(this.bones[t].animations[0]){let r=this.bones[t].animations[0].getHighestFrame();e<r&&(e=r)}return e}beginAnimation(e,t,i,r){let n=this.getAnimationRange(e);return n?this._scene.beginAnimation(this,n.from,n.to,t,i,r):null}static MakeAnimationAdditive(e,t=0,i){let r=e.getAnimationRange(i);if(!r)return null;let n=e._scene.getAllAnimatablesByTarget(e),a=null;for(let l=0;l<n.length;l++){let c=n[l];if(c.fromFrame===r?.from&&c.toFrame===r?.to){a=c;break}}let o=e.getAnimatables();for(let l=0;l<o.length;l++){let f=o[l].animations;if(f)for(let h=0;h<f.length;h++)q.MakeAnimationAdditive(f[h],t,i)}return a&&(a.isAdditive=!0),e}_markAsDirty(){this._isDirty=!0,this._absoluteTransformIsDirty=!0}_registerMeshWithPoseMatrix(e){this._meshesWithPoseMatrix.push(e)}_unregisterMeshWithPoseMatrix(e){let t=this._meshesWithPoseMatrix.indexOf(e);t>-1&&this._meshesWithPoseMatrix.splice(t,1)}_computeTransformMatrices(e,t){this.onBeforeComputeObservable.notifyObservers(this);for(let i=0;i<this.bones.length;i++){let r=this.bones[i];r._childUpdateId++;let n=r.getParent();if(n?r.getLocalMatrix().multiplyToRef(n.getFinalMatrix(),r.getFinalMatrix()):t?r.getLocalMatrix().multiplyToRef(t,r.getFinalMatrix()):r.getFinalMatrix().copyFrom(r.getLocalMatrix()),r._index!==-1){let a=r._index===null?i:r._index;r.getAbsoluteInverseBindMatrix().multiplyToArray(r.getFinalMatrix(),e,a*16)}}this._identity.copyToArray(e,this.bones.length*16)}prepare(e=!1){if(!e){let t=this.getScene().getRenderId();if(this._currentRenderId===t)return;this._currentRenderId=t}if(this._numBonesWithLinkedTransformNode>0){for(let t of this.bones)if(t._linkedTransformNode){let i=t._linkedTransformNode;t.position=i.position,i.rotationQuaternion?t.rotationQuaternion=i.rotationQuaternion:t.rotation=i.rotation,t.scaling=i.scaling}}if(this.needInitialSkinMatrix)for(let t of this._meshesWithPoseMatrix){let i=t.getPoseMatrix(),r=this._isDirty;if((!t._bonesTransformMatrices||t._bonesTransformMatrices.length!==16*(this.bones.length+1))&&(t._bonesTransformMatrices=new Float32Array(16*(this.bones.length+1)),r=!0),!!r){if(this._synchronizedWithMesh!==t){this._synchronizedWithMesh=t;for(let n of this.bones)n.getParent()||(n.getBindMatrix().multiplyToRef(i,w.Matrix[1]),n._updateAbsoluteBindMatrices(w.Matrix[1]));if(this.isUsingTextureForMatrices){let n=(this.bones.length+1)*4;(!t._transformMatrixTexture||t._transformMatrixTexture.getSize().width!==n)&&(t._transformMatrixTexture&&t._transformMatrixTexture.dispose(),t._transformMatrixTexture=yr.CreateRGBATexture(t._bonesTransformMatrices,(this.bones.length+1)*4,1,this._scene,!1,!1,1,1))}}this._computeTransformMatrices(t._bonesTransformMatrices,i),this.isUsingTextureForMatrices&&t._transformMatrixTexture&&t._transformMatrixTexture.update(t._bonesTransformMatrices)}}else{if(!this._isDirty)return;(!this._transformMatrices||this._transformMatrices.length!==16*(this.bones.length+1))&&(this._transformMatrices=new Float32Array(16*(this.bones.length+1)),this.isUsingTextureForMatrices&&(this._transformMatrixTexture&&this._transformMatrixTexture.dispose(),this._transformMatrixTexture=yr.CreateRGBATexture(this._transformMatrices,(this.bones.length+1)*4,1,this._scene,!1,!1,1,1))),this._computeTransformMatrices(this._transformMatrices,null),this.isUsingTextureForMatrices&&this._transformMatrixTexture&&this._transformMatrixTexture.update(this._transformMatrices)}this._isDirty=!1}getAnimatables(){if(!this._animatables||this._animatables.length!==this.bones.length){this._animatables=[];for(let e=0;e<this.bones.length;e++)this._animatables.push(this.bones[e])}return this._animatables}clone(e,t){let i=new s(e,t||e,this._scene);i.needInitialSkinMatrix=this.needInitialSkinMatrix,i.metadata=this.metadata;for(let r=0;r<this.bones.length;r++){let n=this.bones[r],a=null,o=n.getParent();if(o){let c=this.bones.indexOf(o);a=i.bones[c]}let l=new Zr(n.name,i,a,n.getBindMatrix().clone(),n.getRestMatrix().clone());l._index=n._index,n._linkedTransformNode&&l.linkTransformNode(n._linkedTransformNode),xn.DeepCopy(n.animations,l.animations)}if(this._ranges){i._ranges={};for(let r in this._ranges){let n=this._ranges[r];n&&(i._ranges[r]=n.clone())}}return this._isDirty=!0,i.prepare(!0),i}enableBlending(e=.01){for(let t of this.bones)for(let i of t.animations)i.enableBlending=!0,i.blendingSpeed=e}dispose(){if(this._meshesWithPoseMatrix.length=0,this.metadata=null,this.getScene().stopAnimation(this),this.getScene().removeSkeleton(this),this._parentContainer){let e=this._parentContainer.skeletons.indexOf(this);e>-1&&this._parentContainer.skeletons.splice(e,1),this._parentContainer=null}this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null)}serialize(){let e={};e.name=this.name,e.id=this.id,this.dimensionsAtRest&&(e.dimensionsAtRest=this.dimensionsAtRest.asArray()),e.bones=[],e.needInitialSkinMatrix=this.needInitialSkinMatrix,this.metadata&&(e.metadata=this.metadata);for(let t=0;t<this.bones.length;t++){let i=this.bones[t],r=i.getParent(),n={parentBoneIndex:r?this.bones.indexOf(r):-1,index:i.getIndex(),name:i.name,id:i.id,matrix:i.getBindMatrix().asArray(),rest:i.getRestMatrix().asArray(),linkedTransformNodeId:i.getTransformNode()?.id};e.bones.push(n),i.length&&(n.length=i.length),i.metadata&&(n.metadata=i.metadata),i.animations&&i.animations.length>0&&(n.animation=i.animations[0].serialize()),e.ranges=[];for(let a in this._ranges){let o=this._ranges[a];if(!o)continue;let l={};l.name=a,l.from=o.from,l.to=o.to,e.ranges.push(l)}}return e}static Parse(e,t){let i=new s(e.name,e.id,t);e.dimensionsAtRest&&(i.dimensionsAtRest=E.FromArray(e.dimensionsAtRest)),i.needInitialSkinMatrix=e.needInitialSkinMatrix,e.metadata&&(i.metadata=e.metadata);let r;for(r=0;r<e.bones.length;r++){let n=e.bones[r],a=e.bones[r].index,o=null;n.parentBoneIndex>-1&&(o=i.bones[n.parentBoneIndex]);let l=n.rest?B.FromArray(n.rest):null,c=new Zr(n.name,i,o,B.FromArray(n.matrix),l,null,a);n.id!==void 0&&n.id!==null&&(c.id=n.id),n.length&&(c.length=n.length),n.metadata&&(c.metadata=n.metadata),n.animation&&c.animations.push(q.Parse(n.animation)),n.linkedTransformNodeId!==void 0&&n.linkedTransformNodeId!==null&&(i._hasWaitingData=!0,c._waitingTransformNodeId=n.linkedTransformNodeId)}if(e.ranges)for(r=0;r<e.ranges.length;r++){let n=e.ranges[r];i.createAnimationRange(n.name,n.from,n.to)}return i}computeAbsoluteMatrices(e=!1){(this._absoluteTransformIsDirty||e)&&(this.bones[0].computeAbsoluteMatrices(),this._absoluteTransformIsDirty=!1)}computeAbsoluteTransforms(e=!1){this.computeAbsoluteMatrices(e)}getPoseMatrix(){let e=null;return this._meshesWithPoseMatrix.length>0&&(e=this._meshesWithPoseMatrix[0].getPoseMatrix()),e}sortBones(){let e=[],t=new Array(this.bones.length);for(let i=0;i<this.bones.length;i++)this._sortBones(i,e,t);this.bones=e}_sortBones(e,t,i){if(i[e])return;i[e]=!0;let r=this.bones[e];if(!r)return;r._index===void 0&&(r._index=e);let n=r.getParent();n&&this._sortBones(this.bones.indexOf(n),t,i),t.push(r)}setCurrentPoseAsRest(){for(let e of this.bones)e.setCurrentPoseAsRest()}}});var Xl,ty=S(()=>{Ye();we();gt();yt();je();ei();Te();Xl=class s{get influence(){return this._influence}set influence(e){if(this._influence===e)return;let t=this._influence;this._influence=e,this.onInfluenceChanged.hasObservers()&&this.onInfluenceChanged.notifyObservers(t===0||e===0)}get animationPropertiesOverride(){return!this._animationPropertiesOverride&&this._scene?this._scene.animationPropertiesOverride:this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}constructor(e,t=0,i=null){this.name=e,this.animations=[],this._positions=null,this._normals=null,this._tangents=null,this._uvs=null,this._uv2s=null,this._colors=null,this._uniqueId=0,this.onInfluenceChanged=new N,this._onDataLayoutChanged=new N,this._animationPropertiesOverride=null,this.id=e,this._scene=i||Z.LastCreatedScene,this.influence=t,this._scene&&(this._uniqueId=this._scene.getUniqueId())}get uniqueId(){return this._uniqueId}get hasPositions(){return!!this._positions}get hasNormals(){return!!this._normals}get hasTangents(){return!!this._tangents}get hasUVs(){return!!this._uvs}get hasUV2s(){return!!this._uv2s}get hasColors(){return!!this._colors}get vertexCount(){return this._positions?this._positions.length/3:this._normals?this._normals.length/3:this._tangents?this._tangents.length/3:this._uvs?this._uvs.length/2:this._uv2s?this._uv2s.length/2:this._colors?this._colors.length/4:0}setPositions(e){let t=this.hasPositions;this._positions=e,t!==this.hasPositions&&this._onDataLayoutChanged.notifyObservers(void 0)}getPositions(){return this._positions}setNormals(e){let t=this.hasNormals;this._normals=e,t!==this.hasNormals&&this._onDataLayoutChanged.notifyObservers(void 0)}getNormals(){return this._normals}setTangents(e){let t=this.hasTangents;this._tangents=e,t!==this.hasTangents&&this._onDataLayoutChanged.notifyObservers(void 0)}getTangents(){return this._tangents}setUVs(e){let t=this.hasUVs;this._uvs=e,t!==this.hasUVs&&this._onDataLayoutChanged.notifyObservers(void 0)}getUVs(){return this._uvs}setUV2s(e){let t=this.hasUV2s;this._uv2s=e,t!==this.hasUV2s&&this._onDataLayoutChanged.notifyObservers(void 0)}getUV2s(){return this._uv2s}setColors(e){let t=this.hasColors;this._colors=e,t!==this.hasColors&&this._onDataLayoutChanged.notifyObservers(void 0)}getColors(){return this._colors}clone(){let e=_e.Clone(()=>new s(this.name,this.influence,this._scene),this);return e._positions=this._positions,e._normals=this._normals,e._tangents=this._tangents,e._uvs=this._uvs,e._uv2s=this._uv2s,e._colors=this._colors,e}serialize(){let e={};return e.name=this.name,e.influence=this.influence,e.positions=Array.prototype.slice.call(this.getPositions()),this.id!=null&&(e.id=this.id),this.hasNormals&&(e.normals=Array.prototype.slice.call(this.getNormals())),this.hasTangents&&(e.tangents=Array.prototype.slice.call(this.getTangents())),this.hasUVs&&(e.uvs=Array.prototype.slice.call(this.getUVs())),this.hasUV2s&&(e.uv2s=Array.prototype.slice.call(this.getUV2s())),this.hasColors&&(e.colors=Array.prototype.slice.call(this.getColors())),_e.AppendSerializedAnimations(this,e),e}getClassName(){return"MorphTarget"}static Parse(e,t){let i=new s(e.name,e.influence);if(i.setPositions(e.positions),e.id!=null&&(i.id=e.id),e.normals&&i.setNormals(e.normals),e.tangents&&i.setTangents(e.tangents),e.uvs&&i.setUVs(e.uvs),e.uv2s&&i.setUV2s(e.uv2s),e.colors&&i.setColors(e.colors),e.animations){for(let r=0;r<e.animations.length;r++){let n=e.animations[r],a=Ci("BABYLON.Animation");a&&i.animations.push(a.Parse(n))}e.autoAnimate&&t&&t.beginAnimation(i,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1)}return i}static FromMesh(e,t,i){t||(t=e.name);let r=new s(t,i,e.getScene());return r.setPositions(e.getVerticesData(A.PositionKind)),e.isVerticesDataPresent(A.NormalKind)&&r.setNormals(e.getVerticesData(A.NormalKind)),e.isVerticesDataPresent(A.TangentKind)&&r.setTangents(e.getVerticesData(A.TangentKind)),e.isVerticesDataPresent(A.UVKind)&&r.setUVs(e.getVerticesData(A.UVKind)),e.isVerticesDataPresent(A.UV2Kind)&&r.setUV2s(e.getVerticesData(A.UV2Kind)),e.isVerticesDataPresent(A.ColorKind)&&r.setColors(e.getVerticesData(A.ColorKind)),r}};x([y()],Xl.prototype,"id",void 0)});var lg,ek=S(()=>{Ut();lg=class s extends H{get depth(){return this._depth}constructor(e,t,i,r,n,a,o=!0,l=!1,c=H.TRILINEAR_SAMPLINGMODE,f=0,h){super(null,a,!o,l),this.format=n,this._texture=a.getEngine().createRawTexture2DArray(e,t,i,r,n,o,l,c,null,f,h),this._depth=r,this.is2DArray=!0}update(e){this._texture&&this._getEngine().updateRawTexture2DArray(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type)}static CreateRGBATexture(e,t,i,r,n,a=!0,o=!1,l=3,c=0){return new s(e,t,i,r,5,n,a,o,l,c)}}});var Yl,tk=S(()=>{bn();Ee();gt();ty();ek();Yl=class s{set areUpdatesFrozen(e){e?this._blockCounter++:(this._blockCounter--,this._blockCounter<=0&&(this._blockCounter=0,this._syncActiveTargets(this._forceUpdateWhenUnfrozen),this._forceUpdateWhenUnfrozen=!1))}get areUpdatesFrozen(){return this._blockCounter>0}constructor(e=null){if(this._targets=new Array,this._targetInfluenceChangedObservers=new Array,this._targetDataLayoutChangedObservers=new Array,this._activeTargets=new wt(16),this._supportsPositions=!1,this._supportsNormals=!1,this._supportsTangents=!1,this._supportsUVs=!1,this._supportsUV2s=!1,this._supportsColors=!1,this._vertexCount=0,this._uniqueId=0,this._tempInfluences=new Array,this._canUseTextureForTargets=!1,this._blockCounter=0,this._mustSynchronize=!0,this._forceUpdateWhenUnfrozen=!1,this._textureVertexStride=0,this._textureWidth=0,this._textureHeight=1,this._parentContainer=null,this.optimizeInfluencers=!0,this.enablePositionMorphing=!0,this.enableNormalMorphing=!0,this.enableTangentMorphing=!0,this.enableUVMorphing=!0,this.enableUV2Morphing=!0,this.enableColorMorphing=!0,this._numMaxInfluencers=0,this._useTextureToStoreTargets=!0,this.metadata=null,e||(e=Z.LastCreatedScene),this._scene=e,this._scene){this._scene.addMorphTargetManager(this),this._uniqueId=this._scene.getUniqueId();let t=this._scene.getEngine().getCaps();this._canUseTextureForTargets=t.canUseGLVertexID&&t.textureFloat&&t.maxVertexTextureImageUnits>0&&t.texture2DArrayMaxLayerCount>1}}get numMaxInfluencers(){return s.ConstantTargetCountForTextureMode>0&&this.isUsingTextureForTargets?s.ConstantTargetCountForTextureMode:this._numMaxInfluencers}set numMaxInfluencers(e){this._numMaxInfluencers!==e&&(this._numMaxInfluencers=e,this._mustSynchronize=!0,this._syncActiveTargets())}get uniqueId(){return this._uniqueId}get vertexCount(){return this._vertexCount}get supportsPositions(){return this._supportsPositions&&this.enablePositionMorphing}get supportsNormals(){return this._supportsNormals&&this.enableNormalMorphing}get supportsTangents(){return this._supportsTangents&&this.enableTangentMorphing}get supportsUVs(){return this._supportsUVs&&this.enableUVMorphing}get supportsUV2s(){return this._supportsUV2s&&this.enableUV2Morphing}get supportsColors(){return this._supportsColors&&this.enableColorMorphing}get hasPositions(){return this._supportsPositions}get hasNormals(){return this._supportsNormals}get hasTangents(){return this._supportsTangents}get hasUVs(){return this._supportsUVs}get hasUV2s(){return this._supportsUV2s}get hasColors(){return this._supportsColors}get numTargets(){return this._targets.length}get numInfluencers(){return this._activeTargets.length}get influences(){return this._influences}get useTextureToStoreTargets(){return this._useTextureToStoreTargets}set useTextureToStoreTargets(e){this._useTextureToStoreTargets!==e&&(this._useTextureToStoreTargets=e,this._mustSynchronize=!0,this._syncActiveTargets())}get isUsingTextureForTargets(){return s.EnableTextureStorage&&this.useTextureToStoreTargets&&this._canUseTextureForTargets&&!this._scene?.getEngine().getCaps().disableMorphTargetTexture}getActiveTarget(e){return this._activeTargets.data[e]}getTarget(e){return this._targets[e]}getTargetByName(e){for(let t of this._targets)if(t.name===e)return t;return null}addTarget(e){this._targets.push(e),this._targetInfluenceChangedObservers.push(e.onInfluenceChanged.add(t=>{this.areUpdatesFrozen&&t&&(this._forceUpdateWhenUnfrozen=!0),this._syncActiveTargets(t)})),this._targetDataLayoutChangedObservers.push(e._onDataLayoutChanged.add(()=>{this._mustSynchronize=!0,this._syncActiveTargets()})),this._mustSynchronize=!0,this._syncActiveTargets()}removeTarget(e){let t=this._targets.indexOf(e);t>=0&&(this._targets.splice(t,1),e.onInfluenceChanged.remove(this._targetInfluenceChangedObservers.splice(t,1)[0]),e._onDataLayoutChanged.remove(this._targetDataLayoutChangedObservers.splice(t,1)[0]),this._mustSynchronize=!0,this._syncActiveTargets()),this._scene&&this._scene.stopAnimation(e)}_bind(e){e.setFloat3("morphTargetTextureInfo",this._textureVertexStride,this._textureWidth,this._textureHeight),e.setFloatArray("morphTargetTextureIndices",this._morphTargetTextureIndices),e.setTexture("morphTargets",this._targetStoreTexture),e.setFloat("morphTargetCount",this.numInfluencers)}clone(){let e=new s(this._scene);e.areUpdatesFrozen=!0;for(let t of this._targets)e.addTarget(t.clone());return e.areUpdatesFrozen=!1,e.enablePositionMorphing=this.enablePositionMorphing,e.enableNormalMorphing=this.enableNormalMorphing,e.enableTangentMorphing=this.enableTangentMorphing,e.enableUVMorphing=this.enableUVMorphing,e.enableUV2Morphing=this.enableUV2Morphing,e.enableColorMorphing=this.enableColorMorphing,e.metadata=this.metadata,e}serialize(){let e={};e.id=this.uniqueId,e.targets=[];for(let t of this._targets)e.targets.push(t.serialize());return this.metadata&&(e.metadata=this.metadata),e}_syncActiveTargets(e=!1){if(this.areUpdatesFrozen)return;let t=!!this._targetStoreTexture,i=this.isUsingTextureForTargets;(this._mustSynchronize||t!==i)&&(this._mustSynchronize=!1,this.synchronize());let r=0;this._activeTargets.reset(),(!this._morphTargetTextureIndices||this._morphTargetTextureIndices.length!==this._targets.length)&&(this._morphTargetTextureIndices=new Float32Array(this._targets.length));let n=-1;for(let a of this._targets)if(n++,!(a.influence===0&&this.optimizeInfluencers)){if(this._activeTargets.length>=s.MaxActiveMorphTargetsInVertexAttributeMode&&!this.isUsingTextureForTargets)break;this._activeTargets.push(a),this._morphTargetTextureIndices[r]=n,this._tempInfluences[r++]=a.influence}this._morphTargetTextureIndices.length!==r&&(this._morphTargetTextureIndices=this._morphTargetTextureIndices.slice(0,r)),(!this._influences||this._influences.length!==r)&&(this._influences=new Float32Array(r));for(let a=0;a<r;a++)this._influences[a]=this._tempInfluences[a];if(e&&this._scene)for(let a of this._scene.meshes)a.morphTargetManager===this&&(i?a._markSubMeshesAsAttributesDirty():a._syncGeometryWithMorphTargetManager())}synchronize(){if(!this._scene||this.areUpdatesFrozen)return;let e=this._scene.getEngine();this._supportsPositions=!0,this._supportsNormals=!0,this._supportsTangents=!0,this._supportsUVs=!0,this._supportsUV2s=!0,this._supportsColors=!0,this._vertexCount=0,this._targetStoreTexture?.dispose(),this._targetStoreTexture=null,this.isUsingTextureForTargets&&this._targets.length>e.getCaps().texture2DArrayMaxLayerCount&&(this.useTextureToStoreTargets=!1);for(let t of this._targets){this._supportsPositions=this._supportsPositions&&t.hasPositions,this._supportsNormals=this._supportsNormals&&t.hasNormals,this._supportsTangents=this._supportsTangents&&t.hasTangents,this._supportsUVs=this._supportsUVs&&t.hasUVs,this._supportsUV2s=this._supportsUV2s&&t.hasUV2s,this._supportsColors=this._supportsColors&&t.hasColors;let i=t.vertexCount;if(this._vertexCount===0)this._vertexCount=i;else if(this._vertexCount!==i){P.Error(`Incompatible target. Targets must all have the same vertices count. Current vertex count: ${this._vertexCount}, vertex count for target "${t.name}": ${i}`);return}}if(this.isUsingTextureForTargets){this._textureVertexStride=0,this._supportsPositions&&this._textureVertexStride++,this._supportsNormals&&this._textureVertexStride++,this._supportsTangents&&this._textureVertexStride++,this._supportsUVs&&this._textureVertexStride++,this._supportsUV2s&&this._textureVertexStride++,this._supportsColors&&this._textureVertexStride++,this._textureWidth=this._vertexCount*this._textureVertexStride||1,this._textureHeight=1;let t=e.getCaps().maxTextureSize;this._textureWidth>t&&(this._textureHeight=Math.ceil(this._textureWidth/t),this._textureWidth=t);let i=this._targets.length,r=new Float32Array(i*this._textureWidth*this._textureHeight*4),n=0;for(let a=0;a<i;a++){let o=this._targets[a],l=o.getPositions(),c=o.getNormals(),f=o.getUVs(),h=o.getTangents(),u=o.getUV2s(),d=o.getColors();n=a*this._textureWidth*this._textureHeight*4;for(let p=0;p<this._vertexCount;p++)this._supportsPositions&&l&&(r[n]=l[p*3],r[n+1]=l[p*3+1],r[n+2]=l[p*3+2],n+=4),this._supportsNormals&&c&&(r[n]=c[p*3],r[n+1]=c[p*3+1],r[n+2]=c[p*3+2],n+=4),this._supportsUVs&&f&&(r[n]=f[p*2],r[n+1]=f[p*2+1],n+=4),this._supportsTangents&&h&&(r[n]=h[p*3],r[n+1]=h[p*3+1],r[n+2]=h[p*3+2],n+=4),this._supportsUV2s&&u&&(r[n]=u[p*2],r[n+1]=u[p*2+1],n+=4),this._supportsColors&&d&&(r[n]=d[p*4],r[n+1]=d[p*4+1],r[n+2]=d[p*4+2],r[n+3]=d[p*4+3],n+=4)}this._targetStoreTexture=lg.CreateRGBATexture(r,this._textureWidth,this._textureHeight,i,this._scene,!1,!1,1,1),this._targetStoreTexture.name=`Morph texture_${this.uniqueId}`}for(let t of this._scene.meshes)t.morphTargetManager===this&&t._syncGeometryWithMorphTargetManager()}dispose(){if(this._targetStoreTexture&&this._targetStoreTexture.dispose(),this._targetStoreTexture=null,this.metadata=null,this._scene){if(this._scene.removeMorphTargetManager(this),this._parentContainer){let e=this._parentContainer.morphTargetManagers.indexOf(this);e>-1&&this._parentContainer.morphTargetManagers.splice(e,1),this._parentContainer=null}for(let e of this._targets)this._scene.stopAnimation(e)}}static Parse(e,t){let i=new s(t);for(let r of e.targets)i.addTarget(Xl.Parse(r,t));return e.metadata&&(i.metadata=e.metadata),i}};Yl.EnableTextureStorage=!0;Yl.MaxActiveMorphTargetsInVertexAttributeMode=8;Yl.ConstantTargetCountForTextureMode=0});var Kl,ik=S(()=>{ie();Ee();Ef();Ki();Ch();lu();yt();$e();Te();fe._instancedMeshFactory=(s,e)=>{let t=new Kl(s,e);if(e.instancedBuffers){t.instancedBuffers={};for(let i in e.instancedBuffers)t.instancedBuffers[i]=e.instancedBuffers[i]}return t};Kl=class extends Ct{constructor(e,t){super(e,t.getScene()),this._indexInSourceMeshInstanceArray=-1,this._distanceToCamera=0,t.addInstance(this),this._sourceMesh=t,this._unIndexed=t._unIndexed,this.position.copyFrom(t.position),this.rotation.copyFrom(t.rotation),this.scaling.copyFrom(t.scaling),t.rotationQuaternion&&(this.rotationQuaternion=t.rotationQuaternion.clone()),this.animations=t.animations.slice();for(let i of t.getAnimationRanges())i!=null&&this.createAnimationRange(i.name,i.from,i.to);if(this.infiniteDistance=t.infiniteDistance,this.setPivotMatrix(t.getPivotMatrix()),!t.skeleton&&!t.morphTargetManager&&t.hasBoundingInfo){let i=t.getBoundingInfo();this.buildBoundingInfo(i.minimum,i.maximum)}else this.refreshBoundingInfo(!0,!0);this._syncSubMeshes()}getClassName(){return"InstancedMesh"}get lightSources(){return this._sourceMesh._lightSources}_resyncLightSources(){}_resyncLightSource(){}_removeLightSource(){}get receiveShadows(){return this._sourceMesh.receiveShadows}set receiveShadows(e){this._sourceMesh?.receiveShadows!==e&&W.Warn("Setting receiveShadows on an instanced mesh has no effect")}get material(){return this._sourceMesh.material}set material(e){this._sourceMesh?.material!==e&&W.Warn("Setting material on an instanced mesh has no effect")}get visibility(){return this._sourceMesh.visibility}set visibility(e){this._sourceMesh?.visibility!==e&&W.Warn("Setting visibility on an instanced mesh has no effect")}get skeleton(){return this._sourceMesh.skeleton}set skeleton(e){this._sourceMesh?.skeleton!==e&&W.Warn("Setting skeleton on an instanced mesh has no effect")}get renderingGroupId(){return this._sourceMesh.renderingGroupId}set renderingGroupId(e){!this._sourceMesh||e===this._sourceMesh.renderingGroupId||P.Warn("Note - setting renderingGroupId of an instanced mesh has no effect on the scene")}getTotalVertices(){return this._sourceMesh?this._sourceMesh.getTotalVertices():0}getTotalIndices(){return this._sourceMesh.getTotalIndices()}get sourceMesh(){return this._sourceMesh}get geometry(){return this._sourceMesh._geometry}createInstance(e){return this._sourceMesh.createInstance(e)}isReady(e=!1){return this._sourceMesh.isReady(e,!0)}getVerticesData(e,t,i){return this._sourceMesh.getVerticesData(e,t,i)}copyVerticesData(e,t){this._sourceMesh.copyVerticesData(e,t)}getVertexBuffer(e,t){return this._sourceMesh.getVertexBuffer(e,t)}setVerticesData(e,t,i,r){return this.sourceMesh&&this.sourceMesh.setVerticesData(e,t,i,r),this.sourceMesh}updateVerticesData(e,t,i,r){return this.sourceMesh&&this.sourceMesh.updateVerticesData(e,t,i,r),this.sourceMesh}setIndices(e,t=null){return this.sourceMesh&&this.sourceMesh.setIndices(e,t),this.sourceMesh}isVerticesDataPresent(e){return this._sourceMesh.isVerticesDataPresent(e)}getIndices(){return this._sourceMesh.getIndices()}get _positions(){return this._sourceMesh._positions}refreshBoundingInfo(e=!1,t=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;let i;typeof e=="object"?i=e:i={applySkeleton:e,applyMorph:t};let r=this._sourceMesh.geometry?this._sourceMesh.geometry.boundingBias:null;return this._refreshBoundingInfo(this._sourceMesh._getData(i,null,A.PositionKind),r),this}_preActivate(){return this._currentLOD&&this._currentLOD._preActivate(),this}_activate(e,t){if(super._activate(e,t),this._sourceMesh.subMeshes||P.Warn("Instances should only be created for meshes with geometry."),this._currentLOD){if(this._currentLOD._getWorldMatrixDeterminant()>=0!=this._getWorldMatrixDeterminant()>=0)return this._internalAbstractMeshDataInfo._actAsRegularMesh=!0,!0;if(this._internalAbstractMeshDataInfo._actAsRegularMesh=!1,this._currentLOD._registerInstanceForRenderId(this,e),t){if(!this._currentLOD._internalAbstractMeshDataInfo._isActiveIntermediate)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!0,!0}else if(!this._currentLOD._internalAbstractMeshDataInfo._isActive)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstances=!0,!0}return!1}_postActivate(){this._sourceMesh.edgesShareWithInstances&&this._sourceMesh._edgesRenderer&&this._sourceMesh._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup?(this._sourceMesh._renderingGroup._edgesRenderers.pushNoDuplicate(this._sourceMesh._edgesRenderer),this._sourceMesh._edgesRenderer.customInstances.push(this.getWorldMatrix())):this._edgesRenderer&&this._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup&&this._sourceMesh._renderingGroup._edgesRenderers.push(this._edgesRenderer)}getWorldMatrix(){if(this._currentLOD&&this._currentLOD!==this._sourceMesh&&this._currentLOD.billboardMode!==dt.BILLBOARDMODE_NONE&&this._currentLOD._masterMesh!==this){this._billboardWorldMatrix||(this._billboardWorldMatrix=new B);let e=this._currentLOD._masterMesh;return this._currentLOD._masterMesh=this,w.Vector3[7].copyFrom(this._currentLOD.position),this._currentLOD.position.set(0,0,0),this._billboardWorldMatrix.copyFrom(this._currentLOD.computeWorldMatrix(!0)),this._currentLOD.position.copyFrom(w.Vector3[7]),this._currentLOD._masterMesh=e,this._billboardWorldMatrix}return super.getWorldMatrix()}get isAnInstance(){return!0}getLOD(e){if(!e)return this;let t=this.sourceMesh.getLODLevels();if(!t||t.length===0)this._currentLOD=this.sourceMesh;else{let i=this.getBoundingInfo();this._currentLOD=this.sourceMesh.getLOD(e,i.boundingSphere)}return this._currentLOD}_preActivateForIntermediateRendering(e){return this.sourceMesh._preActivateForIntermediateRendering(e)}_syncSubMeshes(){if(this.releaseSubMeshes(),this._sourceMesh.subMeshes)for(let e=0;e<this._sourceMesh.subMeshes.length;e++)this._sourceMesh.subMeshes[e].clone(this,this._sourceMesh);return this}_generatePointsArray(){return this._sourceMesh._generatePointsArray()}_updateBoundingInfo(){return this.hasBoundingInfo?this.getBoundingInfo().update(this.worldMatrixFromCache):this.buildBoundingInfo(this.absolutePosition,this.absolutePosition,this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}clone(e,t=null,i,r){let n=(r||this._sourceMesh).createInstance(e);if(xn.DeepCopy(this,n,["name","subMeshes","uniqueId","parent","lightSources","receiveShadows","material","visibility","skeleton","sourceMesh","isAnInstance","facetNb","isFacetDataEnabled","isBlocked","useBones","hasInstances","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","hasBoundingInfo","geometry"],[]),t&&(n.parent=t),!i)for(let a=0;a<this.getScene().meshes.length;a++){let o=this.getScene().meshes[a];o.parent===this&&o.clone(o.name,n)}return n.computeWorldMatrix(!0),this.onClonedObservable.notifyObservers(n),n}dispose(e,t=!1){this._sourceMesh.removeInstance(this),super.dispose(e,t)}_serializeAsParent(e){super._serializeAsParent(e),e.parentId=this._sourceMesh.uniqueId,e.parentInstanceIndex=this._indexInSourceMeshInstanceArray}instantiateHierarchy(e=null,t,i){let r=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0,t&&t.newSourcedMesh);r&&i&&i(this,r);for(let n of this.getChildTransformNodes(!0))n.instantiateHierarchy(r,t,i);return r}};fe.prototype.registerInstancedBuffer=function(s,e){if(this._userInstancedBuffersStorage?.vertexBuffers[s]?.dispose(),!this.instancedBuffers){this.instancedBuffers={};for(let t of this.instances)t.instancedBuffers={}}this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this.instancedBuffers[s]=null,this._userInstancedBuffersStorage.strides[s]=e,this._userInstancedBuffersStorage.sizes[s]=e*32,this._userInstancedBuffersStorage.data[s]=new Float32Array(this._userInstancedBuffersStorage.sizes[s]),this._userInstancedBuffersStorage.vertexBuffers[s]=new A(this.getEngine(),this._userInstancedBuffersStorage.data[s],s,!0,!1,e,!0);for(let t of this.instances)t.instancedBuffers[s]=null;this._invalidateInstanceVertexArrayObject(),this._markSubMeshesAsAttributesDirty()};fe.prototype._processInstancedBuffers=function(s,e){let t=s?s.length:0;for(let i in this.instancedBuffers){let r=this._userInstancedBuffersStorage.sizes[i],n=this._userInstancedBuffersStorage.strides[i],a=(t+1)*n;for(;r<a;)r*=2;this._userInstancedBuffersStorage.data[i].length!=r&&(this._userInstancedBuffersStorage.data[i]=new Float32Array(r),this._userInstancedBuffersStorage.sizes[i]=r,this._userInstancedBuffersStorage.vertexBuffers[i]&&(this._userInstancedBuffersStorage.vertexBuffers[i].dispose(),this._userInstancedBuffersStorage.vertexBuffers[i]=null));let o=this._userInstancedBuffersStorage.data[i],l=0;if(e){let c=this.instancedBuffers[i];c.toArray?c.toArray(o,l):c.copyToArray?c.copyToArray(o,l):o[l]=c,l+=n}for(let c=0;c<t;c++){let h=s[c].instancedBuffers[i];h.toArray?h.toArray(o,l):h.copyToArray?h.copyToArray(o,l):o[l]=h,l+=n}this._userInstancedBuffersStorage.vertexBuffers[i]?this._userInstancedBuffersStorage.vertexBuffers[i].updateDirectly(o,0):(this._userInstancedBuffersStorage.vertexBuffers[i]=new A(this.getEngine(),this._userInstancedBuffersStorage.data[i],i,!0,!1,n,!0),this._invalidateInstanceVertexArrayObject())}};fe.prototype._invalidateInstanceVertexArrayObject=function(){if(!(!this._userInstancedBuffersStorage||this._userInstancedBuffersStorage.vertexArrayObjects===void 0)){for(let s in this._userInstancedBuffersStorage.vertexArrayObjects)this.getEngine().releaseVertexArrayObject(this._userInstancedBuffersStorage.vertexArrayObjects[s]);this._userInstancedBuffersStorage.vertexArrayObjects={}}};fe.prototype._disposeInstanceSpecificData=function(){for(let s in this._instanceDataStorage.renderPasses)this._instanceDataStorage.renderPasses[s].instancesBuffer?.dispose();for(this._instanceDataStorage.renderPasses={};this.instances.length;)this.instances[0].dispose();for(let s in this.instancedBuffers)this._userInstancedBuffersStorage.vertexBuffers[s]&&this._userInstancedBuffersStorage.vertexBuffers[s].dispose();this._invalidateInstanceVertexArrayObject(),this.instancedBuffers={}};G("BABYLON.InstancedMesh",Kl)});var cg,iy,ry,Bs,Gf=S(()=>{Ki();lu();Ef();Ee();gt();ik();Dn();Vn();$e();po();cg=class{constructor(){this.rootNodes=[],this.cameras=[],this.lights=[],this.meshes=[],this.skeletons=[],this.particleSystems=[],this.animations=[],this.animationGroups=[],this.multiMaterials=[],this.materials=[],this.morphTargetManagers=[],this.geometries=[],this.transformNodes=[],this.actionManagers=[],this.textures=[],this._environmentTexture=null,this.postProcesses=[],this.sounds=null,this.effectLayers=[],this.layers=[],this.reflectionProbes=[]}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture=e}getNodes(){let e=[];e=e.concat(this.meshes),e=e.concat(this.lights),e=e.concat(this.cameras),e=e.concat(this.transformNodes);for(let t of this.skeletons)e=e.concat(t.bones);return e}},iy=class extends cg{},ry=class{constructor(){this.rootNodes=[],this.skeletons=[],this.animationGroups=[]}dispose(){let e=this.rootNodes;for(let r of e)r.dispose();e.length=0;let t=this.skeletons;for(let r of t)r.dispose();t.length=0;let i=this.animationGroups;for(let r of i)r.dispose();i.length=0}},Bs=class extends cg{constructor(e){super(),this._wasAddedToScene=!1,e=e||Z.LastCreatedScene,e&&(this.scene=e,this.proceduralTextures=[],e.onDisposeObservable.add(()=>{this._wasAddedToScene||this.dispose()}),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add(()=>{for(let t of this.geometries)t._rebuild();for(let t of this.meshes)t._rebuild();for(let t of this.particleSystems)t.rebuild();for(let t of this.textures)t._rebuild()}))}_topologicalSort(e){let t=new Map;for(let o of e)t.set(o.uniqueId,o);let i={dependsOn:new Map,dependedBy:new Map};for(let o of e){let l=o.uniqueId;i.dependsOn.set(l,new Set),i.dependedBy.set(l,new Set)}for(let o of e){let l=o.uniqueId,c=i.dependsOn.get(l);if(o instanceof Kl){let h=o.sourceMesh;t.has(h.uniqueId)&&(c.add(h.uniqueId),i.dependedBy.get(h.uniqueId).add(l))}let f=i.dependedBy.get(l);for(let h of o.getDescendants()){let u=h.uniqueId;t.has(u)&&(f.add(u),i.dependsOn.get(u).add(l))}}let r=[],n=[];for(let o of e){let l=o.uniqueId;i.dependsOn.get(l).size===0&&(n.push(o),t.delete(l))}let a=n;for(;a.length>0;){let o=a.shift();r.push(o);let l=i.dependedBy.get(o.uniqueId);for(let c of Array.from(l.values())){let f=i.dependsOn.get(c);f.delete(o.uniqueId),f.size===0&&t.get(c)&&(a.push(t.get(c)),t.delete(c))}}return t.size>0&&(P.Error("SceneSerializer._topologicalSort: There were unvisited nodes:"),t.forEach(o=>{P.Error(o.name)})),r}_addNodeAndDescendantsToList(e,t,i,r){if(!(!i||r&&!r(i)||t.has(i.uniqueId))){e.push(i),t.add(i.uniqueId);for(let n of i.getDescendants(!0))this._addNodeAndDescendantsToList(e,t,n,r)}}_isNodeInContainer(e){return e instanceof Ct&&this.meshes.indexOf(e)!==-1||e instanceof dt&&this.transformNodes.indexOf(e)!==-1||e instanceof Ke&&this.lights.indexOf(e)!==-1||e instanceof ye&&this.cameras.indexOf(e)!==-1}_isValidHierarchy(){for(let e of this.meshes)if(e.parent&&!this._isNodeInContainer(e.parent))return P.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(let e of this.transformNodes)if(e.parent&&!this._isNodeInContainer(e.parent))return P.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(let e of this.lights)if(e.parent&&!this._isNodeInContainer(e.parent))return P.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(let e of this.cameras)if(e.parent&&!this._isNodeInContainer(e.parent))return P.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;return!0}instantiateModelsToScene(e,t=!1,i){this._isValidHierarchy()||W.Warn("SceneSerializer.InstantiateModelsToScene: The Asset Container hierarchy is not valid.");let r={},n={},a=new ry,o=[],l=[],c={doNotInstantiate:!0,...i},f=(m,_)=>{if(r[m.uniqueId]=_.uniqueId,n[_.uniqueId]=_,e&&(_.name=e(m.name)),_ instanceof fe){let v=_;if(v.morphTargetManager){let T=m.morphTargetManager;v.morphTargetManager=T.clone();for(let C=0;C<T.numTargets;C++){let I=T.getTarget(C),R=v.morphTargetManager.getTarget(C);r[I.uniqueId]=R.uniqueId,n[R.uniqueId]=R}}}},h=[],u=new Set;for(let m of this.transformNodes)m.parent===null&&this._addNodeAndDescendantsToList(h,u,m,c.predicate);for(let m of this.meshes)m.parent===null&&this._addNodeAndDescendantsToList(h,u,m,c.predicate);let d=this._topologicalSort(h),p=(m,_)=>{if(f(m,_),m.parent){let v=r[m.parent.uniqueId],T=n[v];T?_.parent=T:_.parent=m.parent}if(_.position&&m.position&&_.position.copyFrom(m.position),_.rotationQuaternion&&m.rotationQuaternion&&_.rotationQuaternion.copyFrom(m.rotationQuaternion),_.rotation&&m.rotation&&_.rotation.copyFrom(m.rotation),_.scaling&&m.scaling&&_.scaling.copyFrom(m.scaling),_.material){let v=_;if(v.material)if(t){let T=m.material;if(l.indexOf(T)===-1){let C=T.clone(e?e(T.name):"Clone of "+T.name);if(l.push(T),r[T.uniqueId]=C.uniqueId,n[C.uniqueId]=C,T.getClassName()==="MultiMaterial"){let I=T;for(let R of I.subMaterials)R&&(C=R.clone(e?e(R.name):"Clone of "+R.name),l.push(R),r[R.uniqueId]=C.uniqueId,n[C.uniqueId]=C);I.subMaterials=I.subMaterials.map(R=>R&&n[r[R.uniqueId]])}}v.getClassName()!=="InstancedMesh"&&(v.material=n[r[T.uniqueId]])}else v.material.getClassName()==="MultiMaterial"?this.scene.multiMaterials.indexOf(v.material)===-1&&this.scene.addMultiMaterial(v.material):this.scene.materials.indexOf(v.material)===-1&&this.scene.addMaterial(v.material)}_.parent===null&&a.rootNodes.push(_)};for(let m of d)if(m.getClassName()==="InstancedMesh"){let _=m,v=_.sourceMesh,T=r[v.uniqueId],I=(typeof T=="number"?n[T]:v).createInstance(_.name);p(_,I)}else{let _=!0;m.getClassName()==="TransformNode"||m.getClassName()==="Node"||m.skeleton||!m.getTotalVertices||m.getTotalVertices()===0?_=!1:c.doNotInstantiate&&(typeof c.doNotInstantiate=="function"?_=!c.doNotInstantiate(m):_=!c.doNotInstantiate);let v=_?m.createInstance(`instance of ${m.name}`):m.clone(`Clone of ${m.name}`,null,!0);if(!v)throw new Error(`Could not clone or instantiate node on Asset Container ${m.name}`);p(m,v)}for(let m of this.skeletons){if(c.predicate&&!c.predicate(m))continue;let _=m.clone(e?e(m.name):"Clone of "+m.name);for(let v of this.meshes)if(v.skeleton===m&&!v.isAnInstance){let T=n[r[v.uniqueId]];if(!T||T.isAnInstance||(T.skeleton=_,o.indexOf(_)!==-1))continue;o.push(_);for(let C of _.bones)C._linkedTransformNode&&(C._linkedTransformNode=n[r[C._linkedTransformNode.uniqueId]])}a.skeletons.push(_)}for(let m of this.animationGroups){if(c.predicate&&!c.predicate(m))continue;let _=m.clone(e?e(m.name):"Clone of "+m.name,v=>n[r[v.uniqueId]]||v);a.animationGroups.push(_)}return a}addAllToScene(){if(!this._wasAddedToScene){this._isValidHierarchy()||W.Warn("SceneSerializer.addAllToScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!0,this.addToScene(null),this.environmentTexture&&(this.scene.environmentTexture=this.environmentTexture);for(let e of this.scene._serializableComponents)e.addFromContainer(this);this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null}}addToScene(e=null){let t=[];for(let i of this.cameras)e&&!e(i)||(this.scene.addCamera(i),t.push(i));for(let i of this.lights)e&&!e(i)||(this.scene.addLight(i),t.push(i));for(let i of this.meshes)e&&!e(i)||(this.scene.addMesh(i),t.push(i));for(let i of this.skeletons)e&&!e(i)||this.scene.addSkeleton(i);for(let i of this.animations)e&&!e(i)||this.scene.addAnimation(i);for(let i of this.animationGroups)e&&!e(i)||this.scene.addAnimationGroup(i);for(let i of this.multiMaterials)e&&!e(i)||this.scene.addMultiMaterial(i);for(let i of this.materials)e&&!e(i)||this.scene.addMaterial(i);for(let i of this.morphTargetManagers)e&&!e(i)||this.scene.addMorphTargetManager(i);for(let i of this.geometries)e&&!e(i)||this.scene.addGeometry(i);for(let i of this.transformNodes)e&&!e(i)||(this.scene.addTransformNode(i),t.push(i));for(let i of this.actionManagers)e&&!e(i)||this.scene.addActionManager(i);for(let i of this.textures)e&&!e(i)||this.scene.addTexture(i);for(let i of this.reflectionProbes)e&&!e(i)||this.scene.addReflectionProbe(i);if(t.length){let i=new Set(this.scene.meshes);for(let r of this.scene.lights)i.add(r);for(let r of this.scene.cameras)i.add(r);for(let r of this.scene.transformNodes)i.add(r);for(let r of this.skeletons)for(let n of r.bones)i.add(n);for(let r of t)r.parent&&!i.has(r.parent)&&(r.setParent?r.setParent(null):r.parent=null)}}removeAllFromScene(){this._isValidHierarchy()||W.Warn("SceneSerializer.removeAllFromScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!1,this.removeFromScene(null),this.environmentTexture===this.scene.environmentTexture&&(this.scene.environmentTexture=null);for(let e of this.scene._serializableComponents)e.removeFromContainer(this)}removeFromScene(e=null){for(let t of this.cameras)e&&!e(t)||this.scene.removeCamera(t);for(let t of this.lights)e&&!e(t)||this.scene.removeLight(t);for(let t of this.meshes)e&&!e(t)||this.scene.removeMesh(t,!0);for(let t of this.skeletons)e&&!e(t)||this.scene.removeSkeleton(t);for(let t of this.animations)e&&!e(t)||this.scene.removeAnimation(t);for(let t of this.animationGroups)e&&!e(t)||this.scene.removeAnimationGroup(t);for(let t of this.multiMaterials)e&&!e(t)||this.scene.removeMultiMaterial(t);for(let t of this.materials)e&&!e(t)||this.scene.removeMaterial(t);for(let t of this.morphTargetManagers)e&&!e(t)||this.scene.removeMorphTargetManager(t);for(let t of this.geometries)e&&!e(t)||this.scene.removeGeometry(t);for(let t of this.transformNodes)e&&!e(t)||this.scene.removeTransformNode(t);for(let t of this.actionManagers)e&&!e(t)||this.scene.removeActionManager(t);for(let t of this.textures)e&&!e(t)||this.scene.removeTexture(t);for(let t of this.reflectionProbes)e&&!e(t)||this.scene.removeReflectionProbe(t)}dispose(){let e=this.cameras.slice(0);for(let p of e)p.dispose();this.cameras.length=0;let t=this.lights.slice(0);for(let p of t)p.dispose();this.lights.length=0;let i=this.meshes.slice(0);for(let p of i)p.dispose();this.meshes.length=0;let r=this.skeletons.slice(0);for(let p of r)p.dispose();this.skeletons.length=0;let n=this.animationGroups.slice(0);for(let p of n)p.dispose();this.animationGroups.length=0;let a=this.multiMaterials.slice(0);for(let p of a)p.dispose();this.multiMaterials.length=0;let o=this.materials.slice(0);for(let p of o)p.dispose();this.materials.length=0;let l=this.geometries.slice(0);for(let p of l)p.dispose();this.geometries.length=0;let c=this.transformNodes.slice(0);for(let p of c)p.dispose();this.transformNodes.length=0;let f=this.actionManagers.slice(0);for(let p of f)p.dispose();this.actionManagers.length=0;let h=this.textures.slice(0);for(let p of h)p.dispose();this.textures.length=0;let u=this.reflectionProbes.slice(0);for(let p of u)p.dispose();this.reflectionProbes.length=0;let d=this.morphTargetManagers.slice(0);for(let p of d)p.dispose();this.morphTargetManagers.length=0,this.environmentTexture&&(this.environmentTexture.dispose(),this.environmentTexture=null);for(let p of this.scene._serializableComponents)p.removeFromContainer(this,!0);this._onContextRestoredObserver&&(this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}_moveAssets(e,t,i){if(!(!e||!t))for(let r of e){let n=!0;if(i){for(let a of i)if(r===a){n=!1;break}}n&&(t.push(r),r._parentContainer=this)}}moveAllFromScene(e){this._wasAddedToScene=!1,e===void 0&&(e=new iy);for(let t in this)Object.prototype.hasOwnProperty.call(this,t)&&(this[t]=this[t]||(t==="_environmentTexture"?null:[]),this._moveAssets(this.scene[t],this[t],e[t]));this.environmentTexture=this.scene.environmentTexture,this.removeAllFromScene()}createRootMesh(){let e=new fe("assetContainerRootMesh",this.scene);for(let t of this.meshes)t.parent||e.addChild(t);return this.meshes.unshift(e),e}mergeAnimationsTo(e=Z.LastCreatedScene,t,i=null){if(!e)return P.Error("No scene available to merge animations to"),[];let r=i||(l=>{let c=null,f=l.animations.length?l.animations[0].targetProperty:"",h=l.name.split(".").join("").split("_primitive")[0];switch(f){case"position":case"rotationQuaternion":c=e.getTransformNodeByName(l.name)||e.getTransformNodeByName(h);break;case"influence":c=e.getMorphTargetByName(l.name)||e.getMorphTargetByName(h);break;default:c=e.getNodeByName(l.name)||e.getNodeByName(h)}return c}),n=this.getNodes();for(let l of n){let c=r(l);if(c!==null){for(let f of l.animations){let h=c.animations.filter(u=>u.targetProperty===f.targetProperty);for(let u of h){let d=c.animations.indexOf(u,0);d>-1&&c.animations.splice(d,1)}}c.animations=c.animations.concat(l.animations)}}let a=[],o=this.animationGroups.slice();for(let l of o){a.push(l.clone(l.name,r));for(let c of l.animatables)c.stop()}for(let l of t){let c=r(l.target);c&&(e.beginAnimation(c,l.fromFrame,l.toFrame,l.loopAnimation,l.speedRatio,l.onAnimationEnd?l.onAnimationEnd:void 0,void 0,!0,void 0,l.onAnimationLoop?l.onAnimationLoop:void 0),e.stopAnimation(l.target))}return a}populateRootNodes(){this.rootNodes.length=0;for(let e of this.meshes)!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e);for(let e of this.transformNodes)!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e);for(let e of this.lights)!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e);for(let e of this.cameras)!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e)}addAllAssetsToContainer(e){if(!e)return;let t=[],i=new Set;for(t.push(e);t.length>0;){let r=t.pop();if(r instanceof fe?(r.geometry&&this.geometries.indexOf(r.geometry)===-1&&this.geometries.push(r.geometry),this.meshes.push(r)):r instanceof Kl?this.meshes.push(r):r instanceof dt?this.transformNodes.push(r):r instanceof Ke?this.lights.push(r):r instanceof ye&&this.cameras.push(r),r instanceof Ct){if(r.material&&this.materials.indexOf(r.material)===-1){this.materials.push(r.material);for(let n of r.material.getActiveTextures())this.textures.indexOf(n)===-1&&this.textures.push(n)}r.skeleton&&this.skeletons.indexOf(r.skeleton)===-1&&this.skeletons.push(r.skeleton),r.morphTargetManager&&this.morphTargetManagers.indexOf(r.morphTargetManager)===-1&&this.morphTargetManagers.push(r.morphTargetManager)}for(let n of r.getChildren())i.has(n)||t.push(n);i.add(r)}this.populateRootNodes()}_getByTags(e,t,i){if(t===void 0)return e;let r=[];for(let n in e){let a=e[n];st&&st.MatchesQuery(a,t)&&(!i||i(a))&&r.push(a)}return r}getMeshesByTags(e,t){return this._getByTags(this.meshes,e,t)}getCamerasByTags(e,t){return this._getByTags(this.cameras,e,t)}getLightsByTags(e,t){return this._getByTags(this.lights,e,t)}getMaterialsByTags(e,t){return this._getByTags(this.materials,e,t).concat(this._getByTags(this.multiMaterials,e,t))}getTransformNodesByTags(e,t){return this._getByTags(this.transformNodes,e,t)}}});var ql,rk=S(()=>{pp();ql=class{constructor(e){this.byteOffset=0,this.buffer=e}async loadAsync(e){let t=await this.buffer.readAsync(this.byteOffset,e);this._dataView=new DataView(t.buffer,t.byteOffset,t.byteLength),this._dataByteOffset=0}readUint32(){let e=this._dataView.getUint32(this._dataByteOffset,!0);return this._dataByteOffset+=4,this.byteOffset+=4,e}readUint8Array(e){let t=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._dataByteOffset,e);return this._dataByteOffset+=e,this.byteOffset+=e,t}readString(e){return ND(this.readUint8Array(e))}skipBytes(e){this._dataByteOffset+=e,this.byteOffset+=e}}});function sy(s,e,t,i){let r={externalResourceFunction:i};return t&&(r.uri=e==="file:"?t:e+t),ArrayBuffer.isView(s)?GLTFValidator.validateBytes(s,r):GLTFValidator.validateString(s,r)}function nte(){let s=[];onmessage=e=>{let t=e.data;switch(t.id){case"init":{importScripts(t.url);break}case"validate":{sy(t.data,t.rootUrl,t.fileName,i=>new Promise((r,n)=>{let a=s.length;s.push({resolve:r,reject:n}),postMessage({id:"getExternalResource",index:a,uri:i})})).then(i=>{postMessage({id:"validate.resolve",value:i})},i=>{postMessage({id:"validate.reject",reason:i})});break}case"getExternalResource.resolve":{s[t.index].resolve(t.value);break}case"getExternalResource.reject":{s[t.index].reject(t.reason);break}}}}var Hu,sk=S(()=>{$e();Hu=class{static ValidateAsync(e,t,i,r){return typeof Worker=="function"?new Promise((n,a)=>{let o=`${sy}(${nte})()`,l=URL.createObjectURL(new Blob([o],{type:"application/javascript"})),c=new Worker(l),f=u=>{c.removeEventListener("error",f),c.removeEventListener("message",h),a(u)},h=u=>{let d=u.data;switch(d.id){case"getExternalResource":{r(d.uri).then(p=>{c.postMessage({id:"getExternalResource.resolve",index:d.index,value:p},[p.buffer])},p=>{c.postMessage({id:"getExternalResource.reject",index:d.index,reason:p})});break}case"validate.resolve":{c.removeEventListener("error",f),c.removeEventListener("message",h),n(d.value),c.terminate();break}case"validate.reject":c.removeEventListener("error",f),c.removeEventListener("message",h),a(d.reason),c.terminate()}};if(c.addEventListener("error",f),c.addEventListener("message",h),c.postMessage({id:"init",url:W.GetBabylonScriptURL(this.Configuration.url)}),ArrayBuffer.isView(e)){let u=e.slice();c.postMessage({id:"validate",data:u,rootUrl:t,fileName:i},[u.buffer])}else c.postMessage({id:"validate",data:e,rootUrl:t,fileName:i})}):(this._LoadScriptPromise||(this._LoadScriptPromise=W.LoadBabylonScriptAsync(this.Configuration.url)),this._LoadScriptPromise.then(()=>sy(e,t,i,r)))}};Hu.Configuration={url:`${W._DefaultCdnUrl}/gltf_validator.js`}});function nk(s,e,t){try{return Promise.resolve(new Uint8Array(s,e,t))}catch(i){return Promise.reject(i)}}function ate(s,e,t){try{if(e<0||e>=s.byteLength)throw new RangeError("Offset is out of range.");if(e+t>s.byteLength)throw new RangeError("Length is out of range.");return Promise.resolve(new Uint8Array(s.buffer,s.byteOffset+e,t))}catch(i){return Promise.reject(i)}}var Vf,Ql,Mr,fg,ote,ny,ja,ak=S(()=>{we();$e();Qo();Gf();Ee();rk();sk();qI();To();Cc();(function(s){s[s.AUTO=0]="AUTO",s[s.FORCE_RIGHT_HANDED=1]="FORCE_RIGHT_HANDED"})(Vf||(Vf={}));(function(s){s[s.NONE=0]="NONE",s[s.FIRST=1]="FIRST",s[s.ALL=2]="ALL"})(Ql||(Ql={}));(function(s){s[s.LOADING=0]="LOADING",s[s.READY=1]="READY",s[s.COMPLETE=2]="COMPLETE"})(Mr||(Mr={}));fg=class{constructor(){this.alwaysComputeBoundingBox=!1,this.alwaysComputeSkeletonRootNode=!1,this.animationStartMode=Ql.FIRST,this.compileMaterials=!1,this.compileShadowGenerators=!1,this.coordinateSystemMode=Vf.AUTO,this.createInstances=!0,this.loadAllMaterials=!1,this.loadMorphTargets=!0,this.loadNodeAnimations=!0,this.loadOnlyMaterials=!1,this.loadSkins=!0,this.skipMaterials=!1,this.targetFps=60,this.transparencyAsCoverage=!1,this.useClipPlane=!1,this.useGltfTextureNames=!1,this.useRangeRequests=!1,this.useSRGBBuffers=!0,this.validate=!1}},ote=new fg,ny=class extends fg{constructor(){super(...arguments),this.extensionOptions={},this.preprocessUrlAsync=e=>Promise.resolve(e)}copyFrom(e){e&&(this.alwaysComputeBoundingBox=e.alwaysComputeBoundingBox??this.alwaysComputeBoundingBox,this.alwaysComputeSkeletonRootNode=e.alwaysComputeSkeletonRootNode??this.alwaysComputeSkeletonRootNode,this.animationStartMode=e.animationStartMode??this.animationStartMode,this.capturePerformanceCounters=e.capturePerformanceCounters??this.capturePerformanceCounters,this.compileMaterials=e.compileMaterials??this.compileMaterials,this.compileShadowGenerators=e.compileShadowGenerators??this.compileShadowGenerators,this.coordinateSystemMode=e.coordinateSystemMode??this.coordinateSystemMode,this.createInstances=e.createInstances??this.createInstances,this.customRootNode=e.customRootNode,this.extensionOptions=e.extensionOptions??this.extensionOptions,this.loadAllMaterials=e.loadAllMaterials??this.loadAllMaterials,this.loadMorphTargets=e.loadMorphTargets??this.loadMorphTargets,this.loadNodeAnimations=e.loadNodeAnimations??this.loadNodeAnimations,this.loadOnlyMaterials=e.loadOnlyMaterials??this.loadOnlyMaterials,this.loadSkins=e.loadSkins??this.loadSkins,this.loggingEnabled=e.loggingEnabled??this.loggingEnabled,this.onCameraLoaded=e.onCameraLoaded,this.onMaterialLoaded=e.onMaterialLoaded,this.onMeshLoaded=e.onMeshLoaded,this.onParsed=e.onParsed,this.onSkinLoaded=e.onSkinLoaded,this.onTextureLoaded=e.onTextureLoaded,this.onValidated=e.onValidated,this.preprocessUrlAsync=e.preprocessUrlAsync??this.preprocessUrlAsync,this.skipMaterials=e.skipMaterials??this.skipMaterials,this.targetFps=e.targetFps??this.targetFps,this.transparencyAsCoverage=e.transparencyAsCoverage??this.transparencyAsCoverage,this.useClipPlane=e.useClipPlane??this.useClipPlane,this.useGltfTextureNames=e.useGltfTextureNames??this.useGltfTextureNames,this.useRangeRequests=e.useRangeRequests??this.useRangeRequests,this.useSRGBBuffers=e.useSRGBBuffers??this.useSRGBBuffers,this.validate=e.validate??this.validate)}},ja=class s extends ny{constructor(e){super(),this.onParsedObservable=new N,this.onMeshLoadedObservable=new N,this.onSkinLoadedObservable=new N,this.onTextureLoadedObservable=new N,this.onMaterialLoadedObservable=new N,this.onCameraLoadedObservable=new N,this.onCompleteObservable=new N,this.onErrorObservable=new N,this.onDisposeObservable=new N,this.onExtensionLoadedObservable=new N,this.onValidatedObservable=new N,this._loader=null,this._state=null,this._requests=new Array,this.name=Zo.name,this.extensions=Zo.extensions,this.onLoaderStateChangedObservable=new N,this._logIndentLevel=0,this._loggingEnabled=!1,this._log=this._logDisabled,this._capturePerformanceCounters=!1,this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled,this.copyFrom(Object.assign({...ote},e))}set onParsed(e){this._onParsedObserver&&this.onParsedObservable.remove(this._onParsedObserver),e&&(this._onParsedObserver=this.onParsedObservable.add(e))}set onMeshLoaded(e){this._onMeshLoadedObserver&&this.onMeshLoadedObservable.remove(this._onMeshLoadedObserver),e&&(this._onMeshLoadedObserver=this.onMeshLoadedObservable.add(e))}set onSkinLoaded(e){this._onSkinLoadedObserver&&this.onSkinLoadedObservable.remove(this._onSkinLoadedObserver),e&&(this._onSkinLoadedObserver=this.onSkinLoadedObservable.add(t=>e(t.node,t.skinnedNode)))}set onTextureLoaded(e){this._onTextureLoadedObserver&&this.onTextureLoadedObservable.remove(this._onTextureLoadedObserver),e&&(this._onTextureLoadedObserver=this.onTextureLoadedObservable.add(e))}set onMaterialLoaded(e){this._onMaterialLoadedObserver&&this.onMaterialLoadedObservable.remove(this._onMaterialLoadedObserver),e&&(this._onMaterialLoadedObserver=this.onMaterialLoadedObservable.add(e))}set onCameraLoaded(e){this._onCameraLoadedObserver&&this.onCameraLoadedObservable.remove(this._onCameraLoadedObserver),e&&(this._onCameraLoadedObserver=this.onCameraLoadedObservable.add(e))}set onComplete(e){this._onCompleteObserver&&this.onCompleteObservable.remove(this._onCompleteObserver),this._onCompleteObserver=this.onCompleteObservable.add(e)}set onError(e){this._onErrorObserver&&this.onErrorObservable.remove(this._onErrorObserver),this._onErrorObserver=this.onErrorObservable.add(e)}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set onExtensionLoaded(e){this._onExtensionLoadedObserver&&this.onExtensionLoadedObservable.remove(this._onExtensionLoadedObserver),this._onExtensionLoadedObserver=this.onExtensionLoadedObservable.add(e)}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled!==e&&(this._loggingEnabled=e,this._loggingEnabled?this._log=this._logEnabled:this._log=this._logDisabled)}get capturePerformanceCounters(){return this._capturePerformanceCounters}set capturePerformanceCounters(e){this._capturePerformanceCounters!==e&&(this._capturePerformanceCounters=e,this._capturePerformanceCounters?(this._startPerformanceCounter=this._startPerformanceCounterEnabled,this._endPerformanceCounter=this._endPerformanceCounterEnabled):(this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled))}set onValidated(e){this._onValidatedObserver&&this.onValidatedObservable.remove(this._onValidatedObserver),this._onValidatedObserver=this.onValidatedObservable.add(e)}dispose(){this._loader&&(this._loader.dispose(),this._loader=null);for(let e of this._requests)e.abort();this._requests.length=0,delete this._progressCallback,this.preprocessUrlAsync=e=>Promise.resolve(e),this.onMeshLoadedObservable.clear(),this.onSkinLoadedObservable.clear(),this.onTextureLoadedObservable.clear(),this.onMaterialLoadedObservable.clear(),this.onCameraLoadedObservable.clear(),this.onCompleteObservable.clear(),this.onExtensionLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(void 0),this.onDisposeObservable.clear()}loadFile(e,t,i,r,n,a,o,l){if(ArrayBuffer.isView(t))return this._loadBinary(e,t,i,r,o,l),null;this._progressCallback=n;let c=t.name||W.GetFilename(t);if(a){if(this.useRangeRequests){this.validate&&P.Warn("glTF validation is not supported when range requests are enabled");let f={abort:()=>{},onCompleteObservable:new N},h={readAsync:(u,d)=>new Promise((p,m)=>{this._loadFile(e,t,_=>{p(new Uint8Array(_))},!0,_=>{m(_)},_=>{_.setRequestHeader("Range",`bytes=${u}-${u+d-1}`)})}),byteLength:0};return this._unpackBinaryAsync(new ql(h)).then(u=>{f.onCompleteObservable.notifyObservers(f),r(u)},o?u=>o(void 0,u):void 0),f}return this._loadFile(e,t,f=>{this._validate(e,new Uint8Array(f,0,f.byteLength),i,c),this._unpackBinaryAsync(new ql({readAsync:(h,u)=>nk(f,h,u),byteLength:f.byteLength})).then(h=>{r(h)},o?h=>o(void 0,h):void 0)},!0,o)}else return this._loadFile(e,t,f=>{try{this._validate(e,f,i,c),r({json:this._parseJson(f)})}catch{o&&o()}},!1,o)}_loadBinary(e,t,i,r,n,a){this._validate(e,new Uint8Array(t.buffer,t.byteOffset,t.byteLength),i,a),this._unpackBinaryAsync(new ql({readAsync:(o,l)=>ate(t,o,l),byteLength:t.byteLength})).then(o=>{r(o)},n?o=>n(void 0,o):void 0)}importMeshAsync(e,t,i,r,n,a){return Promise.resolve().then(()=>(this.onParsedObservable.notifyObservers(i),this.onParsedObservable.clear(),this._log(`Loading ${a||""}`),this._loader=this._getLoader(i),this._loader.importMeshAsync(e,t,null,i,r,n,a)))}loadAsync(e,t,i,r,n){return Promise.resolve().then(()=>(this.onParsedObservable.notifyObservers(t),this.onParsedObservable.clear(),this._log(`Loading ${n||""}`),this._loader=this._getLoader(t),this._loader.loadAsync(e,t,i,r,n)))}loadAssetContainerAsync(e,t,i,r,n){return Promise.resolve().then(()=>{this.onParsedObservable.notifyObservers(t),this.onParsedObservable.clear(),this._log(`Loading ${n||""}`),this._loader=this._getLoader(t);let a=new Bs(e),o=[];this.onMaterialLoadedObservable.add(h=>{o.push(h)});let l=[];this.onTextureLoadedObservable.add(h=>{l.push(h)});let c=[];this.onCameraLoadedObservable.add(h=>{c.push(h)});let f=[];return this.onMeshLoadedObservable.add(h=>{h.morphTargetManager&&f.push(h.morphTargetManager)}),this._loader.importMeshAsync(null,e,a,t,i,r,n).then(h=>(Array.prototype.push.apply(a.geometries,h.geometries),Array.prototype.push.apply(a.meshes,h.meshes),Array.prototype.push.apply(a.particleSystems,h.particleSystems),Array.prototype.push.apply(a.skeletons,h.skeletons),Array.prototype.push.apply(a.animationGroups,h.animationGroups),Array.prototype.push.apply(a.materials,o),Array.prototype.push.apply(a.textures,l),Array.prototype.push.apply(a.lights,h.lights),Array.prototype.push.apply(a.transformNodes,h.transformNodes),Array.prototype.push.apply(a.cameras,c),Array.prototype.push.apply(a.morphTargetManagers,f),a))})}canDirectLoad(e){return Zo.canDirectLoad(e)}directLoad(e,t){if(t.startsWith("base64,"+qa)||t.startsWith(";base64,"+qa)||t.startsWith("application/octet-stream;base64,"+qa)||t.startsWith("model/gltf-binary;base64,"+qa)){let i=Xo(t);return this._validate(e,new Uint8Array(i,0,i.byteLength)),this._unpackBinaryAsync(new ql({readAsync:(r,n)=>nk(i,r,n),byteLength:i.byteLength}))}return this._validate(e,t),Promise.resolve({json:this._parseJson(t)})}createPlugin(e){return new s(e[Zo.name])}get loaderState(){return this._state}whenCompleteAsync(){return new Promise((e,t)=>{this.onCompleteObservable.addOnce(()=>{e()}),this.onErrorObservable.addOnce(i=>{t(i)})})}_setState(e){this._state!==e&&(this._state=e,this.onLoaderStateChangedObservable.notifyObservers(this._state),this._log(Mr[this._state]))}_loadFile(e,t,i,r,n,a){let o=e._loadFile(t,i,l=>{this._onProgress(l,o)},!0,r,n,a);return o.onCompleteObservable.add(()=>{o._lengthComputable=!0,o._total=o._loaded}),this._requests.push(o),o}_onProgress(e,t){if(!this._progressCallback)return;t._lengthComputable=e.lengthComputable,t._loaded=e.loaded,t._total=e.total;let i=!0,r=0,n=0;for(let a of this._requests){if(a._lengthComputable===void 0||a._loaded===void 0||a._total===void 0)return;i=i&&a._lengthComputable,r+=a._loaded,n+=a._total}this._progressCallback({lengthComputable:i,loaded:r,total:i?n:0})}_validate(e,t,i="",r=""){this.validate&&(this._startPerformanceCounter("Validate JSON"),Hu.ValidateAsync(t,i,r,n=>this.preprocessUrlAsync(i+n).then(a=>e._loadFileAsync(a,void 0,!0,!0).then(o=>new Uint8Array(o,0,o.byteLength)))).then(n=>{this._endPerformanceCounter("Validate JSON"),this.onValidatedObservable.notifyObservers(n),this.onValidatedObservable.clear()},n=>{this._endPerformanceCounter("Validate JSON"),W.Warn(`Failed to validate: ${n.message}`),this.onValidatedObservable.clear()}))}_getLoader(e){let t=e.json.asset||{};this._log(`Asset version: ${t.version}`),t.minVersion&&this._log(`Asset minimum version: ${t.minVersion}`),t.generator&&this._log(`Asset generator: ${t.generator}`);let i=s._parseVersion(t.version);if(!i)throw new Error("Invalid version: "+t.version);if(t.minVersion!==void 0){let a=s._parseVersion(t.minVersion);if(!a)throw new Error("Invalid minimum version: "+t.minVersion);if(s._compareVersion(a,{major:2,minor:0})>0)throw new Error("Incompatible minimum version: "+t.minVersion)}let n={1:s._CreateGLTF1Loader,2:s._CreateGLTF2Loader}[i.major];if(!n)throw new Error("Unsupported version: "+t.version);return n(this)}_parseJson(e){this._startPerformanceCounter("Parse JSON"),this._log(`JSON length: ${e.length}`);let t=JSON.parse(e);return this._endPerformanceCounter("Parse JSON"),t}_unpackBinaryAsync(e){return this._startPerformanceCounter("Unpack Binary"),e.loadAsync(20).then(()=>{let t={Magic:1179937895},i=e.readUint32();if(i!==t.Magic)throw new Nr("Unexpected magic: "+i,Is.GLTFLoaderUnexpectedMagicError);let r=e.readUint32();this.loggingEnabled&&this._log(`Binary version: ${r}`);let n=e.readUint32();!this.useRangeRequests&&n!==e.buffer.byteLength&&P.Warn(`Length in header does not match actual data length: ${n} != ${e.buffer.byteLength}`);let a;switch(r){case 1:{a=this._unpackBinaryV1Async(e,n);break}case 2:{a=this._unpackBinaryV2Async(e,n);break}default:throw new Error("Unsupported version: "+r)}return this._endPerformanceCounter("Unpack Binary"),a})}_unpackBinaryV1Async(e,t){let i={JSON:0},r=e.readUint32(),n=e.readUint32();if(n!==i.JSON)throw new Error(`Unexpected content format: ${n}`);let a=t-e.byteOffset,o={json:this._parseJson(e.readString(r)),bin:null};if(a!==0){let l=e.byteOffset;o.bin={readAsync:(c,f)=>e.buffer.readAsync(l+c,f),byteLength:a}}return Promise.resolve(o)}_unpackBinaryV2Async(e,t){let i={JSON:1313821514,BIN:5130562},r=e.readUint32();if(e.readUint32()!==i.JSON)throw new Error("First chunk format is not JSON");return e.byteOffset+r===t?e.loadAsync(r).then(()=>({json:this._parseJson(e.readString(r)),bin:null})):e.loadAsync(r+8).then(()=>{let a={json:this._parseJson(e.readString(r)),bin:null},o=()=>{let l=e.readUint32();switch(e.readUint32()){case i.JSON:throw new Error("Unexpected JSON chunk");case i.BIN:{let f=e.byteOffset;a.bin={readAsync:(h,u)=>e.buffer.readAsync(f+h,u),byteLength:l},e.skipBytes(l);break}default:{e.skipBytes(l);break}}return e.byteOffset!==t?e.loadAsync(8).then(o):Promise.resolve(a)};return o()})}static _parseVersion(e){if(e==="1.0"||e==="1.0.1")return{major:1,minor:0};let t=(e+"").match(/^(\d+)\.(\d+)/);return t?{major:parseInt(t[1]),minor:parseInt(t[2])}:null}static _compareVersion(e,t){return e.major>t.major?1:e.major<t.major?-1:e.minor>t.minor?1:e.minor<t.minor?-1:0}_logOpen(e){this._log(e),this._logIndentLevel++}_logClose(){--this._logIndentLevel}_logEnabled(e){let t=s._logSpaces.substring(0,this._logIndentLevel*2);P.Log(`${t}${e}`)}_logDisabled(e){}_startPerformanceCounterEnabled(e){W.StartPerformanceCounter(e)}_startPerformanceCounterDisabled(e){}_endPerformanceCounterEnabled(e){W.EndPerformanceCounter(e)}_endPerformanceCounterDisabled(e){}};ja.IncrementalLoading=!0;ja.HomogeneousCoordinates=!1;ja._logSpaces="                                ";$i(new ja)});var ui,hg=S(()=>{Ye();je();ie();rs();Dn();Gm();Ut();Te();_t.AddNodeConstructor("Light_Type_2",(s,e)=>()=>new ui(s,E.Zero(),E.Zero(),0,0,e));ui=class s extends Ds{get iesProfileTexture(){return this._iesProfileTexture}set iesProfileTexture(e){this._iesProfileTexture!==e&&(this._iesProfileTexture=e,this._iesProfileTexture&&s._IsTexture(this._iesProfileTexture)&&this._iesProfileTexture.onLoadObservable.addOnce(()=>{this._markMeshesAsLightDirty()}))}get angle(){return this._angle}set angle(e){this._angle=e,this._cosHalfAngle=Math.cos(e*.5),this._projectionTextureProjectionLightDirty=!0,this.forceProjectionMatrixCompute(),this._computeAngleValues()}get innerAngle(){return this._innerAngle}set innerAngle(e){this._innerAngle=e,this._computeAngleValues()}get shadowAngleScale(){return this._shadowAngleScale}set shadowAngleScale(e){this._shadowAngleScale=e,this.forceProjectionMatrixCompute()}get projectionTextureMatrix(){return this._projectionTextureMatrix}get projectionTextureLightNear(){return this._projectionTextureLightNear}set projectionTextureLightNear(e){this._projectionTextureLightNear=e,this._projectionTextureProjectionLightDirty=!0}get projectionTextureLightFar(){return this._projectionTextureLightFar}set projectionTextureLightFar(e){this._projectionTextureLightFar=e,this._projectionTextureProjectionLightDirty=!0}get projectionTextureUpDirection(){return this._projectionTextureUpDirection}set projectionTextureUpDirection(e){this._projectionTextureUpDirection=e,this._projectionTextureProjectionLightDirty=!0}get projectionTexture(){return this._projectionTexture}set projectionTexture(e){this._projectionTexture!==e&&(this._projectionTexture=e,this._projectionTextureDirty=!0,this._projectionTexture&&!this._projectionTexture.isReady()&&(s._IsProceduralTexture(this._projectionTexture)?this._projectionTexture.getEffect().executeWhenCompiled(()=>{this._markMeshesAsLightDirty()}):s._IsTexture(this._projectionTexture)&&this._projectionTexture.onLoadObservable.addOnce(()=>{this._markMeshesAsLightDirty()})))}static _IsProceduralTexture(e){return e.onGeneratedObservable!==void 0}static _IsTexture(e){return e.onLoadObservable!==void 0}get projectionTextureProjectionLightMatrix(){return this._projectionTextureProjectionLightMatrix}set projectionTextureProjectionLightMatrix(e){this._projectionTextureProjectionLightMatrix=e,this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0}constructor(e,t,i,r,n,a){super(e,a),this._innerAngle=0,this._iesProfileTexture=null,this._projectionTextureMatrix=B.Zero(),this._projectionTextureLightNear=1e-6,this._projectionTextureLightFar=1e3,this._projectionTextureUpDirection=E.Up(),this._projectionTextureViewLightDirty=!0,this._projectionTextureProjectionLightDirty=!0,this._projectionTextureDirty=!0,this._projectionTextureViewTargetVector=E.Zero(),this._projectionTextureViewLightMatrix=B.Zero(),this._projectionTextureProjectionLightMatrix=B.Zero(),this._projectionTextureScalingMatrix=B.FromValues(.5,0,0,0,0,.5,0,0,0,0,.5,0,.5,.5,.5,1),this.position=t,this.direction=i,this.angle=r,this.exponent=n}getClassName(){return"SpotLight"}getTypeID(){return Ke.LIGHTTYPEID_SPOTLIGHT}_setDirection(e){super._setDirection(e),this._projectionTextureViewLightDirty=!0}_setPosition(e){super._setPosition(e),this._projectionTextureViewLightDirty=!0}_setDefaultShadowProjectionMatrix(e,t,i){let r=this.getScene().activeCamera;if(!r)return;this._shadowAngleScale=this._shadowAngleScale||1;let n=this._shadowAngleScale*this._angle,a=this.shadowMinZ!==void 0?this.shadowMinZ:r.minZ,o=this.shadowMaxZ!==void 0?this.shadowMaxZ:r.maxZ,l=this.getScene().getEngine().useReverseDepthBuffer;B.PerspectiveFovLHToRef(n,1,l?o:a,l?a:o,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,l)}_computeProjectionTextureViewLightMatrix(){this._projectionTextureViewLightDirty=!1,this._projectionTextureDirty=!0,this.getAbsolutePosition().addToRef(this.getShadowDirection(),this._projectionTextureViewTargetVector),B.LookAtLHToRef(this.getAbsolutePosition(),this._projectionTextureViewTargetVector,this._projectionTextureUpDirection,this._projectionTextureViewLightMatrix)}_computeProjectionTextureProjectionLightMatrix(){this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0;let e=this.projectionTextureLightFar,t=this.projectionTextureLightNear,i=e/(e-t),r=-i*t,n=1/Math.tan(this._angle/2);B.FromValuesToRef(n/1,0,0,0,0,n,0,0,0,0,i,1,0,0,r,0,this._projectionTextureProjectionLightMatrix)}_computeProjectionTextureMatrix(){if(this._projectionTextureDirty=!1,this._projectionTextureViewLightMatrix.multiplyToRef(this._projectionTextureProjectionLightMatrix,this._projectionTextureMatrix),this._projectionTexture instanceof H){let e=this._projectionTexture.uScale/2,t=this._projectionTexture.vScale/2;B.FromValuesToRef(e,0,0,0,0,t,0,0,0,0,.5,0,.5,.5,.5,1,this._projectionTextureScalingMatrix)}this._projectionTextureMatrix.multiplyToRef(this._projectionTextureScalingMatrix,this._projectionTextureMatrix)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightDirection",3),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}_computeAngleValues(){this._lightAngleScale=1/Math.max(.001,Math.cos(this._innerAngle*.5)-this._cosHalfAngle),this._lightAngleOffset=-this._cosHalfAngle*this._lightAngleScale}transferTexturesToEffect(e,t){return this.projectionTexture&&this.projectionTexture.isReady()&&(this._projectionTextureViewLightDirty&&this._computeProjectionTextureViewLightMatrix(),this._projectionTextureProjectionLightDirty&&this._computeProjectionTextureProjectionLightMatrix(),this._projectionTextureDirty&&this._computeProjectionTextureMatrix(),e.setMatrix("textureProjectionMatrix"+t,this._projectionTextureMatrix),e.setTexture("projectionLightTexture"+t,this.projectionTexture)),this._iesProfileTexture&&this._iesProfileTexture.isReady()&&e.setTexture("iesLightTexture"+t,this._iesProfileTexture),this}transferToEffect(e,t){let i;return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,this.exponent,t),i=E.Normalize(this.transformedDirection)):(this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,this.exponent,t),i=E.Normalize(this.direction)),this._uniformBuffer.updateFloat4("vLightDirection",i.x,i.y,i.z,this._cosHalfAngle,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,this._lightAngleScale,this._lightAngleOffset,t),this}transferToNodeMaterialEffect(e,t){let i;return this.computeTransformedInformation()?i=E.Normalize(this.transformedDirection):i=E.Normalize(this.direction),this.getScene().useRightHandedSystem?e.setFloat3(t,-i.x,-i.y,-i.z):e.setFloat3(t,i.x,i.y,i.z),this}dispose(){super.dispose(),this._projectionTexture&&this._projectionTexture.dispose(),this._iesProfileTexture&&(this._iesProfileTexture.dispose(),this._iesProfileTexture=null)}getDepthMinZ(e){let t=this._scene.getEngine(),i=this.shadowMinZ!==void 0?this.shadowMinZ:e?.minZ??0;return t.useReverseDepthBuffer&&t.isNDCHalfZRange?i:this._scene.getEngine().isNDCHalfZRange?0:i}getDepthMaxZ(e){let t=this._scene.getEngine(),i=this.shadowMaxZ!==void 0?this.shadowMaxZ:e?.maxZ??1e4;return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:i}prepareLightSpecificDefines(e,t){e["SPOTLIGHT"+t]=!0,e["PROJECTEDLIGHTTEXTURE"+t]=!!(this.projectionTexture&&this.projectionTexture.isReady()),e["IESLIGHTTEXTURE"+t]=!!(this._iesProfileTexture&&this._iesProfileTexture.isReady())}};x([y()],ui.prototype,"angle",null);x([y()],ui.prototype,"innerAngle",null);x([y()],ui.prototype,"shadowAngleScale",null);x([y()],ui.prototype,"exponent",void 0);x([y()],ui.prototype,"projectionTextureLightNear",null);x([y()],ui.prototype,"projectionTextureLightFar",null);x([y()],ui.prototype,"projectionTextureUpDirection",null);x([He("projectedLightTexture")],ui.prototype,"_projectionTexture",void 0);G("BABYLON.SpotLight",ui)});var lte,ug,ok=S(()=>{lte=[{regex:new RegExp("^/nodes/\\d+/extensions/")}],ug=class{constructor(e,t){this._gltf=e,this._infoTree=t}convert(e){let t=this._gltf,i=this._infoTree,r;if(!e.startsWith("/"))throw new Error("Path must start with a /");let n=e.split("/");if(n.shift(),n[n.length-1].includes(".length")){let l=n[n.length-1].split(".");n.pop(),n.push(...l)}let a=!1;for(let o of n){let l=o==="length";if(l&&!i.__array__)throw new Error(`Path ${e} is invalid`);if(i.__ignoreObjectTree__&&(a=!0),i.__array__&&!l)i=i.__array__;else if(i=i[o],!i)throw new Error(`Path ${e} is invalid`);if(!a)if(t===void 0){if(!lte.find(f=>f.regex.test(e)))throw new Error(`Path ${e} is invalid`)}else l||(t=t?.[o]);(i.__target__||l)&&(r=t)}return{object:r,info:i}}}});function Jo(s,e,t,i){let r=xe(s,e);return i?r[t][i]:r[t]}function xe(s,e,t){return s._data?.[t?.fillMode??L.MATERIAL_TriangleFillMode]?.babylonMaterial}function wi(s,e){return{offset:{componentsCount:2,type:"Vector2",get:(t,i,r)=>{let n=Jo(t,r,s,e);return new he(n?.uOffset,n?.vOffset)},getTarget:xe,set:(t,i,r,n)=>{let a=Jo(i,n,s,e);a.uOffset=t.x,a.vOffset=t.y},getPropertyName:[()=>`${s}${e?"."+e:""}.uOffset`,()=>`${s}${e?"."+e:""}.vOffset`]},rotation:{type:"number",get:(t,i,r)=>Jo(t,r,s,e)?.wAng,getTarget:xe,set:(t,i,r,n)=>Jo(i,n,s,e).wAng=t,getPropertyName:[()=>`${s}${e?"."+e:""}.wAng`]},scale:{componentsCount:2,type:"Vector2",get:(t,i,r)=>{let n=Jo(t,r,s,e);return new he(n?.uScale,n?.vScale)},getTarget:xe,set:(t,i,r,n)=>{let a=Jo(i,n,s,e);a.uScale=t.x,a.vScale=t.y},getPropertyName:[()=>`${s}${e?"."+e:""}.uScale`,()=>`${s}${e?"."+e:""}.vScale`]}}}function pg(s){return new ug(s,dg)}function zu(s){let e=s.split("/").map(i=>i.replace(/{}/g,"__array__")),t=dg;for(let i of e)i&&(t=t[i]);if(t&&t.type&&t.get)return t}function ae(s,e){let t=s.split("/").map(r=>r.replace(/{}/g,"__array__")),i=dg;for(let r of t)r&&(i=i[r]);i&&i.type&&i.get&&(i.interpolation=e)}function Jr(s,e){let t=s.split("/").map(r=>r.replace(/{}/g,"__array__")),i=dg;for(let r of t)if(r){if(!i[r]){if(r==="?"){i.__ignoreObjectTree__=!0;continue}i[r]={},r==="__array__"&&(i[r].__target__=!0)}i=i[r]}Object.assign(i,e)}var cte,fte,hte,ute,dte,pte,dg,Za=S(()=>{ie();If();it();hg();ok();cte={length:{type:"number",get:s=>s.length,getTarget:s=>s.map(e=>e._babylonTransformNode),getPropertyName:[()=>"length"]},__array__:{__target__:!0,translation:{type:"Vector3",get:s=>s._babylonTransformNode?.position,set:(s,e)=>e._babylonTransformNode?.position.copyFrom(s),getTarget:s=>s._babylonTransformNode,getPropertyName:[()=>"position"]},rotation:{type:"Quaternion",get:s=>s._babylonTransformNode?.rotationQuaternion,set:(s,e)=>e._babylonTransformNode?.rotationQuaternion?.copyFrom(s),getTarget:s=>s._babylonTransformNode,getPropertyName:[()=>"rotationQuaternion"]},scale:{type:"Vector3",get:s=>s._babylonTransformNode?.scaling,set:(s,e)=>e._babylonTransformNode?.scaling.copyFrom(s),getTarget:s=>s._babylonTransformNode,getPropertyName:[()=>"scaling"]},weights:{length:{type:"number",get:s=>s._numMorphTargets,getTarget:s=>s._babylonTransformNode,getPropertyName:[()=>"influence"]},__array__:{__target__:!0,type:"number",get:(s,e)=>e!==void 0?s._primitiveBabylonMeshes?.[0].morphTargetManager?.getTarget(e).influence:void 0,getTarget:s=>s._babylonTransformNode,getPropertyName:[()=>"influence"]},type:"number[]",get:(s,e)=>[0],getTarget:s=>s._babylonTransformNode,getPropertyName:[()=>"influence"]},matrix:{type:"Matrix",get:s=>B.Compose(s._babylonTransformNode?.scaling,s._babylonTransformNode?.rotationQuaternion,s._babylonTransformNode?.position),getTarget:s=>s._babylonTransformNode,isReadOnly:!0},globalMatrix:{type:"Matrix",get:s=>{let e=B.Identity(),t=s.parent;for(;t&&t.parent;)t=t.parent;let i=s._babylonTransformNode?.position._isDirty||s._babylonTransformNode?.rotationQuaternion?._isDirty||s._babylonTransformNode?.scaling._isDirty;if(t){let r=t._babylonTransformNode?.computeWorldMatrix(!0).invert();r&&s._babylonTransformNode?.computeWorldMatrix(i)?.multiplyToRef(r,e)}else s._babylonTransformNode&&e.copyFrom(s._babylonTransformNode.computeWorldMatrix(i));return e},getTarget:s=>s._babylonTransformNode,isReadOnly:!0},extensions:{EXT_lights_ies:{multiplier:{type:"number",get:s=>s._babylonTransformNode?.getChildren(e=>e instanceof ui,!0)[0]?.intensity,getTarget:s=>s._babylonTransformNode?.getChildren(e=>e instanceof ui,!0)[0],set:(s,e)=>{if(e._babylonTransformNode){let t=e._babylonTransformNode.getChildren(i=>i instanceof ui,!0)[0];t&&(t.intensity=s)}}},color:{type:"Color3",get:s=>s._babylonTransformNode?.getChildren(e=>e instanceof ui,!0)[0]?.diffuse,getTarget:s=>s._babylonTransformNode?.getChildren(e=>e instanceof ui,!0)[0],set:(s,e)=>{if(e._babylonTransformNode){let t=e._babylonTransformNode.getChildren(i=>i instanceof ui,!0)[0];t&&(t.diffuse=s)}}}}}}},fte={length:{type:"number",get:s=>s.length,getTarget:s=>s.map(e=>e._babylonAnimationGroup),getPropertyName:[()=>"length"]},__array__:{}},hte={length:{type:"number",get:s=>s.length,getTarget:s=>s.map(e=>e.primitives[0]._instanceData?.babylonSourceMesh),getPropertyName:[()=>"length"]},__array__:{}},ute={__array__:{__target__:!0,orthographic:{xmag:{componentsCount:2,type:"Vector2",get:s=>new he(s._babylonCamera?.orthoLeft??0,s._babylonCamera?.orthoRight??0),set:(s,e)=>{e._babylonCamera&&(e._babylonCamera.orthoLeft=s.x,e._babylonCamera.orthoRight=s.y)},getTarget:s=>s,getPropertyName:[()=>"orthoLeft",()=>"orthoRight"]},ymag:{componentsCount:2,type:"Vector2",get:s=>new he(s._babylonCamera?.orthoBottom??0,s._babylonCamera?.orthoTop??0),set:(s,e)=>{e._babylonCamera&&(e._babylonCamera.orthoBottom=s.x,e._babylonCamera.orthoTop=s.y)},getTarget:s=>s,getPropertyName:[()=>"orthoBottom",()=>"orthoTop"]},zfar:{type:"number",get:s=>s._babylonCamera?.maxZ,set:(s,e)=>{e._babylonCamera&&(e._babylonCamera.maxZ=s)},getTarget:s=>s,getPropertyName:[()=>"maxZ"]},znear:{type:"number",get:s=>s._babylonCamera?.minZ,set:(s,e)=>{e._babylonCamera&&(e._babylonCamera.minZ=s)},getTarget:s=>s,getPropertyName:[()=>"minZ"]}},perspective:{aspectRatio:{type:"number",get:s=>s._babylonCamera?.getEngine().getAspectRatio(s._babylonCamera),getTarget:s=>s,getPropertyName:[()=>"aspectRatio"],isReadOnly:!0},yfov:{type:"number",get:s=>s._babylonCamera?.fov,set:(s,e)=>{e._babylonCamera&&(e._babylonCamera.fov=s)},getTarget:s=>s,getPropertyName:[()=>"fov"]},zfar:{type:"number",get:s=>s._babylonCamera?.maxZ,set:(s,e)=>{e._babylonCamera&&(e._babylonCamera.maxZ=s)},getTarget:s=>s,getPropertyName:[()=>"maxZ"]},znear:{type:"number",get:s=>s._babylonCamera?.minZ,set:(s,e)=>{e._babylonCamera&&(e._babylonCamera.minZ=s)},getTarget:s=>s,getPropertyName:[()=>"minZ"]}}}},dte={__array__:{__target__:!0,emissiveFactor:{type:"Color3",get:(s,e,t)=>xe(s,e,t).emissiveColor,set:(s,e,t,i)=>xe(e,t,i).emissiveColor.copyFrom(s),getTarget:(s,e,t)=>xe(s,e,t),getPropertyName:[()=>"emissiveColor"]},emissiveTexture:{extensions:{KHR_texture_transform:wi("emissiveTexture")}},normalTexture:{scale:{type:"number",get:(s,e,t)=>Jo(s,t,"bumpTexture")?.level,set:(s,e,t,i)=>{let r=Jo(e,i,"bumpTexture");r&&(r.level=s)},getTarget:(s,e,t)=>xe(s,e,t),getPropertyName:[()=>"level"]},extensions:{KHR_texture_transform:wi("bumpTexture")}},occlusionTexture:{strength:{type:"number",get:(s,e,t)=>xe(s,e,t).ambientTextureStrength,set:(s,e,t,i)=>{let r=xe(e,t,i);r&&(r.ambientTextureStrength=s)},getTarget:(s,e,t)=>xe(s,e,t),getPropertyName:[()=>"ambientTextureStrength"]},extensions:{KHR_texture_transform:wi("ambientTexture")}},pbrMetallicRoughness:{baseColorFactor:{type:"Color4",get:(s,e,t)=>{let i=xe(s,e,t);return me.FromColor3(i.albedoColor,i.alpha)},set:(s,e,t,i)=>{let r=xe(e,t,i);r.albedoColor.set(s.r,s.g,s.b),r.alpha=s.a},getTarget:(s,e,t)=>xe(s,e,t),getPropertyName:[()=>"albedoColor",()=>"alpha"]},baseColorTexture:{extensions:{KHR_texture_transform:wi("albedoTexture")}},metallicFactor:{type:"number",get:(s,e,t)=>xe(s,e,t).metallic,set:(s,e,t,i)=>{let r=xe(e,t,i);r&&(r.metallic=s)},getTarget:(s,e,t)=>xe(s,e,t),getPropertyName:[()=>"metallic"]},roughnessFactor:{type:"number",get:(s,e,t)=>xe(s,e,t).roughness,set:(s,e,t,i)=>{let r=xe(e,t,i);r&&(r.roughness=s)},getTarget:(s,e,t)=>xe(s,e,t),getPropertyName:[()=>"roughness"]},metallicRoughnessTexture:{extensions:{KHR_texture_transform:wi("metallicTexture")}}},extensions:{KHR_materials_anisotropy:{anisotropyStrength:{type:"number",get:(s,e,t)=>xe(s,e,t).anisotropy.intensity,set:(s,e,t,i)=>{xe(e,t,i).anisotropy.intensity=s},getTarget:(s,e,t)=>xe(s,e,t),getPropertyName:[()=>"anisotropy.intensity"]},anisotropyRotation:{type:"number",get:(s,e,t)=>xe(s,e,t).anisotropy.angle,set:(s,e,t,i)=>{xe(e,t,i).anisotropy.angle=s},getTarget:(s,e,t)=>xe(s,e,t),getPropertyName:[()=>"anisotropy.angle"]},anisotropyTexture:{extensions:{KHR_texture_transform:wi("anisotropy","texture")}}},KHR_materials_clearcoat:{clearcoatFactor:{type:"number",get:(s,e,t)=>xe(s,e,t).clearCoat.intensity,set:(s,e,t,i)=>{xe(e,t,i).clearCoat.intensity=s},getTarget:(s,e,t)=>xe(s,e,t),getPropertyName:[()=>"clearCoat.intensity"]},clearcoatRoughnessFactor:{type:"number",get:(s,e,t)=>xe(s,e,t).clearCoat.roughness,set:(s,e,t,i)=>{xe(e,t,i).clearCoat.roughness=s},getTarget:(s,e,t)=>xe(s,e,t),getPropertyName:[()=>"clearCoat.roughness"]},clearcoatTexture:{extensions:{KHR_texture_transform:wi("clearCoat","texture")}},clearcoatNormalTexture:{scale:{type:"number",get:(s,e,t)=>xe(s,e,t).clearCoat.bumpTexture?.level,getTarget:xe,set:(s,e,t,i)=>xe(e,t,i).clearCoat.bumpTexture.level=s},extensions:{KHR_texture_transform:wi("clearCoat","bumpTexture")}},clearcoatRoughnessTexture:{extensions:{KHR_texture_transform:wi("clearCoat","textureRoughness")}}},KHR_materials_dispersion:{dispersion:{type:"number",get:(s,e,t)=>xe(s,e,t).subSurface.dispersion,getTarget:xe,set:(s,e,t,i)=>xe(e,t,i).subSurface.dispersion=s}},KHR_materials_emissive_strength:{emissiveStrength:{type:"number",get:(s,e,t)=>xe(s,e,t).emissiveIntensity,getTarget:xe,set:(s,e,t,i)=>xe(e,t,i).emissiveIntensity=s}},KHR_materials_ior:{ior:{type:"number",get:(s,e,t)=>xe(s,e,t).indexOfRefraction,getTarget:xe,set:(s,e,t,i)=>xe(e,t,i).indexOfRefraction=s}},KHR_materials_iridescence:{iridescenceFactor:{type:"number",get:(s,e,t)=>xe(s,e,t).iridescence.intensity,getTarget:xe,set:(s,e,t,i)=>xe(e,t,i).iridescence.intensity=s},iridescenceIor:{type:"number",get:(s,e,t)=>xe(s,e,t).iridescence.indexOfRefraction,getTarget:xe,set:(s,e,t,i)=>xe(e,t,i).iridescence.indexOfRefraction=s},iridescenceTexture:{extensions:{KHR_texture_transform:wi("iridescence","texture")}},iridescenceThicknessMaximum:{type:"number",get:(s,e,t)=>xe(s,e,t).iridescence.maximumThickness,getTarget:xe,set:(s,e,t,i)=>xe(e,t,i).iridescence.maximumThickness=s},iridescenceThicknessMinimum:{type:"number",get:(s,e,t)=>xe(s,e,t).iridescence.minimumThickness,getTarget:xe,set:(s,e,t,i)=>xe(e,t,i).iridescence.minimumThickness=s},iridescenceThicknessTexture:{extensions:{KHR_texture_transform:wi("iridescence","thicknessTexture")}}},KHR_materials_sheen:{sheenColorFactor:{type:"Color3",get:(s,e,t)=>xe(s,e,t).sheen.color,getTarget:xe,set:(s,e,t,i)=>xe(e,t,i).sheen.color.copyFrom(s)},sheenColorTexture:{extensions:{KHR_texture_transform:wi("sheen","texture")}},sheenRoughnessFactor:{type:"number",get:(s,e,t)=>xe(s,e,t).sheen.intensity,getTarget:xe,set:(s,e,t,i)=>xe(e,t,i).sheen.intensity=s},sheenRoughnessTexture:{extensions:{KHR_texture_transform:wi("sheen","thicknessTexture")}}},KHR_materials_specular:{specularFactor:{type:"number",get:(s,e,t)=>xe(s,e,t).metallicF0Factor,getTarget:xe,set:(s,e,t,i)=>xe(e,t,i).metallicF0Factor=s,getPropertyName:[()=>"metallicF0Factor"]},specularColorFactor:{type:"Color3",get:(s,e,t)=>xe(s,e,t).metallicReflectanceColor,getTarget:xe,set:(s,e,t,i)=>xe(e,t,i).metallicReflectanceColor.copyFrom(s),getPropertyName:[()=>"metallicReflectanceColor"]},specularTexture:{extensions:{KHR_texture_transform:wi("metallicReflectanceTexture")}},specularColorTexture:{extensions:{KHR_texture_transform:wi("reflectanceTexture")}}},KHR_materials_transmission:{transmissionFactor:{type:"number",get:(s,e,t)=>xe(s,e,t).subSurface.refractionIntensity,getTarget:xe,set:(s,e,t,i)=>xe(e,t,i).subSurface.refractionIntensity=s,getPropertyName:[()=>"subSurface.refractionIntensity"]},transmissionTexture:{extensions:{KHR_texture_transform:wi("subSurface","refractionIntensityTexture")}}},KHR_materials_diffuse_transmission:{diffuseTransmissionFactor:{type:"number",get:(s,e,t)=>xe(s,e,t).subSurface.translucencyIntensity,getTarget:xe,set:(s,e,t,i)=>xe(e,t,i).subSurface.translucencyIntensity=s},diffuseTransmissionTexture:{extensions:{KHR_texture_transform:wi("subSurface","translucencyIntensityTexture")}},diffuseTransmissionColorFactor:{type:"Color3",get:(s,e,t)=>xe(s,e,t).subSurface.translucencyColor,getTarget:xe,set:(s,e,t,i)=>s&&xe(e,t,i).subSurface.translucencyColor?.copyFrom(s)},diffuseTransmissionColorTexture:{extensions:{KHR_texture_transform:wi("subSurface","translucencyColorTexture")}}},KHR_materials_volume:{attenuationColor:{type:"Color3",get:(s,e,t)=>xe(s,e,t).subSurface.tintColor,getTarget:xe,set:(s,e,t,i)=>xe(e,t,i).subSurface.tintColor.copyFrom(s)},attenuationDistance:{type:"number",get:(s,e,t)=>xe(s,e,t).subSurface.tintColorAtDistance,getTarget:xe,set:(s,e,t,i)=>xe(e,t,i).subSurface.tintColorAtDistance=s},thicknessFactor:{type:"number",get:(s,e,t)=>xe(s,e,t).subSurface.maximumThickness,getTarget:xe,set:(s,e,t,i)=>xe(e,t,i).subSurface.maximumThickness=s},thicknessTexture:{extensions:{KHR_texture_transform:wi("subSurface","thicknessTexture")}}}}}},pte={KHR_lights_punctual:{lights:{length:{type:"number",get:s=>s.length,getTarget:s=>s.map(e=>e._babylonLight),getPropertyName:[s=>"length"]},__array__:{__target__:!0,color:{type:"Color3",get:s=>s._babylonLight?.diffuse,set:(s,e)=>e._babylonLight?.diffuse.copyFrom(s),getTarget:s=>s._babylonLight,getPropertyName:[s=>"diffuse"]},intensity:{type:"number",get:s=>s._babylonLight?.intensity,set:(s,e)=>e._babylonLight?e._babylonLight.intensity=s:void 0,getTarget:s=>s._babylonLight,getPropertyName:[s=>"intensity"]},range:{type:"number",get:s=>s._babylonLight?.range,set:(s,e)=>e._babylonLight?e._babylonLight.range=s:void 0,getTarget:s=>s._babylonLight,getPropertyName:[s=>"range"]},spot:{innerConeAngle:{type:"number",get:s=>s._babylonLight?.innerAngle,set:(s,e)=>e._babylonLight?e._babylonLight.innerAngle=s:void 0,getTarget:s=>s._babylonLight,getPropertyName:[s=>"innerConeAngle"]},outerConeAngle:{type:"number",get:s=>s._babylonLight?.angle,set:(s,e)=>e._babylonLight?e._babylonLight.angle=s:void 0,getTarget:s=>s._babylonLight,getPropertyName:[s=>"outerConeAngle"]}}}}},EXT_lights_ies:{lights:{length:{type:"number",get:s=>s.length,getTarget:s=>s.map(e=>e._babylonLight),getPropertyName:[s=>"length"]}}},EXT_lights_image_based:{lights:{length:{type:"number",get:s=>s.length,getTarget:s=>s.map(e=>e._babylonTexture),getPropertyName:[s=>"length"]},__array__:{__target__:!0,intensity:{type:"number",get:s=>s._babylonTexture?.level,set:(s,e)=>{e._babylonTexture&&(e._babylonTexture.level=s)},getTarget:s=>s._babylonTexture},rotation:{type:"Quaternion",get:s=>s._babylonTexture&&K.FromRotationMatrix(s._babylonTexture?.getReflectionTextureMatrix()),set:(s,e)=>{e._babylonTexture&&(e._babylonTexture.getScene()?.useRightHandedSystem||(s=K.Inverse(s)),B.FromQuaternionToRef(s,e._babylonTexture.getReflectionTextureMatrix()))},getTarget:s=>s._babylonTexture}}}}};dg={cameras:ute,nodes:cte,materials:dte,extensions:pte,animations:fte,meshes:hte}});var Xu,lk=S(()=>{Xu=class{constructor(e){this._factory=e}get value(){return this._factory&&(this._value=this._factory(),this._factory=void 0),this._value}}});var mg,ck=S(()=>{ie();ws();mg=class{get currentFrame(){return this._currentFrame}get weight(){return this._weight}get currentValue(){return this._currentValue}get targetPath(){return this._targetPath}get target(){return this._currentActiveTarget}get isAdditive(){return this._host&&this._host.isAdditive}constructor(e,t,i,r){if(this._events=new Array,this._currentFrame=0,this._originalValue=new Array,this._originalBlendValue=null,this._offsetsCache={},this._highLimitsCache={},this._stopped=!1,this._blendingFactor=0,this._currentValue=null,this._currentActiveTarget=null,this._directTarget=null,this._targetPath="",this._weight=1,this._absoluteFrameOffset=0,this._previousElapsedTime=0,this._yoyoDirection=1,this._previousAbsoluteFrame=0,this._targetIsArray=!1,this._coreRuntimeAnimation=null,this._animation=t,this._target=e,this._scene=i,this._host=r,this._activeTargets=[],t._runtimeAnimations.push(this),this._animationState={key:0,repeatCount:0,loopMode:this._getCorrectLoopMode()},this._animation.dataType===q.ANIMATIONTYPE_MATRIX&&(this._animationState.workValue=B.Zero()),this._keys=this._animation.getKeys(),this._minFrame=this._keys[0].frame,this._maxFrame=this._keys[this._keys.length-1].frame,this._minValue=this._keys[0].value,this._maxValue=this._keys[this._keys.length-1].value,this._minFrame!==0){let a={frame:0,value:this._minValue};this._keys.splice(0,0,a)}if(this._target instanceof Array){let a=0;for(let o of this._target)this._preparePath(o,a),this._getOriginalValues(a),a++;this._targetIsArray=!0}else this._preparePath(this._target),this._getOriginalValues(),this._targetIsArray=!1,this._directTarget=this._activeTargets[0];let n=t.getEvents();if(n&&n.length>0)for(let a of n)this._events.push(a._clone());this._enableBlending=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.enableBlending:this._animation.enableBlending}_preparePath(e,t=0){let i=this._animation.targetPropertyPath;if(i.length>1){let r=e;for(let n=0;n<i.length-1;n++){let a=i[n];if(r=r[a],r===void 0)throw new Error(`Invalid property (${a}) in property path (${i.join(".")})`)}this._targetPath=i[i.length-1],this._activeTargets[t]=r}else this._targetPath=i[0],this._activeTargets[t]=e;if(this._activeTargets[t][this._targetPath]===void 0)throw new Error(`Invalid property (${this._targetPath}) in property path (${i.join(".")})`)}get animation(){return this._animation}reset(e=!1){if(e)if(this._target instanceof Array){let t=0;for(let i of this._target)this._originalValue[t]!==void 0&&this._setValue(i,this._activeTargets[t],this._originalValue[t],-1,t),t++}else this._originalValue[0]!==void 0&&this._setValue(this._target,this._directTarget,this._originalValue[0],-1,0);this._offsetsCache={},this._highLimitsCache={},this._currentFrame=0,this._blendingFactor=0;for(let t=0;t<this._events.length;t++)this._events[t].isDone=!1}isStopped(){return this._stopped}dispose(){let e=this._animation.runtimeAnimations.indexOf(this);e>-1&&this._animation.runtimeAnimations.splice(e,1)}setValue(e,t){if(this._targetIsArray){for(let i=0;i<this._target.length;i++){let r=this._target[i];this._setValue(r,this._activeTargets[i],e,t,i)}return}this._setValue(this._target,this._directTarget,e,t,0)}_getOriginalValues(e=0){let t,i=this._activeTargets[e];i.getLocalMatrix&&this._targetPath==="_matrix"?t=i.getLocalMatrix():t=i[this._targetPath],t&&t.clone?this._originalValue[e]=t.clone():this._originalValue[e]=t}_registerTargetForLateAnimationBinding(e,t){let i=e.target;this._scene._registeredForLateAnimationBindings.pushNoDuplicate(i),i._lateAnimationHolders||(i._lateAnimationHolders={}),i._lateAnimationHolders[e.targetPath]||(i._lateAnimationHolders[e.targetPath]={totalWeight:0,totalAdditiveWeight:0,animations:[],additiveAnimations:[],originalValue:t}),e.isAdditive?(i._lateAnimationHolders[e.targetPath].additiveAnimations.push(e),i._lateAnimationHolders[e.targetPath].totalAdditiveWeight+=e.weight):(i._lateAnimationHolders[e.targetPath].animations.push(e),i._lateAnimationHolders[e.targetPath].totalWeight+=e.weight)}_setValue(e,t,i,r,n){if(this._currentActiveTarget=t,this._weight=r,this._enableBlending&&this._blendingFactor<=1){if(!this._originalBlendValue){let o=t[this._targetPath];o.clone?this._originalBlendValue=o.clone():this._originalBlendValue=o}this._originalBlendValue.m?q.AllowMatrixDecomposeForInterpolation?this._currentValue?B.DecomposeLerpToRef(this._originalBlendValue,i,this._blendingFactor,this._currentValue):this._currentValue=B.DecomposeLerp(this._originalBlendValue,i,this._blendingFactor):this._currentValue?B.LerpToRef(this._originalBlendValue,i,this._blendingFactor,this._currentValue):this._currentValue=B.Lerp(this._originalBlendValue,i,this._blendingFactor):this._currentValue=q._UniversalLerp(this._originalBlendValue,i,this._blendingFactor);let a=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.blendingSpeed:this._animation.blendingSpeed;this._blendingFactor+=a}else this._currentValue?this._currentValue.copyFrom?this._currentValue.copyFrom(i):this._currentValue=i:i?.clone?this._currentValue=i.clone():this._currentValue=i;r!==-1?this._registerTargetForLateAnimationBinding(this,this._originalValue[n]):this._animationState.loopMode===q.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT?this._currentValue.addToRef?this._currentValue.addToRef(this._originalValue[n],t[this._targetPath]):t[this._targetPath]=this._originalValue[n]+this._currentValue:t[this._targetPath]=this._currentValue,e.markAsDirty&&e.markAsDirty(this._animation.targetProperty)}_getCorrectLoopMode(){return this._target&&this._target.animationPropertiesOverride?this._target.animationPropertiesOverride.loopMode:this._animation.loopMode}goToFrame(e,t=-1){let i=this._animation.getKeys();e<i[0].frame?e=i[0].frame:e>i[i.length-1].frame&&(e=i[i.length-1].frame);let r=this._events;if(r.length)for(let a=0;a<r.length;a++)r[a].onlyOnce||(r[a].isDone=r[a].frame<e);this._currentFrame=e;let n=this._animation._interpolate(e,this._animationState);this.setValue(n,t)}_prepareForSpeedRatioChange(e){let t=this._previousElapsedTime*(this._animation.framePerSecond*e)/1e3;this._absoluteFrameOffset=this._previousAbsoluteFrame-t}animate(e,t,i,r,n,a=-1){let o=this._animation,l=o.targetPropertyPath;if(!l||l.length<1)return this._stopped=!0,!1;let c=!0,f,h=this._events,u=0;if(this._coreRuntimeAnimation)u=i-t,f=this._coreRuntimeAnimation.currentFrame,this._currentFrame=f,this._animationState.repeatCount=this._coreRuntimeAnimation._animationState.repeatCount,this._animationState.highLimitValue=this._coreRuntimeAnimation._animationState.highLimitValue,this._animationState.offsetValue=this._coreRuntimeAnimation._animationState.offsetValue;else{(t<this._minFrame||t>this._maxFrame)&&(t=this._minFrame),(i<this._minFrame||i>this._maxFrame)&&(i=this._maxFrame),u=i-t;let p,m=e*(o.framePerSecond*n)/1e3+this._absoluteFrameOffset,_=0,v=!1,T=r&&this._animationState.loopMode===q.ANIMATIONLOOPMODE_YOYO;if(T){let C=(m-t)/u,I=Math.sin(C*Math.PI);m=Math.abs(I)*u+t;let b=I>=0?1:-1;this._yoyoDirection!==b&&(v=!0),this._yoyoDirection=b}if(this._previousElapsedTime=e,this._previousAbsoluteFrame=m,!r&&i>=t&&(m>=u&&n>0||m<=0&&n<0))c=!1,_=o._getKeyValue(this._maxValue);else if(!r&&t>=i&&(m<=u&&n<0||m>=0&&n>0))c=!1,_=o._getKeyValue(this._minValue);else if(this._animationState.loopMode!==q.ANIMATIONLOOPMODE_CYCLE){let C=i.toString()+t.toString();if(!this._offsetsCache[C]){this._animationState.repeatCount=0,this._animationState.loopMode=q.ANIMATIONLOOPMODE_CYCLE;let I=o._interpolate(t,this._animationState),R=o._interpolate(i,this._animationState);switch(this._animationState.loopMode=this._getCorrectLoopMode(),o.dataType){case q.ANIMATIONTYPE_FLOAT:this._offsetsCache[C]=R-I;break;case q.ANIMATIONTYPE_QUATERNION:this._offsetsCache[C]=R.subtract(I);break;case q.ANIMATIONTYPE_VECTOR3:this._offsetsCache[C]=R.subtract(I);break;case q.ANIMATIONTYPE_VECTOR2:this._offsetsCache[C]=R.subtract(I);break;case q.ANIMATIONTYPE_SIZE:this._offsetsCache[C]=R.subtract(I);break;case q.ANIMATIONTYPE_COLOR3:this._offsetsCache[C]=R.subtract(I);break;default:break}this._highLimitsCache[C]=R}_=this._highLimitsCache[C],p=this._offsetsCache[C]}if(p===void 0)switch(o.dataType){case q.ANIMATIONTYPE_FLOAT:p=0;break;case q.ANIMATIONTYPE_QUATERNION:p=dC;break;case q.ANIMATIONTYPE_VECTOR3:p=pC;break;case q.ANIMATIONTYPE_VECTOR2:p=mC;break;case q.ANIMATIONTYPE_SIZE:p=_C;break;case q.ANIMATIONTYPE_COLOR3:p=gC;break;case q.ANIMATIONTYPE_COLOR4:p=vC;break}if(this._host&&this._host.syncRoot){let C=this._host.syncRoot,I=(C.masterFrame-C.fromFrame)/(C.toFrame-C.fromFrame);f=t+u*I}else m>0&&t>i||m<0&&t<i?f=c&&u!==0?i+m%u:t:f=c&&u!==0?t+m%u:i;if(!T&&(n>0&&this.currentFrame>f||n<0&&this.currentFrame<f)||T&&v){this._onLoop();for(let C=0;C<h.length;C++)h[C].onlyOnce||(h[C].isDone=!1);this._animationState.key=n>0?0:o.getKeys().length-1}this._currentFrame=f,this._animationState.repeatCount=u===0?0:m/u>>0,this._animationState.highLimitValue=_,this._animationState.offsetValue=p}let d=o._interpolate(f,this._animationState);if(this.setValue(d,a),h.length){for(let p=0;p<h.length;p++)if(u>=0&&f>=h[p].frame&&h[p].frame>=t||u<0&&f<=h[p].frame&&h[p].frame<=t){let m=h[p];m.isDone||(m.onlyOnce&&(h.splice(p,1),p--),m.isDone=!0,m.action(f))}}return c||(this._stopped=!0),c}}});function mte(s){if(s.totalWeight===0&&s.totalAdditiveWeight===0)return s.originalValue;let e=1,t=w.Vector3[0],i=w.Vector3[1],r=w.Quaternion[0],n=0,a=s.animations[0],o=s.originalValue,l=1,c=!1;if(s.totalWeight<1)l=1-s.totalWeight,o.decompose(i,r,t);else{if(n=1,e=s.totalWeight,l=a.weight/e,l==1)if(s.totalAdditiveWeight)c=!0;else return a.currentValue;a.currentValue.decompose(i,r,t)}if(!c){i.scaleInPlace(l),t.scaleInPlace(l),r.scaleInPlace(l);for(let h=n;h<s.animations.length;h++){let u=s.animations[h];if(u.weight===0)continue;l=u.weight/e;let d=w.Vector3[2],p=w.Vector3[3],m=w.Quaternion[1];u.currentValue.decompose(p,m,d),p.scaleAndAddToRef(l,i),m.scaleAndAddToRef(K.Dot(r,m)>0?l:-l,r),d.scaleAndAddToRef(l,t)}r.normalize()}for(let h=0;h<s.additiveAnimations.length;h++){let u=s.additiveAnimations[h];if(u.weight===0)continue;let d=w.Vector3[2],p=w.Vector3[3],m=w.Quaternion[1];u.currentValue.decompose(p,m,d),p.multiplyToRef(i,p),E.LerpToRef(i,p,u.weight,i),r.multiplyToRef(m,m),K.SlerpToRef(r,m,u.weight,r),d.scaleAndAddToRef(u.weight,t)}let f=a?a._animationState.workValue:w.Matrix[0].clone();return B.ComposeToRef(i,r,t,f),f}function _te(s,e){if(s.totalWeight===0&&s.totalAdditiveWeight===0)return e;let t=s.animations[0],i=s.originalValue,r=e;if(s.totalWeight===0&&s.totalAdditiveWeight>0)r.copyFrom(i);else if(s.animations.length===1){if(K.SlerpToRef(i,t.currentValue,Math.min(1,s.totalWeight),r),s.totalAdditiveWeight===0)return r}else if(s.animations.length>1){let n=1,a,o;if(s.totalWeight<1){let c=1-s.totalWeight;a=[],o=[],a.push(i),o.push(c)}else{if(s.animations.length===2&&(K.SlerpToRef(s.animations[0].currentValue,s.animations[1].currentValue,s.animations[1].weight/s.totalWeight,e),s.totalAdditiveWeight===0))return e;a=[],o=[],n=s.totalWeight}for(let c=0;c<s.animations.length;c++){let f=s.animations[c];a.push(f.currentValue),o.push(f.weight/n)}let l=0;for(let c=0;c<a.length;){if(!c){K.SlerpToRef(a[c],a[c+1],o[c+1]/(o[c]+o[c+1]),e),r=e,l=o[c]+o[c+1],c+=2;continue}l+=o[c],K.SlerpToRef(r,a[c],o[c]/l,r),c++}}for(let n=0;n<s.additiveAnimations.length;n++){let a=s.additiveAnimations[n];a.weight!==0&&(r.multiplyToRef(a.currentValue,w.Quaternion[0]),K.SlerpToRef(r,w.Quaternion[0],a.weight,r))}return r}function gte(s){if(s._registeredForLateAnimationBindings.length){for(let e=0;e<s._registeredForLateAnimationBindings.length;e++){let t=s._registeredForLateAnimationBindings.data[e];for(let i in t._lateAnimationHolders){let r=t._lateAnimationHolders[i],n=r.animations[0],a=r.originalValue;if(a==null)continue;let o=q.AllowMatrixDecomposeForInterpolation&&a.m,l=t[i];if(o)l=mte(r);else if(a.w!==void 0)l=_te(r,l||K.Identity());else{let f=0,h=1,u=n&&n._animationState.loopMode===q.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT;if(r.totalWeight<1)u?l=a.clone?a.clone():a:n&&a.scale?l=a.scale(1-r.totalWeight):n?l=a*(1-r.totalWeight):a.clone?l=a.clone():l=a;else if(n){h=r.totalWeight;let d=n.weight/h;d!==1?n.currentValue.scale?l=n.currentValue.scale(d):l=n.currentValue*d:l=n.currentValue,u&&(l.addToRef?l.addToRef(a,l):l+=a),f=1}for(let d=f;d<r.animations.length;d++){let p=r.animations[d],m=p.weight/h;if(m)p.currentValue.scaleAndAddToRef?p.currentValue.scaleAndAddToRef(m,l):l+=p.currentValue*m;else continue}for(let d=0;d<r.additiveAnimations.length;d++){let p=r.additiveAnimations[d],m=p.weight;if(m)p.currentValue.scaleAndAddToRef?p.currentValue.scaleAndAddToRef(m,l):l+=p.currentValue*m;else continue}}t[i]=l}t._lateAnimationHolders={}}s._registeredForLateAnimationBindings.reset()}}function fk(s,e){e&&(e.prototype.copyAnimationRange=function(t,i,r,n=!1,a=null){this.animations.length===0&&(this.animations.push(new q(this.name,"_matrix",t.animations[0].framePerSecond,q.ANIMATIONTYPE_MATRIX,0)),this.animations[0].setKeys([]));let o=t.animations[0].getRange(i);if(!o)return!1;let l=o.from,c=o.to,f=t.animations[0].getKeys(),h=t.length,u=t.getParent(),d=this.getParent(),p=n&&u&&h&&this.length&&h!==this.length,m=p&&d&&u?d.length/u.length:1,_=n&&!d&&a&&(a.x!==1||a.y!==1||a.z!==1),v=this.animations[0].getKeys(),T,C,I;for(let R=0,b=f.length;R<b;R++)T=f[R],T.frame>=l&&T.frame<=c&&(n?(I=T.value.clone(),p?(C=I.getTranslation(),I.setTranslation(C.scaleInPlace(m))):_&&a?(C=I.getTranslation(),I.setTranslation(C.multiplyInPlace(a))):I=T.value):I=T.value,v.push({frame:T.frame+r,value:I}));return this.animations[0].createRange(i,l+r,c+r),!0}),s&&(s.prototype._animate=function(t){if(!this.animationsEnabled)return;let i=Zt.Now;if(!this._animationTimeLast){if(this._pendingData.length>0)return;this._animationTimeLast=i}this.deltaTime=t!==void 0?t:this.useConstantAnimationDeltaTime?16:(i-this._animationTimeLast)*this.animationTimeScale,this._animationTimeLast=i;let r=this._activeAnimatables;if(r.length===0)return;this._animationTime+=this.deltaTime;let n=this._animationTime;for(let a=0;a<r.length;a++){let o=r[a];!o._animate(n)&&o.disposeOnEnd&&a--}gte(this)},s.prototype.sortActiveAnimatables=function(){this._activeAnimatables.sort((t,i)=>t.playOrder-i.playOrder)},s.prototype.beginWeightedAnimation=function(t,i,r,n=1,a,o=1,l,c,f,h,u=!1){let d=this.beginAnimation(t,i,r,a,o,l,c,!1,f,h,u);return d.weight=n,d},s.prototype.beginAnimation=function(t,i,r,n,a=1,o,l,c=!0,f,h,u=!1){if(a<0){let p=i;i=r,r=p,a=-a}i>r&&(a=-a),c&&this.stopAnimation(t,void 0,f),l||(l=new Yu(this,t,i,r,n,a,o,void 0,h,u));let d=f?f(t):!0;if(t.animations&&d&&l.appendAnimations(t,t.animations),t.getAnimatables){let p=t.getAnimatables();for(let m=0;m<p.length;m++)this.beginAnimation(p[m],i,r,n,a,o,l,c,f,h)}return l.reset(),l},s.prototype.beginHierarchyAnimation=function(t,i,r,n,a,o=1,l,c,f=!0,h,u,d=!1){let p=t.getDescendants(i),m=[];m.push(this.beginAnimation(t,r,n,a,o,l,c,f,h,void 0,d));for(let _ of p)m.push(this.beginAnimation(_,r,n,a,o,l,c,f,h,void 0,d));return m},s.prototype.beginDirectAnimation=function(t,i,r,n,a,o=1,l,c,f=!1){if(o<0){let u=r;r=n,n=u,o=-o}return r>n&&(o=-o),new Yu(this,t,r,n,a,o,l,i,c,f)},s.prototype.beginDirectHierarchyAnimation=function(t,i,r,n,a,o,l,c,f,h=!1){let u=t.getDescendants(i),d=[];d.push(this.beginDirectAnimation(t,r,n,a,o,l,c,f,h));for(let p of u)d.push(this.beginDirectAnimation(p,r,n,a,o,l,c,f,h));return d},s.prototype.getAnimatableByTarget=function(t){for(let i=0;i<this._activeAnimatables.length;i++)if(this._activeAnimatables[i].target===t)return this._activeAnimatables[i];return null},s.prototype.getAllAnimatablesByTarget=function(t){let i=[];for(let r=0;r<this._activeAnimatables.length;r++)this._activeAnimatables[r].target===t&&i.push(this._activeAnimatables[r]);return i},s.prototype.stopAnimation=function(t,i,r){let n=this.getAllAnimatablesByTarget(t);for(let a of n)a.stop(i,r)},s.prototype.stopAllAnimations=function(){if(this._activeAnimatables){for(let t=0;t<this._activeAnimatables.length;t++)this._activeAnimatables[t].stop(void 0,void 0,!0);this._activeAnimatables.length=0}for(let t of this.animationGroups)t.stop()})}var Yu,ay=S(()=>{we();ck();ws();zs();ie();Yu=class s{get syncRoot(){return this._syncRoot}get masterFrame(){return this._runtimeAnimations.length===0?0:this._runtimeAnimations[0].currentFrame}get weight(){return this._weight}set weight(e){if(e===-1){this._weight=-1;return}this._weight=Math.min(Math.max(e,0),1)}get speedRatio(){return this._speedRatio}set speedRatio(e){for(let t=0;t<this._runtimeAnimations.length;t++)this._runtimeAnimations[t]._prepareForSpeedRatioChange(e);this._speedRatio=e,this._goToFrame!==null&&this.goToFrame(this._goToFrame)}get elapsedTime(){return this._localDelayOffset===null?0:this._scene._animationTime-this._localDelayOffset}constructor(e,t,i=0,r=100,n=!1,a=1,o,l,c,f=!1,h=0){this.target=t,this.fromFrame=i,this.toFrame=r,this.loopAnimation=n,this.onAnimationEnd=o,this.onAnimationLoop=c,this.isAdditive=f,this.playOrder=h,this._localDelayOffset=null,this._pausedDelay=null,this._manualJumpDelay=null,this._runtimeAnimations=new Array,this._paused=!1,this._speedRatio=1,this._weight=-1,this._previousWeight=-1,this._syncRoot=null,this._frameToSyncFromJump=null,this._goToFrame=null,this.disposeOnEnd=!0,this.animationStarted=!1,this.onAnimationEndObservable=new N,this.onAnimationLoopObservable=new N,this._scene=e,l&&this.appendAnimations(t,l),this._speedRatio=a,e._activeAnimatables.push(this)}syncWith(e){if(this._syncRoot=e,e){let t=this._scene._activeAnimatables.indexOf(this);t>-1&&(this._scene._activeAnimatables.splice(t,1),this._scene._activeAnimatables.push(this))}return this}getAnimations(){return this._runtimeAnimations}appendAnimations(e,t){for(let i=0;i<t.length;i++){let r=t[i],n=new mg(e,r,this._scene,this);n._onLoop=()=>{this.onAnimationLoopObservable.notifyObservers(this),this.onAnimationLoop&&this.onAnimationLoop()},this._runtimeAnimations.push(n)}}getAnimationByTargetProperty(e){let t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i].animation;return null}getRuntimeAnimationByTargetProperty(e){let t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i];return null}reset(){let e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].reset(!0);this._localDelayOffset=null,this._pausedDelay=null}enableBlending(e){let t=this._runtimeAnimations;for(let i=0;i<t.length;i++)t[i].animation.enableBlending=!0,t[i].animation.blendingSpeed=e}disableBlending(){let e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].animation.enableBlending=!1}goToFrame(e,t=!1){let i=this._runtimeAnimations;if(i[0]){let r=i[0].animation.framePerSecond;this._frameToSyncFromJump=this._frameToSyncFromJump??i[0].currentFrame;let n=this.speedRatio===0?0:(e-this._frameToSyncFromJump)/r*1e3/this.speedRatio;this._manualJumpDelay=-n}for(let r=0;r<i.length;r++)i[r].goToFrame(e,t?this._weight:-1);this._goToFrame=e}get paused(){return this._paused}pause(){this._paused||(this._paused=!0)}restart(){this._paused=!1}_raiseOnAnimationEnd(){this.onAnimationEnd&&this.onAnimationEnd(),this.onAnimationEndObservable.notifyObservers(this)}stop(e,t,i=!1,r=!1){if(e||t){let n=this._scene._activeAnimatables.indexOf(this);if(n>-1){let a=this._runtimeAnimations;for(let o=a.length-1;o>=0;o--){let l=a[o];e&&l.animation.name!=e||t&&!t(l.target)||(l.dispose(),a.splice(o,1))}a.length==0&&(i||this._scene._activeAnimatables.splice(n,1),r||this._raiseOnAnimationEnd())}}else{let n=this._scene._activeAnimatables.indexOf(this);if(n>-1){i||this._scene._activeAnimatables.splice(n,1);let a=this._runtimeAnimations;for(let o=0;o<a.length;o++)a[o].dispose();this._runtimeAnimations.length=0,r||this._raiseOnAnimationEnd()}}}async waitAsync(){return await new Promise(e=>{this.onAnimationEndObservable.add(()=>{e(this)},void 0,void 0,this,!0)})}_animate(e){if(this._paused)return this.animationStarted=!1,this._pausedDelay===null&&(this._pausedDelay=e),!0;if(this._localDelayOffset===null?(this._localDelayOffset=e,this._pausedDelay=null):this._pausedDelay!==null&&(this._localDelayOffset+=e-this._pausedDelay,this._pausedDelay=null),this._manualJumpDelay!==null&&(this._localDelayOffset+=this.speedRatio<0?-this._manualJumpDelay:this._manualJumpDelay,this._manualJumpDelay=null,this._frameToSyncFromJump=null),this._goToFrame=null,!s.ProcessPausedAnimatables&&this._weight===0&&this._previousWeight===0)return!0;this._previousWeight=this._weight;let t=!1,i=this._runtimeAnimations,r;for(r=0;r<i.length;r++){let a=i[r].animate(e-this._localDelayOffset,this.fromFrame,this.toFrame,this.loopAnimation,this._speedRatio,this._weight);t=t||a}if(this.animationStarted=t,!t){if(this.disposeOnEnd)for(r=this._scene._activeAnimatables.indexOf(this),this._scene._activeAnimatables.splice(r,1),r=0;r<i.length;r++)i[r].dispose();this._raiseOnAnimationEnd(),this.disposeOnEnd&&(this.onAnimationEnd=null,this.onAnimationLoop=null,this.onAnimationLoopObservable.clear(),this.onAnimationEndObservable.clear())}return t}};Yu.ProcessPausedAnimatables=!1});var hk=S(()=>{ku();ay();Xr();ay();fk(ze,Zr)});var uk={};V(uk,{AnimationGroup:()=>Ku,TargetedAnimation:()=>_g});var _g,Ku,oy=S(()=>{ws();we();gt();po();hk();ym();_g=class{getClassName(){return"TargetedAnimation"}constructor(e){this.parent=e,this.uniqueId=xa.UniqueId}serialize(){let e={};return e.animation=this.animation.serialize(),e.targetId=this.target.id,e}},Ku=class s{get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this.syncWithMask(!0))}syncWithMask(e=!1){if(!this.mask&&!e){this._numActiveAnimatables=this._targetedAnimations.length;return}this._numActiveAnimatables=0;for(let t=0;t<this._animatables.length;++t){let i=this._animatables[t];!this.mask||this.mask.disabled||this.mask.retainsTarget(i.target.name)?(this._numActiveAnimatables++,i.paused&&i.restart()):i.paused||i.pause()}}removeUnmaskedAnimations(){if(!(!this.mask||this.mask.disabled)){for(let e=0;e<this._animatables.length;++e){let t=this._animatables[e];this.mask.retainsTarget(t.target.name)||(t.stop(),this._animatables.splice(e,1),--e)}for(let e=0;e<this._targetedAnimations.length;e++){let t=this._targetedAnimations[e];this.mask.retainsTarget(t.target.name)||(this._targetedAnimations.splice(e,1),--e)}}}get from(){return this._from}set from(e){if(this._from!==e){this._from=e;for(let t=0;t<this._animatables.length;t++){let i=this._animatables[t];i.fromFrame=this._from}}}get to(){return this._to}set to(e){if(this._to!==e){this._to=e;for(let t=0;t<this._animatables.length;t++){let i=this._animatables[t];i.toFrame=this._to}}}get isStarted(){return this._isStarted}get isPlaying(){return this._isStarted&&!this._isPaused}get speedRatio(){return this._speedRatio}set speedRatio(e){if(this._speedRatio!==e){this._speedRatio=e;for(let t=0;t<this._animatables.length;t++){let i=this._animatables[t];i.speedRatio=this._speedRatio}}}get loopAnimation(){return this._loopAnimation}set loopAnimation(e){if(this._loopAnimation!==e){this._loopAnimation=e;for(let t=0;t<this._animatables.length;t++){let i=this._animatables[t];i.loopAnimation=this._loopAnimation}}}get isAdditive(){return this._isAdditive}set isAdditive(e){if(this._isAdditive!==e){this._isAdditive=e;for(let t=0;t<this._animatables.length;t++){let i=this._animatables[t];i.isAdditive=this._isAdditive}}}get weight(){return this._weight}set weight(e){this._weight!==e&&(this._weight=e,this.setWeightForAllAnimatables(this._weight))}get targetedAnimations(){return this._targetedAnimations}get animatables(){return this._animatables}get children(){return this._targetedAnimations}get playOrder(){return this._playOrder}set playOrder(e){if(this._playOrder!==e&&(this._playOrder=e,this._animatables.length>0)){for(let t=0;t<this._animatables.length;t++)this._animatables[t].playOrder=this._playOrder;this._scene.sortActiveAnimatables()}}get enableBlending(){return this._enableBlending}set enableBlending(e){if(this._enableBlending!==e&&(this._enableBlending=e,e!==null))for(let t=0;t<this._targetedAnimations.length;++t)this._targetedAnimations[t].animation.enableBlending=e}get blendingSpeed(){return this._blendingSpeed}set blendingSpeed(e){if(this._blendingSpeed!==e&&(this._blendingSpeed=e,e!==null))for(let t=0;t<this._targetedAnimations.length;++t)this._targetedAnimations[t].animation.blendingSpeed=e}getLength(e,t){e=e??this._from,t=t??this._to;let i=this.targetedAnimations[0].animation.framePerSecond*this._speedRatio;return(t-e)/i}static MergeAnimationGroups(e,t=!0,i=!1,r){if(e.length===0)return null;r=r??e[0].weight;let n=Number.MAX_VALUE,a=-Number.MAX_VALUE;if(i)for(let l of e)l.from<n&&(n=l.from),l.to>a&&(a=l.to);let o=new s(e[0].name+"_merged",e[0]._scene,r);for(let l of e){i&&l.normalize(n,a);for(let c of l.targetedAnimations)o.addTargetedAnimation(c.animation,c.target);t&&l.dispose()}return o}getScene(){return this._scene}constructor(e,t=null,i=-1,r=0){this.name=e,this._targetedAnimations=new Array,this._animatables=new Array,this._from=Number.MAX_VALUE,this._to=-Number.MAX_VALUE,this._speedRatio=1,this._loopAnimation=!1,this._isAdditive=!1,this._weight=-1,this._playOrder=0,this._enableBlending=null,this._blendingSpeed=null,this._numActiveAnimatables=0,this._shouldStart=!0,this._parentContainer=null,this.onAnimationEndObservable=new N,this.onAnimationLoopObservable=new N,this.onAnimationGroupLoopObservable=new N,this.onAnimationGroupEndObservable=new N,this.onAnimationGroupPauseObservable=new N,this.onAnimationGroupPlayObservable=new N,this.metadata=null,this._mask=null,this._animationLoopFlags=[],this._scene=t||Z.LastCreatedScene,this._weight=i,this._playOrder=r,this.uniqueId=this._scene.getUniqueId(),this._scene.addAnimationGroup(this)}addTargetedAnimation(e,t){let i=new _g(this);i.animation=e,i.target=t;let r=e.getKeys();return this._from>r[0].frame&&(this._from=r[0].frame),this._to<r[r.length-1].frame&&(this._to=r[r.length-1].frame),this._enableBlending!==null&&(e.enableBlending=this._enableBlending),this._blendingSpeed!==null&&(e.blendingSpeed=this._blendingSpeed),this._targetedAnimations.push(i),this._shouldStart=!0,i}removeTargetedAnimation(e){for(let t=this._targetedAnimations.length-1;t>-1;t--)this._targetedAnimations[t].animation===e&&this._targetedAnimations.splice(t,1)}normalize(e=null,t=null){e==null&&(e=this._from),t==null&&(t=this._to);for(let i=0;i<this._targetedAnimations.length;i++){let n=this._targetedAnimations[i].animation.getKeys(),a=n[0],o=n[n.length-1];if(a.frame>e){let l={frame:e,value:a.value,inTangent:a.inTangent,outTangent:a.outTangent,interpolation:a.interpolation};n.splice(0,0,l)}if(o.frame<t){let l={frame:t,value:o.value,inTangent:o.inTangent,outTangent:o.outTangent,interpolation:o.interpolation};n.push(l)}}return this._from=e,this._to=t,this}_processLoop(e,t,i){e.onAnimationLoop=()=>{this.onAnimationLoopObservable.notifyObservers(t),!this._animationLoopFlags[i]&&(this._animationLoopFlags[i]=!0,this._animationLoopCount++,this._animationLoopCount===this._numActiveAnimatables&&(this.onAnimationGroupLoopObservable.notifyObservers(this),this._animationLoopCount=0,this._animationLoopFlags.length=0))}}start(e=!1,t=1,i,r,n){if(this._isStarted||this._targetedAnimations.length===0)return this;this._loopAnimation=e,this._shouldStart=!1,this._animationLoopCount=0,this._animationLoopFlags.length=0;for(let a=0;a<this._targetedAnimations.length;a++){let o=this._targetedAnimations[a],l=this._scene.beginDirectAnimation(o.target,[o.animation],i!==void 0?i:this._from,r!==void 0?r:this._to,e,t,void 0,void 0,n!==void 0?n:this._isAdditive);l.weight=this._weight,l.playOrder=this._playOrder,l.onAnimationEnd=()=>{this.onAnimationEndObservable.notifyObservers(o),this._checkAnimationGroupEnded(l)},this._processLoop(l,o,a),this._animatables.push(l)}return this.syncWithMask(),this._scene.sortActiveAnimatables(),this._speedRatio=t,this._isStarted=!0,this._isPaused=!1,this.onAnimationGroupPlayObservable.notifyObservers(this),this}pause(){if(!this._isStarted)return this;this._isPaused=!0;for(let e=0;e<this._animatables.length;e++)this._animatables[e].pause();return this.onAnimationGroupPauseObservable.notifyObservers(this),this}play(e){return this.isStarted&&this._animatables.length&&!this._shouldStart?(e!==void 0&&(this.loopAnimation=e),this.restart()):(this.stop(),this.start(e,this._speedRatio)),this}reset(){if(!this._isStarted)return this.play(),this.goToFrame(0),this.stop(!0),this;for(let e=0;e<this._animatables.length;e++)this._animatables[e].reset();return this}restart(){if(!this._isStarted)return this;for(let e=0;e<this._animatables.length;e++)this._animatables[e].restart();return this.syncWithMask(),this._isPaused=!1,this.onAnimationGroupPlayObservable.notifyObservers(this),this}stop(e=!1){if(!this._isStarted)return this;let t=this._animatables.slice();for(let r=0;r<t.length;r++)t[r].stop(void 0,void 0,!0,e);let i=0;for(let r=0;r<this._scene._activeAnimatables.length;r++){let n=this._scene._activeAnimatables[r];n._runtimeAnimations.length>0?this._scene._activeAnimatables[i++]=n:e&&this._checkAnimationGroupEnded(n,e)}return this._scene._activeAnimatables.length=i,this._isStarted=!1,this}setWeightForAllAnimatables(e){for(let t=0;t<this._animatables.length;t++){let i=this._animatables[t];i.weight=e}return this}syncAllAnimationsWith(e){for(let t=0;t<this._animatables.length;t++)this._animatables[t].syncWith(e);return this}goToFrame(e,t=!1){if(!this._isStarted)return this;for(let i=0;i<this._animatables.length;i++)this._animatables[i].goToFrame(e,t);return this}getCurrentFrame(){return this.animatables[0]?.masterFrame||0}dispose(){this.isStarted&&this.stop(),this._targetedAnimations.length=0,this._animatables.length=0;let e=this._scene.animationGroups.indexOf(this);if(e>-1&&this._scene.animationGroups.splice(e,1),this._parentContainer){let t=this._parentContainer.animationGroups.indexOf(this);t>-1&&this._parentContainer.animationGroups.splice(t,1),this._parentContainer=null}this.onAnimationEndObservable.clear(),this.onAnimationGroupEndObservable.clear(),this.onAnimationGroupPauseObservable.clear(),this.onAnimationGroupPlayObservable.clear(),this.onAnimationLoopObservable.clear(),this.onAnimationGroupLoopObservable.clear()}_checkAnimationGroupEnded(e,t=!1){let i=this._animatables.indexOf(e);i>-1&&this._animatables.splice(i,1),this._animatables.length===this._targetedAnimations.length-this._numActiveAnimatables&&(this._isStarted=!1,t||this.onAnimationGroupEndObservable.notifyObservers(this),this._animatables.length=0)}clone(e,t,i=!1){let r=new s(e||this.name,this._scene,this._weight,this._playOrder);r._from=this.from,r._to=this.to,r._speedRatio=this.speedRatio,r._loopAnimation=this.loopAnimation,r._isAdditive=this.isAdditive,r._enableBlending=this.enableBlending,r._blendingSpeed=this.blendingSpeed,r.metadata=this.metadata,r.mask=this.mask;for(let n of this._targetedAnimations)r.addTargetedAnimation(i?n.animation.clone():n.animation,t?t(n.target):n.target);return r}serialize(){let e={};e.name=this.name,e.from=this.from,e.to=this.to,e.speedRatio=this.speedRatio,e.loopAnimation=this.loopAnimation,e.isAdditive=this.isAdditive,e.weight=this.weight,e.playOrder=this.playOrder,e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed,e.targetedAnimations=[];for(let t=0;t<this.targetedAnimations.length;t++){let i=this.targetedAnimations[t];e.targetedAnimations[t]=i.serialize()}return st&&st.HasTags(this)&&(e.tags=st.GetTags(this)),this.metadata&&(e.metadata=this.metadata),e}static Parse(e,t,i){let r=new s(e.name,t,e.weight,e.playOrder);for(let n=0;n<e.targetedAnimations.length;n++){let a=e.targetedAnimations[n],o=q.Parse(a.animation),l=a.targetId;if(a.animation.property==="influence"){let c=t.getMorphTargetById(l);c&&r.addTargetedAnimation(o,c)}else{let c=i?i.get(l):t.getNodeById(l);c!=null&&r.addTargetedAnimation(o,c)}}return st&&st.AddTagsTo(r,e.tags),e.from!==null&&e.to!==null&&r.normalize(e.from,e.to),e.speedRatio!==void 0&&(r._speedRatio=e.speedRatio),e.loopAnimation!==void 0&&(r._loopAnimation=e.loopAnimation),e.isAdditive!==void 0&&(r._isAdditive=e.isAdditive),e.weight!==void 0&&(r._weight=e.weight),e.playOrder!==void 0&&(r._playOrder=e.playOrder),e.enableBlending!==void 0&&(r._enableBlending=e.enableBlending),e.blendingSpeed!==void 0&&(r._blendingSpeed=e.blendingSpeed),e.metadata!==void 0&&(r.metadata=e.metadata),r}static MakeAnimationAdditive(e,t,i,r=!1,n){let a;typeof t=="object"?a=t:a={referenceFrame:t,range:i,cloneOriginalAnimationGroup:r,clonedAnimationName:n};let o=e;a.cloneOriginalAnimationGroup&&(o=e.clone(a.clonedAnimationGroupName||o.name));let l=o.targetedAnimations;for(let c=0;c<l.length;c++){let f=l[c];f.animation=q.MakeAnimationAdditive(f.animation,a)}if(o.isAdditive=!0,a.clipKeys){let c=Number.MAX_VALUE,f=-Number.MAX_VALUE,h=o.targetedAnimations;for(let u=0;u<h.length;u++){let m=h[u].animation.getKeys();c>m[0].frame&&(c=m[0].frame),f<m[m.length-1].frame&&(f=m[m.length-1].frame)}o._from=c,o._to=f}return o}static ClipKeys(e,t,i,r,n){let a=e.clone(r||e.name);return s.ClipKeysInPlace(a,t,i,n)}static ClipKeysInPlace(e,t,i,r){return s.ClipInPlace(e,t,i,r,!1)}static ClipFrames(e,t,i,r,n){let a=e.clone(r||e.name);return s.ClipFramesInPlace(a,t,i,n)}static ClipFramesInPlace(e,t,i,r){return s.ClipInPlace(e,t,i,r,!0)}static ClipInPlace(e,t,i,r,n=!1){let a=Number.MAX_VALUE,o=-Number.MAX_VALUE,l=e.targetedAnimations;for(let c=0;c<l.length;c++){let f=l[c],h=r?f.animation:f.animation.clone();n&&(h.createKeyForFrame(t),h.createKeyForFrame(i));let u=h.getKeys(),d=[],p=Number.MAX_VALUE;for(let m=0;m<u.length;m++){let _=u[m];if(!n&&m>=t&&m<=i||n&&_.frame>=t&&_.frame<=i){let v={frame:_.frame,value:_.value.clone?_.value.clone():_.value,inTangent:_.inTangent,outTangent:_.outTangent,interpolation:_.interpolation,lockedTangent:_.lockedTangent};p===Number.MAX_VALUE&&(p=v.frame),v.frame-=p,d.push(v)}}if(d.length===0){l.splice(c,1),c--;continue}a>d[0].frame&&(a=d[0].frame),o<d[d.length-1].frame&&(o=d[d.length-1].frame),h.setKeys(d,!0),f.animation=h}return e._from=a,e._to=o,e}getClassName(){return"AnimationGroup"}toString(e){let t="Name: "+this.name;return t+=", type: "+this.getClassName(),e&&(t+=", from: "+this._from,t+=", to: "+this._to,t+=", isStarted: "+this._isStarted,t+=", speedRatio: "+this._speedRatio,t+=", targetedAnimations length: "+this._targetedAnimations.length,t+=", animatables length: "+this._animatables),t}}});var mk={};V(mk,{AnimationPropertyInfo:()=>Ja,TransformNodeAnimationPropertyInfo:()=>kf,WeightAnimationPropertyInfo:()=>gg,getQuaternion:()=>dk,getVector3:()=>ly,getWeights:()=>pk});function ly(s,e,t,i){return E.FromArray(e,t).scaleInPlace(i)}function dk(s,e,t,i){return K.FromArray(e,t).scaleInPlace(i)}function pk(s,e,t,i){let r=new Array(s._numMorphTargets);for(let n=0;n<r.length;n++)r[n]=e[t++]*i;return r}var Ja,kf,gg,cy=S(()=>{ws();ie();Za();Ja=class{constructor(e,t,i,r){this.type=e,this.name=t,this.getValue=i,this.getStride=r}_buildAnimation(e,t,i){let r=new q(e,this.name,t,this.type);return r.setKeys(i),r}},kf=class extends Ja{buildAnimations(e,t,i,r){let n=[];return n.push({babylonAnimatable:e._babylonTransformNode,babylonAnimation:this._buildAnimation(t,i,r)}),n}},gg=class extends Ja{buildAnimations(e,t,i,r){let n=[];if(e._numMorphTargets)for(let a=0;a<e._numMorphTargets;a++){let o=new q(`${t}_${a}`,this.name,i,this.type);if(o.setKeys(r.map(l=>({frame:l.frame,inTangent:l.inTangent?l.inTangent[a]:void 0,value:l.value[a],outTangent:l.outTangent?l.outTangent[a]:void 0,interpolation:l.interpolation}))),e._primitiveBabylonMeshes){for(let l of e._primitiveBabylonMeshes)if(l.morphTargetManager){let c=l.morphTargetManager.getTarget(a),f=o.clone();c.animations.push(f),n.push({babylonAnimatable:c,babylonAnimation:f})}}}return n}};ae("/nodes/{}/translation",[new kf(q.ANIMATIONTYPE_VECTOR3,"position",ly,()=>3)]);ae("/nodes/{}/rotation",[new kf(q.ANIMATIONTYPE_QUATERNION,"rotationQuaternion",dk,()=>4)]);ae("/nodes/{}/scale",[new kf(q.ANIMATIONTYPE_VECTOR3,"scaling",ly,()=>3)]);ae("/nodes/{}/weights",[new gg(q.ANIMATIONTYPE_FLOAT,"influence",pk,s=>s._numMorphTargets)])});var _k={};V(_k,{ArrayItem:()=>ve,GLTFFileLoader:()=>ja,GLTFLoader:()=>Pe,LoadBoundingInfoFromPositionAccessor:()=>vg});function vg(s){if(s.min&&s.max){let e=s.min,t=s.max,i=w.Vector3[0].copyFromFloats(e[0],e[1],e[2]),r=w.Vector3[1].copyFromFloats(t[0],t[1],t[2]);if(s.normalized&&s.componentType!==5126){let n=1;switch(s.componentType){case 5120:n=127;break;case 5121:n=255;break;case 5122:n=32767;break;case 5123:n=65535;break}let a=1/n;i.scaleInPlace(a),r.scaleInPlace(a)}return new Ei(i,r)}return null}var vte,Ste,ve,Pe,Nt=S(()=>{Pu();ie();it();$e();Vn();$V();ku();ey();cs();Li();Ut();lu();yt();ou();Ef();Ki();ty();tk();ak();To();Ee();Pl();mt();Za();UI();Nc();lk();vte=new Xu(()=>Promise.resolve().then(()=>(oy(),uk))),Ste=new Xu(()=>Promise.resolve().then(()=>(cy(),mk))),ve=class{static Get(e,t,i){if(!t||i==null||!t[i])throw new Error(`${e}: Failed to find index (${i})`);return t[i]}static TryGet(e,t){return!e||t==null||!e[t]?null:e[t]}static Assign(e){if(e)for(let t=0;t<e.length;t++)e[t].index=t}};Pe=class s{static RegisterExtension(e,t){te(e,!1,t)}static UnregisterExtension(e){return Ce(e)}get gltf(){if(!this._gltf)throw new Error("glTF JSON is not available");return this._gltf}get bin(){return this._bin}get parent(){return this._parent}get babylonScene(){if(!this._babylonScene)throw new Error("Scene is not available");return this._babylonScene}get rootBabylonMesh(){return this._rootBabylonMesh}get rootUrl(){return this._rootUrl}constructor(e){this._completePromises=new Array,this._assetContainer=null,this._babylonLights=[],this._disableInstancedMesh=0,this._allMaterialsDirtyRequired=!1,this._skipStartAnimationStep=!1,this._extensions=new Array,this._disposed=!1,this._rootUrl=null,this._fileName=null,this._uniqueRootUrl=null,this._bin=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions=new Array,this._parent=e}dispose(){this._disposed||(this._disposed=!0,this._completePromises.length=0,this._extensions.forEach(e=>e.dispose&&e.dispose()),this._extensions.length=0,this._gltf=null,this._bin=null,this._babylonScene=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions.length=0,this._parent.dispose())}async importMeshAsync(e,t,i,r,n,a,o=""){return await Promise.resolve().then(async()=>{this._babylonScene=t,this._assetContainer=i,this._loadData(r);let l=null;if(e){let c={};if(this._gltf.nodes)for(let h of this._gltf.nodes)h.name&&(c[h.name]=h.index);l=(e instanceof Array?e:[e]).map(h=>{let u=c[h];if(u===void 0)throw new Error(`Failed to find node '${h}'`);return u})}return await this._loadAsync(n,o,l,()=>({meshes:this._getMeshes(),particleSystems:[],skeletons:this._getSkeletons(),animationGroups:this._getAnimationGroups(),lights:this._babylonLights,transformNodes:this._getTransformNodes(),geometries:this._getGeometries(),spriteManagers:[]}))})}async loadAsync(e,t,i,r,n=""){return this._babylonScene=e,this._loadData(t),await this._loadAsync(i,n,null,()=>{})}async _loadAsync(e,t,i,r){return await Promise.resolve().then(async()=>{this._rootUrl=e,this._uniqueRootUrl=!e.startsWith("file:")&&t?e:`${e}${Date.now()}/`,this._fileName=t,this._allMaterialsDirtyRequired=!1,await this._loadExtensionsAsync();let n=`${Mr[Mr.LOADING]} => ${Mr[Mr.READY]}`,a=`${Mr[Mr.LOADING]} => ${Mr[Mr.COMPLETE]}`;this._parent._startPerformanceCounter(n),this._parent._startPerformanceCounter(a),this._parent._setState(Mr.LOADING),this._extensionsOnLoading();let o=new Array,l=this._babylonScene.blockMaterialDirtyMechanism;if(this._babylonScene.blockMaterialDirtyMechanism=!0,!this.parent.loadOnlyMaterials){if(i)o.push(this.loadSceneAsync("/nodes",{nodes:i,index:-1}));else if(this._gltf.scene!=null||this._gltf.scenes&&this._gltf.scenes[0]){let f=ve.Get("/scene",this._gltf.scenes,this._gltf.scene||0);o.push(this.loadSceneAsync(`/scenes/${f.index}`,f))}}if(!this.parent.skipMaterials&&this.parent.loadAllMaterials&&this._gltf.materials)for(let f=0;f<this._gltf.materials.length;++f){let h=this._gltf.materials[f],u="/materials/"+f,d=Q.TriangleFillMode;o.push(this._loadMaterialAsync(u,h,null,d,()=>{}))}return this._allMaterialsDirtyRequired?this._babylonScene.blockMaterialDirtyMechanism=l:this._babylonScene._forceBlockMaterialDirtyMechanism(l),this._parent.compileMaterials&&o.push(this._compileMaterialsAsync()),this._parent.compileShadowGenerators&&o.push(this._compileShadowGeneratorsAsync()),await Promise.all(o).then(()=>{this._rootBabylonMesh&&this._rootBabylonMesh!==this._parent.customRootNode&&this._rootBabylonMesh.setEnabled(!0);for(let f of this._babylonScene.materials){let h=f;h.maxSimultaneousLights!==void 0&&(h.maxSimultaneousLights=Math.max(h.maxSimultaneousLights,this._babylonScene.lights.length))}return this._extensionsOnReady(),this._parent._setState(Mr.READY),this._skipStartAnimationStep||this._startAnimations(),r()}).then(f=>(this._parent._endPerformanceCounter(n),W.SetImmediate(()=>{this._disposed||Promise.all(this._completePromises).then(()=>{this._parent._endPerformanceCounter(a),this._parent._setState(Mr.COMPLETE),this._parent.onCompleteObservable.notifyObservers(void 0),this._parent.onCompleteObservable.clear(),this.dispose()},h=>{this._parent.onErrorObservable.notifyObservers(h),this._parent.onErrorObservable.clear(),this.dispose()})}),f))}).catch(n=>{throw this._disposed||(this._parent.onErrorObservable.notifyObservers(n),this._parent.onErrorObservable.clear(),this.dispose()),n})}_loadData(e){if(this._gltf=e.json,this._setupData(),e.bin){let t=this._gltf.buffers;if(t&&t[0]&&!t[0].uri){let i=t[0];(i.byteLength<e.bin.byteLength-3||i.byteLength>e.bin.byteLength)&&P.Warn(`Binary buffer length (${i.byteLength}) from JSON does not match chunk length (${e.bin.byteLength})`),this._bin=e.bin}else P.Warn("Unexpected BIN chunk")}}_setupData(){if(ve.Assign(this._gltf.accessors),ve.Assign(this._gltf.animations),ve.Assign(this._gltf.buffers),ve.Assign(this._gltf.bufferViews),ve.Assign(this._gltf.cameras),ve.Assign(this._gltf.images),ve.Assign(this._gltf.materials),ve.Assign(this._gltf.meshes),ve.Assign(this._gltf.nodes),ve.Assign(this._gltf.samplers),ve.Assign(this._gltf.scenes),ve.Assign(this._gltf.skins),ve.Assign(this._gltf.textures),this._gltf.nodes){let e={};for(let i of this._gltf.nodes)if(i.children)for(let r of i.children)e[r]=i.index;let t=this._createRootNode();for(let i of this._gltf.nodes){let r=e[i.index];i.parent=r===void 0?t:this._gltf.nodes[r]}}}async _loadExtensionsAsync(){let e=[];if(HV.forEach((t,i)=>{this.parent.extensionOptions[i]?.enabled===!1?t.isGLTFExtension&&this.isExtensionUsed(i)&&P.Warn(`Extension ${i} is used but has been explicitly disabled.`):(!t.isGLTFExtension||this.isExtensionUsed(i))&&e.push((async()=>{let r=await t.factory(this);return r.name!==i&&P.Warn(`The name of the glTF loader extension instance does not match the registered name: ${r.name} !== ${i}`),this._parent.onExtensionLoadedObservable.notifyObservers(r),r})())}),this._extensions.push(...await Promise.all(e)),this._extensions.sort((t,i)=>(t.order||Number.MAX_VALUE)-(i.order||Number.MAX_VALUE)),this._parent.onExtensionLoadedObservable.clear(),this._gltf.extensionsRequired){for(let t of this._gltf.extensionsRequired)if(!this._extensions.some(r=>r.name===t&&r.enabled))throw this.parent.extensionOptions[t]?.enabled===!1?new Error(`Required extension ${t} is disabled`):new Error(`Required extension ${t} is not available`)}}_createRootNode(){if(this._parent.customRootNode!==void 0)return this._rootBabylonMesh=this._parent.customRootNode,{_babylonTransformNode:this._rootBabylonMesh===null?void 0:this._rootBabylonMesh,index:-1};this._babylonScene._blockEntityCollection=!!this._assetContainer;let e=new fe("__root__",this._babylonScene);this._rootBabylonMesh=e,this._rootBabylonMesh._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._rootBabylonMesh.setEnabled(!1);let t={_babylonTransformNode:this._rootBabylonMesh,index:-1};switch(this._parent.coordinateSystemMode){case Vf.AUTO:{this._babylonScene.useRightHandedSystem||(t.rotation=[0,1,0,0],t.scale=[1,1,-1],s._LoadTransform(t,this._rootBabylonMesh));break}case Vf.FORCE_RIGHT_HANDED:{this._babylonScene.useRightHandedSystem=!0;break}default:throw new Error(`Invalid coordinate system mode (${this._parent.coordinateSystemMode})`)}return this._parent.onMeshLoadedObservable.notifyObservers(e),t}loadSceneAsync(e,t){let i=this._extensionsLoadSceneAsync(e,t);if(i)return i;let r=new Array;if(this.logOpen(`${e} ${t.name||""}`),t.nodes)for(let n of t.nodes){let a=ve.Get(`${e}/nodes/${n}`,this._gltf.nodes,n);r.push(this.loadNodeAsync(`/nodes/${a.index}`,a,o=>{o.parent=this._rootBabylonMesh}))}for(let n of this._postSceneLoadActions)n();return r.push(this._loadAnimationsAsync()),this.logClose(),Promise.all(r).then(()=>{})}_forEachPrimitive(e,t){if(e._primitiveBabylonMeshes)for(let i of e._primitiveBabylonMeshes)t(i)}_getGeometries(){let e=[],t=this._gltf.nodes;if(t)for(let i of t)this._forEachPrimitive(i,r=>{let n=r.geometry;n&&e.indexOf(n)===-1&&e.push(n)});return e}_getMeshes(){let e=[];this._rootBabylonMesh instanceof Ct&&e.push(this._rootBabylonMesh);let t=this._gltf.nodes;if(t)for(let i of t)this._forEachPrimitive(i,r=>{e.push(r)});return e}_getTransformNodes(){let e=[],t=this._gltf.nodes;if(t)for(let i of t)i._babylonTransformNode&&i._babylonTransformNode.getClassName()==="TransformNode"&&e.push(i._babylonTransformNode),i._babylonTransformNodeForSkin&&e.push(i._babylonTransformNodeForSkin);return e}_getSkeletons(){let e=[],t=this._gltf.skins;if(t)for(let i of t)i._data&&e.push(i._data.babylonSkeleton);return e}_getAnimationGroups(){let e=[],t=this._gltf.animations;if(t)for(let i of t)i._babylonAnimationGroup&&e.push(i._babylonAnimationGroup);return e}_startAnimations(){switch(this._parent.animationStartMode){case Ql.NONE:break;case Ql.FIRST:{let e=this._getAnimationGroups();e.length!==0&&e[0].start(!0);break}case Ql.ALL:{let e=this._getAnimationGroups();for(let t of e)t.start(!0);break}default:{P.Error(`Invalid animation start mode (${this._parent.animationStartMode})`);return}}}loadNodeAsync(e,t,i=()=>{}){let r=this._extensionsLoadNodeAsync(e,t,i);if(r)return r;if(t._babylonTransformNode)throw new Error(`${e}: Invalid recursive node hierarchy`);let n=new Array;this.logOpen(`${e} ${t.name||""}`);let a=c=>{if(s.AddPointerMetadata(c,e),s._LoadTransform(t,c),t.camera!=null){let f=ve.Get(`${e}/camera`,this._gltf.cameras,t.camera);n.push(this.loadCameraAsync(`/cameras/${f.index}`,f,h=>{h.parent=c,this._babylonScene.useRightHandedSystem||(c.scaling.x=-1)}))}if(t.children)for(let f of t.children){let h=ve.Get(`${e}/children/${f}`,this._gltf.nodes,f);n.push(this.loadNodeAsync(`/nodes/${h.index}`,h,u=>{u.parent=c}))}i(c)},o=t.mesh!=null,l=this._parent.loadSkins&&t.skin!=null;if(!o||l){let c=t.name||`node${t.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;let f=new dt(c,this._babylonScene);f._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t.mesh==null?t._babylonTransformNode=f:t._babylonTransformNodeForSkin=f,a(f)}if(o)if(l){let c=ve.Get(`${e}/mesh`,this._gltf.meshes,t.mesh);n.push(this._loadMeshAsync(`/meshes/${c.index}`,t,c,f=>{let h=t._babylonTransformNodeForSkin;f.metadata=Du(h.metadata,f.metadata||{});let u=ve.Get(`${e}/skin`,this._gltf.skins,t.skin);n.push(this._loadSkinAsync(`/skins/${u.index}`,t,u,d=>{this._forEachPrimitive(t,p=>{p.skeleton=d}),this._postSceneLoadActions.push(()=>{if(u.skeleton!=null){let p=ve.Get(`/skins/${u.index}/skeleton`,this._gltf.nodes,u.skeleton).parent;t.index===p.index?f.parent=h.parent:f.parent=p._babylonTransformNode}else f.parent=this._rootBabylonMesh;this._parent.onSkinLoadedObservable.notifyObservers({node:h,skinnedNode:f})})}))}))}else{let c=ve.Get(`${e}/mesh`,this._gltf.meshes,t.mesh);n.push(this._loadMeshAsync(`/meshes/${c.index}`,t,c,a))}return this.logClose(),Promise.all(n).then(()=>(this._forEachPrimitive(t,c=>{let f=c;!f.isAnInstance&&f.geometry&&f.geometry.useBoundingInfoFromGeometry?c._updateBoundingInfo():c.refreshBoundingInfo(!0,!0)}),t._babylonTransformNode))}_loadMeshAsync(e,t,i,r){let n=i.primitives;if(!n||!n.length)throw new Error(`${e}: Primitives are missing`);n[0].index==null&&ve.Assign(n);let a=new Array;this.logOpen(`${e} ${i.name||""}`);let o=t.name||`node${t.index}`;if(n.length===1){let l=i.primitives[0];a.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${l.index}`,o,t,i,l,c=>{t._babylonTransformNode=c,t._primitiveBabylonMeshes=[c]}))}else{this._babylonScene._blockEntityCollection=!!this._assetContainer,t._babylonTransformNode=new dt(o,this._babylonScene),t._babylonTransformNode._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._primitiveBabylonMeshes=[];for(let l of n)a.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${l.index}`,`${o}_primitive${l.index}`,t,i,l,c=>{c.parent=t._babylonTransformNode,t._primitiveBabylonMeshes.push(c)}))}return r(t._babylonTransformNode),this.logClose(),Promise.all(a).then(()=>t._babylonTransformNode)}_loadMeshPrimitiveAsync(e,t,i,r,n,a){let o=this._extensionsLoadMeshPrimitiveAsync(e,t,i,r,n,a);if(o)return o;this.logOpen(`${e}`);let l=this._disableInstancedMesh===0&&this._parent.createInstances&&i.skin==null&&!r.primitives[0].targets,c,f;if(l&&n._instanceData)this._babylonScene._blockEntityCollection=!!this._assetContainer,c=n._instanceData.babylonSourceMesh.createInstance(t),c._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,f=n._instanceData.promise;else{let h=new Array;this._babylonScene._blockEntityCollection=!!this._assetContainer;let u=new fe(t,this._babylonScene);u._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,u.sideOrientation=this._babylonScene.useRightHandedSystem?Q.CounterClockWiseSideOrientation:Q.ClockWiseSideOrientation,this._createMorphTargets(e,i,r,n,u),h.push(this._loadVertexDataAsync(e,n,u).then(async p=>await this._loadMorphTargetsAsync(e,n,u,p).then(()=>{this._disposed||(this._babylonScene._blockEntityCollection=!!this._assetContainer,p.applyToMesh(u),p._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1)})));let d=s._GetDrawMode(e,n.mode);if(n.material==null){let p=this._defaultBabylonMaterialData[d];p||(p=this._createDefaultMaterial("__GLTFLoader._default",d),this._parent.onMaterialLoadedObservable.notifyObservers(p),this._defaultBabylonMaterialData[d]=p),u.material=p}else if(!this.parent.skipMaterials){let p=ve.Get(`${e}/material`,this._gltf.materials,n.material);h.push(this._loadMaterialAsync(`/materials/${p.index}`,p,u,d,m=>{u.material=m}))}f=Promise.all(h),l&&(n._instanceData={babylonSourceMesh:u,promise:f}),c=u}return s.AddPointerMetadata(c,e),this._parent.onMeshLoadedObservable.notifyObservers(c),a(c),this.logClose(),f.then(()=>c)}_loadVertexDataAsync(e,t,i){let r=this._extensionsLoadVertexDataAsync(e,t,i);if(r)return r;let n=t.attributes;if(!n)throw new Error(`${e}: Attributes are missing`);let a=new Array,o=new mi(i.name,this._babylonScene);if(t.indices==null)i.isUnIndexed=!0;else{let c=ve.Get(`${e}/indices`,this._gltf.accessors,t.indices);a.push(this._loadIndicesAccessorAsync(`/accessors/${c.index}`,c).then(f=>{o.setIndices(f)}))}let l=(c,f,h)=>{if(n[c]==null)return;i._delayInfo=i._delayInfo||[],i._delayInfo.indexOf(f)===-1&&i._delayInfo.push(f);let u=ve.Get(`${e}/attributes/${c}`,this._gltf.accessors,n[c]);a.push(this._loadVertexAccessorAsync(`/accessors/${u.index}`,u,f).then(d=>{if(d.getKind()===A.PositionKind&&!this.parent.alwaysComputeBoundingBox&&!i.skeleton){let p=vg(u);p&&(o._boundingInfo=p,o.useBoundingInfoFromGeometry=!0)}o.setVerticesBuffer(d,u.count)})),f==A.MatricesIndicesExtraKind&&(i.numBoneInfluencers=8),h&&h(u)};return l("POSITION",A.PositionKind),l("NORMAL",A.NormalKind),l("TANGENT",A.TangentKind),l("TEXCOORD_0",A.UVKind),l("TEXCOORD_1",A.UV2Kind),l("TEXCOORD_2",A.UV3Kind),l("TEXCOORD_3",A.UV4Kind),l("TEXCOORD_4",A.UV5Kind),l("TEXCOORD_5",A.UV6Kind),l("JOINTS_0",A.MatricesIndicesKind),l("WEIGHTS_0",A.MatricesWeightsKind),l("JOINTS_1",A.MatricesIndicesExtraKind),l("WEIGHTS_1",A.MatricesWeightsExtraKind),l("COLOR_0",A.ColorKind,c=>{c.type==="VEC4"&&(i.hasVertexAlpha=!0)}),Promise.all(a).then(()=>o)}_createMorphTargets(e,t,i,r,n){if(!r.targets||!this._parent.loadMorphTargets)return;if(t._numMorphTargets==null)t._numMorphTargets=r.targets.length;else if(r.targets.length!==t._numMorphTargets)throw new Error(`${e}: Primitives do not have the same number of targets`);let a=i.extras?i.extras.targetNames:null;this._babylonScene._blockEntityCollection=!!this._assetContainer,n.morphTargetManager=new Yl(this._babylonScene),n.morphTargetManager._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,n.morphTargetManager.areUpdatesFrozen=!0;for(let o=0;o<r.targets.length;o++){let l=t.weights?t.weights[o]:i.weights?i.weights[o]:0,c=a?a[o]:`morphTarget${o}`;n.morphTargetManager.addTarget(new Xl(c,l,n.getScene()))}}_loadMorphTargetsAsync(e,t,i,r){if(!t.targets||!this._parent.loadMorphTargets)return Promise.resolve();let n=new Array,a=i.morphTargetManager;for(let o=0;o<a.numTargets;o++){let l=a.getTarget(o);n.push(this._loadMorphTargetVertexDataAsync(`${e}/targets/${o}`,r,t.targets[o],l))}return Promise.all(n).then(()=>{a.areUpdatesFrozen=!1})}async _loadMorphTargetVertexDataAsync(e,t,i,r){let n=new Array,a=(o,l,c)=>{if(i[o]==null)return;let f=t.getVertexBuffer(l);if(!f)return;let h=ve.Get(`${e}/${o}`,this._gltf.accessors,i[o]);n.push(this._loadFloatAccessorAsync(`/accessors/${h.index}`,h).then(u=>{c(f,u)}))};return a("POSITION",A.PositionKind,(o,l)=>{let c=new Float32Array(l.length);o.forEach(l.length,(f,h)=>{c[h]=l[h]+f}),r.setPositions(c)}),a("NORMAL",A.NormalKind,(o,l)=>{let c=new Float32Array(l.length);o.forEach(c.length,(f,h)=>{c[h]=l[h]+f}),r.setNormals(c)}),a("TANGENT",A.TangentKind,(o,l)=>{let c=new Float32Array(l.length/3*4),f=0;o.forEach(l.length/3*4,(h,u)=>{(u+1)%4!==0&&(c[f]=l[f]+h,f++)}),r.setTangents(c)}),a("TEXCOORD_0",A.UVKind,(o,l)=>{let c=new Float32Array(l.length);o.forEach(l.length,(f,h)=>{c[h]=l[h]+f}),r.setUVs(c)}),a("TEXCOORD_1",A.UV2Kind,(o,l)=>{let c=new Float32Array(l.length);o.forEach(l.length,(f,h)=>{c[h]=l[h]+f}),r.setUV2s(c)}),a("COLOR_0",A.ColorKind,(o,l)=>{let c=null,f=o.getSize();if(f===3){c=new Float32Array(l.length/3*4),o.forEach(l.length,(h,u)=>{let d=Math.floor(u/3),p=u%3;c[4*d+p]=l[3*d+p]+h});for(let h=0;h<l.length/3;++h)c[4*h+3]=1}else if(f===4)c=new Float32Array(l.length),o.forEach(l.length,(h,u)=>{c[u]=l[u]+h});else throw new Error(`${e}: Invalid number of components (${f}) for COLOR_0 attribute`);r.setColors(c)}),await Promise.all(n).then(()=>{})}static _LoadTransform(e,t){if(e.skin!=null)return;let i=E.Zero(),r=K.Identity(),n=E.One();e.matrix?B.FromArray(e.matrix).decompose(n,r,i):(e.translation&&(i=E.FromArray(e.translation)),e.rotation&&(r=K.FromArray(e.rotation)),e.scale&&(n=E.FromArray(e.scale))),t.position=i,t.rotationQuaternion=r,t.scaling=n}_loadSkinAsync(e,t,i,r){if(!this._parent.loadSkins)return Promise.resolve();let n=this._extensionsLoadSkinAsync(e,t,i);if(n)return n;if(i._data)return r(i._data.babylonSkeleton),i._data.promise;let a=`skeleton${i.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;let o=new Uf(i.name||a,a,this._babylonScene);o._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._loadBones(e,i,o);let l=this._loadSkinInverseBindMatricesDataAsync(e,i).then(c=>{this._updateBoneMatrices(o,c)});return i._data={babylonSkeleton:o,promise:l},r(o),l}_loadBones(e,t,i){if(t.skeleton==null||this._parent.alwaysComputeSkeletonRootNode){let n=this._findSkeletonRootNode(`${e}/joints`,t.joints);if(n)if(t.skeleton===void 0)t.skeleton=n.index;else{let a=(l,c)=>{for(;c.parent;c=c.parent)if(c.parent===l)return!0;return!1},o=ve.Get(`${e}/skeleton`,this._gltf.nodes,t.skeleton);o!==n&&!a(o,n)&&(P.Warn(`${e}/skeleton: Overriding with nearest common ancestor as skeleton node is not a common root`),t.skeleton=n.index)}else P.Warn(`${e}: Failed to find common root`)}let r={};for(let n of t.joints){let a=ve.Get(`${e}/joints/${n}`,this._gltf.nodes,n);this._loadBone(a,t,i,r)}}_findSkeletonRootNode(e,t){if(t.length===0)return null;let i={};for(let n of t){let a=[],o=ve.Get(`${e}/${n}`,this._gltf.nodes,n);for(;o.index!==-1;)a.unshift(o),o=o.parent;i[n]=a}let r=null;for(let n=0;;++n){let a=i[t[0]];if(n>=a.length)return r;let o=a[n];for(let l=1;l<t.length;++l)if(a=i[t[l]],n>=a.length||o!==a[n])return r;r=o}}_loadBone(e,t,i,r){e._isJoint=!0;let n=r[e.index];if(n)return n;let a=null;e.index!==t.skeleton&&(e.parent&&e.parent.index!==-1?a=this._loadBone(e.parent,t,i,r):t.skeleton!==void 0&&P.Warn(`/skins/${t.index}/skeleton: Skeleton node is not a common root`));let o=t.joints.indexOf(e.index);return n=new Zr(e.name||`joint${e.index}`,i,a,this._getNodeMatrix(e),null,null,o),r[e.index]=n,this._postSceneLoadActions.push(()=>{n.linkTransformNode(e._babylonTransformNode)}),n}_loadSkinInverseBindMatricesDataAsync(e,t){if(t.inverseBindMatrices==null)return Promise.resolve(null);let i=ve.Get(`${e}/inverseBindMatrices`,this._gltf.accessors,t.inverseBindMatrices);return this._loadFloatAccessorAsync(`/accessors/${i.index}`,i)}_updateBoneMatrices(e,t){for(let i of e.bones){let r=B.Identity(),n=i._index;t&&n!==-1&&(B.FromArrayToRef(t,n*16,r),r.invertToRef(r));let a=i.getParent();a&&r.multiplyToRef(a.getAbsoluteInverseBindMatrix(),r),i.updateMatrix(r,!1,!1),i._updateAbsoluteBindMatrices(void 0,!1)}}_getNodeMatrix(e){return e.matrix?B.FromArray(e.matrix):B.Compose(e.scale?E.FromArray(e.scale):E.One(),e.rotation?K.FromArray(e.rotation):K.Identity(),e.translation?E.FromArray(e.translation):E.Zero())}loadCameraAsync(e,t,i=()=>{}){let r=this._extensionsLoadCameraAsync(e,t,i);if(r)return r;let n=new Array;this.logOpen(`${e} ${t.name||""}`),this._babylonScene._blockEntityCollection=!!this._assetContainer;let a=new Qa(t.name||`camera${t.index}`,E.Zero(),this._babylonScene,!1);switch(a._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._babylonCamera=a,a.setTarget(new E(0,0,-1)),t.type){case"perspective":{let o=t.perspective;if(!o)throw new Error(`${e}: Camera perspective properties are missing`);a.fov=o.yfov,a.minZ=o.znear,a.maxZ=o.zfar||0;break}case"orthographic":{if(!t.orthographic)throw new Error(`${e}: Camera orthographic properties are missing`);a.mode=ye.ORTHOGRAPHIC_CAMERA,a.orthoLeft=-t.orthographic.xmag,a.orthoRight=t.orthographic.xmag,a.orthoBottom=-t.orthographic.ymag,a.orthoTop=t.orthographic.ymag,a.minZ=t.orthographic.znear,a.maxZ=t.orthographic.zfar;break}default:throw new Error(`${e}: Invalid camera type (${t.type})`)}return s.AddPointerMetadata(a,e),this._parent.onCameraLoadedObservable.notifyObservers(a),i(a),this.logClose(),Promise.all(n).then(()=>a)}_loadAnimationsAsync(){this._parent._startPerformanceCounter("Load animations");let e=this._gltf.animations;if(!e)return Promise.resolve();let t=new Array;for(let i=0;i<e.length;i++){let r=e[i];t.push(this.loadAnimationAsync(`/animations/${r.index}`,r).then(n=>{n.targetedAnimations.length===0&&n.dispose()}))}return Promise.all(t).then(()=>{this._parent._endPerformanceCounter("Load animations")})}loadAnimationAsync(e,t){this._parent._startPerformanceCounter("Load animation");let i=this._extensionsLoadAnimationAsync(e,t);return i||vte.value.then(({AnimationGroup:r})=>{this._babylonScene._blockEntityCollection=!!this._assetContainer;let n=new r(t.name||`animation${t.index}`,this._babylonScene);n._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._babylonAnimationGroup=n;let a=new Array;ve.Assign(t.channels),ve.Assign(t.samplers);for(let o of t.channels)a.push(this._loadAnimationChannelAsync(`${e}/channels/${o.index}`,e,t,o,(l,c)=>{l.animations=l.animations||[],l.animations.push(c),n.addTargetedAnimation(c,l)}));return this._parent._endPerformanceCounter("Load animation"),Promise.all(a).then(()=>(n.normalize(0),n))})}_loadAnimationChannelAsync(e,t,i,r,n){let a=this._extensionsLoadAnimationChannelAsync(e,t,i,r,n);if(a)return a;if(r.target.node==null)return Promise.resolve();let o=ve.Get(`${e}/target/node`,this._gltf.nodes,r.target.node),l=r.target.path,c=l==="weights";return c&&!o._numMorphTargets||!c&&!o._babylonTransformNode||!this._parent.loadNodeAnimations&&!c&&!o._isJoint?Promise.resolve():Ste.value.then(()=>{let f;switch(l){case"translation":{f=zu("/nodes/{}/translation")?.interpolation;break}case"rotation":{f=zu("/nodes/{}/rotation")?.interpolation;break}case"scale":{f=zu("/nodes/{}/scale")?.interpolation;break}case"weights":{f=zu("/nodes/{}/weights")?.interpolation;break}default:throw new Error(`${e}/target/path: Invalid value (${r.target.path})`)}if(!f)throw new Error(`${e}/target/path: Could not find interpolation properties for target path (${r.target.path})`);let h={object:o,info:f};return this._loadAnimationChannelFromTargetInfoAsync(e,t,i,r,h,n)})}_loadAnimationChannelFromTargetInfoAsync(e,t,i,r,n,a){let o=this.parent.targetFps,l=1/o,c=ve.Get(`${e}/sampler`,i.samplers,r.sampler);return this._loadAnimationSamplerAsync(`${t}/samplers/${r.sampler}`,c).then(f=>{let h=0,u=n.object,d=n.info;for(let p of d){let m=p.getStride(u),_=f.input,v=f.output,T=new Array(_.length),C=0;switch(f.interpolation){case"STEP":{for(let I=0;I<_.length;I++){let R=p.getValue(u,v,C,1);C+=m,T[I]={frame:_[I]*o,value:R,interpolation:1}}break}case"CUBICSPLINE":{for(let I=0;I<_.length;I++){let R=p.getValue(u,v,C,l);C+=m;let b=p.getValue(u,v,C,1);C+=m;let M=p.getValue(u,v,C,l);C+=m,T[I]={frame:_[I]*o,inTangent:R,value:b,outTangent:M}}break}case"LINEAR":{for(let I=0;I<_.length;I++){let R=p.getValue(u,v,C,1);C+=m,T[I]={frame:_[I]*o,value:R}}break}}if(C>0){let I=`${i.name||`animation${i.index}`}_channel${r.index}_${h}`,R=p.buildAnimations(u,I,o,T);for(let b of R)h++,a(b.babylonAnimatable,b.babylonAnimation)}}})}_loadAnimationSamplerAsync(e,t){if(t._data)return t._data;let i=t.interpolation||"LINEAR";switch(i){case"STEP":case"LINEAR":case"CUBICSPLINE":break;default:throw new Error(`${e}/interpolation: Invalid value (${t.interpolation})`)}let r=ve.Get(`${e}/input`,this._gltf.accessors,t.input),n=ve.Get(`${e}/output`,this._gltf.accessors,t.output);return t._data=Promise.all([this._loadFloatAccessorAsync(`/accessors/${r.index}`,r),this._loadFloatAccessorAsync(`/accessors/${n.index}`,n)]).then(([a,o])=>({input:a,interpolation:i,output:o})),t._data}loadBufferAsync(e,t,i,r){let n=this._extensionsLoadBufferAsync(e,t,i,r);if(n)return n;if(!t._data)if(t.uri)t._data=this.loadUriAsync(`${e}/uri`,t,t.uri);else{if(!this._bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);t._data=this._bin.readAsync(0,t.byteLength)}return t._data.then(a=>{try{return new Uint8Array(a.buffer,a.byteOffset+i,r)}catch(o){throw new Error(`${e}: ${o.message}`)}})}loadBufferViewAsync(e,t){let i=this._extensionsLoadBufferViewAsync(e,t);if(i)return i;if(t._data)return t._data;let r=ve.Get(`${e}/buffer`,this._gltf.buffers,t.buffer);return t._data=this.loadBufferAsync(`/buffers/${r.index}`,r,t.byteOffset||0,t.byteLength),t._data}_loadAccessorAsync(e,t,i){if(t._data)return t._data;let r=s._GetNumComponents(e,t.type),n=r*A.GetTypeByteLength(t.componentType),a=r*t.count;if(t.bufferView==null)t._data=Promise.resolve(new i(a));else{let o=ve.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${o.index}`,o).then(l=>{if(t.componentType===5126&&!t.normalized&&(!o.byteStride||o.byteStride===n))return s._GetTypedArray(e,t.componentType,l,t.byteOffset,a);{let c=new i(a);return A.ForEach(l,t.byteOffset||0,o.byteStride||n,r,t.componentType,c.length,t.normalized||!1,(f,h)=>{c[h]=f}),c}})}if(t.sparse){let o=t.sparse;t._data=t._data.then(l=>{let c=l,f=ve.Get(`${e}/sparse/indices/bufferView`,this._gltf.bufferViews,o.indices.bufferView),h=ve.Get(`${e}/sparse/values/bufferView`,this._gltf.bufferViews,o.values.bufferView);return Promise.all([this.loadBufferViewAsync(`/bufferViews/${f.index}`,f),this.loadBufferViewAsync(`/bufferViews/${h.index}`,h)]).then(([u,d])=>{let p=s._GetTypedArray(`${e}/sparse/indices`,o.indices.componentType,u,o.indices.byteOffset,o.count),m=r*o.count,_;if(t.componentType===5126&&!t.normalized)_=s._GetTypedArray(`${e}/sparse/values`,t.componentType,d,o.values.byteOffset,m);else{let T=s._GetTypedArray(`${e}/sparse/values`,t.componentType,d,o.values.byteOffset,m);_=new i(m),A.ForEach(T,0,n,r,t.componentType,_.length,t.normalized||!1,(C,I)=>{_[I]=C})}let v=0;for(let T=0;T<p.length;T++){let C=p[T]*r;for(let I=0;I<r;I++)c[C++]=_[v++]}return c})})}return t._data}_loadFloatAccessorAsync(e,t){return this._loadAccessorAsync(e,t,Float32Array)}_loadIndicesAccessorAsync(e,t){if(t.type!=="SCALAR")throw new Error(`${e}/type: Invalid value ${t.type}`);if(t.componentType!==5121&&t.componentType!==5123&&t.componentType!==5125)throw new Error(`${e}/componentType: Invalid value ${t.componentType}`);if(t._data)return t._data;if(t.sparse){let i=s._GetTypedArrayConstructor(`${e}/componentType`,t.componentType);t._data=this._loadAccessorAsync(e,t,i)}else{let i=ve.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${i.index}`,i).then(r=>s._GetTypedArray(e,t.componentType,r,t.byteOffset,t.count))}return t._data}_loadVertexBufferViewAsync(e){if(e._babylonBuffer)return e._babylonBuffer;let t=this._babylonScene.getEngine();return e._babylonBuffer=this.loadBufferViewAsync(`/bufferViews/${e.index}`,e).then(i=>new Gr(t,i,!1)),e._babylonBuffer}_loadVertexAccessorAsync(e,t,i){if(t._babylonVertexBuffer?.[i])return t._babylonVertexBuffer[i];t._babylonVertexBuffer||(t._babylonVertexBuffer={});let r=this._babylonScene.getEngine();if(t.sparse||t.bufferView==null)t._babylonVertexBuffer[i]=this._loadFloatAccessorAsync(e,t).then(n=>new A(r,n,i,!1));else{let n=ve.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._babylonVertexBuffer[i]=this._loadVertexBufferViewAsync(n).then(a=>{let o=s._GetNumComponents(e,t.type);return new A(r,a,i,!1,void 0,n.byteStride,void 0,t.byteOffset,o,t.componentType,t.normalized,!0,void 0,!0)})}return t._babylonVertexBuffer[i]}_loadMaterialMetallicRoughnessPropertiesAsync(e,t,i){if(!(i instanceof J))throw new Error(`${e}: Material type not supported`);let r=new Array;return t&&(t.baseColorFactor?(i.albedoColor=j.FromArray(t.baseColorFactor),i.alpha=t.baseColorFactor[3]):i.albedoColor=j.White(),i.metallic=t.metallicFactor==null?1:t.metallicFactor,i.roughness=t.roughnessFactor==null?1:t.roughnessFactor,t.baseColorTexture&&r.push(this.loadTextureInfoAsync(`${e}/baseColorTexture`,t.baseColorTexture,n=>{n.name=`${i.name} (Base Color)`,i.albedoTexture=n})),t.metallicRoughnessTexture&&(t.metallicRoughnessTexture.nonColorData=!0,r.push(this.loadTextureInfoAsync(`${e}/metallicRoughnessTexture`,t.metallicRoughnessTexture,n=>{n.name=`${i.name} (Metallic Roughness)`,i.metallicTexture=n})),i.useMetallnessFromMetallicTextureBlue=!0,i.useRoughnessFromMetallicTextureGreen=!0,i.useRoughnessFromMetallicTextureAlpha=!1)),Promise.all(r).then(()=>{})}_loadMaterialAsync(e,t,i,r,n=()=>{}){let a=this._extensionsLoadMaterialAsync(e,t,i,r,n);if(a)return a;t._data=t._data||{};let o=t._data[r];if(!o){this.logOpen(`${e} ${t.name||""}`);let l=this.createMaterial(e,t,r);o={babylonMaterial:l,babylonMeshes:[],promise:this.loadMaterialPropertiesAsync(e,t,l)},t._data[r]=o,s.AddPointerMetadata(l,e),this._parent.onMaterialLoadedObservable.notifyObservers(l),this.logClose()}return i&&(o.babylonMeshes.push(i),i.onDisposeObservable.addOnce(()=>{let l=o.babylonMeshes.indexOf(i);l!==-1&&o.babylonMeshes.splice(l,1)})),n(o.babylonMaterial),o.promise.then(()=>o.babylonMaterial)}_createDefaultMaterial(e,t){this._babylonScene._blockEntityCollection=!!this._assetContainer;let i=new J(e,this._babylonScene);return i._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,i.fillMode=t,i.enableSpecularAntiAliasing=!0,i.useRadianceOverAlpha=!this._parent.transparencyAsCoverage,i.useSpecularOverAlpha=!this._parent.transparencyAsCoverage,i.transparencyMode=J.PBRMATERIAL_OPAQUE,i.metallic=1,i.roughness=1,i}createMaterial(e,t,i){let r=this._extensionsCreateMaterial(e,t,i);if(r)return r;let n=t.name||`material${t.index}`;return this._createDefaultMaterial(n,i)}loadMaterialPropertiesAsync(e,t,i){let r=this._extensionsLoadMaterialPropertiesAsync(e,t,i);if(r)return r;let n=new Array;return n.push(this.loadMaterialBasePropertiesAsync(e,t,i)),t.pbrMetallicRoughness&&n.push(this._loadMaterialMetallicRoughnessPropertiesAsync(`${e}/pbrMetallicRoughness`,t.pbrMetallicRoughness,i)),this.loadMaterialAlphaProperties(e,t,i),Promise.all(n).then(()=>{})}loadMaterialBasePropertiesAsync(e,t,i){if(!(i instanceof J))throw new Error(`${e}: Material type not supported`);let r=new Array;return i.emissiveColor=t.emissiveFactor?j.FromArray(t.emissiveFactor):new j(0,0,0),t.doubleSided&&(i.backFaceCulling=!1,i.twoSidedLighting=!0),t.normalTexture&&(t.normalTexture.nonColorData=!0,r.push(this.loadTextureInfoAsync(`${e}/normalTexture`,t.normalTexture,n=>{n.name=`${i.name} (Normal)`,i.bumpTexture=n})),i.invertNormalMapX=!this._babylonScene.useRightHandedSystem,i.invertNormalMapY=this._babylonScene.useRightHandedSystem,t.normalTexture.scale!=null&&i.bumpTexture&&(i.bumpTexture.level=t.normalTexture.scale),i.forceIrradianceInFragment=!0),t.occlusionTexture&&(t.occlusionTexture.nonColorData=!0,r.push(this.loadTextureInfoAsync(`${e}/occlusionTexture`,t.occlusionTexture,n=>{n.name=`${i.name} (Occlusion)`,i.ambientTexture=n})),i.useAmbientInGrayScale=!0,t.occlusionTexture.strength!=null&&(i.ambientTextureStrength=t.occlusionTexture.strength)),t.emissiveTexture&&r.push(this.loadTextureInfoAsync(`${e}/emissiveTexture`,t.emissiveTexture,n=>{n.name=`${i.name} (Emissive)`,i.emissiveTexture=n})),Promise.all(r).then(()=>{})}loadMaterialAlphaProperties(e,t,i){if(!(i instanceof J))throw new Error(`${e}: Material type not supported`);switch(t.alphaMode||"OPAQUE"){case"OPAQUE":{i.transparencyMode=J.PBRMATERIAL_OPAQUE,i.alpha=1;break}case"MASK":{i.transparencyMode=J.PBRMATERIAL_ALPHATEST,i.alphaCutOff=t.alphaCutoff==null?.5:t.alphaCutoff,i.albedoTexture&&(i.albedoTexture.hasAlpha=!0);break}case"BLEND":{i.transparencyMode=J.PBRMATERIAL_ALPHABLEND,i.albedoTexture&&(i.albedoTexture.hasAlpha=!0,i.useAlphaFromAlbedoTexture=!0);break}default:throw new Error(`${e}/alphaMode: Invalid value (${t.alphaMode})`)}}loadTextureInfoAsync(e,t,i=()=>{}){let r=this._extensionsLoadTextureInfoAsync(e,t,i);if(r)return r;if(this.logOpen(`${e}`),t.texCoord>=6)throw new Error(`${e}/texCoord: Invalid value (${t.texCoord})`);let n=ve.Get(`${e}/index`,this._gltf.textures,t.index);n._textureInfo=t;let a=this._loadTextureAsync(`/textures/${t.index}`,n,o=>{o.coordinatesIndex=t.texCoord||0,s.AddPointerMetadata(o,e),this._parent.onTextureLoadedObservable.notifyObservers(o),i(o)});return this.logClose(),a}_loadTextureAsync(e,t,i=()=>{}){let r=this._extensionsLoadTextureAsync(e,t,i);if(r)return r;this.logOpen(`${e} ${t.name||""}`);let n=t.sampler==null?s.DefaultSampler:ve.Get(`${e}/sampler`,this._gltf.samplers,t.sampler),a=ve.Get(`${e}/source`,this._gltf.images,t.source),o=this._createTextureAsync(e,n,a,i,void 0,!t._textureInfo.nonColorData);return this.logClose(),o}_createTextureAsync(e,t,i,r=()=>{},n,a){let o=this._loadSampler(`/samplers/${t.index}`,t),l=new Array,c=new Qr;this._babylonScene._blockEntityCollection=!!this._assetContainer;let f={noMipmap:o.noMipMaps,invertY:!1,samplingMode:o.samplingMode,onLoad:()=>{this._disposed||c.resolve()},onError:(u,d)=>{this._disposed||c.reject(new Error(`${e}: ${d&&d.message?d.message:u||"Failed to load texture"}`))},mimeType:i.mimeType??eB(i.uri??""),loaderOptions:n,useSRGBBuffer:!!a&&this._parent.useSRGBBuffers},h=new H(null,this._babylonScene,f);return h._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,l.push(c.promise),l.push(this.loadImageAsync(`/images/${i.index}`,i).then(u=>{let d=i.uri||`${this._fileName}#image${i.index}`,p=`data:${this._uniqueRootUrl}${d}`;h.updateURL(p,u);let m=h.getInternalTexture();m&&(m.label=i.name)})),h.wrapU=o.wrapU,h.wrapV=o.wrapV,r(h),this._parent.useGltfTextureNames&&(h.name=i.name||i.uri||`image${i.index}`),Promise.all(l).then(()=>h)}_loadSampler(e,t){return t._data||(t._data={noMipMaps:t.minFilter===9728||t.minFilter===9729,samplingMode:s._GetTextureSamplingMode(e,t),wrapU:s._GetTextureWrapMode(`${e}/wrapS`,t.wrapS),wrapV:s._GetTextureWrapMode(`${e}/wrapT`,t.wrapT)}),t._data}loadImageAsync(e,t){if(!t._data){if(this.logOpen(`${e} ${t.name||""}`),t.uri)t._data=this.loadUriAsync(`${e}/uri`,t,t.uri);else{let i=ve.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${i.index}`,i)}this.logClose()}return t._data}loadUriAsync(e,t,i){let r=this._extensionsLoadUriAsync(e,t,i);if(r)return r;if(!s._ValidateUri(i))throw new Error(`${e}: '${i}' is invalid`);if(wl(i)){let n=new Uint8Array(Xo(i));return this.log(`${e}: Decoded ${i.substring(0,64)}... (${n.length} bytes)`),Promise.resolve(n)}return this.log(`${e}: Loading ${i}`),this._parent.preprocessUrlAsync(this._rootUrl+i).then(n=>new Promise((a,o)=>{this._parent._loadFile(this._babylonScene,n,l=>{this._disposed||(this.log(`${e}: Loaded ${i} (${l.byteLength} bytes)`),a(new Uint8Array(l)))},!0,l=>{o(new mf(`${e}: Failed to load '${i}'${l?": "+l.status+" "+l.statusText:""}`,l))})}))}static AddPointerMetadata(e,t){e.metadata=e.metadata||{};let i=e._internalMetadata=e._internalMetadata||{},r=i.gltf=i.gltf||{};(r.pointers=r.pointers||[]).push(t)}static _GetTextureWrapMode(e,t){switch(t=t??10497,t){case 33071:return H.CLAMP_ADDRESSMODE;case 33648:return H.MIRROR_ADDRESSMODE;case 10497:return H.WRAP_ADDRESSMODE;default:return P.Warn(`${e}: Invalid value (${t})`),H.WRAP_ADDRESSMODE}}static _GetTextureSamplingMode(e,t){let i=t.magFilter==null?9729:t.magFilter,r=t.minFilter==null?9987:t.minFilter;if(i===9729)switch(r){case 9728:return H.LINEAR_NEAREST;case 9729:return H.LINEAR_LINEAR;case 9984:return H.LINEAR_NEAREST_MIPNEAREST;case 9985:return H.LINEAR_LINEAR_MIPNEAREST;case 9986:return H.LINEAR_NEAREST_MIPLINEAR;case 9987:return H.LINEAR_LINEAR_MIPLINEAR;default:return P.Warn(`${e}/minFilter: Invalid value (${r})`),H.LINEAR_LINEAR_MIPLINEAR}else switch(i!==9728&&P.Warn(`${e}/magFilter: Invalid value (${i})`),r){case 9728:return H.NEAREST_NEAREST;case 9729:return H.NEAREST_LINEAR;case 9984:return H.NEAREST_NEAREST_MIPNEAREST;case 9985:return H.NEAREST_LINEAR_MIPNEAREST;case 9986:return H.NEAREST_NEAREST_MIPLINEAR;case 9987:return H.NEAREST_LINEAR_MIPLINEAR;default:return P.Warn(`${e}/minFilter: Invalid value (${r})`),H.NEAREST_NEAREST_MIPNEAREST}}static _GetTypedArrayConstructor(e,t){try{return TO(t)}catch(i){throw new Error(`${e}: ${i.message}`)}}static _GetTypedArray(e,t,i,r,n){let a=i.buffer;r=i.byteOffset+(r||0);let o=s._GetTypedArrayConstructor(`${e}/componentType`,t),l=A.GetTypeByteLength(t);return r%l!==0?(P.Warn(`${e}: Copying buffer as byte offset (${r}) is not a multiple of component type byte length (${l})`),new o(a.slice(r,r+n*l),0)):new o(a,r,n)}static _GetNumComponents(e,t){switch(t){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}throw new Error(`${e}: Invalid type (${t})`)}static _ValidateUri(e){return W.IsBase64(e)||e.indexOf("..")===-1}static _GetDrawMode(e,t){switch(t==null&&(t=4),t){case 0:return Q.PointListDrawMode;case 1:return Q.LineListDrawMode;case 2:return Q.LineLoopDrawMode;case 3:return Q.LineStripDrawMode;case 4:return Q.TriangleFillMode;case 5:return Q.TriangleStripDrawMode;case 6:return Q.TriangleFanDrawMode}throw new Error(`${e}: Invalid mesh primitive mode (${t})`)}_compileMaterialsAsync(){this._parent._startPerformanceCounter("Compile materials");let e=new Array;if(this._gltf.materials){for(let t of this._gltf.materials)if(t._data)for(let i in t._data){let r=t._data[i];for(let n of r.babylonMeshes){n.computeWorldMatrix(!0);let a=r.babylonMaterial;e.push(a.forceCompilationAsync(n)),e.push(a.forceCompilationAsync(n,{useInstances:!0})),this._parent.useClipPlane&&(e.push(a.forceCompilationAsync(n,{clipPlane:!0})),e.push(a.forceCompilationAsync(n,{clipPlane:!0,useInstances:!0})))}}}return Promise.all(e).then(()=>{this._parent._endPerformanceCounter("Compile materials")})}_compileShadowGeneratorsAsync(){this._parent._startPerformanceCounter("Compile shadow generators");let e=new Array,t=this._babylonScene.lights;for(let i of t){let r=i.getShadowGenerator();r&&e.push(r.forceCompilationAsync())}return Promise.all(e).then(()=>{this._parent._endPerformanceCounter("Compile shadow generators")})}_forEachExtensions(e){for(let t of this._extensions)t.enabled&&e(t)}_applyExtensions(e,t,i){for(let r of this._extensions)if(r.enabled){let n=`${r.name}.${t}`,a=e;a._activeLoaderExtensionFunctions=a._activeLoaderExtensionFunctions||{};let o=a._activeLoaderExtensionFunctions;if(!o[n]){o[n]=!0;try{let l=i(r);if(l)return l}finally{delete o[n]}}}return null}_extensionsOnLoading(){this._forEachExtensions(e=>e.onLoading&&e.onLoading())}_extensionsOnReady(){this._forEachExtensions(e=>e.onReady&&e.onReady())}_extensionsLoadSceneAsync(e,t){return this._applyExtensions(t,"loadScene",i=>i.loadSceneAsync&&i.loadSceneAsync(e,t))}_extensionsLoadNodeAsync(e,t,i){return this._applyExtensions(t,"loadNode",r=>r.loadNodeAsync&&r.loadNodeAsync(e,t,i))}_extensionsLoadCameraAsync(e,t,i){return this._applyExtensions(t,"loadCamera",r=>r.loadCameraAsync&&r.loadCameraAsync(e,t,i))}_extensionsLoadVertexDataAsync(e,t,i){return this._applyExtensions(t,"loadVertexData",r=>r._loadVertexDataAsync&&r._loadVertexDataAsync(e,t,i))}_extensionsLoadMeshPrimitiveAsync(e,t,i,r,n,a){return this._applyExtensions(n,"loadMeshPrimitive",o=>o._loadMeshPrimitiveAsync&&o._loadMeshPrimitiveAsync(e,t,i,r,n,a))}_extensionsLoadMaterialAsync(e,t,i,r,n){return this._applyExtensions(t,"loadMaterial",a=>a._loadMaterialAsync&&a._loadMaterialAsync(e,t,i,r,n))}_extensionsCreateMaterial(e,t,i){return this._applyExtensions(t,"createMaterial",r=>r.createMaterial&&r.createMaterial(e,t,i))}_extensionsLoadMaterialPropertiesAsync(e,t,i){return this._applyExtensions(t,"loadMaterialProperties",r=>r.loadMaterialPropertiesAsync&&r.loadMaterialPropertiesAsync(e,t,i))}_extensionsLoadTextureInfoAsync(e,t,i){return this._applyExtensions(t,"loadTextureInfo",r=>r.loadTextureInfoAsync&&r.loadTextureInfoAsync(e,t,i))}_extensionsLoadTextureAsync(e,t,i){return this._applyExtensions(t,"loadTexture",r=>r._loadTextureAsync&&r._loadTextureAsync(e,t,i))}_extensionsLoadAnimationAsync(e,t){return this._applyExtensions(t,"loadAnimation",i=>i.loadAnimationAsync&&i.loadAnimationAsync(e,t))}_extensionsLoadAnimationChannelAsync(e,t,i,r,n){return this._applyExtensions(i,"loadAnimationChannel",a=>a._loadAnimationChannelAsync&&a._loadAnimationChannelAsync(e,t,i,r,n))}_extensionsLoadSkinAsync(e,t,i){return this._applyExtensions(i,"loadSkin",r=>r._loadSkinAsync&&r._loadSkinAsync(e,t,i))}_extensionsLoadUriAsync(e,t,i){return this._applyExtensions(t,"loadUri",r=>r._loadUriAsync&&r._loadUriAsync(e,t,i))}_extensionsLoadBufferViewAsync(e,t){return this._applyExtensions(t,"loadBufferView",i=>i.loadBufferViewAsync&&i.loadBufferViewAsync(e,t))}_extensionsLoadBufferAsync(e,t,i,r){return this._applyExtensions(t,"loadBuffer",n=>n.loadBufferAsync&&n.loadBufferAsync(e,t,i,r))}static LoadExtensionAsync(e,t,i,r){if(!t.extensions)return null;let a=t.extensions[i];return a?r(`${e}/extensions/${i}`,a):null}static LoadExtraAsync(e,t,i,r){if(!t.extras)return null;let a=t.extras[i];return a?r(`${e}/extras/${i}`,a):null}isExtensionUsed(e){return!!this._gltf.extensionsUsed&&this._gltf.extensionsUsed.indexOf(e)!==-1}logOpen(e){this._parent._logOpen(e)}logClose(){this._parent._logClose()}log(e){this._parent._log(e)}startPerformanceCounter(e){this._parent._startPerformanceCounter(e)}endPerformanceCounter(e){this._parent._endPerformanceCounter(e)}};Pe.DefaultSampler={index:-1};ja._CreateGLTF2Loader=s=>new Pe(s)});var gk={};V(gk,{EXT_lights_image_based:()=>Eg});var Sg,Eg,vk=S(()=>{gl();ie();YV();Nt();mt();Sg="EXT_lights_image_based",Eg=class{constructor(e){this.name=Sg,this._loader=e,this.enabled=this._loader.isExtensionUsed(Sg)}dispose(){this._loader=null,delete this._lights}onLoading(){let e=this._loader.gltf.extensions;if(e&&e[this.name]){let t=e[this.name];this._lights=t.lights}}loadSceneAsync(e,t){return Pe.LoadExtensionAsync(e,t,this.name,async(i,r)=>{this._loader._allMaterialsDirtyRequired=!0;let n=new Array;n.push(this._loader.loadSceneAsync(e,t)),this._loader.logOpen(`${i}`);let a=ve.Get(`${i}/light`,this._lights,r.light);return n.push(this._loadLightAsync(`/extensions/${this.name}/lights/${r.light}`,a).then(o=>{this._loader.babylonScene.environmentTexture=o})),this._loader.logClose(),await Promise.all(n).then(()=>{})})}_loadLightAsync(e,t){if(!t._loaded){let i=new Array;this._loader.logOpen(`${e}`);let r=new Array(t.specularImages.length);for(let n=0;n<t.specularImages.length;n++){let a=t.specularImages[n];r[n]=new Array(a.length);for(let o=0;o<a.length;o++){let l=`${e}/specularImages/${n}/${o}`;this._loader.logOpen(`${l}`);let c=a[o],f=ve.Get(l,this._loader.gltf.images,c);i.push(this._loader.loadImageAsync(`/images/${c}`,f).then(h=>{r[n][o]=h})),this._loader.logClose()}}this._loader.logClose(),t._loaded=Promise.all(i).then(async()=>{let n=new ag(this._loader.babylonScene,null,t.specularImageSize);if(n.name=t.name||"environment",t._babylonTexture=n,t.intensity!=null&&(n.level=t.intensity),t.rotation){let c=K.FromArray(t.rotation);this._loader.babylonScene.useRightHandedSystem||(c=K.Inverse(c)),B.FromQuaternionToRef(c,n.getReflectionTextureMatrix())}if(!t.irradianceCoefficients)throw new Error(`${e}: Irradiance coefficients are missing`);let a=_l.FromArray(t.irradianceCoefficients);a.scaleInPlace(t.intensity),a.convertIrradianceToLambertianRadiance();let o=Ur.FromHarmonics(a),l=(r.length-1)/Math.log2(t.specularImageSize);return await n.updateRGBDAsync(r,o,l)})}return t._loaded.then(()=>t._babylonTexture)}};Ce(Sg);te(Sg,!0,s=>new Eg(s))});var fy=S(()=>{Ki();yt();ie();Ee();Pl();fe.prototype.thinInstanceAdd=function(s,e=!0){if(!this.getScene().getEngine().getCaps().instancedArrays)return P.Error("Thin Instances are not supported on this device as Instanced Array extension not supported"),-1;this._thinInstanceUpdateBufferSize("matrix",Array.isArray(s)?s.length:1);let t=this._thinInstanceDataStorage.instancesCount;if(Array.isArray(s))for(let i=0;i<s.length;++i)this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,s[i],i===s.length-1&&e);else this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,s,e);return t};fe.prototype.thinInstanceAddSelf=function(s=!0){return this.thinInstanceAdd(B.IdentityReadOnly,s)};fe.prototype.thinInstanceRegisterAttribute=function(s,e){s===A.ColorKind&&(s=A.ColorInstanceKind),this.removeVerticesData(s),this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.strides[s]=e,this._userThinInstanceBuffersStorage.sizes[s]=e*Math.max(32,this._thinInstanceDataStorage.instancesCount),this._userThinInstanceBuffersStorage.data[s]=new Float32Array(this._userThinInstanceBuffersStorage.sizes[s]),this._userThinInstanceBuffersStorage.vertexBuffers[s]=new A(this.getEngine(),this._userThinInstanceBuffersStorage.data[s],s,!0,!1,e,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[s])};fe.prototype.thinInstanceSetMatrixAt=function(s,e,t=!0){if(!this._thinInstanceDataStorage.matrixData||s>=this._thinInstanceDataStorage.instancesCount)return!1;let i=this._thinInstanceDataStorage.matrixData;return e.copyToArray(i,s*16),this._thinInstanceDataStorage.worldMatrices&&(this._thinInstanceDataStorage.worldMatrices[s]=e),t&&(this.thinInstanceBufferUpdated("matrix"),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)),!0};fe.prototype.thinInstanceSetAttributeAt=function(s,e,t,i=!0){return s===A.ColorKind&&(s=A.ColorInstanceKind),!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.data[s]||e>=this._thinInstanceDataStorage.instancesCount?!1:(this._thinInstanceUpdateBufferSize(s,0),this._userThinInstanceBuffersStorage.data[s].set(t,e*this._userThinInstanceBuffersStorage.strides[s]),i&&this.thinInstanceBufferUpdated(s),!0)};Object.defineProperty(fe.prototype,"thinInstanceCount",{get:function(){return this._thinInstanceDataStorage.instancesCount},set:function(s){let e=this._thinInstanceDataStorage.matrixData??this.source?._thinInstanceDataStorage.matrixData,t=e?e.length/16:0;s<=t&&(this._thinInstanceDataStorage.instancesCount=s)},enumerable:!0,configurable:!0});fe.prototype._thinInstanceCreateMatrixBuffer=function(s,e,t=!0){let i=new Gr(this.getEngine(),e,!t,16,!1,!0);for(let r=0;r<4;r++)this.setVerticesBuffer(i.createVertexBuffer(s+r,r*4,4));return i};fe.prototype.thinInstanceSetBuffer=function(s,e,t=0,i=!0){t=t||16,s==="matrix"?(this._thinInstanceDataStorage.matrixBuffer?.dispose(),this._thinInstanceDataStorage.matrixBuffer=null,this._thinInstanceDataStorage.matrixBufferSize=e?e.length:32*t,this._thinInstanceDataStorage.matrixData=e,this._thinInstanceDataStorage.worldMatrices=null,e!==null?(this._thinInstanceDataStorage.instancesCount=e.length/t,this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",e,i),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)):(this._thinInstanceDataStorage.instancesCount=0,this.doNotSyncBoundingInfo||this.refreshBoundingInfo())):s==="previousMatrix"?(this._thinInstanceDataStorage.previousMatrixBuffer?.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=null,this._thinInstanceDataStorage.previousMatrixData=e,e!==null&&(this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",e,i))):(s===A.ColorKind&&(s=A.ColorInstanceKind),e===null?this._userThinInstanceBuffersStorage?.data[s]&&(this.removeVerticesData(s),delete this._userThinInstanceBuffersStorage.data[s],delete this._userThinInstanceBuffersStorage.strides[s],delete this._userThinInstanceBuffersStorage.sizes[s],delete this._userThinInstanceBuffersStorage.vertexBuffers[s]):(this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.data[s]=e,this._userThinInstanceBuffersStorage.strides[s]=t,this._userThinInstanceBuffersStorage.sizes[s]=e.length,this._userThinInstanceBuffersStorage.vertexBuffers[s]=new A(this.getEngine(),e,s,!i,!1,t,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[s])))};fe.prototype.thinInstanceBufferUpdated=function(s){s==="matrix"?(this.thinInstanceAllowAutomaticStaticBufferRecreation&&this._thinInstanceDataStorage.matrixBuffer&&!this._thinInstanceDataStorage.matrixBuffer.isUpdatable()&&this._thinInstanceRecreateBuffer(s),this._thinInstanceDataStorage.matrixBuffer?.updateDirectly(this._thinInstanceDataStorage.matrixData,0,this._thinInstanceDataStorage.instancesCount)):s==="previousMatrix"?(this.thinInstanceAllowAutomaticStaticBufferRecreation&&this._thinInstanceDataStorage.previousMatrixBuffer&&!this._thinInstanceDataStorage.previousMatrixBuffer.isUpdatable()&&this._thinInstanceRecreateBuffer(s),this._thinInstanceDataStorage.previousMatrixBuffer?.updateDirectly(this._thinInstanceDataStorage.previousMatrixData,0,this._thinInstanceDataStorage.instancesCount)):(s===A.ColorKind&&(s=A.ColorInstanceKind),this._userThinInstanceBuffersStorage?.vertexBuffers[s]&&(this.thinInstanceAllowAutomaticStaticBufferRecreation&&!this._userThinInstanceBuffersStorage.vertexBuffers[s].isUpdatable()&&this._thinInstanceRecreateBuffer(s),this._userThinInstanceBuffersStorage.vertexBuffers[s].updateDirectly(this._userThinInstanceBuffersStorage.data[s],0)))};fe.prototype.thinInstancePartialBufferUpdate=function(s,e,t){s==="matrix"?this._thinInstanceDataStorage.matrixBuffer&&this._thinInstanceDataStorage.matrixBuffer.updateDirectly(e,t):(s===A.ColorKind&&(s=A.ColorInstanceKind),this._userThinInstanceBuffersStorage?.vertexBuffers[s]&&this._userThinInstanceBuffersStorage.vertexBuffers[s].updateDirectly(e,t))};fe.prototype.thinInstanceGetWorldMatrices=function(){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return[];let s=this._thinInstanceDataStorage.matrixData;if(!this._thinInstanceDataStorage.worldMatrices){this._thinInstanceDataStorage.worldMatrices=[];for(let e=0;e<this._thinInstanceDataStorage.instancesCount;++e)this._thinInstanceDataStorage.worldMatrices[e]=B.FromArray(s,e*16)}return this._thinInstanceDataStorage.worldMatrices};fe.prototype.thinInstanceRefreshBoundingInfo=function(s=!1,e=!1,t=!1){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return;let i=this._thinInstanceDataStorage.boundingVectors;if(s||!this.rawBoundingInfo){i.length=0,this.refreshBoundingInfo(e,t);let a=this.getBoundingInfo();this.rawBoundingInfo=new Ei(a.minimum,a.maximum)}let r=this.getBoundingInfo(),n=this._thinInstanceDataStorage.matrixData;if(i.length===0)for(let a=0;a<r.boundingBox.vectors.length;++a)i.push(r.boundingBox.vectors[a].clone());w.Vector3[0].setAll(Number.POSITIVE_INFINITY),w.Vector3[1].setAll(Number.NEGATIVE_INFINITY);for(let a=0;a<this._thinInstanceDataStorage.instancesCount;++a){B.FromArrayToRef(n,a*16,w.Matrix[0]);for(let o=0;o<i.length;++o)E.TransformCoordinatesToRef(i[o],w.Matrix[0],w.Vector3[2]),w.Vector3[0].minimizeInPlace(w.Vector3[2]),w.Vector3[1].maximizeInPlace(w.Vector3[2])}r.reConstruct(w.Vector3[0],w.Vector3[1]),this._updateBoundingInfo()};fe.prototype._thinInstanceRecreateBuffer=function(s,e=!0){s==="matrix"?(this._thinInstanceDataStorage.matrixBuffer?.dispose(),this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",this._thinInstanceDataStorage.matrixData,e)):s==="previousMatrix"?this._scene.needsPreviousWorldMatrices&&(this._thinInstanceDataStorage.previousMatrixBuffer?.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.previousMatrixData??this._thinInstanceDataStorage.matrixData,e)):(s===A.ColorKind&&(s=A.ColorInstanceKind),this._userThinInstanceBuffersStorage.vertexBuffers[s]?.dispose(),this._userThinInstanceBuffersStorage.vertexBuffers[s]=new A(this.getEngine(),this._userThinInstanceBuffersStorage.data[s],s,!e,!1,this._userThinInstanceBuffersStorage.strides[s],!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[s]))};fe.prototype._thinInstanceUpdateBufferSize=function(s,e=1){s===A.ColorKind&&(s=A.ColorInstanceKind);let t=s==="matrix";if(!t&&(!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.strides[s]))return;let i=t?16:this._userThinInstanceBuffersStorage.strides[s],r=t?this._thinInstanceDataStorage.matrixBufferSize:this._userThinInstanceBuffersStorage.sizes[s],n=t?this._thinInstanceDataStorage.matrixData:this._userThinInstanceBuffersStorage.data[s],a=(this._thinInstanceDataStorage.instancesCount+e)*i,o=r;for(;o<a;)o*=2;if(!n||r!=o){if(!n)n=new Float32Array(o);else{let l=new Float32Array(o);l.set(n,0),n=l}t?(this._thinInstanceDataStorage.matrixBuffer?.dispose(),this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",n,!1),this._thinInstanceDataStorage.matrixData=n,this._thinInstanceDataStorage.matrixBufferSize=o,this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&(this._thinInstanceDataStorage.previousMatrixBuffer?.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",n,!1))):(this._userThinInstanceBuffersStorage.vertexBuffers[s]?.dispose(),this._userThinInstanceBuffersStorage.data[s]=n,this._userThinInstanceBuffersStorage.sizes[s]=o,this._userThinInstanceBuffersStorage.vertexBuffers[s]=new A(this.getEngine(),n,s,!0,!1,i,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[s]))}};fe.prototype._thinInstanceInitializeUserStorage=function(){this._userThinInstanceBuffersStorage||(this._userThinInstanceBuffersStorage={data:{},sizes:{},vertexBuffers:{},strides:{}})};fe.prototype._disposeThinInstanceSpecificData=function(){this._thinInstanceDataStorage?.matrixBuffer&&(this._thinInstanceDataStorage.matrixBuffer.dispose(),this._thinInstanceDataStorage.matrixBuffer=null),this._thinInstanceDataStorage?.previousMatrixBuffer&&(this._thinInstanceDataStorage.previousMatrixBuffer.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=null)}});var Sk={};V(Sk,{EXT_mesh_gpu_instancing:()=>xg});var Tg,xg,Ek=S(()=>{ie();Nt();mt();fy();Tg="EXT_mesh_gpu_instancing",xg=class{constructor(e){this.name=Tg,this._loader=e,this.enabled=this._loader.isExtensionUsed(Tg)}dispose(){this._loader=null}loadNodeAsync(e,t,i){return Pe.LoadExtensionAsync(e,t,this.name,async(r,n)=>{this._loader._disableInstancedMesh++;let a=this._loader.loadNodeAsync(`/nodes/${t.index}`,t,i);if(this._loader._disableInstancedMesh--,!t._primitiveBabylonMeshes)return await a;let o=new Array,l=0,c=f=>{if(n.attributes[f]==null){o.push(Promise.resolve(null));return}let h=ve.Get(`${r}/attributes/${f}`,this._loader.gltf.accessors,n.attributes[f]);if(o.push(this._loader._loadFloatAccessorAsync(`/accessors/${h.bufferView}`,h)),l===0)l=h.count;else if(l!==h.count)throw new Error(`${r}/attributes: Instance buffer accessors do not have the same count.`)};return c("TRANSLATION"),c("ROTATION"),c("SCALE"),await a.then(async f=>{let[h,u,d]=await Promise.all(o),p=new Float32Array(l*16);w.Vector3[0].copyFromFloats(0,0,0),w.Quaternion[0].copyFromFloats(0,0,0,1),w.Vector3[1].copyFromFloats(1,1,1);for(let m=0;m<l;++m)h&&E.FromArrayToRef(h,m*3,w.Vector3[0]),u&&K.FromArrayToRef(u,m*4,w.Quaternion[0]),d&&E.FromArrayToRef(d,m*3,w.Vector3[1]),B.ComposeToRef(w.Vector3[1],w.Quaternion[0],w.Vector3[0],w.Matrix[0]),w.Matrix[0].copyToArray(p,m*16);for(let m of t._primitiveBabylonMeshes)m.thinInstanceSetBuffer("matrix",p,16,!0);return f})})}};Ce(Tg);te(Tg,!0,s=>new xg(s))});var hy,Ag,Wf,Tk=S(()=>{$e();hy=0,Ag=null,Wf=class s{static get Default(){return s._Default||(s._Default=new s),s._Default}constructor(){let e=s.Configuration.decoder;this._decoderModulePromise=W.LoadBabylonScriptAsync(e.url).then(()=>MeshoptDecoder.ready)}dispose(){delete this._decoderModulePromise}async decodeGltfBufferAsync(e,t,i,r,n){await this._decoderModulePromise,hy===0&&(MeshoptDecoder.useWorkers(1),hy=1);let a=await MeshoptDecoder.decodeGltfBufferAsync(t,i,e,r,n);return Ag!==null&&clearTimeout(Ag),Ag=setTimeout(()=>{MeshoptDecoder.useWorkers(0),hy=0,Ag=null},1e3),a}};Wf.Configuration={decoder:{url:`${W._DefaultCdnUrl}/meshopt_decoder.js`}};Wf._Default=null});var xk={};V(xk,{EXT_meshopt_compression:()=>bg});var Rg,bg,Ak=S(()=>{Nt();Tk();mt();Rg="EXT_meshopt_compression",bg=class{constructor(e){this.name=Rg,this.enabled=e.isExtensionUsed(Rg),this._loader=e}dispose(){this._loader=null}loadBufferViewAsync(e,t){return Pe.LoadExtensionAsync(e,t,this.name,async(i,r)=>{let n=t;if(n._meshOptData)return await n._meshOptData;let a=ve.Get(`${e}/buffer`,this._loader.gltf.buffers,r.buffer);return n._meshOptData=this._loader.loadBufferAsync(`/buffers/${a.index}`,a,r.byteOffset||0,r.byteLength).then(async o=>await Wf.Default.decodeGltfBufferAsync(o,r.count,r.byteStride,r.mode,r.filter)),await n._meshOptData})}};Ce(Rg);te(Rg,!0,s=>new bg(s))});var Rk={};V(Rk,{EXT_texture_avif:()=>Ig});var Cg,Ig,bk=S(()=>{Nt();mt();Cg="EXT_texture_avif",Ig=class{constructor(e){this.name=Cg,this._loader=e,this.enabled=e.isExtensionUsed(Cg)}dispose(){this._loader=null}_loadTextureAsync(e,t,i){return Pe.LoadExtensionAsync(e,t,this.name,async(r,n)=>{let a=t.sampler==null?Pe.DefaultSampler:ve.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),o=ve.Get(`${r}/source`,this._loader.gltf.images,n.source);return await this._loader._createTextureAsync(e,a,o,l=>{i(l)},void 0,!t._textureInfo.nonColorData)})}};Ce(Cg);te(Cg,!0,s=>new Ig(s))});var Ck={};V(Ck,{EXT_texture_webp:()=>Mg});var yg,Mg,Ik=S(()=>{Nt();mt();yg="EXT_texture_webp",Mg=class{constructor(e){this.name=yg,this._loader=e,this.enabled=e.isExtensionUsed(yg)}dispose(){this._loader=null}_loadTextureAsync(e,t,i){return Pe.LoadExtensionAsync(e,t,this.name,async(r,n)=>{let a=t.sampler==null?Pe.DefaultSampler:ve.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),o=ve.Get(`${r}/source`,this._loader.gltf.images,n.source);return await this._loader._createTextureAsync(e,a,o,l=>{i(l)},void 0,!t._textureInfo.nonColorData)})}};Ce(yg);te(yg,!0,s=>new Mg(s))});var yk={};V(yk,{ExtrasAsMetadata:()=>Pg});var uy,Pg,Mk=S(()=>{mt();uy="ExtrasAsMetadata",Pg=class{_assignExtras(e,t){if(t.extras&&Object.keys(t.extras).length>0){let i=e.metadata=e.metadata||{},r=i.gltf=i.gltf||{};r.extras=t.extras}}constructor(e){this.name=uy,this.enabled=!0,this._loader=e}dispose(){this._loader=null}loadNodeAsync(e,t,i){return this._loader.loadNodeAsync(e,t,r=>{this._assignExtras(r,t),i(r)})}loadCameraAsync(e,t,i){return this._loader.loadCameraAsync(e,t,r=>{this._assignExtras(r,t),i(r)})}createMaterial(e,t,i){let r=this._loader.createMaterial(e,t,i);return this._assignExtras(r,t),r}};Ce(uy);te(uy,!1,s=>new Pg(s))});function $o(s,e,t,i){return j.FromArray(e,t).scale(i)}function Ete(s,e,t,i){return e[t+3]*i}function Lt(s,e,t,i){return e[t]*i}function dy(s,e,t,i){return-e[t]*i}function Dg(s,e,t,i){return e[t+1]*i}function Pk(s,e,t,i){return e[t]*i*2}function Fi(s){return{scale:[new It(q.ANIMATIONTYPE_FLOAT,`${s}.uScale`,Lt,()=>2),new It(q.ANIMATIONTYPE_FLOAT,`${s}.vScale`,Dg,()=>2)],offset:[new It(q.ANIMATIONTYPE_FLOAT,`${s}.uOffset`,Lt,()=>2),new It(q.ANIMATIONTYPE_FLOAT,`${s}.vOffset`,Dg,()=>2)],rotation:[new It(q.ANIMATIONTYPE_FLOAT,`${s}.wAng`,dy,()=>1)]}}var un,It,$a,py,my,_y,gy,vy,Sy,Ey,Ty,xy,Ay,Ry,by,Cy,Iy,yy,My,Py,Dy,Oy,Dk=S(()=>{ws();cy();it();Za();un=class extends Ja{buildAnimations(e,t,i,r){return[{babylonAnimatable:e._babylonCamera,babylonAnimation:this._buildAnimation(t,i,r)}]}},It=class extends Ja{buildAnimations(e,t,i,r){let n=[];for(let a in e._data)n.push({babylonAnimatable:e._data[a].babylonMaterial,babylonAnimation:this._buildAnimation(t,i,r)});return n}},$a=class extends Ja{buildAnimations(e,t,i,r){return[{babylonAnimatable:e._babylonLight,babylonAnimation:this._buildAnimation(t,i,r)}]}};ae("/cameras/{}/orthographic/xmag",[new un(q.ANIMATIONTYPE_FLOAT,"orthoLeft",dy,()=>1),new un(q.ANIMATIONTYPE_FLOAT,"orthoRight",Dg,()=>1)]);ae("/cameras/{}/orthographic/ymag",[new un(q.ANIMATIONTYPE_FLOAT,"orthoBottom",dy,()=>1),new un(q.ANIMATIONTYPE_FLOAT,"orthoTop",Dg,()=>1)]);ae("/cameras/{}/orthographic/zfar",[new un(q.ANIMATIONTYPE_FLOAT,"maxZ",Lt,()=>1)]);ae("/cameras/{}/orthographic/znear",[new un(q.ANIMATIONTYPE_FLOAT,"minZ",Lt,()=>1)]);ae("/cameras/{}/perspective/yfov",[new un(q.ANIMATIONTYPE_FLOAT,"fov",Lt,()=>1)]);ae("/cameras/{}/perspective/zfar",[new un(q.ANIMATIONTYPE_FLOAT,"maxZ",Lt,()=>1)]);ae("/cameras/{}/perspective/znear",[new un(q.ANIMATIONTYPE_FLOAT,"minZ",Lt,()=>1)]);ae("/materials/{}/pbrMetallicRoughness/baseColorFactor",[new It(q.ANIMATIONTYPE_COLOR3,"albedoColor",$o,()=>4),new It(q.ANIMATIONTYPE_FLOAT,"alpha",Ete,()=>4)]);ae("/materials/{}/pbrMetallicRoughness/metallicFactor",[new It(q.ANIMATIONTYPE_FLOAT,"metallic",Lt,()=>1)]);ae("/materials/{}/pbrMetallicRoughness/metallicFactor",[new It(q.ANIMATIONTYPE_FLOAT,"roughness",Lt,()=>1)]);py=Fi("albedoTexture");ae("/materials/{}/pbrMetallicRoughness/baseColorTexture/extensions/KHR_texture_transform/scale",py.scale);ae("/materials/{}/pbrMetallicRoughness/baseColorTexture/extensions/KHR_texture_transform/offset",py.offset);ae("/materials/{}/pbrMetallicRoughness/baseColorTexture/extensions/KHR_texture_transform/rotation",py.rotation);my=Fi("metallicTexture");ae("//materials/{}/pbrMetallicRoughness/metallicRoughnessTexture/scale",my.scale);ae("//materials/{}/pbrMetallicRoughness/metallicRoughnessTexture/offset",my.offset);ae("//materials/{}/pbrMetallicRoughness/metallicRoughnessTexture/rotation",my.rotation);ae("/materials/{}/emissiveFactor",[new It(q.ANIMATIONTYPE_COLOR3,"emissiveColor",$o,()=>3)]);_y=Fi("bumpTexture");ae("/materials/{}/normalTexture/scale",[new It(q.ANIMATIONTYPE_FLOAT,"bumpTexture.level",Lt,()=>1)]);ae("/materials/{}/normalTexture/extensions/KHR_texture_transform/scale",_y.scale);ae("/materials/{}/normalTexture/extensions/KHR_texture_transform/offset",_y.offset);ae("/materials/{}/normalTexture/extensions/KHR_texture_transform/rotation",_y.rotation);ae("/materials/{}/occlusionTexture/strength",[new It(q.ANIMATIONTYPE_FLOAT,"ambientTextureStrength",Lt,()=>1)]);gy=Fi("ambientTexture");ae("/materials/{}/occlusionTexture/extensions/KHR_texture_transform/scale",gy.scale);ae("/materials/{}/occlusionTexture/extensions/KHR_texture_transform/offset",gy.offset);ae("/materials/{}/occlusionTexture/extensions/KHR_texture_transform/rotation",gy.rotation);vy=Fi("emissiveTexture");ae("/materials/{}/emissiveTexture/extensions/KHR_texture_transform/scale",vy.scale);ae("/materials/{}/emissiveTexture/extensions/KHR_texture_transform/offset",vy.offset);ae("/materials/{}/emissiveTexture/extensions/KHR_texture_transform/rotation",vy.rotation);ae("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyStrength",[new It(q.ANIMATIONTYPE_FLOAT,"anisotropy.intensity",Lt,()=>1)]);ae("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyRotation",[new It(q.ANIMATIONTYPE_FLOAT,"anisotropy.angle",Lt,()=>1)]);Sy=Fi("anisotropy.texture");ae("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyTexture/extensions/KHR_texture_transform/scale",Sy.scale);ae("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyTexture/extensions/KHR_texture_transform/offset",Sy.offset);ae("/materials/{}/extensions/KHR_materials_anisotropy/anisotropyTexture/extensions/KHR_texture_transform/rotation",Sy.rotation);ae("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatFactor",[new It(q.ANIMATIONTYPE_FLOAT,"clearCoat.intensity",Lt,()=>1)]);ae("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatRoughnessFactor",[new It(q.ANIMATIONTYPE_FLOAT,"clearCoat.roughness",Lt,()=>1)]);Ey=Fi("clearCoat.texture");ae("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatTexture/extensions/KHR_texture_transform/scale",Ey.scale);ae("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatTexture/extensions/KHR_texture_transform/offset",Ey.offset);ae("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatTexture/extensions/KHR_texture_transform/rotation",Ey.rotation);Ty=Fi("clearCoat.bumpTexture");ae("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatNormalTexture/scale",[new It(q.ANIMATIONTYPE_FLOAT,"clearCoat.bumpTexture.level",Lt,()=>1)]);ae("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatNormalTexture/extensions/KHR_texture_transform/scale",Ty.scale);ae("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatNormalTexture/extensions/KHR_texture_transform/offset",Ty.offset);ae("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatNormalTexture/extensions/KHR_texture_transform/rotation",Ty.rotation);xy=Fi("clearCoat.textureRoughness");ae("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatRoughnessTexture/extensions/KHR_texture_transform/scale",xy.scale);ae("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatRoughnessTexture/extensions/KHR_texture_transform/offset",xy.offset);ae("/materials/{}/extensions/KHR_materials_clearcoat/clearcoatRoughnessTexture/extensions/KHR_texture_transform/rotation",xy.rotation);ae("/materials/{}/extensions/KHR_materials_dispersion/dispersionFactor",[new It(q.ANIMATIONTYPE_FLOAT,"subSurface.dispersion",Lt,()=>1)]);ae("/materials/{}/extensions/KHR_materials_emissive_strength/emissiveStrength",[new It(q.ANIMATIONTYPE_FLOAT,"emissiveIntensity",Lt,()=>1)]);ae("/materials/{}/extensions/KHR_materials_ior/ior",[new It(q.ANIMATIONTYPE_FLOAT,"indexOfRefraction",Lt,()=>1)]);ae("/materials/{}/extensions/KHR_materials_iridescence/iridescenceFactor",[new It(q.ANIMATIONTYPE_FLOAT,"iridescence.intensity",Lt,()=>1)]);ae("/materials/{}/extensions/KHR_materials_iridescence/iridescenceIor",[new It(q.ANIMATIONTYPE_FLOAT,"iridescence.indexOfRefraction",Lt,()=>1)]);ae("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessMinimum",[new It(q.ANIMATIONTYPE_FLOAT,"iridescence.minimumThickness",Lt,()=>1)]);ae("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessMaximum",[new It(q.ANIMATIONTYPE_FLOAT,"iridescence.maximumThickness",Lt,()=>1)]);Ay=Fi("iridescence.texture");ae("/materials/{}/extensions/KHR_materials_iridescence/iridescenceTexture/extensions/KHR_texture_transform/scale",Ay.scale);ae("/materials/{}/extensions/KHR_materials_iridescence/iridescenceTexture/extensions/KHR_texture_transform/offset",Ay.offset);ae("/materials/{}/extensions/KHR_materials_iridescence/iridescenceTexture/extensions/KHR_texture_transform/rotation",Ay.rotation);Ry=Fi("iridescence.thicknessTexture");ae("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessTexture/extensions/KHR_texture_transform/scale",Ry.scale);ae("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessTexture/extensions/KHR_texture_transform/offset",Ry.offset);ae("/materials/{}/extensions/KHR_materials_iridescence/iridescenceThicknessTexture/extensions/KHR_texture_transform/rotation",Ry.rotation);ae("/materials/{}/extensions/KHR_materials_sheen/sheenColorFactor",[new It(q.ANIMATIONTYPE_COLOR3,"sheen.color",$o,()=>3)]);ae("/materials/{}/extensions/KHR_materials_sheen/sheenRoughnessFactor",[new It(q.ANIMATIONTYPE_FLOAT,"sheen.roughness",Lt,()=>1)]);by=Fi("sheen.texture");ae("/materials/{}/extensions/KHR_materials_sheen/sheenColorTexture/extensions/KHR_texture_transform/scale",by.scale);ae("/materials/{}/extensions/KHR_materials_sheen/sheenColorTexture/extensions/KHR_texture_transform/offset",by.offset);ae("/materials/{}/extensions/KHR_materials_sheen/sheenColorTexture/extensions/KHR_texture_transform/rotation",by.rotation);Cy=Fi("sheen.textureRoughness");ae("/materials/{}/extensions/KHR_materials_sheen/sheenRoughnessTexture/extensions/KHR_texture_transform/scale",Cy.scale);ae("/materials/{}/extensions/KHR_materials_sheen/sheenRoughnessTexture/extensions/KHR_texture_transform/offset",Cy.offset);ae("/materials/{}/extensions/KHR_materials_sheen/sheenRoughnessTexture/extensions/KHR_texture_transform/rotation",Cy.rotation);ae("/materials/{}/extensions/KHR_materials_specular/specularFactor",[new It(q.ANIMATIONTYPE_FLOAT,"metallicF0Factor",Lt,()=>1)]);ae("/materials/{}/extensions/KHR_materials_specular/specularColorFactor",[new It(q.ANIMATIONTYPE_COLOR3,"metallicReflectanceColor",$o,()=>3)]);Iy=Fi("metallicReflectanceTexture");ae("/materials/{}/extensions/KHR_materials_specular/specularTexture/extensions/KHR_texture_transform/scale",Iy.scale);ae("/materials/{}/extensions/KHR_materials_specular/specularTexture/extensions/KHR_texture_transform/offset",Iy.offset);ae("/materials/{}/extensions/KHR_materials_specular/specularTexture/extensions/KHR_texture_transform/rotation",Iy.rotation);yy=Fi("reflectanceTexture");ae("/materials/{}/extensions/KHR_materials_specular/specularColorTexture/extensions/KHR_texture_transform/scale",yy.scale);ae("/materials/{}/extensions/KHR_materials_specular/specularColorTexture/extensions/KHR_texture_transform/offset",yy.offset);ae("/materials/{}/extensions/KHR_materials_specular/specularColorTexture/extensions/KHR_texture_transform/rotation",yy.rotation);ae("/materials/{}/extensions/KHR_materials_transmission/transmissionFactor",[new It(q.ANIMATIONTYPE_FLOAT,"subSurface.refractionIntensity",Lt,()=>1)]);My=Fi("subSurface.refractionIntensityTexture");ae("/materials/{}/extensions/KHR_materials_transmission/transmissionTexture/extensions/KHR_texture_transform/scale",My.scale);ae("/materials/{}/extensions/KHR_materials_transmission/transmissionTexture/extensions/KHR_texture_transform/offset",My.offset);ae("/materials/{}/extensions/KHR_materials_transmission/transmissionTexture/extensions/KHR_texture_transform/rotation",My.rotation);ae("/materials/{}/extensions/KHR_materials_volume/attenuationColor",[new It(q.ANIMATIONTYPE_COLOR3,"subSurface.tintColor",$o,()=>3)]);ae("/materials/{}/extensions/KHR_materials_volume/attenuationDistance",[new It(q.ANIMATIONTYPE_FLOAT,"subSurface.tintColorAtDistance",Lt,()=>1)]);ae("/materials/{}/extensions/KHR_materials_volume/thicknessFactor",[new It(q.ANIMATIONTYPE_FLOAT,"subSurface.maximumThickness",Lt,()=>1)]);Py=Fi("subSurface.thicknessTexture");ae("/materials/{}/extensions/KHR_materials_volume/thicknessTexture/extensions/KHR_texture_transform/scale",Py.scale);ae("/materials/{}/extensions/KHR_materials_volume/thicknessTexture/extensions/KHR_texture_transform/offset",Py.offset);ae("/materials/{}/extensions/KHR_materials_volume/thicknessTexture/extensions/KHR_texture_transform/rotation",Py.rotation);ae("/materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionFactor",[new It(q.ANIMATIONTYPE_FLOAT,"subSurface.translucencyIntensity",Lt,()=>1)]);Dy=Fi("subSurface.translucencyIntensityTexture");ae("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionTexture/extensions/KHR_texture_transform/scale",Dy.scale);ae("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionTexture/extensions/KHR_texture_transform/offset",Dy.offset);ae("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionTexture/extensions/KHR_texture_transform/rotation",Dy.rotation);ae("/materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionColorFactor",[new It(q.ANIMATIONTYPE_COLOR3,"subSurface.translucencyColor",$o,()=>3)]);Oy=Fi("subSurface.translucencyColorTexture");ae("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionColorTexture/extensions/KHR_texture_transform/scale",Oy.scale);ae("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionColorTexture/extensions/KHR_texture_transform/offset",Oy.offset);ae("materials/{}/extensions/KHR_materials_diffuse_transmission/diffuseTransmissionColorTexture/extensions/KHR_texture_transform/rotation",Oy.rotation);ae("/extensions/KHR_lights_punctual/lights/{}/color",[new $a(q.ANIMATIONTYPE_COLOR3,"diffuse",$o,()=>3)]);ae("/extensions/KHR_lights_punctual/lights/{}/intensity",[new $a(q.ANIMATIONTYPE_FLOAT,"intensity",Lt,()=>1)]);ae("/extensions/KHR_lights_punctual/lights/{}/range",[new $a(q.ANIMATIONTYPE_FLOAT,"range",Lt,()=>1)]);ae("/extensions/KHR_lights_punctual/lights/{}/spot/innerConeAngle",[new $a(q.ANIMATIONTYPE_FLOAT,"innerAngle",Pk,()=>1)]);ae("/extensions/KHR_lights_punctual/lights/{}/spot/outerConeAngle",[new $a(q.ANIMATIONTYPE_FLOAT,"angle",Pk,()=>1)]);ae("/nodes/{}/extensions/EXT_lights_ies/color",[new $a(q.ANIMATIONTYPE_COLOR3,"diffuse",$o,()=>3)]);ae("/nodes/{}/extensions/EXT_lights_ies/multiplier",[new $a(q.ANIMATIONTYPE_FLOAT,"intensity",Lt,()=>1)])});var Ok={};V(Ok,{KHR_animation_pointer:()=>Lg});var Og,Lg,Lk=S(()=>{Ee();mt();Za();Dk();Og="KHR_animation_pointer",Lg=class{constructor(e){this.name=Og,this._loader=e,this._pathToObjectConverter=pg(this._loader.gltf)}get enabled(){return this._loader.isExtensionUsed(Og)}dispose(){this._loader=null,delete this._pathToObjectConverter}_loadAnimationChannelAsync(e,t,i,r,n){let a=r.target.extensions?.KHR_animation_pointer;if(!a||!this._pathToObjectConverter)return null;r.target.path!=="pointer"&&P.Warn(`${e}/target/path: Value (${r.target.path}) must be (pointer) when using the ${this.name} extension`),r.target.node!=null&&P.Warn(`${e}/target/node: Value (${r.target.node}) must not be present when using the ${this.name} extension`);let o=`${e}/extensions/${this.name}`,l=a.pointer;if(!l)throw new Error(`${o}: Pointer is missing`);try{let c=this._pathToObjectConverter.convert(l);if(!c.info.interpolation)throw new Error(`${o}/pointer: Interpolation is missing`);return this._loader._loadAnimationChannelFromTargetInfoAsync(e,t,i,r,{object:c.object,info:c.info.interpolation},n)}catch{return P.Warn(`${o}/pointer: Invalid pointer (${l}) skipped`),null}}};Ce(Og);te(Og,!0,s=>new Lg(s))});function wg(s,e,t,i,r){let n=s,a=null,o=null,l=null;try{a=new n.Decoder,o=new n.DecoderBuffer,o.Init(e,e.byteLength);let c,f=a.GetEncodedGeometryType(o);switch(f){case n.TRIANGULAR_MESH:{let d=new n.Mesh;if(c=a.DecodeBufferToMesh(o,d),!c.ok()||d.ptr===0)throw new Error(c.error_msg());let m=d.num_faces()*3,_=m*4,v=n._malloc(_);try{a.GetTrianglesUInt32Array(d,_,v);let T=new Uint32Array(m);T.set(new Uint32Array(n.HEAPF32.buffer,v,m)),i(T)}finally{n._free(v)}l=d;break}case n.POINT_CLOUD:{let d=new n.PointCloud;if(c=a.DecodeBufferToPointCloud(o,d),!c.ok()||!d.ptr)throw new Error(c.error_msg());l=d;break}default:throw new Error(`Invalid geometry type ${f}`)}let h=l.num_points(),u=(d,p,m,_)=>{let v=_.data_type(),T=_.num_components(),C=_.normalized(),I=_.byte_stride(),R=_.byte_offset(),M={[n.DT_FLOAT32]:{typedArrayConstructor:Float32Array,heap:n.HEAPF32},[n.DT_INT8]:{typedArrayConstructor:Int8Array,heap:n.HEAP8},[n.DT_INT16]:{typedArrayConstructor:Int16Array,heap:n.HEAP16},[n.DT_INT32]:{typedArrayConstructor:Int32Array,heap:n.HEAP32},[n.DT_UINT8]:{typedArrayConstructor:Uint8Array,heap:n.HEAPU8},[n.DT_UINT16]:{typedArrayConstructor:Uint16Array,heap:n.HEAPU16},[n.DT_UINT32]:{typedArrayConstructor:Uint32Array,heap:n.HEAPU32}}[v];if(!M)throw new Error(`Invalid data type ${v}`);let F=h*T,U=F*M.typedArrayConstructor.BYTES_PER_ELEMENT,D=n._malloc(U);try{d.GetAttributeDataArrayForAllPoints(p,_,v,U,D);let $=new M.typedArrayConstructor(M.heap.buffer,D,F);r(m,$.slice(),T,R,I,C)}finally{n._free(D)}};if(t)for(let d in t){let p=t[d],m=a.GetAttributeByUniqueId(l,p);u(a,l,d,m)}else{let d={position:n.POSITION,normal:n.NORMAL,color:n.COLOR,uv:n.TEX_COORD};for(let p in d){let m=a.GetAttributeId(l,d[p]);if(m!==-1){let _=a.GetAttribute(l,m);u(a,l,p,_)}}}return h}finally{l&&n.destroy(l),o&&n.destroy(o),a&&n.destroy(a)}}function wk(){let s;onmessage=e=>{let t=e.data;switch(t.id){case"init":{t.url&&importScripts(t.url);let i=t.wasmBinary?{wasmBinary:t.wasmBinary}:{};s=DracoDecoderModule(i),postMessage({id:"initDone"});break}case"decodeMesh":{if(!s)throw new Error("Draco decoder module is not available");s.then(i=>{let r=wg(i,t.dataView,t.attributes,n=>{postMessage({id:"indices",data:n},[n.buffer])},(n,a,o,l,c,f)=>{postMessage({id:"attribute",kind:n,data:a,size:o,byteOffset:l,byteStride:c,normalized:f},[a.buffer])});postMessage({id:"decodeMeshDone",totalVertices:r})});break}}}}async function Fk(s,e,t){return await new Promise((i,r)=>{let n=o=>{s.removeEventListener("error",n),s.removeEventListener("message",a),r(o)},a=o=>{o.data.id==="initDone"&&(s.removeEventListener("error",n),s.removeEventListener("message",a),i(s))};if(s.addEventListener("error",n),s.addEventListener("message",a),!e)s.postMessage({id:"init",url:t});else{let o=e.slice(0);s.postMessage({id:"init",url:t,wasmBinary:o},[o])}})}var Ly=S(()=>{});function Tte(){return typeof navigator!="object"||!navigator.hardwareConcurrency?1:Math.min(Math.floor(navigator.hardwareConcurrency*.5),4)}function Nk(s){return!!(s.wasmUrl&&(s.wasmBinary||s.wasmBinaryUrl)&&typeof WebAssembly=="object"||s.fallbackUrl)}var Fg,Bk=S(()=>{$e();Nb();Ly();Fg=class{constructor(e){if(e.workerPool){this._workerPoolPromise=Promise.resolve(e.workerPool);return}let t=e.wasmBinary,i=e.numWorkers??Tte(),r=i&&typeof Worker=="function"&&typeof URL=="function",n=r||!e.jsModule,a=e.wasmUrl&&e.wasmBinaryUrl&&typeof WebAssembly=="object"?{url:n?W.GetBabylonScriptURL(e.wasmUrl,!0):"",wasmBinaryPromise:t?Promise.resolve(t):W.LoadFileAsync(W.GetBabylonScriptURL(e.wasmBinaryUrl,!0))}:{url:n?W.GetBabylonScriptURL(e.fallbackUrl):"",wasmBinaryPromise:Promise.resolve(void 0)};r?this._workerPoolPromise=a.wasmBinaryPromise.then(o=>{let l=this._getWorkerContent(),c=URL.createObjectURL(new Blob([l],{type:"application/javascript"}));return new Ol(i,()=>{let f=new Worker(c);return Fk(f,o,a.url)})}):this._modulePromise=a.wasmBinaryPromise.then(async o=>{if(!this._isModuleAvailable()&&!e.jsModule){if(!a.url)throw new Error("Draco codec module is not available");await W.LoadBabylonScriptAsync(a.url)}return await this._createModuleAsync(o,e.jsModule)})}async whenReadyAsync(){if(this._workerPoolPromise){await this._workerPoolPromise;return}if(this._modulePromise){await this._modulePromise;return}}dispose(){this._workerPoolPromise&&this._workerPoolPromise.then(e=>{e.dispose()}),delete this._workerPoolPromise,delete this._modulePromise}}});var wy=S(()=>{yt()});var jl,Uk=S(()=>{Bk();$e();ou();wy();Ee();Ly();jl=class s extends Fg{static get DefaultAvailable(){return Nk(s.DefaultConfiguration)}static get Default(){return s._Default??(s._Default=new s),s._Default}static ResetDefault(e){s._Default&&(e||s._Default.dispose(),s._Default=null)}_isModuleAvailable(){return typeof DracoDecoderModule<"u"}async _createModuleAsync(e,t){return{module:await(t||DracoDecoderModule)({wasmBinary:e})}}_getWorkerContent(){return`${wg}(${wk})()`}constructor(e=s.DefaultConfiguration){super(e)}decodeMeshToMeshDataAsync(e,t,i){let r=e instanceof ArrayBuffer?new Int8Array(e):new Int8Array(e.buffer,e.byteOffset,e.byteLength),n=(a,o)=>i&&i[a]!==void 0?(o!==i[a]&&P.Warn(`Normalized flag from Draco data (${o}) does not match normalized flag from glTF accessor (${i[a]}). Using flag from glTF accessor.`),i[a]):o;if(this._workerPoolPromise)return this._workerPoolPromise.then(async a=>await new Promise((o,l)=>{a.push((c,f)=>{let h=null,u=[],d=_=>{c.removeEventListener("error",d),c.removeEventListener("message",p),l(_),f()},p=_=>{let v=_.data;switch(v.id){case"indices":{h=v.data;break}case"attribute":{u.push({kind:v.kind,data:v.data,size:v.size,byteOffset:v.byteOffset,byteStride:v.byteStride,normalized:n(v.kind,v.normalized)});break}case"decodeMeshDone":{c.removeEventListener("error",d),c.removeEventListener("message",p),o({indices:h,attributes:u,totalVertices:v.totalVertices}),f();break}}};c.addEventListener("error",d),c.addEventListener("message",p);let m=r.slice();c.postMessage({id:"decodeMesh",dataView:m,attributes:t},[m.buffer])})}));if(this._modulePromise)return this._modulePromise.then(a=>{let o=null,l=[],c=wg(a.module,r,t,f=>{o=f},(f,h,u,d,p,m)=>{l.push({kind:f,data:h,size:u,byteOffset:d,byteStride:p,normalized:m})});return{indices:o,attributes:l,totalVertices:c}});throw new Error("Draco decoder module is not available")}async decodeMeshToGeometryAsync(e,t,i,r){let n=await this.decodeMeshToMeshDataAsync(i,r),a=new mi(e,t);n.indices&&a.setIndices(n.indices);for(let o of n.attributes)a.setVerticesBuffer(new A(t.getEngine(),o.data,o.kind,!1,void 0,o.byteStride,void 0,o.byteOffset,o.size,void 0,o.normalized,!0),n.totalVertices);return a}async _decodeMeshToGeometryForGltfAsync(e,t,i,r,n,a){let o=await this.decodeMeshToMeshDataAsync(i,r,n),l=new mi(e,t);a&&(l._boundingInfo=a,l.useBoundingInfoFromGeometry=!0),o.indices&&l.setIndices(o.indices);for(let c of o.attributes)l.setVerticesBuffer(new A(t.getEngine(),c.data,c.kind,!1,void 0,c.byteStride,void 0,c.byteOffset,c.size,void 0,c.normalized,!0),o.totalVertices);return l}};jl.DefaultConfiguration={wasmUrl:`${W._DefaultCdnUrl}/draco_wasm_wrapper_gltf.js`,wasmBinaryUrl:`${W._DefaultCdnUrl}/draco_decoder_gltf.wasm`,fallbackUrl:`${W._DefaultCdnUrl}/draco_decoder_gltf.js`};jl._Default=null});var Gk={};V(Gk,{KHR_draco_mesh_compression:()=>Bg});var Ng,Bg,Vk=S(()=>{Uk();yt();Nt();mt();Ng="KHR_draco_mesh_compression",Bg=class{constructor(e){this.name=Ng,this.useNormalizedFlagFromAccessor=!0,this._loader=e,this.enabled=jl.DefaultAvailable&&this._loader.isExtensionUsed(Ng)}dispose(){delete this.dracoDecoder,this._loader=null}_loadVertexDataAsync(e,t,i){return Pe.LoadExtensionAsync(e,t,this.name,async(r,n)=>{if(t.mode!=null&&t.mode!==4&&t.mode!==5)throw new Error(`${e}: Unsupported mode ${t.mode}`);let a={},o={},l=(f,h)=>{let u=n.attributes[f];if(u!=null&&(i._delayInfo=i._delayInfo||[],i._delayInfo.indexOf(h)===-1&&i._delayInfo.push(h),a[h]=u,this.useNormalizedFlagFromAccessor)){let d=ve.TryGet(this._loader.gltf.accessors,t.attributes[f]);d&&(o[h]=d.normalized||!1)}};l("POSITION",A.PositionKind),l("NORMAL",A.NormalKind),l("TANGENT",A.TangentKind),l("TEXCOORD_0",A.UVKind),l("TEXCOORD_1",A.UV2Kind),l("TEXCOORD_2",A.UV3Kind),l("TEXCOORD_3",A.UV4Kind),l("TEXCOORD_4",A.UV5Kind),l("TEXCOORD_5",A.UV6Kind),l("JOINTS_0",A.MatricesIndicesKind),l("WEIGHTS_0",A.MatricesWeightsKind),l("COLOR_0",A.ColorKind);let c=ve.Get(r,this._loader.gltf.bufferViews,n.bufferView);return c._dracoBabylonGeometry||(c._dracoBabylonGeometry=this._loader.loadBufferViewAsync(`/bufferViews/${c.index}`,c).then(async f=>{let h=this.dracoDecoder||jl.Default,u=ve.TryGet(this._loader.gltf.accessors,t.attributes.POSITION),d=!this._loader.parent.alwaysComputeBoundingBox&&!i.skeleton&&u?vg(u):null;return await h._decodeMeshToGeometryForGltfAsync(i.name,this._loader.babylonScene,f,a,o,d).catch(p=>{throw new Error(`${e}: ${p.message}`)})})),await c._dracoBabylonGeometry})}};Ce(Ng);te(Ng,!0,s=>new Bg(s))});var Xe,$r=S(()=>{Te();Xe=class s{constructor(e){this.value=this._toInt(e)}_toInt(e){return e|0}add(e){return new s(this.value+e.value)}subtract(e){return new s(this.value-e.value)}multiply(e){return new s(Math.imul(this.value,e.value))}divide(e){return new s(this.value/e.value)}getClassName(){return s.ClassName}equals(e){return this.value===e.value}static FromValue(e){return new s(e)}toString(){return this.value.toString()}};Xe.ClassName="FlowGraphInteger";G("FlowGraphInteger",Xe)});var Pr,Dr,qu=S(()=>{ie();Pr=class s{constructor(e=[1,0,0,1]){this._m=e}get m(){return this._m}transformVector(e){return this.transformVectorToRef(e,new he)}transformVectorToRef(e,t){return t.x=e.x*this._m[0]+e.y*this._m[1],t.y=e.x*this._m[2]+e.y*this._m[3],t}asArray(){return this.toArray()}toArray(e=[]){for(let t=0;t<4;t++)e[t]=this._m[t];return e}fromArray(e){for(let t=0;t<4;t++)this._m[t]=e[t];return this}multiplyToRef(e,t){let i=e._m,r=this._m,n=t._m;return n[0]=i[0]*r[0]+i[1]*r[2],n[1]=i[0]*r[1]+i[1]*r[3],n[2]=i[2]*r[0]+i[3]*r[2],n[3]=i[2]*r[1]+i[3]*r[3],t}multiply(e){return this.multiplyToRef(e,new s)}divideToRef(e,t){let i=this._m,r=e._m,n=t._m;return n[0]=i[0]/r[0],n[1]=i[1]/r[1],n[2]=i[2]/r[2],n[3]=i[3]/r[3],t}divide(e){return this.divideToRef(e,new s)}addToRef(e,t){let i=this._m,r=e.m,n=t.m;return n[0]=i[0]+r[0],n[1]=i[1]+r[1],n[2]=i[2]+r[2],n[3]=i[3]+r[3],t}add(e){return this.addToRef(e,new s)}subtractToRef(e,t){let i=this._m,r=e.m,n=t.m;return n[0]=i[0]-r[0],n[1]=i[1]-r[1],n[2]=i[2]-r[2],n[3]=i[3]-r[3],t}subtract(e){return this.subtractToRef(e,new s)}transpose(){let e=this._m;return new s([e[0],e[2],e[1],e[3]])}determinant(){let e=this._m;return e[0]*e[3]-e[1]*e[2]}inverse(){let e=this.determinant();if(e===0)throw new Error("Matrix is not invertible");let t=this._m,i=1/e;return new s([t[3]*i,-t[1]*i,-t[2]*i,t[0]*i])}equals(e,t=0){let i=this._m,r=e.m;return t===0?i[0]===r[0]&&i[1]===r[1]&&i[2]===r[2]&&i[3]===r[3]:Math.abs(i[0]-r[0])<t&&Math.abs(i[1]-r[1])<t&&Math.abs(i[2]-r[2])<t&&Math.abs(i[3]-r[3])<t}getClassName(){return"FlowGraphMatrix2D"}toString(){return`FlowGraphMatrix2D(${this._m.join(", ")})`}},Dr=class s{constructor(e=[1,0,0,0,1,0,0,0,1]){this._m=e}get m(){return this._m}transformVector(e){return this.transformVectorToRef(e,new E)}transformVectorToRef(e,t){let i=this._m;return t.x=e.x*i[0]+e.y*i[1]+e.z*i[2],t.y=e.x*i[3]+e.y*i[4]+e.z*i[5],t.z=e.x*i[6]+e.y*i[7]+e.z*i[8],t}multiplyToRef(e,t){let i=e._m,r=this._m,n=t.m;return n[0]=i[0]*r[0]+i[1]*r[3]+i[2]*r[6],n[1]=i[0]*r[1]+i[1]*r[4]+i[2]*r[7],n[2]=i[0]*r[2]+i[1]*r[5]+i[2]*r[8],n[3]=i[3]*r[0]+i[4]*r[3]+i[5]*r[6],n[4]=i[3]*r[1]+i[4]*r[4]+i[5]*r[7],n[5]=i[3]*r[2]+i[4]*r[5]+i[5]*r[8],n[6]=i[6]*r[0]+i[7]*r[3]+i[8]*r[6],n[7]=i[6]*r[1]+i[7]*r[4]+i[8]*r[7],n[8]=i[6]*r[2]+i[7]*r[5]+i[8]*r[8],t}multiply(e){return this.multiplyToRef(e,new s)}divideToRef(e,t){let i=this._m,r=e.m,n=t.m;return n[0]=i[0]/r[0],n[1]=i[1]/r[1],n[2]=i[2]/r[2],n[3]=i[3]/r[3],n[4]=i[4]/r[4],n[5]=i[5]/r[5],n[6]=i[6]/r[6],n[7]=i[7]/r[7],n[8]=i[8]/r[8],t}divide(e){return this.divideToRef(e,new s)}addToRef(e,t){let i=this._m,r=e.m,n=t.m;return n[0]=i[0]+r[0],n[1]=i[1]+r[1],n[2]=i[2]+r[2],n[3]=i[3]+r[3],n[4]=i[4]+r[4],n[5]=i[5]+r[5],n[6]=i[6]+r[6],n[7]=i[7]+r[7],n[8]=i[8]+r[8],t}add(e){return this.addToRef(e,new s)}subtractToRef(e,t){let i=this._m,r=e.m,n=t.m;return n[0]=i[0]-r[0],n[1]=i[1]-r[1],n[2]=i[2]-r[2],n[3]=i[3]-r[3],n[4]=i[4]-r[4],n[5]=i[5]-r[5],n[6]=i[6]-r[6],n[7]=i[7]-r[7],n[8]=i[8]-r[8],t}subtract(e){return this.subtractToRef(e,new s)}toArray(e=[]){for(let t=0;t<9;t++)e[t]=this._m[t];return e}asArray(){return this.toArray()}fromArray(e){for(let t=0;t<9;t++)this._m[t]=e[t];return this}transpose(){let e=this._m;return new s([e[0],e[3],e[6],e[1],e[4],e[7],e[2],e[5],e[8]])}determinant(){let e=this._m;return e[0]*(e[4]*e[8]-e[5]*e[7])-e[1]*(e[3]*e[8]-e[5]*e[6])+e[2]*(e[3]*e[7]-e[4]*e[6])}inverse(){let e=this.determinant();if(e===0)throw new Error("Matrix is not invertible");let t=this._m,i=1/e;return new s([(t[4]*t[8]-t[5]*t[7])*i,(t[2]*t[7]-t[1]*t[8])*i,(t[1]*t[5]-t[2]*t[4])*i,(t[5]*t[6]-t[3]*t[8])*i,(t[0]*t[8]-t[2]*t[6])*i,(t[2]*t[3]-t[0]*t[5])*i,(t[3]*t[7]-t[4]*t[6])*i,(t[1]*t[6]-t[0]*t[7])*i,(t[0]*t[4]-t[1]*t[3])*i])}equals(e,t=0){let i=this._m,r=e.m;return t===0?i[0]===r[0]&&i[1]===r[1]&&i[2]===r[2]&&i[3]===r[3]&&i[4]===r[4]&&i[5]===r[5]&&i[6]===r[6]&&i[7]===r[7]&&i[8]===r[8]:Math.abs(i[0]-r[0])<t&&Math.abs(i[1]-r[1])<t&&Math.abs(i[2]-r[2])<t&&Math.abs(i[3]-r[3])<t&&Math.abs(i[4]-r[4])<t&&Math.abs(i[5]-r[5])<t&&Math.abs(i[6]-r[6])<t&&Math.abs(i[7]-r[7])<t&&Math.abs(i[8]-r[8])<t}getClassName(){return"FlowGraphMatrix3D"}toString(){return`FlowGraphMatrix3D(${this._m.join(", ")})`}}});function Wk(s){let e=s;switch(typeof s){case"string":return Ug;case"number":return ue;case"boolean":return Bt;case"object":if(e.getClassName)switch(e.getClassName()){case"Vector2":return Us;case"Vector3":return kt;case"Vector4":return Qu;case"Matrix":return dn;case"Color3":return Fy;case"Color4":return Ny;case"Quaternion":return gr;case"FlowGraphInteger":return xt;case"Matrix2D":return ju;case"Matrix3D":return Zu}return Y;default:return Y}}function pt(s){switch(s){case"string":return Ug;case"number":return ue;case"boolean":return Bt;case"Vector2":return Us;case"Vector3":return kt;case"Vector4":return Qu;case"Matrix":return dn;case"Color3":return Fy;case"Color4":return Ny;case"Quaternion":return gr;case"FlowGraphInteger":return xt;case"Matrix2D":return ju;case"Matrix3D":return Zu;default:return Y}}function Hk(s){switch(s){case"number":return 0;case"Vector2":return 5;case"Vector3":return 1;case"Matrix":return 3;case"Color3":return 4;case"Color4":return 7;case"Quaternion":return 2;default:return 0}}function zk(s){switch(s){case 0:return ue;case 5:return Us;case 1:return kt;case 3:return dn;case 4:return Fy;case 7:return Ny;case 2:return gr;default:return Y}}var kk,er,Y,Ug,ue,Bt,Us,kt,Qu,dn,ju,Zu,Fy,Ny,gr,xt,Ze=S(()=>{ie();it();$r();qu();(function(s){s.Any="any",s.String="string",s.Number="number",s.Boolean="boolean",s.Object="object",s.Integer="FlowGraphInteger",s.Vector2="Vector2",s.Vector3="Vector3",s.Vector4="Vector4",s.Quaternion="Quaternion",s.Matrix="Matrix",s.Matrix2D="Matrix2D",s.Matrix3D="Matrix3D",s.Color3="Color3",s.Color4="Color4"})(kk||(kk={}));er=class{constructor(e,t,i=-1){this.typeName=e,this.defaultValue=t,this.animationType=i}serialize(e){e.typeName=this.typeName,e.defaultValue=this.defaultValue}},Y=new er("any",void 0),Ug=new er("string",""),ue=new er("number",0,0),Bt=new er("boolean",!1),Us=new er("Vector2",he.Zero(),5),kt=new er("Vector3",E.Zero(),1),Qu=new er("Vector4",Oe.Zero()),dn=new er("Matrix",B.Identity(),3),ju=new er("Matrix2D",new Pr),Zu=new er("Matrix3D",new Dr),Fy=new er("Color3",j.Black(),4),Ny=new er("Color4",new me(0,0,0,0),7),gr=new er("Quaternion",K.Identity(),2);gr.typeTransformer=s=>{if(s.getClassName){if(s.getClassName()==="Vector4")return K.FromArray(s.asArray());if(s.getClassName()==="Vector3")return K.FromEulerVector(s);if(s.getClassName()==="Matrix")return K.FromRotationMatrix(s)}return s};xt=new er("FlowGraphInteger",new Xe(0),0)});function xte(s){return s==="Mesh"||s==="AbstractMesh"||s==="GroundMesh"||s==="InstanceMesh"||s==="LinesMesh"||s==="GoldbergMesh"||s==="GreasedLineMesh"||s==="TrailMesh"}function Xk(s){return s==="Vector2"||s==="Vector3"||s==="Vector4"||s==="Quaternion"||s==="Color3"||s==="Color4"}function Ate(s){return s==="Matrix"||s==="Matrix2D"||s==="Matrix3D"}function Rte(s){return s==="AnimationGroup"}function bte(s,e,t=!1){if(s==="Vector2")return he.FromArray(e);if(s==="Vector3")return t&&(e[2]*=-1),E.FromArray(e);if(s==="Vector4")return Oe.FromArray(e);if(s==="Quaternion")return t&&(e[2]*=-1,e[3]*=-1),K.FromArray(e);if(s==="Color3")return new j(e[0],e[1],e[2]);if(s==="Color4")return new me(e[0],e[1],e[2],e[3]);throw new Error(`Unknown vector class name ${s}`)}function el(s,e,t){let i=e?.getClassName?.()??"";if(Xk(i)||Ate(i))t[s]={value:e.asArray(),className:i};else if(i==="FlowGraphInteger")t[s]={value:e.value,className:i};else if(i&&(e.id||e.name))t[s]={id:e.id,name:e.name,className:i};else if(typeof e!="object")t[s]=e;else throw new Error(`Could not serialize value ${e}`)}function Ju(s,e,t,i){let r=e[s],n,a=r?.type??r?.className;if(xte(a)){let o=i.meshes.filter(l=>r.id?l.id===r.id:l.name===r.name);o.length===0&&(o=i.transformNodes.filter(l=>r.id?l.id===r.id:l.name===r.name)),n=r.uniqueId?o.find(l=>l.uniqueId===r.uniqueId):o[0]}else if(Xk(a))n=bte(a,r.value);else if(Rte(a)){let o=i.animationGroups.filter(l=>l.name===r.name);n=o.length===1?o[0]:o.find(l=>l.uniqueId===r.uniqueId)}else a==="Matrix"?n=B.FromArray(r.value):a==="Matrix2D"?n=new Pr(r.value):a==="Matrix3D"?n=new Dr(r.value):a==="FlowGraphInteger"?n=Xe.FromValue(r.value):a==="number"||a==="string"||a==="boolean"?n=r.value[0]:r&&r.value!==void 0?n=r.value:Array.isArray(r)?n=r.reduce((o,l)=>(l.eventData&&(o[l.id]={type:pt(l.type)},typeof l.value<"u"&&(o[l.id].value=Ju("value",l,t,i))),o),{}):n=r;return n}function Yk(s){return s==="FlowGraphJsonPointerParserBlock"}var Hf=S(()=>{it();ie();$r();Ze();qu()});function Gg(s,e,t,i){switch(e){case"Animation":return i?s.animations.find(r=>r.uniqueId===t)??null:s.animations[t]??null;case"AnimationGroup":return i?s.animationGroups.find(r=>r.uniqueId===t)??null:s.animationGroups[t]??null;case"Mesh":return i?s.meshes.find(r=>r.uniqueId===t)??null:s.meshes[t]??null;case"Material":return i?s.materials.find(r=>r.uniqueId===t)??null:s.materials[t]??null;case"Camera":return i?s.cameras.find(r=>r.uniqueId===t)??null:s.cameras[t]??null;case"Light":return i?s.lights.find(r=>r.uniqueId===t)??null:s.lights[t]??null;default:return null}}var Kk,By=S(()=>{(function(s){s.Animation="Animation",s.AnimationGroup="AnimationGroup",s.Mesh="Mesh",s.Material="Material",s.Camera="Camera",s.Light="Light"})(Kk||(Kk={}))});var qk,Vg,Qk=S(()=>{Ee();(function(s){s.ExecuteBlock="ExecuteBlock",s.ExecuteEvent="ExecuteEvent",s.TriggerConnection="TriggerConnection",s.ContextVariableSet="ContextVariableSet",s.GlobalVariableSet="GlobalVariableSet",s.GlobalVariableDelete="GlobalVariableDelete",s.GlobalVariableGet="GlobalVariableGet",s.AddConnection="AddConnection",s.GetConnectionValue="GetConnectionValue",s.SetConnectionValue="SetConnectionValue",s.ActivateSignal="ActivateSignal",s.ContextVariableGet="ContextVariableGet"})(qk||(qk={}));Vg=class{constructor(){this.logToConsole=!1,this.log=[]}addLogItem(e){if(e.time||(e.time=Date.now()),this.log.push(e),this.logToConsole){let t=e.payload?.value;typeof t=="object"&&t.getClassName?P.Log(`[FGLog] ${e.className}:${e.uniqueId.split("-")[0]} ${e.action} - ${JSON.stringify(t.getClassName())}: ${t.toString()}`):P.Log(`[FGLog] ${e.className}:${e.uniqueId.split("-")[0]} ${e.action} - ${JSON.stringify(e.payload)}`)}}getItemsOfType(e){return this.log.filter(t=>t.action===e)}}});var $u,jk=S(()=>{Ye();je();pa();Hf();we();By();Qk();$u=class{get enableLogging(){return this._enableLogging}set enableLogging(e){this._enableLogging!==e&&(this._enableLogging=e,this._enableLogging?(this.logger=new Vg,this.logger.logToConsole=!0):this.logger=null)}constructor(e){this.uniqueId=Vi(),this._userVariables={},this._executionVariables={},this._globalContextVariables={},this._connectionValues={},this._pendingBlocks=[],this._executionId=0,this.onNodeExecutedObservable=new N,this.treatDataAsRightHanded=!1,this._enableLogging=!1,this._configuration=e,this.assetsContext=e.assetsContext??e.scene}hasVariable(e){return e in this._userVariables}setVariable(e,t){this._userVariables[e]=t,this.logger?.addLogItem({time:Date.now(),className:this.getClassName(),uniqueId:this.uniqueId,action:"ContextVariableSet",payload:{name:e,value:t}})}getAsset(e,t){return Gg(this.assetsContext,e,t)}getVariable(e){return this.logger?.addLogItem({time:Date.now(),className:this.getClassName(),uniqueId:this.uniqueId,action:"ContextVariableGet",payload:{name:e,value:this._userVariables[e]}}),this._userVariables[e]}get userVariables(){return this._userVariables}getScene(){return this._configuration.scene}_getUniqueIdPrefixedName(e,t){return`${e.uniqueId}_${t}`}_getGlobalContextVariable(e,t){return this.logger?.addLogItem({time:Date.now(),className:this.getClassName(),uniqueId:this.uniqueId,action:"GlobalVariableGet",payload:{name:e,defaultValue:t,possibleValue:this._globalContextVariables[e]}}),this._hasGlobalContextVariable(e)?this._globalContextVariables[e]:t}_setGlobalContextVariable(e,t){this.logger?.addLogItem({time:Date.now(),className:this.getClassName(),uniqueId:this.uniqueId,action:"GlobalVariableSet",payload:{name:e,value:t}}),this._globalContextVariables[e]=t}_deleteGlobalContextVariable(e){this.logger?.addLogItem({time:Date.now(),className:this.getClassName(),uniqueId:this.uniqueId,action:"GlobalVariableDelete",payload:{name:e}}),delete this._globalContextVariables[e]}_hasGlobalContextVariable(e){return e in this._globalContextVariables}_setExecutionVariable(e,t,i){this._executionVariables[this._getUniqueIdPrefixedName(e,t)]=i}_getExecutionVariable(e,t,i){return this._hasExecutionVariable(e,t)?this._executionVariables[this._getUniqueIdPrefixedName(e,t)]:i}_deleteExecutionVariable(e,t){delete this._executionVariables[this._getUniqueIdPrefixedName(e,t)]}_hasExecutionVariable(e,t){return this._getUniqueIdPrefixedName(e,t)in this._executionVariables}_hasConnectionValue(e){return e.uniqueId in this._connectionValues}_setConnectionValue(e,t){this._connectionValues[e.uniqueId]=t,this.logger?.addLogItem({time:Date.now(),className:this.getClassName(),uniqueId:this.uniqueId,action:"SetConnectionValue",payload:{connectionPointId:e.uniqueId,value:t}})}_setConnectionValueByKey(e,t){this._connectionValues[e]=t}_getConnectionValue(e){return this.logger?.addLogItem({time:Date.now(),className:this.getClassName(),uniqueId:this.uniqueId,action:"GetConnectionValue",payload:{connectionPointId:e.uniqueId,value:this._connectionValues[e.uniqueId]}}),this._connectionValues[e.uniqueId]}get configuration(){return this._configuration}get hasPendingBlocks(){return this._pendingBlocks.length>0}_addPendingBlock(e){this._pendingBlocks.includes(e)||(this._pendingBlocks.push(e),this._pendingBlocks.sort((t,i)=>t.priority-i.priority))}_removePendingBlock(e){let t=this._pendingBlocks.indexOf(e);t!==-1&&this._pendingBlocks.splice(t,1)}_clearPendingBlocks(){for(let e of this._pendingBlocks)e._cancelPendingTasks(this);this._pendingBlocks.length=0}_notifyExecuteNode(e){this.onNodeExecutedObservable.notifyObservers(e),this.logger?.addLogItem({time:Date.now(),className:e.getClassName(),uniqueId:e.uniqueId,action:"ExecuteBlock"})}_notifyOnTick(e){this._setGlobalContextVariable("timeSinceStart",e.timeSinceStart),this._setGlobalContextVariable("deltaTime",e.deltaTime);for(let t of this._pendingBlocks)t._executeOnTick?.(this)}_increaseExecutionId(){this._executionId++}get executionId(){return this._executionId}serialize(e={},t=el){e.uniqueId=this.uniqueId,e._userVariables={};for(let i in this._userVariables)t(i,this._userVariables[i],e._userVariables);e._connectionValues={};for(let i in this._connectionValues)t(i,this._connectionValues[i],e._connectionValues);this.assetsContext!==this.getScene()&&(e._assetsContext={meshes:this.assetsContext.meshes.map(i=>i.id),materials:this.assetsContext.materials.map(i=>i.id),textures:this.assetsContext.textures.map(i=>i.name),animations:this.assetsContext.animations.map(i=>i.name),lights:this.assetsContext.lights.map(i=>i.id),cameras:this.assetsContext.cameras.map(i=>i.id),sounds:this.assetsContext.sounds?.map(i=>i.name),skeletons:this.assetsContext.skeletons.map(i=>i.id),particleSystems:this.assetsContext.particleSystems.map(i=>i.name),geometries:this.assetsContext.geometries.map(i=>i.id),multiMaterials:this.assetsContext.multiMaterials.map(i=>i.id),transformNodes:this.assetsContext.transformNodes.map(i=>i.id)})}getClassName(){return"FlowGraphContext"}};x([y()],$u.prototype,"uniqueId",void 0)});var Zk,zf,Uy=S(()=>{pa();(function(s){s[s.Input=0]="Input",s[s.Output=1]="Output"})(Zk||(Zk={}));zf=class{constructor(e,t,i){this._ownerBlock=i,this._connectedPoint=[],this.uniqueId=Vi(),this.connectedPointIds=[],this.name=e,this._connectionType=t}get connectionType(){return this._connectionType}_isSingularConnection(){return!0}isConnected(){return this._connectedPoint.length>0}connectTo(e){if(this._connectionType===e._connectionType)throw new Error(`Cannot connect two points of type ${this.connectionType}`);if(this._isSingularConnection()&&this._connectedPoint.length>0||e._isSingularConnection()&&e._connectedPoint.length>0)throw new Error("Max number of connections for point reached");this._connectedPoint.push(e),e._connectedPoint.push(this)}disconnectFrom(e,t=!0){let i=this._connectedPoint.indexOf(e),r=e._connectedPoint.indexOf(this);i===-1||r===-1||(t&&this._connectedPoint.splice(i,1),e._connectedPoint.splice(r,1))}disconnectFromAll(){for(let e of this._connectedPoint)this.disconnectFrom(e,!1);this._connectedPoint.length=0}dispose(){for(let e of this._connectedPoint)this.disconnectFrom(e)}serialize(e={}){e.uniqueId=this.uniqueId,e.name=this.name,e._connectionType=this._connectionType,e.connectedPointIds=[],e.className=this.getClassName();for(let t of this._connectedPoint)e.connectedPointIds.push(t.uniqueId)}getClassName(){return"FGConnection"}deserialize(e){this.uniqueId=e.uniqueId,this.name=e.name,this._connectionType=e._connectionType,this.connectedPointIds=e.connectedPointIds}}});var Xf,Jk=S(()=>{Te();Uy();we();Hf();Xf=class extends zf{constructor(e,t,i,r,n=r.defaultValue,a=!1){super(e,t,i),this.richType=r,this._defaultValue=n,this._optional=a,this._isDisabled=!1,this._lastValue=null,this.dataTransformer=null,this.onValueChangedObservable=new N}get optional(){return this._optional}get isDisabled(){return this._isDisabled}set isDisabled(e){this._isDisabled!==e&&(this._isDisabled=e,this._isDisabled&&this.disconnectFromAll())}_isSingularConnection(){return this.connectionType===0}setValue(e,t){t._getConnectionValue(this)!==e&&(t._setConnectionValue(this,e),this.onValueChangedObservable.notifyObservers(e))}resetToDefaultValue(e){e._setConnectionValue(this,this._defaultValue)}connectTo(e){this._isDisabled||super.connectTo(e)}_getValueOrDefault(e){let t=e._getConnectionValue(this)??this._defaultValue;return this.dataTransformer?this.dataTransformer(t):t}getValue(e){if(this.connectionType===1){e._notifyExecuteNode(this._ownerBlock),this._ownerBlock._updateOutputs(e);let i=this._getValueOrDefault(e);return this._lastValue=i,this.richType.typeTransformer?this.richType.typeTransformer(i):i}let t=this.isConnected()?this._connectedPoint[0].getValue(e):this._getValueOrDefault(e);return this._lastValue=t,this.richType.typeTransformer?this.richType.typeTransformer(t):t}_getLastValue(){return this._lastValue}getClassName(){return"FlowGraphDataConnection"}serialize(e={}){super.serialize(e),e.richType={},this.richType.serialize(e.richType),e.optional=this._optional,el("defaultValue",this._defaultValue,e)}};G("FlowGraphDataConnection",Xf)});var ht,_i=S(()=>{pa();Jk();Hf();ht=class{constructor(e){this.config=e,this.uniqueId=Vi(),this.name=this.config?.name??this.getClassName(),this.dataInputs=[],this.dataOutputs=[]}_updateOutputs(e){}registerDataInput(e,t,i){let r=new Xf(e,0,this,t,i);return this.dataInputs.push(r),r}registerDataOutput(e,t,i){let r=new Xf(e,1,this,t,i);return this.dataOutputs.push(r),r}getDataInput(e){return this.dataInputs.find(t=>t.name===e)}getDataOutput(e){return this.dataOutputs.find(t=>t.name===e)}serialize(e={},t=el){if(e.uniqueId=this.uniqueId,e.config={},this.config){let i=this.config,r=Object.keys(i);for(let n of r)t(n,i[n],e.config)}e.dataInputs=[],e.dataOutputs=[],e.className=this.getClassName();for(let i of this.dataInputs){let r={};i.serialize(r),e.dataInputs.push(r)}for(let i of this.dataOutputs){let r={};i.serialize(r),e.dataOutputs.push(r)}}deserialize(e){}_log(e,t,i){e.logger?.addLogItem({action:t,payload:i,className:this.getClassName(),uniqueId:this.uniqueId})}getClassName(){return"FlowGraphBlock"}}});var Yf,$k=S(()=>{Uy();Te();Yf=class extends zf{constructor(){super(...arguments),this.priority=0}_isSingularConnection(){return!1}connectTo(e){super.connectTo(e),this._connectedPoint.sort((t,i)=>i.priority-t.priority)}_activateSignal(e){if(e.logger?.addLogItem({action:"ActivateSignal",className:this._ownerBlock.getClassName(),uniqueId:this._ownerBlock.uniqueId,payload:{connectionType:this.connectionType,name:this.name}}),this.connectionType===0)e._notifyExecuteNode(this._ownerBlock),this._ownerBlock._execute(e,this),e._increaseExecutionId();else for(let t of this._connectedPoint)t._activateSignal(e)}};G("FlowGraphSignalConnection",Yf)});var Ni,eo=S(()=>{_i();$k();Ni=class extends ht{constructor(e){super(e),this.priority=0,this.signalInputs=[],this.signalOutputs=[],this.in=this._registerSignalInput("in"),this.error=this._registerSignalOutput("error")}_registerSignalInput(e){let t=new Yf(e,0,this);return this.signalInputs.push(t),t}_registerSignalOutput(e){let t=new Yf(e,1,this);return this.signalOutputs.push(t),t}_unregisterSignalInput(e){let t=this.signalInputs.findIndex(i=>i.name===e);t!==-1&&(this.signalInputs[t].dispose(),this.signalInputs.splice(t,1))}_unregisterSignalOutput(e){let t=this.signalOutputs.findIndex(i=>i.name===e);t!==-1&&(this.signalOutputs[t].dispose(),this.signalOutputs.splice(t,1))}_reportError(e,t){this.error.payload=typeof t=="string"?new Error(t):t,this.error._activateSignal(e)}getSignalInput(e){return this.signalInputs.find(t=>t.name===e)}getSignalOutput(e){return this.signalOutputs.find(t=>t.name===e)}serialize(e={}){super.serialize(e),e.signalInputs=[],e.signalOutputs=[];for(let t of this.signalInputs){let i={};t.serialize(i),e.signalInputs.push(i)}for(let t of this.signalOutputs){let i={};t.serialize(i),e.signalOutputs.push(i)}}deserialize(e){for(let t=0;t<e.signalInputs.length;t++){let i=this.getSignalInput(e.signalInputs[t].name);if(i)i.deserialize(e.signalInputs[t]);else throw new Error("Could not find signal input with name "+e.signalInputs[t].name+" in block "+e.className)}for(let t=0;t<e.signalOutputs.length;t++){let i=this.getSignalOutput(e.signalOutputs[t].name);if(i)i.deserialize(e.signalOutputs[t]);else throw new Error("Could not find signal output with name "+e.signalOutputs[t].name+" in block "+e.className)}}getClassName(){return"FlowGraphExecutionBlock"}}});var kg,e4=S(()=>{ns();we();kg=class{constructor(e){this.onEventTriggeredObservable=new N,this.sceneReadyTriggered=!1,this._pointerUnderMeshState={},this._startingTime=0,this._scene=e,this._initialize()}_initialize(){this._sceneReadyObserver=this._scene.onReadyObservable.add(()=>{this.sceneReadyTriggered||(this.onEventTriggeredObservable.notifyObservers({type:"SceneReady"}),this.sceneReadyTriggered=!0)}),this._sceneDisposeObserver=this._scene.onDisposeObservable.add(()=>{this.onEventTriggeredObservable.notifyObservers({type:"SceneDispose"})}),this._sceneOnBeforeRenderObserver=this._scene.onBeforeRenderObservable.add(()=>{let e=this._scene.getEngine().getDeltaTime()/1e3;this.onEventTriggeredObservable.notifyObservers({type:"SceneBeforeRender",payload:{timeSinceStart:this._startingTime,deltaTime:e}}),this._startingTime+=e}),this._meshPickedObserver=this._scene.onPointerObservable.add(e=>{this.onEventTriggeredObservable.notifyObservers({type:"MeshPick",payload:e})},ce.POINTERPICK),this._meshUnderPointerObserver=this._scene.onMeshUnderPointerUpdatedObservable.add(e=>{let t=e.pointerId,i=e.mesh,r=this._pointerUnderMeshState[t];!r&&i?this.onEventTriggeredObservable.notifyObservers({type:"PointerOver",payload:{pointerId:t,mesh:i}}):r&&!i?this.onEventTriggeredObservable.notifyObservers({type:"PointerOut",payload:{pointerId:t,mesh:r}}):r&&i&&r!==i&&(this.onEventTriggeredObservable.notifyObservers({type:"PointerOut",payload:{pointerId:t,mesh:r,over:i}}),this.onEventTriggeredObservable.notifyObservers({type:"PointerOver",payload:{pointerId:t,mesh:i,out:r}})),this._pointerUnderMeshState[t]=i},ce.POINTERMOVE)}dispose(){this._sceneDisposeObserver?.remove(),this._sceneReadyObserver?.remove(),this._sceneOnBeforeRenderObserver?.remove(),this._meshPickedObserver?.remove(),this._meshUnderPointerObserver?.remove(),this.onEventTriggeredObservable.clear()}}});function pn(s,e){return!!(s.parent&&(s.parent===e||pn(s.parent,e)))}function Bi(s){if(s.getClassName)return s.getClassName()}function Kf(s,e){return s===e&&(s==="Vector2"||s==="Vector3"||s==="Vector4"||s==="Quaternion")}function qf(s,e){return s===e&&(s==="Matrix"||s==="Matrix2D"||s==="Matrix3D")}function Qf(s,e){return s==="FlowGraphInteger"&&e==="FlowGraphInteger"}function to(s,e){let t=typeof s=="number"||typeof s?.value=="number";return t&&!e?!isNaN(At(s)):t}function At(s){return typeof s=="number"?s:s.value}var us=S(()=>{});var t4,Wg,i4=S(()=>{we();jk();eo();e4();us();(function(s){s[s.Stopped=0]="Stopped",s[s.Started=1]="Started"})(t4||(t4={}));Wg=class{get state(){return this._state}set state(e){this._state=e,this.onStateChangedObservable.notifyObservers(e)}constructor(e){this.onStateChangedObservable=new N,this._eventBlocks={SceneReady:[],SceneDispose:[],SceneBeforeRender:[],MeshPick:[],PointerDown:[],PointerUp:[],PointerMove:[],PointerOver:[],PointerOut:[],SceneAfterRender:[],NoTrigger:[]},this._executionContexts=[],this._state=0,this._scene=e.scene,this._sceneEventCoordinator=new kg(this._scene),this._coordinator=e.coordinator,this._eventObserver=this._sceneEventCoordinator.onEventTriggeredObservable.add(t=>{for(let i of this._executionContexts){let r=this._getContextualOrder(t.type,i);for(let n of r)if(!n._executeEvent(i,t.payload))break}switch(t.type){case"SceneReady":this._sceneEventCoordinator.sceneReadyTriggered=!0;break;case"SceneBeforeRender":for(let i of this._executionContexts)i._notifyOnTick(t.payload);break;case"SceneDispose":this.dispose();break}})}createContext(){let e=new $u({scene:this._scene,coordinator:this._coordinator});return this._executionContexts.push(e),e}getContext(e){return this._executionContexts[e]}addEventBlock(e){if((e.type==="PointerOver"||e.type==="PointerOut")&&(this._scene.constantlyUpdateMeshUnderPointer=!0),e.type!=="NoTrigger"&&this._eventBlocks[e.type].push(e),this.state===1)for(let t of this._executionContexts)e._startPendingTasks(t);else this.onStateChangedObservable.addOnce(t=>{if(t===1)for(let i of this._executionContexts)e._startPendingTasks(i)})}start(){this.state!==1&&(this._executionContexts.length===0&&this.createContext(),this.onStateChangedObservable.add(e=>{e===1&&(this._startPendingEvents(),this._scene.isReady(!0)&&this._sceneEventCoordinator.onEventTriggeredObservable.notifyObservers({type:"SceneReady"}))}),this.state=1)}_startPendingEvents(){for(let e of this._executionContexts)for(let t in this._eventBlocks){let i=this._getContextualOrder(t,e);for(let r of i)r._startPendingTasks(e)}}_getContextualOrder(e,t){let i=this._eventBlocks[e].sort((r,n)=>n.initPriority-r.initPriority);if(e==="MeshPick"){let r=[];for(let n of i){let a=n.asset.getValue(t),o=0;for(;o<i.length;o++){let c=i[o].asset.getValue(t);if(a&&c&&pn(a,c))break}r.splice(o,0,n)}return r}return i}dispose(){if(this.state!==0){this.state=0;for(let e of this._executionContexts)e._clearPendingBlocks();this._executionContexts.length=0;for(let e in this._eventBlocks)this._eventBlocks[e].length=0;this._eventObserver?.remove(),this._sceneEventCoordinator.dispose()}}visitAllBlocks(e){let t=[],i=new Set;for(let r in this._eventBlocks)for(let n of this._eventBlocks[r])t.push(n),i.add(n.uniqueId);for(;t.length>0;){let r=t.pop();e(r);for(let n of r.dataInputs)for(let a of n._connectedPoint)i.has(a._ownerBlock.uniqueId)||(t.push(a._ownerBlock),i.add(a._ownerBlock.uniqueId));if(r instanceof Ni)for(let n of r.signalOutputs)for(let a of n._connectedPoint)i.has(a._ownerBlock.uniqueId)||(t.push(a._ownerBlock),i.add(a._ownerBlock.uniqueId))}}serialize(e={},t){e.allBlocks=[],this.visitAllBlocks(i=>{let r={};i.serialize(r),e.allBlocks.push(r)}),e.executionContexts=[];for(let i of this._executionContexts){let r={};i.serialize(r,t),e.executionContexts.push(r)}}}});var mn,Hg=S(()=>{we();i4();Ee();mn=class s{constructor(e){this.config=e,this.dispatchEventsSynchronously=!0,this._flowGraphs=[],this._customEventsMap=new Map,this._eventExecutionCounter=new Map,this._executeOnNextFrame=[],this._eventUniqueId=0,this._disposeObserver=this.config.scene.onDisposeObservable.add(()=>{this.dispose()}),this._onBeforeRenderObserver=this.config.scene.onBeforeRenderObservable.add(()=>{this._eventExecutionCounter.clear();let i=this._executeOnNextFrame.slice(0);if(i.length)for(let r of i){this.notifyCustomEvent(r.id,r.data,!1);let n=this._executeOnNextFrame.findIndex(a=>a.uniqueId===r.uniqueId);n!==-1&&this._executeOnNextFrame.splice(n,1)}}),(s.SceneCoordinators.get(this.config.scene)??[]).push(this)}createGraph(){let e=new Wg({scene:this.config.scene,coordinator:this});return this._flowGraphs.push(e),e}removeGraph(e){let t=this._flowGraphs.indexOf(e);t!==-1&&(e.dispose(),this._flowGraphs.splice(t,1))}start(){for(let e of this._flowGraphs)e.start()}dispose(){for(let i of this._flowGraphs)i.dispose();this._flowGraphs.length=0,this._disposeObserver?.remove(),this._onBeforeRenderObserver?.remove();let e=s.SceneCoordinators.get(this.config.scene)??[],t=e.indexOf(this);t!==-1&&e.splice(t,1)}serialize(e,t){e._flowGraphs=[];for(let i of this._flowGraphs){let r={};i.serialize(r,t),e._flowGraphs.push(r)}e.dispatchEventsSynchronously=this.dispatchEventsSynchronously}get flowGraphs(){return this._flowGraphs}getCustomEventObservable(e){let t=this._customEventsMap.get(e);return t||(t=new N,this._customEventsMap.set(e,t)),t}notifyCustomEvent(e,t,i=!this.dispatchEventsSynchronously){if(i){this._executeOnNextFrame.push({id:e,data:t,uniqueId:this._eventUniqueId++});return}if(this._eventExecutionCounter.has(e)){let n=this._eventExecutionCounter.get(e);if(this._eventExecutionCounter.set(e,n+1),n>=s.MaxEventTypeExecutionPerFrame){n===s.MaxEventTypeExecutionPerFrame&&P.Warn(`FlowGraphCoordinator: Too many executions of event "${e}".`);return}}else this._eventExecutionCounter.set(e,1);let r=this._customEventsMap.get(e);r&&r.notifyObservers(t)}};mn.MaxEventsPerType=30;mn.MaxEventTypeExecutionPerFrame=30;mn.SceneCoordinators=new Map});var Vt,Or=S(()=>{eo();Vt=class extends Ni{constructor(e){super(e),this.out=this._registerSignalOutput("out")}}});var jn,ed=S(()=>{Or();jn=class extends Vt{constructor(e,t){if(super(e),this._eventsSignalOutputs={},this.done=this._registerSignalOutput("done"),t)for(let i of t)this._eventsSignalOutputs[i]=this._registerSignalOutput(i+"Event")}_executeOnTick(e){}_startPendingTasks(e){e._getExecutionVariable(this,"_initialized",!1)&&(this._cancelPendingTasks(e),this._resetAfterCanceled(e)),this._preparePendingTasks(e),e._addPendingBlock(this),this.out._activateSignal(e),e._setExecutionVariable(this,"_initialized",!0)}_resetAfterCanceled(e){e._deleteExecutionVariable(this,"_initialized"),e._removePendingBlock(this)}}});var r4={};V(r4,{FlowGraphPlayAnimationBlock:()=>zg});var zg,s4=S(()=>{ed();Ze();Te();oy();zg=class extends jn{constructor(e){super(e,["animationLoop","animationEnd","animationGroupLoop"]),this.config=e,this.speed=this.registerDataInput("speed",ue),this.loop=this.registerDataInput("loop",Bt),this.from=this.registerDataInput("from",ue,0),this.to=this.registerDataInput("to",ue),this.currentFrame=this.registerDataOutput("currentFrame",ue),this.currentTime=this.registerDataOutput("currentTime",ue),this.currentAnimationGroup=this.registerDataOutput("currentAnimationGroup",Y),this.animationGroup=this.registerDataInput("animationGroup",Y,e?.animationGroup),this.animation=this.registerDataInput("animation",Y),this.object=this.registerDataInput("object",Y)}_preparePendingTasks(e){let t=this.animationGroup.getValue(e),i=this.animation.getValue(e);if(!t&&!i)return this._reportError(e,"No animation or animation group provided");{let r=this.currentAnimationGroup.getValue(e);r&&r!==t&&r.dispose();let n=t;if(i&&!n){let h=this.object.getValue(e);if(!h)return this._reportError(e,"No target object provided");let u=Array.isArray(i)?i:[i],d=u[0].name;n=new Ku("flowGraphAnimationGroup-"+d+"-"+h.name,e.configuration.scene);let p=!1,m=e._getGlobalContextVariable("interpolationAnimations",[]);for(let _ of u)n.addTargetedAnimation(_,h),m.indexOf(_.uniqueId)!==-1&&(p=!0);p&&this._checkInterpolationDuplications(e,u,h)}let a=this.speed.getValue(e)||1,o=this.from.getValue(e)??0,l=this.to.getValue(e)||n.to,c=!isFinite(l)||this.loop.getValue(e);this.currentAnimationGroup.setValue(n,e);let f=e._getGlobalContextVariable("currentlyRunningAnimationGroups",[]);f.indexOf(n.uniqueId)!==-1&&n.stop();try{n.start(c,a,o,l),n.onAnimationGroupEndObservable.add(()=>this._onAnimationGroupEnd(e)),n.onAnimationEndObservable.add(()=>this._eventsSignalOutputs.animationEnd._activateSignal(e)),n.onAnimationLoopObservable.add(()=>this._eventsSignalOutputs.animationLoop._activateSignal(e)),n.onAnimationGroupLoopObservable.add(()=>this._eventsSignalOutputs.animationGroupLoop._activateSignal(e)),f.push(n.uniqueId),e._setGlobalContextVariable("currentlyRunningAnimationGroups",f)}catch(h){this._reportError(e,h)}}}_reportError(e,t){super._reportError(e,t),this.currentFrame.setValue(-1,e),this.currentTime.setValue(-1,e)}_executeOnTick(e){let t=this.currentAnimationGroup.getValue(e);t&&(this.currentFrame.setValue(t.getCurrentFrame(),e),this.currentTime.setValue(t.animatables[0]?.elapsedTime??0,e))}_execute(e){this._startPendingTasks(e)}_onAnimationGroupEnd(e){this._removeFromCurrentlyRunning(e,this.currentAnimationGroup.getValue(e)),this._resetAfterCanceled(e),this.done._activateSignal(e)}_checkInterpolationDuplications(e,t,i){let r=e._getGlobalContextVariable("currentlyRunningAnimationGroups",[]);for(let n of r){let a=e.assetsContext.animationGroups.find(o=>o.uniqueId===n);if(a)for(let o of a.targetedAnimations)for(let l of t)o.animation.targetProperty===l.targetProperty&&o.target===i&&this._stopAnimationGroup(e,a)}}_stopAnimationGroup(e,t){t.stop(!0),t.dispose(),this._removeFromCurrentlyRunning(e,t)}_removeFromCurrentlyRunning(e,t){let i=e._getGlobalContextVariable("currentlyRunningAnimationGroups",[]),r=i.indexOf(t.uniqueId);r!==-1&&(i.splice(r,1),e._setGlobalContextVariable("currentlyRunningAnimationGroups",i))}_cancelPendingTasks(e){let t=this.currentAnimationGroup.getValue(e);t&&this._stopAnimationGroup(e,t)}getClassName(){return"FlowGraphPlayAnimationBlock"}};G("FlowGraphPlayAnimationBlock",zg)});var n4={};V(n4,{FlowGraphStopAnimationBlock:()=>Xg});var Xg,a4=S(()=>{Ze();Te();Ee();ed();Xg=class extends jn{constructor(e){super(e),this.animationGroup=this.registerDataInput("animationGroup",Y),this.stopAtFrame=this.registerDataInput("stopAtFrame",ue,-1)}_preparePendingTasks(e){let t=this.animationGroup.getValue(e),i=this.stopAtFrame.getValue(e)??-1,r=e._getGlobalContextVariable("pendingStopAnimations",[]);r.push({uniqueId:t.uniqueId,stopAtFrame:i}),e._setGlobalContextVariable("pendingStopAnimations",r)}_cancelPendingTasks(e){let t=this.animationGroup.getValue(e),i=e._getGlobalContextVariable("pendingStopAnimations",[]);for(let r=0;r<i.length;r++)if(i[r].uniqueId===t.uniqueId){i.splice(r,1),e._setGlobalContextVariable("pendingStopAnimations",i);break}}_execute(e){let t=this.animationGroup.getValue(e),i=this.stopAtFrame.getValue(e)??-1;if(!t)return P.Warn("No animation group provided to stop."),this._reportError(e,"No animation group provided to stop.");if(isNaN(i))return this._reportError(e,"Invalid stop time.");i>0?this._startPendingTasks(e):this._stopAnimation(t,e),this.out._activateSignal(e)}_executeOnTick(e){let t=this.animationGroup.getValue(e),i=e._getGlobalContextVariable("pendingStopAnimations",[]);for(let r=0;r<i.length;r++)if(i[r].uniqueId===t.uniqueId&&t.getCurrentFrame()>=i[r].stopAtFrame){this._stopAnimation(t,e),i.splice(r,1),e._setGlobalContextVariable("pendingStopAnimations",i),this.done._activateSignal(e),e._removePendingBlock(this);break}}getClassName(){return"FlowGraphStopAnimationBlock"}_stopAnimation(e,t){let i=t._getGlobalContextVariable("currentlyRunningAnimationGroups",[]),r=i.indexOf(e.uniqueId);r!==-1&&(e.stop(),i.splice(r,1),t._setGlobalContextVariable("currentlyRunningAnimationGroups",i))}};G("FlowGraphStopAnimationBlock",Xg)});var o4={};V(o4,{FlowGraphPauseAnimationBlock:()=>Yg});var Yg,l4=S(()=>{Or();Ze();Te();Yg=class extends Vt{constructor(e){super(e),this.animationToPause=this.registerDataInput("animationToPause",Y)}_execute(e){this.animationToPause.getValue(e).pause(),this.out._activateSignal(e)}getClassName(){return"FlowGraphPauseAnimationBlock"}};G("FlowGraphPauseAnimationBlock",Yg)});var c4={};V(c4,{FlowGraphInterpolationBlock:()=>Kg});var Kg,f4=S(()=>{_i();Ze();ws();Te();Kg=class extends ht{constructor(e={}){super(e),this.keyFrames=[];let t=typeof e?.animationType=="string"?pt(e.animationType):zk(e?.animationType??0),i=e?.keyFramesCount??1,r=this.registerDataInput("duration_0",ue,0),n=this.registerDataInput("value_0",t);this.keyFrames.push({duration:r,value:n});for(let a=1;a<i+1;a++){let o=this.registerDataInput(`duration_${a}`,ue,a===i?e.duration:void 0),l=this.registerDataInput(`value_${a}`,t);this.keyFrames.push({duration:o,value:l})}this.initialValue=this.keyFrames[0].value,this.endValue=this.keyFrames[i].value,this.easingFunction=this.registerDataInput("easingFunction",Y),this.animation=this.registerDataOutput("animation",Y),this.propertyName=this.registerDataInput("propertyName",Y,e?.propertyName),this.customBuildAnimation=this.registerDataInput("customBuildAnimation",Y)}_updateOutputs(e){let t=e._getGlobalContextVariable("interpolationAnimations",[]),i=this.propertyName.getValue(e),r=this.easingFunction.getValue(e),n=this._createAnimation(e,i,r);if(this.animation.setValue(n,e),Array.isArray(n))for(let a of n)t.push(a.uniqueId);else t.push(n.uniqueId);e._setGlobalContextVariable("interpolationAnimations",t)}_createAnimation(e,t,i){let r=this.initialValue.richType,n=[],a=this.initialValue.getValue(e)||r.defaultValue;n.push({frame:0,value:a});let o=this.config?.numberOfKeyFrames??1;for(let c=1;c<o+1;c++){let f=this.keyFrames[c].duration?.getValue(e),h=this.keyFrames[c].value?.getValue(e);c===o-1&&(h=h||r.defaultValue),f!==void 0&&h&&n.push({frame:f*60,value:h})}let l=this.customBuildAnimation.getValue(e);if(l)return l(null,null,e)(n,60,r.animationType,i);if(typeof t=="string"){let c=q.CreateAnimation(t,r.animationType,60,i);return c.setKeys(n),[c]}else return t.map(f=>{let h=q.CreateAnimation(f,r.animationType,60,i);return h.setKeys(n),h})}getClassName(){return"FlowGraphInterpolationBlock"}};G("FlowGraphInterpolationBlock",Kg)});var vr,tl=S(()=>{ed();vr=class extends jn{constructor(){super(...arguments),this.initPriority=0,this.type="NoTrigger"}_execute(e){e._notifyExecuteNode(this),this.done._activateSignal(e)}}});var h4={};V(h4,{FlowGraphSceneReadyEventBlock:()=>qg});var qg,u4=S(()=>{tl();Te();qg=class extends vr{constructor(){super(...arguments),this.initPriority=-1,this.type="SceneReady"}_executeEvent(e,t){return this._execute(e),!0}_preparePendingTasks(e){}_cancelPendingTasks(e){}getClassName(){return"FlowGraphSceneReadyEventBlock"}};G("FlowGraphSceneReadyEventBlock",qg)});var d4={};V(d4,{FlowGraphSceneTickEventBlock:()=>Qg});var Qg,p4=S(()=>{tl();Te();Ze();Qg=class extends vr{constructor(){super(),this.type="SceneBeforeRender",this.timeSinceStart=this.registerDataOutput("timeSinceStart",ue),this.deltaTime=this.registerDataOutput("deltaTime",ue)}_preparePendingTasks(e){}_executeEvent(e,t){return this.timeSinceStart.setValue(t.timeSinceStart,e),this.deltaTime.setValue(t.deltaTime,e),this._execute(e),!0}_cancelPendingTasks(e){}getClassName(){return"FlowGraphSceneTickEventBlock"}};G("FlowGraphSceneTickEventBlock",Qg)});var m4={};V(m4,{FlowGraphSendCustomEventBlock:()=>jg});var jg,_4=S(()=>{Or();Te();jg=class extends Vt{constructor(e){super(e),this.config=e;for(let t in this.config.eventData)this.registerDataInput(t,this.config.eventData[t].type,this.config.eventData[t].value)}_execute(e){let t=this.config.eventId,i={};for(let r of this.dataInputs)i[r.name]=r.getValue(e);e.configuration.coordinator.notifyCustomEvent(t,i),this.out._activateSignal(e)}getClassName(){return"FlowGraphReceiveCustomEventBlock"}};G("FlowGraphReceiveCustomEventBlock",jg)});var g4={};V(g4,{FlowGraphReceiveCustomEventBlock:()=>Zg});var Zg,v4=S(()=>{tl();$e();Te();Hg();Zg=class extends vr{constructor(e){super(e),this.config=e,this.initPriority=1;for(let t in this.config.eventData)this.registerDataOutput(t,this.config.eventData[t].type)}_preparePendingTasks(e){let t=e.configuration.coordinator.getCustomEventObservable(this.config.eventId);if(t&&t.hasObservers()&&t.observers.length>mn.MaxEventsPerType){this._reportError(e,`FlowGraphReceiveCustomEventBlock: Too many observers for event ${this.config.eventId}. Max is ${mn.MaxEventsPerType}.`);return}let i=t.add(r=>{let n=Object.keys(r);for(let a of n)this.getDataOutput(a)?.setValue(r[a],e);this._execute(e)});e._setExecutionVariable(this,"_eventObserver",i)}_cancelPendingTasks(e){let t=e.configuration.coordinator.getCustomEventObservable(this.config.eventId);if(t){let i=e._getExecutionVariable(this,"_eventObserver",null);t.remove(i)}else W.Warn(`FlowGraphReceiveCustomEventBlock: Missing observable for event ${this.config.eventId}`)}_executeEvent(e,t){return!0}getClassName(){return"FlowGraphReceiveCustomEventBlock"}};G("FlowGraphReceiveCustomEventBlock",Zg)});var S4={};V(S4,{FlowGraphMeshPickEventBlock:()=>Jg});var Jg,E4=S(()=>{tl();ns();Te();us();Ze();Jg=class extends vr{constructor(e){super(e),this.config=e,this.type="MeshPick",this.asset=this.registerDataInput("asset",Y,e?.targetMesh),this.pickedPoint=this.registerDataOutput("pickedPoint",kt),this.pickOrigin=this.registerDataOutput("pickOrigin",kt),this.pointerId=this.registerDataOutput("pointerId",ue),this.pickedMesh=this.registerDataOutput("pickedMesh",Y),this.pointerType=this.registerDataInput("pointerType",Y,ce.POINTERPICK)}_getReferencedMesh(e){return this.asset.getValue(e)}_executeEvent(e,t){if(this.pointerType.getValue(e)!==t.type)return!0;let r=this._getReferencedMesh(e);return r&&t.pickInfo?.pickedMesh&&(t.pickInfo?.pickedMesh===r||pn(t.pickInfo?.pickedMesh,r))?(this.pointerId.setValue(t.event.pointerId,e),this.pickOrigin.setValue(t.pickInfo.ray?.origin,e),this.pickedPoint.setValue(t.pickInfo.pickedPoint,e),this.pickedMesh.setValue(t.pickInfo.pickedMesh,e),this._execute(e),!this.config?.stopPropagation):(this.pointerId.resetToDefaultValue(e),this.pickOrigin.resetToDefaultValue(e),this.pickedPoint.resetToDefaultValue(e),this.pickedMesh.resetToDefaultValue(e),!0)}_preparePendingTasks(e){}_cancelPendingTasks(e){}getClassName(){return"FlowGraphMeshPickEventBlock"}};G("FlowGraphMeshPickEventBlock",Jg)});var T4,x4,Sr,il=S(()=>{_i();Ze();T4="cachedOperationValue",x4="cachedExecutionId",Sr=class extends ht{constructor(e,t){super(t),this.value=this.registerDataOutput("value",e),this.isValid=this.registerDataOutput("isValid",Bt)}_updateOutputs(e){let t=e._getExecutionVariable(this,x4,-1),i=e._getExecutionVariable(this,T4,null);if(i!=null&&t===e.executionId)this.isValid.setValue(!0,e),this.value.setValue(i,e);else try{let r=this._doOperation(e);if(r==null){this.isValid.setValue(!1,e);return}e._setExecutionVariable(this,T4,r),e._setExecutionVariable(this,x4,e.executionId),this.value.setValue(r,e),this.isValid.setValue(!0,e)}catch{this.isValid.setValue(!1,e)}}}});var Dt,$g=S(()=>{il();Dt=class extends Sr{constructor(e,t,i,r,n,a){super(i,a),this._operation=r,this._className=n,this.a=this.registerDataInput("a",e),this.b=this.registerDataInput("b",t)}_doOperation(e){let t=this.a.getValue(e),i=this.b.getValue(e);return this._operation(t,i)}getClassName(){return this._className}}});var rl,A4=S(()=>{il();rl=class extends Sr{constructor(e,t,i,r){super(e,r),this._operation=t,this._className=i}_doOperation(e){return this._operation(e)}getClassName(){return this._className}}});var qe,td=S(()=>{il();qe=class extends Sr{constructor(e,t,i,r,n){super(t,n),this._operation=i,this._className=r,this.a=this.registerDataInput("a",e)}_doOperation(e){return this._operation(this.a.getValue(e))}getClassName(){return this._className}}});var id,R4=S(()=>{il();id=class extends Sr{constructor(e,t,i,r,n,a,o){super(r,o),this._operation=n,this._className=a,this.a=this.registerDataInput("a",e),this.b=this.registerDataInput("b",t),this.c=this.registerDataInput("c",i)}_doOperation(e){return this._operation(this.a.getValue(e),this.b.getValue(e),this.c.getValue(e))}getClassName(){return this._className}}});var Be={};V(Be,{FlowGraphAbsBlock:()=>cv,FlowGraphAcosBlock:()=>Lv,FlowGraphAcoshBlock:()=>Vv,FlowGraphAddBlock:()=>ev,FlowGraphAsinBlock:()=>Ov,FlowGraphAsinhBlock:()=>Gv,FlowGraphAtan2Block:()=>Fv,FlowGraphAtanBlock:()=>wv,FlowGraphAtanhBlock:()=>kv,FlowGraphBitwiseAndBlock:()=>jv,FlowGraphBitwiseLeftShiftBlock:()=>$v,FlowGraphBitwiseNotBlock:()=>Qv,FlowGraphBitwiseOrBlock:()=>Zv,FlowGraphBitwiseRightShiftBlock:()=>eS,FlowGraphBitwiseXorBlock:()=>Jv,FlowGraphCeilBlock:()=>dv,FlowGraphClampBlock:()=>Ev,FlowGraphCosBlock:()=>Vy,FlowGraphCoshBlock:()=>Bv,FlowGraphCubeRootBlock:()=>Kv,FlowGraphDegToRadBlock:()=>Pv,FlowGraphDivideBlock:()=>rv,FlowGraphEBlock:()=>nv,FlowGraphEqualityBlock:()=>Av,FlowGraphExpBlock:()=>Wv,FlowGraphFloorBlock:()=>uv,FlowGraphFractionBlock:()=>mv,FlowGraphGreaterThanBlock:()=>Cv,FlowGraphGreaterThanOrEqualBlock:()=>Iv,FlowGraphInfBlock:()=>ov,FlowGraphIsInfinityBlock:()=>Mv,FlowGraphIsNanBlock:()=>yv,FlowGraphLeadingZerosBlock:()=>tS,FlowGraphLessThanBlock:()=>Rv,FlowGraphLessThanOrEqualBlock:()=>bv,FlowGraphLog10Block:()=>Xv,FlowGraphLog2Block:()=>zv,FlowGraphLogBlock:()=>Hv,FlowGraphMathInterpolationBlock:()=>xv,FlowGraphMaxBlock:()=>Sv,FlowGraphMinBlock:()=>vv,FlowGraphModuloBlock:()=>gv,FlowGraphMultiplyBlock:()=>iv,FlowGraphNaNBlock:()=>lv,FlowGraphNegationBlock:()=>_v,FlowGraphOneBitsCounterBlock:()=>rS,FlowGraphPiBlock:()=>av,FlowGraphPowerBlock:()=>qv,FlowGraphRadToDegBlock:()=>Dv,FlowGraphRandomBlock:()=>sv,FlowGraphRoundBlock:()=>pv,FlowGraphSaturateBlock:()=>Tv,FlowGraphSignBlock:()=>fv,FlowGraphSinBlock:()=>Gy,FlowGraphSinhBlock:()=>Nv,FlowGraphSquareRootBlock:()=>Yv,FlowGraphSubtractBlock:()=>tv,FlowGraphTanBlock:()=>ky,FlowGraphTanhBlock:()=>Uv,FlowGraphTrailingZerosBlock:()=>iS,FlowGraphTruncBlock:()=>hv});function Wt(s,e){switch(Bi(s)){case"FlowGraphInteger":return s=s,new Xe(e(s.value));case"Vector2":return s=s,new he(e(s.x),e(s.y));case"Vector3":return s=s,new E(e(s.x),e(s.y),e(s.z));case"Vector4":return s=s,new Oe(e(s.x),e(s.y),e(s.z),e(s.w));case"Quaternion":return s=s,new K(e(s.x),e(s.y),e(s.z),e(s.w));case"Matrix":return s=s,B.FromArray(s.m.map(e));case"Matrix2D":return s=s,new Pr(s.m.map(e));case"Matrix3D":return s=s,new Dr(s.m.map(e));default:return s=s,e(s)}}function rd(s,e,t){switch(Bi(s)){case"FlowGraphInteger":return s=s,e=e,new Xe(t(s.value,e.value));case"Vector2":return s=s,e=e,new he(t(s.x,e.x),t(s.y,e.y));case"Vector3":return s=s,e=e,new E(t(s.x,e.x),t(s.y,e.y),t(s.z,e.z));case"Vector4":return s=s,e=e,new Oe(t(s.x,e.x),t(s.y,e.y),t(s.z,e.z),t(s.w,e.w));case"Quaternion":return s=s,e=e,new K(t(s.x,e.x),t(s.y,e.y),t(s.z,e.z),t(s.w,e.w));case"Matrix":return s=s,B.FromArray(s.m.map((r,n)=>t(r,e.m[n])));case"Matrix2D":return s=s,new Pr(s.m.map((r,n)=>t(r,e.m[n])));case"Matrix3D":return s=s,new Dr(s.m.map((r,n)=>t(r,e.m[n])));default:return t(At(s),At(e))}}function Cte(s,e,t){return Math.min(Math.max(s,Math.min(e,t)),Math.max(e,t))}function b4(s,e,t,i){switch(Bi(s)){case"FlowGraphInteger":return s=s,e=e,t=t,new Xe(i(s.value,e.value,t.value));case"Vector2":return s=s,e=e,t=t,new he(i(s.x,e.x,t.x),i(s.y,e.y,t.y));case"Vector3":return s=s,e=e,t=t,new E(i(s.x,e.x,t.x),i(s.y,e.y,t.y),i(s.z,e.z,t.z));case"Vector4":return s=s,e=e,t=t,new Oe(i(s.x,e.x,t.x),i(s.y,e.y,t.y),i(s.z,e.z,t.z),i(s.w,e.w,t.w));case"Quaternion":return s=s,e=e,t=t,new K(i(s.x,e.x,t.x),i(s.y,e.y,t.y),i(s.z,e.z,t.z),i(s.w,e.w,t.w));case"Matrix":return B.FromArray(s.m.map((n,a)=>i(n,e.m[a],t.m[a])));case"Matrix2D":return new Pr(s.m.map((n,a)=>i(n,e.m[a],t.m[a])));case"Matrix3D":return new Dr(s.m.map((n,a)=>i(n,e.m[a],t.m[a])));default:return i(At(s),At(e),At(t))}}function Ite(s){return Math.min(Math.max(s,0),1)}function yte(s,e,t){return(1-t)*s+t*e}function sS(s,e,t){if(to(s)&&to(e))return t(At(s),At(e));throw new Error(`Cannot compare ${s} and ${e}`)}function Mte(s){let e=0;for(;s;)e+=s&1,s>>=1;return e}var ev,tv,iv,rv,sv,nv,av,ov,lv,cv,fv,hv,uv,dv,pv,mv,_v,gv,vv,Sv,Ev,Tv,xv,Av,Rv,bv,Cv,Iv,yv,Mv,Pv,Dv,Gy,Vy,ky,Ov,Lv,wv,Fv,Nv,Bv,Uv,Gv,Vv,kv,Wv,Hv,zv,Xv,Yv,Kv,qv,Qv,jv,Zv,Jv,$v,eS,tS,iS,rS,Ue=S(()=>{Te();Ze();$g();A4();ie();td();R4();$r();qu();us();ev=class extends Dt{constructor(e){super(pt(e?.type),pt(e?.type),pt(e?.type),(t,i)=>this._polymorphicAdd(t,i),"FlowGraphAddBlock",e)}_polymorphicAdd(e,t){let i=Bi(e),r=Bi(t);if(Kf(i,r)||qf(i,r)||Qf(i,r))return e.add(t);if(i==="Quaternion"||r==="Vector4")return new Oe(e.x,e.y,e.z,e.w).addInPlace(t);if(i==="Vector4"||r==="Quaternion")return e.add(t);if(this.config?.preventIntegerFloatArithmetic&&typeof e!=typeof t)throw new Error("Cannot add different types of numbers.");return At(e)+At(t)}};G("FlowGraphAddBlock",ev);tv=class extends Dt{constructor(e){super(pt(e?.type),pt(e?.type),pt(e?.type),(t,i)=>this._polymorphicSubtract(t,i),"FlowGraphSubtractBlock",e)}_polymorphicSubtract(e,t){let i=Bi(e),r=Bi(t);if(Kf(i,r)||Qf(i,r)||qf(i,r))return e.subtract(t);if(i==="Quaternion"||r==="Vector4")return new Oe(e.x,e.y,e.z,e.w).subtractInPlace(t);if(i==="Vector4"||r==="Quaternion")return e.subtract(t);if(this.config?.preventIntegerFloatArithmetic&&typeof e!=typeof t)throw new Error("Cannot add different types of numbers.");return At(e)-At(t)}};G("FlowGraphSubtractBlock",tv);iv=class extends Dt{constructor(e){super(pt(e?.type),pt(e?.type),pt(e?.type),(t,i)=>this._polymorphicMultiply(t,i),"FlowGraphMultiplyBlock",e)}_polymorphicMultiply(e,t){let i=Bi(e),r=Bi(t);if(Kf(i,r)||Qf(i,r))return e.multiply(t);if(i==="Quaternion"||r==="Vector4")return new Oe(e.x,e.y,e.z,e.w).multiplyInPlace(t);if(i==="Vector4"||r==="Quaternion")return e.multiply(t);if(qf(i,r))if(this.config?.useMatrixPerComponent){let n=e.m;for(let a=0;a<n.length;a++)n[a]*=t.m[a];return i==="Matrix2D"?new Pr(n):i==="Matrix3D"?new Dr(n):B.FromArray(n)}else return e=e,t=t,t.multiply(e);else{if(this.config?.preventIntegerFloatArithmetic&&typeof e!=typeof t)throw new Error("Cannot add different types of numbers.");return At(e)*At(t)}}};G("FlowGraphMultiplyBlock",iv);rv=class extends Dt{constructor(e){super(pt(e?.type),pt(e?.type),pt(e?.type),(t,i)=>this._polymorphicDivide(t,i),"FlowGraphDivideBlock",e)}_polymorphicDivide(e,t){let i=Bi(e),r=Bi(t);if(Kf(i,r)||Qf(i,r))return e.divide(t);if(i==="Quaternion"||r==="Quaternion"){let n=e.clone();return n.x/=t.x,n.y/=t.y,n.z/=t.z,n.w/=t.w,n}else{if(i==="Quaternion"||r==="Vector4")return new Oe(e.x,e.y,e.z,e.w).divideInPlace(t);if(i==="Vector4"||r==="Quaternion")return e.divide(t);if(qf(i,r))if(this.config?.useMatrixPerComponent){let n=e.m;for(let a=0;a<n.length;a++)n[a]/=t.m[a];return i==="Matrix2D"?new Pr(n):i==="Matrix3D"?new Dr(n):B.FromArray(n)}else return e=e,t=t,e.divide(t);else{if(this.config?.preventIntegerFloatArithmetic&&typeof e!=typeof t)throw new Error("Cannot add different types of numbers.");return At(e)/At(t)}}}};G("FlowGraphDivideBlock",rv);sv=class extends rl{constructor(e){super(ue,t=>this._random(t),"FlowGraphRandomBlock",e),this.min=this.registerDataInput("min",ue,e?.min??0),this.max=this.registerDataInput("max",ue,e?.max??1),e?.seed&&(this._seed=e.seed)}_isSeed(e=this._seed){return e!==void 0}_getRandomValue(){if(this._isSeed(this._seed)){let e=Math.sin(this._seed++)*1e4;return e-Math.floor(e)}return Math.random()}_random(e){let t=this.min.getValue(e),i=this.max.getValue(e);return this._getRandomValue()*(i-t)+t}};G("FlowGraphRandomBlock",sv);nv=class extends rl{constructor(e){super(ue,()=>Math.E,"FlowGraphEBlock",e)}};G("FlowGraphEBlock",nv);av=class extends rl{constructor(e){super(ue,()=>Math.PI,"FlowGraphPIBlock",e)}};G("FlowGraphPIBlock",av);ov=class extends rl{constructor(e){super(ue,()=>Number.POSITIVE_INFINITY,"FlowGraphInfBlock",e)}};G("FlowGraphInfBlock",ov);lv=class extends rl{constructor(e){super(ue,()=>Number.NaN,"FlowGraphNaNBlock",e)}};G("FlowGraphNaNBlock",lv);cv=class extends qe{constructor(e){super(ue,ue,t=>this._polymorphicAbs(t),"FlowGraphAbsBlock",e)}_polymorphicAbs(e){return Wt(e,Math.abs)}};G("FlowGraphAbsBlock",cv);fv=class extends qe{constructor(e){super(ue,ue,t=>this._polymorphicSign(t),"FlowGraphSignBlock",e)}_polymorphicSign(e){return Wt(e,Math.sign)}};G("FlowGraphSignBlock",fv);hv=class extends qe{constructor(e){super(ue,ue,t=>this._polymorphicTrunc(t),"FlowGraphTruncBlock",e)}_polymorphicTrunc(e){return Wt(e,Math.trunc)}};G("FlowGraphTruncBlock",hv);uv=class extends qe{constructor(e){super(ue,ue,t=>this._polymorphicFloor(t),"FlowGraphFloorBlock",e)}_polymorphicFloor(e){return Wt(e,Math.floor)}};G("FlowGraphFloorBlock",uv);dv=class extends qe{constructor(e){super(Y,Y,t=>this._polymorphicCeiling(t),"FlowGraphCeilBlock",e)}_polymorphicCeiling(e){return Wt(e,Math.ceil)}};G("FlowGraphCeilBlock",dv);pv=class extends qe{constructor(e){super(Y,Y,t=>this._polymorphicRound(t),"FlowGraphRoundBlock",e)}_polymorphicRound(e){return Wt(e,t=>t<0&&this.config?.roundHalfAwayFromZero?-Math.round(-t):Math.round(t))}};G("FlowGraphRoundBlock",pv);mv=class extends qe{constructor(e){super(Y,Y,t=>this._polymorphicFraction(t),"FlowGraphFractBlock",e)}_polymorphicFraction(e){return Wt(e,t=>t-Math.floor(t))}};G("FlowGraphFractBlock",mv);_v=class extends qe{constructor(e){super(Y,Y,t=>this._polymorphicNeg(t),"FlowGraphNegationBlock",e)}_polymorphicNeg(e){return Wt(e,t=>-t)}};G("FlowGraphNegationBlock",_v);gv=class extends Dt{constructor(e){super(Y,Y,Y,(t,i)=>this._polymorphicRemainder(t,i),"FlowGraphModuloBlock",e)}_polymorphicRemainder(e,t){return rd(e,t,(i,r)=>i%r)}};G("FlowGraphModuloBlock",gv);vv=class extends Dt{constructor(e){super(Y,Y,Y,(t,i)=>this._polymorphicMin(t,i),"FlowGraphMinBlock",e)}_polymorphicMin(e,t){return rd(e,t,Math.min)}};G("FlowGraphMinBlock",vv);Sv=class extends Dt{constructor(e){super(Y,Y,Y,(t,i)=>this._polymorphicMax(t,i),"FlowGraphMaxBlock",e)}_polymorphicMax(e,t){return rd(e,t,Math.max)}};G("FlowGraphMaxBlock",Sv);Ev=class extends id{constructor(e){super(Y,Y,Y,Y,(t,i,r)=>this._polymorphicClamp(t,i,r),"FlowGraphClampBlock",e)}_polymorphicClamp(e,t,i){return b4(e,t,i,Cte)}};G("FlowGraphClampBlock",Ev);Tv=class extends qe{constructor(e){super(Y,Y,t=>this._polymorphicSaturate(t),"FlowGraphSaturateBlock",e)}_polymorphicSaturate(e){return Wt(e,Ite)}};G("FlowGraphSaturateBlock",Tv);xv=class extends id{constructor(e){super(Y,Y,Y,Y,(t,i,r)=>this._polymorphicInterpolate(t,i,r),"FlowGraphMathInterpolationBlock",e)}_polymorphicInterpolate(e,t,i){return b4(e,t,i,yte)}};G("FlowGraphMathInterpolationBlock",xv);Av=class extends Dt{constructor(e){super(Y,Y,Bt,(t,i)=>this._polymorphicEq(t,i),"FlowGraphEqualityBlock",e)}_polymorphicEq(e,t){let i=Bi(e),r=Bi(t);return typeof e!=typeof t?!1:Kf(i,r)||qf(i,r)||Qf(i,r)?e.equals(t):e===t}};G("FlowGraphEqualityBlock",Av);Rv=class extends Dt{constructor(e){super(Y,Y,Bt,(t,i)=>this._polymorphicLessThan(t,i),"FlowGraphLessThanBlock",e)}_polymorphicLessThan(e,t){return sS(e,t,(i,r)=>i<r)}};G("FlowGraphLessThanBlock",Rv);bv=class extends Dt{constructor(e){super(Y,Y,Bt,(t,i)=>this._polymorphicLessThanOrEqual(t,i),"FlowGraphLessThanOrEqualBlock",e)}_polymorphicLessThanOrEqual(e,t){return sS(e,t,(i,r)=>i<=r)}};G("FlowGraphLessThanOrEqualBlock",bv);Cv=class extends Dt{constructor(e){super(Y,Y,Bt,(t,i)=>this._polymorphicGreaterThan(t,i),"FlowGraphGreaterThanBlock",e)}_polymorphicGreaterThan(e,t){return sS(e,t,(i,r)=>i>r)}};G("FlowGraphGreaterThanBlock",Cv);Iv=class extends Dt{constructor(e){super(Y,Y,Bt,(t,i)=>this._polymorphicGreaterThanOrEqual(t,i),"FlowGraphGreaterThanOrEqualBlock",e)}_polymorphicGreaterThanOrEqual(e,t){return sS(e,t,(i,r)=>i>=r)}};G("FlowGraphGreaterThanOrEqualBlock",Iv);yv=class extends qe{constructor(e){super(Y,Bt,t=>this._polymorphicIsNan(t),"FlowGraphIsNaNBlock",e)}_polymorphicIsNan(e){if(to(e,!0))return isNaN(At(e));throw new Error(`Cannot get NaN of ${e}`)}};G("FlowGraphIsNaNBlock",yv);Mv=class extends qe{constructor(e){super(Y,Bt,t=>this._polymorphicIsInf(t),"FlowGraphIsInfBlock",e)}_polymorphicIsInf(e){if(to(e))return!isFinite(At(e));throw new Error(`Cannot get isInf of ${e}`)}};G("FlowGraphIsInfBlock",Mv);Pv=class extends qe{constructor(e){super(Y,Y,t=>this._polymorphicDegToRad(t),"FlowGraphDegToRadBlock",e)}_degToRad(e){return e*Math.PI/180}_polymorphicDegToRad(e){return Wt(e,this._degToRad)}};G("FlowGraphDegToRadBlock",Pv);Dv=class extends qe{constructor(e){super(Y,Y,t=>this._polymorphicRadToDeg(t),"FlowGraphRadToDegBlock",e)}_radToDeg(e){return e*180/Math.PI}_polymorphicRadToDeg(e){return Wt(e,this._radToDeg)}};G("FlowGraphRadToDegBlock",Dv);Gy=class extends qe{constructor(e){super(ue,ue,t=>this._polymorphicSin(t),"FlowGraphSinBlock",e)}_polymorphicSin(e){return Wt(e,Math.sin)}},Vy=class extends qe{constructor(e){super(ue,ue,t=>this._polymorphicCos(t),"FlowGraphCosBlock",e)}_polymorphicCos(e){return Wt(e,Math.cos)}},ky=class extends qe{constructor(e){super(ue,ue,t=>this._polymorphicTan(t),"FlowGraphTanBlock",e)}_polymorphicTan(e){return Wt(e,Math.tan)}},Ov=class extends qe{constructor(e){super(ue,ue,t=>this._polymorphicAsin(t),"FlowGraphASinBlock",e)}_polymorphicAsin(e){return Wt(e,Math.asin)}};G("FlowGraphASinBlock",Ov);Lv=class extends qe{constructor(e){super(ue,ue,t=>this._polymorphicAcos(t),"FlowGraphACosBlock",e)}_polymorphicAcos(e){return Wt(e,Math.acos)}};G("FlowGraphACosBlock",Lv);wv=class extends qe{constructor(e){super(ue,ue,t=>this._polymorphicAtan(t),"FlowGraphATanBlock",e)}_polymorphicAtan(e){return Wt(e,Math.atan)}};G("FlowGraphATanBlock",wv);Fv=class extends Dt{constructor(e){super(Y,Y,Y,(t,i)=>this._polymorphicAtan2(t,i),"FlowGraphATan2Block",e)}_polymorphicAtan2(e,t){return rd(e,t,Math.atan2)}};G("FlowGraphATan2Block",Fv);Nv=class extends qe{constructor(e){super(Y,Y,t=>this._polymorphicSinh(t),"FlowGraphSinhBlock",e)}_polymorphicSinh(e){return Wt(e,Math.sinh)}};G("FlowGraphSinhBlock",Nv);Bv=class extends qe{constructor(e){super(Y,Y,t=>this._polymorphicCosh(t),"FlowGraphCoshBlock",e)}_polymorphicCosh(e){return Wt(e,Math.cosh)}};G("FlowGraphCoshBlock",Bv);Uv=class extends qe{constructor(e){super(Y,Y,t=>this._polymorphicTanh(t),"FlowGraphTanhBlock",e)}_polymorphicTanh(e){return Wt(e,Math.tanh)}};G("FlowGraphTanhBlock",Uv);Gv=class extends qe{constructor(e){super(Y,ue,t=>this._polymorphicAsinh(t),"FlowGraphASinhBlock",e)}_polymorphicAsinh(e){return Wt(e,Math.asinh)}};G("FlowGraphASinhBlock",Gv);Vv=class extends qe{constructor(e){super(Y,ue,t=>this._polymorphicAcosh(t),"FlowGraphACoshBlock",e)}_polymorphicAcosh(e){return Wt(e,Math.acosh)}};G("FlowGraphACoshBlock",Vv);kv=class extends qe{constructor(e){super(Y,ue,t=>this._polymorphicAtanh(t),"FlowGraphATanhBlock",e)}_polymorphicAtanh(e){return Wt(e,Math.atanh)}};G("FlowGraphATanhBlock",kv);Wv=class extends qe{constructor(e){super(Y,ue,t=>this._polymorphicExp(t),"FlowGraphExponentialBlock",e)}_polymorphicExp(e){return Wt(e,Math.exp)}};G("FlowGraphExponentialBlock",Wv);Hv=class extends qe{constructor(e){super(Y,ue,t=>this._polymorphicLog(t),"FlowGraphLogBlock",e)}_polymorphicLog(e){return Wt(e,Math.log)}};G("FlowGraphLogBlock",Hv);zv=class extends qe{constructor(e){super(Y,ue,t=>this._polymorphicLog2(t),"FlowGraphLog2Block",e)}_polymorphicLog2(e){return Wt(e,Math.log2)}};G("FlowGraphLog2Block",zv);Xv=class extends qe{constructor(e){super(Y,ue,t=>this._polymorphicLog10(t),"FlowGraphLog10Block",e)}_polymorphicLog10(e){return Wt(e,Math.log10)}};G("FlowGraphLog10Block",Xv);Yv=class extends qe{constructor(e){super(Y,ue,t=>this._polymorphicSqrt(t),"FlowGraphSquareRootBlock",e)}_polymorphicSqrt(e){return Wt(e,Math.sqrt)}};G("FlowGraphSquareRootBlock",Yv);Kv=class extends qe{constructor(e){super(Y,ue,t=>this._polymorphicCubeRoot(t),"FlowGraphCubeRootBlock",e)}_polymorphicCubeRoot(e){return Wt(e,Math.cbrt)}};G("FlowGraphCubeRootBlock",Kv);qv=class extends Dt{constructor(e){super(Y,ue,ue,(t,i)=>this._polymorphicPow(t,i),"FlowGraphPowerBlock",e)}_polymorphicPow(e,t){return rd(e,t,Math.pow)}};G("FlowGraphPowerBlock",qv);Qv=class extends qe{constructor(e){super(pt(e?.valueType||"FlowGraphInteger"),pt(e?.valueType||"FlowGraphInteger"),t=>typeof t=="boolean"?!t:typeof t=="number"?~t:new Xe(~t.value),"FlowGraphBitwiseNotBlock",e)}};G("FlowGraphBitwiseNotBlock",Qv);jv=class extends Dt{constructor(e){super(pt(e?.valueType||"FlowGraphInteger"),pt(e?.valueType||"FlowGraphInteger"),pt(e?.valueType||"FlowGraphInteger"),(t,i)=>{if(typeof t=="boolean"&&typeof i=="boolean")return t&&i;if(typeof t=="number"&&typeof i=="number")return t&i;if(typeof t=="object"&&typeof i=="object")return new Xe(t.value&i.value);throw new Error(`Cannot perform bitwise AND on ${t} and ${i}`)},"FlowGraphBitwiseAndBlock",e)}};G("FlowGraphBitwiseAndBlock",jv);Zv=class extends Dt{constructor(e){super(pt(e?.valueType||"FlowGraphInteger"),pt(e?.valueType||"FlowGraphInteger"),pt(e?.valueType||"FlowGraphInteger"),(t,i)=>{if(typeof t=="boolean"&&typeof i=="boolean")return t||i;if(typeof t=="number"&&typeof i=="number")return t|i;if(typeof t=="object"&&typeof i=="object")return new Xe(t.value|i.value);throw new Error(`Cannot perform bitwise OR on ${t} and ${i}`)},"FlowGraphBitwiseOrBlock",e)}};G("FlowGraphBitwiseOrBlock",Zv);Jv=class extends Dt{constructor(e){super(pt(e?.valueType||"FlowGraphInteger"),pt(e?.valueType||"FlowGraphInteger"),pt(e?.valueType||"FlowGraphInteger"),(t,i)=>{if(typeof t=="boolean"&&typeof i=="boolean")return t!==i;if(typeof t=="number"&&typeof i=="number")return t^i;if(typeof t=="object"&&typeof i=="object")return new Xe(t.value^i.value);throw new Error(`Cannot perform bitwise XOR on ${t} and ${i}`)},"FlowGraphBitwiseXorBlock",e)}};G("FlowGraphBitwiseXorBlock",Jv);$v=class extends Dt{constructor(e){super(xt,xt,xt,(t,i)=>new Xe(t.value<<i.value),"FlowGraphBitwiseLeftShiftBlock",e)}};G("FlowGraphBitwiseLeftShiftBlock",$v);eS=class extends Dt{constructor(e){super(xt,xt,xt,(t,i)=>new Xe(t.value>>i.value),"FlowGraphBitwiseRightShiftBlock",e)}};G("FlowGraphBitwiseRightShiftBlock",eS);tS=class extends qe{constructor(e){super(xt,xt,t=>new Xe(Math.clz32(t.value)),"FlowGraphLeadingZerosBlock",e)}};G("FlowGraphLeadingZerosBlock",tS);iS=class extends qe{constructor(e){super(xt,xt,t=>new Xe(t.value?31-Math.clz32(t.value&-t.value):32),"FlowGraphTrailingZerosBlock",e)}};G("FlowGraphTrailingZerosBlock",iS);rS=class extends qe{constructor(e){super(xt,xt,t=>new Xe(Mte(t.value)),"FlowGraphOneBitsCounterBlock",e)}};G("FlowGraphOneBitsCounterBlock",rS)});function Pte(s,e){return s.x*e.x+s.y*e.y+s.z*e.z}function C4(s,e){return Math.acos(Fe(K.Dot(s,e)))*2}function I4(s,e){let t=new K;return Dte(s,e,t),t}function Dte(s,e,t){let i=E.Cross(s,e),r=Math.acos(Fe(Pte(s,e),-1,1));return K.RotationAxisToRef(i,r,t),t}var y4=S(()=>{di();ie()});var es={};V(es,{FlowGraphAngleBetweenBlock:()=>pS,FlowGraphAxisAngleFromQuaternionBlock:()=>_S,FlowGraphConjugateBlock:()=>dS,FlowGraphCrossBlock:()=>lS,FlowGraphDotBlock:()=>oS,FlowGraphLengthBlock:()=>nS,FlowGraphNormalizeBlock:()=>aS,FlowGraphQuaternionFromAxisAngleBlock:()=>mS,FlowGraphQuaternionFromDirectionsBlock:()=>Wy,FlowGraphRotate2DBlock:()=>cS,FlowGraphRotate3DBlock:()=>fS,FlowGraphTransformBlock:()=>hS,FlowGraphTransformCoordinatesBlock:()=>uS});function Ote(s,e){switch(Bi(s)){case"Vector2":return e.transformVector(s);case"Vector3":return e.transformVector(s);case"Vector4":return s=s,new Oe(s.x*e.m[0]+s.y*e.m[1]+s.z*e.m[2]+s.w*e.m[3],s.x*e.m[4]+s.y*e.m[5]+s.z*e.m[6]+s.w*e.m[7],s.x*e.m[8]+s.y*e.m[9]+s.z*e.m[10]+s.w*e.m[11],s.x*e.m[12]+s.y*e.m[13]+s.z*e.m[14]+s.w*e.m[15]);default:throw new Error(`Cannot transform value ${s}`)}}var M4,P4,D4,nS,aS,oS,lS,cS,fS,hS,uS,dS,pS,mS,_S,Wy,ts=S(()=>{_i();Ze();Te();$g();td();ie();us();y4();M4="cachedOperationAxis",P4="cachedOperationAngle",D4="cachedExecutionId",nS=class extends qe{constructor(e){super(Y,ue,t=>this._polymorphicLength(t),"FlowGraphLengthBlock",e)}_polymorphicLength(e){switch(Bi(e)){case"Vector2":case"Vector3":case"Vector4":case"Quaternion":return e.length();default:throw new Error(`Cannot compute length of value ${e}`)}}};G("FlowGraphLengthBlock",nS);aS=class extends qe{constructor(e){super(Y,Y,t=>this._polymorphicNormalize(t),"FlowGraphNormalizeBlock",e)}_polymorphicNormalize(e){let t=Bi(e),i;switch(t){case"Vector2":case"Vector3":case"Vector4":case"Quaternion":return i=e.normalizeToNew(),this.config?.nanOnZeroLength&&e.length()===0&&i.setAll(NaN),i;default:throw new Error(`Cannot normalize value ${e}`)}}};G("FlowGraphNormalizeBlock",aS);oS=class extends Dt{constructor(e){super(Y,Y,ue,(t,i)=>this._polymorphicDot(t,i),"FlowGraphDotBlock",e)}_polymorphicDot(e,t){switch(Bi(e)){case"Vector2":case"Vector3":case"Vector4":case"Quaternion":return e.dot(t);default:throw new Error(`Cannot get dot product of ${e} and ${t}`)}}};G("FlowGraphDotBlock",oS);lS=class extends Dt{constructor(e){super(kt,kt,kt,(t,i)=>E.Cross(t,i),"FlowGraphCrossBlock",e)}};G("FlowGraphCrossBlock",lS);cS=class extends Dt{constructor(e){super(Us,ue,Us,(t,i)=>t.rotate(i),"FlowGraphRotate2DBlock",e)}};G("FlowGraphRotate2DBlock",cS);fS=class extends Dt{constructor(e){super(kt,gr,kt,(t,i)=>t.applyRotationQuaternion(i),"FlowGraphRotate3DBlock",e)}};G("FlowGraphRotate3DBlock",fS);hS=class extends Dt{constructor(e){let t=e?.vectorType||"Vector3",i=t==="Vector2"?"Matrix2D":t==="Vector3"?"Matrix3D":"Matrix";super(pt(t),pt(i),pt(t),Ote,"FlowGraphTransformVectorBlock",e)}};G("FlowGraphTransformVectorBlock",hS);uS=class extends Dt{constructor(e){super(kt,dn,kt,(t,i)=>E.TransformCoordinates(t,i),"FlowGraphTransformCoordinatesBlock",e)}};G("FlowGraphTransformCoordinatesBlock",uS);dS=class extends qe{constructor(e){super(gr,gr,t=>t.conjugate(),"FlowGraphConjugateBlock",e)}};G("FlowGraphConjugateBlock",dS);pS=class extends Dt{constructor(e){super(gr,gr,ue,(t,i)=>C4(t,i),"FlowGraphAngleBetweenBlock",e)}};G("FlowGraphAngleBetweenBlock",pS);mS=class extends Dt{constructor(e){super(kt,ue,gr,(t,i)=>K.RotationAxis(t,i),"FlowGraphQuaternionFromAxisAngleBlock",e)}};G("FlowGraphQuaternionFromAxisAngleBlock",mS);_S=class extends ht{constructor(e){super(e),this.a=this.registerDataInput("a",gr),this.axis=this.registerDataOutput("axis",kt),this.angle=this.registerDataOutput("angle",ue),this.isValid=this.registerDataOutput("isValid",Bt)}_updateOutputs(e){let t=e._getExecutionVariable(this,D4,-1),i=e._getExecutionVariable(this,M4,null),r=e._getExecutionVariable(this,P4,null);if(i!=null&&r!==void 0&&r!==null&&t===e.executionId)this.axis.setValue(i,e),this.angle.setValue(r,e);else try{let{axis:n,angle:a}=this.a.getValue(e).toAxisAngle();e._setExecutionVariable(this,M4,n),e._setExecutionVariable(this,P4,a),e._setExecutionVariable(this,D4,e.executionId),this.axis.setValue(n,e),this.angle.setValue(a,e),this.isValid.setValue(!0,e)}catch{this.isValid.setValue(!1,e)}}getClassName(){return"FlowGraphAxisAngleFromQuaternionBlock"}};G("FlowGraphAxisAngleFromQuaternionBlock",_S);Wy=class extends Dt{constructor(e){super(kt,kt,gr,(t,i)=>I4(t,i),"FlowGraphQuaternionFromDirectionsBlock",e)}}});var Zl={};V(Zl,{FlowGraphDeterminantBlock:()=>vS,FlowGraphInvertMatrixBlock:()=>SS,FlowGraphMatrixComposeBlock:()=>xS,FlowGraphMatrixDecomposeBlock:()=>TS,FlowGraphMatrixMultiplicationBlock:()=>ES,FlowGraphTransposeBlock:()=>gS});var gS,vS,SS,ES,TS,xS,Jl=S(()=>{_i();Ze();ie();Te();td();$g();gS=class extends qe{constructor(e){super(pt(e?.matrixType||"Matrix"),pt(e?.matrixType||"Matrix"),t=>t.transpose?t.transpose():B.Transpose(t),"FlowGraphTransposeBlock",e)}};G("FlowGraphTransposeBlock",gS);vS=class extends qe{constructor(e){super(pt(e?.matrixType||"Matrix"),ue,t=>t.determinant(),"FlowGraphDeterminantBlock",e)}};G("FlowGraphDeterminantBlock",vS);SS=class extends qe{constructor(e){super(pt(e?.matrixType||"Matrix"),pt(e?.matrixType||"Matrix"),t=>t.inverse?t.inverse():B.Invert(t),"FlowGraphInvertMatrixBlock",e)}};G("FlowGraphInvertMatrixBlock",SS);ES=class extends Dt{constructor(e){super(pt(e?.matrixType||"Matrix"),pt(e?.matrixType||"Matrix"),pt(e?.matrixType||"Matrix"),(t,i)=>i.multiply(t),"FlowGraphMatrixMultiplicationBlock",e)}};G("FlowGraphMatrixMultiplicationBlock",ES);TS=class extends ht{constructor(e){super(e),this.input=this.registerDataInput("input",dn),this.position=this.registerDataOutput("position",kt),this.rotationQuaternion=this.registerDataOutput("rotationQuaternion",gr),this.scaling=this.registerDataOutput("scaling",kt),this.isValid=this.registerDataOutput("isValid",Bt,!1)}_updateOutputs(e){let t=e._getExecutionVariable(this,"executionId",-1),i=e._getExecutionVariable(this,"cachedPosition",null),r=e._getExecutionVariable(this,"cachedRotation",null),n=e._getExecutionVariable(this,"cachedScaling",null);if(t===e.executionId&&i&&r&&n)this.position.setValue(i,e),this.rotationQuaternion.setValue(r,e),this.scaling.setValue(n,e);else{let a=this.input.getValue(e),o=i||new E,l=r||new K,c=n||new E,f=Math.round(a.m[3]*1e4)/1e4,h=Math.round(a.m[7]*1e4)/1e4,u=Math.round(a.m[11]*1e4)/1e4,d=Math.round(a.m[15]*1e4)/1e4;if(f!==0||h!==0||u!==0||d!==1){this.isValid.setValue(!1,e),this.position.setValue(E.Zero(),e),this.rotationQuaternion.setValue(K.Identity(),e),this.scaling.setValue(E.One(),e);return}let p=a.decompose(c,l,o);this.isValid.setValue(p,e),this.position.setValue(o,e),this.rotationQuaternion.setValue(l,e),this.scaling.setValue(c,e),e._setExecutionVariable(this,"cachedPosition",o),e._setExecutionVariable(this,"cachedRotation",l),e._setExecutionVariable(this,"cachedScaling",c),e._setExecutionVariable(this,"executionId",e.executionId)}}getClassName(){return"FlowGraphMatrixDecompose"}};G("FlowGraphMatrixDecompose",TS);xS=class extends ht{constructor(e){super(e),this.position=this.registerDataInput("position",kt),this.rotationQuaternion=this.registerDataInput("rotationQuaternion",gr),this.scaling=this.registerDataInput("scaling",kt),this.value=this.registerDataOutput("value",dn)}_updateOutputs(e){let t=e._getExecutionVariable(this,"executionId",-1),i=e._getExecutionVariable(this,"cachedMatrix",null);if(t===e.executionId&&i)this.value.setValue(i,e);else{let r=B.Compose(this.scaling.getValue(e),this.rotationQuaternion.getValue(e),this.position.getValue(e));this.value.setValue(r,e),e._setExecutionVariable(this,"cachedMatrix",r),e._setExecutionVariable(this,"executionId",e.executionId)}}getClassName(){return"FlowGraphMatrixCompose"}};G("FlowGraphMatrixCompose",xS)});var O4={};V(O4,{FlowGraphBranchBlock:()=>AS});var AS,L4=S(()=>{Ze();eo();Te();AS=class extends Ni{constructor(e){super(e),this.condition=this.registerDataInput("condition",Bt),this.onTrue=this._registerSignalOutput("onTrue"),this.onFalse=this._registerSignalOutput("onFalse")}_execute(e){this.condition.getValue(e)?this.onTrue._activateSignal(e):this.onFalse._activateSignal(e)}getClassName(){return"FlowGraphBranchBlock"}};G("FlowGraphBranchBlock",AS)});var w4,RS,F4=S(()=>{we();(function(s){s[s.INIT=0]="INIT",s[s.STARTED=1]="STARTED",s[s.ENDED=2]="ENDED"})(w4||(w4={}));RS=class{constructor(e){this.onEachCountObservable=new N,this.onTimerAbortedObservable=new N,this.onTimerEndedObservable=new N,this.onStateChangedObservable=new N,this._observer=null,this._breakOnNextTick=!1,this._tick=t=>{let i=Date.now();this._timer=i-this._startTime;let r={startTime:this._startTime,currentTime:i,deltaTime:this._timer,completeRate:this._timer/this._timeToEnd,payload:t},n=this._breakOnNextTick||this._breakCondition(r);n||this._timer>=this._timeToEnd?this._stop(r,n):this.onEachCountObservable.notifyObservers(r)},this._setState(0),this._contextObservable=e.contextObservable,this._observableParameters=e.observableParameters??{},this._breakCondition=e.breakCondition??(()=>!1),this._timeToEnd=e.timeout,e.onEnded&&this.onTimerEndedObservable.add(e.onEnded),e.onTick&&this.onEachCountObservable.add(e.onTick),e.onAborted&&this.onTimerAbortedObservable.add(e.onAborted)}set breakCondition(e){this._breakCondition=e}clearObservables(){this.onEachCountObservable.clear(),this.onTimerAbortedObservable.clear(),this.onTimerEndedObservable.clear(),this.onStateChangedObservable.clear()}start(e=this._timeToEnd){if(this._state===1)throw new Error("Timer already started. Please stop it before starting again");this._timeToEnd=e,this._startTime=Date.now(),this._timer=0,this._observer=this._contextObservable.add(this._tick,this._observableParameters.mask,this._observableParameters.insertFirst,this._observableParameters.scope),this._setState(1)}stop(){this._state===1&&(this._breakOnNextTick=!0)}dispose(){this._observer&&this._contextObservable.remove(this._observer),this.clearObservables()}_setState(e){this._state=e,this.onStateChangedObservable.notifyObservers(this._state)}_stop(e,t=!1){this._contextObservable.remove(this._observer),this._setState(2),t?this.onTimerAbortedObservable.notifyObservers(e):this.onTimerEndedObservable.notifyObservers(e)}}});var N4={};V(N4,{FlowGraphSetDelayBlock:()=>sd});var sd,B4=S(()=>{ed();Ze();F4();Ee();Te();$r();sd=class s extends jn{constructor(e){super(e),this.cancel=this._registerSignalInput("cancel"),this.duration=this.registerDataInput("duration",ue),this.lastDelayIndex=this.registerDataOutput("lastDelayIndex",xt,new Xe(-1))}_preparePendingTasks(e){let t=this.duration.getValue(e);if(t<0||isNaN(t)||!isFinite(t))return this._reportError(e,"Invalid duration in SetDelay block");if(e._getGlobalContextVariable("activeDelays",0)>=s.MaxParallelDelayCount)return this._reportError(e,"Max parallel delays reached");let r=e._getGlobalContextVariable("lastDelayIndex",-1),n=e._getExecutionVariable(this,"pendingDelays",[]),a=e.configuration.scene,o=new RS({timeout:t*1e3,contextObservable:a.onBeforeRenderObservable,onEnded:()=>this._onEnded(o,e)});o.start();let l=r+1;this.lastDelayIndex.setValue(new Xe(l),e),e._setGlobalContextVariable("lastDelayIndex",l),n[l]=o,e._setExecutionVariable(this,"pendingDelays",n),this._updateGlobalTimers(e)}_cancelPendingTasks(e){let t=e._getExecutionVariable(this,"pendingDelays",[]);for(let i of t)i?.dispose();e._deleteExecutionVariable(this,"pendingDelays"),this.lastDelayIndex.setValue(new Xe(-1),e),this._updateGlobalTimers(e)}_execute(e,t){if(t===this.cancel){this._cancelPendingTasks(e);return}else this._preparePendingTasks(e),this.out._activateSignal(e)}getClassName(){return"FlowGraphSetDelayBlock"}_onEnded(e,t){let i=t._getExecutionVariable(this,"pendingDelays",[]),r=i.indexOf(e);r!==-1?i.splice(r,1):P.Warn("FlowGraphTimerBlock: Timer ended but was not found in the running timers list"),t._removePendingBlock(this),this.done._activateSignal(t),this._updateGlobalTimers(t)}_updateGlobalTimers(e){let t=e._getExecutionVariable(this,"pendingDelays",[]),i=e._getGlobalContextVariable("pendingDelays",[]);for(let r=0;r<t.length;r++){if(!t[r])continue;let n=t[r];i[r]&&i[r]!==n?P.Warn("FlowGraphTimerBlock: Timer ended but was not found in the running timers list"):i[r]=n}e._setGlobalContextVariable("pendingDelays",i)}};sd.MaxParallelDelayCount=100;G("FlowGraphSetDelayBlock",sd)});var U4={};V(U4,{FlowGraphCancelDelayBlock:()=>bS});var bS,G4=S(()=>{Te();Or();Ze();us();bS=class extends Vt{constructor(e){super(e),this.delayIndex=this.registerDataInput("delayIndex",xt)}_execute(e,t){let i=At(this.delayIndex.getValue(e));if(i<=0||isNaN(i)||!isFinite(i))return this._reportError(e,"Invalid delay index");let n=e._getGlobalContextVariable("pendingDelays",[])[i];n&&n.dispose(),this.out._activateSignal(e)}getClassName(){return"FlowGraphCancelDelayBlock"}};G("FlowGraphCancelDelayBlock",bS)});var V4={};V(V4,{FlowGraphCallCounterBlock:()=>CS});var CS,k4=S(()=>{Ze();Or();Te();CS=class extends Vt{constructor(e){super(e),this.count=this.registerDataOutput("count",ue),this.reset=this._registerSignalInput("reset")}_execute(e,t){if(t===this.reset){e._setExecutionVariable(this,"count",0),this.count.setValue(0,e);return}let i=e._getExecutionVariable(this,"count",0)+1;e._setExecutionVariable(this,"count",i),this.count.setValue(i,e),this.out._activateSignal(e)}getClassName(){return"FlowGraphCallCounterBlock"}};G("FlowGraphCallCounterBlock",CS)});var W4={};V(W4,{FlowGraphDebounceBlock:()=>IS});var IS,H4=S(()=>{Ze();Or();Te();IS=class extends Vt{constructor(e){super(e),this.count=this.registerDataInput("count",ue),this.reset=this._registerSignalInput("reset"),this.currentCount=this.registerDataOutput("currentCount",ue)}_execute(e,t){if(t===this.reset){e._setExecutionVariable(this,"debounceCount",0);return}let i=this.count.getValue(e),n=e._getExecutionVariable(this,"debounceCount",0)+1;this.currentCount.setValue(n,e),e._setExecutionVariable(this,"debounceCount",n),n>=i&&(this.out._activateSignal(e),e._setExecutionVariable(this,"debounceCount",0))}getClassName(){return"FlowGraphDebounceBlock"}};G("FlowGraphDebounceBlock",IS)});var z4={};V(z4,{FlowGraphThrottleBlock:()=>yS});var yS,X4=S(()=>{Ze();Or();Te();yS=class extends Vt{constructor(e){super(e),this.reset=this._registerSignalInput("reset"),this.duration=this.registerDataInput("duration",ue),this.lastRemainingTime=this.registerDataOutput("lastRemainingTime",ue,NaN)}_execute(e,t){if(t===this.reset){this.lastRemainingTime.setValue(NaN,e),e._setExecutionVariable(this,"lastRemainingTime",NaN),e._setExecutionVariable(this,"timestamp",0);return}let i=this.duration.getValue(e);if(i<=0||isNaN(i)||!isFinite(i))return this._reportError(e,"Invalid duration in Throttle block");let r=e._getExecutionVariable(this,"lastRemainingTime",NaN),n=Date.now();if(isNaN(r))return this.lastRemainingTime.setValue(0,e),e._setExecutionVariable(this,"lastRemainingTime",0),e._setExecutionVariable(this,"timestamp",n),this.out._activateSignal(e);{let a=n-e._getExecutionVariable(this,"timestamp",0),o=i*1e3;if(o<=a)return this.lastRemainingTime.setValue(0,e),e._setExecutionVariable(this,"lastRemainingTime",0),e._setExecutionVariable(this,"timestamp",n),this.out._activateSignal(e);{let l=o-a;this.lastRemainingTime.setValue(l/1e3,e),e._setExecutionVariable(this,"lastRemainingTime",l)}}}getClassName(){return"FlowGraphThrottleBlock"}};G("FlowGraphThrottleBlock",yS)});var Y4={};V(Y4,{FlowGraphDoNBlock:()=>MS});var MS,K4=S(()=>{Ze();Or();Te();$r();MS=class extends Vt{constructor(e={}){super(e),this.config=e,this.config.startIndex=e.startIndex??new Xe(0),this.reset=this._registerSignalInput("reset"),this.maxExecutions=this.registerDataInput("maxExecutions",xt),this.executionCount=this.registerDataOutput("executionCount",xt,new Xe(0))}_execute(e,t){if(t===this.reset)this.executionCount.setValue(this.config.startIndex,e);else{let i=this.executionCount.getValue(e);i.value<this.maxExecutions.getValue(e).value&&(this.executionCount.setValue(new Xe(i.value+1),e),this.out._activateSignal(e))}}getClassName(){return"FlowGraphDoNBlock"}};G("FlowGraphDoNBlock",MS)});var q4={};V(q4,{FlowGraphFlipFlopBlock:()=>PS});var PS,Q4=S(()=>{eo();Ze();Te();PS=class extends Ni{constructor(e){super(e),this.onOn=this._registerSignalOutput("onOn"),this.onOff=this._registerSignalOutput("onOff"),this.value=this.registerDataOutput("value",Bt)}_execute(e,t){let i=e._getExecutionVariable(this,"value",typeof this.config?.startValue=="boolean"?!this.config.startValue:!1);i=!i,e._setExecutionVariable(this,"value",i),this.value.setValue(i,e),i?this.onOn._activateSignal(e):this.onOff._activateSignal(e)}getClassName(){return"FlowGraphFlipFlopBlock"}};G("FlowGraphFlipFlopBlock",PS)});var j4={};V(j4,{FlowGraphForLoopBlock:()=>nd});var nd,Z4=S(()=>{Or();Ze();Te();us();$r();nd=class s extends Vt{constructor(e){super(e),this.startIndex=this.registerDataInput("startIndex",Y,0),this.endIndex=this.registerDataInput("endIndex",Y),this.step=this.registerDataInput("step",ue,1),this.index=this.registerDataOutput("index",xt,new Xe(At(e?.initialIndex??0))),this.executionFlow=this._registerSignalOutput("executionFlow"),this.completed=this._registerSignalOutput("completed"),this._unregisterSignalOutput("out")}_execute(e){let t=At(this.startIndex.getValue(e)),i=this.step.getValue(e),r=At(this.endIndex.getValue(e));for(let n=t;n<r&&(this.index.setValue(new Xe(n),e),this.executionFlow._activateSignal(e),r=At(this.endIndex.getValue(e)),!(n>s.MaxLoopIterations*i));n+=i);this.config?.incrementIndexWhenLoopDone&&this.index.setValue(new Xe(At(this.index.getValue(e))+i),e),this.completed._activateSignal(e)}getClassName(){return"FlowGraphForLoopBlock"}};nd.MaxLoopIterations=1e3;G("FlowGraphForLoopBlock",nd)});var J4={};V(J4,{FlowGraphMultiGateBlock:()=>DS});var DS,$4=S(()=>{Te();eo();Ze();$r();DS=class extends Ni{constructor(e){super(e),this.config=e,this.outputSignals=[],this.reset=this._registerSignalInput("reset"),this.lastIndex=this.registerDataOutput("lastIndex",xt,new Xe(-1)),this.setNumberOfOutputSignals(e?.outputSignalCount)}_getNextIndex(e){if(e.includes(!1)||this.config.isLoop&&e.fill(!1),this.config.isRandom){let t=e.map((i,r)=>i?-1:r).filter(i=>i!==-1);return t.length?t[Math.floor(Math.random()*t.length)]:-1}else return e.indexOf(!1)}setNumberOfOutputSignals(e=1){for(;this.outputSignals.length>e;){let t=this.outputSignals.pop();t&&(t.disconnectFromAll(),this._unregisterSignalOutput(t.name))}for(;this.outputSignals.length<e;)this.outputSignals.push(this._registerSignalOutput(`out_${this.outputSignals.length}`))}_execute(e,t){if(e._hasExecutionVariable(this,"indexesUsed")||e._setExecutionVariable(this,"indexesUsed",this.outputSignals.map(()=>!1)),t===this.reset){e._deleteExecutionVariable(this,"indexesUsed"),this.lastIndex.setValue(new Xe(-1),e);return}let i=e._getExecutionVariable(this,"indexesUsed",[]),r=this._getNextIndex(i);r>-1&&(this.lastIndex.setValue(new Xe(r),e),i[r]=!0,e._setExecutionVariable(this,"indexesUsed",i),this.outputSignals[r]._activateSignal(e))}getClassName(){return"FlowGraphMultiGateBlock"}serialize(e){super.serialize(e),e.config.outputSignalCount=this.config.outputSignalCount,e.config.isRandom=this.config.isRandom,e.config.loop=this.config.isLoop,e.config.startIndex=this.config.startIndex}};G("FlowGraphMultiGateBlock",DS)});var eW={};V(eW,{FlowGraphSequenceBlock:()=>OS});var OS,tW=S(()=>{Te();eo();OS=class extends Ni{constructor(e){super(e),this.config=e,this.executionSignals=[],this.setNumberOfOutputSignals(this.config.outputSignalCount)}_execute(e){for(let t=0;t<this.executionSignals.length;t++)this.executionSignals[t]._activateSignal(e)}setNumberOfOutputSignals(e=1){for(;this.executionSignals.length>e;){let t=this.executionSignals.pop();t&&(t.disconnectFromAll(),this._unregisterSignalOutput(t.name))}for(;this.executionSignals.length<e;)this.executionSignals.push(this._registerSignalOutput(`out_${this.executionSignals.length}`))}getClassName(){return"FlowGraphSequenceBlock"}};G("FlowGraphSequenceBlock",OS)});var iW={};V(iW,{FlowGraphSwitchBlock:()=>LS});var LS,rW=S(()=>{eo();Ze();Te();us();LS=class extends Ni{constructor(e){super(e),this.config=e,this.default=this._registerSignalOutput("default"),this._caseToOutputFlow=new Map,this.case=this.registerDataInput("case",Y);let t=this.config.cases||[];for(let i of t)this._caseToOutputFlow.set(i,this._registerSignalOutput(`out_${i}`))}_execute(e,t){let i=this.case.getValue(e),r;to(i)?r=this._getOutputFlowForCase(At(i)):r=this._getOutputFlowForCase(i),r?r._activateSignal(e):this.default._activateSignal(e)}addCase(e){this.config.cases.includes(e)||(this.config.cases.push(e),this._caseToOutputFlow.set(e,this._registerSignalOutput(`out_${e}`)))}removeCase(e){if(!this.config.cases.includes(e))return;let t=this.config.cases.indexOf(e);this.config.cases.splice(t,1),this._caseToOutputFlow.delete(e)}_getOutputFlowForCase(e){return this._caseToOutputFlow.get(e)}getClassName(){return"FlowGraphSwitchBlock"}serialize(e){super.serialize(e),e.cases=this.config.cases}};G("FlowGraphSwitchBlock",LS)});var sW={};V(sW,{FlowGraphWaitAllBlock:()=>wS});var wS,nW=S(()=>{Or();Te();Ze();$r();wS=class extends Vt{constructor(e){super(e),this.config=e,this.inFlows=[],this._cachedActivationState=[],this.reset=this._registerSignalInput("reset"),this.completed=this._registerSignalOutput("completed"),this.remainingInputs=this.registerDataOutput("remainingInputs",xt,new Xe(this.config.inputSignalCount||0));for(let t=0;t<this.config.inputSignalCount;t++)this.inFlows.push(this._registerSignalInput(`in_${t}`));this._unregisterSignalInput("in")}_getCurrentActivationState(e){let t=this._cachedActivationState;if(t.length=0,e._hasExecutionVariable(this,"activationState")){let i=e._getExecutionVariable(this,"activationState",[]);for(let r=0;r<i.length;r++)t.push(i[r])}else for(let i=0;i<this.config.inputSignalCount;i++)t.push(!1);return t}_execute(e,t){let i=this._getCurrentActivationState(e);if(t===this.reset)for(let r=0;r<this.config.inputSignalCount;r++)i[r]=!1;else{let r=this.inFlows.indexOf(t);r>=0&&(i[r]=!0)}if(this.remainingInputs.setValue(new Xe(i.filter(r=>!r).length),e),e._setExecutionVariable(this,"activationState",i.slice()),i.includes(!1))t!==this.reset&&this.out._activateSignal(e);else{this.completed._activateSignal(e);for(let r=0;r<this.config.inputSignalCount;r++)i[r]=!1}}getClassName(){return"FlowGraphWaitAllBlock"}serialize(e){super.serialize(e),e.config.inputFlows=this.config.inputSignalCount}};G("FlowGraphWaitAllBlock",wS)});var aW={};V(aW,{FlowGraphWhileLoopBlock:()=>ad});var ad,oW=S(()=>{Ze();Te();Or();Ee();ad=class s extends Vt{constructor(e){super(e),this.config=e,this.condition=this.registerDataInput("condition",Bt),this.executionFlow=this._registerSignalOutput("executionFlow"),this.completed=this._registerSignalOutput("completed"),this._unregisterSignalOutput("out")}_execute(e,t){let i=this.condition.getValue(e);this.config?.doWhile&&!i&&this.executionFlow._activateSignal(e);let r=0;for(;i;){if(this.executionFlow._activateSignal(e),++r,r>=s.MaxLoopCount){P.Warn("FlowGraphWhileLoopBlock: Max loop count reached. Breaking.");break}i=this.condition.getValue(e)}this.completed._activateSignal(e)}getClassName(){return"FlowGraphWhileLoopBlock"}};ad.MaxLoopCount=1e3;G("FlowGraphWhileLoopBlock",ad)});var lW={};V(lW,{FlowGraphConsoleLogBlock:()=>FS});var FS,cW=S(()=>{Or();Ze();Te();Ee();FS=class extends Vt{constructor(e){if(super(e),this.message=this.registerDataInput("message",Y),this.logType=this.registerDataInput("logType",Y,"log"),e?.messageTemplate){let t=this._getTemplateMatches(e.messageTemplate);for(let i of t)this.registerDataInput(i,Y)}}_execute(e){let t=this.logType.getValue(e),i=this._getMessageValue(e);t==="warn"?P.Warn(i):t==="error"?P.Error(i):P.Log(i),this.out._activateSignal(e)}getClassName(){return"FlowGraphConsoleLogBlock"}_getMessageValue(e){if(this.config?.messageTemplate){let t=this.config.messageTemplate,i=this._getTemplateMatches(t);for(let r of i){let n=this.getDataInput(r)?.getValue(e);n!==void 0&&(t=t.replace(new RegExp(`\\{${r}\\}`,"g"),n.toString()))}return t}else return this.message.getValue(e)}_getTemplateMatches(e){let t=/\{([^}]+)\}/g,i=[],r;for(;(r=t.exec(e))!==null;)i.push(r[1]);return i}};G("FlowGraphConsoleLogBlock",FS)});var fW={};V(fW,{FlowGraphConditionalDataBlock:()=>NS});var NS,hW=S(()=>{_i();Ze();Te();NS=class extends ht{constructor(e){super(e),this.condition=this.registerDataInput("condition",Bt),this.onTrue=this.registerDataInput("onTrue",Y),this.onFalse=this.registerDataInput("onFalse",Y),this.output=this.registerDataOutput("output",Y)}_updateOutputs(e){let t=this.condition.getValue(e);this.output.setValue(t?this.onTrue.getValue(e):this.onFalse.getValue(e),e)}getClassName(){return"FlowGraphConditionalBlock"}};G("FlowGraphConditionalBlock",NS)});var uW={};V(uW,{FlowGraphConstantBlock:()=>BS});var BS,dW=S(()=>{_i();Ze();Te();Hf();BS=class extends ht{constructor(e){super(e),this.config=e,this.output=this.registerDataOutput("output",Wk(e.value))}_updateOutputs(e){this.output.setValue(this.config.value,e)}getClassName(){return"FlowGraphConstantBlock"}serialize(e={},t=el){super.serialize(e),t("value",this.config.value,e.config)}};G("FlowGraphConstantBlock",BS)});var pW={};V(pW,{FlowGraphTransformCoordinatesSystemBlock:()=>US});var US,mW=S(()=>{_i();Ze();ie();Te();US=class extends ht{constructor(e){super(e),this.sourceSystem=this.registerDataInput("sourceSystem",Y),this.destinationSystem=this.registerDataInput("destinationSystem",Y),this.inputCoordinates=this.registerDataInput("inputCoordinates",kt),this.outputCoordinates=this.registerDataOutput("outputCoordinates",kt)}_updateOutputs(e){let t=this.sourceSystem.getValue(e),i=this.destinationSystem.getValue(e),r=this.inputCoordinates.getValue(e),n=t.getWorldMatrix(),a=i.getWorldMatrix(),o=w.Matrix[0].copyFrom(a);o.invert();let l=w.Matrix[1];o.multiplyToRef(n,l);let c=this.outputCoordinates.getValue(e);E.TransformCoordinatesToRef(r,l,c)}getClassName(){return"FlowGraphTransformCoordinatesSystemBlock"}};G("FlowGraphTransformCoordinatesSystemBlock",US)});var _W={};V(_W,{FlowGraphGetAssetBlock:()=>GS});var GS,gW=S(()=>{By();_i();Ze();Te();$r();us();GS=class extends ht{constructor(e){super(e),this.config=e,this.type=this.registerDataInput("type",Y,e.type),this.value=this.registerDataOutput("value",Y),this.index=this.registerDataInput("index",Y,new Xe(At(e.index??-1)))}_updateOutputs(e){let t=this.type.getValue(e),i=this.index.getValue(e),r=Gg(e.assetsContext,t,At(i),this.config.useIndexAsUniqueId);this.value.setValue(r,e)}getClassName(){return"FlowGraphGetAssetBlock"}};G("FlowGraphGetAssetBlock",GS)});var vW={};V(vW,{FlowGraphGetPropertyBlock:()=>VS});var VS,SW=S(()=>{Ze();Te();il();VS=class extends Sr{constructor(e){super(Y,e),this.config=e,this.object=this.registerDataInput("object",Y,e.object),this.propertyName=this.registerDataInput("propertyName",Y,e.propertyName),this.customGetFunction=this.registerDataInput("customGetFunction",Y)}_doOperation(e){let t=this.customGetFunction.getValue(e),i;if(t)i=t(this.object.getValue(e),this.propertyName.getValue(e),e);else{let r=this.object.getValue(e),n=this.propertyName.getValue(e);i=r&&n?this._getPropertyValue(r,n):void 0}return i}_getPropertyValue(e,t){let i=t.split("."),r=e;for(let n of i)if(r=r[n],r===void 0)return;return r}getClassName(){return"FlowGraphGetPropertyBlock"}};G("FlowGraphGetPropertyBlock",VS)});var EW={};V(EW,{FlowGraphSetPropertyBlock:()=>kS});var kS,TW=S(()=>{Or();Ze();Te();kS=class extends Vt{constructor(e){super(e),this.config=e,this.object=this.registerDataInput("object",Y,e.target),this.value=this.registerDataInput("value",Y),this.propertyName=this.registerDataInput("propertyName",Y,e.propertyName),this.customSetFunction=this.registerDataInput("customSetFunction",Y)}_execute(e,t){try{let i=this.object.getValue(e),r=this.value.getValue(e),n=this.propertyName.getValue(e);this._stopRunningAnimations(e,i,n);let a=this.customSetFunction.getValue(e);a?a(i,n,r,e):this._setPropertyValue(i,n,r)}catch(i){this._reportError(e,i)}this.out._activateSignal(e)}_stopRunningAnimations(e,t,i){let r=e._getGlobalContextVariable("currentlyRunningAnimationGroups",[]);for(let n of r){let a=e.assetsContext.animationGroups.find(o=>o.uniqueId===n);if(a){for(let o of a.targetedAnimations)if(o.target===t&&o.animation.targetProperty===i){a.stop(!0),a.dispose();let l=r.indexOf(n);l!==-1&&(r.splice(l,1),e._setGlobalContextVariable("currentlyRunningAnimationGroups",r))}}}}_setPropertyValue(e,t,i){let r=t.split("."),n=e;for(let a=0;a<r.length-1;a++){let o=r[a];n[o]===void 0&&(n[o]={}),n=n[o]}n[r[r.length-1]]=i}getClassName(){return"FlowGraphSetPropertyBlock"}};G("FlowGraphSetPropertyBlock",kS)});var xW={};V(xW,{FlowGraphGetVariableBlock:()=>WS});var WS,AW=S(()=>{_i();Ze();Te();WS=class extends ht{constructor(e){super(e),this.config=e,this.value=this.registerDataOutput("value",Y,e.initialValue)}_updateOutputs(e){let t=this.config.variable;e.hasVariable(t)&&this.value.setValue(e.getVariable(t),e)}serialize(e){super.serialize(e),e.config.variable=this.config.variable}getClassName(){return"FlowGraphGetVariableBlock"}};G("FlowGraphGetVariableBlock",WS)});var RW={};V(RW,{FlowGraphSetVariableBlock:()=>HS});var HS,bW=S(()=>{Te();Or();Ze();HS=class extends Vt{constructor(e){if(super(e),!e.variable&&!e.variables)throw new Error("FlowGraphSetVariableBlock: variable/variables is not defined");if(e.variables&&e.variable)throw new Error("FlowGraphSetVariableBlock: variable and variables are both defined");if(e.variables)for(let t of e.variables)this.registerDataInput(t,Y);else this.registerDataInput("value",Y)}_execute(e,t){if(this.config?.variables)for(let i of this.config.variables)this._saveVariable(e,i);else this._saveVariable(e,this.config?.variable,"value");this.out._activateSignal(e)}_saveVariable(e,t,i){let r=e._getGlobalContextVariable("currentlyRunningAnimationGroups",[]);for(let a of r){let o=e.assetsContext.animationGroups.find(l=>l.uniqueId==a);if(o){for(let l of o.targetedAnimations)if(l.target===e&&l.animation.targetProperty===t){o.stop();let c=r.indexOf(a);c>-1&&r.splice(c,1),e._setGlobalContextVariable("currentlyRunningAnimationGroups",r);break}}}let n=this.getDataInput(i||t)?.getValue(e);e.setVariable(t,n)}getClassName(){return"FlowGraphSetVariableBlock"}serialize(e){super.serialize(e),e.config.variable=this.config?.variable}};G("FlowGraphSetVariableBlock",HS)});var CW,zS,IW=S(()=>{$r();Ze();CW=new RegExp(/\/\{(\w+)\}(?=\/|$)/g),zS=class{constructor(e,t){this.path=e,this.ownerBlock=t,this.templatedInputs=[];let i=CW.exec(e),r=new Set;for(;i;){let[,n]=i;if(r.has(n))throw new Error("Duplicate template variable detected.");r.add(n),this.templatedInputs.push(t.registerDataInput(n,xt,new Xe(0))),i=CW.exec(e)}}getAccessor(e,t){let i=this.path;for(let r of this.templatedInputs){let n=r.getValue(t).value;if(typeof n!="number"||n<0)throw new Error("Invalid value for templated input.");i=i.replace(`{${r.name}}`,n.toString())}return e.convert(i)}}});var MW={};V(MW,{FlowGraphJsonPointerParserBlock:()=>XS});function yW(s,e){return s.getClassName().startsWith("Color")?s:e==="Color3"?new j(s.x,s.y,s.z):e==="Color4"?new me(s.x,s.y,s.z,s.w):s}function Lte(s){if(s instanceof j)return new E(s.r,s.g,s.b);if(s instanceof me)return new Oe(s.r,s.g,s.b,s.a);throw new Error("Invalid color type")}var XS,PW=S(()=>{IW();Ze();Te();ie();it();il();XS=class extends Sr{constructor(e){super(Y,e),this.config=e,this.object=this.registerDataOutput("object",Y),this.propertyName=this.registerDataOutput("propertyName",Y),this.setterFunction=this.registerDataOutput("setFunction",Y,this._setPropertyValue.bind(this)),this.getterFunction=this.registerDataOutput("getFunction",Y,this._getPropertyValue.bind(this)),this.generateAnimationsFunction=this.registerDataOutput("generateAnimationsFunction",Y,this._getInterpolationAnimationPropertyInfo.bind(this)),this.templateComponent=new zS(e.jsonPointer,this)}_doOperation(e){let t=this.templateComponent.getAccessor(this.config.pathConverter,e),i=t.info.get(t.object),r=t.info.getTarget?.(t.object),n=t.info.getPropertyName?.[0](t.object);if(r)this.object.setValue(r,e),n&&this.propertyName.setValue(n,e);else throw new Error("Object is undefined");return i}_setPropertyValue(e,t,i,r){let n=this.templateComponent.getAccessor(this.config.pathConverter,r),a=n.info.type;a.startsWith("Color")&&(i=yW(i,a)),n.info.set?.(i,n.object)}_getPropertyValue(e,t,i){let r=this.templateComponent.getAccessor(this.config.pathConverter,i),n=r.info.type,a=r.info.get(r.object);return n.startsWith("Color")?Lte(a):a}_getInterpolationAnimationPropertyInfo(e,t,i){let r=this.templateComponent.getAccessor(this.config.pathConverter,i);return(n,a,o,l)=>{let c=[],f=r.info.type;return f.startsWith("Color")&&(n=n.map(h=>({frame:h.frame,value:yW(h.value,f)}))),r.info.interpolation?.forEach((h,u)=>{let d=r.info.getPropertyName?.[u](r.object)||"Animation-interpolation-"+u,p=n;o!==h.type&&(p=n.map(_=>({frame:_.frame,value:h.getValue(void 0,_.value.asArray?_.value.asArray():[_.value],0,1)})));let m=h.buildAnimations(r.object,d,60,p);for(let _ of m)l&&_.babylonAnimation.setEasingFunction(l),c.push(_.babylonAnimation)}),c}}getClassName(){return"FlowGraphJsonPointerParserBlock"}};G("FlowGraphJsonPointerParserBlock",XS)});var io={};V(io,{FlowGraphCombineMatrix2DBlock:()=>jS,FlowGraphCombineMatrix3DBlock:()=>ZS,FlowGraphCombineMatrixBlock:()=>QS,FlowGraphCombineVector2Block:()=>YS,FlowGraphCombineVector3Block:()=>KS,FlowGraphCombineVector4Block:()=>qS,FlowGraphExtractMatrix2DBlock:()=>iE,FlowGraphExtractMatrix3DBlock:()=>rE,FlowGraphExtractMatrixBlock:()=>tE,FlowGraphExtractVector2Block:()=>JS,FlowGraphExtractVector3Block:()=>$S,FlowGraphExtractVector4Block:()=>eE});var sl,nl,YS,KS,qS,QS,jS,ZS,JS,$S,eE,tE,iE,rE,ro=S(()=>{il();Ze();_i();ie();Te();qu();sl=class extends Sr{constructor(e,t,i){super(t,i);for(let r=0;r<e;r++)this.registerDataInput(`input_${r}`,ue,0)}},nl=class extends ht{constructor(e,t,i){super(i),this.registerDataInput("input",t);for(let r=0;r<e;r++)this.registerDataOutput(`output_${r}`,ue,0)}},YS=class extends sl{constructor(e){super(2,Us,e)}_doOperation(e){e._hasExecutionVariable(this,"cachedVector")||e._setExecutionVariable(this,"cachedVector",new he);let t=e._getExecutionVariable(this,"cachedVector",null);return t.set(this.getDataInput("input_0").getValue(e),this.getDataInput("input_1").getValue(e)),t}getClassName(){return"FlowGraphCombineVector2Block"}};G("FlowGraphCombineVector2Block",YS);KS=class extends sl{constructor(e){super(3,kt,e)}_doOperation(e){e._hasExecutionVariable(this,"cachedVector")||e._setExecutionVariable(this,"cachedVector",new E);let t=e._getExecutionVariable(this,"cachedVector",null);return t.set(this.getDataInput("input_0").getValue(e),this.getDataInput("input_1").getValue(e),this.getDataInput("input_2").getValue(e)),t}getClassName(){return"FlowGraphCombineVector3Block"}};G("FlowGraphCombineVector3Block",KS);qS=class extends sl{constructor(e){super(4,Qu,e)}_doOperation(e){e._hasExecutionVariable(this,"cachedVector")||e._setExecutionVariable(this,"cachedVector",new Oe);let t=e._getExecutionVariable(this,"cachedVector",null);return t.set(this.getDataInput("input_0").getValue(e),this.getDataInput("input_1").getValue(e),this.getDataInput("input_2").getValue(e),this.getDataInput("input_3").getValue(e)),t}getClassName(){return"FlowGraphCombineVector4Block"}};G("FlowGraphCombineVector4Block",qS);QS=class extends sl{constructor(e){super(16,dn,e)}_doOperation(e){e._hasExecutionVariable(this,"cachedMatrix")||e._setExecutionVariable(this,"cachedMatrix",new B);let t=e._getExecutionVariable(this,"cachedMatrix",null);return this.config?.inputIsColumnMajor?t.set(this.getDataInput("input_0").getValue(e),this.getDataInput("input_4").getValue(e),this.getDataInput("input_8").getValue(e),this.getDataInput("input_12").getValue(e),this.getDataInput("input_1").getValue(e),this.getDataInput("input_5").getValue(e),this.getDataInput("input_9").getValue(e),this.getDataInput("input_13").getValue(e),this.getDataInput("input_2").getValue(e),this.getDataInput("input_6").getValue(e),this.getDataInput("input_10").getValue(e),this.getDataInput("input_14").getValue(e),this.getDataInput("input_3").getValue(e),this.getDataInput("input_7").getValue(e),this.getDataInput("input_11").getValue(e),this.getDataInput("input_15").getValue(e)):t.set(this.getDataInput("input_0").getValue(e),this.getDataInput("input_1").getValue(e),this.getDataInput("input_2").getValue(e),this.getDataInput("input_3").getValue(e),this.getDataInput("input_4").getValue(e),this.getDataInput("input_5").getValue(e),this.getDataInput("input_6").getValue(e),this.getDataInput("input_7").getValue(e),this.getDataInput("input_8").getValue(e),this.getDataInput("input_9").getValue(e),this.getDataInput("input_10").getValue(e),this.getDataInput("input_11").getValue(e),this.getDataInput("input_12").getValue(e),this.getDataInput("input_13").getValue(e),this.getDataInput("input_14").getValue(e),this.getDataInput("input_15").getValue(e)),t}getClassName(){return"FlowGraphCombineMatrixBlock"}};G("FlowGraphCombineMatrixBlock",QS);jS=class extends sl{constructor(e){super(4,ju,e)}_doOperation(e){e._hasExecutionVariable(this,"cachedMatrix")||e._setExecutionVariable(this,"cachedMatrix",new Pr);let t=e._getExecutionVariable(this,"cachedMatrix",null),i=this.config?.inputIsColumnMajor?[this.getDataInput("input_0").getValue(e),this.getDataInput("input_2").getValue(e),this.getDataInput("input_1").getValue(e),this.getDataInput("input_3").getValue(e)]:[this.getDataInput("input_0").getValue(e),this.getDataInput("input_1").getValue(e),this.getDataInput("input_2").getValue(e),this.getDataInput("input_3").getValue(e)];return t.fromArray(i),t}getClassName(){return"FlowGraphCombineMatrix2DBlock"}};G("FlowGraphCombineMatrix2DBlock",jS);ZS=class extends sl{constructor(e){super(9,Zu,e)}_doOperation(e){e._hasExecutionVariable(this,"cachedMatrix")||e._setExecutionVariable(this,"cachedMatrix",new Dr);let t=e._getExecutionVariable(this,"cachedMatrix",null),i=this.config?.inputIsColumnMajor?[this.getDataInput("input_0").getValue(e),this.getDataInput("input_3").getValue(e),this.getDataInput("input_6").getValue(e),this.getDataInput("input_1").getValue(e),this.getDataInput("input_4").getValue(e),this.getDataInput("input_7").getValue(e),this.getDataInput("input_2").getValue(e),this.getDataInput("input_5").getValue(e),this.getDataInput("input_8").getValue(e)]:[this.getDataInput("input_0").getValue(e),this.getDataInput("input_1").getValue(e),this.getDataInput("input_2").getValue(e),this.getDataInput("input_3").getValue(e),this.getDataInput("input_4").getValue(e),this.getDataInput("input_5").getValue(e),this.getDataInput("input_6").getValue(e),this.getDataInput("input_7").getValue(e),this.getDataInput("input_8").getValue(e)];return t.fromArray(i),t}getClassName(){return"FlowGraphCombineMatrix3DBlock"}};G("FlowGraphCombineMatrix3DBlock",ZS);JS=class extends nl{constructor(e){super(2,Us,e)}_updateOutputs(e){let t=this.getDataInput("input")?.getValue(e);t||(t=he.Zero(),this.getDataInput("input").setValue(t,e)),this.getDataOutput("output_0").setValue(t.x,e),this.getDataOutput("output_1").setValue(t.y,e)}getClassName(){return"FlowGraphExtractVector2Block"}};G("FlowGraphExtractVector2Block",JS);$S=class extends nl{constructor(e){super(3,kt,e)}_updateOutputs(e){let t=this.getDataInput("input")?.getValue(e);t||(t=E.Zero(),this.getDataInput("input").setValue(t,e)),this.getDataOutput("output_0").setValue(t.x,e),this.getDataOutput("output_1").setValue(t.y,e),this.getDataOutput("output_2").setValue(t.z,e)}getClassName(){return"FlowGraphExtractVector3Block"}};G("FlowGraphExtractVector3Block",$S);eE=class extends nl{constructor(e){super(4,Qu,e)}_updateOutputs(e){let t=this.getDataInput("input")?.getValue(e);t||(t=Oe.Zero(),this.getDataInput("input").setValue(t,e)),this.getDataOutput("output_0").setValue(t.x,e),this.getDataOutput("output_1").setValue(t.y,e),this.getDataOutput("output_2").setValue(t.z,e),this.getDataOutput("output_3").setValue(t.w,e)}getClassName(){return"FlowGraphExtractVector4Block"}};G("FlowGraphExtractVector4Block",eE);tE=class extends nl{constructor(e){super(16,dn,e)}_updateOutputs(e){let t=this.getDataInput("input")?.getValue(e);t||(t=B.Identity(),this.getDataInput("input").setValue(t,e));for(let i=0;i<16;i++)this.getDataOutput(`output_${i}`).setValue(t.m[i],e)}getClassName(){return"FlowGraphExtractMatrixBlock"}};G("FlowGraphExtractMatrixBlock",tE);iE=class extends nl{constructor(e){super(4,ju,e)}_updateOutputs(e){let t=this.getDataInput("input")?.getValue(e);t||(t=new Pr,this.getDataInput("input").setValue(t,e));for(let i=0;i<4;i++)this.getDataOutput(`output_${i}`).setValue(t.m[i],e)}getClassName(){return"FlowGraphExtractMatrix2DBlock"}};G("FlowGraphExtractMatrix2DBlock",iE);rE=class extends nl{constructor(e){super(9,Zu,e)}_updateOutputs(e){let t=this.getDataInput("input")?.getValue(e);t||(t=new Dr,this.getDataInput("input").setValue(t,e));for(let i=0;i<9;i++)this.getDataOutput(`output_${i}`).setValue(t.m[i],e)}getClassName(){return"FlowGraphExtractMatrix3DBlock"}};G("FlowGraphExtractMatrix3DBlock",rE)});var $l={};V($l,{FlowGraphBooleanToFloat:()=>sE,FlowGraphBooleanToInt:()=>nE,FlowGraphFloatToBoolean:()=>aE,FlowGraphFloatToInt:()=>cE,FlowGraphIntToBoolean:()=>oE,FlowGraphIntToFloat:()=>lE});var sE,nE,aE,oE,lE,cE,ec=S(()=>{td();Ze();Te();$r();sE=class extends qe{constructor(e){super(Bt,ue,t=>+t,"FlowGraphBooleanToFloat",e)}};G("FlowGraphBooleanToFloat",sE);nE=class extends qe{constructor(e){super(Bt,xt,t=>Xe.FromValue(+t),"FlowGraphBooleanToInt",e)}};G("FlowGraphBooleanToInt",nE);aE=class extends qe{constructor(e){super(ue,Bt,t=>!!t,"FlowGraphFloatToBoolean",e)}};G("FlowGraphFloatToBoolean",aE);oE=class extends qe{constructor(e){super(xt,Bt,t=>!!t.value,"FlowGraphIntToBoolean",e)}};G("FlowGraphIntToBoolean",oE);lE=class extends qe{constructor(e){super(xt,ue,t=>t.value,"FlowGraphIntToFloat",e)}};G("FlowGraphIntToFloat",lE);cE=class extends qe{constructor(e){super(ue,xt,t=>{switch(e?.roundingMode){case"floor":return Xe.FromValue(Math.floor(t));case"ceil":return Xe.FromValue(Math.ceil(t));case"round":return Xe.FromValue(Math.round(t));default:return Xe.FromValue(t)}},"FlowGraphFloatToInt",e)}};G("FlowGraphFloatToInt",cE)});var DW={};V(DW,{EasingFunctionType:()=>Hy,FlowGraphEasingBlock:()=>fE});function wte(s,...e){switch(s){case 11:return new Rf(...e);case 0:return new f_;case 1:return new xf(...e);case 2:return new h_(...e);case 3:return new u_;case 4:return new d_(...e);case 5:return new Af(...e);default:throw new Error("Easing type not yet implemented")}}var Hy,fE,OW=S(()=>{cu();_i();Ze();Te();(function(s){s[s.CircleEase=0]="CircleEase",s[s.BackEase=1]="BackEase",s[s.BounceEase=2]="BounceEase",s[s.CubicEase=3]="CubicEase",s[s.ElasticEase=4]="ElasticEase",s[s.ExponentialEase=5]="ExponentialEase",s[s.PowerEase=6]="PowerEase",s[s.QuadraticEase=7]="QuadraticEase",s[s.QuarticEase=8]="QuarticEase",s[s.QuinticEase=9]="QuinticEase",s[s.SineEase=10]="SineEase",s[s.BezierCurveEase=11]="BezierCurveEase"})(Hy||(Hy={}));fE=class extends ht{constructor(e){super(e),this.config=e,this._easingFunctions={},this.type=this.registerDataInput("type",Y,11),this.mode=this.registerDataInput("mode",ue,0),this.parameters=this.registerDataInput("parameters",Y,[1,0,0,1]),this.easingFunction=this.registerDataOutput("easingFunction",Y)}_updateOutputs(e){let t=this.type.getValue(e),i=this.mode.getValue(e),r=this.parameters.getValue(e);if(t===void 0||i===void 0)return;let n=`${t}-${i}-${r.join("-")}`;if(!this._easingFunctions[n]){let a=wte(t,...r);a.setEasingMode(i),this._easingFunctions[n]=a}this.easingFunction.setValue(this._easingFunctions[n],e)}getClassName(){return"FlowGraphEasingBlock"}};G("FlowGraphEasingBlock",fE)});var LW={};V(LW,{FlowGraphBezierCurveEasingBlock:()=>hE});var hE,wW=S(()=>{cu();_i();Ze();Te();hE=class extends ht{constructor(e){super(e),this.config=e,this._easingFunctions={},this.mode=this.registerDataInput("mode",ue,0),this.controlPoint1=this.registerDataInput("controlPoint1",Us),this.controlPoint2=this.registerDataInput("controlPoint2",Us),this.easingFunction=this.registerDataOutput("easingFunction",Y)}_updateOutputs(e){let t=this.mode.getValue(e),i=this.controlPoint1.getValue(e),r=this.controlPoint2.getValue(e);if(t===void 0)return;let n=`${t}-${i.x}-${i.y}-${r.x}-${r.y}`;if(!this._easingFunctions[n]){let a=new Rf(i.x,i.y,r.x,r.y);a.setEasingMode(t),this._easingFunctions[n]=a}this.easingFunction.setValue(this._easingFunctions[n],e)}getClassName(){return"FlowGraphBezierCurveEasing"}};G("FlowGraphBezierCurveEasing",hE)});var FW={};V(FW,{FlowGraphPointerOverEventBlock:()=>uE});var uE,NW=S(()=>{tl();Ze();Te();us();uE=class extends vr{constructor(e){super(e),this.type="PointerOver",this.pointerId=this.registerDataOutput("pointerId",ue),this.targetMesh=this.registerDataInput("targetMesh",Y,e?.targetMesh),this.meshUnderPointer=this.registerDataOutput("meshUnderPointer",Y)}_executeEvent(e,t){let i=this.targetMesh.getValue(e);this.meshUnderPointer.setValue(t.mesh,e);let r=t.out&&pn(t.out,i);return this.pointerId.setValue(t.pointerId,e),!r&&(t.mesh===i||pn(t.mesh,i))?(this._execute(e),!this.config?.stopPropagation):!0}_preparePendingTasks(e){}_cancelPendingTasks(e){}getClassName(){return"FlowGraphPointerOverEventBlock"}};G("FlowGraphPointerOverEventBlock",uE)});var BW={};V(BW,{FlowGraphPointerOutEventBlock:()=>dE});var dE,UW=S(()=>{tl();Ze();Te();us();dE=class extends vr{constructor(e){super(e),this.type="PointerOut",this.pointerId=this.registerDataOutput("pointerId",ue),this.targetMesh=this.registerDataInput("targetMesh",Y,e?.targetMesh),this.meshOutOfPointer=this.registerDataOutput("meshOutOfPointer",Y)}_executeEvent(e,t){let i=this.targetMesh.getValue(e);return this.meshOutOfPointer.setValue(t.mesh,e),this.pointerId.setValue(t.pointerId,e),!(t.over&&pn(t.mesh,i))&&(t.mesh===i||pn(t.mesh,i))?(this._execute(e),!this.config?.stopPropagation):!0}_preparePendingTasks(e){}_cancelPendingTasks(e){}getClassName(){return"FlowGraphPointerOutEventBlock"}};G("FlowGraphPointerOutEventBlock",dE)});var GW={};V(GW,{FlowGraphContextBlock:()=>pE});var pE,VW=S(()=>{_i();Ze();Te();pE=class extends ht{constructor(e){super(e),this.userVariables=this.registerDataOutput("userVariables",Y),this.executionId=this.registerDataOutput("executionId",ue)}_updateOutputs(e){this.userVariables.setValue(e.userVariables,e),this.executionId.setValue(e.executionId,e)}serialize(e){super.serialize(e)}getClassName(){return"FlowGraphContextBlock"}};G("FlowGraphContextBlock",pE)});var kW={};V(kW,{FlowGraphArrayIndexBlock:()=>mE});var mE,WW=S(()=>{_i();Ze();Te();$r();us();mE=class extends ht{constructor(e){super(e),this.config=e,this.array=this.registerDataInput("array",Y),this.index=this.registerDataInput("index",Y,new Xe(-1)),this.value=this.registerDataOutput("value",Y)}_updateOutputs(e){let t=this.array.getValue(e),i=At(this.index.getValue(e));t&&i>=0&&i<t.length?this.value.setValue(t[i],e):this.value.setValue(null,e)}serialize(e){super.serialize(e)}getClassName(){return"FlowGraphArrayIndexBlock"}};G("FlowGraphArrayIndexBlock",mE)});var HW={};V(HW,{FlowGraphCodeExecutionBlock:()=>zy});var zy,zW=S(()=>{_i();Ze();zy=class extends ht{constructor(e){super(e),this.config=e,this.executionFunction=this.registerDataInput("function",Y),this.value=this.registerDataInput("value",Y),this.result=this.registerDataOutput("result",Y)}_updateOutputs(e){let t=this.executionFunction.getValue(e),i=this.value.getValue(e);t&&this.result.setValue(t(i,e),e)}getClassName(){return"FlowGraphCodeExecutionBlock"}}});var XW={};V(XW,{FlowGraphIndexOfBlock:()=>_E});var _E,YW=S(()=>{_i();Ze();Te();$r();_E=class extends ht{constructor(e){super(e),this.config=e,this.object=this.registerDataInput("object",Y),this.array=this.registerDataInput("array",Y),this.index=this.registerDataOutput("index",xt,new Xe(-1))}_updateOutputs(e){let t=this.object.getValue(e),i=this.array.getValue(e);i&&this.index.setValue(new Xe(i.indexOf(t)),e)}serialize(e){super.serialize(e)}getClassName(){return"FlowGraphIndexOfBlock"}};G("FlowGraphIndexOfBlock",_E)});var KW={};V(KW,{FlowGraphFunctionReferenceBlock:()=>gE});var gE,qW=S(()=>{_i();Ze();Te();gE=class extends ht{constructor(e){super(e),this.functionName=this.registerDataInput("functionName",Ug),this.object=this.registerDataInput("object",Y),this.context=this.registerDataInput("context",Y,null),this.output=this.registerDataOutput("output",Y)}_updateOutputs(e){let t=this.functionName.getValue(e),i=this.object.getValue(e),r=this.context.getValue(e);if(i&&t){let n=i[t];n&&typeof n=="function"&&this.output.setValue(n.bind(r),e)}}getClassName(){return"FlowGraphFunctionReference"}};G("FlowGraphFunctionReference",gE)});var QW={};V(QW,{FlowGraphDataSwitchBlock:()=>vE});var vE,jW=S(()=>{_i();Ze();us();Te();vE=class extends ht{constructor(e){super(e),this.config=e,this._inputCases=new Map,this.case=this.registerDataInput("case",Y,NaN),this.default=this.registerDataInput("default",Y),this.value=this.registerDataOutput("value",Y);let t=this.config.cases||[];for(let i of t){if(i=At(i),this.config.treatCasesAsIntegers&&(i=i|0,this._inputCases.has(i)))return;this._inputCases.set(i,this.registerDataInput(`in_${i}`,Y))}}_updateOutputs(e){let t=this.case.getValue(e),i;to(t)&&(i=this._getOutputValueForCase(At(t),e)),i||(i=this.default.getValue(e)),this.value.setValue(i,e)}_getOutputValueForCase(e,t){return this._inputCases.get(e)?.getValue(t)}getClassName(){return"FlowGraphDataSwitchBlock"}};G("FlowGraphDataSwitchBlock",vE)});function ZW(s,e,t){Xy[`${s}/${e}`]=t}function JW(s){switch(s){case"FlowGraphPlayAnimationBlock":return async()=>(await Promise.resolve().then(()=>(s4(),r4))).FlowGraphPlayAnimationBlock;case"FlowGraphStopAnimationBlock":return async()=>(await Promise.resolve().then(()=>(a4(),n4))).FlowGraphStopAnimationBlock;case"FlowGraphPauseAnimationBlock":return async()=>(await Promise.resolve().then(()=>(l4(),o4))).FlowGraphPauseAnimationBlock;case"FlowGraphInterpolationBlock":return async()=>(await Promise.resolve().then(()=>(f4(),c4))).FlowGraphInterpolationBlock;case"FlowGraphSceneReadyEventBlock":return async()=>(await Promise.resolve().then(()=>(u4(),h4))).FlowGraphSceneReadyEventBlock;case"FlowGraphSceneTickEventBlock":return async()=>(await Promise.resolve().then(()=>(p4(),d4))).FlowGraphSceneTickEventBlock;case"FlowGraphSendCustomEventBlock":return async()=>(await Promise.resolve().then(()=>(_4(),m4))).FlowGraphSendCustomEventBlock;case"FlowGraphReceiveCustomEventBlock":return async()=>(await Promise.resolve().then(()=>(v4(),g4))).FlowGraphReceiveCustomEventBlock;case"FlowGraphMeshPickEventBlock":return async()=>(await Promise.resolve().then(()=>(E4(),S4))).FlowGraphMeshPickEventBlock;case"FlowGraphEBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphEBlock;case"FlowGraphPIBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphPiBlock;case"FlowGraphInfBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphInfBlock;case"FlowGraphNaNBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphNaNBlock;case"FlowGraphRandomBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphRandomBlock;case"FlowGraphAddBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphAddBlock;case"FlowGraphSubtractBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphSubtractBlock;case"FlowGraphMultiplyBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphMultiplyBlock;case"FlowGraphDivideBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphDivideBlock;case"FlowGraphAbsBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphAbsBlock;case"FlowGraphSignBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphSignBlock;case"FlowGraphTruncBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphTruncBlock;case"FlowGraphFloorBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphFloorBlock;case"FlowGraphCeilBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphCeilBlock;case"FlowGraphRoundBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphRoundBlock;case"FlowGraphFractBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphFractionBlock;case"FlowGraphNegationBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphNegationBlock;case"FlowGraphModuloBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphModuloBlock;case"FlowGraphMinBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphMinBlock;case"FlowGraphMaxBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphMaxBlock;case"FlowGraphClampBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphClampBlock;case"FlowGraphSaturateBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphSaturateBlock;case"FlowGraphMathInterpolationBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphMathInterpolationBlock;case"FlowGraphEqualityBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphEqualityBlock;case"FlowGraphLessThanBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphLessThanBlock;case"FlowGraphLessThanOrEqualBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphLessThanOrEqualBlock;case"FlowGraphGreaterThanBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphGreaterThanBlock;case"FlowGraphGreaterThanOrEqualBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphGreaterThanOrEqualBlock;case"FlowGraphIsNaNBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphIsNanBlock;case"FlowGraphIsInfBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphIsInfinityBlock;case"FlowGraphDegToRadBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphDegToRadBlock;case"FlowGraphRadToDegBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphRadToDegBlock;case"FlowGraphSinBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphSinBlock;case"FlowGraphCosBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphCosBlock;case"FlowGraphTanBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphTanBlock;case"FlowGraphASinBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphAsinBlock;case"FlowGraphACosBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphAcosBlock;case"FlowGraphATanBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphAtanBlock;case"FlowGraphATan2Block":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphAtan2Block;case"FlowGraphSinhBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphSinhBlock;case"FlowGraphCoshBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphCoshBlock;case"FlowGraphTanhBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphTanhBlock;case"FlowGraphASinhBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphAsinhBlock;case"FlowGraphACoshBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphAcoshBlock;case"FlowGraphATanhBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphAtanhBlock;case"FlowGraphExponentialBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphExpBlock;case"FlowGraphLogBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphLogBlock;case"FlowGraphLog2Block":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphLog2Block;case"FlowGraphLog10Block":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphLog10Block;case"FlowGraphSquareRootBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphSquareRootBlock;case"FlowGraphPowerBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphPowerBlock;case"FlowGraphCubeRootBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphCubeRootBlock;case"FlowGraphBitwiseAndBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphBitwiseAndBlock;case"FlowGraphBitwiseOrBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphBitwiseOrBlock;case"FlowGraphBitwiseNotBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphBitwiseNotBlock;case"FlowGraphBitwiseXorBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphBitwiseXorBlock;case"FlowGraphBitwiseLeftShiftBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphBitwiseLeftShiftBlock;case"FlowGraphBitwiseRightShiftBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphBitwiseRightShiftBlock;case"FlowGraphLengthBlock":return async()=>(await Promise.resolve().then(()=>(ts(),es))).FlowGraphLengthBlock;case"FlowGraphNormalizeBlock":return async()=>(await Promise.resolve().then(()=>(ts(),es))).FlowGraphNormalizeBlock;case"FlowGraphDotBlock":return async()=>(await Promise.resolve().then(()=>(ts(),es))).FlowGraphDotBlock;case"FlowGraphCrossBlock":return async()=>(await Promise.resolve().then(()=>(ts(),es))).FlowGraphCrossBlock;case"FlowGraphRotate2DBlock":return async()=>(await Promise.resolve().then(()=>(ts(),es))).FlowGraphRotate2DBlock;case"FlowGraphRotate3DBlock":return async()=>(await Promise.resolve().then(()=>(ts(),es))).FlowGraphRotate3DBlock;case"FlowGraphTransposeBlock":return async()=>(await Promise.resolve().then(()=>(Jl(),Zl))).FlowGraphTransposeBlock;case"FlowGraphDeterminantBlock":return async()=>(await Promise.resolve().then(()=>(Jl(),Zl))).FlowGraphDeterminantBlock;case"FlowGraphInvertMatrixBlock":return async()=>(await Promise.resolve().then(()=>(Jl(),Zl))).FlowGraphInvertMatrixBlock;case"FlowGraphMatrixMultiplicationBlock":return async()=>(await Promise.resolve().then(()=>(Jl(),Zl))).FlowGraphMatrixMultiplicationBlock;case"FlowGraphBranchBlock":return async()=>(await Promise.resolve().then(()=>(L4(),O4))).FlowGraphBranchBlock;case"FlowGraphSetDelayBlock":return async()=>(await Promise.resolve().then(()=>(B4(),N4))).FlowGraphSetDelayBlock;case"FlowGraphCancelDelayBlock":return async()=>(await Promise.resolve().then(()=>(G4(),U4))).FlowGraphCancelDelayBlock;case"FlowGraphCallCounterBlock":return async()=>(await Promise.resolve().then(()=>(k4(),V4))).FlowGraphCallCounterBlock;case"FlowGraphDebounceBlock":return async()=>(await Promise.resolve().then(()=>(H4(),W4))).FlowGraphDebounceBlock;case"FlowGraphThrottleBlock":return async()=>(await Promise.resolve().then(()=>(X4(),z4))).FlowGraphThrottleBlock;case"FlowGraphDoNBlock":return async()=>(await Promise.resolve().then(()=>(K4(),Y4))).FlowGraphDoNBlock;case"FlowGraphFlipFlopBlock":return async()=>(await Promise.resolve().then(()=>(Q4(),q4))).FlowGraphFlipFlopBlock;case"FlowGraphForLoopBlock":return async()=>(await Promise.resolve().then(()=>(Z4(),j4))).FlowGraphForLoopBlock;case"FlowGraphMultiGateBlock":return async()=>(await Promise.resolve().then(()=>($4(),J4))).FlowGraphMultiGateBlock;case"FlowGraphSequenceBlock":return async()=>(await Promise.resolve().then(()=>(tW(),eW))).FlowGraphSequenceBlock;case"FlowGraphSwitchBlock":return async()=>(await Promise.resolve().then(()=>(rW(),iW))).FlowGraphSwitchBlock;case"FlowGraphWaitAllBlock":return async()=>(await Promise.resolve().then(()=>(nW(),sW))).FlowGraphWaitAllBlock;case"FlowGraphWhileLoopBlock":return async()=>(await Promise.resolve().then(()=>(oW(),aW))).FlowGraphWhileLoopBlock;case"FlowGraphConsoleLogBlock":return async()=>(await Promise.resolve().then(()=>(cW(),lW))).FlowGraphConsoleLogBlock;case"FlowGraphConditionalBlock":return async()=>(await Promise.resolve().then(()=>(hW(),fW))).FlowGraphConditionalDataBlock;case"FlowGraphConstantBlock":return async()=>(await Promise.resolve().then(()=>(dW(),uW))).FlowGraphConstantBlock;case"FlowGraphTransformCoordinatesSystemBlock":return async()=>(await Promise.resolve().then(()=>(mW(),pW))).FlowGraphTransformCoordinatesSystemBlock;case"FlowGraphGetAssetBlock":return async()=>(await Promise.resolve().then(()=>(gW(),_W))).FlowGraphGetAssetBlock;case"FlowGraphGetPropertyBlock":return async()=>(await Promise.resolve().then(()=>(SW(),vW))).FlowGraphGetPropertyBlock;case"FlowGraphSetPropertyBlock":return async()=>(await Promise.resolve().then(()=>(TW(),EW))).FlowGraphSetPropertyBlock;case"FlowGraphGetVariableBlock":return async()=>(await Promise.resolve().then(()=>(AW(),xW))).FlowGraphGetVariableBlock;case"FlowGraphSetVariableBlock":return async()=>(await Promise.resolve().then(()=>(bW(),RW))).FlowGraphSetVariableBlock;case"FlowGraphJsonPointerParserBlock":return async()=>(await Promise.resolve().then(()=>(PW(),MW))).FlowGraphJsonPointerParserBlock;case"FlowGraphLeadingZerosBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphLeadingZerosBlock;case"FlowGraphTrailingZerosBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphTrailingZerosBlock;case"FlowGraphOneBitsCounterBlock":return async()=>(await Promise.resolve().then(()=>(Ue(),Be))).FlowGraphOneBitsCounterBlock;case"FlowGraphCombineVector2Block":return async()=>(await Promise.resolve().then(()=>(ro(),io))).FlowGraphCombineVector2Block;case"FlowGraphCombineVector3Block":return async()=>(await Promise.resolve().then(()=>(ro(),io))).FlowGraphCombineVector3Block;case"FlowGraphCombineVector4Block":return async()=>(await Promise.resolve().then(()=>(ro(),io))).FlowGraphCombineVector4Block;case"FlowGraphCombineMatrixBlock":return async()=>(await Promise.resolve().then(()=>(ro(),io))).FlowGraphCombineMatrixBlock;case"FlowGraphExtractVector2Block":return async()=>(await Promise.resolve().then(()=>(ro(),io))).FlowGraphExtractVector2Block;case"FlowGraphExtractVector3Block":return async()=>(await Promise.resolve().then(()=>(ro(),io))).FlowGraphExtractVector3Block;case"FlowGraphExtractVector4Block":return async()=>(await Promise.resolve().then(()=>(ro(),io))).FlowGraphExtractVector4Block;case"FlowGraphExtractMatrixBlock":return async()=>(await Promise.resolve().then(()=>(ro(),io))).FlowGraphExtractMatrixBlock;case"FlowGraphTransformVectorBlock":return async()=>(await Promise.resolve().then(()=>(ts(),es))).FlowGraphTransformBlock;case"FlowGraphTransformCoordinatesBlock":return async()=>(await Promise.resolve().then(()=>(ts(),es))).FlowGraphTransformCoordinatesBlock;case"FlowGraphConjugateBlock":return async()=>(await Promise.resolve().then(()=>(ts(),es))).FlowGraphConjugateBlock;case"FlowGraphAngleBetweenBlock":return async()=>(await Promise.resolve().then(()=>(ts(),es))).FlowGraphAngleBetweenBlock;case"FlowGraphQuaternionFromAxisAngleBlock":return async()=>(await Promise.resolve().then(()=>(ts(),es))).FlowGraphQuaternionFromAxisAngleBlock;case"FlowGraphAxisAngleFromQuaternionBlock":return async()=>(await Promise.resolve().then(()=>(ts(),es))).FlowGraphAxisAngleFromQuaternionBlock;case"FlowGraphQuaternionFromDirectionsBlock":return async()=>(await Promise.resolve().then(()=>(ts(),es))).FlowGraphQuaternionFromDirectionsBlock;case"FlowGraphMatrixDecompose":return async()=>(await Promise.resolve().then(()=>(Jl(),Zl))).FlowGraphMatrixDecomposeBlock;case"FlowGraphMatrixCompose":return async()=>(await Promise.resolve().then(()=>(Jl(),Zl))).FlowGraphMatrixComposeBlock;case"FlowGraphBooleanToFloat":return async()=>(await Promise.resolve().then(()=>(ec(),$l))).FlowGraphBooleanToFloat;case"FlowGraphBooleanToInt":return async()=>(await Promise.resolve().then(()=>(ec(),$l))).FlowGraphBooleanToInt;case"FlowGraphFloatToBoolean":return async()=>(await Promise.resolve().then(()=>(ec(),$l))).FlowGraphFloatToBoolean;case"FlowGraphIntToBoolean":return async()=>(await Promise.resolve().then(()=>(ec(),$l))).FlowGraphIntToBoolean;case"FlowGraphIntToFloat":return async()=>(await Promise.resolve().then(()=>(ec(),$l))).FlowGraphIntToFloat;case"FlowGraphFloatToInt":return async()=>(await Promise.resolve().then(()=>(ec(),$l))).FlowGraphFloatToInt;case"FlowGraphEasingBlock":return async()=>(await Promise.resolve().then(()=>(OW(),DW))).FlowGraphEasingBlock;case"FlowGraphBezierCurveEasing":return async()=>(await Promise.resolve().then(()=>(wW(),LW))).FlowGraphBezierCurveEasingBlock;case"FlowGraphPointerOverEventBlock":return async()=>(await Promise.resolve().then(()=>(NW(),FW))).FlowGraphPointerOverEventBlock;case"FlowGraphPointerOutEventBlock":return async()=>(await Promise.resolve().then(()=>(UW(),BW))).FlowGraphPointerOutEventBlock;case"FlowGraphContextBlock":return async()=>(await Promise.resolve().then(()=>(VW(),GW))).FlowGraphContextBlock;case"FlowGraphArrayIndexBlock":return async()=>(await Promise.resolve().then(()=>(WW(),kW))).FlowGraphArrayIndexBlock;case"FlowGraphCodeExecutionBlock":return async()=>(await Promise.resolve().then(()=>(zW(),HW))).FlowGraphCodeExecutionBlock;case"FlowGraphIndexOfBlock":return async()=>(await Promise.resolve().then(()=>(YW(),XW))).FlowGraphIndexOfBlock;case"FlowGraphFunctionReference":return async()=>(await Promise.resolve().then(()=>(qW(),KW))).FlowGraphFunctionReferenceBlock;case"FlowGraphDataSwitchBlock":return async()=>(await Promise.resolve().then(()=>(jW(),QW))).FlowGraphDataSwitchBlock;default:if(Xy[s])return Xy[s];throw new Error(`Unknown block name ${s}`)}}var Xy,Yy=S(()=>{Xy={}});function Fte(s,e){for(let t of s)for(let i of t.dataOutputs)if(i.uniqueId===e)return i;throw new Error("Could not find data out connection with unique id "+e)}function Nte(s,e){for(let t of s)if(t instanceof Ni){for(let i of t.signalInputs)if(i.uniqueId===e)return i}throw new Error("Could not find signal in connection with unique id "+e)}async function $W(s,e){let t=await Promise.all(s.allBlocks.map(async i=>await JW(i.className)()));return Bte(s,e,t)}function Bte(s,e,t){let i=e.coordinator.createGraph(),r=[],n=e.valueParseFunction??Ju;for(let a=0;a<s.allBlocks.length;a++){let o=s.allBlocks[a],l=Gte(o,{scene:e.coordinator.config.scene,pathConverter:e.pathConverter,assetsContainer:e.coordinator.config.scene,valueParseFunction:n},t[a]);r.push(l),l instanceof vr&&i.addEventBlock(l)}for(let a of r){for(let o of a.dataInputs)for(let l of o.connectedPointIds){let c=Fte(r,l);o.connectTo(c)}if(a instanceof Ni)for(let o of a.signalOutputs)for(let l of o.connectedPointIds){let c=Nte(r,l);o.connectTo(c)}}for(let a of s.executionContexts)Ute(a,{graph:i,valueParseFunction:n},s.rightHanded);return i}function Ute(s,e,t){let i=e.graph.createContext();s.enableLogging&&(i.enableLogging=!0),i.treatDataAsRightHanded=t||!1;let r=e.valueParseFunction??Ju;i.uniqueId=s.uniqueId;let n=i.getScene();if(s._assetsContext){let a=s._assetsContext,o={meshes:a.meshes?.map(l=>n.getMeshById(l)),lights:a.lights?.map(l=>n.getLightByName(l)),cameras:a.cameras?.map(l=>n.getCameraByName(l)),materials:a.materials?.map(l=>n.getMaterialById(l)),textures:a.textures?.map(l=>n.getTextureByName(l)),animations:a.animations?.map(l=>n.animations.find(c=>c.name===l)),skeletons:a.skeletons?.map(l=>n.getSkeletonByName(l)),particleSystems:a.particleSystems?.map(l=>n.getParticleSystemById(l)),animationGroups:a.animationGroups?.map(l=>n.getAnimationGroupByName(l)),transformNodes:a.transformNodes?.map(l=>n.getTransformNodeById(l)),rootNodes:[],multiMaterials:[],morphTargetManagers:[],geometries:[],actionManagers:[],environmentTexture:null,postProcesses:[],sounds:null,effectLayers:[],layers:[],reflectionProbes:[],lensFlareSystems:[],proceduralTextures:[],getNodes:function(){throw new Error("Function not implemented.")}};i.assetsContext=o}for(let a in s._userVariables){let o=r(a,s._userVariables,i.assetsContext,n);i.userVariables[a]=o}for(let a in s._connectionValues){let o=r(a,s._connectionValues,i.assetsContext,n);i._setConnectionValueByKey(a,o)}return i}function Gte(s,e,t){let i={},r=e.valueParseFunction??Ju;if(s.config)for(let a in s.config)i[a]=r(a,s.config,e.assetsContainer||e.scene,e.scene);if(Yk(s.className)){if(!e.pathConverter)throw new Error("Path converter is required for this block");i.pathConverter=e.pathConverter}let n=new t(i);n.uniqueId=s.uniqueId;for(let a=0;a<s.dataInputs.length;a++){let o=n.getDataInput(s.dataInputs[a].name);if(o)o.deserialize(s.dataInputs[a]);else throw new Error("Could not find data input with name "+s.dataInputs[a].name+" in block "+s.className)}for(let a=0;a<s.dataOutputs.length;a++){let o=n.getDataOutput(s.dataOutputs[a].name);if(o)o.deserialize(s.dataOutputs[a]);else throw new Error("Could not find data output with name "+s.dataOutputs[a].name+" in block "+s.className)}return n.metadata=s.metadata,n.deserialize&&n.deserialize(s),n}var eH=S(()=>{Yy();Hg();tl();eo();Hf();Ze()});function Ky(s){let[e,t]=s.split(":");return qy({op:e,extension:t})}function qy(s,e=!0){let t=s.extension?SE[s.extension]?.[s.op]:Vte[s.op];if(!t&&(P.Warn(`No mapping found for operation ${s.op} and extension ${s.extension||"KHR_interactivity"}`),e)){let i={},r={flows:{}};if(s.inputValueSockets){i.values={};for(let n in s.inputValueSockets)i.values[n]={name:n}}return s.outputValueSockets&&(r.values={},Object.keys(s.outputValueSockets).forEach(n=>{r.values[n]={name:n}})),{blocks:[],inputs:i,outputs:r}}return t}function od(s,e,t){SE[e]||(SE[e]={}),SE[e][s]=t}function De(s,e=["a"],t){return{blocks:[s],inputs:{values:e.reduce((i,r)=>(i[r]={name:r},i),{})},outputs:{values:{value:{name:"value"}}},extraProcessor(i,r,n,a,o){var l;if(t){(l=o[0]).config||(l.config={}),o[0].config.preventIntegerFloatArithmetic=!0;let c=-1;Object.keys(i.values||{}).find(f=>i.values?.[f].type!==void 0?(c=i.values[f].type,!0):!1),c!==-1&&(o[0].config.type=a.arrays.types[c].flowGraphType)}return o},validation(i){return t?tH(i):{valid:!0}}}}function tH(s){if(s.values){let e=Object.keys(s.values).map(i=>s.values[i].type).filter(i=>i!==void 0);if(!e.every(i=>i===e[0]))return{valid:!1,error:"All inputs must be of the same type"}}return{valid:!0}}var SE,Vte,EE=S(()=>{Ee();Ze();SE={BABYLON:{"flow/log":{blocks:["FlowGraphConsoleLogBlock"],inputs:{values:{message:{name:"message"}}}}}},Vte={"event/onStart":{blocks:["FlowGraphSceneReadyEventBlock"],outputs:{flows:{out:{name:"done"}}}},"event/onTick":{blocks:["FlowGraphSceneTickEventBlock"],inputs:{},outputs:{values:{timeSinceLastTick:{name:"deltaTime",gltfType:"number"}},flows:{out:{name:"done"}}}},"event/send":{blocks:["FlowGraphSendCustomEventBlock"],extraProcessor(s,e,t,i,r){if(e.op!=="event/send"||!s.configuration||Object.keys(s.configuration).length!==1)throw new Error("Receive event should have a single configuration object, the event itself");let a=s.configuration.event.value[0];if(typeof a!="number")throw new Error("Event id should be a number");let o=i.arrays.events[a],l=r[0];return l.config||(l.config={}),l.config.eventId=o.eventId,l.config.eventData=o.eventData,r}},"event/receive":{blocks:["FlowGraphReceiveCustomEventBlock"],outputs:{flows:{out:{name:"done"}}},validation(s,e){if(!s.configuration)return P.Error("Receive event should have a configuration object"),{valid:!1,error:"Receive event should have a configuration object"};let t=s.configuration.event;if(!t)return P.Error("Receive event should have a single configuration object, the event itself"),{valid:!1,error:"Receive event should have a single configuration object, the event itself"};let i=t.value[0];return typeof i!="number"?(P.Error("Event id should be a number"),{valid:!1,error:"Event id should be a number"}):e.events?.[i]?{valid:!0}:(P.Error(`Event with id ${i} not found`),{valid:!1,error:`Event with id ${i} not found`})},extraProcessor(s,e,t,i,r){if(e.op!=="event/receive"||!s.configuration||Object.keys(s.configuration).length!==1)throw new Error("Receive event should have a single configuration object, the event itself");let a=s.configuration.event.value[0];if(typeof a!="number")throw new Error("Event id should be a number");let o=i.arrays.events[a],l=r[0];return l.config||(l.config={}),l.config.eventId=o.eventId,l.config.eventData=o.eventData,r}},"math/E":De("FlowGraphEBlock"),"math/Pi":De("FlowGraphPIBlock"),"math/Inf":De("FlowGraphInfBlock"),"math/NaN":De("FlowGraphNaNBlock"),"math/abs":De("FlowGraphAbsBlock"),"math/sign":De("FlowGraphSignBlock"),"math/trunc":De("FlowGraphTruncBlock"),"math/floor":De("FlowGraphFloorBlock"),"math/ceil":De("FlowGraphCeilBlock"),"math/round":{blocks:["FlowGraphRoundBlock"],configuration:{},inputs:{values:{a:{name:"a"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(s,e,t,i,r){var n;return(n=r[0]).config||(n.config={}),r[0].config.roundHalfAwayFromZero=!0,r}},"math/fract":De("FlowGraphFractBlock"),"math/neg":De("FlowGraphNegationBlock"),"math/add":De("FlowGraphAddBlock",["a","b"],!0),"math/sub":De("FlowGraphSubtractBlock",["a","b"],!0),"math/mul":{blocks:["FlowGraphMultiplyBlock"],extraProcessor(s,e,t,i,r){var n;(n=r[0]).config||(n.config={}),r[0].config.useMatrixPerComponent=!0,r[0].config.preventIntegerFloatArithmetic=!0;let a=-1;return Object.keys(s.values||{}).find(o=>s.values?.[o].type!==void 0?(a=s.values[o].type,!0):!1),a!==-1&&(r[0].config.type=i.arrays.types[a].flowGraphType),r},validation(s){return s.values?tH(s):{valid:!0}}},"math/div":De("FlowGraphDivideBlock",["a","b"],!0),"math/rem":De("FlowGraphModuloBlock",["a","b"]),"math/min":De("FlowGraphMinBlock",["a","b"]),"math/max":De("FlowGraphMaxBlock",["a","b"]),"math/clamp":De("FlowGraphClampBlock",["a","b","c"]),"math/saturate":De("FlowGraphSaturateBlock"),"math/mix":De("FlowGraphMathInterpolationBlock",["a","b","c"]),"math/eq":De("FlowGraphEqualityBlock",["a","b"]),"math/lt":De("FlowGraphLessThanBlock",["a","b"]),"math/le":De("FlowGraphLessThanOrEqualBlock",["a","b"]),"math/gt":De("FlowGraphGreaterThanBlock",["a","b"]),"math/ge":De("FlowGraphGreaterThanOrEqualBlock",["a","b"]),"math/isNaN":De("FlowGraphIsNaNBlock"),"math/isInf":De("FlowGraphIsInfBlock"),"math/select":{blocks:["FlowGraphConditionalBlock"],inputs:{values:{condition:{name:"condition"},a:{name:"onTrue"},b:{name:"onFalse"}}},outputs:{values:{value:{name:"output"}}}},"math/random":{blocks:["FlowGraphRandomBlock"],outputs:{values:{value:{name:"value"}}}},"math/sin":De("FlowGraphSinBlock"),"math/cos":De("FlowGraphCosBlock"),"math/tan":De("FlowGraphTanBlock"),"math/asin":De("FlowGraphASinBlock"),"math/acos":De("FlowGraphACosBlock"),"math/atan":De("FlowGraphATanBlock"),"math/atan2":De("FlowGraphATan2Block",["a","b"]),"math/sinh":De("FlowGraphSinhBlock"),"math/cosh":De("FlowGraphCoshBlock"),"math/tanh":De("FlowGraphTanhBlock"),"math/asinh":De("FlowGraphASinhBlock"),"math/acosh":De("FlowGraphACoshBlock"),"math/atanh":De("FlowGraphATanhBlock"),"math/exp":De("FlowGraphExponentialBlock"),"math/log":De("FlowGraphLogBlock"),"math/log2":De("FlowGraphLog2Block"),"math/log10":De("FlowGraphLog10Block"),"math/sqrt":De("FlowGraphSquareRootBlock"),"math/cbrt":De("FlowGraphCubeRootBlock"),"math/pow":De("FlowGraphPowerBlock",["a","b"]),"math/length":De("FlowGraphLengthBlock"),"math/normalize":De("FlowGraphNormalizeBlock"),"math/dot":De("FlowGraphDotBlock",["a","b"]),"math/cross":De("FlowGraphCrossBlock",["a","b"]),"math/rotate2D":{blocks:["FlowGraphRotate2DBlock"],inputs:{values:{a:{name:"a"},angle:{name:"b"}}},outputs:{values:{value:{name:"value"}}}},"math/rotate3D":{blocks:["FlowGraphRotate3DBlock"],inputs:{values:{a:{name:"a"},rotation:{name:"b"}}},outputs:{values:{value:{name:"value"}}}},"math/transform":{blocks:["FlowGraphTransformVectorBlock"],inputs:{values:{a:{name:"a"},b:{name:"b"}}},outputs:{values:{value:{name:"value"}}}},"math/combine2":{blocks:["FlowGraphCombineVector2Block"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}}},"math/combine3":{blocks:["FlowGraphCombineVector3Block"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}}},"math/combine4":{blocks:["FlowGraphCombineVector4Block"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"},d:{name:"input_3",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}}},"math/extract2":{blocks:["FlowGraphExtractVector2Block"],inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"}}}},"math/extract3":{blocks:["FlowGraphExtractVector3Block"],inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"}}}},"math/extract4":{blocks:["FlowGraphExtractVector4Block"],inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"},3:{name:"output_3"}}}},"math/transpose":De("FlowGraphTransposeBlock"),"math/determinant":De("FlowGraphDeterminantBlock"),"math/inverse":De("FlowGraphInvertMatrixBlock"),"math/matMul":De("FlowGraphMatrixMultiplicationBlock",["a","b"]),"math/matCompose":{blocks:["FlowGraphMatrixCompose"],inputs:{values:{translation:{name:"position",gltfType:"float3"},rotation:{name:"rotationQuaternion",gltfType:"float4"},scale:{name:"scaling",gltfType:"float3"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(s,e,t,i,r,n){let a=r[0].dataInputs.find(o=>o.name==="rotationQuaternion");if(!a)throw new Error("Rotation quaternion input not found");return n._connectionValues[a.uniqueId]&&(n._connectionValues[a.uniqueId].type="Quaternion"),r}},"math/matDecompose":{blocks:["FlowGraphMatrixDecompose"],inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{translation:{name:"position"},rotation:{name:"rotationQuaternion"},scale:{name:"scaling"}}}},"math/quatConjugate":De("FlowGraphConjugateBlock",["a"]),"math/quatMul":{blocks:["FlowGraphMultiplyBlock"],inputs:{values:{a:{name:"a",gltfType:"vector4"},b:{name:"b",gltfType:"vector4"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(s,e,t,i,r){var n;return(n=r[0]).config||(n.config={}),r[0].config.type="Quaternion",r}},"math/quatAngleBetween":De("FlowGraphAngleBetweenBlock",["a","b"]),"math/quatFromAxisAngle":{blocks:["FlowGraphQuaternionFromAxisAngleBlock"],inputs:{values:{axis:{name:"a",gltfType:"float3"},angle:{name:"b",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}}},"math/quatToAxisAngle":De("FlowGraphAxisAngleFromQuaternionBlock",["a"]),"math/quatFromDirections":De("FlowGraphQuaternionFromDirectionsBlock",["a","b"]),"math/combine2x2":{blocks:["FlowGraphCombineMatrix2DBlock"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"},d:{name:"input_3",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(s,e,t,i,r){var n;return(n=r[0]).config||(n.config={}),r[0].config.inputIsColumnMajor=!0,r}},"math/extract2x2":{blocks:["FlowGraphExtractMatrix2DBlock"],inputs:{values:{a:{name:"input",gltfType:"float2x2"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"},3:{name:"output_3"}}}},"math/combine3x3":{blocks:["FlowGraphCombineMatrix3DBlock"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"},d:{name:"input_3",gltfType:"number"},e:{name:"input_4",gltfType:"number"},f:{name:"input_5",gltfType:"number"},g:{name:"input_6",gltfType:"number"},h:{name:"input_7",gltfType:"number"},i:{name:"input_8",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(s,e,t,i,r){var n;return(n=r[0]).config||(n.config={}),r[0].config.inputIsColumnMajor=!0,r}},"math/extract3x3":{blocks:["FlowGraphExtractMatrix3DBlock"],inputs:{values:{a:{name:"input",gltfType:"float3x3"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"},3:{name:"output_3"},4:{name:"output_4"},5:{name:"output_5"},6:{name:"output_6"},7:{name:"output_7"},8:{name:"output_8"}}}},"math/combine4x4":{blocks:["FlowGraphCombineMatrixBlock"],inputs:{values:{a:{name:"input_0",gltfType:"number"},b:{name:"input_1",gltfType:"number"},c:{name:"input_2",gltfType:"number"},d:{name:"input_3",gltfType:"number"},e:{name:"input_4",gltfType:"number"},f:{name:"input_5",gltfType:"number"},g:{name:"input_6",gltfType:"number"},h:{name:"input_7",gltfType:"number"},i:{name:"input_8",gltfType:"number"},j:{name:"input_9",gltfType:"number"},k:{name:"input_10",gltfType:"number"},l:{name:"input_11",gltfType:"number"},m:{name:"input_12",gltfType:"number"},n:{name:"input_13",gltfType:"number"},o:{name:"input_14",gltfType:"number"},p:{name:"input_15",gltfType:"number"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(s,e,t,i,r){var n;return(n=r[0]).config||(n.config={}),r[0].config.inputIsColumnMajor=!0,r}},"math/extract4x4":{blocks:["FlowGraphExtractMatrixBlock"],configuration:{},inputs:{values:{a:{name:"input",gltfType:"number"}}},outputs:{values:{0:{name:"output_0"},1:{name:"output_1"},2:{name:"output_2"},3:{name:"output_3"},4:{name:"output_4"},5:{name:"output_5"},6:{name:"output_6"},7:{name:"output_7"},8:{name:"output_8"},9:{name:"output_9"},10:{name:"output_10"},11:{name:"output_11"},12:{name:"output_12"},13:{name:"output_13"},14:{name:"output_14"},15:{name:"output_15"}}}},"math/not":{blocks:["FlowGraphBitwiseNotBlock"],inputs:{values:{a:{name:"a"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(s,e,t,i,r,n){var a;(a=r[0]).config||(a.config={});let o=r[0].dataInputs[0];return r[0].config.valueType=n._connectionValues[o.uniqueId]?.type??"FlowGraphInteger",r}},"math/and":{blocks:["FlowGraphBitwiseAndBlock"],inputs:{values:{a:{name:"a"},b:{name:"b"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(s,e,t,i,r,n){var a;(a=r[0]).config||(a.config={});let o=r[0].dataInputs[0],l=r[0].dataInputs[1];return r[0].config.valueType=n._connectionValues[o.uniqueId]?.type??n._connectionValues[l.uniqueId]?.type??"FlowGraphInteger",r}},"math/or":{blocks:["FlowGraphBitwiseOrBlock"],inputs:{values:{a:{name:"a"},b:{name:"b"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(s,e,t,i,r,n){var a;(a=r[0]).config||(a.config={});let o=r[0].dataInputs[0],l=r[0].dataInputs[1];return r[0].config.valueType=n._connectionValues[o.uniqueId]?.type??n._connectionValues[l.uniqueId]?.type??"FlowGraphInteger",r}},"math/xor":{blocks:["FlowGraphBitwiseXorBlock"],inputs:{values:{a:{name:"a"},b:{name:"b"}}},outputs:{values:{value:{name:"value"}}},extraProcessor(s,e,t,i,r,n){var a;(a=r[0]).config||(a.config={});let o=r[0].dataInputs[0],l=r[0].dataInputs[1];return r[0].config.valueType=n._connectionValues[o.uniqueId]?.type??n._connectionValues[l.uniqueId]?.type??"FlowGraphInteger",r}},"math/asr":De("FlowGraphBitwiseRightShiftBlock",["a","b"]),"math/lsl":De("FlowGraphBitwiseLeftShiftBlock",["a","b"]),"math/clz":De("FlowGraphLeadingZerosBlock"),"math/ctz":De("FlowGraphTrailingZerosBlock"),"math/popcnt":De("FlowGraphOneBitsCounterBlock"),"math/rad":De("FlowGraphDegToRadBlock"),"math/deg":De("FlowGraphRadToDegBlock"),"type/boolToInt":De("FlowGraphBooleanToInt"),"type/boolToFloat":De("FlowGraphBooleanToFloat"),"type/intToBool":De("FlowGraphIntToBoolean"),"type/intToFloat":De("FlowGraphIntToFloat"),"type/floatToInt":De("FlowGraphFloatToInt"),"type/floatToBool":De("FlowGraphFloatToBoolean"),"flow/sequence":{blocks:["FlowGraphSequenceBlock"],extraProcessor(s,e,t,i,r){let n=r[0];return n.config||(n.config={}),n.config.outputSignalCount=Object.keys(s.flows||[]).length,n.signalOutputs.forEach((a,o)=>{a.name="out_"+o}),r}},"flow/branch":{blocks:["FlowGraphBranchBlock"],outputs:{flows:{true:{name:"onTrue"},false:{name:"onFalse"}}}},"flow/switch":{blocks:["FlowGraphSwitchBlock"],configuration:{cases:{name:"cases",inOptions:!0,defaultValue:[]}},inputs:{values:{selection:{name:"case"},default:{name:"default"}}},validation(s){if(s.configuration&&s.configuration.cases){let e=s.configuration.cases.value;if(!e.every(r=>typeof r=="number"&&/^-?\d+$/.test(r.toString())))return P.Warn("Switch cases should be integers. Using empty array instead."),s.configuration.cases.value=[],{valid:!0};let i=new Set(e);s.configuration.cases.value=Array.from(i)}return{valid:!0}},extraProcessor(s,e,t,i,r){if(e.op!=="flow/switch"||!s.flows||Object.keys(s.flows).length===0)throw new Error("Switch should have a single configuration object, the cases array");return r[0].signalOutputs.forEach(a=>{a.name!=="default"&&(a.name="out_"+a.name)}),r}},"flow/while":{blocks:["FlowGraphWhileLoopBlock"],outputs:{flows:{loopBody:{name:"executionFlow"}}}},"flow/for":{blocks:["FlowGraphForLoopBlock"],configuration:{initialIndex:{name:"initialIndex",gltfType:"number",inOptions:!0,defaultValue:0}},inputs:{values:{startIndex:{name:"startIndex",gltfType:"number"},endIndex:{name:"endIndex",gltfType:"number"}}},outputs:{values:{index:{name:"index"}},flows:{loopBody:{name:"executionFlow"}}},extraProcessor(s,e,t,i,r){let n=r[0];return n.config||(n.config={}),n.config.incrementIndexWhenLoopDone=!0,r}},"flow/doN":{blocks:["FlowGraphDoNBlock"],configuration:{},inputs:{values:{n:{name:"maxExecutions",gltfType:"number"}}},outputs:{values:{currentCount:{name:"executionCount"}}}},"flow/multiGate":{blocks:["FlowGraphMultiGateBlock"],configuration:{isRandom:{name:"isRandom",gltfType:"boolean",inOptions:!0,defaultValue:!1},isLoop:{name:"isLoop",gltfType:"boolean",inOptions:!0,defaultValue:!1}},extraProcessor(s,e,t,i,r){if(e.op!=="flow/multiGate"||!s.flows||Object.keys(s.flows).length===0)throw new Error("MultiGate should have a single configuration object, the number of output flows");let n=r[0];return n.config||(n.config={}),n.config.outputSignalCount=Object.keys(s.flows).length,n.signalOutputs.forEach((a,o)=>{a.name="out_"+o}),r}},"flow/waitAll":{blocks:["FlowGraphWaitAllBlock"],configuration:{inputFlows:{name:"inputSignalCount",gltfType:"number",inOptions:!0,defaultValue:0}},inputs:{flows:{reset:{name:"reset"},"[segment]":{name:"in_$1"}}},validation(s){return typeof s.configuration?.inputFlows?.value[0]!="number"&&(s.configuration=s.configuration||{inputFlows:{value:[0]}},s.configuration.inputFlows.value=[0]),{valid:!0}}},"flow/throttle":{blocks:["FlowGraphThrottleBlock"],outputs:{flows:{err:{name:"error"}}}},"flow/setDelay":{blocks:["FlowGraphSetDelayBlock"],outputs:{flows:{err:{name:"error"}}}},"flow/cancelDelay":{blocks:["FlowGraphCancelDelayBlock"]},"variable/get":{blocks:["FlowGraphGetVariableBlock"],validation(s){return s.configuration?.variable?.value?{valid:!0}:(P.Error("Variable get block should have a variable configuration"),{valid:!1,error:"Variable get block should have a variable configuration"})},configuration:{variable:{name:"variable",gltfType:"number",flowGraphType:"string",inOptions:!0,isVariable:!0,dataTransformer(s,e){return[e.getVariableName(s[0])]}}}},"variable/set":{blocks:["FlowGraphSetVariableBlock"],configuration:{variable:{name:"variable",gltfType:"number",flowGraphType:"string",inOptions:!0,isVariable:!0,dataTransformer(s,e){return[e.getVariableName(s[0])]}}}},"variable/setMultiple":{blocks:["FlowGraphSetVariableBlock"],configuration:{variables:{name:"variables",gltfType:"number",flowGraphType:"string",inOptions:!0,dataTransformer(s,e){return[s[0].map(t=>e.getVariableName(t))]}}},extraProcessor(s,e,t,i,r){return r[0].dataInputs.forEach(a=>{a.name=i.getVariableName(+a.name)}),r}},"variable/interpolate":{blocks:["FlowGraphInterpolationBlock","FlowGraphContextBlock","FlowGraphPlayAnimationBlock","FlowGraphBezierCurveEasing","FlowGraphGetVariableBlock"],configuration:{variable:{name:"propertyName",inOptions:!0,isVariable:!0,dataTransformer(s,e){return[e.getVariableName(s[0])]}},useSlerp:{name:"animationType",inOptions:!0,defaultValue:!1,dataTransformer:s=>s[0]===!0?["Quaternion"]:[void 0]}},inputs:{values:{value:{name:"value_1"},duration:{name:"duration_1",gltfType:"number"},p1:{name:"controlPoint1",toBlock:"FlowGraphBezierCurveEasing"},p2:{name:"controlPoint2",toBlock:"FlowGraphBezierCurveEasing"}},flows:{in:{name:"in",toBlock:"FlowGraphPlayAnimationBlock"}}},outputs:{flows:{err:{name:"error",toBlock:"FlowGraphPlayAnimationBlock"},out:{name:"out",toBlock:"FlowGraphPlayAnimationBlock"},done:{name:"done",toBlock:"FlowGraphPlayAnimationBlock"}}},interBlockConnectors:[{input:"object",output:"userVariables",inputBlockIndex:2,outputBlockIndex:1,isVariable:!0},{input:"animation",output:"animation",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0},{input:"easingFunction",output:"easingFunction",inputBlockIndex:0,outputBlockIndex:3,isVariable:!0},{input:"value_0",output:"value",inputBlockIndex:0,outputBlockIndex:4,isVariable:!0}],extraProcessor(s,e,t,i,r){var n,a;let o=r[0],l=s.configuration?.variable.value[0];if(typeof l!="number")throw P.Error("Variable index is not defined for variable interpolation block"),new Error("Variable index is not defined for variable interpolation block");let c=i.arrays.staticVariables[l];typeof o.config.animationType.value>"u"&&(i.arrays.staticVariables,o.config.animationType.value=Hk(c.type));let f=r[4];return f.config||(f.config={}),(n=f.config).variable||(n.variable={}),f.config.variable.value=i.getVariableName(l),(a=r[3]).config||(a.config={}),r}},"pointer/get":{blocks:["FlowGraphGetPropertyBlock","FlowGraphJsonPointerParserBlock"],configuration:{pointer:{name:"jsonPointer",toBlock:"FlowGraphJsonPointerParserBlock"}},inputs:{values:{"[segment]":{name:"$1",toBlock:"FlowGraphJsonPointerParserBlock"}}},interBlockConnectors:[{input:"object",output:"object",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"propertyName",output:"propertyName",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"customGetFunction",output:"getFunction",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0}],extraProcessor(s,e,t,i,r){return r.forEach(n=>{n.className==="FlowGraphJsonPointerParserBlock"&&(n.config||(n.config={}),n.config.outputValue=!0)}),r}},"pointer/set":{blocks:["FlowGraphSetPropertyBlock","FlowGraphJsonPointerParserBlock"],configuration:{pointer:{name:"jsonPointer",toBlock:"FlowGraphJsonPointerParserBlock"}},inputs:{values:{value:{name:"value"},"[segment]":{name:"$1",toBlock:"FlowGraphJsonPointerParserBlock"}}},outputs:{flows:{err:{name:"error"}}},interBlockConnectors:[{input:"object",output:"object",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"propertyName",output:"propertyName",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"customSetFunction",output:"setFunction",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0}],extraProcessor(s,e,t,i,r){return r.forEach(n=>{n.className==="FlowGraphJsonPointerParserBlock"&&(n.config||(n.config={}),n.config.outputValue=!0)}),r}},"pointer/interpolate":{blocks:["FlowGraphInterpolationBlock","FlowGraphJsonPointerParserBlock","FlowGraphPlayAnimationBlock","FlowGraphBezierCurveEasing"],configuration:{pointer:{name:"jsonPointer",toBlock:"FlowGraphJsonPointerParserBlock"}},inputs:{values:{value:{name:"value_1"},"[segment]":{name:"$1",toBlock:"FlowGraphJsonPointerParserBlock"},duration:{name:"duration_1",gltfType:"number"},p1:{name:"controlPoint1",toBlock:"FlowGraphBezierCurveEasing"},p2:{name:"controlPoint2",toBlock:"FlowGraphBezierCurveEasing"}},flows:{in:{name:"in",toBlock:"FlowGraphPlayAnimationBlock"}}},outputs:{flows:{err:{name:"error",toBlock:"FlowGraphPlayAnimationBlock"},out:{name:"out",toBlock:"FlowGraphPlayAnimationBlock"},done:{name:"done",toBlock:"FlowGraphPlayAnimationBlock"}}},interBlockConnectors:[{input:"object",output:"object",inputBlockIndex:2,outputBlockIndex:1,isVariable:!0},{input:"propertyName",output:"propertyName",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"customBuildAnimation",output:"generateAnimationsFunction",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"animation",output:"animation",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0},{input:"easingFunction",output:"easingFunction",inputBlockIndex:0,outputBlockIndex:3,isVariable:!0},{input:"value_0",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0}],extraProcessor(s,e,t,i,r){return r.forEach(n=>{n.className==="FlowGraphJsonPointerParserBlock"?(n.config||(n.config={}),n.config.outputValue=!0):n.className==="FlowGraphInterpolationBlock"&&(n.config||(n.config={}),Object.keys(s.values||[]).forEach(a=>{let o=s.values?.[a];if(a==="value"&&o){let l=o.type;l!==void 0&&(n.config.animationType=i.arrays.types[l].flowGraphType)}}))}),r}},"animation/start":{blocks:["FlowGraphPlayAnimationBlock","FlowGraphArrayIndexBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],inputs:{values:{animation:{name:"index",gltfType:"number",toBlock:"FlowGraphArrayIndexBlock"},speed:{name:"speed",gltfType:"number"},startTime:{name:"from",gltfType:"number",dataTransformer:(s,e)=>[s[0]*e._animationTargetFps]},endTime:{name:"to",gltfType:"number",dataTransformer:(s,e)=>[s[0]*e._animationTargetFps]}}},outputs:{flows:{err:{name:"error"}}},interBlockConnectors:[{input:"animationGroup",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"animationGroups",inputBlockIndex:1,outputBlockIndex:2,isVariable:!0}],extraProcessor(s,e,t,i,r,n,a){let o=r[r.length-1];return o.config||(o.config={}),o.config.glTF=a,r}},"animation/stop":{blocks:["FlowGraphStopAnimationBlock","FlowGraphArrayIndexBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],inputs:{values:{animation:{name:"index",gltfType:"number",toBlock:"FlowGraphArrayIndexBlock"}}},outputs:{flows:{err:{name:"error"}}},interBlockConnectors:[{input:"animationGroup",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"animationGroups",inputBlockIndex:1,outputBlockIndex:2,isVariable:!0}],extraProcessor(s,e,t,i,r,n,a){let o=r[r.length-1];return o.config||(o.config={}),o.config.glTF=a,r}},"animation/stopAt":{blocks:["FlowGraphStopAnimationBlock","FlowGraphArrayIndexBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],configuration:{},inputs:{values:{animation:{name:"index",gltfType:"number",toBlock:"FlowGraphArrayIndexBlock"},stopTime:{name:"stopAtFrame",gltfType:"number",dataTransformer:(s,e)=>[s[0]*e._animationTargetFps]}}},outputs:{flows:{err:{name:"error"}}},interBlockConnectors:[{input:"animationGroup",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"animationGroups",inputBlockIndex:1,outputBlockIndex:2,isVariable:!0}],extraProcessor(s,e,t,i,r,n,a){let o=r[r.length-1];return o.config||(o.config={}),o.config.glTF=a,r}},"math/switch":{blocks:["FlowGraphDataSwitchBlock"],configuration:{cases:{name:"cases",inOptions:!0,defaultValue:[]}},inputs:{values:{selection:{name:"case"}}},validation(s){if(s.configuration&&s.configuration.cases){let e=s.configuration.cases.value;if(!e.every(r=>typeof r=="number"&&/^-?\d+$/.test(r.toString())))return P.Warn("Switch cases should be integers. Using empty array instead."),s.configuration.cases.value=[],{valid:!0};let i=new Set(e);s.configuration.cases.value=Array.from(i)}return{valid:!0}},extraProcessor(s,e,t,i,r){let n=r[0];return n.dataInputs.forEach(a=>{a.name!=="default"&&a.name!=="case"&&(a.name="in_"+a.name)}),n.config||(n.config={}),n.config.treatCasesAsIntegers=!0,r}},"debug/log":{blocks:["FlowGraphConsoleLogBlock"],configuration:{message:{name:"messageTemplate",inOptions:!0}}}}});var kte,TE,iH=S(()=>{EE();Ee();pa();kte={float:{length:1,flowGraphType:"number",elementType:"number"},bool:{length:1,flowGraphType:"boolean",elementType:"boolean"},float2:{length:2,flowGraphType:"Vector2",elementType:"number"},float3:{length:3,flowGraphType:"Vector3",elementType:"number"},float4:{length:4,flowGraphType:"Vector4",elementType:"number"},float4x4:{length:16,flowGraphType:"Matrix",elementType:"number"},float2x2:{length:4,flowGraphType:"Matrix2D",elementType:"number"},float3x3:{length:9,flowGraphType:"Matrix3D",elementType:"number"},int:{length:1,flowGraphType:"FlowGraphInteger",elementType:"number"}},TE=class{constructor(e,t,i=60){this._interactivityGraph=e,this._gltf=t,this._animationTargetFps=i,this._types=[],this._mappings=[],this._staticVariables=[],this._events=[],this._internalEventsCounter=0,this._nodes=[],this._parseTypes(),this._parseDeclarations(),this._parseVariables(),this._parseEvents(),this._parseNodes()}get arrays(){return{types:this._types,mappings:this._mappings,staticVariables:this._staticVariables,events:this._events,nodes:this._nodes}}_parseTypes(){if(this._interactivityGraph.types)for(let e of this._interactivityGraph.types)this._types.push(kte[e.signature])}_parseDeclarations(){if(this._interactivityGraph.declarations)for(let e of this._interactivityGraph.declarations){let t=qy(e);if(!t)throw P.Error(["No mapping found for declaration",e]),new Error("Error parsing declarations");this._mappings.push({flowGraphMapping:t,fullOperationName:e.extension?e.op+":"+e.extension:e.op})}}_parseVariables(){if(this._interactivityGraph.variables)for(let e of this._interactivityGraph.variables){let t=this._parseVariable(e);this._staticVariables.push(t)}}_parseVariable(e,t){let i=this._types[e.type];if(!i)throw P.Error(["No type found for variable",e]),new Error("Error parsing variables");if(e.value&&e.value.length!==i.length)throw P.Error(["Invalid value length for variable",e,i]),new Error("Error parsing variables");let r=e.value||[];if(!r.length)switch(i.flowGraphType){case"boolean":r.push(!1);break;case"FlowGraphInteger":r.push(0);break;case"number":r.push(NaN);break;case"Vector2":r.push(NaN,NaN);break;case"Vector3":r.push(NaN,NaN,NaN);break;case"Vector4":case"Matrix2D":case"Quaternion":r.fill(NaN,0,4);break;case"Matrix":r.fill(NaN,0,16);break;case"Matrix3D":r.fill(NaN,0,9);break;default:break}return i.elementType==="number"&&typeof r[0]=="string"&&(r[0]=parseFloat(r[0])),{type:i.flowGraphType,value:t?t(r,this):r}}_parseEvents(){if(this._interactivityGraph.events)for(let e of this._interactivityGraph.events){let t={eventId:e.id||"internalEvent_"+this._internalEventsCounter++};e.values&&(t.eventData=Object.keys(e.values).map(i=>{let r=e.values?.[i];if(!r)throw P.Error(["No value found for event key",i]),new Error("Error parsing events");let n=this._types[r.type];if(!n)throw P.Error(["No type found for event value",r]),new Error("Error parsing events");let a=typeof r.value<"u"?this._parseVariable(r):void 0;return{id:i,type:n.flowGraphType,eventData:!0,value:a}})),this._events.push(t)}}_parseNodes(){if(this._interactivityGraph.nodes)for(let e of this._interactivityGraph.nodes){if(typeof e.declaration!="number")throw P.Error(["No declaration found for node",e]),new Error("Error parsing nodes");let t=this._mappings[e.declaration];if(!t)throw P.Error(["No mapping found for node",e]),new Error("Error parsing nodes");if(t.flowGraphMapping.validation){let r=t.flowGraphMapping.validation(e,this._interactivityGraph,this._gltf);if(!r.valid)throw new Error(`Error validating interactivity node ${this._interactivityGraph.declarations?.[e.declaration].op} - ${r.error}`)}let i=[];for(let r of t.flowGraphMapping.blocks){let n=this._getEmptyBlock(r,t.fullOperationName);this._parseNodeConfiguration(e,n,t.flowGraphMapping,r),i.push(n)}this._nodes.push({blocks:i,fullOperationName:t.fullOperationName})}}_getEmptyBlock(e,t){return{uniqueId:Vi(),className:e,dataInputs:[],dataOutputs:[],signalInputs:[],signalOutputs:[],config:{},type:t,metadata:{}}}_parseNodeConfiguration(e,t,i,r){let n=t.config;if(e.configuration){let a=Object.keys(e.configuration);for(let o of a){let l=e.configuration?.[o];if(!l)throw P.Error(["No value found for node configuration",o]),new Error("Error parsing node configuration");let c=i.configuration?.[o];if(c&&c.toBlock?c.toBlock===r:i.blocks.indexOf(r)===0){let h=c?.name||o;(!l||typeof l.value>"u")&&typeof c?.defaultValue<"u"?n[h]={value:c.defaultValue}:l.value.length>=0?n[h]={value:l.value.length===1?l.value[0]:l.value}:P.Warn(["Invalid value for node configuration",l]),c&&c.dataTransformer&&(n[h].value=c.dataTransformer([n[h].value],this)[0])}}}}_parseNodeConnections(e){for(let t=0;t<this._nodes.length;t++){let i=this._interactivityGraph.nodes?.[t];if(!i)throw P.Error(["No node found for interactivity node",this._nodes[t]]),new Error("Error parsing node connections");let r=this._nodes[t],n=this._mappings[i.declaration];if(!n)throw P.Error(["No mapping found for node",i]),new Error("Error parsing node connections");let a=i.flows||{},o=Object.keys(a).sort();for(let f of o){let h=a[f],u=n.flowGraphMapping.outputs?.flows?.[f],d=u?.name||f,p=this._createNewSocketConnection(d,!0);(u&&u.toBlock&&r.blocks.find(F=>F.className===u.toBlock)||r.blocks[0]).signalOutputs.push(p);let _=h.node,v=this._nodes[_];if(!v)throw P.Error(["No node found for input node id",_]),new Error("Error parsing node connections");let T=Ky(v.fullOperationName);if(!T)throw P.Error(["No mapping found for input node",v]),new Error("Error parsing node connections");let C=T.inputs?.flows?.[h.socket||"in"],I=!1;if(!C)for(let F in T.inputs?.flows)F.startsWith("[")&&F.endsWith("]")&&(I=!0,C=T.inputs?.flows?.[F]);let R=C?I?C.name.replace("$1",h.socket||""):C.name:h.socket||"in",b=C&&C.toBlock&&v.blocks.find(F=>F.className===C.toBlock)||v.blocks[0],M=b.signalInputs.find(F=>F.name===R);M||(M=this._createNewSocketConnection(R),b.signalInputs.push(M)),M.connectedPointIds.push(p.uniqueId),p.connectedPointIds.push(M.uniqueId)}let l=i.values||{},c=Object.keys(l);for(let f of c){let h=l[f],u=n.flowGraphMapping.inputs?.values?.[f],d=!1;if(!u)for(let v in n.flowGraphMapping.inputs?.values)v.startsWith("[")&&v.endsWith("]")&&(d=!0,u=n.flowGraphMapping.inputs?.values?.[v]);let p=u?d?u.name.replace("$1",f):u.name:f,m=this._createNewSocketConnection(p);if((u&&u.toBlock&&r.blocks.find(v=>v.className===u.toBlock)||r.blocks[0]).dataInputs.push(m),h.value!==void 0){let v=this._parseVariable(h,u&&u.dataTransformer);e._connectionValues[m.uniqueId]=v}else if(typeof h.node<"u"){let v=h.node,T=h.socket||"value",C=this._nodes[v];if(!C)throw P.Error(["No node found for output socket reference",h]),new Error("Error parsing node connections");let I=Ky(C.fullOperationName);if(!I)throw P.Error(["No mapping found for output socket reference",h]),new Error("Error parsing node connections");let R=I.outputs?.values?.[T],b=!1;if(!R)for(let D in I.outputs?.values)D.startsWith("[")&&D.endsWith("]")&&(b=!0,R=I.outputs?.values?.[D]);let M=R?b?R.name.replace("$1",T):R?.name:T,F=R&&R.toBlock&&C.blocks.find(D=>D.className===R.toBlock)||C.blocks[0],U=F.dataOutputs.find(D=>D.name===M);U||(U=this._createNewSocketConnection(M,!0),F.dataOutputs.push(U)),m.connectedPointIds.push(U.uniqueId),U.connectedPointIds.push(m.uniqueId)}else throw P.Error(["Invalid value for value connection",h]),new Error("Error parsing node connections")}if(n.flowGraphMapping.interBlockConnectors)for(let f of n.flowGraphMapping.interBlockConnectors){let h=f.input,u=f.output,d=f.isVariable;this._connectFlowGraphNodes(h,u,r.blocks[f.inputBlockIndex],r.blocks[f.outputBlockIndex],d)}if(n.flowGraphMapping.extraProcessor){let f=this._interactivityGraph.declarations?.[i.declaration];if(!f)throw P.Error(["No declaration found for extra processor",i]),new Error("Error parsing node connections");r.blocks=n.flowGraphMapping.extraProcessor(i,f,n.flowGraphMapping,this,r.blocks,e,this._gltf)}}}_createNewSocketConnection(e,t){return{uniqueId:Vi(),name:e,_connectionType:t?1:0,connectedPointIds:[]}}_connectFlowGraphNodes(e,t,i,r,n){let a=n?i.dataInputs:i.signalInputs,o=n?r.dataOutputs:r.signalOutputs,l=a.find(f=>f.name===e)||this._createNewSocketConnection(e),c=o.find(f=>f.name===t)||this._createNewSocketConnection(t,!0);a.find(f=>f.name===e)||a.push(l),o.find(f=>f.name===t)||o.push(c),l.connectedPointIds.push(c.uniqueId),c.connectedPointIds.push(l.uniqueId)}getVariableName(e){return"staticVariable_"+e}serializeToFlowGraph(){let e={uniqueId:Vi(),_userVariables:{},_connectionValues:{}};this._parseNodeConnections(e);for(let i=0;i<this._staticVariables.length;i++){let r=this._staticVariables[i];e._userVariables[this.getVariableName(i)]=r}return{rightHanded:!0,allBlocks:this._nodes.reduce((i,r)=>i.concat(r.blocks),[]),executionContexts:[e]}}}});var rH={};V(rH,{FlowGraphGLTFDataProvider:()=>Qy});var Qy,sH=S(()=>{_i();Ze();Qy=class extends ht{constructor(e){super();let t=e.glTF,i=t.animations?.map(n=>n._babylonAnimationGroup)||[];this.animationGroups=this.registerDataOutput("animationGroups",Y,i);let r=t.nodes?.map(n=>n._babylonTransformNode)||[];this.nodes=this.registerDataOutput("nodes",Y,r)}getClassName(){return"FlowGraphGLTFDataProvider"}}});var aH={};V(aH,{KHR_interactivity:()=>xE,_AddInteractivityObjectModel:()=>nH});function nH(s){Jr("/extensions/KHR_interactivity/?/activeCamera/rotation",{get:()=>{if(!s.activeCamera)return new K(NaN,NaN,NaN,NaN);let e=K.FromRotationMatrix(s.activeCamera.getWorldMatrix()).normalize();return s.useRightHandedSystem||(e.w*=-1,e.x*=-1),e},type:"Quaternion",getTarget:()=>s.activeCamera}),Jr("/extensions/KHR_interactivity/?/activeCamera/position",{get:()=>{if(!s.activeCamera)return new E(NaN,NaN,NaN);let e=s.activeCamera.getWorldMatrix().getTranslation();return s.useRightHandedSystem||(e.x*=-1),e},type:"Vector3",getTarget:()=>s.activeCamera}),Jr("/animations/{}/extensions/KHR_interactivity/isPlaying",{get:e=>e._babylonAnimationGroup?.isPlaying??!1,type:"boolean",getTarget:e=>e._babylonAnimationGroup}),Jr("/animations/{}/extensions/KHR_interactivity/minTime",{get:e=>(e._babylonAnimationGroup?.from??0)/60,type:"number",getTarget:e=>e._babylonAnimationGroup}),Jr("/animations/{}/extensions/KHR_interactivity/maxTime",{get:e=>(e._babylonAnimationGroup?.to??0)/60,type:"number",getTarget:e=>e._babylonAnimationGroup}),Jr("/animations/{}/extensions/KHR_interactivity/playhead",{get:e=>(e._babylonAnimationGroup?.getCurrentFrame()??0)/60,type:"number",getTarget:e=>e._babylonAnimationGroup}),Jr("/animations/{}/extensions/KHR_interactivity/virtualPlayhead",{get:e=>(e._babylonAnimationGroup?.getCurrentFrame()??0)/60,type:"number",getTarget:e=>e._babylonAnimationGroup})}var ld,xE,oH=S(()=>{Hg();eH();mt();Za();iH();Yy();ie();ld="KHR_interactivity",xE=class{constructor(e){this._loader=e,this.name=ld,this.enabled=this._loader.isExtensionUsed(ld),this._pathConverter=pg(this._loader.gltf),e._skipStartAnimationStep=!0;let t=e.babylonScene;t&&nH(t)}dispose(){this._loader=null,delete this._pathConverter}async onReady(){if(!this._loader.babylonScene||!this._pathConverter)return;let e=this._loader.babylonScene,t=this._loader.gltf.extensions?.KHR_interactivity;if(!t)return;let i=new mn({scene:e});i.dispatchEventsSynchronously=!1;let r=t.graphs.map(n=>new TE(n,this._loader.gltf,this._loader.parent.targetFps).serializeToFlowGraph());await Promise.all(r.map(async n=>await $W(n,{coordinator:i,pathConverter:this._pathConverter}))),i.start()}};ZW(ld,"FlowGraphGLTFDataProvider",async()=>(await Promise.resolve().then(()=>(sH(),rH))).FlowGraphGLTFDataProvider);Ce(ld);te(ld,!0,s=>new xE(s))});var tc,lH=S(()=>{Ye();je();ie();rs();Dn();Gm();Te();_t.AddNodeConstructor("Light_Type_0",(s,e)=>()=>new tc(s,E.Zero(),e));tc=class extends Ds{get shadowAngle(){return this._shadowAngle}set shadowAngle(e){this._shadowAngle=e,this.forceProjectionMatrixCompute()}get direction(){return this._direction}set direction(e){let t=this.needCube();if(this._direction=e,this.needCube()!==t&&this._shadowGenerators){let i=this._shadowGenerators.values();for(let r=i.next();r.done!==!0;r=i.next())r.value.recreateShadowMap()}}constructor(e,t,i){super(e,i),this._shadowAngle=Math.PI/2,this.position=t}getClassName(){return"PointLight"}getTypeID(){return Ke.LIGHTTYPEID_POINTLIGHT}needCube(){return!this.direction}getShadowDirection(e){if(this.direction)return super.getShadowDirection(e);switch(e){case 0:return new E(1,0,0);case 1:return new E(-1,0,0);case 2:return new E(0,-1,0);case 3:return new E(0,1,0);case 4:return new E(0,0,1);case 5:return new E(0,0,-1)}return E.Zero()}_setDefaultShadowProjectionMatrix(e,t,i){let r=this.getScene().activeCamera;if(!r)return;let n=this.shadowMinZ!==void 0?this.shadowMinZ:r.minZ,a=this.shadowMaxZ!==void 0?this.shadowMaxZ:r.maxZ,o=this.getScene().getEngine().useReverseDepthBuffer;B.PerspectiveFovLHToRef(this.shadowAngle,1,o?a:n,o?n:a,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,o)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){return this.computeTransformedInformation()?this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,0,t):this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,0,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,0,0,t),this}transferToNodeMaterialEffect(e,t){return this.computeTransformedInformation()?e.setFloat3(t,this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z):e.setFloat3(t,this.position.x,this.position.y,this.position.z),this}prepareLightSpecificDefines(e,t){e["POINTLIGHT"+t]=!0}};x([y()],tc.prototype,"shadowAngle",null);G("BABYLON.PointLight",tc)});var cH={};V(cH,{KHR_lights:()=>RE});var AE,RE,fH=S(()=>{ie();it();Vm();lH();hg();Dn();Nt();mt();AE="KHR_lights_punctual",RE=class{constructor(e){this.name=AE,this._loader=e,this.enabled=this._loader.isExtensionUsed(AE)}dispose(){this._loader=null,delete this._lights}onLoading(){let e=this._loader.gltf.extensions;if(e&&e[this.name]){let t=e[this.name];this._lights=t.lights,ve.Assign(this._lights)}}loadNodeAsync(e,t,i){return Pe.LoadExtensionAsync(e,t,this.name,async(r,n)=>(this._loader._allMaterialsDirtyRequired=!0,await this._loader.loadNodeAsync(e,t,a=>{let o,l=ve.Get(r,this._lights,n.light),c=l.name||a.name;switch(this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer,l.type){case"directional":{let f=new Yi(c,E.Backward(),this._loader.babylonScene);f.position.setAll(0),o=f;break}case"point":{o=new tc(c,E.Zero(),this._loader.babylonScene);break}case"spot":{let f=new ui(c,E.Zero(),E.Backward(),0,1,this._loader.babylonScene);f.angle=(l.spot&&l.spot.outerConeAngle||Math.PI/4)*2,f.innerAngle=(l.spot&&l.spot.innerConeAngle||0)*2,o=f;break}default:throw this._loader.babylonScene._blockEntityCollection=!1,new Error(`${r}: Invalid light type (${l.type})`)}o._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=!1,l._babylonLight=o,o.falloffType=Ke.FALLOFF_GLTF,o.diffuse=l.color?j.FromArray(l.color):j.White(),o.intensity=l.intensity==null?1:l.intensity,o.range=l.range==null?Number.MAX_VALUE:l.range,o.parent=a,this._loader._babylonLights.push(o),Pe.AddPointerMetadata(o,r),i(a)})))}};Ce(AE);te(AE,!0,s=>new RE(s))});var hH={};V(hH,{EXT_lights_ies:()=>CE});var bE,CE,uH=S(()=>{ie();it();hg();Dn();Nt();mt();Ut();bE="EXT_lights_ies",CE=class{constructor(e){this.name=bE,this._loader=e,this.enabled=this._loader.isExtensionUsed(bE)}dispose(){this._loader=null,delete this._lights}onLoading(){let e=this._loader.gltf.extensions;if(e&&e[this.name]){let t=e[this.name];this._lights=t.lights,ve.Assign(this._lights)}}loadNodeAsync(e,t,i){return Pe.LoadExtensionAsync(e,t,this.name,async(r,n)=>{this._loader._allMaterialsDirtyRequired=!0;let a,o,l=await this._loader.loadNodeAsync(e,t,f=>{o=ve.Get(r,this._lights,n.light);let h=o.name||f.name;this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer,a=new ui(h,E.Zero(),E.Backward(),0,1,this._loader.babylonScene),a.angle=Math.PI/2,a.innerAngle=0,a._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=!1,o._babylonLight=a,a.falloffType=Ke.FALLOFF_GLTF,a.diffuse=n.color?j.FromArray(n.color):j.White(),a.intensity=n.multiplier||1,a.range=Number.MAX_VALUE,a.parent=f,this._loader._babylonLights.push(a),Pe.AddPointerMetadata(a,r),i(f)}),c;if(o.uri)c=await this._loader.loadUriAsync(e,o,o.uri);else{let f=ve.Get(`${e}/bufferView`,this._loader.gltf.bufferViews,o.bufferView);c=await this._loader.loadBufferViewAsync(`/bufferViews/${f.index}`,f)}return a.iesProfileTexture=new H(name+"_iesProfile",this._loader.babylonScene,!0,!1,void 0,null,null,c,!0,void 0,void 0,void 0,void 0,".ies"),l})}};Ce(bE);te(bE,!0,s=>new CE(s))});var dH={};V(dH,{KHR_materials_anisotropy:()=>yE});var IE,yE,pH=S(()=>{Li();Nt();mt();IE="KHR_materials_anisotropy",yE=class{constructor(e){this.name=IE,this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed(IE)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Pe.LoadExtensionAsync(e,t,this.name,async(r,n)=>{let a=new Array;a.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),a.push(this._loadIridescencePropertiesAsync(r,n,i)),await Promise.all(a)})}async _loadIridescencePropertiesAsync(e,t,i){if(!(i instanceof J))throw new Error(`${e}: Material type not supported`);let r=new Array;i.anisotropy.isEnabled=!0,i.anisotropy.intensity=t.anisotropyStrength??0,i.anisotropy.angle=t.anisotropyRotation??0,t.anisotropyTexture&&(t.anisotropyTexture.nonColorData=!0,r.push(this._loader.loadTextureInfoAsync(`${e}/anisotropyTexture`,t.anisotropyTexture,n=>{n.name=`${i.name} (Anisotropy Intensity)`,i.anisotropy.texture=n}))),await Promise.all(r)}};Ce(IE);te(IE,!0,s=>new yE(s))});var mH={};V(mH,{KHR_materials_clearcoat:()=>PE});var ME,PE,_H=S(()=>{Li();Nt();mt();ME="KHR_materials_clearcoat",PE=class{constructor(e){this.name=ME,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(ME)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Pe.LoadExtensionAsync(e,t,this.name,async(r,n)=>{let a=new Array;a.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),a.push(this._loadClearCoatPropertiesAsync(r,n,i)),await Promise.all(a)})}_loadClearCoatPropertiesAsync(e,t,i){if(!(i instanceof J))throw new Error(`${e}: Material type not supported`);let r=new Array;return i.clearCoat.isEnabled=!0,i.clearCoat.useRoughnessFromMainTexture=!1,i.clearCoat.remapF0OnInterfaceChange=!1,t.clearcoatFactor!=null?i.clearCoat.intensity=t.clearcoatFactor:i.clearCoat.intensity=0,t.clearcoatTexture&&r.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatTexture`,t.clearcoatTexture,n=>{n.name=`${i.name} (ClearCoat)`,i.clearCoat.texture=n})),t.clearcoatRoughnessFactor!=null?i.clearCoat.roughness=t.clearcoatRoughnessFactor:i.clearCoat.roughness=0,t.clearcoatRoughnessTexture&&(t.clearcoatRoughnessTexture.nonColorData=!0,r.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatRoughnessTexture`,t.clearcoatRoughnessTexture,n=>{n.name=`${i.name} (ClearCoat Roughness)`,i.clearCoat.textureRoughness=n}))),t.clearcoatNormalTexture&&(t.clearcoatNormalTexture.nonColorData=!0,r.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatNormalTexture`,t.clearcoatNormalTexture,n=>{n.name=`${i.name} (ClearCoat Normal)`,i.clearCoat.bumpTexture=n})),i.invertNormalMapX=!i.getScene().useRightHandedSystem,i.invertNormalMapY=i.getScene().useRightHandedSystem,t.clearcoatNormalTexture.scale!=null&&(i.clearCoat.bumpTexture.level=t.clearcoatNormalTexture.scale)),Promise.all(r).then(()=>{})}};Ce(ME);te(ME,!0,s=>new PE(s))});var gH={};V(gH,{EXT_materials_diffuse_roughness:()=>OE});var DE,OE,vH=S(()=>{Li();Nt();mt();If();DE="EXT_materials_diffuse_roughness",OE=class{constructor(e){this.name=DE,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(DE)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Pe.LoadExtensionAsync(e,t,this.name,async(r,n)=>{let a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),a.push(this._loadDiffuseRoughnessPropertiesAsync(r,n,i)),await Promise.all(a).then(()=>{})})}_loadDiffuseRoughnessPropertiesAsync(e,t,i){if(!(i instanceof J))throw new Error(`${e}: Material type not supported`);let r=new Array;return i.brdf.baseDiffuseModel=L.MATERIAL_DIFFUSE_MODEL_E_OREN_NAYAR,t.diffuseRoughnessFactor!=null?i.baseDiffuseRoughness=t.diffuseRoughnessFactor:i.baseDiffuseRoughness=0,t.diffuseRoughnessTexture&&r.push(this._loader.loadTextureInfoAsync(`${e}/diffuseRoughnessTexture`,t.diffuseRoughnessTexture,n=>{n.name=`${i.name} (Diffuse Roughness)`,i.baseDiffuseRoughnessTexture=n})),Promise.all(r).then(()=>{})}};Ce(DE);te(DE,!0,s=>new OE(s))});var SH={};V(SH,{KHR_materials_diffuse_transmission:()=>wE});var LE,wE,EH=S(()=>{Li();Nt();it();mt();LE="KHR_materials_diffuse_transmission",wE=class{constructor(e){this.name=LE,this.order=174,this._loader=e,this.enabled=this._loader.isExtensionUsed(LE),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Pe.LoadExtensionAsync(e,t,this.name,async(r,n)=>{let a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),a.push(this._loadTranslucentPropertiesAsync(r,t,i,n)),await Promise.all(a).then(()=>{})})}_loadTranslucentPropertiesAsync(e,t,i,r){if(!(i instanceof J))throw new Error(`${e}: Material type not supported`);let n=i;if(n.subSurface.isTranslucencyEnabled=!0,n.subSurface.volumeIndexOfRefraction=1,n.subSurface.minimumThickness=0,n.subSurface.maximumThickness=0,n.subSurface.useAlbedoToTintTranslucency=!1,r.diffuseTransmissionFactor!==void 0)n.subSurface.translucencyIntensity=r.diffuseTransmissionFactor;else return n.subSurface.translucencyIntensity=0,n.subSurface.isTranslucencyEnabled=!1,Promise.resolve();let a=new Array;return n.subSurface.useGltfStyleTextures=!0,r.diffuseTransmissionTexture&&(r.diffuseTransmissionTexture.nonColorData=!0,a.push(this._loader.loadTextureInfoAsync(`${e}/diffuseTransmissionTexture`,r.diffuseTransmissionTexture).then(o=>{o.name=`${i.name} (Diffuse Transmission)`,n.subSurface.translucencyIntensityTexture=o}))),r.diffuseTransmissionColorFactor!==void 0?n.subSurface.translucencyColor=j.FromArray(r.diffuseTransmissionColorFactor):n.subSurface.translucencyColor=j.White(),r.diffuseTransmissionColorTexture&&a.push(this._loader.loadTextureInfoAsync(`${e}/diffuseTransmissionColorTexture`,r.diffuseTransmissionColorTexture).then(o=>{o.name=`${i.name} (Diffuse Transmission Color)`,n.subSurface.translucencyColorTexture=o})),Promise.all(a).then(()=>{})}};Ce(LE);te(LE,!0,s=>new wE(s))});var TH={};V(TH,{KHR_materials_dispersion:()=>NE});var FE,NE,xH=S(()=>{Li();Nt();mt();FE="KHR_materials_dispersion",NE=class{constructor(e){this.name=FE,this.order=174,this._loader=e,this.enabled=this._loader.isExtensionUsed(FE)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Pe.LoadExtensionAsync(e,t,this.name,async(r,n)=>{let a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),a.push(this._loadDispersionPropertiesAsync(r,t,i,n)),await Promise.all(a).then(()=>{})})}_loadDispersionPropertiesAsync(e,t,i,r){if(!(i instanceof J))throw new Error(`${e}: Material type not supported`);return!i.subSurface.isRefractionEnabled||!r.dispersion||(i.subSurface.isDispersionEnabled=!0,i.subSurface.dispersion=r.dispersion),Promise.resolve()}};Ce(FE);te(FE,!0,s=>new NE(s))});var AH={};V(AH,{KHR_materials_emissive_strength:()=>UE});var BE,UE,RH=S(()=>{Li();Nt();mt();BE="KHR_materials_emissive_strength",UE=class{constructor(e){this.name=BE,this.order=170,this._loader=e,this.enabled=this._loader.isExtensionUsed(BE)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Pe.LoadExtensionAsync(e,t,this.name,async(r,n)=>await this._loader.loadMaterialPropertiesAsync(e,t,i).then(()=>{this._loadEmissiveProperties(r,n,i)}))}_loadEmissiveProperties(e,t,i){if(!(i instanceof J))throw new Error(`${e}: Material type not supported`);t.emissiveStrength!==void 0&&(i.emissiveIntensity=t.emissiveStrength)}};Ce(BE);te(BE,!0,s=>new UE(s))});var bH={};V(bH,{KHR_materials_ior:()=>cd});var GE,cd,CH=S(()=>{Li();Nt();mt();GE="KHR_materials_ior",cd=class s{constructor(e){this.name=GE,this.order=180,this._loader=e,this.enabled=this._loader.isExtensionUsed(GE)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Pe.LoadExtensionAsync(e,t,this.name,async(r,n)=>{let a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),a.push(this._loadIorPropertiesAsync(r,n,i)),await Promise.all(a).then(()=>{})})}_loadIorPropertiesAsync(e,t,i){if(!(i instanceof J))throw new Error(`${e}: Material type not supported`);return t.ior!==void 0?i.indexOfRefraction=t.ior:i.indexOfRefraction=s._DEFAULT_IOR,Promise.resolve()}};cd._DEFAULT_IOR=1.5;Ce(GE);te(GE,!0,s=>new cd(s))});var IH={};V(IH,{KHR_materials_iridescence:()=>kE});var VE,kE,yH=S(()=>{Li();Nt();mt();VE="KHR_materials_iridescence",kE=class{constructor(e){this.name=VE,this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed(VE)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Pe.LoadExtensionAsync(e,t,this.name,async(r,n)=>{let a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),a.push(this._loadIridescencePropertiesAsync(r,n,i)),await Promise.all(a).then(()=>{})})}_loadIridescencePropertiesAsync(e,t,i){if(!(i instanceof J))throw new Error(`${e}: Material type not supported`);let r=new Array;return i.iridescence.isEnabled=!0,i.iridescence.intensity=t.iridescenceFactor??0,i.iridescence.indexOfRefraction=t.iridescenceIor??t.iridescenceIOR??1.3,i.iridescence.minimumThickness=t.iridescenceThicknessMinimum??100,i.iridescence.maximumThickness=t.iridescenceThicknessMaximum??400,t.iridescenceTexture&&r.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceTexture`,t.iridescenceTexture,n=>{n.name=`${i.name} (Iridescence)`,i.iridescence.texture=n})),t.iridescenceThicknessTexture&&r.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceThicknessTexture`,t.iridescenceThicknessTexture,n=>{n.name=`${i.name} (Iridescence Thickness)`,i.iridescence.thicknessTexture=n})),Promise.all(r).then(()=>{})}};Ce(VE);te(VE,!0,s=>new kE(s))});var MH={};V(MH,{KHR_materials_pbrSpecularGlossiness:()=>HE});var WE,HE,PH=S(()=>{it();Li();Nt();mt();WE="KHR_materials_pbrSpecularGlossiness",HE=class{constructor(e){this.name=WE,this.order=200,this._loader=e,this.enabled=this._loader.isExtensionUsed(WE)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Pe.LoadExtensionAsync(e,t,this.name,async(r,n)=>{let a=new Array;return a.push(this._loader.loadMaterialBasePropertiesAsync(e,t,i)),a.push(this._loadSpecularGlossinessPropertiesAsync(r,n,i)),this._loader.loadMaterialAlphaProperties(e,t,i),await Promise.all(a).then(()=>{})})}_loadSpecularGlossinessPropertiesAsync(e,t,i){if(!(i instanceof J))throw new Error(`${e}: Material type not supported`);let r=new Array;return i.metallic=null,i.roughness=null,t.diffuseFactor?(i.albedoColor=j.FromArray(t.diffuseFactor),i.alpha=t.diffuseFactor[3]):i.albedoColor=j.White(),i.reflectivityColor=t.specularFactor?j.FromArray(t.specularFactor):j.White(),i.microSurface=t.glossinessFactor==null?1:t.glossinessFactor,t.diffuseTexture&&r.push(this._loader.loadTextureInfoAsync(`${e}/diffuseTexture`,t.diffuseTexture,n=>{n.name=`${i.name} (Diffuse)`,i.albedoTexture=n})),t.specularGlossinessTexture&&(r.push(this._loader.loadTextureInfoAsync(`${e}/specularGlossinessTexture`,t.specularGlossinessTexture,n=>{n.name=`${i.name} (Specular Glossiness)`,i.reflectivityTexture=n,i.reflectivityTexture.hasAlpha=!0})),i.useMicroSurfaceFromReflectivityMapAlpha=!0),Promise.all(r).then(()=>{})}};Ce(WE);te(WE,!0,s=>new HE(s))});var DH={};V(DH,{KHR_materials_sheen:()=>XE});var zE,XE,OH=S(()=>{Li();Nt();it();mt();zE="KHR_materials_sheen",XE=class{constructor(e){this.name=zE,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(zE)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Pe.LoadExtensionAsync(e,t,this.name,async(r,n)=>{let a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),a.push(this._loadSheenPropertiesAsync(r,n,i)),await Promise.all(a).then(()=>{})})}_loadSheenPropertiesAsync(e,t,i){if(!(i instanceof J))throw new Error(`${e}: Material type not supported`);let r=new Array;return i.sheen.isEnabled=!0,i.sheen.intensity=1,t.sheenColorFactor!=null?i.sheen.color=j.FromArray(t.sheenColorFactor):i.sheen.color=j.Black(),t.sheenColorTexture&&r.push(this._loader.loadTextureInfoAsync(`${e}/sheenColorTexture`,t.sheenColorTexture,n=>{n.name=`${i.name} (Sheen Color)`,i.sheen.texture=n})),t.sheenRoughnessFactor!==void 0?i.sheen.roughness=t.sheenRoughnessFactor:i.sheen.roughness=0,t.sheenRoughnessTexture&&(t.sheenRoughnessTexture.nonColorData=!0,r.push(this._loader.loadTextureInfoAsync(`${e}/sheenRoughnessTexture`,t.sheenRoughnessTexture,n=>{n.name=`${i.name} (Sheen Roughness)`,i.sheen.textureRoughness=n}))),i.sheen.albedoScaling=!0,i.sheen.useRoughnessFromMainTexture=!1,Promise.all(r).then(()=>{})}};Ce(zE);te(zE,!0,s=>new XE(s))});var LH={};V(LH,{KHR_materials_specular:()=>KE});var YE,KE,wH=S(()=>{Li();Nt();it();If();mt();YE="KHR_materials_specular",KE=class{constructor(e){this.name=YE,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(YE)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Pe.LoadExtensionAsync(e,t,this.name,async(r,n)=>{let a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),a.push(this._loadSpecularPropertiesAsync(r,n,i)),n.extensions&&n.extensions.EXT_materials_specular_edge_color&&i instanceof J&&n.extensions.EXT_materials_specular_edge_color.specularEdgeColorEnabled&&(i.brdf.dielectricSpecularModel=L.MATERIAL_DIELECTRIC_SPECULAR_MODEL_OPENPBR,i.brdf.conductorSpecularModel=L.MATERIAL_CONDUCTOR_SPECULAR_MODEL_OPENPBR),await Promise.all(a).then(()=>{})})}_loadSpecularPropertiesAsync(e,t,i){if(!(i instanceof J))throw new Error(`${e}: Material type not supported`);let r=new Array;return t.specularFactor!==void 0&&(i.metallicF0Factor=t.specularFactor),t.specularColorFactor!==void 0&&(i.metallicReflectanceColor=j.FromArray(t.specularColorFactor)),t.specularTexture&&(t.specularTexture.nonColorData=!0,r.push(this._loader.loadTextureInfoAsync(`${e}/specularTexture`,t.specularTexture,n=>{n.name=`${i.name} (Specular)`,i.metallicReflectanceTexture=n,i.useOnlyMetallicFromMetallicReflectanceTexture=!0}))),t.specularColorTexture&&r.push(this._loader.loadTextureInfoAsync(`${e}/specularColorTexture`,t.specularColorTexture,n=>{n.name=`${i.name} (Specular Color)`,i.reflectanceTexture=n})),Promise.all(r).then(()=>{})}};Ce(YE);te(YE,!0,s=>new KE(s))});var FH={};V(FH,{KHR_materials_transmission:()=>QE});var jy,qE,QE,NH=S(()=>{Li();Nt();Mn();we();If();$e();mt();jy=class s{static _GetDefaultOptions(){return{renderSize:1024,samples:4,lodGenerationScale:1,lodGenerationOffset:-4,renderTargetTextureType:L.TEXTURETYPE_HALF_FLOAT,generateMipmaps:!0}}constructor(e,t){this._opaqueRenderTarget=null,this._opaqueMeshesCache=[],this._transparentMeshesCache=[],this._materialObservers={},this._options={...s._GetDefaultOptions(),...e},this._scene=t,this._scene._transmissionHelper=this,this.onErrorObservable=new N,this._scene.onDisposeObservable.addOnce(()=>{this.dispose()}),this._parseScene(),this._setupRenderTargets()}updateOptions(e){if(!Object.keys(e).filter(n=>this._options[n]!==e[n]).length)return;let i={...this._options,...e},r=this._options;this._options=i,i.renderSize!==r.renderSize||i.renderTargetTextureType!==r.renderTargetTextureType||i.generateMipmaps!==r.generateMipmaps||!this._opaqueRenderTarget?this._setupRenderTargets():(this._opaqueRenderTarget.samples=i.samples,this._opaqueRenderTarget.lodGenerationScale=i.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=i.lodGenerationOffset)}getOpaqueTarget(){return this._opaqueRenderTarget}_shouldRenderAsTransmission(e){return e?!!(e instanceof J&&e.subSurface.isRefractionEnabled):!1}_addMesh(e){this._materialObservers[e.uniqueId]=e.onMaterialChangedObservable.add(this._onMeshMaterialChanged.bind(this)),W.SetImmediate(()=>{this._shouldRenderAsTransmission(e.material)?(e.material.refractionTexture=this._opaqueRenderTarget,this._transparentMeshesCache.indexOf(e)===-1&&this._transparentMeshesCache.push(e)):this._opaqueMeshesCache.indexOf(e)===-1&&this._opaqueMeshesCache.push(e)})}_removeMesh(e){e.onMaterialChangedObservable.remove(this._materialObservers[e.uniqueId]),delete this._materialObservers[e.uniqueId];let t=this._transparentMeshesCache.indexOf(e);t!==-1&&this._transparentMeshesCache.splice(t,1),t=this._opaqueMeshesCache.indexOf(e),t!==-1&&this._opaqueMeshesCache.splice(t,1)}_parseScene(){this._scene.meshes.forEach(this._addMesh.bind(this)),this._scene.onNewMeshAddedObservable.add(this._addMesh.bind(this)),this._scene.onMeshRemovedObservable.add(this._removeMesh.bind(this))}_onMeshMaterialChanged(e){let t=this._transparentMeshesCache.indexOf(e),i=this._opaqueMeshesCache.indexOf(e);this._shouldRenderAsTransmission(e.material)?(e.material instanceof J&&(e.material.subSurface.refractionTexture=this._opaqueRenderTarget),i!==-1?(this._opaqueMeshesCache.splice(i,1),this._transparentMeshesCache.push(e)):t===-1&&this._transparentMeshesCache.push(e)):t!==-1?(this._transparentMeshesCache.splice(t,1),this._opaqueMeshesCache.push(e)):i===-1&&this._opaqueMeshesCache.push(e)}_isRenderTargetValid(){return this._opaqueRenderTarget?.getInternalTexture()!==null}_setupRenderTargets(){this._opaqueRenderTarget&&this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=new Gt("opaqueSceneTexture",this._options.renderSize,this._scene,this._options.generateMipmaps,void 0,this._options.renderTargetTextureType),this._opaqueRenderTarget.ignoreCameraViewport=!0,this._opaqueRenderTarget.renderList=this._opaqueMeshesCache,this._opaqueRenderTarget.clearColor=this._options.clearColor?.clone()??this._scene.clearColor.clone(),this._opaqueRenderTarget.gammaSpace=!1,this._opaqueRenderTarget.lodGenerationScale=this._options.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=this._options.lodGenerationOffset,this._opaqueRenderTarget.samples=this._options.samples,this._opaqueRenderTarget.renderSprites=!0,this._opaqueRenderTarget.renderParticles=!0,this._opaqueRenderTarget.disableImageProcessing=!0;let e;this._opaqueRenderTarget.onBeforeBindObservable.add(t=>{e=this._scene.environmentIntensity,this._scene.environmentIntensity=1,this._options.clearColor?t.clearColor.copyFrom(this._options.clearColor):this._scene.clearColor.toLinearSpaceToRef(t.clearColor,this._scene.getEngine().useExactSrgbConversions)}),this._opaqueRenderTarget.onAfterUnbindObservable.add(()=>{this._scene.environmentIntensity=e});for(let t of this._transparentMeshesCache)this._shouldRenderAsTransmission(t.material)&&(t.material.refractionTexture=this._opaqueRenderTarget)}dispose(){this._scene._transmissionHelper=void 0,this._opaqueRenderTarget&&(this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=null),this._transparentMeshesCache=[],this._opaqueMeshesCache=[]}},qE="KHR_materials_transmission",QE=class{constructor(e){this.name=qE,this.order=175,this._loader=e,this.enabled=this._loader.isExtensionUsed(qE),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Pe.LoadExtensionAsync(e,t,this.name,async(r,n)=>{let a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),a.push(this._loadTransparentPropertiesAsync(r,t,i,n)),await Promise.all(a).then(()=>{})})}_loadTransparentPropertiesAsync(e,t,i,r){if(!(i instanceof J))throw new Error(`${e}: Material type not supported`);let n=i;if(n.subSurface.isRefractionEnabled=!0,n.subSurface.volumeIndexOfRefraction=1,n.subSurface.useAlbedoToTintRefraction=!0,r.transmissionFactor!==void 0){n.subSurface.refractionIntensity=r.transmissionFactor;let a=n.getScene();n.subSurface.refractionIntensity&&!a._transmissionHelper?new jy({},n.getScene()):n.subSurface.refractionIntensity&&!a._transmissionHelper?._isRenderTargetValid()&&a._transmissionHelper?._setupRenderTargets()}else return n.subSurface.refractionIntensity=0,n.subSurface.isRefractionEnabled=!1,Promise.resolve();return n.subSurface.minimumThickness=0,n.subSurface.maximumThickness=0,r.transmissionTexture?(r.transmissionTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/transmissionTexture`,r.transmissionTexture,void 0).then(a=>{a.name=`${i.name} (Transmission)`,n.subSurface.refractionIntensityTexture=a,n.subSurface.useGltfStyleTextures=!0})):Promise.resolve()}};Ce(qE);te(qE,!0,s=>new QE(s))});var BH={};V(BH,{KHR_materials_unlit:()=>ZE});var jE,ZE,UH=S(()=>{it();Li();Nt();mt();jE="KHR_materials_unlit",ZE=class{constructor(e){this.name=jE,this.order=210,this._loader=e,this.enabled=this._loader.isExtensionUsed(jE)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Pe.LoadExtensionAsync(e,t,this.name,async()=>await this._loadUnlitPropertiesAsync(e,t,i))}_loadUnlitPropertiesAsync(e,t,i){if(!(i instanceof J))throw new Error(`${e}: Material type not supported`);let r=new Array;i.unlit=!0;let n=t.pbrMetallicRoughness;return n&&(n.baseColorFactor?(i.albedoColor=j.FromArray(n.baseColorFactor),i.alpha=n.baseColorFactor[3]):i.albedoColor=j.White(),n.baseColorTexture&&r.push(this._loader.loadTextureInfoAsync(`${e}/baseColorTexture`,n.baseColorTexture,a=>{a.name=`${i.name} (Base Color)`,i.albedoTexture=a}))),t.doubleSided&&(i.backFaceCulling=!1,i.twoSidedLighting=!0),this._loader.loadMaterialAlphaProperties(e,t,i),Promise.all(r).then(()=>{})}};Ce(jE);te(jE,!0,s=>new ZE(s))});var GH={};V(GH,{KHR_materials_variants:()=>JE});var tr,JE,VH=S(()=>{Nt();Ki();mt();tr="KHR_materials_variants",JE=class s{constructor(e){this.name=tr,this._loader=e,this.enabled=this._loader.isExtensionUsed(tr)&&!this._loader.parent.skipMaterials}dispose(){this._loader=null}static GetAvailableVariants(e){let t=this._GetExtensionMetadata(e);return t?Object.keys(t.variants):[]}getAvailableVariants(e){return s.GetAvailableVariants(e)}static SelectVariant(e,t){let i=this._GetExtensionMetadata(e);if(!i)throw new Error(`Cannot select variant on a glTF mesh that does not have the ${tr} extension`);let r=n=>{let a=i.variants[n];if(a)for(let o of a)o.mesh.material=o.material};if(t instanceof Array)for(let n of t)r(n);else r(t);i.lastSelected=t}selectVariant(e,t){s.SelectVariant(e,t)}static Reset(e){let t=this._GetExtensionMetadata(e);if(!t)throw new Error(`Cannot reset on a glTF mesh that does not have the ${tr} extension`);for(let i of t.original)i.mesh.material=i.material;t.lastSelected=null}reset(e){s.Reset(e)}static GetLastSelectedVariant(e){let t=this._GetExtensionMetadata(e);if(!t)throw new Error(`Cannot get the last selected variant on a glTF mesh that does not have the ${tr} extension`);return t.lastSelected}getLastSelectedVariant(e){return s.GetLastSelectedVariant(e)}static _GetExtensionMetadata(e){return e?._internalMetadata?.gltf?.[tr]||null}onLoading(){let e=this._loader.gltf.extensions;if(e&&e[this.name]){let t=e[this.name];this._variants=t.variants}}onReady(){let e=this._loader.rootBabylonMesh;if(e){let t=this._loader.parent.extensionOptions[tr];t?.defaultVariant&&s.SelectVariant(e,t.defaultVariant),t?.onLoaded?.({get variants(){return s.GetAvailableVariants(e)},get selectedVariant(){let i=s.GetLastSelectedVariant(e);return i?Array.isArray(i)?i[0]:i:s.GetAvailableVariants(e)[0]},set selectedVariant(i){s.SelectVariant(e,i)}})}}_loadMeshPrimitiveAsync(e,t,i,r,n,a){return Pe.LoadExtensionAsync(e,n,this.name,async(o,l)=>{let c=new Array;return c.push(this._loader._loadMeshPrimitiveAsync(e,t,i,r,n,f=>{if(a(f),f instanceof fe){let h=Pe._GetDrawMode(e,n.mode),u=this._loader.rootBabylonMesh,d=u?u._internalMetadata=u._internalMetadata||{}:{},p=d.gltf=d.gltf||{},m=p[tr]=p[tr]||{lastSelected:null,original:[],variants:{}};m.original.push({mesh:f,material:f.material});for(let _=0;_<l.mappings.length;++_){let v=l.mappings[_],T=ve.Get(`${o}/mappings/${_}/material`,this._loader.gltf.materials,v.material);c.push(this._loader._loadMaterialAsync(`#/materials/${v.material}`,T,f,h,C=>{for(let I=0;I<v.variants.length;++I){let R=v.variants[I],b=ve.Get(`/extensions/${tr}/variants/${R}`,this._variants,R);m.variants[b.name]=m.variants[b.name]||[],m.variants[b.name].push({mesh:f,material:C}),f.onClonedObservable.add(M=>{let F=M,U=null,D=F;do{if(D=D.parent,!D)return;U=s._GetExtensionMetadata(D)}while(U===null);if(u&&U===s._GetExtensionMetadata(u)){D._internalMetadata={};for(let $ in u._internalMetadata)D._internalMetadata[$]=u._internalMetadata[$];D._internalMetadata.gltf=[];for(let $ in u._internalMetadata.gltf)D._internalMetadata.gltf[$]=u._internalMetadata.gltf[$];D._internalMetadata.gltf[tr]={lastSelected:null,original:[],variants:{}};for(let $ of U.original)D._internalMetadata.gltf[tr].original.push({mesh:$.mesh,material:$.material});for(let $ in U.variants)if(Object.prototype.hasOwnProperty.call(U.variants,$)){D._internalMetadata.gltf[tr].variants[$]=[];for(let oe of U.variants[$])D._internalMetadata.gltf[tr].variants[$].push({mesh:oe.mesh,material:oe.material})}U=D._internalMetadata.gltf[tr]}for(let $ of U.original)$.mesh===f&&($.mesh=F);for(let $ of U.variants[b.name])$.mesh===f&&($.mesh=F)})}}))}}})),await Promise.all(c).then(([f])=>f)})}};Ce(tr);te(tr,!0,s=>new JE(s))});var kH={};V(kH,{KHR_materials_volume:()=>eT});var $E,eT,WH=S(()=>{Li();Nt();mt();$E="KHR_materials_volume",eT=class{constructor(e){this.name=$E,this.order=173,this._loader=e,this.enabled=this._loader.isExtensionUsed($E),this.enabled&&this._loader._disableInstancedMesh++}dispose(){this.enabled&&this._loader._disableInstancedMesh--,this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Pe.LoadExtensionAsync(e,t,this.name,async(r,n)=>{let a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),a.push(this._loadVolumePropertiesAsync(r,t,i,n)),await Promise.all(a).then(()=>{})})}_loadVolumePropertiesAsync(e,t,i,r){if(!(i instanceof J))throw new Error(`${e}: Material type not supported`);if(!i.subSurface.isRefractionEnabled&&!i.subSurface.isTranslucencyEnabled||!r.thicknessFactor)return Promise.resolve();i.subSurface.volumeIndexOfRefraction=i.indexOfRefraction;let n=r.attenuationDistance!==void 0?r.attenuationDistance:Number.MAX_VALUE;return i.subSurface.tintColorAtDistance=n,r.attenuationColor!==void 0&&r.attenuationColor.length==3&&i.subSurface.tintColor.copyFromFloats(r.attenuationColor[0],r.attenuationColor[1],r.attenuationColor[2]),i.subSurface.minimumThickness=0,i.subSurface.maximumThickness=r.thicknessFactor,i.subSurface.useThicknessAsDepth=!0,r.thicknessTexture?(r.thicknessTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/thicknessTexture`,r.thicknessTexture).then(a=>{a.name=`${i.name} (Thickness)`,i.subSurface.thicknessTexture=a,i.subSurface.useGltfStyleTextures=!0})):Promise.resolve()}};Ce($E);te($E,!0,s=>new eT(s))});var HH={};V(HH,{KHR_mesh_quantization:()=>iT});var tT,iT,zH=S(()=>{mt();tT="KHR_mesh_quantization",iT=class{constructor(e){this.name=tT,this.enabled=e.isExtensionUsed(tT)}dispose(){}};Ce(tT);te(tT,!0,s=>new iT(s))});var XH={};V(XH,{KHR_texture_basisu:()=>sT});var rT,sT,YH=S(()=>{Nt();mt();rT="KHR_texture_basisu",sT=class{constructor(e){this.name=rT,this._loader=e,this.enabled=e.isExtensionUsed(rT)}dispose(){this._loader=null}_loadTextureAsync(e,t,i){return Pe.LoadExtensionAsync(e,t,this.name,async(r,n)=>{let a=t.sampler==null?Pe.DefaultSampler:ve.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),o=ve.Get(`${r}/source`,this._loader.gltf.images,n.source);return await this._loader._createTextureAsync(e,a,o,l=>{i(l)},t._textureInfo.nonColorData?{useRGBAIfASTCBC7NotAvailableWhenUASTC:!0}:void 0,!t._textureInfo.nonColorData)})}};Ce(rT);te(rT,!0,s=>new sT(s))});var KH={};V(KH,{KHR_texture_transform:()=>aT});var nT,aT,qH=S(()=>{Ut();Nt();mt();nT="KHR_texture_transform",aT=class{constructor(e){this.name=nT,this._loader=e,this.enabled=this._loader.isExtensionUsed(nT)}dispose(){this._loader=null}loadTextureInfoAsync(e,t,i){return Pe.LoadExtensionAsync(e,t,this.name,async(r,n)=>await this._loader.loadTextureInfoAsync(e,t,a=>{if(!(a instanceof H))throw new Error(`${r}: Texture type not supported`);n.offset&&(a.uOffset=n.offset[0],a.vOffset=n.offset[1]),a.uRotationCenter=0,a.vRotationCenter=0,n.rotation&&(a.wAng=-n.rotation),n.scale&&(a.uScale=n.scale[0],a.vScale=n.scale[1]),n.texCoord!=null&&(a.coordinatesIndex=n.texCoord),i(a)}))}};Ce(nT);te(nT,!0,s=>new aT(s))});var QH={};V(QH,{KHR_xmp_json_ld:()=>lT});var oT,lT,jH=S(()=>{mt();oT="KHR_xmp_json_ld",lT=class{constructor(e){this.name=oT,this.order=100,this._loader=e,this.enabled=this._loader.isExtensionUsed(oT)}dispose(){this._loader=null}onLoading(){if(this._loader.rootBabylonMesh===null)return;let e=this._loader.gltf.extensions?.KHR_xmp_json_ld,t=this._loader.gltf.asset?.extensions?.KHR_xmp_json_ld;if(e&&t){let i=+t.packet;e.packets&&i<e.packets.length&&(this._loader.rootBabylonMesh.metadata=this._loader.rootBabylonMesh.metadata||{},this._loader.rootBabylonMesh.metadata.xmp=e.packets[i])}}};Ce(oT);te(oT,!0,s=>new lT(s))});var cT,ZH=S(()=>{cT=class s{constructor(e,t,i){this.frame=e,this.action=t,this.onlyOnce=i,this.isDone=!1}_clone(){return new s(this.frame,this.action,this.onlyOnce)}}});var _n,Zy=S(()=>{$e();we();ie();Ee();Ii();gt();Te();Jt();ys();_n=class s{get loop(){return this._loop}set loop(e){e!==this._loop&&(this._loop=e,this.updateOptions({loop:e}))}get currentTime(){if(this._htmlAudioElement)return this._htmlAudioElement.currentTime;if(k.audioEngine?.audioContext&&(this.isPlaying||this.isPaused)){let e=this.isPaused?0:k.audioEngine.audioContext.currentTime-this._startTime;return this._currentTime+e}return 0}get spatialSound(){return this._spatialSound}set spatialSound(e){if(e==this._spatialSound)return;let t=this.isPlaying;this.pause(),e?(this._spatialSound=e,this._updateSpatialParameters()):this._disableSpatialSound(),t&&this.play()}constructor(e,t,i,r=null,n){if(this.autoplay=!1,this._loop=!1,this.useCustomAttenuation=!1,this.isPlaying=!1,this.isPaused=!1,this.refDistance=1,this.rolloffFactor=1,this.maxDistance=100,this.distanceModel="linear",this.metadata=null,this.onEndedObservable=new N,this._spatialSound=!1,this._panningModel="equalpower",this._playbackRate=1,this._streaming=!1,this._startTime=0,this._currentTime=0,this._position=E.Zero(),this._localDirection=new E(1,0,0),this._volume=1,this._isReadyToPlay=!1,this._isDirectional=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._coneOuterGain=0,this._isOutputConnected=!1,this._urlType="Unknown",this.name=e,i=i||Z.LastCreatedScene,!!i)if(this._scene=i,s._SceneComponentInitialization(i),this._readyToPlayCallback=r,this._customAttenuationFunction=(a,o,l,c,f)=>o<l?a*(1-o/l):0,n&&(this.autoplay=n.autoplay||!1,this._loop=n.loop||!1,n.volume!==void 0&&(this._volume=n.volume),this._spatialSound=n.spatialSound??!1,this.maxDistance=n.maxDistance??100,this.useCustomAttenuation=n.useCustomAttenuation??!1,this.rolloffFactor=n.rolloffFactor||1,this.refDistance=n.refDistance||1,this.distanceModel=n.distanceModel||"linear",this._playbackRate=n.playbackRate||1,this._streaming=n.streaming??!1,this._length=n.length,this._offset=n.offset),k.audioEngine?.canUseWebAudio&&k.audioEngine.audioContext){this._soundGain=k.audioEngine.audioContext.createGain(),this._soundGain.gain.value=this._volume,this._inputAudioNode=this._soundGain,this._outputAudioNode=this._soundGain,this._spatialSound&&this._createSpatialParameters(),this._scene.mainSoundTrack.addSound(this);let a=!0;if(t)try{typeof t=="string"?(this._urlType="String",this._url=t):t instanceof ArrayBuffer?this._urlType="ArrayBuffer":t instanceof HTMLMediaElement?this._urlType="MediaElement":t instanceof MediaStream?this._urlType="MediaStream":t instanceof AudioBuffer?this._urlType="AudioBuffer":Array.isArray(t)&&(this._urlType="Array");let o=[],l=!1;switch(this._urlType){case"MediaElement":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=k.audioEngine.audioContext.createMediaElementSource(t),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"MediaStream":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=k.audioEngine.audioContext.createMediaStreamSource(t),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"ArrayBuffer":t.byteLength>0&&(l=!0,this._soundLoaded(t));break;case"AudioBuffer":this._audioBufferLoaded(t);break;case"String":o.push(t);case"Array":o.length===0&&(o=t);for(let c=0;c<o.length;c++){let f=o[c];if(l=n&&n.skipCodecCheck||f.indexOf(".mp3",f.length-4)!==-1&&k.audioEngine.isMP3supported||f.indexOf(".ogg",f.length-4)!==-1&&k.audioEngine.isOGGsupported||f.indexOf(".wav",f.length-4)!==-1||f.indexOf(".m4a",f.length-4)!==-1||f.indexOf(".mp4",f.length-4)!==-1||f.indexOf("blob:")!==-1,l){this._streaming?(this._htmlAudioElement=new Audio(f),this._htmlAudioElement.controls=!1,this._htmlAudioElement.loop=this.loop,W.SetCorsBehavior(f,this._htmlAudioElement),this._htmlAudioElement.preload="auto",this._htmlAudioElement.addEventListener("canplaythrough",()=>{this._isReadyToPlay=!0,this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback()},{once:!0}),document.body.appendChild(this._htmlAudioElement),this._htmlAudioElement.load()):this._scene._loadFile(f,h=>{this._soundLoaded(h)},void 0,!0,!0,h=>{h&&P.Error("XHR "+h.status+" error on: "+f+"."),P.Error("Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)});break}}break;default:a=!1;break}a?l||(this._isReadyToPlay=!0,this._readyToPlayCallback&&setTimeout(()=>{this._readyToPlayCallback&&this._readyToPlayCallback()},1e3)):P.Error("Parameter must be a URL to the sound, an Array of URLs (.mp3 & .ogg) or an ArrayBuffer of the sound.")}catch{P.Error("Unexpected error. Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)}}else this._scene.mainSoundTrack.addSound(this),k.audioEngine&&!k.audioEngine.WarnedWebAudioUnsupported&&(P.Error("Web Audio is not supported by your browser."),k.audioEngine.WarnedWebAudioUnsupported=!0),this._readyToPlayCallback&&setTimeout(()=>{this._readyToPlayCallback&&this._readyToPlayCallback()},1e3)}dispose(){k.audioEngine?.canUseWebAudio&&(this.isPlaying&&this.stop(),this._isReadyToPlay=!1,this.soundTrackId===-1?this._scene.mainSoundTrack.removeSound(this):this._scene.soundTracks&&this._scene.soundTracks[this.soundTrackId].removeSound(this),this._soundGain&&(this._soundGain.disconnect(),this._soundGain=null),this._soundPanner&&(this._soundPanner.disconnect(),this._soundPanner=null),this._soundSource&&(this._soundSource.disconnect(),this._soundSource=null),this._audioBuffer=null,this._htmlAudioElement&&(this._htmlAudioElement.pause(),this._htmlAudioElement.src="",document.body.removeChild(this._htmlAudioElement),this._htmlAudioElement=null),this._streamingSource&&(this._streamingSource.disconnect(),this._streamingSource=null),this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._connectedTransformNode=null),this._clearTimeoutsAndObservers())}isReady(){return this._isReadyToPlay}getClassName(){return"Sound"}_audioBufferLoaded(e){k.audioEngine?.audioContext&&(this._audioBuffer=e,this._isReadyToPlay=!0,this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback())}_soundLoaded(e){k.audioEngine?.audioContext&&k.audioEngine.audioContext.decodeAudioData(e,t=>{this._audioBufferLoaded(t)},t=>{P.Error("Error while decoding audio data for: "+this.name+" / Error: "+t)})}setAudioBuffer(e){k.audioEngine?.canUseWebAudio&&(this._audioBuffer=e,this._isReadyToPlay=!0)}updateOptions(e){e&&(this.loop=e.loop??this.loop,this.maxDistance=e.maxDistance??this.maxDistance,this.useCustomAttenuation=e.useCustomAttenuation??this.useCustomAttenuation,this.rolloffFactor=e.rolloffFactor??this.rolloffFactor,this.refDistance=e.refDistance??this.refDistance,this.distanceModel=e.distanceModel??this.distanceModel,this._playbackRate=e.playbackRate??this._playbackRate,this._length=e.length??void 0,this.spatialSound=e.spatialSound??this._spatialSound,this._setOffset(e.offset??void 0),this.setVolume(e.volume??this._volume),this._updateSpatialParameters(),this.isPlaying&&(this._streaming&&this._htmlAudioElement?(this._htmlAudioElement.playbackRate=this._playbackRate,this._htmlAudioElement.loop!==this.loop&&(this._htmlAudioElement.loop=this.loop)):this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.loop!==this.loop&&(this._soundSource.loop=this.loop),this._offset!==void 0&&this._soundSource.loopStart!==this._offset&&(this._soundSource.loopStart=this._offset),this._length!==void 0&&this._length!==this._soundSource.loopEnd&&(this._soundSource.loopEnd=(this._offset|0)+this._length))))}_createSpatialParameters(){k.audioEngine?.canUseWebAudio&&k.audioEngine.audioContext&&(this._scene.headphone&&(this._panningModel="HRTF"),this._soundPanner=this._soundPanner??k.audioEngine.audioContext.createPanner(),this._soundPanner&&this._outputAudioNode&&(this._updateSpatialParameters(),this._soundPanner.connect(this._outputAudioNode),this._inputAudioNode=this._soundPanner))}_disableSpatialSound(){this._spatialSound&&(this._inputAudioNode=this._soundGain,this._soundPanner?.disconnect(),this._soundPanner=null,this._spatialSound=!1)}_updateSpatialParameters(){this._spatialSound&&(this._soundPanner?this.useCustomAttenuation?(this._soundPanner.distanceModel="linear",this._soundPanner.maxDistance=Number.MAX_VALUE,this._soundPanner.refDistance=1,this._soundPanner.rolloffFactor=1,this._soundPanner.panningModel=this._panningModel):(this._soundPanner.distanceModel=this.distanceModel,this._soundPanner.maxDistance=this.maxDistance,this._soundPanner.refDistance=this.refDistance,this._soundPanner.rolloffFactor=this.rolloffFactor,this._soundPanner.panningModel=this._panningModel):this._createSpatialParameters())}switchPanningModelToHRTF(){this._panningModel="HRTF",this._switchPanningModel()}switchPanningModelToEqualPower(){this._panningModel="equalpower",this._switchPanningModel()}_switchPanningModel(){k.audioEngine?.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.panningModel=this._panningModel)}connectToSoundTrackAudioNode(e){k.audioEngine?.canUseWebAudio&&this._outputAudioNode&&(this._isOutputConnected&&this._outputAudioNode.disconnect(),this._outputAudioNode.connect(e),this._isOutputConnected=!0)}setDirectionalCone(e,t,i){if(t<e){P.Error("setDirectionalCone(): outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=e,this._coneOuterAngle=t,this._coneOuterGain=i,this._isDirectional=!0,this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))}get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(e){if(e!=this._coneInnerAngle){if(this._coneOuterAngle<e){P.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=e,k.audioEngine?.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle)}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(e){if(e!=this._coneOuterAngle){if(e<this._coneInnerAngle){P.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneOuterAngle=e,k.audioEngine?.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneOuterAngle=this._coneOuterAngle)}}setPosition(e){e.equals(this._position)||(this._position.copyFrom(e),k.audioEngine?.canUseWebAudio&&this._spatialSound&&this._soundPanner&&!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z))}setLocalDirectionToMesh(e){this._localDirection=e,k.audioEngine?.canUseWebAudio&&this._connectedTransformNode&&this.isPlaying&&this._updateDirection()}_updateDirection(){if(!this._connectedTransformNode||!this._soundPanner)return;let e=this._connectedTransformNode.getWorldMatrix(),t=E.TransformNormal(this._localDirection,e);t.normalize(),this._soundPanner.orientationX.value=t.x,this._soundPanner.orientationY.value=t.y,this._soundPanner.orientationZ.value=t.z}updateDistanceFromListener(){if(k.audioEngine?.canUseWebAudio&&this._connectedTransformNode&&this.useCustomAttenuation&&this._soundGain&&this._scene.activeCamera){let e=this._scene.audioListenerPositionProvider?this._connectedTransformNode.position.subtract(this._scene.audioListenerPositionProvider()).length():this._connectedTransformNode.getDistanceToCamera(this._scene.activeCamera);this._soundGain.gain.value=this._customAttenuationFunction(this._volume,e,this.maxDistance,this.refDistance,this.rolloffFactor)}}setAttenuationFunction(e){this._customAttenuationFunction=e}play(e,t,i){if(this._isReadyToPlay&&this._scene.audioEnabled&&k.audioEngine?.audioContext)try{this._clearTimeoutsAndObservers();let r=e?k.audioEngine?.audioContext.currentTime+e:k.audioEngine?.audioContext.currentTime;if((!this._soundSource||!this._streamingSource)&&this._spatialSound&&this._soundPanner&&(!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z),this._isDirectional&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle,this._soundPanner.coneOuterAngle=this._coneOuterAngle,this._soundPanner.coneOuterGain=this._coneOuterGain,this._connectedTransformNode?this._updateDirection():this._soundPanner.setOrientation(this._localDirection.x,this._localDirection.y,this._localDirection.z))),this._streaming){if(!this._streamingSource&&this._htmlAudioElement&&(this._streamingSource=k.audioEngine.audioContext.createMediaElementSource(this._htmlAudioElement),this._htmlAudioElement.onended=()=>{this._onended()},this._htmlAudioElement.playbackRate=this._playbackRate),this._streamingSource&&(this._streamingSource.disconnect(),this._inputAudioNode&&this._streamingSource.connect(this._inputAudioNode)),this._htmlAudioElement){let n=()=>{if(k.audioEngine?.unlocked){if(!this._htmlAudioElement)return;this._htmlAudioElement.currentTime=t??0;let a=this._htmlAudioElement.play();a!==void 0&&a.catch(()=>{k.audioEngine?.lock(),(this.loop||this.autoplay)&&(this._audioUnlockedObserver=k.audioEngine?.onAudioUnlockedObservable.addOnce(()=>{n()}))})}else(this.loop||this.autoplay)&&(this._audioUnlockedObserver=k.audioEngine?.onAudioUnlockedObservable.addOnce(()=>{n()}))};n()}}else{let n=()=>{if(k.audioEngine?.audioContext){if(i=i||this._length,t!==void 0&&this._setOffset(t),this._soundSource){let a=this._soundSource;a.onended=()=>{a.disconnect()}}if(this._soundSource=k.audioEngine?.audioContext.createBufferSource(),this._soundSource&&this._inputAudioNode){this._soundSource.buffer=this._audioBuffer,this._soundSource.connect(this._inputAudioNode),this._soundSource.loop=this.loop,t!==void 0&&(this._soundSource.loopStart=t),i!==void 0&&(this._soundSource.loopEnd=(t|0)+i),this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.onended=()=>{this._onended()},r=e?k.audioEngine?.audioContext.currentTime+e:k.audioEngine.audioContext.currentTime;let a=((this.isPaused?this.currentTime:0)+(this._offset??0))%this._soundSource.buffer.duration;this._soundSource.start(r,a,this.loop?void 0:i)}}};k.audioEngine?.audioContext.state==="suspended"?this._tryToPlayTimeout=setTimeout(()=>{k.audioEngine?.audioContext.state==="suspended"?(k.audioEngine.lock(),(this.loop||this.autoplay)&&(this._audioUnlockedObserver=k.audioEngine.onAudioUnlockedObservable.addOnce(()=>{n()}))):n()},500):n()}this._startTime=r,this.isPlaying=!0,this.isPaused=!1}catch(r){P.Error("Error while trying to play audio: "+this.name+", "+r.message)}}_onended(){this.isPlaying=!1,this._startTime=0,this._currentTime=0,this.onended&&this.onended(),this.onEndedObservable.notifyObservers(this)}stop(e){if(this.isPlaying)if(this._clearTimeoutsAndObservers(),this._streaming)this._htmlAudioElement?(this._htmlAudioElement.pause(),this._htmlAudioElement.currentTime>0&&(this._htmlAudioElement.currentTime=0)):this._streamingSource?.disconnect(),this.isPlaying=!1;else if(k.audioEngine?.audioContext&&this._soundSource){let t=e?k.audioEngine.audioContext.currentTime+e:void 0;this._soundSource.onended=()=>{this.isPlaying=!1,this.isPaused=!1,this._startTime=0,this._currentTime=0,this._soundSource&&(this._soundSource.onended=()=>{}),this._onended()},this._soundSource.stop(t)}else this.isPlaying=!1;else this.isPaused&&(this.isPaused=!1,this._startTime=0,this._currentTime=0)}pause(){this.isPlaying&&(this._clearTimeoutsAndObservers(),this._streaming?(this._htmlAudioElement?this._htmlAudioElement.pause():this._streamingSource?.disconnect(),this.isPlaying=!1,this.isPaused=!0):k.audioEngine?.audioContext&&this._soundSource&&(this._soundSource.onended=()=>{},this._soundSource.stop(),this.isPlaying=!1,this.isPaused=!0,this._currentTime+=k.audioEngine.audioContext.currentTime-this._startTime))}setVolume(e,t){k.audioEngine?.canUseWebAudio&&this._soundGain&&(t&&k.audioEngine.audioContext?(this._soundGain.gain.cancelScheduledValues(k.audioEngine.audioContext.currentTime),this._soundGain.gain.setValueAtTime(this._soundGain.gain.value,k.audioEngine.audioContext.currentTime),this._soundGain.gain.linearRampToValueAtTime(e,k.audioEngine.audioContext.currentTime+t)):this._soundGain.gain.value=e),this._volume=e}setPlaybackRate(e){this._playbackRate=e,this.isPlaying&&(this._streaming&&this._htmlAudioElement?this._htmlAudioElement.playbackRate=this._playbackRate:this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate))}getPlaybackRate(){return this._playbackRate}getVolume(){return this._volume}attachToMesh(e){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null),this._connectedTransformNode=e,this._spatialSound||(this._spatialSound=!0,this._createSpatialParameters(),this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))),this._onRegisterAfterWorldMatrixUpdate(this._connectedTransformNode),this._registerFunc=t=>this._onRegisterAfterWorldMatrixUpdate(t),this._connectedTransformNode.registerAfterWorldMatrixUpdate(this._registerFunc)}detachFromMesh(){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null,this._connectedTransformNode=null)}_onRegisterAfterWorldMatrixUpdate(e){if(!e.getBoundingInfo)this.setPosition(e.absolutePosition);else{let i=e.getBoundingInfo();this.setPosition(i.boundingSphere.centerWorld)}k.audioEngine?.canUseWebAudio&&this._isDirectional&&this.isPlaying&&this._updateDirection()}clone(){if(this._streaming)return null;{let e=()=>{br(()=>this._isReadyToPlay,()=>{i._audioBuffer=this.getAudioBuffer(),i._isReadyToPlay=!0,i.autoplay&&i.play(0,this._offset,this._length)},void 0,300)},t={autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,useCustomAttenuation:this.useCustomAttenuation,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel},i=new s(this.name+"_cloned",new ArrayBuffer(0),this._scene,null,t);return this.useCustomAttenuation&&i.setAttenuationFunction(this._customAttenuationFunction),i.setPosition(this._position),i.setPlaybackRate(this._playbackRate),e(),i}}getAudioBuffer(){return this._audioBuffer}getSoundSource(){return this._soundSource}getSoundGain(){return this._soundGain}serialize(){let e={name:this.name,url:this._url,autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel,playbackRate:this._playbackRate,panningModel:this._panningModel,soundTrackId:this.soundTrackId,metadata:this.metadata};return this._spatialSound&&(this._connectedTransformNode&&(e.connectedMeshId=this._connectedTransformNode.id),e.position=this._position.asArray(),e.refDistance=this.refDistance,e.distanceModel=this.distanceModel,e.isDirectional=this._isDirectional,e.localDirectionToMesh=this._localDirection.asArray(),e.coneInnerAngle=this._coneInnerAngle,e.coneOuterAngle=this._coneOuterAngle,e.coneOuterGain=this._coneOuterGain),e}static Parse(e,t,i,r){let n=e.name,a;e.url?a=i+e.url:a=i+n;let o={autoplay:e.autoplay,loop:e.loop,volume:e.volume,spatialSound:e.spatialSound,maxDistance:e.maxDistance,rolloffFactor:e.rolloffFactor,refDistance:e.refDistance,distanceModel:e.distanceModel,playbackRate:e.playbackRate},l;if(!r)l=new s(n,a,t,()=>{t.removePendingData(l)},o),t.addPendingData(l);else{let c=()=>{br(()=>r._isReadyToPlay,()=>{l._audioBuffer=r.getAudioBuffer(),l._isReadyToPlay=!0,l.autoplay&&l.play(0,l._offset,l._length)},void 0,300)};l=new s(n,new ArrayBuffer(0),t,null,o),c()}if(e.position){let c=E.FromArray(e.position);l.setPosition(c)}if(e.isDirectional&&(l.setDirectionalCone(e.coneInnerAngle||360,e.coneOuterAngle||360,e.coneOuterGain||0),e.localDirectionToMesh)){let c=E.FromArray(e.localDirectionToMesh);l.setLocalDirectionToMesh(c)}if(e.connectedMeshId){let c=t.getMeshById(e.connectedMeshId);c&&l.attachToMesh(c)}return e.metadata&&(l.metadata=e.metadata),l}_setOffset(e){this._offset!==e&&(this.isPaused&&(this.stop(),this.isPaused=!1),this._offset=e)}_clearTimeoutsAndObservers(){this._tryToPlayTimeout&&(clearTimeout(this._tryToPlayTimeout),this._tryToPlayTimeout=null),this._audioUnlockedObserver&&(k.audioEngine?.onAudioUnlockedObservable.remove(this._audioUnlockedObserver),this._audioUnlockedObserver=null)}};_n._SceneComponentInitialization=s=>{throw pe("AudioSceneComponent")};G("BABYLON.Sound",_n)});var fT,JH=S(()=>{Ee();fT=class{constructor(e,t,i){if(this.loop=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._volume=1,this.isPlaying=!1,this.isPaused=!1,this._sounds=[],this._weights=[],t.length!==i.length)throw new Error("Sounds length does not equal weights length");this.loop=e,this._weights=i;let r=0;for(let a of i)r+=a;let n=r>0?1/r:0;for(let a=0;a<this._weights.length;a++)this._weights[a]*=n;this._sounds=t;for(let a of this._sounds)a.onEndedObservable.add(()=>{this._onended()})}get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(e){if(e!==this._coneInnerAngle){if(this._coneOuterAngle<e){P.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=e;for(let t of this._sounds)t.directionalConeInnerAngle=e}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(e){if(e!==this._coneOuterAngle){if(e<this._coneInnerAngle){P.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneOuterAngle=e;for(let t of this._sounds)t.directionalConeOuterAngle=e}}get volume(){return this._volume}set volume(e){if(e!==this._volume)for(let t of this._sounds)t.setVolume(e)}_onended(){this._currentIndex!==void 0&&(this._sounds[this._currentIndex].autoplay=!1),this.loop&&this.isPlaying?this.play():this.isPlaying=!1}pause(){this.isPlaying&&(this.isPaused=!0,this._currentIndex!==void 0&&this._sounds[this._currentIndex].pause())}stop(){this.isPlaying=!1,this._currentIndex!==void 0&&this._sounds[this._currentIndex].stop()}play(e){if(!this.isPaused){this.stop();let i=Math.random(),r=0;for(let n=0;n<this._weights.length;n++)if(r+=this._weights[n],i<=r){this._currentIndex=n;break}}let t=this._sounds[this._currentIndex??0];t.isReady()?t.play(0,this.isPaused?void 0:e):t.autoplay=!0,this.isPlaying=!0,this.isPaused=!1}}});var hT,$H=S(()=>{gt();Jt();hT=class{constructor(e,t={}){this.id=-1,this._isInitialized=!1,e=e||Z.LastCreatedScene,e&&(this._scene=e,this.soundCollection=[],this._options=t,!this._options.mainTrack&&this._scene.soundTracks&&(this._scene.soundTracks.push(this),this.id=this._scene.soundTracks.length-1))}_initializeSoundTrackAudioGraph(){k.audioEngine?.canUseWebAudio&&k.audioEngine.audioContext&&(this._outputAudioNode=k.audioEngine.audioContext.createGain(),this._outputAudioNode.connect(k.audioEngine.masterGain),this._options&&this._options.volume&&(this._outputAudioNode.gain.value=this._options.volume),this._isInitialized=!0)}dispose(){if(k.audioEngine&&k.audioEngine.canUseWebAudio){for(this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas();this.soundCollection.length;)this.soundCollection[0].dispose();this._outputAudioNode&&this._outputAudioNode.disconnect(),this._outputAudioNode=null}}addSound(e){this._isInitialized||this._initializeSoundTrackAudioGraph(),k.audioEngine?.canUseWebAudio&&this._outputAudioNode&&e.connectToSoundTrackAudioNode(this._outputAudioNode),e.soundTrackId!==void 0&&(e.soundTrackId===-1?this._scene.mainSoundTrack.removeSound(e):this._scene.soundTracks&&this._scene.soundTracks[e.soundTrackId].removeSound(e)),this.soundCollection.push(e),e.soundTrackId=this.id}removeSound(e){let t=this.soundCollection.indexOf(e);t!==-1&&this.soundCollection.splice(t,1)}setVolume(e){k.audioEngine?.canUseWebAudio&&this._outputAudioNode&&(this._outputAudioNode.gain.value=e)}switchPanningModelToHRTF(){if(k.audioEngine?.canUseWebAudio)for(let e=0;e<this.soundCollection.length;e++)this.soundCollection[e].switchPanningModelToHRTF()}switchPanningModelToEqualPower(){if(k.audioEngine?.canUseWebAudio)for(let e=0;e<this.soundCollection.length;e++)this.soundCollection[e].switchPanningModelToEqualPower()}connectToAnalyser(e){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser=e,k.audioEngine?.canUseWebAudio&&this._outputAudioNode&&(this._outputAudioNode.disconnect(),this._connectedAnalyser.connectAudioNodes(this._outputAudioNode,k.audioEngine.masterGain))}}});var uT,dT,ez=S(()=>{uT=[],dT=class{constructor(e){this._mainBuses=new Set,this._nodes=new Set,this._defaultMainBus=null,this._parameterRampDuration=.01,uT.push(this),typeof e.parameterRampDuration=="number"&&(this.parameterRampDuration=e.parameterRampDuration)}get defaultMainBus(){return this._mainBuses.size===0?null:(this._defaultMainBus||(this._defaultMainBus=Array.from(this._mainBuses)[0]),this._defaultMainBus)}get parameterRampDuration(){return this._parameterRampDuration}set parameterRampDuration(e){this._parameterRampDuration=Math.max(0,e)}dispose(){uT.includes(this)&&uT.splice(uT.indexOf(this),1);let e=this._nodes.values();for(let t=e.next();!t.done;t=e.next())t.value.dispose();this._mainBuses.clear(),this._nodes.clear(),this._defaultMainBus=null}unlockAsync(){return this.resumeAsync()}_addMainBus(e){this._mainBuses.add(e),this._addNode(e)}_removeMainBus(e){this._mainBuses.delete(e),this._defaultMainBus=null,this._removeNode(e)}_addNode(e){this._nodes.add(e)}_removeNode(e){this._nodes.delete(e)}}});function iz(s){return s.listenerEnabled||s.listenerMinUpdateTime!==void 0||s.listenerPosition!==void 0||s.listenerRotation!==void 0||s.listenerRotationQuaternion!==void 0}var tz,pT,Jy=S(()=>{ie();tz={position:E.Zero(),rotation:E.Zero(),rotationQuaternion:new K};pT=class{}});var ic,$y=S(()=>{ie();ic=class{constructor(e){this._attachmentType=3,this._position=new E,this._rotationQuaternion=new K,this._sceneNode=null,this._useBoundingBox=!1,this.dispose=()=>{this.detach()},this._spatialAudioNode=e}get isAttached(){return this._sceneNode!==null}attach(e,t,i){this._sceneNode!==e&&(this.detach(),e&&(this._attachmentType=i,this._sceneNode=e,this._sceneNode.onDisposeObservable.add(this.dispose),this._useBoundingBox=t))}detach(){this._sceneNode?.onDisposeObservable.removeCallback(this.dispose),this._sceneNode=null}update(){this._attachmentType&1&&(this._useBoundingBox&&this._sceneNode.getBoundingInfo?this._position.copyFrom(this._sceneNode.getBoundingInfo().boundingBox.centerWorld):this._sceneNode?.getWorldMatrix().getTranslationToRef(this._position),this._spatialAudioNode.position.copyFrom(this._position),this._spatialAudioNode._updatePosition()),this._attachmentType&2&&(this._sceneNode?.getWorldMatrix().decompose(void 0,this._rotationQuaternion),this._spatialAudioNode.rotationQuaternion.copyFrom(this._rotationQuaternion),this._spatialAudioNode._updateRotation())}}});var mT,rz=S(()=>{$y();Jy();mT=class extends pT{constructor(){super(),this._attacherComponent=null,this._attacherComponent=new ic(this)}get isAttached(){return this._attacherComponent!==null&&this._attacherComponent.isAttached}attach(e,t=!1,i=3){this._attacherComponent||(this._attacherComponent=new ic(this)),this._attacherComponent.attach(e,t,i)}detach(){this._attacherComponent?.detach()}dispose(){this._attacherComponent?.dispose(),this._attacherComponent=null}setOptions(e){e.listenerMinUpdateTime!==void 0&&(this.minUpdateTime=e.listenerMinUpdateTime),e.listenerPosition&&(this.position=e.listenerPosition.clone()),e.listenerRotationQuaternion?this.rotationQuaternion=e.listenerRotationQuaternion.clone():e.listenerRotation?this.rotation=e.listenerRotation.clone():this.rotationQuaternion=tz.rotationQuaternion.clone(),this.update()}}});var jf,e0=S(()=>{zs();jf=class{constructor(e,t,i){if(this._autoUpdate=!0,this._lastUpdateTime=0,this.minUpdateTime=0,!t)return;this.minUpdateTime=i;let r=()=>{if(!this._autoUpdate)return;let n=!1;if(0<this.minUpdateTime){let a=Zt.Now;this._lastUpdateTime&&a-this._lastUpdateTime<this.minUpdateTime&&(n=!0),this._lastUpdateTime=a}n||e.update(),requestAnimationFrame(r)};requestAnimationFrame(r)}dispose(){this._autoUpdate=!1}}});function Wte(){if(!_T){_T=new Float32Array(so);let s=1/(so-1),e=s;for(let t=1;t<so;t++)_T[t]=Math.exp(-11.512925464970227*(1-e)),e+=s}return _T}function Hte(){if(!gT){gT=new Float32Array(so);let s=1/so,e=s;for(let t=0;t<so;t++)gT[t]=1+Math.log10(e)/Math.log10(so),e+=s}return gT}function nz(s,e,t){fd||(fd=new Float32Array(so));let i;if(s==="linear")return t0[0]=e,t0[1]=t,t0;if(s==="exponential")i=Wte();else if(s==="logarithmic")i=Hte();else throw new Error(`Unknown ramp shape: ${s}`);let r=Math.sign(t-e),n=Math.abs(t-e);if(r===1)for(let a=0;a<i.length;a++)fd[a]=e+n*i[a];else{let a=so-1;for(let o=0;o<i.length;o++,a--)fd[o]=e-n*(1-i[a])}return fd}function hd(s){return s.replace(/#/gm,"%23")}var sz,so,t0,fd,_T,gT,vT=S(()=>{sz=new RegExp("\\.(\\w{3,4})($|\\?)"),so=100,t0=new Float32Array([0,0]),fd=null,_T=null,gT=null});var zte,Xte,Yt,rc=S(()=>{vT();zte=.011,Xte=1e-6,Yt=class{constructor(e,t){this._deferredRampOptions={duration:0,shape:"linear"},this._deferredTargetValue=-1,this._isObservingUpdates=!1,this._rampEndTime=0,this._applyDeferredRamp=()=>{0<this._deferredRampOptions.duration&&this._rampEndTime<this._engine.currentTime&&this.setTargetValue(this._deferredTargetValue,this._deferredRampOptions)},this._engine=e,this._param=t,this._targetValue=t.value}get isRamping(){return this._engine.currentTime<this._rampEndTime}get targetValue(){return this._targetValue}set targetValue(e){this.setTargetValue(e)}get value(){return this._param.value}dispose(){this._clearDeferredRamp(),this._param=null,this._engine=null}setTargetValue(e,t=null){if(this._targetValue===e)return;let i=typeof t?.shape=="string"?t.shape:"linear",r=typeof t?.duration=="number"?Math.max(t.duration,this._engine.parameterRampDuration):this._engine.parameterRampDuration,n=this._engine.currentTime;if(n<this._rampEndTime){let a=this._rampEndTime-n;if(zte<a)throw new Error("Audio parameter not set. Wait for current ramp to finish.");this._deferRamp(e,r,i);return}if((r=Math.max(this._engine.parameterRampDuration,r))<Xte){this._param.setValueAtTime(this._targetValue=e,n);return}this._param.cancelScheduledValues(n),this._param.setValueCurveAtTime(nz(i,this._targetValue,this._targetValue=e),n,r),this._clearDeferredRamp(),this._rampEndTime=n+r}_deferRamp(e,t,i){this._deferredRampOptions.duration=t,this._deferredRampOptions.shape=i,this._deferredTargetValue=e,this._isObservingUpdates||(this._engine._addUpdateObserver(this._applyDeferredRamp),this._isObservingUpdates=!0)}_clearDeferredRamp(){this._deferredRampOptions.duration=0,this._isObservingUpdates&&(this._engine._removeUpdateObserver(this._applyDeferredRamp),this._isObservingUpdates=!1)}}});function a0(s,e,t){let i=s._audioContext.listener;return i.forwardX&&i.forwardY&&i.forwardZ&&i.positionX&&i.positionY&&i.positionZ&&i.upX&&i.upY&&i.upZ?new s0(s,e,t):new n0(s,e,t)}var i0,r0,az,oz,ST,s0,n0,lz=S(()=>{ie();rz();e0();rc();i0=B.Zero(),r0=new K,az=E.Zero(),oz=E.Zero();ST=class extends mT{constructor(e,t,i){super(),this._lastPosition=E.Zero(),this._lastRotation=E.Zero(),this._lastRotationQuaternion=new K,this.position=E.Zero(),this.rotation=E.Zero(),this.rotationQuaternion=new K,this._listener=e._audioContext.listener,this.engine=e,this._updaterComponent=new jf(this,t,i)}dispose(){super.dispose(),this._updaterComponent.dispose(),this._updaterComponent=null}get minUpdateTime(){return this._updaterComponent.minUpdateTime}set minUpdateTime(e){this._updaterComponent.minUpdateTime=e}update(){this.isAttached?this._attacherComponent?.update():(this._updatePosition(),this._updateRotation())}_updatePosition(){this._lastPosition.equalsWithEpsilon(this.position)||(this._setWebAudioPosition(this.position),this._lastPosition.copyFrom(this.position))}_updateRotation(){if(!this._lastRotationQuaternion.equalsWithEpsilon(this.rotationQuaternion))r0.copyFrom(this.rotationQuaternion),this._lastRotationQuaternion.copyFrom(this.rotationQuaternion);else if(!this._lastRotation.equalsWithEpsilon(this.rotation))K.FromEulerAnglesToRef(this.rotation.x,this.rotation.y,this.rotation.z,r0),this._lastRotation.copyFrom(this.rotation);else return;B.FromQuaternionToRef(r0,i0),E.TransformNormalToRef(E.RightHandedForwardReadOnly,i0,az),E.TransformNormalToRef(E.Up(),i0,oz),this._setWebAudioOrientation(az,oz)}},s0=class extends ST{constructor(e,t,i){super(e,t,i);let r=e._audioContext.listener;this._forwardX=new Yt(e,r.forwardX),this._forwardY=new Yt(e,r.forwardY),this._forwardZ=new Yt(e,r.forwardZ),this._positionX=new Yt(e,r.positionX),this._positionY=new Yt(e,r.positionY),this._positionZ=new Yt(e,r.positionZ),this._upX=new Yt(e,r.upX),this._upY=new Yt(e,r.upY),this._upZ=new Yt(e,r.upZ)}_setWebAudioPosition(e){this.isAttached&&(this._positionX.isRamping||this._positionY.isRamping||this._positionZ.isRamping)||(this._positionX.targetValue=e.x,this._positionY.targetValue=e.y,this._positionZ.targetValue=e.z)}_setWebAudioOrientation(e,t){this.isAttached&&(this._forwardX.isRamping||this._forwardY.isRamping||this._forwardZ.isRamping||this._upX.isRamping||this._upY.isRamping||this._upZ.isRamping)||(this._forwardX.targetValue=e.x,this._forwardY.targetValue=e.y,this._forwardZ.targetValue=e.z,this._upX.targetValue=t.x,this._upY.targetValue=t.y,this._upZ.targetValue=t.z)}},n0=class extends ST{_setWebAudioPosition(e){this._listener.setPosition(e.x,e.y,e.z)}_setWebAudioOrientation(e,t){this._listener.setOrientation(e.x,e.y,e.z,t.x,t.y,t.z)}}});var cz,sc,Zf,ud=S(()=>{we();(function(s){s[s.HAS_INPUTS=1]="HAS_INPUTS",s[s.HAS_OUTPUTS=2]="HAS_OUTPUTS",s[s.HAS_INPUTS_AND_OUTPUTS=3]="HAS_INPUTS_AND_OUTPUTS"})(cz||(cz={}));sc=class{constructor(e,t){this.onDisposeObservable=new N,this.engine=e,t&1&&(this._upstreamNodes=new Set),t&2&&(this._downstreamNodes=new Set)}dispose(){if(this._downstreamNodes){for(let e of Array.from(this._downstreamNodes))if(!this._disconnect(e))throw new Error("Disconnect failed");this._downstreamNodes.clear()}if(this._upstreamNodes){for(let e of Array.from(this._upstreamNodes))if(!e._disconnect(this))throw new Error("Disconnect failed");this._upstreamNodes.clear()}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}_connect(e){return!this._downstreamNodes||this._downstreamNodes.has(e)||!e._onConnect(this)?!1:(this._downstreamNodes.add(e),!0)}_disconnect(e){return!this._downstreamNodes||!this._downstreamNodes.delete(e)?!1:e._onDisconnect(this)}_onConnect(e){return!this._upstreamNodes||this._upstreamNodes.has(e)?!1:(this._upstreamNodes.add(e),!0)}_onDisconnect(e){return this._upstreamNodes?.delete(e)??!1}},Zf=class extends sc{constructor(e,t,i){super(t,i),this.onNameChangedObservable=new N,this._name=e}get name(){return this._name}set name(e){if(this._name===e)return;let t=this._name;this._name=e,this.onNameChangedObservable.notifyObservers({newName:e,oldName:t,node:this})}dispose(){super.dispose(),this.onNameChangedObservable.clear()}}});var ET,fz=S(()=>{ud();ET=class extends sc{constructor(e){super(e,1)}}});var TT,hz=S(()=>{fz();rc();TT=class extends ET{constructor(e){super(e),this._setGainNode(new GainNode(e._audioContext))}dispose(){super.dispose(),this._volume.dispose(),this._gainNode.disconnect(),this._destinationNode.disconnect()}get _inNode(){return this._gainNode}set _inNode(e){this._gainNode!==e&&this._setGainNode(e)}get volume(){return this._volume.targetValue}set volume(e){this._volume.targetValue=e}get _destinationNode(){return this.engine._audioDestination}getClassName(){return"_WebAudioMainOut"}setVolume(e,t=null){this._volume.setTargetValue(e,t)}_setGainNode(e){this._gainNode!==e&&(this._gainNode?.disconnect(),e.connect(this._destinationNode),this._volume=new Yt(this.engine,e.gain),this._gainNode=e)}}});var xT,uz=S(()=>{gt();xT=class{constructor(e,t){this._button=null,this._enabled=!0,this._style=null,this._onStateChanged=()=>{this._button&&(this._engine.state==="running"?this._hide():this._show())},this._engine=e;let i=t||Z.LastCreatedEngine?.getInputElement()?.parentElement||document.body,r=(i?.offsetTop||0)+20;this._style=document.createElement("style"),this._style.appendChild(document.createTextNode(`.babylonUnmute{position:absolute;top:${r}px;margin-left:20px;height:40px;width:60px;background-color:rgba(51,51,51,0.7);background-image:url("data:image/svg+xml;charset=UTF-8,%3Csvg%20version%3D%221.1%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2239%22%20height%3D%2232%22%20viewBox%3D%220%200%2039%2032%22%3E%3Cpath%20fill%3D%22white%22%20d%3D%22M9.625%2018.938l-0.031%200.016h-4.953q-0.016%200-0.031-0.016v-12.453q0-0.016%200.031-0.016h4.953q0.031%200%200.031%200.016v12.453zM12.125%207.688l8.719-8.703v27.453l-8.719-8.719-0.016-0.047v-9.938zM23.359%207.875l1.406-1.406%204.219%204.203%204.203-4.203%201.422%201.406-4.219%204.219%204.219%204.203-1.484%201.359-4.141-4.156-4.219%204.219-1.406-1.422%204.219-4.203z%22%3E%3C%2Fpath%3E%3C%2Fsvg%3E");background-size:80%;background-repeat:no-repeat;background-position:center;background-position-y:4px;border:none;outline:none;transition:transform 0.125s ease-out;cursor:pointer;z-index:9999;}.babylonUnmute:hover{transform:scale(1.05)}`)),document.head.appendChild(this._style),this._button=document.createElement("button"),this._button.className="babylonUnmute",this._button.id="babylonUnmuteButton",this._button.addEventListener("click",()=>{this._engine.unlockAsync()}),i.appendChild(this._button),this._engine.stateChangedObservable.add(this._onStateChanged)}dispose(){this._button?.remove(),this._button=null,this._style?.remove(),this._style=null,this._engine.stateChangedObservable.removeCallback(this._onStateChanged)}get enabled(){return this._enabled}set enabled(e){this._enabled=e,e?this._engine.state!=="running"&&this._show():this._hide()}_show(){this._button&&(this._button.style.display="block")}_hide(){this._button&&(this._button.style.display="none")}}});var Zn,dd=S(()=>{ud();Zn=class extends Zf{constructor(e,t){super(e,t,3)}connect(e){if(!this._connect(e))throw new Error("Connect failed")}disconnect(e){if(!this._disconnect(e))throw new Error("Disconnect failed")}disconnectAll(){if(!this._downstreamNodes)throw new Error("Disconnect failed");let e=this._downstreamNodes.values();for(let t=e.next();!t.done;t=e.next())if(!this._disconnect(t.value))throw new Error("Disconnect failed")}}});function no(s){return s.getSubNode("Volume")}function pz(s,e){return no(s)?.[e]??dz[e]}var dz,AT,pd=S(()=>{dd();dz={volume:1},AT=class extends Zn{constructor(e){super("Volume",e)}setOptions(e){this.volume=e.volume??dz.volume}}});function mz(s){return s.analyzerEnabled||s.analyzerFFTSize!==void 0||s.analyzerMinDecibels!==void 0||s.analyzerMaxDecibels!==void 0||s.analyzerSmoothing!==void 0}var Jn,RT,bT=S(()=>{Jn={fftSize:2048,minDecibels:-100,maxDecibels:-30,smoothing:.8};RT=class{get frequencyBinCount(){return this.fftSize/2}}});function ao(s){return s.getSubNode("Analyzer")}function md(s,e,t){s.callOnSubNode("Analyzer",i=>{i[e]=t})}var CT,IT=S(()=>{bT();dd();CT=class extends Zn{constructor(e){super("Analyzer",e)}setOptions(e){this.fftSize=e.analyzerFFTSize??Jn.fftSize,this.minDecibels=e.analyzerMinDecibels??Jn.minDecibels,this.maxDecibels=e.analyzerMaxDecibels??Jn.maxDecibels,this.smoothing=e.analyzerSmoothing??Jn.smoothing}}});function c0(){return o0||(o0=new Uint8Array),o0}function f0(){return l0||(l0=new Float32Array),l0}var o0,l0,yT,h0=S(()=>{Ee();bT();IT();o0=null,l0=null;yT=class extends RT{constructor(e){super(),this._fftSize=Jn.fftSize,this._maxDecibels=Jn.maxDecibels,this._minDecibels=Jn.minDecibels,this._smoothing=Jn.smoothing,this._subGraph=e}get fftSize(){return this._fftSize}set fftSize(e){this._fftSize=e,md(this._subGraph,"fftSize",e)}get isEnabled(){return ao(this._subGraph)!==null}get minDecibels(){return this._minDecibels}set minDecibels(e){this._minDecibels=e,md(this._subGraph,"minDecibels",e)}get maxDecibels(){return this._maxDecibels}set maxDecibels(e){this._maxDecibels=e,md(this._subGraph,"maxDecibels",e)}get smoothing(){return this._smoothing}set smoothing(e){this._smoothing=e,md(this._subGraph,"smoothing",e)}dispose(){let e=ao(this._subGraph);e&&(this._subGraph.removeSubNodeAsync(e),e.dispose())}async enableAsync(){ao(this._subGraph)||await this._subGraph.createAndAddSubNodeAsync("Analyzer")}getByteFrequencyData(){let e=ao(this._subGraph);return e?e.getByteFrequencyData():(P.Warn("AudioAnalyzer not enabled"),this.enableAsync(),c0())}getFloatFrequencyData(){let e=ao(this._subGraph);return e?e.getFloatFrequencyData():(P.Warn("AudioAnalyzer not enabled"),this.enableAsync(),f0())}}});var Jf,u0=S(()=>{ud();pd();h0();Jf=class extends Zf{constructor(e,t,i){super(e,t,i),this._analyzer=null}get analyzer(){return this._analyzer??(this._analyzer=new yT(this._subGraph))}get volume(){return pz(this._subGraph,"volume")}set volume(e){let t=no(this._subGraph);if(!t)throw new Error("No volume subnode");t.volume=e}dispose(){super.dispose(),this._analyzer?.dispose(),this._analyzer=null,this._subGraph.dispose()}setVolume(e,t=null){let i=no(this._subGraph);if(!i)throw new Error("No volume subnode");i.setVolume(e,t)}}});var $f,d0=S(()=>{u0();$f=class extends Jf{constructor(e,t){super(e,t,3)}}});var MT,_z=S(()=>{d0();MT=class extends $f{constructor(e,t){super(e,t),this._outBus=null,this._onOutBusDisposed=()=>{this.outBus=this.engine.defaultMainBus}}get outBus(){return this._outBus}set outBus(e){if(this._outBus!==e){if(this._outBus&&(this._outBus.onDisposeObservable.removeCallback(this._onOutBusDisposed),!this._disconnect(this._outBus)))throw new Error("Disconnect failed");if(this._outBus=e,this._outBus&&(this._outBus.onDisposeObservable.add(this._onOutBusDisposed),!this._connect(this._outBus)))throw new Error("Connect failed")}}dispose(){super.dispose(),this._outBus=null}}});function $n(s){return s.spatialEnabled||s.spatialAutoUpdate!==void 0||s.spatialConeInnerAngle!==void 0||s.spatialConeOuterAngle!==void 0||s.spatialConeOuterVolume!==void 0||s.spatialDistanceModel!==void 0||s.spatialMaxDistance!==void 0||s.spatialMinDistance!==void 0||s.spatialMinUpdateTime!==void 0||s.spatialPanningModel!==void 0||s.spatialPosition!==void 0||s.spatialRolloffFactor!==void 0||s.spatialRotation!==void 0||s.spatialRotationQuaternion!==void 0}var ni,PT,oo=S(()=>{ie();ni={coneInnerAngle:6.28318530718,coneOuterAngle:6.28318530718,coneOuterVolume:0,distanceModel:"linear",maxDistance:1e4,minDistance:1,panningModel:"equalpower",position:E.Zero(),rolloffFactor:1,rotation:E.Zero(),rotationQuaternion:new K};PT=class{}});function gz(s){return s.stereoEnabled||s.stereoPan!==void 0}var OT,DT,LT=S(()=>{OT={pan:0};DT=class{}});function p0(s){return s.getSubNode("Stereo")}function vz(s,e,t){s.callOnSubNode("Stereo",i=>{i[e]=t})}var wT,FT=S(()=>{dd();LT();wT=class extends Zn{constructor(e){super("Stereo",e)}setOptions(e){this.pan=e.stereoPan??OT.pan}}});var ea,_d=S(()=>{LT();FT();ea=class extends DT{constructor(e){super(),this._pan=OT.pan,this._subGraph=e}get pan(){return this._pan}set pan(e){this._pan=e,vz(this._subGraph,"pan",e)}}});function ta(s){return s.getSubNode("Spatial")}function lo(s,e,t){s.callOnSubNode("Spatial",i=>{i[e]=t})}var NT,BT=S(()=>{$y();oo();dd();NT=class extends Zn{constructor(e){super("Spatial",e),this._attacherComponent=null}get isAttached(){return this._attacherComponent!==null&&this._attacherComponent.isAttached}attach(e,t,i){this.detach(),this._attacherComponent||(this._attacherComponent=new ic(this)),this._attacherComponent.attach(e,t,i)}detach(){this._attacherComponent?.detach()}dispose(){super.dispose(),this._attacherComponent?.dispose(),this._attacherComponent=null}setOptions(e){this.coneInnerAngle=e.spatialConeInnerAngle??ni.coneInnerAngle,this.coneOuterAngle=e.spatialConeOuterAngle??ni.coneOuterAngle,this.coneOuterVolume=e.spatialConeOuterVolume??ni.coneOuterVolume,this.distanceModel=e.spatialDistanceModel??ni.distanceModel,this.maxDistance=e.spatialMaxDistance??ni.maxDistance,this.minDistance=e.spatialMinDistance??ni.minDistance,this.panningModel=e.spatialPanningModel??ni.panningModel,this.rolloffFactor=e.spatialRolloffFactor??ni.rolloffFactor,e.spatialPosition&&(this.position=e.spatialPosition.clone()),e.spatialRotationQuaternion?this.rotationQuaternion=e.spatialRotationQuaternion.clone():e.spatialRotation?this.rotation=e.spatialRotation.clone():this.rotationQuaternion=ni.rotationQuaternion.clone(),this.update()}update(){this.isAttached?this._attacherComponent?.update():(this._updatePosition(),this._updateRotation())}}});function Ez(s){return s*Math.PI/180}function Tz(s){return s*180/Math.PI}async function xz(s){return new _0(s)}var Sz,m0,UT,_0,Az=S(()=>{ie();BT();oo();rc();Sz=B.Zero(),m0=new K,UT=E.Zero();_0=class extends NT{constructor(e){super(e),this._lastPosition=E.Zero(),this._lastRotation=E.Zero(),this._lastRotationQuaternion=new K,this.position=ni.position.clone(),this.rotation=ni.rotation.clone(),this.rotationQuaternion=ni.rotationQuaternion.clone(),this.node=new PannerNode(e._audioContext),this._orientationX=new Yt(e,this.node.orientationX),this._orientationY=new Yt(e,this.node.orientationY),this._orientationZ=new Yt(e,this.node.orientationZ),this._positionX=new Yt(e,this.node.positionX),this._positionY=new Yt(e,this.node.positionY),this._positionZ=new Yt(e,this.node.positionZ)}dispose(){super.dispose(),this._orientationX.dispose(),this._orientationY.dispose(),this._orientationZ.dispose(),this._positionX.dispose(),this._positionY.dispose(),this._positionZ.dispose(),this.node.disconnect()}get coneInnerAngle(){return Ez(this.node.coneInnerAngle)}set coneInnerAngle(e){this.node.coneInnerAngle=Tz(e)}get coneOuterAngle(){return Ez(this.node.coneOuterAngle)}set coneOuterAngle(e){this.node.coneOuterAngle=Tz(e)}get coneOuterVolume(){return this.node.coneOuterGain}set coneOuterVolume(e){this.node.coneOuterGain=e}get distanceModel(){return this.node.distanceModel}set distanceModel(e){this.node.distanceModel=e;let t=this.node.maxDistance;this.node.maxDistance=t+.001,this.node.maxDistance=t}get minDistance(){return this.node.refDistance}set minDistance(e){this.node.refDistance=e}get maxDistance(){return this.node.maxDistance}set maxDistance(e){this.node.maxDistance=e}get panningModel(){return this.node.panningModel}set panningModel(e){this.node.panningModel=e}get rolloffFactor(){return this.node.rolloffFactor}set rolloffFactor(e){this.node.rolloffFactor=e}get _inNode(){return this.node}get _outNode(){return this.node}_updatePosition(){this._lastPosition.equalsWithEpsilon(this.position)||this.isAttached&&(this._positionX.isRamping||this._positionY.isRamping||this._positionZ.isRamping)||(this._positionX.targetValue=this.position.x,this._positionY.targetValue=this.position.y,this._positionZ.targetValue=this.position.z,this._lastPosition.copyFrom(this.position))}_updateRotation(){if(!(this.isAttached&&(this._orientationX.isRamping||this._orientationY.isRamping||this._orientationZ.isRamping))){if(!this._lastRotationQuaternion.equalsWithEpsilon(this.rotationQuaternion))m0.copyFrom(this.rotationQuaternion),this._lastRotationQuaternion.copyFrom(this.rotationQuaternion);else if(!this._lastRotation.equalsWithEpsilon(this.rotation))K.FromEulerAnglesToRef(this.rotation.x,this.rotation.y,this.rotation.z,m0),this._lastRotation.copyFrom(this.rotation);else return;B.FromQuaternionToRef(m0,Sz),E.TransformNormalToRef(E.RightReadOnly,Sz,UT),this._orientationX.targetValue=UT.x,this._orientationY.targetValue=UT.y,this._orientationZ.targetValue=UT.z}}_connect(e){return super._connect(e)?(e._inNode&&this.node.connect(e._inNode),!0):!1}_disconnect(e){return super._disconnect(e)?(e._inNode&&this.node.disconnect(e._inNode),!0):!1}getClassName(){return"_SpatialWebAudioSubNode"}}});async function Rz(s){return new g0(s)}var g0,bz=S(()=>{FT();rc();g0=class extends wT{constructor(e){super(e),this.node=new StereoPannerNode(e._audioContext),this._pan=new Yt(e,this.node.pan)}dispose(){super.dispose(),this._pan.dispose()}get pan(){return this._pan.targetValue}set pan(e){this._pan.targetValue=e}get _inNode(){return this.node}get _outNode(){return this.node}getClassName(){return"_StereoWebAudioSubNode"}_connect(e){return super._connect(e)?(e._inNode&&this.node.connect(e._inNode),!0):!1}_disconnect(e){return super._disconnect(e)?(e._inNode&&this.node.disconnect(e._inNode),!0):!1}}});var GT,Cz=S(()=>{GT=class{constructor(){this._createSubNodePromises={},this._isDisposed=!1,this._subNodes={},this._onSubNodeDisposed=e=>{let t=e;delete this._subNodes[t.name],this._onSubNodesChanged()}}callOnSubNode(e,t){let i=this.getSubNode(e);if(i){t(i);return}this._createSubNodePromisesResolvedAsync().then(()=>{let r=this.getSubNode(e);if(r){t(r);return}this.createAndAddSubNodeAsync(e).then(n=>{t(n)})})}createAndAddSubNodeAsync(e){var t;return(t=this._createSubNodePromises)[e]||(t[e]=this._createSubNode(e).then(i=>(this._addSubNode(i),i))),this._createSubNodePromises[e]}dispose(){this._isDisposed=!0;let e=Object.values(this._subNodes);for(let t of e)t.dispose();this._subNodes={},this._createSubNodePromises={}}getSubNode(e){return this._subNodes[e]??null}async removeSubNodeAsync(e){await this._createSubNodePromisesResolvedAsync();let t=e.name;this._subNodes[t]&&delete this._subNodes[t],delete this._createSubNodePromises[t],this._onSubNodesChanged()}async _createSubNodePromisesResolvedAsync(){return await Promise.all(Object.values(this._createSubNodePromises))}_addSubNode(e){if(this._isDisposed){e.dispose();return}this._subNodes[e.name]=e,e.onDisposeObservable.addOnce(this._onSubNodeDisposed),this._onSubNodesChanged()}}});async function Iz(s){return new v0(s)}var v0,yz=S(()=>{pd();rc();v0=class extends AT{constructor(e){super(e);let t=this.node=new GainNode(e._audioContext);this._volume=new Yt(e,t.gain)}dispose(){super.dispose(),this._volume.dispose()}get volume(){return this._volume.value}set volume(e){this.setVolume(e)}get _inNode(){return this.node}get _outNode(){return this.node}setVolume(e,t=null){this._volume.setTargetValue(e,t)}_connect(e){return super._connect(e)?(e._inNode&&this.node.connect(e._inNode),!0):!1}_disconnect(e){return super._disconnect(e)?(e._inNode&&this.node.disconnect(e._inNode),!0):!1}getClassName(){return"_VolumeWebAudioSubNode"}}});async function Mz(s){return new S0(s)}var S0,Pz=S(()=>{IT();h0();S0=class extends CT{constructor(e){super(e),this._byteFrequencyData=null,this._floatFrequencyData=null,this._analyzerNode=new AnalyserNode(e._audioContext)}get fftSize(){return this._analyzerNode.fftSize}set fftSize(e){e!==this._analyzerNode.fftSize&&(this._analyzerNode.fftSize=e,this._clearArrays())}get _inNode(){return this._analyzerNode}get minDecibels(){return this._analyzerNode.minDecibels}set minDecibels(e){this._analyzerNode.minDecibels=e}get maxDecibels(){return this._analyzerNode.maxDecibels}set maxDecibels(e){this._analyzerNode.maxDecibels=e}get smoothing(){return this._analyzerNode.smoothingTimeConstant}set smoothing(e){this._analyzerNode.smoothingTimeConstant=e}dispose(){super.dispose(),this._clearArrays(),this._byteFrequencyData=null,this._floatFrequencyData=null,this._analyzerNode.disconnect()}getClassName(){return"_WebAudioAnalyzerSubNode"}getByteFrequencyData(){return(!this._byteFrequencyData||this._byteFrequencyData.length===0)&&(this._byteFrequencyData=new Uint8Array(this._analyzerNode.frequencyBinCount)),this._analyzerNode.getByteFrequencyData(this._byteFrequencyData),this._byteFrequencyData}getFloatFrequencyData(){return(!this._floatFrequencyData||this._floatFrequencyData.length===0)&&(this._floatFrequencyData=new Float32Array(this._analyzerNode.frequencyBinCount)),this._analyzerNode.getFloatFrequencyData(this._floatFrequencyData),this._floatFrequencyData}_clearArrays(){this._byteFrequencyData?.set(c0()),this._floatFrequencyData?.set(f0())}}});var eh,E0=S(()=>{Cz();IT();pd();bT();yz();Pz();eh=class extends GT{constructor(e){super(),this._outputNode=null,this._owner=e}async initAsync(e){let t=mz(e);if(t&&await this.createAndAddSubNodeAsync("Analyzer"),await this.createAndAddSubNodeAsync("Volume"),await this._createSubNodePromisesResolvedAsync(),t){let r=ao(this);if(!r)throw new Error("No analyzer subnode.");r.setOptions(e)}let i=no(this);if(!i)throw new Error("No volume subnode.");if(i.setOptions(e),i.getClassName()!=="_VolumeWebAudioSubNode")throw new Error("Not a WebAudio subnode.");if(this._outputNode=i.node,this._outputNode&&this._downstreamNodes){let r=this._downstreamNodes.values();for(let n=r.next();!n.done;n=r.next()){let a=n.value._inNode;a&&this._outputNode.connect(a)}}}get _inNode(){return this._outputNode}get _outNode(){return this._outputNode}_createSubNode(e){switch(e){case"Analyzer":return Mz(this._owner.engine);case"Volume":return Iz(this._owner.engine);default:throw new Error(`Unknown subnode name: ${e}`)}}_onSubNodesChanged(){let e=ao(this),t=no(this);e&&t&&t.connect(e)}}});var ia,gd=S(()=>{BT();FT();pd();oo();LT();Az();bz();E0();ia=class extends eh{constructor(){super(...arguments),this._rootNode=null,this._inputNode=null}async initAsync(e){await super.initAsync(e);let t=!1,i=!1;(t=$n(e))&&await this.createAndAddSubNodeAsync("Spatial"),(i=gz(e))&&await this.createAndAddSubNodeAsync("Stereo"),await this._createSubNodePromisesResolvedAsync(),t&&ta(this)?.setOptions(e),i&&p0(this)?.setOptions(e)}get _inNode(){return this._inputNode}_createSubNode(e){try{return super._createSubNode(e)}catch{}switch(e){case"Spatial":return xz(this._owner.engine);case"Stereo":return Rz(this._owner.engine);default:throw new Error(`Unknown subnode name: ${e}`)}}_onSubNodesChanged(){super._onSubNodesChanged();let e=ta(this),t=p0(this),i=no(this);if(e&&e.getClassName()!=="_SpatialWebAudioSubNode")throw new Error("Not a WebAudio subnode.");if(t&&t.getClassName()!=="_StereoWebAudioSubNode")throw new Error("Not a WebAudio subnode.");if(i&&i.getClassName()!=="_VolumeWebAudioSubNode")throw new Error("Not a WebAudio subnode.");e&&(e.disconnectAll(),i&&e.connect(i)),t&&(t.disconnectAll(),i&&t.connect(i)),e&&t?(this._rootNode=new GainNode(this._owner.engine._audioContext),this._rootNode.connect(e._outNode),this._rootNode.connect(t._outNode)):(this._rootNode?.disconnect(),this._rootNode=null);let r=null,n=null;if(this._rootNode?n=this._rootNode:(e?r=e:t?r=t:i&&(r=i),n=r?.node??null),this._inputNode!==n){if(this._inputNode&&this._upstreamNodes){let a=this._upstreamNodes.values();for(let o=a.next();!o.done;o=a.next())o.value._outNode?.disconnect(this._inputNode)}if(this._inputNode=n,n&&this._upstreamNodes){let a=this._upstreamNodes.values();for(let o=a.next();!o.done;o=a.next())o.value._outNode?.connect(n)}}}}});var VT,Dz=S(()=>{BT();oo();VT=class extends PT{constructor(e){super(),this._coneInnerAngle=ni.coneInnerAngle,this._coneOuterAngle=ni.coneOuterAngle,this._coneOuterVolume=ni.coneOuterVolume,this._distanceModel=ni.distanceModel,this._maxDistance=ni.maxDistance,this._minDistance=ni.minDistance,this._panningModel=ni.panningModel,this._rolloffFactor=ni.rolloffFactor;let t=ta(e);t?(this._position=t.position.clone(),this._rotation=t.rotation.clone(),this._rotationQuaternion=t.rotationQuaternion.clone()):(this._position=ni.position.clone(),this._rotation=ni.rotation.clone(),this._rotationQuaternion=ni.rotationQuaternion.clone(),e.createAndAddSubNodeAsync("Spatial")),this._subGraph=e}get coneInnerAngle(){return this._coneInnerAngle}set coneInnerAngle(e){this._coneInnerAngle=e,lo(this._subGraph,"coneInnerAngle",e)}get coneOuterAngle(){return this._coneOuterAngle}set coneOuterAngle(e){this._coneOuterAngle=e,lo(this._subGraph,"coneOuterAngle",e)}get coneOuterVolume(){return this._coneOuterVolume}set coneOuterVolume(e){this._coneOuterVolume=e,lo(this._subGraph,"coneOuterVolume",e)}get distanceModel(){return this._distanceModel}set distanceModel(e){this._distanceModel=e,lo(this._subGraph,"distanceModel",e)}get isAttached(){return this._subGraph.getSubNode("Spatial")?.isAttached??!1}get maxDistance(){return this._maxDistance}set maxDistance(e){e<=0&&(e=1e-6),this._maxDistance=e,lo(this._subGraph,"maxDistance",e)}get minDistance(){return this._minDistance}set minDistance(e){this._minDistance=e,lo(this._subGraph,"minDistance",e)}get panningModel(){return this._panningModel}set panningModel(e){this._panningModel=e,lo(this._subGraph,"panningModel",e)}get position(){return this._position}set position(e){this._position=e,this._updatePosition()}get rolloffFactor(){return this._rolloffFactor}set rolloffFactor(e){this._rolloffFactor=e,lo(this._subGraph,"rolloffFactor",e)}get rotation(){return this._rotation}set rotation(e){this._rotation=e,this._updateRotation()}get rotationQuaternion(){return this._rotationQuaternion}set rotationQuaternion(e){this._rotationQuaternion=e,this._updateRotation()}attach(e,t=!1,i=3){ta(this._subGraph)?.attach(e,t,i)}detach(){ta(this._subGraph)?.detach()}update(){let e=ta(this._subGraph);e&&(e.isAttached?e.update():(this._updatePosition(e),this._updateRotation(e)))}_updatePosition(e=null){if(!e&&(e=ta(this._subGraph),!e))return;e.position.equalsWithEpsilon(this._position)||(e.position.copyFrom(this._position),e._updatePosition())}_updateRotation(e=null){!e&&(e=ta(this._subGraph),!e)||(e.rotationQuaternion.equalsWithEpsilon(this._rotationQuaternion)?e.rotation.equalsWithEpsilon(this._rotation)||(e.rotation.copyFrom(this._rotation),e._updateRotation()):(e.rotationQuaternion.copyFrom(this._rotationQuaternion),e._updateRotation()))}}});var ra,vd=S(()=>{Dz();e0();ra=class extends VT{constructor(e,t,i){super(e),this._updaterComponent=new jf(this,t,i)}get minUpdateTime(){return this._updaterComponent.minUpdateTime}set minUpdateTime(e){this._updaterComponent.minUpdateTime=e}dispose(){this._updaterComponent.dispose(),this._updaterComponent=null}}});var Oz={};V(Oz,{_WebAudioBus:()=>kT});var kT,Lz=S(()=>{_z();oo();_d();gd();vd();kT=class s extends MT{constructor(e,t,i){super(e,t),this._spatial=null,this._spatialAutoUpdate=!0,this._spatialMinUpdateTime=0,this._stereo=null,typeof i.spatialAutoUpdate=="boolean"&&(this._spatialAutoUpdate=i.spatialAutoUpdate),typeof i.spatialMinUpdateTime=="number"&&(this._spatialMinUpdateTime=i.spatialMinUpdateTime),this._subGraph=new s._SubGraph(this)}async _initAsync(e){e.outBus?this.outBus=e.outBus:(await this.engine.isReadyPromise,this.outBus=this.engine.defaultMainBus),await this._subGraph.initAsync(e),$n(e)&&this._initSpatialProperty(),this.engine._addNode(this)}dispose(){super.dispose(),this._spatial=null,this._stereo=null,this.engine._removeNode(this)}get _inNode(){return this._subGraph._inNode}get _outNode(){return this._subGraph._outNode}get spatial(){return this._spatial?this._spatial:this._initSpatialProperty()}get stereo(){return this._stereo??(this._stereo=new ea(this._subGraph))}getClassName(){return"_WebAudioBus"}_connect(e){return super._connect(e)?(e._inNode&&this._outNode?.connect(e._inNode),!0):!1}_disconnect(e){return super._disconnect(e)?(e._inNode&&this._outNode?.disconnect(e._inNode),!0):!1}_initSpatialProperty(){return this._spatial||(this._spatial=new ra(this._subGraph,this._spatialAutoUpdate,this._spatialMinUpdateTime)),this._spatial}};kT._SubGraph=class extends ia{get _downstreamNodes(){return this._owner._downstreamNodes??null}get _upstreamNodes(){return this._owner._upstreamNodes??null}}});var WT,wz=S(()=>{d0();WT=class extends $f{constructor(e,t){super(e,t)}}});var Fz={};V(Fz,{_WebAudioMainBus:()=>HT});var HT,Nz=S(()=>{wz();E0();HT=class s extends WT{constructor(e,t){super(e,t),this._subGraph=new s._SubGraph(this)}async _initAsync(e){if(await this._subGraph.initAsync(e),this.engine.mainOut&&!this._connect(this.engine.mainOut))throw new Error("Connect failed");this.engine._addMainBus(this)}dispose(){super.dispose(),this.engine._removeMainBus(this)}get _inNode(){return this._subGraph._inNode}get _outNode(){return this._subGraph._outNode}_connect(e){return super._connect(e)?(e._inNode&&this._outNode?.connect(e._inNode),!0):!1}_disconnect(e){return super._disconnect(e)?(e._inNode&&this._outNode?.disconnect(e._inNode),!0):!1}getClassName(){return"_WebAudioMainBus"}};HT._SubGraph=class extends eh{get _downstreamNodes(){return this._owner._downstreamNodes??null}}});var th,T0=S(()=>{u0();th=class extends Jf{constructor(e,t,i=2){super(e,t,i),this._outBus=null,this._onOutBusDisposed=()=>{this._outBus=null}}get outBus(){return this._outBus}set outBus(e){if(this._outBus!==e){if(this._outBus&&(this._outBus.onDisposeObservable.removeCallback(this._onOutBusDisposed),!this._disconnect(this._outBus)))throw new Error("Disconnect failed");if(this._outBus=e,this._outBus&&(this._outBus.onDisposeObservable.add(this._onOutBusDisposed),!this._connect(this._outBus)))throw new Error("Connect failed")}}dispose(){super.dispose(),this._outBus=null}}});var ih,x0=S(()=>{we();T0();ih=class extends th{constructor(e,t){super(e,t,3),this._newestInstance=null,this._privateInstances=new Set,this._state=1,this._instances=this._privateInstances,this.onEndedObservable=new N,this._onInstanceEnded=i=>{this._newestInstance===i&&(this._newestInstance=null),this._privateInstances.delete(i),this._instances.size===0&&(this._state=1,this.onEndedObservable.notifyObservers(this))}}get autoplay(){return this._options.autoplay}get currentTime(){let e=this._getNewestInstance();return e?e.currentTime:0}set currentTime(e){this.startOffset=e;let t=this._getNewestInstance();t&&(t.currentTime=e)}get loop(){return this._options.loop}set loop(e){this._options.loop=e}get maxInstances(){return this._options.maxInstances}set maxInstances(e){this._options.maxInstances=e}get startOffset(){return this._options.startOffset}set startOffset(e){this._options.startOffset=e}get state(){return this._state}dispose(){super.dispose(),this.stop(),this._newestInstance=null,this._privateInstances.clear(),this.onEndedObservable.clear()}pause(){let e=this._instances.values();for(let t=e.next();!t.done;t=e.next())t.value.pause();this._state=5}resume(){if(this._state!==5)return;let e=this._instances.values();for(let t=e.next();!t.done;t=e.next())t.value.resume();this._state=3}_beforePlay(e){if(this.state===5&&this._instances.size>0){this.resume();return}e.onEndedObservable.addOnce(this._onInstanceEnded),this._privateInstances.add(e),this._newestInstance=e}_afterPlay(e){this._state=e.state}_getNewestInstance(){if(this._instances.size===0)return null;if(!this._newestInstance){let e=this._instances.values();for(let t=e.next();!t.done;t=e.next())this._newestInstance=t.value}return this._newestInstance}_setState(e){this._state=e}_stopExcessInstances(){if(this.maxInstances<1/0){let e=Array.from(this._instances).filter(i=>i.state===3).length-this.maxInstances,t=this._instances.values();for(let i=0;i<e;i++)t.next().value.stop()}}}});var zT,Bz=S(()=>{x0();zT=class extends ih{constructor(e,t){super(e,t)}get duration(){return this._options.duration}set duration(e){this._options.duration=e}get loopStart(){return this._options.loopStart}set loopStart(e){this._options.loopStart=e}get loopEnd(){return this._options.loopEnd}set loopEnd(e){this._options.loopEnd=e}get pitch(){return this._options.pitch}set pitch(e){this._options.pitch=e;let t=this._instances.values();for(let i=t.next();!i.done;i=t.next())i.value.pitch=e}get playbackRate(){return this._options.playbackRate}set playbackRate(e){this._options.playbackRate=e;let t=this._instances.values();for(let i=t.next();!i.done;i=t.next())i.value.playbackRate=e}play(e={}){if(this.state===5){this.resume();return}e.duration??(e.duration=this.duration),e.loop??(e.loop=this.loop),e.loopStart??(e.loopStart=this.loopStart),e.loopEnd??(e.loopEnd=this.loopEnd),e.startOffset??(e.startOffset=this.startOffset),e.volume??(e.volume=1),e.waitTime??(e.waitTime=0);let t=this._createInstance();this._beforePlay(t),t.play(e),this._afterPlay(t),this._stopExcessInstances()}stop(e={}){if(e.waitTime&&0<e.waitTime?this._setState(0):this._setState(1),!!this._instances)for(let t of Array.from(this._instances))t.stop(e)}}});var Yte,XT,Uz=S(()=>{Yte=1,XT=class{constructor(e){this.name=`StaticSoundBuffer #${Yte++}`,this.engine=e}}});var rh,A0=S(()=>{we();ud();rh=class extends sc{constructor(e){super(e.engine,2),this._state=1,this.onEndedObservable=new N,this.onErrorObservable=new N,this.onStateChangedObservable=new N,this._sound=e}get state(){return this._state}dispose(){super.dispose(),this.stop(),this.onEndedObservable.clear(),this.onStateChangedObservable.clear()}_setState(e){this._state!==e&&(this._state=e,this.onStateChangedObservable.notifyObservers(this))}}});var YT,Gz=S(()=>{A0();YT=class extends rh{}});var b0={};V(b0,{_WebAudioStaticSound:()=>sh,_WebAudioStaticSoundBuffer:()=>KT});var sh,KT,R0,C0=S(()=>{Bz();Uz();Gz();oo();_d();vT();rc();gd();vd();sh=class s extends zT{constructor(e,t,i){super(e,t),this._spatial=null,this._spatialAutoUpdate=!0,this._spatialMinUpdateTime=0,this._stereo=null,typeof i.spatialAutoUpdate=="boolean"&&(this._spatialAutoUpdate=i.spatialAutoUpdate),typeof i.spatialMinUpdateTime=="number"&&(this._spatialMinUpdateTime=i.spatialMinUpdateTime),this._options={autoplay:i.autoplay??!1,duration:i.duration??0,loop:i.loop??!1,loopEnd:i.loopEnd??0,loopStart:i.loopStart??0,maxInstances:i.maxInstances??1/0,pitch:i.pitch??0,playbackRate:i.playbackRate??1,startOffset:i.startOffset??0},this._subGraph=new s._SubGraph(this)}async _initAsync(e,t){this._audioContext=this.engine._audioContext,e instanceof KT?this._buffer=e:(typeof e=="string"||Array.isArray(e)||e instanceof ArrayBuffer||e instanceof AudioBuffer)&&(this._buffer=await this.engine.createSoundBufferAsync(e,t)),t.outBus?this.outBus=t.outBus:t.outBusAutoDefault!==!1&&(await this.engine.isReadyPromise,this.outBus=this.engine.defaultMainBus),await this._subGraph.initAsync(t),$n(t)&&this._initSpatialProperty(),t.autoplay&&this.play(),this.engine._addNode(this)}get buffer(){return this._buffer}get _inNode(){return this._subGraph._inNode}get _outNode(){return this._subGraph._outNode}get spatial(){return this._spatial?this._spatial:this._initSpatialProperty()}get stereo(){return this._stereo??(this._stereo=new ea(this._subGraph))}async cloneAsync(e=null){let t=await this.engine.createSoundAsync(this.name,e?.cloneBuffer?this.buffer.clone():this.buffer,this._options);return t.outBus=e?.outBus?e.outBus:this.outBus,t}dispose(){super.dispose(),this._spatial?.dispose(),this._spatial=null,this._stereo=null,this._subGraph.dispose(),this.engine._removeNode(this)}getClassName(){return"_WebAudioStaticSound"}_createInstance(){return new R0(this,this._options)}_connect(e){return super._connect(e)?(e._inNode&&this._outNode?.connect(e._inNode),!0):!1}_disconnect(e){return super._disconnect(e)?(e._inNode&&this._outNode?.disconnect(e._inNode),!0):!1}_initSpatialProperty(){return this._spatial||(this._spatial=new ra(this._subGraph,this._spatialAutoUpdate,this._spatialMinUpdateTime)),this._spatial}};sh._SubGraph=class extends ia{get _downstreamNodes(){return this._owner._downstreamNodes??null}get _upstreamNodes(){return this._owner._upstreamNodes??null}};KT=class s extends XT{constructor(e){super(e)}async _initAsync(e,t){e instanceof AudioBuffer?this._audioBuffer=e:typeof e=="string"?await this._initFromUrlAsync(e):Array.isArray(e)?await this._initFromUrlsAsync(e,t.skipCodecCheck??!1):e instanceof ArrayBuffer&&await this._initFromArrayBufferAsync(e)}get channelCount(){return this._audioBuffer.numberOfChannels}get duration(){return this._audioBuffer.duration}get length(){return this._audioBuffer.length}get sampleRate(){return this._audioBuffer.sampleRate}clone(e=null){let t=new AudioBuffer({length:this._audioBuffer.length,numberOfChannels:this._audioBuffer.numberOfChannels,sampleRate:this._audioBuffer.sampleRate});for(let r=0;r<this._audioBuffer.numberOfChannels;r++)t.copyToChannel(this._audioBuffer.getChannelData(r),r);let i=new s(this.engine);return i._audioBuffer=t,i.name=e?.name?e.name:this.name,i}async _initFromArrayBufferAsync(e){this._audioBuffer=await this.engine._audioContext.decodeAudioData(e)}async _initFromUrlAsync(e){e=hd(e),await this._initFromArrayBufferAsync(await(await fetch(e)).arrayBuffer())}async _initFromUrlsAsync(e,t){for(let i of e){if(t)await this._initFromUrlAsync(i);else{let n=i.match(sz)?.at(1);if(n&&this.engine.isFormatValid(n))try{await this._initFromUrlAsync(i)}catch{n&&0<n.length&&this.engine.flagInvalidFormat(n)}}if(this._audioBuffer)break}}},R0=class extends YT{constructor(e,t){super(e),this._enginePlayTime=0,this._enginePauseTime=0,this._isConnected=!1,this._pitch=null,this._playbackRate=null,this._sourceNode=null,this._onEnded=()=>{this._enginePlayTime=0,this.onEndedObservable.notifyObservers(this),this._deinitSourceNode()},this._onEngineStateChanged=()=>{this.engine.state==="running"&&(this._options.loop&&this.state===2&&this.play(),this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged))},this._options=t,this._volumeNode=new GainNode(e._audioContext),this._initSourceNode()}dispose(){super.dispose(),this._pitch?.dispose(),this._playbackRate?.dispose(),this._sourceNode=null,this.stop(),this._deinitSourceNode(),this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged)}get currentTime(){if(this._state===1)return 0;let e=this._state===5?0:this.engine.currentTime-this._enginePlayTime;return this._enginePauseTime+e+this._options.startOffset}set currentTime(e){let t=this._state===2||this._state===3;t&&(this.stop(),this._deinitSourceNode()),this._options.startOffset=e,t&&this.play()}get _outNode(){return this._volumeNode}set pitch(e){this._pitch?.setTargetValue(e)}set playbackRate(e){this._playbackRate?.setTargetValue(e)}get startTime(){return this._state===1?0:this._enginePlayTime}getClassName(){return"_WebAudioStaticSoundInstance"}play(e={}){if(this._state===3)return;e.duration!==void 0&&(this._options.duration=e.duration),e.loop!==void 0&&(this._options.loop=e.loop),e.loopStart!==void 0&&(this._options.loopStart=e.loopStart),e.loopEnd!==void 0&&(this._options.loopEnd=e.loopEnd),e.startOffset!==void 0&&(this._options.startOffset=e.startOffset);let t=this._options.startOffset;this._state===5&&(t+=this.currentTime,t%=this._sound.buffer.duration),this._enginePlayTime=this.engine.currentTime+(e.waitTime??0),this._volumeNode.gain.value=e.volume??1,this._initSourceNode(),this.engine.state==="running"?(this._setState(3),this._sourceNode?.start(this._enginePlayTime,t,this._options.duration>0?this._options.duration:void 0)):this._options.loop&&(this._setState(2),this.engine.stateChangedObservable.add(this._onEngineStateChanged))}pause(){this._state!==5&&(this._setState(5),this._enginePauseTime+=this.engine.currentTime-this._enginePlayTime,this._sourceNode?.stop(),this._deinitSourceNode())}resume(){this._state===5&&this.play()}stop(e={}){if(this._state===1)return;this._setState(1);let t=this.engine.currentTime+(e.waitTime??0);this._sourceNode?.stop(t),this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged)}_connect(e){return super._connect(e)?(e instanceof sh&&e._inNode&&(this._outNode?.connect(e._inNode),this._isConnected=!0),!0):!1}_disconnect(e){return super._disconnect(e)?(e instanceof sh&&e._inNode&&(this._outNode?.disconnect(e._inNode),this._isConnected=!1),!0):!1}_deinitSourceNode(){if(this._sourceNode){if(this._isConnected&&!this._disconnect(this._sound))throw new Error("Disconnect failed");this._sourceNode.disconnect(this._volumeNode),this._sourceNode.removeEventListener("ended",this._onEnded),this._sourceNode=null}}_initSourceNode(){if(!this._sourceNode){if(this._sourceNode=new AudioBufferSourceNode(this._sound._audioContext,{buffer:this._sound.buffer._audioBuffer}),this._sourceNode.addEventListener("ended",this._onEnded,{once:!0}),this._sourceNode.connect(this._volumeNode),!this._connect(this._sound))throw new Error("Connect failed");this._pitch=new Yt(this.engine,this._sourceNode.detune),this._playbackRate=new Yt(this.engine,this._sourceNode.playbackRate)}let e=this._sourceNode;e.detune.value=this._sound.pitch,e.loop=this._options.loop,e.loopEnd=this._options.loopEnd,e.loopStart=this._options.loopStart,e.playbackRate.value=this._sound.playbackRate}}});var Vz={};V(Vz,{_WebAudioSoundSource:()=>qT});var qT,kz=S(()=>{T0();oo();_d();gd();vd();qT=class s extends th{constructor(e,t,i,r){super(e,i),this._spatial=null,this._spatialAutoUpdate=!0,this._spatialMinUpdateTime=0,this._stereo=null,typeof r.spatialAutoUpdate=="boolean"&&(this._spatialAutoUpdate=r.spatialAutoUpdate),typeof r.spatialMinUpdateTime=="number"&&(this._spatialMinUpdateTime=r.spatialMinUpdateTime),this._audioContext=this.engine._audioContext,this._webAudioNode=t,this._subGraph=new s._SubGraph(this)}async _initAsync(e){e.outBus?this.outBus=e.outBus:e.outBusAutoDefault!==!1&&(await this.engine.isReadyPromise,this.outBus=this.engine.defaultMainBus),await this._subGraph.initAsync(e),$n(e)&&this._initSpatialProperty(),this.engine._addNode(this)}get _inNode(){return this._webAudioNode}get _outNode(){return this._subGraph._outNode}get spatial(){return this._spatial?this._spatial:this._initSpatialProperty()}get stereo(){return this._stereo??(this._stereo=new ea(this._subGraph))}dispose(){super.dispose(),this._spatial?.dispose(),this._spatial=null,this._stereo=null,this._subGraph.dispose(),this.engine._removeNode(this)}getClassName(){return"_WebAudioSoundSource"}_connect(e){return super._connect(e)?(e._inNode&&this._outNode?.connect(e._inNode),!0):!1}_disconnect(e){return super._disconnect(e)?(e._inNode&&this._outNode?.disconnect(e._inNode),!0):!1}_initSpatialProperty(){return this._spatial||(this._spatial=new ra(this._subGraph,this._spatialAutoUpdate,this._spatialMinUpdateTime)),this._spatial}};qT._SubGraph=class extends ia{get _downstreamNodes(){return this._owner._downstreamNodes??null}get _upstreamNodes(){return this._owner._upstreamNodes??null}_onSubNodesChanged(){super._onSubNodesChanged(),this._owner._inNode.disconnect(),this._owner._subGraph._inNode&&this._owner._inNode.connect(this._owner._subGraph._inNode)}}});var QT,Wz=S(()=>{x0();QT=class extends ih{constructor(e,t){super(e,t),this._preloadedInstances=new Array}get preloadCount(){return this._options.preloadCount??1}get preloadCompletedCount(){return this._preloadedInstances.length}preloadInstanceAsync(){let e=this._createInstance();return this._addPreloadedInstance(e),e.preloadedPromise}async preloadInstancesAsync(e){for(let t=0;t<e;t++)this.preloadInstanceAsync();await Promise.all(this._preloadedInstances.map(async t=>await t.preloadedPromise))}play(e={}){if(this.state===5){this.resume();return}let t;this.preloadCompletedCount>0?(t=this._preloadedInstances[0],t.startOffset=this.startOffset,this._removePreloadedInstance(t)):t=this._createInstance();let i=()=>{t.state===3&&(this._stopExcessInstances(),t.onStateChangedObservable.removeCallback(i))};t.onStateChangedObservable.add(i),e.startOffset??(e.startOffset=this.startOffset),e.loop??(e.loop=this.loop),e.volume??(e.volume=1),this._beforePlay(t),t.play(e),this._afterPlay(t)}stop(){if(this._setState(1),!!this._instances)for(let e of Array.from(this._instances))e.stop()}_addPreloadedInstance(e){this._preloadedInstances.includes(e)||this._preloadedInstances.push(e)}_removePreloadedInstance(e){let t=this._preloadedInstances.indexOf(e);t!==-1&&this._preloadedInstances.splice(t,1)}}});var jT,Hz=S(()=>{we();A0();jT=class extends rh{constructor(e){super(e),this.onReadyObservable=new N,this.preloadedPromise=new Promise((t,i)=>{this._rejectPreloadedProimse=i,this._resolvePreloadedPromise=t}),this.onErrorObservable.add(this._rejectPreloadedProimse),this.onReadyObservable.add(this._resolvePreloadedPromise)}set startOffset(e){this._options.startOffset=e}dispose(){super.dispose(),this.onErrorObservable.clear(),this.onReadyObservable.clear(),this._resolvePreloadedPromise()}}});var zz={};V(zz,{_WebAudioStreamingSound:()=>nh});var nh,I0,Xz=S(()=>{Ee();$e();Wz();Hz();oo();_d();vT();gd();vd();nh=class s extends QT{constructor(e,t,i){super(e,t),this._spatial=null,this._spatialAutoUpdate=!0,this._spatialMinUpdateTime=0,this._stereo=null,typeof i.spatialAutoUpdate=="boolean"&&(this._spatialAutoUpdate=i.spatialAutoUpdate),typeof i.spatialMinUpdateTime=="number"&&(this._spatialMinUpdateTime=i.spatialMinUpdateTime),this._options={autoplay:i.autoplay??!1,loop:i.loop??!1,maxInstances:i.maxInstances??1/0,preloadCount:i.preloadCount??1,startOffset:i.startOffset??0},this._subGraph=new s._SubGraph(this)}async _initAsync(e,t){let i=this.engine._audioContext;if(!(i instanceof AudioContext))throw new Error("Unsupported audio context type.");this._audioContext=i,this._source=e,t.outBus?this.outBus=t.outBus:t.outBusAutoDefault!==!1&&(await this.engine.isReadyPromise,this.outBus=this.engine.defaultMainBus),await this._subGraph.initAsync(t),$n(t)&&this._initSpatialProperty(),this.preloadCount&&await this.preloadInstancesAsync(this.preloadCount),t.autoplay&&this.play(t),this.engine._addNode(this)}get _inNode(){return this._subGraph._inNode}get _outNode(){return this._subGraph._outNode}get spatial(){return this._spatial?this._spatial:this._initSpatialProperty()}get stereo(){return this._stereo??(this._stereo=new ea(this._subGraph))}dispose(){super.dispose(),this._spatial=null,this._stereo=null,this._subGraph.dispose(),this.engine._removeNode(this)}getClassName(){return"_WebAudioStreamingSound"}_createInstance(){return new I0(this,this._options)}_connect(e){return super._connect(e)?(e._inNode&&this._outNode?.connect(e._inNode),!0):!1}_disconnect(e){return super._disconnect(e)?(e._inNode&&this._outNode?.disconnect(e._inNode),!0):!1}_initSpatialProperty(){return this._spatial||(this._spatial=new ra(this._subGraph,this._spatialAutoUpdate,this._spatialMinUpdateTime)),this._spatial}};nh._SubGraph=class extends ia{get _downstreamNodes(){return this._owner._downstreamNodes??null}get _upstreamNodes(){return this._owner._upstreamNodes??null}};I0=class extends jT{constructor(e,t){super(e),this._currentTimeChangedWhilePaused=!1,this._enginePlayTime=1/0,this._enginePauseTime=0,this._isReady=!1,this._isReadyPromise=new Promise((i,r)=>{this._resolveIsReadyPromise=i,this._rejectIsReadyPromise=r}),this._onCanPlayThrough=()=>{this._isReady=!0,this._resolveIsReadyPromise(this._mediaElement),this.onReadyObservable.notifyObservers(this)},this._onEnded=()=>{this.onEndedObservable.notifyObservers(this),this.dispose()},this._onError=i=>{this._setState(4),this.onErrorObservable.notifyObservers(i),this._rejectIsReadyPromise(i),this.dispose()},this._onEngineStateChanged=()=>{this.engine.state==="running"&&(this._options.loop&&this.state===2&&this.play(),this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged))},this._onUserGesture=()=>{this.play()},this._options=t,this._volumeNode=new GainNode(e._audioContext),typeof e._source=="string"?this._initFromUrl(e._source):Array.isArray(e._source)?this._initFromUrls(e._source):e._source instanceof HTMLMediaElement&&this._initFromMediaElement(e._source)}get currentTime(){if(this._state===1)return 0;let e=this._state===5?0:this.engine.currentTime-this._enginePlayTime;return this._enginePauseTime+e+this._options.startOffset}set currentTime(e){let t=this._state===2||this._state===3;t&&(this._mediaElement.pause(),this._setState(1)),this._options.startOffset=e,t?this.play({startOffset:e}):this._state===5&&(this._currentTimeChangedWhilePaused=!0)}get _outNode(){return this._volumeNode}get startTime(){return this._state===1?0:this._enginePlayTime}dispose(){super.dispose(),this.stop(),this._sourceNode?.disconnect(this._volumeNode),this._sourceNode=null,this._mediaElement.removeEventListener("error",this._onError),this._mediaElement.removeEventListener("ended",this._onEnded),this._mediaElement.removeEventListener("canplaythrough",this._onCanPlayThrough);for(let e of Array.from(this._mediaElement.children))this._mediaElement.removeChild(e);this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged),this.engine.userGestureObservable.removeCallback(this._onUserGesture)}play(e={}){if(this._state===3)return;e.loop!==void 0&&(this._options.loop=e.loop),this._mediaElement.loop=this._options.loop;let t=e.startOffset;this._currentTimeChangedWhilePaused?(t=this._options.startOffset,this._currentTimeChangedWhilePaused=!1):this._state===5&&(t=this.currentTime+this._options.startOffset),t&&t>0&&(this._mediaElement.currentTime=t),this._volumeNode.gain.value=e.volume??1,this._play()}pause(){this._state!==2&&this._state!==3||(this._setState(5),this._enginePauseTime+=this.engine.currentTime-this._enginePlayTime,this._mediaElement.pause())}resume(){this._state===5?this.play():this._currentTimeChangedWhilePaused&&this.play()}stop(){this._state!==1&&this._stop()}getClassName(){return"_WebAudioStreamingSoundInstance"}_connect(e){return super._connect(e)?(e instanceof nh&&e._inNode&&this._outNode?.connect(e._inNode),!0):!1}_disconnect(e){return super._disconnect(e)?(e instanceof nh&&e._inNode&&this._outNode?.disconnect(e._inNode),!0):!1}_initFromMediaElement(e){if(W.SetCorsBehavior(e.currentSrc,e),e.controls=!1,e.loop=this._options.loop,e.preload="auto",e.addEventListener("canplaythrough",this._onCanPlayThrough,{once:!0}),e.addEventListener("ended",this._onEnded,{once:!0}),e.addEventListener("error",this._onError,{once:!0}),e.load(),this._sourceNode=new MediaElementAudioSourceNode(this._sound._audioContext,{mediaElement:e}),this._sourceNode.connect(this._volumeNode),!this._connect(this._sound))throw new Error("Connect failed");this._mediaElement=e}_initFromUrl(e){let t=new Audio(hd(e));this._initFromMediaElement(t)}_initFromUrls(e){let t=new Audio;for(let i of e){let r=document.createElement("source");r.src=hd(i),t.appendChild(r)}this._initFromMediaElement(t)}_play(){if(this._setState(2),!this._isReady){this._playWhenReady();return}if(this._state===2)if(this.engine.state==="running"){let e=this._mediaElement.play();this._enginePlayTime=this.engine.currentTime,this._setState(3),e.catch(()=>{this._setState(4),this._options.loop&&this.engine.userGestureObservable.addOnce(this._onUserGesture)})}else this._options.loop?this.engine.stateChangedObservable.add(this._onEngineStateChanged):(this.stop(),this._setState(4))}_playWhenReady(){this._isReadyPromise.then(()=>{this._play()}).catch(()=>{P.Error("Streaming sound instance failed to play"),this._setState(4)})}_stop(){this._mediaElement.pause(),this._setState(1),this._onEnded(),this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged)}}});var Kte,ZT,Yz=S(()=>{we();ez();Jy();lz();hz();uz();Kte={aac:"audio/aac",ac3:"audio/ac3",flac:"audio/flac",m4a:"audio/mp4",mp3:'audio/mpeg; codecs="mp3"',mp4:"audio/mp4",ogg:'audio/ogg; codecs="vorbis"',wav:"audio/wav",webm:'audio/webm; codecs="vorbis"'},ZT=class extends dT{constructor(e={}){super(e),this._audioContextStarted=!1,this._destinationNode=null,this._invalidFormats=new Set,this._isUpdating=!1,this._listener=null,this._listenerAutoUpdate=!0,this._listenerMinUpdateTime=0,this._pauseCalled=!1,this._resumeOnInteraction=!0,this._resumeOnPause=!0,this._resumeOnPauseRetryInterval=1e3,this._resumeOnPauseTimerId=null,this._resumePromise=null,this._silentHtmlAudio=null,this._unmuteUI=null,this._updateObservable=null,this._validFormats=new Set,this._volume=1,this._isUsingOfflineAudioContext=!1,this.isReadyPromise=new Promise(t=>{this._resolveIsReadyPromise=t}),this.stateChangedObservable=new N,this.userGestureObservable=new N,this._initAudioContextAsync=async()=>{this._audioContext.addEventListener("statechange",this._onAudioContextStateChange),this._mainOut=new TT(this),this._mainOut.volume=this._volume,await this.createMainBusAsync("default")},this._onAudioContextStateChange=()=>{this.state==="running"&&(clearInterval(this._resumeOnPauseTimerId),this._audioContextStarted=!0,this._resumePromise=null),(this.state==="suspended"||this.state==="interrupted")&&this._audioContextStarted&&this._resumeOnPause&&!this._pauseCalled&&(clearInterval(this._resumeOnPauseTimerId),this._resumeOnPauseTimerId=setInterval(()=>{this.resumeAsync()},this._resumeOnPauseRetryInterval)),this.stateChangedObservable.notifyObservers(this.state)},this._onUserGestureAsync=async()=>{if(this._resumeOnInteraction&&await this._audioContext.resume(),!this._silentHtmlAudio){this._silentHtmlAudio=document.createElement("audio");let t=this._silentHtmlAudio;t.controls=!1,t.preload="auto",t.loop=!0,t.src="data:audio/wav;base64,UklGRjAAAABXQVZFZm10IBAAAAABAAEAgLsAAAB3AQACABAAZGF0YQwAAAAAAAEA/v8CAP//AQA=",t.play()}this.userGestureObservable.notifyObservers()},this._startUpdating=()=>{if(!this._isUpdating)if(this._isUpdating=!0,this.state==="running")this._update();else{let t=()=>{this.state==="running"&&(this._update(),this.stateChangedObservable.removeCallback(t))};this.stateChangedObservable.add(t)}},this._update=()=>{this._updateObservable?.hasObservers()?(this._updateObservable.notifyObservers(),requestAnimationFrame(this._update)):this._isUpdating=!1},typeof e.listenerAutoUpdate=="boolean"&&(this._listenerAutoUpdate=e.listenerAutoUpdate),typeof e.listenerMinUpdateTime=="number"&&(this._listenerMinUpdateTime=e.listenerMinUpdateTime),this._volume=e.volume??1,e.audioContext?(this._isUsingOfflineAudioContext=e.audioContext instanceof OfflineAudioContext,this._audioContext=e.audioContext):this._audioContext=new AudioContext,e.disableDefaultUI||(this._unmuteUI=new xT(this,e.defaultUIParentElement))}async _initAsync(e){this._resumeOnInteraction=typeof e.resumeOnInteraction=="boolean"?e.resumeOnInteraction:!0,this._resumeOnPause=typeof e.resumeOnPause=="boolean"?e.resumeOnPause:!0,this._resumeOnPauseRetryInterval=e.resumeOnPauseRetryInterval??1e3,document.addEventListener("click",this._onUserGestureAsync),await this._initAudioContextAsync(),iz(e)&&(this._listener=a0(this,this._listenerAutoUpdate,this._listenerMinUpdateTime),this._listener.setOptions(e)),this._resolveIsReadyPromise()}get currentTime(){return this._audioContext.currentTime??0}get _inNode(){return this._audioContext.destination}get mainOut(){return this._mainOut}get listener(){return this._listener??(this._listener=a0(this,this._listenerAutoUpdate,this._listenerMinUpdateTime))}get state(){return this._isUsingOfflineAudioContext?"running":this._audioContext.state}get volume(){return this._volume}set volume(e){this._volume!==e&&(this._volume=e,this._mainOut&&(this._mainOut.volume=e))}get _audioDestination(){return this._destinationNode?this._destinationNode:this._destinationNode=this._audioContext.destination}set _audioDestination(e){this._destinationNode=e}get _unmuteUIEnabled(){return this._unmuteUI?this._unmuteUI.enabled:!1}set _unmuteUIEnabled(e){this._unmuteUI&&(this._unmuteUI.enabled=e)}async createBusAsync(e,t={}){let i=await Promise.resolve().then(()=>(Lz(),Oz)),r=new i._WebAudioBus(e,this,t);return await r._initAsync(t),r}async createMainBusAsync(e,t={}){let i=await Promise.resolve().then(()=>(Nz(),Fz)),r=new i._WebAudioMainBus(e,this);return await r._initAsync(t),r}async createMicrophoneSoundSourceAsync(e,t){let i;try{i=await navigator.mediaDevices.getUserMedia({audio:!0})}catch(r){throw new Error("Unable to access microphone: "+r)}return await this.createSoundSourceAsync(e,new MediaStreamAudioSourceNode(this._audioContext,{mediaStream:i}),{outBusAutoDefault:!1,...t})}async createSoundAsync(e,t,i={}){let r=await Promise.resolve().then(()=>(C0(),b0)),n=new r._WebAudioStaticSound(e,this,i);return await n._initAsync(t,i),n}async createSoundBufferAsync(e,t={}){let i=await Promise.resolve().then(()=>(C0(),b0)),r=new i._WebAudioStaticSoundBuffer(this);return await r._initAsync(e,t),r}async createSoundSourceAsync(e,t,i={}){let r=await Promise.resolve().then(()=>(kz(),Vz)),n=new r._WebAudioSoundSource(e,t,this,i);return await n._initAsync(i),n}async createStreamingSoundAsync(e,t,i={}){let r=await Promise.resolve().then(()=>(Xz(),zz)),n=new r._WebAudioStreamingSound(e,this,i);return await n._initAsync(t,i),n}dispose(){super.dispose(),this._listener?.dispose(),this._listener=null,this._audioContext.state!=="closed"&&!this._isUsingOfflineAudioContext&&this._audioContext.close(),document.removeEventListener("click",this._onUserGestureAsync),this._audioContext.removeEventListener("statechange",this._onAudioContextStateChange),this._silentHtmlAudio?.remove(),this._updateObservable?.clear(),this._updateObservable=null,this._unmuteUI?.dispose(),this._unmuteUI=null,this.stateChangedObservable.clear()}flagInvalidFormat(e){this._invalidFormats.add(e)}isFormatValid(e){if(this._validFormats.has(e))return!0;if(this._invalidFormats.has(e))return!1;let t=Kte[e];return t===void 0?!1:new Audio().canPlayType(t)===""?(this._invalidFormats.add(e),!1):(this._validFormats.add(e),!0)}async pauseAsync(){await this._audioContext.suspend(),this._pauseCalled=!0}resumeAsync(){return this._pauseCalled=!1,this._resumePromise?this._resumePromise:(this._resumePromise=this._audioContext.resume(),this._resumePromise)}setVolume(e,t=null){if(this._mainOut)this._mainOut.setVolume(e,t);else throw new Error("Main output not initialized yet.")}_addMainBus(e){super._addMainBus(e)}_removeMainBus(e){super._removeMainBus(e)}_addNode(e){super._addNode(e)}_removeNode(e){super._removeNode(e)}_addUpdateObserver(e){this._updateObservable||(this._updateObservable=new N),this._updateObservable.add(e),this._startUpdating()}_removeUpdateObserver(e){this._updateObservable&&this._updateObservable.removeCallback(e)}}});var y0,M0=S(()=>{we();Jt();Yz();k.AudioEngineFactory=(s,e,t)=>new y0(s,e,t);y0=class{get masterGain(){return this._masterGain}set masterGain(e){this._masterGain=this._v2.mainOut._inNode=e}get useCustomUnlockedButton(){return this._useCustomUnlockedButton}set useCustomUnlockedButton(e){this._useCustomUnlockedButton=e,this._v2._unmuteUIEnabled=!e}get audioContext(){return this._v2.state==="running"&&this._triggerRunningStateAsync(),this._v2._audioContext}constructor(e=null,t=null,i=null){this._audioContext=null,this._tryToRun=!1,this._useCustomUnlockedButton=!1,this.canUseWebAudio=!0,this.WarnedWebAudioUnsupported=!1,this.isMP3supported=!1,this.isOGGsupported=!1,this.unlocked=!1,this.onAudioUnlockedObservable=new N,this.onAudioLockedObservable=new N;let r=new ZT({audioContext:t||void 0,defaultUIParentElement:e?.parentElement?e.parentElement:void 0});r._unmuteUIEnabled=!1,this._masterGain=new GainNode(r._audioContext),r._audioDestination=i,r.stateChangedObservable.add(n=>{n==="running"?(this.unlocked=!0,this.onAudioUnlockedObservable.notifyObservers(this)):(this.unlocked=!1,this.onAudioLockedObservable.notifyObservers(this))}),r._initAsync({resumeOnInteraction:!1}).then(()=>{let n=r.defaultMainBus._outNode;n&&(n.disconnect(r.mainOut._inNode),n.connect(this._masterGain)),r.mainOut._inNode=this._masterGain,r.stateChangedObservable.notifyObservers(r.state)}),this.isMP3supported=r.isFormatValid("mp3"),this.isOGGsupported=r.isFormatValid("ogg"),this._v2=r}lock(){this._v2._audioContext.suspend(),this._useCustomUnlockedButton||(this._v2._unmuteUIEnabled=!0)}unlock(){if(this._audioContext?.state==="running"){this.unlocked||(this.unlocked=!0,this.onAudioUnlockedObservable.notifyObservers(this));return}this._triggerRunningStateAsync()}_resumeAudioContextOnStateChange(){this._audioContext?.addEventListener("statechange",()=>{this.unlocked&&this._audioContext?.state!=="running"&&this._resumeAudioContextAsync()},{once:!0,passive:!0,signal:AbortSignal.timeout(3e3)})}_resumeAudioContextAsync(){return this._v2._isUsingOfflineAudioContext?Promise.resolve():this._v2._audioContext.resume()}dispose(){this._v2.dispose(),this.onAudioUnlockedObservable.clear(),this.onAudioLockedObservable.clear()}getGlobalVolume(){return this.masterGain.gain.value}setGlobalVolume(e){this.masterGain.gain.value=e}connectToAnalyser(e){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser=e,this.masterGain.disconnect(),this._connectedAnalyser.connectAudioNodes(this.masterGain,this._v2._audioContext.destination)}async _triggerRunningStateAsync(){this._tryToRun||(this._tryToRun=!0,await this._resumeAudioContextAsync(),this._tryToRun=!1,this.unlocked=!0,this.onAudioUnlockedObservable.notifyObservers(this))}}});function JT(s,e){qte[s]=e}var qte,P0=S(()=>{qte={}});var Lr,Kz=S(()=>{Zy();$H();ie();Pn();Xr();M0();zs();gt();Jt();P0();JT(ne.NAME_AUDIO,(s,e,t,i)=>{let r=[],n;if(t.sounds=t.sounds||[],s.sounds!==void 0&&s.sounds!==null)for(let a=0,o=s.sounds.length;a<o;a++){let l=s.sounds[a];k.audioEngine?.canUseWebAudio?(l.url||(l.url=l.name),r[l.url]?t.sounds.push(_n.Parse(l,e,i,r[l.url])):(n=_n.Parse(l,e,i),r[l.url]=n,t.sounds.push(n))):t.sounds.push(new _n(l.name,null,e))}r=[]});Object.defineProperty(ze.prototype,"mainSoundTrack",{get:function(){let s=this._getComponent(ne.NAME_AUDIO);return s||(s=new Lr(this),this._addComponent(s)),this._mainSoundTrack||(this._mainSoundTrack=new hT(this,{mainTrack:!0})),this._mainSoundTrack},enumerable:!0,configurable:!0});ze.prototype.getSoundByName=function(s){let e;for(e=0;e<this.mainSoundTrack.soundCollection.length;e++)if(this.mainSoundTrack.soundCollection[e].name===s)return this.mainSoundTrack.soundCollection[e];if(this.soundTracks){for(let t=0;t<this.soundTracks.length;t++)for(e=0;e<this.soundTracks[t].soundCollection.length;e++)if(this.soundTracks[t].soundCollection[e].name===s)return this.soundTracks[t].soundCollection[e]}return null};Object.defineProperty(ze.prototype,"audioEnabled",{get:function(){let s=this._getComponent(ne.NAME_AUDIO);return s||(s=new Lr(this),this._addComponent(s)),s.audioEnabled},set:function(s){let e=this._getComponent(ne.NAME_AUDIO);e||(e=new Lr(this),this._addComponent(e)),s?e.enableAudio():e.disableAudio()},enumerable:!0,configurable:!0});Object.defineProperty(ze.prototype,"headphone",{get:function(){let s=this._getComponent(ne.NAME_AUDIO);return s||(s=new Lr(this),this._addComponent(s)),s.headphone},set:function(s){let e=this._getComponent(ne.NAME_AUDIO);e||(e=new Lr(this),this._addComponent(e)),s?e.switchAudioModeForHeadphones():e.switchAudioModeForNormalSpeakers()},enumerable:!0,configurable:!0});Object.defineProperty(ze.prototype,"audioListenerPositionProvider",{get:function(){let s=this._getComponent(ne.NAME_AUDIO);return s||(s=new Lr(this),this._addComponent(s)),s.audioListenerPositionProvider},set:function(s){let e=this._getComponent(ne.NAME_AUDIO);if(e||(e=new Lr(this),this._addComponent(e)),s&&typeof s!="function")throw new Error("The value passed to [Scene.audioListenerPositionProvider] must be a function that returns a Vector3");e.audioListenerPositionProvider=s},enumerable:!0,configurable:!0});Object.defineProperty(ze.prototype,"audioListenerRotationProvider",{get:function(){let s=this._getComponent(ne.NAME_AUDIO);return s||(s=new Lr(this),this._addComponent(s)),s.audioListenerRotationProvider},set:function(s){let e=this._getComponent(ne.NAME_AUDIO);if(e||(e=new Lr(this),this._addComponent(e)),s&&typeof s!="function")throw new Error("The value passed to [Scene.audioListenerRotationProvider] must be a function that returns a Vector3");e.audioListenerRotationProvider=s},enumerable:!0,configurable:!0});Object.defineProperty(ze.prototype,"audioPositioningRefreshRate",{get:function(){let s=this._getComponent(ne.NAME_AUDIO);return s||(s=new Lr(this),this._addComponent(s)),s.audioPositioningRefreshRate},set:function(s){let e=this._getComponent(ne.NAME_AUDIO);e||(e=new Lr(this),this._addComponent(e)),e.audioPositioningRefreshRate=s},enumerable:!0,configurable:!0});Lr=class s{get audioEnabled(){return this._audioEnabled}get headphone(){return this._headphone}constructor(e){this.name=ne.NAME_AUDIO,this._audioEnabled=!0,this._headphone=!1,this.audioPositioningRefreshRate=500,this.audioListenerPositionProvider=null,this.audioListenerRotationProvider=null,this._cachedCameraDirection=new E,this._cachedCameraPosition=new E,this._lastCheck=0,this._invertMatrixTemp=new B,this._cameraDirectionTemp=new E,e=e||Z.LastCreatedScene,e&&(this.scene=e,e.soundTracks=[],e.sounds=[])}register(){this.scene._afterRenderStage.registerStep(ne.STEP_AFTERRENDER_AUDIO,this,this._afterRender)}rebuild(){}serialize(e){if(e.sounds=[],this.scene.soundTracks)for(let t=0;t<this.scene.soundTracks.length;t++){let i=this.scene.soundTracks[t];for(let r=0;r<i.soundCollection.length;r++)e.sounds.push(i.soundCollection[r].serialize())}}addFromContainer(e){if(e.sounds)for(let t of e.sounds)t.play(),t.autoplay=!0,this.scene.mainSoundTrack.addSound(t)}removeFromContainer(e,t=!1){if(e.sounds)for(let i of e.sounds)i.stop(),i.autoplay=!1,this.scene.mainSoundTrack.removeSound(i),t&&i.dispose()}dispose(){let e=this.scene;if(e._mainSoundTrack&&e.mainSoundTrack.dispose(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].dispose()}disableAudio(){let e=this.scene;this._audioEnabled=!1,k.audioEngine&&k.audioEngine.audioContext&&k.audioEngine.audioContext.suspend();let t;for(t=0;t<e.mainSoundTrack.soundCollection.length;t++)e.mainSoundTrack.soundCollection[t].pause();if(e.soundTracks)for(t=0;t<e.soundTracks.length;t++)for(let i=0;i<e.soundTracks[t].soundCollection.length;i++)e.soundTracks[t].soundCollection[i].pause()}enableAudio(){let e=this.scene;this._audioEnabled=!0,k.audioEngine&&k.audioEngine.audioContext&&k.audioEngine.audioContext.resume();let t;for(t=0;t<e.mainSoundTrack.soundCollection.length;t++)e.mainSoundTrack.soundCollection[t].isPaused&&e.mainSoundTrack.soundCollection[t].play();if(e.soundTracks)for(t=0;t<e.soundTracks.length;t++)for(let i=0;i<e.soundTracks[t].soundCollection.length;i++)e.soundTracks[t].soundCollection[i].isPaused&&e.soundTracks[t].soundCollection[i].play()}switchAudioModeForHeadphones(){let e=this.scene;if(this._headphone=!0,e.mainSoundTrack.switchPanningModelToHRTF(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToHRTF()}switchAudioModeForNormalSpeakers(){let e=this.scene;if(this._headphone=!1,e.mainSoundTrack.switchPanningModelToEqualPower(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToEqualPower()}_afterRender(){let e=Zt.Now;if(this._lastCheck&&e-this._lastCheck<this.audioPositioningRefreshRate)return;this._lastCheck=e;let t=this.scene;if(!this._audioEnabled||!t._mainSoundTrack||!t.soundTracks||t._mainSoundTrack.soundCollection.length===0&&t.soundTracks.length===1)return;let i=k.audioEngine;if(i&&i.audioContext){let r=t.activeCamera;if(t.activeCameras&&t.activeCameras.length>0&&(r=t.activeCameras[0]),this.audioListenerPositionProvider){let a=this.audioListenerPositionProvider();i.audioContext.listener.setPosition(a.x||0,a.y||0,a.z||0)}else r?this._cachedCameraPosition.equals(r.globalPosition)||(this._cachedCameraPosition.copyFrom(r.globalPosition),i.audioContext.listener.setPosition(r.globalPosition.x,r.globalPosition.y,r.globalPosition.z)):i.audioContext.listener.setPosition(0,0,0);if(this.audioListenerRotationProvider){let a=this.audioListenerRotationProvider();i.audioContext.listener.setOrientation(a.x||0,a.y||0,a.z||0,0,1,0)}else r?(r.rigCameras&&r.rigCameras.length>0&&(r=r.rigCameras[0]),r.getViewMatrix().invertToRef(this._invertMatrixTemp),E.TransformNormalToRef(s._CameraDirection,this._invertMatrixTemp,this._cameraDirectionTemp),this._cameraDirectionTemp.normalize(),!isNaN(this._cameraDirectionTemp.x)&&!isNaN(this._cameraDirectionTemp.y)&&!isNaN(this._cameraDirectionTemp.z)&&(this._cachedCameraDirection.equals(this._cameraDirectionTemp)||(this._cachedCameraDirection.copyFrom(this._cameraDirectionTemp),i.audioContext.listener.setOrientation(this._cameraDirectionTemp.x,this._cameraDirectionTemp.y,this._cameraDirectionTemp.z,0,1,0)))):i.audioContext.listener.setOrientation(0,0,0,0,1,0);let n;for(n=0;n<t.mainSoundTrack.soundCollection.length;n++){let a=t.mainSoundTrack.soundCollection[n];a.useCustomAttenuation&&a.updateDistanceFromListener()}if(t.soundTracks)for(n=0;n<t.soundTracks.length;n++)for(let a=0;a<t.soundTracks[n].soundCollection.length;a++){let o=t.soundTracks[n].soundCollection[a];o.useCustomAttenuation&&o.updateDistanceFromListener()}}}};Lr._CameraDirection=new E(0,0,-1);_n._SceneComponentInitialization=s=>{let e=s._getComponent(ne.NAME_AUDIO);e||(e=new Lr(s),s._addComponent(e))}});var qz={};V(qz,{MSFT_audio_emitter:()=>ex});var $T,ex,Qz=S(()=>{ie();$e();ZH();Zy();JH();Nt();mt();Kz();$T="MSFT_audio_emitter",ex=class{constructor(e){this.name=$T,this._loader=e,this.enabled=this._loader.isExtensionUsed($T)}dispose(){this._loader=null,this._clips=null,this._emitters=null}onLoading(){let e=this._loader.gltf.extensions;if(e&&e[this.name]){let t=e[this.name];this._clips=t.clips,this._emitters=t.emitters,ve.Assign(this._clips),ve.Assign(this._emitters)}}loadSceneAsync(e,t){return Pe.LoadExtensionAsync(e,t,this.name,async(i,r)=>{let n=new Array;n.push(this._loader.loadSceneAsync(e,t));for(let a of r.emitters){let o=ve.Get(`${i}/emitters`,this._emitters,a);if(o.refDistance!=null||o.maxDistance!=null||o.rolloffFactor!=null||o.distanceModel!=null||o.innerAngle!=null||o.outerAngle!=null)throw new Error(`${i}: Direction or Distance properties are not allowed on emitters attached to a scene`);n.push(this._loadEmitterAsync(`${i}/emitters/${o.index}`,o))}await Promise.all(n)})}loadNodeAsync(e,t,i){return Pe.LoadExtensionAsync(e,t,this.name,async(r,n)=>{let a=new Array,o=await this._loader.loadNodeAsync(r,t,l=>{for(let c of n.emitters){let f=ve.Get(`${r}/emitters`,this._emitters,c);a.push(this._loadEmitterAsync(`${r}/emitters/${f.index}`,f).then(()=>{for(let h of f._babylonSounds)h.attachToMesh(l),(f.innerAngle!=null||f.outerAngle!=null)&&(h.setLocalDirectionToMesh(E.Forward()),h.setDirectionalCone(2*W.ToDegrees(f.innerAngle==null?Math.PI:f.innerAngle),2*W.ToDegrees(f.outerAngle==null?Math.PI:f.outerAngle),0))}))}i(l)});return await Promise.all(a),o})}loadAnimationAsync(e,t){return Pe.LoadExtensionAsync(e,t,this.name,async(i,r)=>{let n=await this._loader.loadAnimationAsync(e,t),a=new Array;ve.Assign(r.events);for(let o of r.events)a.push(this._loadAnimationEventAsync(`${i}/events/${o.index}`,e,t,o,n));return await Promise.all(a),n})}_loadClipAsync(e,t){if(t._objectURL)return t._objectURL;let i;if(t.uri)i=this._loader.loadUriAsync(e,t,t.uri);else{let r=ve.Get(`${e}/bufferView`,this._loader.gltf.bufferViews,t.bufferView);i=this._loader.loadBufferViewAsync(`/bufferViews/${r.index}`,r)}return t._objectURL=i.then(r=>URL.createObjectURL(new Blob([r],{type:t.mimeType}))),t._objectURL}_loadEmitterAsync(e,t){if(t._babylonSounds=t._babylonSounds||[],!t._babylonData){let i=new Array,r=t.name||`emitter${t.index}`,n={loop:!1,autoplay:!1,volume:t.volume==null?1:t.volume};for(let o=0;o<t.clips.length;o++){let l=`/extensions/${this.name}/clips`,c=ve.Get(l,this._clips,t.clips[o].clip);i.push(this._loadClipAsync(`${l}/${t.clips[o].clip}`,c).then(f=>{let h=t._babylonSounds[o]=new _n(r,f,this._loader.babylonScene,null,n);h.refDistance=t.refDistance||1,h.maxDistance=t.maxDistance||256,h.rolloffFactor=t.rolloffFactor||1,h.distanceModel=t.distanceModel||"exponential"}))}let a=Promise.all(i).then(()=>{let o=t.clips.map(c=>c.weight||1),l=new fT(t.loop||!1,t._babylonSounds,o);t.innerAngle&&(l.directionalConeInnerAngle=2*W.ToDegrees(t.innerAngle)),t.outerAngle&&(l.directionalConeOuterAngle=2*W.ToDegrees(t.outerAngle)),t.volume&&(l.volume=t.volume),t._babylonData.sound=l});t._babylonData={loaded:a}}return t._babylonData.loaded}_getEventAction(e,t,i,r,n){switch(i){case"play":return a=>{let o=(n||0)+(a-r);t.play(o)};case"stop":return()=>{t.stop()};case"pause":return()=>{t.pause()};default:throw new Error(`${e}: Unsupported action ${i}`)}}_loadAnimationEventAsync(e,t,i,r,n){if(n.targetedAnimations.length==0)return Promise.resolve();let a=n.targetedAnimations[0],o=r.emitter,l=ve.Get(`/extensions/${this.name}/emitters`,this._emitters,o);return this._loadEmitterAsync(e,l).then(()=>{let c=l._babylonData.sound;if(c){let f=new cT(r.time,this._getEventAction(e,c,r.action,r.time,r.startOffset));a.animation.addEvent(f),n.onAnimationGroupEndObservable.add(()=>{c.stop()}),n.onAnimationGroupPauseObservable.add(()=>{c.pause()})}})}};Ce($T);te($T,!0,s=>new ex(s))});var jz={};V(jz,{MSFT_lod:()=>tx});var Sd,tx,Zz=S(()=>{we();Pu();Nt();mt();Sd="MSFT_lod",tx=class{constructor(e){this.name=Sd,this.order=100,this.maxLODsToLoad=10,this.onNodeLODsLoadedObservable=new N,this.onMaterialLODsLoadedObservable=new N,this._bufferLODs=new Array,this._nodeIndexLOD=null,this._nodeSignalLODs=new Array,this._nodePromiseLODs=new Array,this._nodeBufferLODs=new Array,this._materialIndexLOD=null,this._materialSignalLODs=new Array,this._materialPromiseLODs=new Array,this._materialBufferLODs=new Array,this._loader=e,this.maxLODsToLoad=this._loader.parent.extensionOptions[Sd]?.maxLODsToLoad??this.maxLODsToLoad,this.enabled=this._loader.isExtensionUsed(Sd)}dispose(){this._loader=null,this._nodeIndexLOD=null,this._nodeSignalLODs.length=0,this._nodePromiseLODs.length=0,this._nodeBufferLODs.length=0,this._materialIndexLOD=null,this._materialSignalLODs.length=0,this._materialPromiseLODs.length=0,this._materialBufferLODs.length=0,this.onMaterialLODsLoadedObservable.clear(),this.onNodeLODsLoadedObservable.clear()}onReady(){for(let e=0;e<this._nodePromiseLODs.length;e++){let t=Promise.all(this._nodePromiseLODs[e]).then(()=>{e!==0&&(this._loader.endPerformanceCounter(`Node LOD ${e}`),this._loader.log(`Loaded node LOD ${e}`)),this.onNodeLODsLoadedObservable.notifyObservers(e),e!==this._nodePromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Node LOD ${e+1}`),this._loadBufferLOD(this._nodeBufferLODs,e+1),this._nodeSignalLODs[e]&&this._nodeSignalLODs[e].resolve())});this._loader._completePromises.push(t)}for(let e=0;e<this._materialPromiseLODs.length;e++){let t=Promise.all(this._materialPromiseLODs[e]).then(()=>{e!==0&&(this._loader.endPerformanceCounter(`Material LOD ${e}`),this._loader.log(`Loaded material LOD ${e}`)),this.onMaterialLODsLoadedObservable.notifyObservers(e),e!==this._materialPromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Material LOD ${e+1}`),this._loadBufferLOD(this._materialBufferLODs,e+1),this._materialSignalLODs[e]&&this._materialSignalLODs[e].resolve())});this._loader._completePromises.push(t)}}loadSceneAsync(e,t){let i=this._loader.loadSceneAsync(e,t);return this._loadBufferLOD(this._bufferLODs,0),i}loadNodeAsync(e,t,i){return Pe.LoadExtensionAsync(e,t,this.name,async(r,n)=>{let a,o=this._getLODs(r,t,this._loader.gltf.nodes,n.ids);this._loader.logOpen(`${r}`);for(let l=0;l<o.length;l++){let c=o[l];l!==0&&(this._nodeIndexLOD=l,this._nodeSignalLODs[l]=this._nodeSignalLODs[l]||new Qr);let f=u=>{i(u),u.setEnabled(!1)},h=this._loader.loadNodeAsync(`/nodes/${c.index}`,c,f).then(u=>{if(l!==0){let d=o[l-1];d._babylonTransformNode&&(this._disposeTransformNode(d._babylonTransformNode),delete d._babylonTransformNode)}return u.setEnabled(!0),u});this._nodePromiseLODs[l]=this._nodePromiseLODs[l]||[],l===0?a=h:(this._nodeIndexLOD=null,this._nodePromiseLODs[l].push(h))}return this._loader.logClose(),await a})}_loadMaterialAsync(e,t,i,r,n){return this._nodeIndexLOD?null:Pe.LoadExtensionAsync(e,t,this.name,async(a,o)=>{let l,c=this._getLODs(a,t,this._loader.gltf.materials,o.ids);this._loader.logOpen(`${a}`);for(let f=0;f<c.length;f++){let h=c[f];f!==0&&(this._materialIndexLOD=f);let u=this._loader._loadMaterialAsync(`/materials/${h.index}`,h,i,r,d=>{f===0&&n(d)}).then(d=>{if(f!==0){n(d);let p=c[f-1]._data;p[r]&&(this._disposeMaterials([p[r].babylonMaterial]),delete p[r])}return d});this._materialPromiseLODs[f]=this._materialPromiseLODs[f]||[],f===0?l=u:(this._materialIndexLOD=null,this._materialPromiseLODs[f].push(u))}return this._loader.logClose(),await l})}_loadUriAsync(e,t,i){if(this._nodeIndexLOD!==null){this._loader.log("deferred");let r=this._nodeIndexLOD-1;return this._nodeSignalLODs[r]=this._nodeSignalLODs[r]||new Qr,this._nodeSignalLODs[this._nodeIndexLOD-1].promise.then(async()=>await this._loader.loadUriAsync(e,t,i))}else if(this._materialIndexLOD!==null){this._loader.log("deferred");let r=this._materialIndexLOD-1;return this._materialSignalLODs[r]=this._materialSignalLODs[r]||new Qr,this._materialSignalLODs[r].promise.then(async()=>await this._loader.loadUriAsync(e,t,i))}return null}loadBufferAsync(e,t,i,r){if(this._loader.parent.useRangeRequests&&!t.uri){if(!this._loader.bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);let n=async(a,o)=>{let l=i,c=l+r-1,f=a[o];return f?(f.start=Math.min(f.start,l),f.end=Math.max(f.end,c)):(f={start:l,end:c,loaded:new Qr},a[o]=f),await f.loaded.promise.then(h=>new Uint8Array(h.buffer,h.byteOffset+i-f.start,r))};return this._loader.log("deferred"),this._nodeIndexLOD!==null?n(this._nodeBufferLODs,this._nodeIndexLOD):this._materialIndexLOD!==null?n(this._materialBufferLODs,this._materialIndexLOD):n(this._bufferLODs,0)}return null}_loadBufferLOD(e,t){let i=e[t];i&&(this._loader.log(`Loading buffer range [${i.start}-${i.end}]`),this._loader.bin.readAsync(i.start,i.end-i.start+1).then(r=>{i.loaded.resolve(r)},r=>{i.loaded.reject(r)}))}_getLODs(e,t,i,r){if(this.maxLODsToLoad<=0)throw new Error("maxLODsToLoad must be greater than zero");let n=[];for(let a=r.length-1;a>=0;a--)if(n.push(ve.Get(`${e}/ids/${r[a]}`,i,r[a])),n.length===this.maxLODsToLoad)return n;return n.push(t),n}_disposeTransformNode(e){let t=[],i=e.material;i&&t.push(i);for(let n of e.getChildMeshes())n.material&&t.push(n.material);e.dispose();let r=t.filter(n=>this._loader.babylonScene.meshes.every(a=>a.material!=n));this._disposeMaterials(r)}_disposeMaterials(e){let t={};for(let i of e){for(let r of i.getActiveTextures())t[r.uniqueId]=r;i.dispose()}for(let i in t)for(let r of this._loader.babylonScene.materials)r.hasTexture(t[i])&&delete t[i];for(let i in t)t[i].dispose()}};Ce(Sd);te(Sd,!0,s=>new tx(s))});var Jz={};V(Jz,{MSFT_minecraftMesh:()=>rx});var ix,rx,$z=S(()=>{Li();Nt();mt();ix="MSFT_minecraftMesh",rx=class{constructor(e){this.name=ix,this._loader=e,this.enabled=this._loader.isExtensionUsed(ix)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Pe.LoadExtraAsync(e,t,this.name,async(r,n)=>{if(n){if(!(i instanceof J))throw new Error(`${r}: Material type not supported`);let a=this._loader.loadMaterialPropertiesAsync(e,t,i);return i.needAlphaBlending()&&(i.forceDepthWrite=!0,i.separateCullingPass=!0),i.backFaceCulling=i.forceDepthWrite,i.twoSidedLighting=!0,await a}})}};Ce(ix);te(ix,!0,s=>new rx(s))});var eX={};V(eX,{MSFT_sRGBFactors:()=>nx});var sx,nx,tX=S(()=>{Li();Nt();mt();sx="MSFT_sRGBFactors",nx=class{constructor(e){this.name=sx,this._loader=e,this.enabled=this._loader.isExtensionUsed(sx)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Pe.LoadExtraAsync(e,t,this.name,async(r,n)=>{if(n){if(!(i instanceof J))throw new Error(`${r}: Material type not supported`);let a=this._loader.loadMaterialPropertiesAsync(e,t,i),o=i.getScene().getEngine().useExactSrgbConversions;return i.albedoTexture||i.albedoColor.toLinearSpaceToRef(i.albedoColor,o),i.reflectivityTexture||i.reflectivityColor.toLinearSpaceToRef(i.reflectivityColor,o),await a}})}};Ce(sx);te(sx,!0,s=>new nx(s))});var iX={};V(iX,{KHR_node_visibility:()=>ox});var ax,ox,rX=S(()=>{mt();Za();ax="KHR_node_visibility";Jr("/nodes/{}/extensions/KHR_node_visibility/visible",{get:s=>{let e=s._babylonTransformNode;return e&&e.isVisible!==void 0?e.isVisible:!0},set:(s,e)=>{e._primitiveBabylonMeshes?.forEach(t=>{t.inheritVisibility=!0}),e._babylonTransformNode&&(e._babylonTransformNode.isVisible=s),e._primitiveBabylonMeshes?.forEach(t=>{t.isVisible=s})},getTarget:s=>s._babylonTransformNode,getPropertyName:[()=>"isVisible"],type:"boolean"});ox=class{constructor(e){this.name=ax,this._loader=e,this.enabled=e.isExtensionUsed(ax)}async onReady(){this._loader.gltf.nodes?.forEach(e=>{e._primitiveBabylonMeshes?.forEach(t=>{t.inheritVisibility=!0}),e.extensions?.KHR_node_visibility&&e.extensions?.KHR_node_visibility.visible===!1&&(e._babylonTransformNode&&(e._babylonTransformNode.isVisible=!1),e._primitiveBabylonMeshes?.forEach(t=>{t.isVisible=!1}))})}dispose(){this._loader=null}};Ce(ax);te(ax,!0,s=>new ox(s))});var aX={};V(aX,{KHR_node_hoverability:()=>lx});var ah,sX,nX,lx,oX=S(()=>{mt();EE();Za();ah="KHR_node_hoverability",sX="targetMeshPointerOver_";od("event/onHoverIn",ah,{blocks:["FlowGraphPointerOverEventBlock","FlowGraphGetVariableBlock","FlowGraphIndexOfBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],configuration:{stopPropagation:{name:"stopPropagation"},nodeIndex:{name:"variable",toBlock:"FlowGraphGetVariableBlock",dataTransformer(s){return[sX+s[0]]}}},outputs:{values:{hoverNodeIndex:{name:"index",toBlock:"FlowGraphIndexOfBlock"},controllerIndex:{name:"pointerId"}},flows:{out:{name:"done"}}},interBlockConnectors:[{input:"targetMesh",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"nodes",inputBlockIndex:2,outputBlockIndex:3,isVariable:!0},{input:"object",output:"meshUnderPointer",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0}],extraProcessor(s,e,t,i,r,n,a){let o=r[r.length-1];o.config=o.config||{},o.config.glTF=a;let l=s.configuration?.nodeIndex?.value[0];if(l===void 0||typeof l!="number")throw new Error("nodeIndex not found in configuration");let c=sX+l;return r[1].config.variable=c,n._userVariables[c]={className:"Mesh",id:a?.nodes?.[l]._babylonTransformNode?.id,uniqueId:a?.nodes?.[l]._babylonTransformNode?.uniqueId},r}});nX="targetMeshPointerOut_";od("event/onHoverOut",ah,{blocks:["FlowGraphPointerOutEventBlock","FlowGraphGetVariableBlock","FlowGraphIndexOfBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],configuration:{stopPropagation:{name:"stopPropagation"},nodeIndex:{name:"variable",toBlock:"FlowGraphGetVariableBlock",dataTransformer(s){return[nX+s[0]]}}},outputs:{values:{hoverNodeIndex:{name:"index",toBlock:"FlowGraphIndexOfBlock"},controllerIndex:{name:"pointerId"}},flows:{out:{name:"done"}}},interBlockConnectors:[{input:"targetMesh",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"nodes",inputBlockIndex:2,outputBlockIndex:3,isVariable:!0},{input:"object",output:"meshOutOfPointer",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0}],extraProcessor(s,e,t,i,r,n,a){let o=r[r.length-1];o.config=o.config||{},o.config.glTF=a;let l=s.configuration?.nodeIndex?.value[0];if(l===void 0||typeof l!="number")throw new Error("nodeIndex not found in configuration");let c=nX+l;return r[1].config.variable=c,n._userVariables[c]={className:"Mesh",id:a?.nodes?.[l]._babylonTransformNode?.id,uniqueId:a?.nodes?.[l]._babylonTransformNode?.uniqueId},r}});Jr("/nodes/{}/extensions/KHR_node_hoverability/hoverable",{get:s=>{let e=s._babylonTransformNode;return e&&e.pointerOverDisableMeshTesting!==void 0?e.pointerOverDisableMeshTesting:!0},set:(s,e)=>{e._primitiveBabylonMeshes?.forEach(t=>{t.pointerOverDisableMeshTesting=!s})},getTarget:s=>s._babylonTransformNode,getPropertyName:[()=>"pointerOverDisableMeshTesting"],type:"boolean"});lx=class{constructor(e){this.name=ah,this._loader=e,this.enabled=e.isExtensionUsed(ah)}async onReady(){this._loader.gltf.nodes?.forEach(e=>{e.extensions?.KHR_node_hoverability&&e.extensions?.KHR_node_hoverability.hoverable===!1&&e._babylonTransformNode?.getChildMeshes().forEach(t=>{t.pointerOverDisableMeshTesting=!0})})}dispose(){this._loader=null}};Ce(ah);te(ah,!0,s=>new lx(s))});var lX={};V(lX,{KHR_node_selectability:()=>cx});var Ed,cx,cX=S(()=>{mt();EE();Za();Ed="KHR_node_selectability";od("event/onSelect",Ed,{blocks:["FlowGraphMeshPickEventBlock","FlowGraphGetVariableBlock","FlowGraphIndexOfBlock","KHR_interactivity/FlowGraphGLTFDataProvider"],configuration:{stopPropagation:{name:"stopPropagation"},nodeIndex:{name:"variable",toBlock:"FlowGraphGetVariableBlock",dataTransformer(s){return["pickedMesh_"+s[0]]}}},outputs:{values:{selectedNodeIndex:{name:"index",toBlock:"FlowGraphIndexOfBlock"},controllerIndex:{name:"pointerId"},selectionPoint:{name:"pickedPoint"},selectionRayOrigin:{name:"pickOrigin"}},flows:{out:{name:"done"}}},interBlockConnectors:[{input:"asset",output:"value",inputBlockIndex:0,outputBlockIndex:1,isVariable:!0},{input:"array",output:"nodes",inputBlockIndex:2,outputBlockIndex:3,isVariable:!0},{input:"object",output:"pickedMesh",inputBlockIndex:2,outputBlockIndex:0,isVariable:!0}],extraProcessor(s,e,t,i,r,n,a){let o=r[r.length-1];o.config=o.config||{},o.config.glTF=a;let l=s.configuration?.nodeIndex?.value[0];if(l===void 0||typeof l!="number")throw new Error("nodeIndex not found in configuration");let c="pickedMesh_"+l;return r[1].config.variable=c,n._userVariables[c]={className:"Mesh",id:a?.nodes?.[l]._babylonTransformNode?.id,uniqueId:a?.nodes?.[l]._babylonTransformNode?.uniqueId},r}});Jr("/nodes/{}/extensions/KHR_node_selectability/selectable",{get:s=>{let e=s._babylonTransformNode;return e&&e.isPickable!==void 0?e.isPickable:!0},set:(s,e)=>{e._primitiveBabylonMeshes?.forEach(t=>{t.isPickable=s})},getTarget:s=>s._babylonTransformNode,getPropertyName:[()=>"isPickable"],type:"boolean"});cx=class{constructor(e){this.name=Ed,this._loader=e,this.enabled=e.isExtensionUsed(Ed)}async onReady(){this._loader.gltf.nodes?.forEach(e=>{e.extensions?.KHR_node_selectability&&e.extensions?.KHR_node_selectability.selectable===!1&&e._babylonTransformNode?.getChildMeshes().forEach(t=>{t.isPickable=!1})})}dispose(){this._loader=null}};Ce(Ed);te(Ed,!0,s=>new cx(s))});function gX(){return{name:"",type:"",offset:new E,channels:[],children:[],frames:[],parent:null}}function Zte(){return{frame:0,position:new E,rotation:new K}}function Jte(s){let e=s.offset.x,t=s.offset.y,i=s.offset.z;return B.Translation(e,t,i)}function $te(s,e){if(s.frames.length===0)return[];let t=[],i=s.channels.some(c=>c===hX||c===uX||c===dX),r=s.channels.some(c=>c===pX||c===mX||c===_X),n=new q(`${s.name}_pos`,"position",e.frameRate,q.ANIMATIONTYPE_VECTOR3,e.loopMode),a=new q(`${s.name}_rot`,"rotationQuaternion",e.frameRate,q.ANIMATIONTYPE_QUATERNION,e.loopMode),o=[],l=[];for(let c=0;c<s.frames.length;c++){let f=s.frames[c];i&&f.position&&o.push({frame:f.frame,value:f.position.clone()}),r&&l.push({frame:f.frame,value:f.rotation.clone()})}return o.length>0&&(n.setKeys(o),t.push(n)),l.length>0&&(a.setKeys(l),t.push(a)),t}function vX(s,e,t){let i=Jte(s),r=new Zr(s.name,t.skeleton,e,i),n=$te(s,t);for(let a of n)a.getKeys()&&a.getKeys().length>0&&r.animations.push(a);for(let a of s.children)vX(a,r,t)}function SX(s,e,t,i){if(t.type==="ENDSITE")return;let r=Zte();r.frame=e,r.position=new E,r.rotation=new K,t.frames.push(r);let n=B.Identity();for(let a=0;a<t.channels.length;++a){let o=t.channels[a],l=s[i.i++];if(!l)continue;let c=parseFloat(l.trim());if(o.endsWith("position"))switch(o){case hX:r.position.x=c;break;case uX:r.position.y=c;break;case dX:r.position.z=c;break}else if(o.endsWith("rotation")){let f=W.ToRadians(c),h;switch(o){case pX:h=B.RotationX(f);break;case mX:h=B.RotationY(f);break;case _X:h=B.RotationZ(f);break}n=h.multiply(n)}}K.FromRotationMatrixToRef(n,r.rotation);for(let a of t.children)SX(s,e,a,i)}function EX(s,e,t,i){let r=gX();r.parent=t,i.list.push(r);let n=e.trim().split(/\s+/);if(n[0].toUpperCase()==="END"&&n[1].toUpperCase()==="SITE"?(r.type="ENDSITE",r.name="ENDSITE"):(r.name=n[1],r.type=n[0].toUpperCase()),s.shift()?.trim()!="{")throw new Error("Expected opening { after type & name");let a=s.shift()?.trim().split(/\s+/);if(!a)throw new Error("Unexpected end of file: missing OFFSET");if(n=a,n[0].toUpperCase()!="OFFSET")throw new Error("Expected OFFSET, but got: "+n[0]);if(n.length!=4)throw new Error("OFFSET: Invalid number of values");let o=new E(parseFloat(n[1]),parseFloat(n[2]),parseFloat(n[3]));if(isNaN(o.x)||isNaN(o.y)||isNaN(o.z))throw new Error("OFFSET: Invalid values");if(r.offset=o,r.type!="ENDSITE"){if(n=s.shift()?.trim().split(/\s+/),!n)throw new Error("Unexpected end of file: missing CHANNELS");if(n[0].toUpperCase()!="CHANNELS")throw new Error("Expected CHANNELS definition");let l=parseInt(n[1]);r.channels=n.splice(2,l),r.children=[]}for(;s.length>0;){let l=s.shift()?.trim();if(l==="}")return r;l&&r.children.push(EX(s,l,r,i))}throw new Error("Unexpected end of file: missing closing brace")}function O0(s,e,t,i){let r=s.split(`
`),{loopMode:n}=i;e._blockEntityCollection=!!t;let a=new Uf("","",e);a._parentContainer=t,e._blockEntityCollection=!1;let o=new D0(a);o.loopMode=n;let l=r.shift();if(!l||l.trim().toUpperCase()!==Qte)throw new Error("HIERARCHY expected");let c=r.shift();if(!c)throw new Error("Unexpected end of file after HIERARCHY");let f=EX(r,c.trim(),null,o),h=r.shift();if(!h||h.trim().toUpperCase()!==jte)throw new Error("MOTION expected");let u=r.shift();if(!u)throw new Error("Unexpected end of file before frame count");let d=u.trim().split(/[\s]+/);if(d.length<2)throw new Error("Invalid frame count line");let p=parseInt(d[1]);if(isNaN(p))throw new Error("Failed to read number of frames.");o.numFrames=p;let m=r.shift();if(!m)throw new Error("Unexpected end of file before frame time");let _=m.trim().split(/[\s]+/);if(_.length<3)throw new Error("Invalid frame time line");let v=parseFloat(_[2]);if(isNaN(v))throw new Error("Failed to read frame time.");if(v<=0)throw new Error("Failed to read frame time. Invalid value "+v);o.frameRate=1/v;for(let T=0;T<p;++T){let C=r.shift();if(!C)continue;let I=C.trim().split(/[\s]+/)||[];SX(I,T,f,{i:0})}return o.root=f,vX(o.root,null,o),o.skeleton.returnToRest(),o.skeleton}var hX,uX,dX,pX,mX,_X,Qte,jte,D0,TX=S(()=>{ws();ku();ey();ie();$e();hX="Xposition",uX="Yposition",dX="Zposition",pX="Xrotation",mX="Yrotation",_X="Zrotation",Qte="HIERARCHY",jte="MOTION",D0=class{constructor(e){this.loopMode=q.ANIMATIONLOOPMODE_CYCLE,this.list=[],this.root=gX(),this.numFrames=0,this.frameRate=0,this.skeleton=e}}});var xX={};V(xX,{BVHFileLoader:()=>fx});var fx,AX=S(()=>{Qo();Gf();ws();KI();TX();fx=class s{constructor(e){this.name=Gl.name,this.extensions=Gl.extensions,this._loadingOptions={...s._DefaultLoadingOptions,...e??{}}}static get _DefaultLoadingOptions(){return{loopMode:q.ANIMATIONLOOPMODE_CYCLE}}createPlugin(e){return new s(e[Gl.name])}canDirectLoad(e){return this.isBvhHeader(e)}isBvhHeader(e){return e.split(`
`)[0]=="HIERARCHY"}isNotBvhHeader(e){return!this.isBvhHeader(e)}importMeshAsync(e,t,i){if(typeof i!="string")return Promise.reject("BVH loader expects string data.");if(this.isNotBvhHeader(i))return Promise.reject("BVH loader expects HIERARCHY header.");try{let r=O0(i,t,null,this._loadingOptions);return Promise.resolve({meshes:[],particleSystems:[],skeletons:[r],animationGroups:[],transformNodes:[],geometries:[],lights:[],spriteManagers:[]})}catch(r){return Promise.reject(r)}}loadAsync(e,t){return typeof t!="string"?Promise.reject("BVH loader expects string data."):this.isNotBvhHeader(t)?Promise.reject("BVH loader expects HIERARCHY header."):this.importMeshAsync(null,e,t).then(()=>{})}loadAssetContainerAsync(e,t){if(typeof t!="string")return Promise.reject("BVH loader expects string data.");if(this.isNotBvhHeader(t))return Promise.reject("BVH loader expects HIERARCHY header.");let i=new Bs(e);try{let r=O0(t,e,i,this._loadingOptions);return i.skeletons.push(r),Promise.resolve(i)}catch(r){return Promise.reject(r)}}};$i(new fx)});var RX,eie,L0=S(()=>{O();wo();rf();RX="defaultUboDeclaration",eie=`uniform diffuseLeftColor: vec4f;uniform diffuseRightColor: vec4f;uniform opacityParts: vec4f;uniform reflectionLeftColor: vec4f;uniform reflectionRightColor: vec4f;uniform refractionLeftColor: vec4f;uniform refractionRightColor: vec4f;uniform emissiveLeftColor: vec4f;uniform emissiveRightColor: vec4f;uniform vDiffuseInfos: vec2f;uniform vAmbientInfos: vec2f;uniform vOpacityInfos: vec2f;uniform vReflectionInfos: vec2f;uniform vReflectionPosition: vec3f;uniform vReflectionSize: vec3f;uniform vEmissiveInfos: vec2f;uniform vLightmapInfos: vec2f;uniform vSpecularInfos: vec2f;uniform vBumpInfos: vec3f;uniform diffuseMatrix: mat4x4f;uniform ambientMatrix: mat4x4f;uniform opacityMatrix: mat4x4f;uniform reflectionMatrix: mat4x4f;uniform emissiveMatrix: mat4x4f;uniform lightmapMatrix: mat4x4f;uniform specularMatrix: mat4x4f;uniform bumpMatrix: mat4x4f;uniform vTangentSpaceParams: vec2f;uniform pointSize: f32;uniform alphaCutOff: f32;uniform refractionMatrix: mat4x4f;uniform vRefractionInfos: vec4f;uniform vRefractionPosition: vec3f;uniform vRefractionSize: vec3f;uniform vSpecularColor: vec4f;uniform vEmissiveColor: vec3f;uniform vDiffuseColor: vec4f;uniform vAmbientColor: vec3f;uniform cameraInfo: vec4f;
#define ADDITIONAL_UBO_DECLARATION
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;g.IncludesShadersStoreWGSL[RX]||(g.IncludesShadersStoreWGSL[RX]=eie)});var bX,tie,CX=S(()=>{O();bX="lightVxFragmentDeclaration",tie=`#ifdef LIGHT{X}
uniform vLightData{X}: vec4f;uniform vLightDiffuse{X}: vec4f;
#ifdef SPECULARTERM
uniform vLightSpecular{X}: vec4f;
#else
var vLightSpecular{X}: vec4f= vec4f(0.);
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform lightMatrix{X}: mat4x4f[SHADOWCSMNUM_CASCADES{X}];varying var vPositionFromLight{X}: vec4f[SHADOWCSMNUM_CASCADES{X}];varying var vDepthMetric{X}: f32[SHADOWCSMNUM_CASCADES{X}];varying var vPositionFromCamera{X}: vec4f;
#elif defined(SHADOWCUBE{X})
#else
varying var vPositionFromLight{X}: vec4f;varying var vDepthMetric{X}: f32;uniform lightMatrix{X}: mat4x4f;
#endif
uniform shadowsInfo{X}: vec4f;uniform depthValues{X}: vec2f;
#endif
#ifdef SPOTLIGHT{X}
uniform vLightDirection{X}: vec4f;uniform vLightFalloff{X}: vec4f;
#elif defined(POINTLIGHT{X})
uniform vLightFalloff{X}: vec4f;
#elif defined(HEMILIGHT{X})
uniform vLightGround{X}: vec3f;
#endif
#if defined(AREALIGHT{X})
uniform vLightWidth{X}: vec4f;uniform vLightHeight{X}: vec4f;
#endif
#endif
`;g.IncludesShadersStoreWGSL[bX]||(g.IncludesShadersStoreWGSL[bX]=tie)});var yX={};V(yX,{defaultVertexShaderWGSL:()=>iie});var w0,IX,iie,MX=S(()=>{O();L0();eI();Pi();Ia();Bn();Va();tI();Au();iI();sI();ya();hu();CX();g_();Oo();Lo();za();Fo();No();Un();Ma();Gn();nI();aI();oI();B_();Pa();uu();v_();lI();du();w0="defaultVertexShader",IX=`#include<defaultUboDeclaration>
#define CUSTOM_VERTEX_BEGIN
attribute position: vec3f;
#ifdef NORMAL
attribute normal: vec3f;
#endif
#ifdef TANGENT
attribute tangent: vec4f;
#endif
#ifdef UV1
attribute uv: vec2f;
#endif
#include<uvAttributeDeclaration>[2..7]
#ifdef VERTEXCOLOR
attribute color: vec4f;
#endif
#include<helperFunctions>
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<prePassVertexDeclaration>
#include<mainUVVaryingDeclaration>[1..7]
#include<samplerVertexDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse)
#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)
#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)
#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)
#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)
#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)
#if defined(SPECULARTERM)
#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular)
#endif
#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)
#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)
varying vPositionW: vec3f;
#ifdef NORMAL
varying vNormalW: vec3f;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vColor: vec4f;
#endif
#include<bumpVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vPositionUVW: vec3f;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vDirectionW: vec3f;
#endif
#ifdef CLUSTLIGHT_BATCH
varying vViewDepth: f32;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
var positionUpdated: vec3f=vertexInputs.position;
#ifdef NORMAL
var normalUpdated: vec3f=vertexInputs.normal;
#endif
#ifdef TANGENT
var tangentUpdated: vec4f=vertexInputs.tangent;
#endif
#ifdef UV1
var uvUpdated: vec2f=vertexInputs.uv;
#endif
#ifdef UV2
var uv2Updated: vec2f=vertexInputs.uv2;
#endif
#ifdef VERTEXCOLOR
var colorUpdated: vec4f=vertexInputs.color;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vertexOutputs.vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && ((defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)
vertexOutputs.vCurrentPosition=scene.viewProjection*finalWorld*vec4f(positionUpdated,1.0);vertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld*vec4f(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
var worldPos: vec4f=finalWorld*vec4f(positionUpdated,1.0);
#ifdef NORMAL
var normalWorld: mat3x3f= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vertexOutputs.vNormalW=normalUpdated/ vec3f(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vertexOutputs.vNormalW=normalize(normalWorld*vertexOutputs.vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vertexOutputs.vNormalW=normalize(normalWorld*normalUpdated);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {vertexOutputs.position=scene.viewProjection*worldPos;} else {vertexOutputs.position=scene.viewProjectionR*worldPos;}
#else
vertexOutputs.position=scene.viewProjection*worldPos;
#endif
vertexOutputs.vPositionW= worldPos.xyz;
#ifdef PREPASS
#include<prePassVertex>
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vertexOutputs.vDirectionW=normalize((finalWorld* vec4f(positionUpdated,0.0)).xyz);
#endif
#ifdef CLUSTLIGHT_BATCH
vertexOutputs.vViewDepth=(scene.view*worldPos).z;
#endif
#ifndef UV1
var uvUpdated: vec2f=vec2f(0.,0.);
#endif
#ifdef MAINUV1
vertexOutputs.vMainUV1=uvUpdated;
#endif
#ifndef UV2
var uv2Updated: vec2f=vec2f(0.,0.);
#endif
#ifdef MAINUV2
vertexOutputs.vMainUV2=uv2Updated;
#endif
#include<uvVariableDeclaration>[3..7]
#include<samplerVertexImplementation>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_MATRIXNAME_,diffuse,_INFONAME_,DiffuseInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)
#if defined(SPECULARTERM)
#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_MATRIXNAME_,specular,_INFONAME_,SpecularInfos.x)
#endif
#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)
#include<bumpVertex>
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#include<vertexColorMixing>
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}
`;g.ShadersStoreWGSL[w0]||(g.ShadersStoreWGSL[w0]=IX);iie={name:w0,shader:IX}});var PX,rie,F0=S(()=>{O();PX="fresnelFunction",rie=`#ifdef FRESNEL
fn computeFresnelTerm(viewDirection: vec3f,worldNormal: vec3f,bias: f32,power: f32)->f32
{let fresnelTerm: f32=pow(bias+abs(dot(viewDirection,worldNormal)),power);return clamp(fresnelTerm,0.,1.);}
#endif
`;g.IncludesShadersStoreWGSL[PX]||(g.IncludesShadersStoreWGSL[PX]=rie)});var OX={};V(OX,{defaultPixelShaderWGSL:()=>sie});var N0,DX,sie,LX=S(()=>{O();L0();fI();hI();Au();Pi();T_();wC();x_();U_();F0();S_();E_();A_();G_();V_();ba();za();pu();Ca();W_();k_();dI();R_();mu();_u();pI();N0="defaultPixelShader",DX=`#include<defaultUboDeclaration>
#include<prePassDeclaration>[SCENE_MRT_COUNT]
#include<oitDeclaration>
#define CUSTOM_FRAGMENT_BEGIN
varying vPositionW: vec3f;
#ifdef NORMAL
varying vNormalW: vec3f;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vColor: vec4f;
#endif
#ifdef CLUSTLIGHT_BATCH
varying vViewDepth: f32;
#endif
#include<mainUVVaryingDeclaration>[1..7]
#include<helperFunctions>
#include<lightUboDeclaration>[0..maxSimultaneousLights]
#include<lightsFragmentFunctions>
#include<shadowsFragmentFunctions>
#include<samplerFragmentDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_SAMPLERNAME_,diffuse)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)
#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)
#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)
#ifdef REFRACTION
#ifdef REFRACTIONMAP_3D
var refractionCubeSamplerSampler: sampler;var refractionCubeSampler: texture_cube<f32>;
#else
var refraction2DSamplerSampler: sampler;var refraction2DSampler: texture_2d<f32>;
#endif
#endif
#if defined(SPECULARTERM)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_SAMPLERNAME_,specular)
#endif
#include<fresnelFunction>
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
var reflectionCubeSamplerSampler: sampler;var reflectionCubeSampler: texture_cube<f32>;
#else
var reflection2DSamplerSampler: sampler;var reflection2DSampler: texture_2d<f32>;
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vPositionUVW: vec3f;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vDirectionW: vec3f;
#endif
#endif
#include<reflectionFunction>
#endif
#include<imageProcessingDeclaration>
#include<imageProcessingFunctions>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
var viewDirectionW: vec3f=normalize(scene.vEyePosition.xyz-fragmentInputs.vPositionW);var baseColor: vec4f= vec4f(1.,1.,1.,1.);var diffuseColor: vec3f=uniforms.vDiffuseColor.rgb;var alpha: f32=uniforms.vDiffuseColor.a;
#ifdef NORMAL
var normalW: vec3f=normalize(fragmentInputs.vNormalW);
#else
var normalW: vec3f=normalize(-cross(dpdx(fragmentInputs.vPositionW),dpdy(fragmentInputs.vPositionW)));
#endif
#include<bumpFragment>
#ifdef TWOSIDEDLIGHTING
normalW=select(-normalW,normalW,fragmentInputs.frontFacing);
#endif
#ifdef DIFFUSE
baseColor=textureSample(diffuseSampler,diffuseSamplerSampler,fragmentInputs.vDiffuseUV+uvOffset);
#if defined(ALPHATEST) && !defined(ALPHATEST_AFTERALLALPHACOMPUTATIONS)
if (baseColor.a<uniforms.alphaCutOff) {discard;}
#endif
#ifdef ALPHAFROMDIFFUSE
alpha*=baseColor.a;
#endif
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
baseColor=vec4f(baseColor.rgb*uniforms.vDiffuseInfos.y,baseColor.a);
#endif
#if defined(DECAL) && !defined(DECAL_AFTER_DETAIL)
var decalColor: vec4f=textureSample(decalSampler,decalSamplerSampler,fragmentInputs.vDecalUV+uvOffset);
#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)
#endif
#include<depthPrePass>
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
baseColor=vec4f(baseColor.rgb*fragmentInputs.vColor.rgb,baseColor.a);
#endif
#ifdef DETAIL
baseColor=vec4f(baseColor.rgb*2.0*mix(0.5,detailColor.r,uniforms.vDetailInfos.y),baseColor.a);
#endif
#if defined(DECAL) && defined(DECAL_AFTER_DETAIL)
var decalColor: vec4f=textureSample(decalSampler,decalSamplerSampler,fragmentInputs.vDecalUV+uvOffset);
#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)
#endif
#define CUSTOM_FRAGMENT_UPDATE_DIFFUSE
var baseAmbientColor: vec3f= vec3f(1.,1.,1.);
#ifdef AMBIENT
baseAmbientColor=textureSample(ambientSampler,ambientSamplerSampler,fragmentInputs.vAmbientUV+uvOffset).rgb*uniforms.vAmbientInfos.y;
#endif
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS
var glossiness: f32=uniforms.vSpecularColor.a;var specularColor: vec3f=uniforms.vSpecularColor.rgb;
#ifdef SPECULARTERM
#ifdef SPECULAR
var specularMapColor: vec4f=textureSample(specularSampler,specularSamplerSampler,fragmentInputs.vSpecularUV+uvOffset);specularColor=specularMapColor.rgb;
#ifdef GLOSSINESS
glossiness=glossiness*specularMapColor.a;
#endif
#endif
#endif
var diffuseBase: vec3f= vec3f(0.,0.,0.);var info: lightingInfo;
#ifdef SPECULARTERM
var specularBase: vec3f= vec3f(0.,0.,0.);
#endif
var shadow: f32=1.;var aggShadow: f32=0.;var numLights: f32=0.;
#ifdef LIGHTMAP
var lightmapColor: vec4f=textureSample(lightmapSampler,lightmapSamplerSampler,fragmentInputs.vLightmapUV+uvOffset);
#ifdef RGBDLIGHTMAP
lightmapColor=vec4f(fromRGBD(lightmapColor),lightmapColor.a);
#endif
lightmapColor=vec4f(lightmapColor.rgb*uniforms.vLightmapInfos.y,lightmapColor.a);
#endif
#include<lightFragment>[0..maxSimultaneousLights]
aggShadow=aggShadow/numLights;var refractionColor: vec4f= vec4f(0.,0.,0.,1.);
#ifdef REFRACTION
var refractionVector: vec3f=normalize(refract(-viewDirectionW,normalW,uniforms.vRefractionInfos.y));
#ifdef REFRACTIONMAP_3D
#ifdef USE_LOCAL_REFRACTIONMAP_CUBIC
refractionVector=parallaxCorrectNormal(fragmentInputs.vPositionW,refractionVector,uniforms.vRefractionSize,uniforms.vRefractionPosition);
#endif
refractionVector.y=refractionVector.y*uniforms.vRefractionInfos.w;var refractionLookup: vec4f=textureSample(refractionCubeSampler,refractionCubeSamplerSampler,refractionVector);if (dot(refractionVector,viewDirectionW)<1.0) {refractionColor=refractionLookup;}
#else
var vRefractionUVW: vec3f= (uniforms.refractionMatrix*(scene.view* vec4f(fragmentInputs.vPositionW+refractionVector*uniforms.vRefractionInfos.z,1.0))).xyz;var refractionCoords: vec2f=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;refractionColor=textureSample(refraction2DSampler,refraction2DSamplerSampler,refractionCoords);
#endif
#ifdef RGBDREFRACTION
refractionColor=vec4f(fromRGBD(refractionColor),refractionColor.a);
#endif
#ifdef IS_REFRACTION_LINEAR
refractionColor=vec4f(toGammaSpaceVec3(refractionColor.rgb),refractionColor.a);
#endif
refractionColor=vec4f(refractionColor.rgb*uniforms.vRefractionInfos.x,refractionColor.a);
#endif
var reflectionColor: vec4f= vec4f(0.,0.,0.,1.);
#ifdef REFLECTION
var vReflectionUVW: vec3f=computeReflectionCoords( vec4f(fragmentInputs.vPositionW,1.0),normalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
vReflectionUVW=vec3f(vReflectionUVW.x,vReflectionUVW.y,vReflectionUVW.z*-1.0);
#endif
#ifdef REFLECTIONMAP_3D
#ifdef ROUGHNESS
var bias: f32=uniforms.vReflectionInfos.y;
#ifdef SPECULARTERM
#ifdef SPECULAR
#ifdef GLOSSINESS
bias*=(1.0-specularMapColor.a);
#endif
#endif
#endif
reflectionColor=textureSampleLevel(reflectionCubeSampler,reflectionCubeSamplerSampler,vReflectionUVW,bias);
#else
reflectionColor=textureSample(reflectionCubeSampler,reflectionCubeSamplerSampler,vReflectionUVW);
#endif
#else
var coords: vec2f=vReflectionUVW.xy;
#ifdef REFLECTIONMAP_PROJECTION
coords/=vReflectionUVW.z;
#endif
coords.y=1.0-coords.y;reflectionColor=textureSample(reflection2DSampler,reflection2DSamplerSampler,coords);
#endif
#ifdef RGBDREFLECTION
reflectionColor=vec4f(fromRGBD(reflectionColor),reflectionColor.a);
#endif
#ifdef IS_REFLECTION_LINEAR
reflectionColor=vec4f(toGammaSpaceVec3(reflectionColor.rgb),reflectionColor.a);
#endif
reflectionColor=vec4f(reflectionColor.rgb*uniforms.vReflectionInfos.x,reflectionColor.a);
#ifdef REFLECTIONFRESNEL
var reflectionFresnelTerm: f32=computeFresnelTerm(viewDirectionW,normalW,uniforms.reflectionRightColor.a,uniforms.reflectionLeftColor.a);
#ifdef REFLECTIONFRESNELFROMSPECULAR
#ifdef SPECULARTERM
reflectionColor=vec4f(reflectionColor.rgb*specularColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*uniforms.reflectionRightColor.rgb,reflectionColor.a);
#else
reflectionColor=vec4f(reflectionColor.rgb*uniforms.reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*uniforms.reflectionRightColor.rgb,reflectionColor.a);
#endif
#else
reflectionColor=vec4f(reflectionColor.rgb*uniforms.reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*uniforms.reflectionRightColor.rgb,reflectionColor.a);
#endif
#endif
#endif
#ifdef REFRACTIONFRESNEL
var refractionFresnelTerm: f32=computeFresnelTerm(viewDirectionW,normalW,uniforms.refractionRightColor.a,uniforms.refractionLeftColor.a);refractionColor=vec4f(refractionColor.rgb*uniforms.refractionLeftColor.rgb*(1.0-refractionFresnelTerm)+refractionFresnelTerm*uniforms.refractionRightColor.rgb,refractionColor.a);
#endif
#ifdef OPACITY
var opacityMap: vec4f=textureSample(opacitySampler,opacitySamplerSampler,fragmentInputs.vOpacityUV+uvOffset);
#ifdef OPACITYRGB
opacityMap=vec4f(opacityMap.rgb* vec3f(0.3,0.59,0.11),opacityMap.a);alpha*=(opacityMap.x+opacityMap.y+opacityMap.z)* uniforms.vOpacityInfos.y;
#else
alpha*=opacityMap.a*uniforms.vOpacityInfos.y;
#endif
#endif
#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)
alpha*=fragmentInputs.vColor.a;
#endif
#ifdef OPACITYFRESNEL
var opacityFresnelTerm: f32=computeFresnelTerm(viewDirectionW,normalW,uniforms.opacityParts.z,uniforms.opacityParts.w);alpha+=uniforms.opacityParts.x*(1.0-opacityFresnelTerm)+opacityFresnelTerm*uniforms.opacityParts.y;
#endif
#ifdef ALPHATEST
#ifdef ALPHATEST_AFTERALLALPHACOMPUTATIONS
if (alpha<uniforms.alphaCutOff) {discard;}
#endif
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
var emissiveColor: vec3f=uniforms.vEmissiveColor;
#ifdef EMISSIVE
emissiveColor+=textureSample(emissiveSampler,emissiveSamplerSampler,fragmentInputs.vEmissiveUV+uvOffset).rgb*uniforms.vEmissiveInfos.y;
#endif
#ifdef EMISSIVEFRESNEL
var emissiveFresnelTerm: f32=computeFresnelTerm(viewDirectionW,normalW,uniforms.emissiveRightColor.a,uniforms.emissiveLeftColor.a);emissiveColor*=uniforms.emissiveLeftColor.rgb*(1.0-emissiveFresnelTerm)+emissiveFresnelTerm*uniforms.emissiveRightColor.rgb;
#endif
#ifdef DIFFUSEFRESNEL
var diffuseFresnelTerm: f32=computeFresnelTerm(viewDirectionW,normalW,uniforms.diffuseRightColor.a,uniforms.diffuseLeftColor.a);diffuseBase*=uniforms.diffuseLeftColor.rgb*(1.0-diffuseFresnelTerm)+diffuseFresnelTerm*uniforms.diffuseRightColor.rgb;
#endif
#ifdef EMISSIVEASILLUMINATION
var finalDiffuse: vec3f=clamp(diffuseBase*diffuseColor+uniforms.vAmbientColor,vec3f(0.0),vec3f(1.0))*baseColor.rgb;
#else
#ifdef LINKEMISSIVEWITHDIFFUSE
var finalDiffuse: vec3f=clamp((diffuseBase+emissiveColor)*diffuseColor+uniforms.vAmbientColor,vec3f(0.0),vec3f(1.0))*baseColor.rgb;
#else
var finalDiffuse: vec3f=clamp(diffuseBase*diffuseColor+emissiveColor+uniforms.vAmbientColor,vec3f(0.0),vec3f(1.0))*baseColor.rgb;
#endif
#endif
#ifdef SPECULARTERM
var finalSpecular: vec3f=specularBase*specularColor;
#ifdef SPECULAROVERALPHA
alpha=clamp(alpha+dot(finalSpecular, vec3f(0.3,0.59,0.11)),0.0,1.0);
#endif
#else
var finalSpecular: vec3f= vec3f(0.0);
#endif
#ifdef REFLECTIONOVERALPHA
alpha=clamp(alpha+dot(reflectionColor.rgb, vec3f(0.3,0.59,0.11)),0.0,1.0);
#endif
#ifdef EMISSIVEASILLUMINATION
var color: vec4f= vec4f(clamp(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+emissiveColor+refractionColor.rgb,0.0,1.0),alpha);
#else
var color: vec4f= vec4f(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+refractionColor.rgb,alpha);
#endif
#ifdef LIGHTMAP
#ifndef LIGHTMAPEXCLUDED
#ifdef USELIGHTMAPASSHADOWMAP
color=vec4f(color.rgb*lightmapColor.rgb,color.a);
#else
color=vec4f(color.rgb+lightmapColor.rgb,color.a);
#endif
#endif
#endif
#define CUSTOM_FRAGMENT_BEFORE_FOG
color=vec4f(max(color.rgb,vec3f(0.)),color.a);
#include<logDepthFragment>
#include<fogFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS
color=vec4f(toLinearSpaceVec3(color.rgb),color.a);
#else
#ifdef IMAGEPROCESSING
color=vec4f(toLinearSpaceVec3(color.rgb),color.a);color=applyImageProcessing(color);
#endif
#endif
color=vec4f(color.rgb,color.a*mesh.visibility);
#ifdef PREMULTIPLYALPHA
color=vec4f(color.rgb*color.a, color.a);
#endif
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
#if SCENE_MRT_COUNT>0
var writeGeometryInfo: f32=select(0.0,1.0,color.a>0.4);var fragData: array<vec4<f32>,SCENE_MRT_COUNT>;
#ifdef PREPASS_COLOR
fragData[PREPASS_COLOR_INDEX]=color; 
#endif
#ifdef PREPASS_POSITION
fragData[PREPASS_POSITION_INDEX]=vec4f(fragmentInputs.vPositionW,writeGeometryInfo);
#endif
#ifdef PREPASS_LOCAL_POSITION
fragData[PREPASS_LOCAL_POSITION_INDEX]=vec4f(fragmentInputs.vPosition,writeGeometryInfo);
#endif
#ifdef PREPASS_VELOCITY
var a: vec2f=(fragmentInputs.vCurrentPosition.xy/fragmentInputs.vCurrentPosition.w)*0.5+0.5;var b: vec2f=(fragmentInputs.vPreviousPosition.xy/fragmentInputs.vPreviousPosition.w)*0.5+0.5;var velocity: vec2f=abs(a-b);velocity= vec2f(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;fragData[PREPASS_VELOCITY_INDEX]= vec4f(velocity,0.0,writeGeometryInfo);
#elif defined(PREPASS_VELOCITY_LINEAR)
var velocity : vec2f=vec2f(0.5)*((fragmentInputs.vPreviousPosition.xy/fragmentInputs.vPreviousPosition.w) -
(fragmentInputs.vCurrentPosition.xy/fragmentInputs.vCurrentPosition.w));fragData[PREPASS_VELOCITY_LINEAR_INDEX]=vec4f(velocity,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_IRRADIANCE
fragData[PREPASS_IRRADIANCE_INDEX]=vec4f(0.0,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_DEPTH
fragData[PREPASS_DEPTH_INDEX]=vec4f(fragmentInputs.vViewPos.z,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_SCREENSPACE_DEPTH
fragData[PREPASS_SCREENSPACE_DEPTH_INDEX]=vec4f(fragmentInputs.position.z,0.0,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_NORMALIZED_VIEW_DEPTH
fragData[PREPASS_NORMALIZED_VIEW_DEPTH_INDEX]=vec4f(fragmentInputs.vNormViewDepth,0.0,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_NORMAL
#ifdef PREPASS_NORMAL_WORLDSPACE
fragData[PREPASS_NORMAL_INDEX]=vec4f(normalW,writeGeometryInfo);
#else
fragData[PREPASS_NORMAL_INDEX]=vec4f(normalize((scene.view*vec4f(normalW,0.0)).rgb),writeGeometryInfo);
#endif
#endif
#ifdef PREPASS_WORLD_NORMAL
fragData[PREPASS_WORLD_NORMAL_INDEX]=vec4f(normalW*0.5+0.5,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO
fragData[PREPASS_ALBEDO_INDEX]=vec4f(baseColor.rgb,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO_SQRT
fragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4f(sqrt(baseColor.rgb),writeGeometryInfo);
#endif
#ifdef PREPASS_REFLECTIVITY
#if defined(SPECULAR)
fragData[PREPASS_REFLECTIVITY_INDEX]=vec4f(toLinearSpaceVec4(specularMapColor))*writeGeometryInfo; 
#else
fragData[PREPASS_REFLECTIVITY_INDEX]=vec4f(toLinearSpaceVec3(specularColor),1.0)*writeGeometryInfo;
#endif
#endif
#if SCENE_MRT_COUNT>0
fragmentOutputs.fragData0=fragData[0];
#endif
#if SCENE_MRT_COUNT>1
fragmentOutputs.fragData1=fragData[1];
#endif
#if SCENE_MRT_COUNT>2
fragmentOutputs.fragData2=fragData[2];
#endif
#if SCENE_MRT_COUNT>3
fragmentOutputs.fragData3=fragData[3];
#endif
#if SCENE_MRT_COUNT>4
fragmentOutputs.fragData4=fragData[4];
#endif
#if SCENE_MRT_COUNT>5
fragmentOutputs.fragData5=fragData[5];
#endif
#if SCENE_MRT_COUNT>6
fragmentOutputs.fragData6=fragData[6];
#endif
#if SCENE_MRT_COUNT>7
fragmentOutputs.fragData7=fragData[7];
#endif
#endif
#endif
#if !defined(PREPASS) && !defined(ORDER_INDEPENDENT_TRANSPARENCY)
fragmentOutputs.color=color;
#endif
#include<oitFragment>
#if ORDER_INDEPENDENT_TRANSPARENCY
if (fragDepth==nearestDepth) {fragmentOutputs.frontColor=vec4f(fragmentOutputs.frontColor.rgb+color.rgb*color.a*alphaMultiplier,1.0-alphaMultiplier*(1.0-color.a));} else {fragmentOutputs.backColor+=color;}
#endif
#define CUSTOM_FRAGMENT_MAIN_END
}
`;g.ShadersStoreWGSL[N0]||(g.ShadersStoreWGSL[N0]=DX);sie={name:N0,shader:DX}});var wX,nie,FX=S(()=>{O();_I();wX="defaultVertexDeclaration",nie=`uniform mat4 viewProjection;
#ifdef MULTIVIEW
mat4 viewProjectionR;
#endif 
uniform mat4 view;
#ifdef DIFFUSE
uniform mat4 diffuseMatrix;uniform vec2 vDiffuseInfos;
#endif
#ifdef AMBIENT
uniform mat4 ambientMatrix;uniform vec2 vAmbientInfos;
#endif
#ifdef OPACITY
uniform mat4 opacityMatrix;uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;uniform mat4 emissiveMatrix;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;uniform mat4 lightmapMatrix;
#endif
#if defined(SPECULAR) && defined(SPECULARTERM)
uniform vec2 vSpecularInfos;uniform mat4 specularMatrix;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;uniform mat4 bumpMatrix;
#endif
#ifdef REFLECTION
uniform mat4 reflectionMatrix;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;uniform mat4 detailMatrix;
#endif
uniform vec4 cameraInfo;
#include<decalVertexDeclaration>
#define ADDITIONAL_VERTEX_DECLARATION
`;g.IncludesShadersStore[wX]||(g.IncludesShadersStore[wX]=nie)});var NX,aie,B0=S(()=>{O();Ml();qh();NX="defaultUboDeclaration",aie=`layout(std140,column_major) uniform;uniform Material
{vec4 diffuseLeftColor;vec4 diffuseRightColor;vec4 opacityParts;vec4 reflectionLeftColor;vec4 reflectionRightColor;vec4 refractionLeftColor;vec4 refractionRightColor;vec4 emissiveLeftColor;vec4 emissiveRightColor;vec2 vDiffuseInfos;vec2 vAmbientInfos;vec2 vOpacityInfos;vec2 vReflectionInfos;vec3 vReflectionPosition;vec3 vReflectionSize;vec2 vEmissiveInfos;vec2 vLightmapInfos;vec2 vSpecularInfos;vec3 vBumpInfos;mat4 diffuseMatrix;mat4 ambientMatrix;mat4 opacityMatrix;mat4 reflectionMatrix;mat4 emissiveMatrix;mat4 lightmapMatrix;mat4 specularMatrix;mat4 bumpMatrix;vec2 vTangentSpaceParams;float pointSize;float alphaCutOff;mat4 refractionMatrix;vec4 vRefractionInfos;vec3 vRefractionPosition;vec3 vRefractionSize;vec4 vSpecularColor;vec3 vEmissiveColor;vec4 vDiffuseColor;vec3 vAmbientColor;vec4 cameraInfo;
#define ADDITIONAL_UBO_DECLARATION
};
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;g.IncludesShadersStore[NX]||(g.IncludesShadersStore[NX]=aie)});var UX={};V(UX,{defaultVertexShader:()=>oie});var U0,BX,oie,GX=S(()=>{O();FX();B0();vI();Di();La();wa();ko();SI();Cu();EI();xI();Fa();gu();b_();C_();Bo();Uo();Xa();Go();Vo();Na();Ba();Ua();AI();RI();bI();H_();Ga();vu();I_();CI();ob();Su();U0="defaultVertexShader",BX=`#define CUSTOM_VERTEX_EXTENSION
#include<__decl__defaultVertex>
#define CUSTOM_VERTEX_BEGIN
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#ifdef TANGENT
attribute vec4 tangent;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#include<uvAttributeDeclaration>[2..7]
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<helperFunctions>
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<prePassVertexDeclaration>
#include<mainUVVaryingDeclaration>[1..7]
#include<samplerVertexDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse)
#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)
#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)
#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)
#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)
#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)
#if defined(SPECULARTERM)
#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular)
#endif
#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)
#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#include<bumpVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0
varying float vViewDepth;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 positionUpdated=position;
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#ifdef TANGENT
vec4 tangentUpdated=tangent;
#endif
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#ifdef UV2
vec2 uv2Updated=uv2;
#endif
#ifdef VERTEXCOLOR
vec4 colorUpdated=color;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && ((defined(PREPASS_VELOCITY) || defined(PREPASS_VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vNormalW=normalize(normalWorld*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normalUpdated);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}
#else
gl_Position=viewProjection*worldPos;
#endif
vPositionW=vec3(worldPos);
#ifdef PREPASS
#include<prePassVertex>
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));
#endif
#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0
vViewDepth=(view*worldPos).z;
#endif
#ifndef UV1
vec2 uvUpdated=vec2(0.,0.);
#endif
#ifndef UV2
vec2 uv2Updated=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uvUpdated;
#endif
#ifdef MAINUV2
vMainUV2=uv2Updated;
#endif
#include<uvVariableDeclaration>[3..7]
#include<samplerVertexImplementation>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_MATRIXNAME_,diffuse,_INFONAME_,DiffuseInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)
#if defined(SPECULARTERM)
#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_MATRIXNAME_,specular,_INFONAME_,SpecularInfos.x)
#endif
#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)
#include<bumpVertex>
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#include<vertexColorMixing>
#include<pointCloudVertex>
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}
`;g.ShadersStore[U0]||(g.ShadersStore[U0]=BX);oie={name:U0,shader:BX}});var VX,lie,kX=S(()=>{O();PI();VX="defaultFragmentDeclaration",lie=`uniform vec4 vEyePosition;uniform vec4 vDiffuseColor;uniform vec4 vSpecularColor;uniform vec3 vEmissiveColor;uniform vec3 vAmbientColor;uniform float visibility;
#ifdef DIFFUSE
uniform vec2 vDiffuseInfos;
#endif
#ifdef AMBIENT
uniform vec2 vAmbientInfos;
#endif
#ifdef OPACITY 
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;uniform vec2 vTangentSpaceParams;
#endif
#ifdef ALPHATEST
uniform float alphaCutOff;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION) || defined(PREPASS)
uniform mat4 view;
#endif
#ifdef REFRACTION
uniform vec4 vRefractionInfos;
#ifndef REFRACTIONMAP_3D
uniform mat4 refractionMatrix;
#endif
#ifdef REFRACTIONFRESNEL
uniform vec4 refractionLeftColor;uniform vec4 refractionRightColor;
#endif
#if defined(USE_LOCAL_REFRACTIONMAP_CUBIC) && defined(REFRACTIONMAP_3D)
uniform vec3 vRefractionPosition;uniform vec3 vRefractionSize; 
#endif
#endif
#if defined(SPECULAR) && defined(SPECULARTERM)
uniform vec2 vSpecularInfos;
#endif
#ifdef DIFFUSEFRESNEL
uniform vec4 diffuseLeftColor;uniform vec4 diffuseRightColor;
#endif
#ifdef OPACITYFRESNEL
uniform vec4 opacityParts;
#endif
#ifdef EMISSIVEFRESNEL
uniform vec4 emissiveLeftColor;uniform vec4 emissiveRightColor;
#endif
#if defined(REFLECTION) || (defined(AREALIGHTUSED) && defined(AREALIGHTSUPPORTED))
uniform vec2 vReflectionInfos;
#if defined(REFLECTIONMAP_PLANAR) || defined(REFLECTIONMAP_CUBIC) || defined(REFLECTIONMAP_PROJECTION) || defined(REFLECTIONMAP_EQUIRECTANGULAR) || defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_SKYBOX)
uniform mat4 reflectionMatrix;
#endif
#ifndef REFLECTIONMAP_SKYBOX
#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)
uniform vec3 vReflectionPosition;uniform vec3 vReflectionSize; 
#endif
#endif
#ifdef REFLECTIONFRESNEL
uniform vec4 reflectionLeftColor;uniform vec4 reflectionRightColor;
#endif
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
#endif
#include<decalFragmentDeclaration>
#define ADDITIONAL_FRAGMENT_DECLARATION
`;g.IncludesShadersStore[VX]||(g.IncludesShadersStore[VX]=lie)});var WX,cie,HX=S(()=>{O();WX="fresnelFunction",cie=`#ifdef FRESNEL
float computeFresnelTerm(vec3 viewDirection,vec3 worldNormal,float bias,float power)
{float fresnelTerm=pow(bias+abs(dot(viewDirection,worldNormal)),power);return clamp(fresnelTerm,0.,1.);}
#endif
`;g.IncludesShadersStore[WX]||(g.IncludesShadersStore[WX]=cie)});var XX={};V(XX,{defaultPixelShader:()=>fie});var G0,zX,fie,YX=S(()=>{O();kX();B0();yI();MI();Cu();Di();P_();D_();VC();O_();z_();HX();y_();M_();L_();X_();Y_();Da();Xa();Eu();Oa();K_();DI();LI();w_();Tu();xu();wI();G0="defaultPixelShader",zX=`#define CUSTOM_FRAGMENT_EXTENSION
#include<__decl__defaultFragment>
#if defined(BUMP) || !defined(NORMAL)
#extension GL_OES_standard_derivatives : enable
#endif
#include<prePassDeclaration>[SCENE_MRT_COUNT]
#include<oitDeclaration>
#define CUSTOM_FRAGMENT_BEGIN
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#if defined(CLUSTLIGHT_BATCH) && CLUSTLIGHT_BATCH>0
varying float vViewDepth;
#endif
#include<mainUVVaryingDeclaration>[1..7]
#include<helperFunctions>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<lightsFragmentFunctions>
#include<shadowsFragmentFunctions>
#include<samplerFragmentDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_SAMPLERNAME_,diffuse)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)
#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)
#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)
#ifdef REFRACTION
#ifdef REFRACTIONMAP_3D
uniform samplerCube refractionCubeSampler;
#else
uniform sampler2D refraction2DSampler;
#endif
#endif
#if defined(SPECULARTERM)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_SAMPLERNAME_,specular)
#endif
#include<fresnelFunction>
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
uniform samplerCube reflectionCubeSampler;
#else
uniform sampler2D reflection2DSampler;
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#include<reflectionFunction>
#endif
#include<imageProcessingDeclaration>
#include<imageProcessingFunctions>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);vec4 baseColor=vec4(1.,1.,1.,1.);vec3 diffuseColor=vDiffuseColor.rgb;float alpha=vDiffuseColor.a;
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=normalize(-cross(dFdx(vPositionW),dFdy(vPositionW)));
#endif
#include<bumpFragment>
#ifdef TWOSIDEDLIGHTING
normalW=gl_FrontFacing ? normalW : -normalW;
#endif
#ifdef DIFFUSE
baseColor=texture2D(diffuseSampler,vDiffuseUV+uvOffset);
#if defined(ALPHATEST) && !defined(ALPHATEST_AFTERALLALPHACOMPUTATIONS)
if (baseColor.a<alphaCutOff)
discard;
#endif
#ifdef ALPHAFROMDIFFUSE
alpha*=baseColor.a;
#endif
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
baseColor.rgb*=vDiffuseInfos.y;
#endif
#if defined(DECAL) && !defined(DECAL_AFTER_DETAIL)
vec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);
#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)
#endif
#include<depthPrePass>
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
baseColor.rgb*=vColor.rgb;
#endif
#ifdef DETAIL
baseColor.rgb=baseColor.rgb*2.0*mix(0.5,detailColor.r,vDetailInfos.y);
#endif
#if defined(DECAL) && defined(DECAL_AFTER_DETAIL)
vec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);
#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)
#endif
#define CUSTOM_FRAGMENT_UPDATE_DIFFUSE
vec3 baseAmbientColor=vec3(1.,1.,1.);
#ifdef AMBIENT
baseAmbientColor=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb*vAmbientInfos.y;
#endif
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS
float glossiness=vSpecularColor.a;vec3 specularColor=vSpecularColor.rgb;
#ifdef SPECULARTERM
#ifdef SPECULAR
vec4 specularMapColor=texture2D(specularSampler,vSpecularUV+uvOffset);specularColor=specularMapColor.rgb;
#ifdef GLOSSINESS
glossiness=glossiness*specularMapColor.a;
#endif
#endif
#endif
vec3 diffuseBase=vec3(0.,0.,0.);lightingInfo info;
#ifdef SPECULARTERM
vec3 specularBase=vec3(0.,0.,0.);
#endif
float shadow=1.;float aggShadow=0.;float numLights=0.;
#ifdef LIGHTMAP
vec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);
#ifdef RGBDLIGHTMAP
lightmapColor.rgb=fromRGBD(lightmapColor);
#endif
lightmapColor.rgb*=vLightmapInfos.y;
#endif
#include<lightFragment>[0..maxSimultaneousLights]
aggShadow=aggShadow/numLights;vec4 refractionColor=vec4(0.,0.,0.,1.);
#ifdef REFRACTION
vec3 refractionVector=normalize(refract(-viewDirectionW,normalW,vRefractionInfos.y));
#ifdef REFRACTIONMAP_3D
#ifdef USE_LOCAL_REFRACTIONMAP_CUBIC
refractionVector=parallaxCorrectNormal(vPositionW,refractionVector,vRefractionSize,vRefractionPosition);
#endif
refractionVector.y=refractionVector.y*vRefractionInfos.w;vec4 refractionLookup=textureCube(refractionCubeSampler,refractionVector);if (dot(refractionVector,viewDirectionW)<1.0) {refractionColor=refractionLookup;}
#else
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));vec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;refractionColor=texture2D(refraction2DSampler,refractionCoords);
#endif
#ifdef RGBDREFRACTION
refractionColor.rgb=fromRGBD(refractionColor);
#endif
#ifdef IS_REFRACTION_LINEAR
refractionColor.rgb=toGammaSpace(refractionColor.rgb);
#endif
refractionColor.rgb*=vRefractionInfos.x;
#endif
vec4 reflectionColor=vec4(0.,0.,0.,1.);
#ifdef REFLECTION
vec3 vReflectionUVW=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
vReflectionUVW.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
#ifdef ROUGHNESS
float bias=vReflectionInfos.y;
#ifdef SPECULARTERM
#ifdef SPECULAR
#ifdef GLOSSINESS
bias*=(1.0-specularMapColor.a);
#endif
#endif
#endif
reflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW,bias);
#else
reflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW);
#endif
#else
vec2 coords=vReflectionUVW.xy;
#ifdef REFLECTIONMAP_PROJECTION
coords/=vReflectionUVW.z;
#endif
coords.y=1.0-coords.y;reflectionColor=texture2D(reflection2DSampler,coords);
#endif
#ifdef RGBDREFLECTION
reflectionColor.rgb=fromRGBD(reflectionColor);
#endif
#ifdef IS_REFLECTION_LINEAR
reflectionColor.rgb=toGammaSpace(reflectionColor.rgb);
#endif
reflectionColor.rgb*=vReflectionInfos.x;
#ifdef REFLECTIONFRESNEL
float reflectionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,reflectionRightColor.a,reflectionLeftColor.a);
#ifdef REFLECTIONFRESNELFROMSPECULAR
#ifdef SPECULARTERM
reflectionColor.rgb*=specularColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#else
reflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#endif
#else
reflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#endif
#endif
#endif
#ifdef REFRACTIONFRESNEL
float refractionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,refractionRightColor.a,refractionLeftColor.a);refractionColor.rgb*=refractionLeftColor.rgb*(1.0-refractionFresnelTerm)+refractionFresnelTerm*refractionRightColor.rgb;
#endif
#ifdef OPACITY
vec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);
#ifdef OPACITYRGB
opacityMap.rgb=opacityMap.rgb*vec3(0.3,0.59,0.11);alpha*=(opacityMap.x+opacityMap.y+opacityMap.z)* vOpacityInfos.y;
#else
alpha*=opacityMap.a*vOpacityInfos.y;
#endif
#endif
#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)
alpha*=vColor.a;
#endif
#ifdef OPACITYFRESNEL
float opacityFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,opacityParts.z,opacityParts.w);alpha+=opacityParts.x*(1.0-opacityFresnelTerm)+opacityFresnelTerm*opacityParts.y;
#endif
#ifdef ALPHATEST
#ifdef ALPHATEST_AFTERALLALPHACOMPUTATIONS
if (alpha<alphaCutOff)
discard;
#endif
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
vec3 emissiveColor=vEmissiveColor;
#ifdef EMISSIVE
emissiveColor+=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb*vEmissiveInfos.y;
#endif
#ifdef EMISSIVEFRESNEL
float emissiveFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,emissiveRightColor.a,emissiveLeftColor.a);emissiveColor*=emissiveLeftColor.rgb*(1.0-emissiveFresnelTerm)+emissiveFresnelTerm*emissiveRightColor.rgb;
#endif
#ifdef DIFFUSEFRESNEL
float diffuseFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,diffuseRightColor.a,diffuseLeftColor.a);diffuseBase*=diffuseLeftColor.rgb*(1.0-diffuseFresnelTerm)+diffuseFresnelTerm*diffuseRightColor.rgb;
#endif
#ifdef EMISSIVEASILLUMINATION
vec3 finalDiffuse=clamp(diffuseBase*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#else
#ifdef LINKEMISSIVEWITHDIFFUSE
vec3 finalDiffuse=clamp((diffuseBase+emissiveColor)*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#else
vec3 finalDiffuse=clamp(diffuseBase*diffuseColor+emissiveColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#endif
#endif
#ifdef SPECULARTERM
vec3 finalSpecular=specularBase*specularColor;
#ifdef SPECULAROVERALPHA
alpha=clamp(alpha+dot(finalSpecular,vec3(0.3,0.59,0.11)),0.,1.);
#endif
#else
vec3 finalSpecular=vec3(0.0);
#endif
#ifdef REFLECTIONOVERALPHA
alpha=clamp(alpha+dot(reflectionColor.rgb,vec3(0.3,0.59,0.11)),0.,1.);
#endif
#ifdef EMISSIVEASILLUMINATION
vec4 color=vec4(clamp(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+emissiveColor+refractionColor.rgb,0.0,1.0),alpha);
#else
vec4 color=vec4(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+refractionColor.rgb,alpha);
#endif
#ifdef LIGHTMAP
#ifndef LIGHTMAPEXCLUDED
#ifdef USELIGHTMAPASSHADOWMAP
color.rgb*=lightmapColor.rgb;
#else
color.rgb+=lightmapColor.rgb;
#endif
#endif
#endif
#define CUSTOM_FRAGMENT_BEFORE_FOG
color.rgb=max(color.rgb,0.);
#include<logDepthFragment>
#include<fogFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS
color.rgb=toLinearSpace(color.rgb);
#else
#ifdef IMAGEPROCESSING
color.rgb=toLinearSpace(color.rgb);color=applyImageProcessing(color);
#endif
#endif
color.a*=visibility;
#ifdef PREMULTIPLYALPHA
color.rgb*=color.a;
#endif
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
#if SCENE_MRT_COUNT>0
float writeGeometryInfo=color.a>0.4 ? 1.0 : 0.0;
#ifdef PREPASS_COLOR
gl_FragData[PREPASS_COLOR_INDEX]=color; 
#endif
#ifdef PREPASS_POSITION
gl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);
#endif
#ifdef PREPASS_LOCAL_POSITION
gl_FragData[PREPASS_LOCAL_POSITION_INDEX]=vec4(vPosition,writeGeometryInfo);
#endif
#if defined(PREPASS_VELOCITY)
vec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;vec2 velocity=abs(a-b);velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;gl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);
#elif defined(PREPASS_VELOCITY_LINEAR)
vec2 velocity=vec2(0.5)*((vPreviousPosition.xy/vPreviousPosition.w)-(vCurrentPosition.xy/vCurrentPosition.w));gl_FragData[PREPASS_VELOCITY_LINEAR_INDEX]=vec4(velocity,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_IRRADIANCE
gl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_DEPTH
gl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_SCREENSPACE_DEPTH
gl_FragData[PREPASS_SCREENSPACE_DEPTH_INDEX]=vec4(gl_FragCoord.z,0.0,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_NORMALIZED_VIEW_DEPTH
gl_FragData[PREPASS_NORMALIZED_VIEW_DEPTH_INDEX]=vec4(vNormViewDepth,0.0,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_NORMAL
#ifdef PREPASS_NORMAL_WORLDSPACE
gl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalW,writeGeometryInfo);
#else
gl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalize((view*vec4(normalW,0.0)).rgb),writeGeometryInfo);
#endif
#endif
#ifdef PREPASS_WORLD_NORMAL
gl_FragData[PREPASS_WORLD_NORMAL_INDEX]=vec4(normalW*0.5+0.5,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO
gl_FragData[PREPASS_ALBEDO_INDEX]=vec4(baseColor.rgb,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO_SQRT
gl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(sqrt(baseColor.rgb),writeGeometryInfo);
#endif
#ifdef PREPASS_REFLECTIVITY
#if defined(SPECULAR)
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(toLinearSpace(specularMapColor))*writeGeometryInfo; 
#else
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(toLinearSpace(specularColor),1.0)*writeGeometryInfo;
#endif
#endif
#endif
#endif
#if !defined(PREPASS) || defined(WEBGL2)
gl_FragColor=color;
#endif
#include<oitFragment>
#if ORDER_INDEPENDENT_TRANSPARENCY
if (fragDepth==nearestDepth) {frontColor.rgb+=color.rgb*color.a*alphaMultiplier;frontColor.a=1.0-alphaMultiplier*(1.0-color.a);} else {backColor+=color;}
#endif
#define CUSTOM_FRAGMENT_MAIN_END
}
`;g.ShadersStore[G0]||(g.ShadersStore[G0]=zX);fie={name:G0,shader:zX}});var V0,k0,Se,nc=S(()=>{Ye();je();bn();Xr();it();yt();XC();Xc();cs();fs();yf();Ut();Te();fn();bo();JC();rn();Xi();ei();N_();V0={effect:null,subMesh:null},k0=class extends ri{constructor(e){super(e),this.MAINUV1=!1,this.MAINUV2=!1,this.MAINUV3=!1,this.MAINUV4=!1,this.MAINUV5=!1,this.MAINUV6=!1,this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.OPACITY=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.REFLECTION=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.SPECULAR=!1,this.SPECULARDIRECTUV=0,this.BUMP=!1,this.BUMPDIRECTUV=0,this.PARALLAX=!1,this.PARALLAX_RHS=!1,this.PARALLAXOCCLUSION=!1,this.SPECULAROVERALPHA=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHAFROMDIFFUSE=!1,this.POINTSIZE=!1,this.FOG=!1,this.SPECULARTERM=!1,this.DIFFUSEFRESNEL=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONFRESNEL=!1,this.REFRACTIONFRESNEL=!1,this.EMISSIVEFRESNEL=!1,this.FRESNEL=!1,this.NORMAL=!1,this.TANGENT=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.VERTEXCOLOR=!1,this.VERTEXALPHA=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.GLOSSINESS=!1,this.ROUGHNESS=!1,this.EMISSIVEASILLUMINATION=!1,this.LINKEMISSIVEWITHDIFFUSE=!1,this.REFLECTIONFRESNELFROMSPECULAR=!1,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.USELIGHTMAPASSHADOWMAP=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.INVERTCUBICMAP=!1,this.LOGARITHMICDEPTH=!1,this.REFRACTION=!1,this.REFRACTIONMAP_3D=!1,this.REFLECTIONOVERALPHA=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_POSITION=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.MORPHTARGETS_UV2=!1,this.MORPHTARGETS_COLOR=!1,this.MORPHTARGETTEXTURE_HASPOSITIONS=!1,this.MORPHTARGETTEXTURE_HASNORMALS=!1,this.MORPHTARGETTEXTURE_HASTANGENTS=!1,this.MORPHTARGETTEXTURE_HASUVS=!1,this.MORPHTARGETTEXTURE_HASUV2S=!1,this.MORPHTARGETTEXTURE_HASCOLORS=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.NONUNIFORMSCALING=!1,this.PREMULTIPLYALPHA=!1,this.ALPHATEST_AFTERALLALPHACOMPUTATIONS=!1,this.ALPHABLEND=!0,this.PREPASS=!1,this.PREPASS_COLOR=!1,this.PREPASS_COLOR_INDEX=-1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO=!1,this.PREPASS_ALBEDO_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_SCREENSPACE_DEPTH=!1,this.PREPASS_SCREENSPACE_DEPTH_INDEX=-1,this.PREPASS_NORMALIZED_VIEW_DEPTH=!1,this.PREPASS_NORMALIZED_VIEW_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_NORMAL_WORLDSPACE=!1,this.PREPASS_WORLD_NORMAL=!1,this.PREPASS_WORLD_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_LOCAL_POSITION=!1,this.PREPASS_LOCAL_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_VELOCITY_LINEAR=!1,this.PREPASS_VELOCITY_LINEAR_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.RGBDLIGHTMAP=!1,this.RGBDREFLECTION=!1,this.RGBDREFRACTION=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=0,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.AREALIGHTSUPPORTED=!0,this.USE_VERTEX_PULLING=!1,this.IS_REFLECTION_LINEAR=!1,this.IS_REFRACTION_LINEAR=!1,this.EXPOSURE=!1,this.DECAL_AFTER_DETAIL=!1,this.rebuild()}setReflectionMode(e){let t=["REFLECTIONMAP_CUBIC","REFLECTIONMAP_EXPLICIT","REFLECTIONMAP_PLANAR","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_SKYBOX","REFLECTIONMAP_SPHERICAL","REFLECTIONMAP_EQUIRECTANGULAR","REFLECTIONMAP_EQUIRECTANGULAR_FIXED","REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"];for(let i of t)this[i]=i===e}},Se=class s extends Fs{get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsImageProcessingDirty()}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._markAllSubMeshesAsImageProcessingDirty()})))}get isPrePassCapable(){return!this.disableDepthWrite}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this._imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this._imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this._imageProcessingConfiguration.colorCurves=e}get canRenderToMRT(){return!0}constructor(e,t,i=!1){super(e,t,void 0,i||s.ForceGLSL),this._diffuseTexture=null,this._ambientTexture=null,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._specularTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._refractionTexture=null,this.ambientColor=new j(0,0,0),this.diffuseColor=new j(1,1,1),this.specularColor=new j(1,1,1),this.emissiveColor=new j(0,0,0),this.specularPower=64,this._useAlphaFromDiffuseTexture=!1,this._useEmissiveAsIllumination=!1,this._linkEmissiveWithDiffuse=!1,this._useSpecularOverAlpha=!1,this._useReflectionOverAlpha=!1,this._disableLighting=!1,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this._roughness=0,this.indexOfRefraction=.98,this.invertRefractionY=!0,this.alphaCutOff=.4,this._useLightmapAsShadowmap=!1,this._useReflectionFresnelFromSpecular=!1,this._useGlossinessFromSpecularMapAlpha=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._applyDecalMapAfterDetailMap=!1,this._shadersLoaded=!1,this._renderTargets=new wt(16),this._globalAmbientColor=new j(0,0,0),this._cacheHasRenderTargetTextures=!1,this.detailMap=new Ns(this),this._attachImageProcessingConfiguration(null),this.prePassConfiguration=new Qn,this.getRenderTargetTextures=()=>(this._renderTargets.reset(),s.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),s.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&this._renderTargets.push(this._refractionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets)}get hasRenderTargetTextures(){return s.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget||s.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget?!0:this._cacheHasRenderTargetTextures}getClassName(){return"StandardMaterial"}needAlphaBlending(){return this._hasTransparencyMode?this._transparencyModeIsBlend:this._disableAlphaBlending?!1:this.alpha<1||this._opacityTexture!=null||this._shouldUseAlphaFromDiffuseTexture()||this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled}needAlphaTesting(){return this._hasTransparencyMode?this._transparencyModeIsTest:this._hasAlphaChannel()&&(this._transparencyMode==null||this._transparencyMode===Q.MATERIAL_ALPHATEST)}_shouldUseAlphaFromDiffuseTexture(){return this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha&&this._useAlphaFromDiffuseTexture&&this._transparencyMode!==Q.MATERIAL_OPAQUE}_hasAlphaChannel(){return this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha||this._opacityTexture!=null}getAlphaTestTexture(){return this._diffuseTexture}isReadyForSubMesh(e,t,i=!1){this._uniformBufferLayoutBuilt||this.buildUniformLayout();let r=t._drawWrapper;if(r.effect&&this.isFrozen&&r._wasPreviouslyReady&&r._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(this._callbackPluginEventGeneric(4,this._eventInfo),t.materialDefines=new k0(this._eventInfo.defineNames));let n=this.getScene(),a=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;let o=n.getEngine();a._needNormals=ef(n,e,a,!0,this._maxSimultaneousLights,this._disableLighting),tf(n,a);let l=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(wm(n,a,this.canRenderToMRT&&!l),Lm(n,a,l),si.PrepareDefines(o.currentRenderPassId,e,a),a._areTexturesDirty){this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,a._needUVs=!1;for(let f=1;f<=6;++f)a["MAINUV"+f]=!1;if(n.texturesEnabled){if(a.DIFFUSEDIRECTUV=0,a.BUMPDIRECTUV=0,a.AMBIENTDIRECTUV=0,a.OPACITYDIRECTUV=0,a.EMISSIVEDIRECTUV=0,a.SPECULARDIRECTUV=0,a.LIGHTMAPDIRECTUV=0,this._diffuseTexture&&s.DiffuseTextureEnabled)if(this._diffuseTexture.isReadyOrNotBlocking())lt(this._diffuseTexture,a,"DIFFUSE");else return!1;else a.DIFFUSE=!1;if(this._ambientTexture&&s.AmbientTextureEnabled)if(this._ambientTexture.isReadyOrNotBlocking())lt(this._ambientTexture,a,"AMBIENT");else return!1;else a.AMBIENT=!1;if(this._opacityTexture&&s.OpacityTextureEnabled)if(this._opacityTexture.isReadyOrNotBlocking())lt(this._opacityTexture,a,"OPACITY"),a.OPACITYRGB=this._opacityTexture.getAlphaFromRGB;else return!1;else a.OPACITY=!1;if(this._reflectionTexture&&s.ReflectionTextureEnabled)if(this._reflectionTexture.isReadyOrNotBlocking()){switch(a._needNormals=!0,a.REFLECTION=!0,a.ROUGHNESS=this._roughness>0,a.REFLECTIONOVERALPHA=this._useReflectionOverAlpha,a.INVERTCUBICMAP=this._reflectionTexture.coordinatesMode===H.INVCUBIC_MODE,a.REFLECTIONMAP_3D=this._reflectionTexture.isCube,a.REFLECTIONMAP_OPPOSITEZ=a.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!this._reflectionTexture.invertZ:this._reflectionTexture.invertZ,a.RGBDREFLECTION=this._reflectionTexture.isRGBD,this._reflectionTexture.coordinatesMode){case H.EXPLICIT_MODE:a.setReflectionMode("REFLECTIONMAP_EXPLICIT");break;case H.PLANAR_MODE:a.setReflectionMode("REFLECTIONMAP_PLANAR");break;case H.PROJECTION_MODE:a.setReflectionMode("REFLECTIONMAP_PROJECTION");break;case H.SKYBOX_MODE:a.setReflectionMode("REFLECTIONMAP_SKYBOX");break;case H.SPHERICAL_MODE:a.setReflectionMode("REFLECTIONMAP_SPHERICAL");break;case H.EQUIRECTANGULAR_MODE:a.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR");break;case H.FIXED_EQUIRECTANGULAR_MODE:a.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR_FIXED");break;case H.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:a.setReflectionMode("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED");break;case H.CUBIC_MODE:case H.INVCUBIC_MODE:default:a.setReflectionMode("REFLECTIONMAP_CUBIC");break}a.USE_LOCAL_REFLECTIONMAP_CUBIC=!!this._reflectionTexture.boundingBoxSize}else return!1;else a.REFLECTION=!1,a.REFLECTIONMAP_OPPOSITEZ=!1;if(this._emissiveTexture&&s.EmissiveTextureEnabled)if(this._emissiveTexture.isReadyOrNotBlocking())lt(this._emissiveTexture,a,"EMISSIVE");else return!1;else a.EMISSIVE=!1;if(this._lightmapTexture&&s.LightmapTextureEnabled)if(this._lightmapTexture.isReadyOrNotBlocking())lt(this._lightmapTexture,a,"LIGHTMAP"),a.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,a.RGBDLIGHTMAP=this._lightmapTexture.isRGBD;else return!1;else a.LIGHTMAP=!1;if(this._specularTexture&&s.SpecularTextureEnabled)if(this._specularTexture.isReadyOrNotBlocking())lt(this._specularTexture,a,"SPECULAR"),a.GLOSSINESS=this._useGlossinessFromSpecularMapAlpha;else return!1;else a.SPECULAR=!1;if(n.getEngine().getCaps().standardDerivatives&&this._bumpTexture&&s.BumpTextureEnabled){if(this._bumpTexture.isReady())lt(this._bumpTexture,a,"BUMP"),a.PARALLAX=this._useParallax,a.PARALLAX_RHS=n.useRightHandedSystem,a.PARALLAXOCCLUSION=this._useParallaxOcclusion;else return!1;a.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap}else a.BUMP=!1,a.PARALLAX=!1,a.PARALLAX_RHS=!1,a.PARALLAXOCCLUSION=!1;if(this._refractionTexture&&s.RefractionTextureEnabled)if(this._refractionTexture.isReadyOrNotBlocking())a._needUVs=!0,a.REFRACTION=!0,a.REFRACTIONMAP_3D=this._refractionTexture.isCube,a.RGBDREFRACTION=this._refractionTexture.isRGBD,a.USE_LOCAL_REFRACTIONMAP_CUBIC=!!this._refractionTexture.boundingBoxSize;else return!1;else a.REFRACTION=!1;a.TWOSIDEDLIGHTING=!this._backFaceCulling&&this._twoSidedLighting}else a.DIFFUSE=!1,a.AMBIENT=!1,a.OPACITY=!1,a.REFLECTION=!1,a.EMISSIVE=!1,a.LIGHTMAP=!1,a.BUMP=!1,a.REFRACTION=!1;a.ALPHAFROMDIFFUSE=this._shouldUseAlphaFromDiffuseTexture(),a.EMISSIVEASILLUMINATION=this._useEmissiveAsIllumination,a.LINKEMISSIVEWITHDIFFUSE=this._linkEmissiveWithDiffuse,a.SPECULAROVERALPHA=this._useSpecularOverAlpha,a.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,a.ALPHATEST_AFTERALLALPHACOMPUTATIONS=this.transparencyMode!==null,a.ALPHABLEND=this.transparencyMode===null||this.needAlphaBlendingForMesh(e)}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=a,this._eventInfo.subMesh=t,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh)return!1;if(a._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(a),a.IS_REFLECTION_LINEAR=this.reflectionTexture!=null&&!this.reflectionTexture.gammaSpace,a.IS_REFRACTION_LINEAR=this.refractionTexture!=null&&!this.refractionTexture.gammaSpace}if(a._areFresnelDirty&&(s.FresnelEnabled?(this._diffuseFresnelParameters||this._opacityFresnelParameters||this._emissiveFresnelParameters||this._refractionFresnelParameters||this._reflectionFresnelParameters)&&(a.DIFFUSEFRESNEL=this._diffuseFresnelParameters&&this._diffuseFresnelParameters.isEnabled,a.OPACITYFRESNEL=this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled,a.REFLECTIONFRESNEL=this._reflectionFresnelParameters&&this._reflectionFresnelParameters.isEnabled,a.REFLECTIONFRESNELFROMSPECULAR=this._useReflectionFresnelFromSpecular,a.REFRACTIONFRESNEL=this._refractionFresnelParameters&&this._refractionFresnelParameters.isEnabled,a.EMISSIVEFRESNEL=this._emissiveFresnelParameters&&this._emissiveFresnelParameters.isEnabled,a._needNormals=!0,a.FRESNEL=!0):a.FRESNEL=!1),a.AREALIGHTUSED||a.CLUSTLIGHT_BATCH){for(let f=0;f<e.lightSources.length;f++)if(!e.lightSources[f]._isReady())return!1}yo(e,n,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this.needAlphaTestingForMesh(e),a,this._applyDecalMapAfterDetailMap,this._useVertexPulling,t.getRenderingMesh(),this._setVertexOutputInvariant),Mo(n,o,this,a,i,null,t.getRenderingMesh().hasThinInstances),this._eventInfo.defines=a,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),Po(e,a,!0,!0,!0),this._callbackPluginEventPrepareDefines(this._eventInfo);let c=!1;if(a.isDirty){let f=a._areLightsDisposed;a.markAsProcessed();let h=new or;a.REFLECTION&&h.addFallback(0,"REFLECTION"),a.SPECULAR&&h.addFallback(0,"SPECULAR"),a.BUMP&&h.addFallback(0,"BUMP"),a.PARALLAX&&h.addFallback(1,"PARALLAX"),a.PARALLAX_RHS&&h.addFallback(1,"PARALLAX_RHS"),a.PARALLAXOCCLUSION&&h.addFallback(0,"PARALLAXOCCLUSION"),a.SPECULAROVERALPHA&&h.addFallback(0,"SPECULAROVERALPHA"),a.FOG&&h.addFallback(1,"FOG"),a.POINTSIZE&&h.addFallback(0,"POINTSIZE"),a.LOGARITHMICDEPTH&&h.addFallback(0,"LOGARITHMICDEPTH"),$c(a,h,this._maxSimultaneousLights),a.SPECULARTERM&&h.addFallback(0,"SPECULARTERM"),a.DIFFUSEFRESNEL&&h.addFallback(1,"DIFFUSEFRESNEL"),a.OPACITYFRESNEL&&h.addFallback(2,"OPACITYFRESNEL"),a.REFLECTIONFRESNEL&&h.addFallback(3,"REFLECTIONFRESNEL"),a.EMISSIVEFRESNEL&&h.addFallback(4,"EMISSIVEFRESNEL"),a.FRESNEL&&h.addFallback(4,"FRESNEL"),a.MULTIVIEW&&h.addFallback(0,"MULTIVIEW");let u=[A.PositionKind];a.NORMAL&&u.push(A.NormalKind),a.TANGENT&&u.push(A.TangentKind);for(let b=1;b<=6;++b)a["UV"+b]&&u.push(`uv${b===1?"":b}`);a.VERTEXCOLOR&&u.push(A.ColorKind),Jc(u,e,a,h),Io(u,a),Kh(u,e,a),jc(u,e,a);let d="default",p=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vDiffuseColor","vSpecularColor","vEmissiveColor","visibility","vFogInfos","vFogColor","pointSize","vDiffuseInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vEmissiveInfos","vSpecularInfos","vBumpInfos","vLightmapInfos","vRefractionInfos","mBones","diffuseMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","specularMatrix","bumpMatrix","normalMatrix","lightmapMatrix","refractionMatrix","diffuseLeftColor","diffuseRightColor","opacityParts","reflectionLeftColor","reflectionRightColor","emissiveLeftColor","emissiveRightColor","refractionLeftColor","refractionRightColor","vReflectionPosition","vReflectionSize","vRefractionPosition","vRefractionSize","logarithmicDepthConstant","vTangentSpaceParams","alphaCutOff","boneTextureWidth","morphTargetTextureInfo","morphTargetTextureIndices","cameraInfo"],m=["diffuseSampler","ambientSampler","opacitySampler","reflectionCubeSampler","reflection2DSampler","emissiveSampler","specularSampler","bumpSampler","lightmapSampler","refractionCubeSampler","refraction2DSampler","boneSampler","morphTargets","oitDepthSampler","oitFrontColorSampler","areaLightsLTC1Sampler","areaLightsLTC2Sampler"],_=["Material","Scene","Mesh"],v={maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:a.NUM_MORPH_INFLUENCERS};this._eventInfo.fallbacks=h,this._eventInfo.fallbackRank=0,this._eventInfo.defines=a,this._eventInfo.uniforms=p,this._eventInfo.attributes=u,this._eventInfo.samplers=m,this._eventInfo.uniformBuffersNames=_,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._eventInfo.indexParameters=v,this._callbackPluginEventGeneric(128,this._eventInfo),si.AddUniformsAndSamplers(p,m),Qn.AddUniforms(p),Qn.AddSamplers(m),Ve&&(Ve.PrepareUniforms(p,a),Ve.PrepareSamplers(m,a)),Do({uniformsNames:p,uniformBuffersNames:_,samplers:m,defines:a,maxSimultaneousLights:this._maxSimultaneousLights}),Hi(p);let T={};this.customShaderNameResolve&&(d=this.customShaderNameResolve(d,p,_,m,a,u,T));let C=a.toString(),I=t.effect,R=n.getEngine().createEffect(d,{attributes:u,uniformsNames:p,uniformBuffersNames:_,samplers:m,defines:C,fallbacks:h,onCompiled:this.onCompiled,onError:this.onError,indexParameters:v,processFinalCode:T.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:a.PREPASS,shaderLanguage:this._shaderLanguage,extraInitializationsAsync:this._shadersLoaded?void 0:async()=>{this._shaderLanguage===1?await Promise.all([Promise.resolve().then(()=>(MX(),yX)),Promise.resolve().then(()=>(LX(),OX))]):await Promise.all([Promise.resolve().then(()=>(GX(),UX)),Promise.resolve().then(()=>(YX(),XX))]),this._shadersLoaded=!0}},o);if(this._eventInfo.customCode=void 0,R)if(this._onEffectCreatedObservable&&(V0.effect=R,V0.subMesh=t,this._onEffectCreatedObservable.notifyObservers(V0)),this.allowShaderHotSwapping&&I&&!R.isReady()){if(R=I,a.markAsUnprocessed(),c=this.isFrozen,f)return a._areLightsDisposed=!0,!1}else n.resetCachedMaterial(),t.setEffect(R,a,this._materialContext)}return!t.effect||!t.effect.isReady()?!1:(a._renderId=n.getRenderId(),r._wasPreviouslyReady=!c,r._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),!0)}buildUniformLayout(){let e=this._uniformBuffer;e.addUniform("diffuseLeftColor",4),e.addUniform("diffuseRightColor",4),e.addUniform("opacityParts",4),e.addUniform("reflectionLeftColor",4),e.addUniform("reflectionRightColor",4),e.addUniform("refractionLeftColor",4),e.addUniform("refractionRightColor",4),e.addUniform("emissiveLeftColor",4),e.addUniform("emissiveRightColor",4),e.addUniform("vDiffuseInfos",2),e.addUniform("vAmbientInfos",2),e.addUniform("vOpacityInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vSpecularInfos",2),e.addUniform("vBumpInfos",3),e.addUniform("diffuseMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("reflectionMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("specularMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("pointSize",1),e.addUniform("alphaCutOff",1),e.addUniform("refractionMatrix",16),e.addUniform("vRefractionInfos",4),e.addUniform("vRefractionPosition",3),e.addUniform("vRefractionSize",3),e.addUniform("vSpecularColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vDiffuseColor",4),e.addUniform("vAmbientColor",3),e.addUniform("cameraInfo",4),super.buildUniformLayout()}bindForSubMesh(e,t,i){let r=this.getScene(),n=i.materialDefines;if(!n)return;let a=i.effect;if(!a)return;this._activeEffect=a,t.getMeshUniformBuffer().bindToEffect(a,"Mesh"),t.transferToEffect(e),this._uniformBuffer.bindToEffect(a,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,r,t,e,this.isFrozen),si.Bind(r.getEngine().currentRenderPassId,this._activeEffect,t,e,this);let o=r.activeCamera;o?this._uniformBuffer.updateFloat4("cameraInfo",o.minZ,o.maxZ,0,0):this._uniformBuffer.updateFloat4("cameraInfo",0,0,0,0),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),n.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));let l=this._mustRebind(r,a,i,t.visibility);Nn(t,a);let c=this._uniformBuffer;if(l){if(this.bindViewProjection(a),!c.useUbo||!this.isFrozen||!c.isSync||i._drawWrapper._forceRebindOnNextCall){if(s.FresnelEnabled&&n.FRESNEL&&(this.diffuseFresnelParameters&&this.diffuseFresnelParameters.isEnabled&&(c.updateColor4("diffuseLeftColor",this.diffuseFresnelParameters.leftColor,this.diffuseFresnelParameters.power),c.updateColor4("diffuseRightColor",this.diffuseFresnelParameters.rightColor,this.diffuseFresnelParameters.bias)),this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&c.updateColor4("opacityParts",new j(this.opacityFresnelParameters.leftColor.toLuminance(),this.opacityFresnelParameters.rightColor.toLuminance(),this.opacityFresnelParameters.bias),this.opacityFresnelParameters.power),this.reflectionFresnelParameters&&this.reflectionFresnelParameters.isEnabled&&(c.updateColor4("reflectionLeftColor",this.reflectionFresnelParameters.leftColor,this.reflectionFresnelParameters.power),c.updateColor4("reflectionRightColor",this.reflectionFresnelParameters.rightColor,this.reflectionFresnelParameters.bias)),this.refractionFresnelParameters&&this.refractionFresnelParameters.isEnabled&&(c.updateColor4("refractionLeftColor",this.refractionFresnelParameters.leftColor,this.refractionFresnelParameters.power),c.updateColor4("refractionRightColor",this.refractionFresnelParameters.rightColor,this.refractionFresnelParameters.bias)),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(c.updateColor4("emissiveLeftColor",this.emissiveFresnelParameters.leftColor,this.emissiveFresnelParameters.power),c.updateColor4("emissiveRightColor",this.emissiveFresnelParameters.rightColor,this.emissiveFresnelParameters.bias))),r.texturesEnabled){if(this._diffuseTexture&&s.DiffuseTextureEnabled&&(c.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),ct(this._diffuseTexture,c,"diffuse")),this._ambientTexture&&s.AmbientTextureEnabled&&(c.updateFloat2("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level),ct(this._ambientTexture,c,"ambient")),this._opacityTexture&&s.OpacityTextureEnabled&&(c.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),ct(this._opacityTexture,c,"opacity")),this._hasAlphaChannel()&&c.updateFloat("alphaCutOff",this.alphaCutOff),this._reflectionTexture&&s.ReflectionTextureEnabled){if(c.updateFloat2("vReflectionInfos",this._reflectionTexture.level,this.roughness),c.updateMatrix("reflectionMatrix",this._reflectionTexture.getReflectionTextureMatrix()),this._reflectionTexture.boundingBoxSize){let f=this._reflectionTexture;c.updateVector3("vReflectionPosition",f.boundingBoxPosition),c.updateVector3("vReflectionSize",f.boundingBoxSize)}}else c.updateFloat2("vReflectionInfos",0,this.roughness);if(this._emissiveTexture&&s.EmissiveTextureEnabled&&(c.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),ct(this._emissiveTexture,c,"emissive")),this._lightmapTexture&&s.LightmapTextureEnabled&&(c.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),ct(this._lightmapTexture,c,"lightmap")),this._specularTexture&&s.SpecularTextureEnabled&&(c.updateFloat2("vSpecularInfos",this._specularTexture.coordinatesIndex,this._specularTexture.level),ct(this._specularTexture,c,"specular")),this._bumpTexture&&r.getEngine().getCaps().standardDerivatives&&s.BumpTextureEnabled&&(c.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,1/this._bumpTexture.level,this.parallaxScaleBias),ct(this._bumpTexture,c,"bump"),r._mirroredCameraPosition?c.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):c.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1)),this._refractionTexture&&s.RefractionTextureEnabled){let f=1;if(this._refractionTexture.isCube||(c.updateMatrix("refractionMatrix",this._refractionTexture.getReflectionTextureMatrix()),this._refractionTexture.depth&&(f=this._refractionTexture.depth)),c.updateFloat4("vRefractionInfos",this._refractionTexture.level,this.indexOfRefraction,f,this.invertRefractionY?-1:1),this._refractionTexture.boundingBoxSize){let h=this._refractionTexture;c.updateVector3("vRefractionPosition",h.boundingBoxPosition),c.updateVector3("vRefractionSize",h.boundingBoxSize)}}}this.pointsCloud&&c.updateFloat("pointSize",this.pointSize),c.updateColor4("vSpecularColor",this.specularColor,this.specularPower),c.updateColor3("vEmissiveColor",s.EmissiveTextureEnabled?this.emissiveColor:j.BlackReadOnly),c.updateColor4("vDiffuseColor",this.diffuseColor,this.alpha),r.ambientColor.multiplyToRef(this.ambientColor,this._globalAmbientColor),c.updateColor3("vAmbientColor",this._globalAmbientColor)}r.texturesEnabled&&(this._diffuseTexture&&s.DiffuseTextureEnabled&&a.setTexture("diffuseSampler",this._diffuseTexture),this._ambientTexture&&s.AmbientTextureEnabled&&a.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&s.OpacityTextureEnabled&&a.setTexture("opacitySampler",this._opacityTexture),this._reflectionTexture&&s.ReflectionTextureEnabled&&(this._reflectionTexture.isCube?a.setTexture("reflectionCubeSampler",this._reflectionTexture):a.setTexture("reflection2DSampler",this._reflectionTexture)),this._emissiveTexture&&s.EmissiveTextureEnabled&&a.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&s.LightmapTextureEnabled&&a.setTexture("lightmapSampler",this._lightmapTexture),this._specularTexture&&s.SpecularTextureEnabled&&a.setTexture("specularSampler",this._specularTexture),this._bumpTexture&&r.getEngine().getCaps().standardDerivatives&&s.BumpTextureEnabled&&a.setTexture("bumpSampler",this._bumpTexture),this._refractionTexture&&s.RefractionTextureEnabled&&(this._refractionTexture.isCube?a.setTexture("refractionCubeSampler",this._refractionTexture):a.setTexture("refraction2DSampler",this._refractionTexture))),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(a),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),zi(a,this,r),this.bindEyePosition(a)}else r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);(l||!this.isFrozen)&&(r.lightsEnabled&&!this._disableLighting&&Zc(r,t,a,n,this._maxSimultaneousLights),(r.fogEnabled&&t.applyFog&&r.fogMode!==ze.FOGMODE_NONE||this._reflectionTexture||this._refractionTexture||t.receiveShadows||n.PREPASS||n.CLUSTLIGHT_BATCH)&&this.bindView(a),wn(r,t,a),n.NUM_MORPH_INFLUENCERS&&lr(t,a),n.BAKED_VERTEX_ANIMATION_TEXTURE&&t.bakedVertexAnimationManager?.bind(a,n.INSTANCES),this.useLogarithmicDepth&&Ln(n,a,r),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect,i),c.update()}getAnimatables(){let e=super.getAnimatables();return this._diffuseTexture&&this._diffuseTexture.animations&&this._diffuseTexture.animations.length>0&&e.push(this._diffuseTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._specularTexture&&this._specularTexture.animations&&this._specularTexture.animations.length>0&&e.push(this._specularTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture),e}getActiveTextures(){let e=super.getActiveTextures();return this._diffuseTexture&&e.push(this._diffuseTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._specularTexture&&e.push(this._specularTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),this._refractionTexture&&e.push(this._refractionTexture),e}hasTexture(e){return!!(super.hasTexture(e)||this._diffuseTexture===e||this._ambientTexture===e||this._opacityTexture===e||this._reflectionTexture===e||this._emissiveTexture===e||this._specularTexture===e||this._bumpTexture===e||this._lightmapTexture===e||this._refractionTexture===e)}dispose(e,t){t&&(this._diffuseTexture?.dispose(),this._ambientTexture?.dispose(),this._opacityTexture?.dispose(),this._reflectionTexture?.dispose(),this._emissiveTexture?.dispose(),this._specularTexture?.dispose(),this._bumpTexture?.dispose(),this._lightmapTexture?.dispose(),this._refractionTexture?.dispose()),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t)}clone(e,t=!0,i=""){let r=_e.Clone(()=>new s(e,this.getScene()),this,{cloneTexturesOnlyOnce:t});return r.name=e,r.id=e,this.stencil.copyTo(r.stencil),this._clonePlugins(r,i),r}static Parse(e,t,i){let r=_e.Parse(()=>new s(e.name,t),e,t,i);return e.stencil&&r.stencil.parse(e.stencil,t,i),Q._ParsePlugins(e,r,t,i),r}static get DiffuseTextureEnabled(){return X.DiffuseTextureEnabled}static set DiffuseTextureEnabled(e){X.DiffuseTextureEnabled=e}static get DetailTextureEnabled(){return X.DetailTextureEnabled}static set DetailTextureEnabled(e){X.DetailTextureEnabled=e}static get AmbientTextureEnabled(){return X.AmbientTextureEnabled}static set AmbientTextureEnabled(e){X.AmbientTextureEnabled=e}static get OpacityTextureEnabled(){return X.OpacityTextureEnabled}static set OpacityTextureEnabled(e){X.OpacityTextureEnabled=e}static get ReflectionTextureEnabled(){return X.ReflectionTextureEnabled}static set ReflectionTextureEnabled(e){X.ReflectionTextureEnabled=e}static get EmissiveTextureEnabled(){return X.EmissiveTextureEnabled}static set EmissiveTextureEnabled(e){X.EmissiveTextureEnabled=e}static get SpecularTextureEnabled(){return X.SpecularTextureEnabled}static set SpecularTextureEnabled(e){X.SpecularTextureEnabled=e}static get BumpTextureEnabled(){return X.BumpTextureEnabled}static set BumpTextureEnabled(e){X.BumpTextureEnabled=e}static get LightmapTextureEnabled(){return X.LightmapTextureEnabled}static set LightmapTextureEnabled(e){X.LightmapTextureEnabled=e}static get RefractionTextureEnabled(){return X.RefractionTextureEnabled}static set RefractionTextureEnabled(e){X.RefractionTextureEnabled=e}static get ColorGradingTextureEnabled(){return X.ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(e){X.ColorGradingTextureEnabled=e}static get FresnelEnabled(){return X.FresnelEnabled}static set FresnelEnabled(e){X.FresnelEnabled=e}};Se.ForceGLSL=!1;x([He("diffuseTexture")],Se.prototype,"_diffuseTexture",void 0);x([z("_markAllSubMeshesAsTexturesAndMiscDirty")],Se.prototype,"diffuseTexture",void 0);x([He("ambientTexture")],Se.prototype,"_ambientTexture",void 0);x([z("_markAllSubMeshesAsTexturesDirty")],Se.prototype,"ambientTexture",void 0);x([He("opacityTexture")],Se.prototype,"_opacityTexture",void 0);x([z("_markAllSubMeshesAsTexturesAndMiscDirty")],Se.prototype,"opacityTexture",void 0);x([He("reflectionTexture")],Se.prototype,"_reflectionTexture",void 0);x([z("_markAllSubMeshesAsTexturesDirty")],Se.prototype,"reflectionTexture",void 0);x([He("emissiveTexture")],Se.prototype,"_emissiveTexture",void 0);x([z("_markAllSubMeshesAsTexturesDirty")],Se.prototype,"emissiveTexture",void 0);x([He("specularTexture")],Se.prototype,"_specularTexture",void 0);x([z("_markAllSubMeshesAsTexturesDirty")],Se.prototype,"specularTexture",void 0);x([He("bumpTexture")],Se.prototype,"_bumpTexture",void 0);x([z("_markAllSubMeshesAsTexturesDirty")],Se.prototype,"bumpTexture",void 0);x([He("lightmapTexture")],Se.prototype,"_lightmapTexture",void 0);x([z("_markAllSubMeshesAsTexturesDirty")],Se.prototype,"lightmapTexture",void 0);x([He("refractionTexture")],Se.prototype,"_refractionTexture",void 0);x([z("_markAllSubMeshesAsTexturesDirty")],Se.prototype,"refractionTexture",void 0);x([zt("ambient")],Se.prototype,"ambientColor",void 0);x([zt("diffuse")],Se.prototype,"diffuseColor",void 0);x([zt("specular")],Se.prototype,"specularColor",void 0);x([zt("emissive")],Se.prototype,"emissiveColor",void 0);x([y()],Se.prototype,"specularPower",void 0);x([y("useAlphaFromDiffuseTexture")],Se.prototype,"_useAlphaFromDiffuseTexture",void 0);x([z("_markAllSubMeshesAsTexturesAndMiscDirty")],Se.prototype,"useAlphaFromDiffuseTexture",void 0);x([y("useEmissiveAsIllumination")],Se.prototype,"_useEmissiveAsIllumination",void 0);x([z("_markAllSubMeshesAsTexturesDirty")],Se.prototype,"useEmissiveAsIllumination",void 0);x([y("linkEmissiveWithDiffuse")],Se.prototype,"_linkEmissiveWithDiffuse",void 0);x([z("_markAllSubMeshesAsTexturesDirty")],Se.prototype,"linkEmissiveWithDiffuse",void 0);x([y("useSpecularOverAlpha")],Se.prototype,"_useSpecularOverAlpha",void 0);x([z("_markAllSubMeshesAsTexturesDirty")],Se.prototype,"useSpecularOverAlpha",void 0);x([y("useReflectionOverAlpha")],Se.prototype,"_useReflectionOverAlpha",void 0);x([z("_markAllSubMeshesAsTexturesDirty")],Se.prototype,"useReflectionOverAlpha",void 0);x([y("disableLighting")],Se.prototype,"_disableLighting",void 0);x([z("_markAllSubMeshesAsLightsDirty")],Se.prototype,"disableLighting",void 0);x([y("useObjectSpaceNormalMap")],Se.prototype,"_useObjectSpaceNormalMap",void 0);x([z("_markAllSubMeshesAsTexturesDirty")],Se.prototype,"useObjectSpaceNormalMap",void 0);x([y("useParallax")],Se.prototype,"_useParallax",void 0);x([z("_markAllSubMeshesAsTexturesDirty")],Se.prototype,"useParallax",void 0);x([y("useParallaxOcclusion")],Se.prototype,"_useParallaxOcclusion",void 0);x([z("_markAllSubMeshesAsTexturesDirty")],Se.prototype,"useParallaxOcclusion",void 0);x([y()],Se.prototype,"parallaxScaleBias",void 0);x([y("roughness")],Se.prototype,"_roughness",void 0);x([z("_markAllSubMeshesAsTexturesDirty")],Se.prototype,"roughness",void 0);x([y()],Se.prototype,"indexOfRefraction",void 0);x([y()],Se.prototype,"invertRefractionY",void 0);x([y()],Se.prototype,"alphaCutOff",void 0);x([y("useLightmapAsShadowmap")],Se.prototype,"_useLightmapAsShadowmap",void 0);x([z("_markAllSubMeshesAsTexturesDirty")],Se.prototype,"useLightmapAsShadowmap",void 0);x([gc("diffuseFresnelParameters")],Se.prototype,"_diffuseFresnelParameters",void 0);x([z("_markAllSubMeshesAsFresnelDirty")],Se.prototype,"diffuseFresnelParameters",void 0);x([gc("opacityFresnelParameters")],Se.prototype,"_opacityFresnelParameters",void 0);x([z("_markAllSubMeshesAsFresnelAndMiscDirty")],Se.prototype,"opacityFresnelParameters",void 0);x([gc("reflectionFresnelParameters")],Se.prototype,"_reflectionFresnelParameters",void 0);x([z("_markAllSubMeshesAsFresnelDirty")],Se.prototype,"reflectionFresnelParameters",void 0);x([gc("refractionFresnelParameters")],Se.prototype,"_refractionFresnelParameters",void 0);x([z("_markAllSubMeshesAsFresnelDirty")],Se.prototype,"refractionFresnelParameters",void 0);x([gc("emissiveFresnelParameters")],Se.prototype,"_emissiveFresnelParameters",void 0);x([z("_markAllSubMeshesAsFresnelDirty")],Se.prototype,"emissiveFresnelParameters",void 0);x([y("useReflectionFresnelFromSpecular")],Se.prototype,"_useReflectionFresnelFromSpecular",void 0);x([z("_markAllSubMeshesAsFresnelDirty")],Se.prototype,"useReflectionFresnelFromSpecular",void 0);x([y("useGlossinessFromSpecularMapAlpha")],Se.prototype,"_useGlossinessFromSpecularMapAlpha",void 0);x([z("_markAllSubMeshesAsTexturesDirty")],Se.prototype,"useGlossinessFromSpecularMapAlpha",void 0);x([y("maxSimultaneousLights")],Se.prototype,"_maxSimultaneousLights",void 0);x([z("_markAllSubMeshesAsLightsDirty")],Se.prototype,"maxSimultaneousLights",void 0);x([y("invertNormalMapX")],Se.prototype,"_invertNormalMapX",void 0);x([z("_markAllSubMeshesAsTexturesDirty")],Se.prototype,"invertNormalMapX",void 0);x([y("invertNormalMapY")],Se.prototype,"_invertNormalMapY",void 0);x([z("_markAllSubMeshesAsTexturesDirty")],Se.prototype,"invertNormalMapY",void 0);x([y("twoSidedLighting")],Se.prototype,"_twoSidedLighting",void 0);x([z("_markAllSubMeshesAsTexturesDirty")],Se.prototype,"twoSidedLighting",void 0);x([y("applyDecalMapAfterDetailMap")],Se.prototype,"_applyDecalMapAfterDetailMap",void 0);x([z("_markAllSubMeshesAsMiscDirty")],Se.prototype,"applyDecalMapAfterDetailMap",void 0);G("BABYLON.StandardMaterial",Se);ze.DefaultMaterialFactory=s=>new Se("default material",s)});var ac,KX=S(()=>{it();Ut();nc();ac=class s{constructor(){this.materials=[]}parseMTL(e,t,i,r){if(t instanceof ArrayBuffer)return;let n=t.split(`
`),a=/\s+/,o,l=null;for(let c=0;c<n.length;c++){let f=n[c].trim();if(f.length===0||f.charAt(0)==="#")continue;let h=f.indexOf(" "),u=h>=0?f.substring(0,h):f;u=u.toLowerCase();let d=h>=0?f.substring(h+1).trim():"";if(u==="newmtl")l&&this.materials.push(l),e._blockEntityCollection=!!r,l=new Se(d,e),l._parentContainer=r,e._blockEntityCollection=!1;else if(u==="kd"&&l)o=d.split(a,3).map(parseFloat),l.diffuseColor=j.FromArray(o);else if(u==="ka"&&l)o=d.split(a,3).map(parseFloat),l.ambientColor=j.FromArray(o);else if(u==="ks"&&l)o=d.split(a,3).map(parseFloat),l.specularColor=j.FromArray(o);else if(u==="ke"&&l)o=d.split(a,3).map(parseFloat),l.emissiveColor=j.FromArray(o);else if(u==="ns"&&l)l.specularPower=parseFloat(d);else if(u==="d"&&l)l.alpha=parseFloat(d);else if(u==="map_ka"&&l)l.ambientTexture=s._GetTexture(i,d,e);else if(u==="map_kd"&&l)l.diffuseTexture=s._GetTexture(i,d,e);else if(u==="map_ks"&&l)l.specularTexture=s._GetTexture(i,d,e);else if(u!=="map_ns")if(u==="map_bump"&&l){let p=d.split(a),m=p.indexOf("-bm"),_=null;m>=0&&(_=p[m+1],p.splice(m,2)),l.bumpTexture=s._GetTexture(i,p.join(" "),e),l.bumpTexture&&_!==null&&(l.bumpTexture.level=parseFloat(_))}else u==="map_d"&&l&&(l.opacityTexture=s._GetTexture(i,d,e))}l&&this.materials.push(l)}static _GetTexture(e,t,i){if(!t)return null;let r=e;if(e==="file:"){let n=t.lastIndexOf("\\");n===-1&&(n=t.lastIndexOf("/")),n>-1?r+=t.substring(n+1):r+=t}else r+=t;return new H(r,i,!1,s.INVERT_TEXTURE_Y)}};ac.INVERT_TEXTURE_Y=!0});var xi,qX=S(()=>{yt();nc();it();ie();ou();Ki();ln();Ee();xi=class s{constructor(e,t,i){this._positions=[],this._normals=[],this._uvs=[],this._colors=[],this._extColors=[],this._meshesFromObj=[],this._indicesForBabylon=[],this._wrappedPositionForBabylon=[],this._wrappedUvsForBabylon=[],this._wrappedColorsForBabylon=[],this._wrappedNormalsForBabylon=[],this._tuplePosNorm=[],this._curPositionInIndices=0,this._hasMeshes=!1,this._unwrappedPositionsForBabylon=[],this._unwrappedColorsForBabylon=[],this._unwrappedNormalsForBabylon=[],this._unwrappedUVForBabylon=[],this._triangles=[],this._materialNameFromObj="",this._objMeshName="",this._increment=1,this._isFirstMaterial=!0,this._grayColor=new me(.5,.5,.5,1),this._hasLineData=!1,this._materialToUse=e,this._babylonMeshesArray=t,this._loadingOptions=i}_isInArray(e,t){e[t[0]]||(e[t[0]]={normals:[],idx:[]});let i=e[t[0]].normals.indexOf(t[1]);return i===-1?-1:e[t[0]].idx[i]}_isInArrayUV(e,t){e[t[0]]||(e[t[0]]={normals:[],idx:[],uv:[]});let i=e[t[0]].normals.indexOf(t[1]);return i!=1&&t[2]===e[t[0]].uv[i]?e[t[0]].idx[i]:-1}_setData(e,t,i,r,n,a,o){let l;this._loadingOptions.optimizeWithUV?l=this._isInArrayUV(this._tuplePosNorm,[e,i,t]):l=this._isInArray(this._tuplePosNorm,[e,i]),l===-1?(this._indicesForBabylon.push(this._wrappedPositionForBabylon.length),this._wrappedPositionForBabylon.push(r),n=n??new he(0,0),this._wrappedUvsForBabylon.push(n),this._wrappedNormalsForBabylon.push(a),o!==void 0&&this._wrappedColorsForBabylon.push(o),this._tuplePosNorm[e].normals.push(i),this._tuplePosNorm[e].idx.push(this._curPositionInIndices++),this._loadingOptions.optimizeWithUV&&this._tuplePosNorm[e].uv.push(t)):this._indicesForBabylon.push(l)}_unwrapData(){try{for(let e=0;e<this._wrappedPositionForBabylon.length;e++)this._unwrappedPositionsForBabylon.push(this._wrappedPositionForBabylon[e].x*this._handednessSign,this._wrappedPositionForBabylon[e].y,this._wrappedPositionForBabylon[e].z),this._unwrappedNormalsForBabylon.push(this._wrappedNormalsForBabylon[e].x*this._handednessSign,this._wrappedNormalsForBabylon[e].y,this._wrappedNormalsForBabylon[e].z),this._unwrappedUVForBabylon.push(this._wrappedUvsForBabylon[e].x,this._wrappedUvsForBabylon[e].y),this._loadingOptions.importVertexColors&&this._unwrappedColorsForBabylon.push(this._wrappedColorsForBabylon[e].r,this._wrappedColorsForBabylon[e].g,this._wrappedColorsForBabylon[e].b,this._wrappedColorsForBabylon[e].a);this._wrappedPositionForBabylon.length=0,this._wrappedNormalsForBabylon.length=0,this._wrappedUvsForBabylon.length=0,this._wrappedColorsForBabylon.length=0,this._tuplePosNorm.length=0,this._curPositionInIndices=0}catch{throw new Error("Unable to unwrap data while parsing OBJ data.")}}_getTriangles(e,t){for(let i=t;i<e.length-1;i++)this._pushTriangle(e,i)}_getColor(e){if(this._loadingOptions.importVertexColors)return this._extColors[e]??this._colors[e]}_setDataForCurrentFaceWithPattern1(e,t){this._getTriangles(e,t);for(let i=0;i<this._triangles.length;i++){let r=parseInt(this._triangles[i])-1;this._setData(r,0,0,this._positions[r],he.Zero(),E.Up(),this._getColor(r))}this._triangles.length=0}_setDataForCurrentFaceWithPattern2(e,t){this._getTriangles(e,t);for(let i=0;i<this._triangles.length;i++){let r=this._triangles[i].split("/"),n=parseInt(r[0])-1,a=parseInt(r[1])-1;this._setData(n,a,0,this._positions[n],this._uvs[a]??he.Zero(),E.Up(),this._getColor(n))}this._triangles.length=0}_setDataForCurrentFaceWithPattern3(e,t){this._getTriangles(e,t);for(let i=0;i<this._triangles.length;i++){let r=this._triangles[i].split("/"),n=parseInt(r[0])-1,a=parseInt(r[1])-1,o=parseInt(r[2])-1;this._setData(n,a,o,this._positions[n],this._uvs[a]??he.Zero(),this._normals[o]??E.Up())}this._triangles.length=0}_setDataForCurrentFaceWithPattern4(e,t){this._getTriangles(e,t);for(let i=0;i<this._triangles.length;i++){let r=this._triangles[i].split("//"),n=parseInt(r[0])-1,a=parseInt(r[1])-1;this._setData(n,1,a,this._positions[n],he.Zero(),this._normals[a],this._getColor(n))}this._triangles.length=0}_setDataForCurrentFaceWithPattern5(e,t){this._getTriangles(e,t);for(let i=0;i<this._triangles.length;i++){let r=this._triangles[i].split("/"),n=this._positions.length+parseInt(r[0]),a=this._uvs.length+parseInt(r[1]),o=this._normals.length+parseInt(r[2]);this._setData(n,a,o,this._positions[n],this._uvs[a],this._normals[o],this._getColor(n))}this._triangles.length=0}_addPreviousObjMesh(){this._meshesFromObj.length>0&&(this._handledMesh=this._meshesFromObj[this._meshesFromObj.length-1],this._unwrapData(),this._loadingOptions.useLegacyBehavior&&this._indicesForBabylon.reverse(),this._handledMesh.indices=this._indicesForBabylon.slice(),this._handledMesh.positions=this._unwrappedPositionsForBabylon.slice(),this._handledMesh.normals=this._unwrappedNormalsForBabylon.slice(),this._handledMesh.uvs=this._unwrappedUVForBabylon.slice(),this._handledMesh.hasLines=this._hasLineData,this._loadingOptions.importVertexColors&&(this._handledMesh.colors=this._unwrappedColorsForBabylon.slice()),this._indicesForBabylon.length=0,this._unwrappedPositionsForBabylon.length=0,this._unwrappedColorsForBabylon.length=0,this._unwrappedNormalsForBabylon.length=0,this._unwrappedUVForBabylon.length=0,this._hasLineData=!1)}_optimizeNormals(e){let t=e.getVerticesData(A.PositionKind),i=e.getVerticesData(A.NormalKind),r={};if(!t||!i)return;for(let a=0;a<t.length/3;a++){let o=t[a*3+0],l=t[a*3+1],c=t[a*3+2],f=o+"_"+l+"_"+c,h=r[f];h||(h=[],r[f]=h),h.push(a)}let n=new E;for(let a in r){let o=r[a];if(o.length<2)continue;let l=o[0];for(let c=1;c<o.length;++c){let f=o[c];i[l*3+0]+=i[f*3+0],i[l*3+1]+=i[f*3+1],i[l*3+2]+=i[f*3+2]}n.copyFromFloats(i[l*3+0],i[l*3+1],i[l*3+2]),n.normalize();for(let c=0;c<o.length;++c){let f=o[c];i[f*3+0]=n.x,i[f*3+1]=n.y,i[f*3+2]=n.z}}e.setVerticesData(A.NormalKind,i)}static _IsLineElement(e){return e.startsWith("l")}static _IsObjectElement(e){return e.startsWith("o")}static _IsGroupElement(e){return e.startsWith("g")}static _GetZbrushMRGB(e,t){if(!e.startsWith("mrgb"))return null;if(e=e.replace("mrgb","").trim(),t)return[];let i=/[a-z0-9]/g,r=e.match(i);if(!r||r.length%8!==0)return[];let n=[];for(let a=0;a<r.length/8;a++){let o=r[a*8+2]+r[a*8+3],l=r[a*8+4]+r[a*8+5],c=r[a*8+6]+r[a*8+7];n.push(new me(parseInt(o,16)/255,parseInt(l,16)/255,parseInt(c,16)/255,1))}return n}parse(e,t,i,r,n){t=t.replace(/#MRGB/g,"mrgb"),t=t.replace(/#.*$/gm,"").trim(),this._loadingOptions.useLegacyBehavior?(this._pushTriangle=(f,h)=>this._triangles.push(f[0],f[h],f[h+1]),this._handednessSign=1):i.useRightHandedSystem?(this._pushTriangle=(f,h)=>this._triangles.push(f[0],f[h+1],f[h]),this._handednessSign=1):(this._pushTriangle=(f,h)=>this._triangles.push(f[0],f[h],f[h+1]),this._handednessSign=-1);let a=t.split(`
`),o=[],l=[];o.push(l);for(let f=0;f<a.length;f++){let h=a[f].trim().replace(/\s\s/g," ");if(!(h.length===0||h.charAt(0)==="#"))if((s._IsGroupElement(h)||s._IsObjectElement(h))&&(l=[],o.push(l)),s._IsLineElement(h)){let u=h.split(" ");for(let d=1;d<u.length-1;d++)l.push(`l ${u[d]} ${u[d+1]}`)}else l.push(h)}let c=o.flat();for(let f=0;f<c.length;f++){let h=c[f].trim().replace(/\s\s/g," "),u;if(!(h.length===0||h.charAt(0)==="#"))if(s.VertexPattern.test(h)){if(u=h.match(/[^ ]+/g),this._positions.push(new E(parseFloat(u[1]),parseFloat(u[2]),parseFloat(u[3]))),this._loadingOptions.importVertexColors)if(u.length>=7){let d=parseFloat(u[4]),p=parseFloat(u[5]),m=parseFloat(u[6]);this._colors.push(new me(d>1?d/255:d,p>1?p/255:p,m>1?m/255:m,u.length===7||u[7]===void 0?1:parseFloat(u[7])))}else this._colors.push(this._grayColor)}else if((u=s.NormalPattern.exec(h))!==null)this._normals.push(new E(parseFloat(u[1]),parseFloat(u[2]),parseFloat(u[3])));else if((u=s.UVPattern.exec(h))!==null)this._uvs.push(new he(parseFloat(u[1])*this._loadingOptions.UVScaling.x,parseFloat(u[2])*this._loadingOptions.UVScaling.y));else if((u=s.FacePattern3.exec(h))!==null)this._setDataForCurrentFaceWithPattern3(u[1].trim().split(" "),1);else if((u=s.FacePattern4.exec(h))!==null)this._setDataForCurrentFaceWithPattern4(u[1].trim().split(" "),1);else if((u=s.FacePattern5.exec(h))!==null)this._setDataForCurrentFaceWithPattern5(u[1].trim().split(" "),1);else if((u=s.FacePattern2.exec(h))!==null)this._setDataForCurrentFaceWithPattern2(u[1].trim().split(" "),1);else if((u=s.FacePattern1.exec(h))!==null)this._setDataForCurrentFaceWithPattern1(u[1].trim().split(" "),1);else if((u=s.LinePattern1.exec(h))!==null)this._setDataForCurrentFaceWithPattern1(u[1].trim().split(" "),0),this._hasLineData=!0;else if((u=s.LinePattern2.exec(h))!==null)this._setDataForCurrentFaceWithPattern2(u[1].trim().split(" "),0),this._hasLineData=!0;else if(u=s._GetZbrushMRGB(h,!this._loadingOptions.importVertexColors))for(let d of u)this._extColors.push(d);else if((u=s.LinePattern3.exec(h))!==null)this._setDataForCurrentFaceWithPattern3(u[1].trim().split(" "),0),this._hasLineData=!0;else if(s.GroupDescriptor.test(h)||s.ObjectDescriptor.test(h)){let d={name:h.substring(2).trim(),indices:null,positions:null,normals:null,uvs:null,colors:null,materialName:this._materialNameFromObj,isObject:s.ObjectDescriptor.test(h)};this._addPreviousObjMesh(),this._meshesFromObj.push(d),this._hasMeshes=!0,this._isFirstMaterial=!0,this._increment=1}else if(s.UseMtlDescriptor.test(h)){if(this._materialNameFromObj=h.substring(7).trim(),!this._isFirstMaterial||!this._hasMeshes){this._addPreviousObjMesh();let d={name:(this._objMeshName||"mesh")+"_mm"+this._increment.toString(),indices:null,positions:null,normals:null,uvs:null,colors:null,materialName:this._materialNameFromObj,isObject:!1};this._increment++,this._meshesFromObj.push(d),this._hasMeshes=!0}this._hasMeshes&&this._isFirstMaterial&&(this._meshesFromObj[this._meshesFromObj.length-1].materialName=this._materialNameFromObj,this._isFirstMaterial=!1)}else s.MtlLibGroupDescriptor.test(h)?n(h.substring(7).trim()):s.SmoothDescriptor.test(h)||P.Log("Unhandled expression at line : "+h)}if(this._hasMeshes&&(this._handledMesh=this._meshesFromObj[this._meshesFromObj.length-1],this._loadingOptions.useLegacyBehavior&&this._indicesForBabylon.reverse(),this._unwrapData(),this._handledMesh.indices=this._indicesForBabylon,this._handledMesh.positions=this._unwrappedPositionsForBabylon,this._handledMesh.normals=this._unwrappedNormalsForBabylon,this._handledMesh.uvs=this._unwrappedUVForBabylon,this._handledMesh.hasLines=this._hasLineData,this._loadingOptions.importVertexColors&&(this._handledMesh.colors=this._unwrappedColorsForBabylon)),!this._hasMeshes){let f=null;if(this._indicesForBabylon.length)this._loadingOptions.useLegacyBehavior&&this._indicesForBabylon.reverse(),this._unwrapData();else{for(let h of this._positions)this._unwrappedPositionsForBabylon.push(h.x,h.y,h.z);if(this._normals.length)for(let h of this._normals)this._unwrappedNormalsForBabylon.push(h.x,h.y,h.z);if(this._uvs.length)for(let h of this._uvs)this._unwrappedUVForBabylon.push(h.x,h.y);if(this._extColors.length)for(let h of this._extColors)this._unwrappedColorsForBabylon.push(h.r,h.g,h.b,h.a);else if(this._colors.length)for(let h of this._colors)this._unwrappedColorsForBabylon.push(h.r,h.g,h.b,h.a);this._materialNameFromObj||(f=new Se(mi.RandomId(),i),f.pointsCloud=!0,this._materialNameFromObj=f.name,this._normals.length||(f.disableLighting=!0,f.emissiveColor=j.White()))}this._meshesFromObj.push({name:mi.RandomId(),indices:this._indicesForBabylon,positions:this._unwrappedPositionsForBabylon,colors:this._unwrappedColorsForBabylon,normals:this._unwrappedNormalsForBabylon,uvs:this._unwrappedUVForBabylon,materialName:this._materialNameFromObj,directMaterial:f,isObject:!0,hasLines:this._hasLineData})}for(let f=0;f<this._meshesFromObj.length;f++){if(e&&this._meshesFromObj[f].name){if(e instanceof Array){if(e.indexOf(this._meshesFromObj[f].name)===-1)continue}else if(this._meshesFromObj[f].name!==e)continue}this._handledMesh=this._meshesFromObj[f],i._blockEntityCollection=!!r;let h=new fe(this._meshesFromObj[f].name,i);if(h._parentContainer=r,i._blockEntityCollection=!1,this._handledMesh._babylonMesh=h,!this._handledMesh.isObject){for(let d=f-1;d>=0;--d)if(this._meshesFromObj[d].isObject&&this._meshesFromObj[d]._babylonMesh){h.parent=this._meshesFromObj[d]._babylonMesh;break}}if(this._materialToUse.push(this._meshesFromObj[f].materialName),this._handledMesh.hasLines&&(h._internalMetadata??(h._internalMetadata={}),h._internalMetadata._isLine=!0),this._handledMesh.positions?.length===0){this._babylonMeshesArray.push(h);continue}let u=new Ge;if(u.uvs=this._handledMesh.uvs,u.indices=this._handledMesh.indices,u.positions=this._handledMesh.positions,this._loadingOptions.computeNormals){let d=new Array;Ge.ComputeNormals(this._handledMesh.positions,this._handledMesh.indices,d),u.normals=d}else u.normals=this._handledMesh.normals;this._loadingOptions.importVertexColors&&(u.colors=this._handledMesh.colors),u.applyToMesh(h),this._loadingOptions.invertY&&(h.scaling.y*=-1),this._loadingOptions.optimizeNormals&&this._optimizeNormals(h),this._babylonMeshesArray.push(h),this._handledMesh.directMaterial&&(h.material=this._handledMesh.directMaterial)}}};xi.ObjectDescriptor=/^o/;xi.GroupDescriptor=/^g/;xi.MtlLibGroupDescriptor=/^mtllib /;xi.UseMtlDescriptor=/^usemtl /;xi.SmoothDescriptor=/^s /;xi.VertexPattern=/^v(\s+[\d|.|+|\-|e|E]+){3,7}/;xi.NormalPattern=/^vn(\s+[\d|.|+|\-|e|E]+)( +[\d|.|+|\-|e|E]+)( +[\d|.|+|\-|e|E]+)/;xi.UVPattern=/^vt(\s+[\d|.|+|\-|e|E]+)( +[\d|.|+|\-|e|E]+)/;xi.FacePattern1=/^f\s+(([\d]{1,}[\s]?){3,})+/;xi.FacePattern2=/^f\s+((([\d]{1,}\/[\d]{1,}[\s]?){3,})+)/;xi.FacePattern3=/^f\s+((([\d]{1,}\/[\d]{1,}\/[\d]{1,}[\s]?){3,})+)/;xi.FacePattern4=/^f\s+((([\d]{1,}\/\/[\d]{1,}[\s]?){3,})+)/;xi.FacePattern5=/^f\s+(((-[\d]{1,}\/-[\d]{1,}\/-[\d]{1,}[\s]?){3,})+)/;xi.LinePattern1=/^l\s+(([\d]{1,}[\s]?){2,})+/;xi.LinePattern2=/^l\s+((([\d]{1,}\/[\d]{1,}[\s]?){2,})+)/;xi.LinePattern3=/^l\s+((([\d]{1,}\/[\d]{1,}\/[\d]{1,}[\s]?){2,})+)/});var QX={};V(QX,{OBJFileLoader:()=>ds});var ds,jX=S(()=>{ie();$e();Qo();Gf();QI();KX();qX();nc();ds=class s{static get INVERT_TEXTURE_Y(){return ac.INVERT_TEXTURE_Y}static set INVERT_TEXTURE_Y(e){ac.INVERT_TEXTURE_Y=e}constructor(e){this.name=Vl.name,this.extensions=Vl.extensions,this._assetContainer=null,this._loadingOptions={...s._DefaultLoadingOptions,...e??{}}}static get _DefaultLoadingOptions(){return{computeNormals:s.COMPUTE_NORMALS,optimizeNormals:s.OPTIMIZE_NORMALS,importVertexColors:s.IMPORT_VERTEX_COLORS,invertY:s.INVERT_Y,invertTextureY:s.INVERT_TEXTURE_Y,UVScaling:s.UV_SCALING,materialLoadingFailsSilently:s.MATERIAL_LOADING_FAILS_SILENTLY,optimizeWithUV:s.OPTIMIZE_WITH_UV,skipMaterials:s.SKIP_MATERIALS,useLegacyBehavior:s.USE_LEGACY_BEHAVIOR}}_loadMTL(e,t,i,r){let n=t+e;W.LoadFile(n,i,void 0,void 0,!1,(a,o)=>{r(n,o)})}createPlugin(e){return new s(e[Vl.name])}canDirectLoad(){return!1}importMeshAsync(e,t,i,r){return this._parseSolidAsync(e,t,i,r).then(n=>({meshes:n,particleSystems:[],skeletons:[],animationGroups:[],transformNodes:[],geometries:[],lights:[],spriteManagers:[]}))}loadAsync(e,t,i){return this.importMeshAsync(null,e,t,i).then(()=>{})}loadAssetContainerAsync(e,t,i){let r=new Bs(e);return this._assetContainer=r,this.importMeshAsync(null,e,t,i).then(n=>(n.meshes.forEach(a=>r.meshes.push(a)),n.meshes.forEach(a=>{let o=a.material;o&&r.materials.indexOf(o)==-1&&(r.materials.push(o),o.getActiveTextures().forEach(c=>{r.textures.indexOf(c)==-1&&r.textures.push(c)}))}),this._assetContainer=null,r)).catch(n=>{throw this._assetContainer=null,n})}_parseSolidAsync(e,t,i,r){let n="",a=new ac,o=[],l=[];i=i.replace(/#.*$/gm,"").trim(),new xi(o,l,this._loadingOptions).parse(e,i,t,this._assetContainer,h=>{n=h});let f=[];return n!==""&&!this._loadingOptions.skipMaterials&&f.push(new Promise((h,u)=>{this._loadMTL(n,r,d=>{try{a.parseMTL(t,d,r,this._assetContainer);for(let p=0;p<a.materials.length;p++){let m=0,_=[],v;for(;(v=o.indexOf(a.materials[p].name,m))>-1;)_.push(v),m=v+1;if(v===-1&&_.length===0)a.materials[p].dispose();else for(let T=0;T<_.length;T++){let C=l[_[T]],I=a.materials[p];C.material=I,C.getTotalIndices()||(I.pointsCloud=!0)}}h()}catch(p){W.Warn(`Error processing MTL file: '${n}'`),this._loadingOptions.materialLoadingFailsSilently?h():u(p)}},(d,p)=>{W.Warn(`Error downloading MTL file: '${n}'`),this._loadingOptions.materialLoadingFailsSilently?h():u(p)})})),Promise.all(f).then(()=>{let h=u=>!!(u._internalMetadata?._isLine??!1);return l.forEach(u=>{if(h(u)){let d=u.material??new Se(u.name+"_line",t);d.getBindedMeshes().filter(m=>!h(m)).length>0&&(d=d.clone(d.name+"_line")??d),d.wireframe=!0,u.material=d,u._internalMetadata&&(u._internalMetadata._isLine=void 0)}}),l})}};ds.OPTIMIZE_WITH_UV=!0;ds.INVERT_Y=!1;ds.IMPORT_VERTEX_COLORS=!1;ds.COMPUTE_NORMALS=!1;ds.OPTIMIZE_NORMALS=!1;ds.UV_SCALING=new he(1,1);ds.SKIP_MATERIALS=!1;ds.MATERIAL_LOADING_FAILS_SILENTLY=!0;ds.USE_LEGACY_BEHAVIOR=!1;$i(new ds)});var ZX,hie,JX=S(()=>{O();Tu();xu();ZX="gaussianSplattingFragmentDeclaration",hie=`vec4 gaussianColor(vec4 inColor)
{float A=-dot(vPosition,vPosition);if (A<-4.0) discard;float B=exp(A)*inColor.a;
#include<logDepthFragment>
vec3 color=inColor.rgb;
#ifdef FOG
#include<fogFragment>
#endif
return vec4(color,B);}
`;g.IncludesShadersStore[ZX]||(g.IncludesShadersStore[ZX]=hie)});var e5={};V(e5,{gaussianSplattingPixelShader:()=>uie});var W0,$X,uie,H0=S(()=>{O();Da();Xa();Eu();JX();Oa();W0="gaussianSplattingPixelShader",$X=`#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
varying vec4 vColor;varying vec2 vPosition;
#include<gaussianSplattingFragmentDeclaration>
void main () { 
#include<clipPlaneFragment>
gl_FragColor=gaussianColor(vColor);}
`;g.ShadersStore[W0]||(g.ShadersStore[W0]=$X);uie={name:W0,shader:$X}});var t5,die,i5=S(()=>{O();t5="gaussianSplattingVertexDeclaration",die="attribute vec2 position;uniform mat4 view;uniform mat4 projection;uniform mat4 world;uniform vec4 vEyePosition;";g.IncludesShadersStore[t5]||(g.IncludesShadersStore[t5]=die)});var r5,pie,s5=S(()=>{O();Ml();qh();r5="gaussianSplattingUboDeclaration",pie=`#include<sceneUboDeclaration>
#include<meshUboDeclaration>
attribute vec2 position;`;g.IncludesShadersStore[r5]||(g.IncludesShadersStore[r5]=pie)});var n5,mie,a5=S(()=>{O();n5="gaussianSplatting",mie=`#if !defined(WEBGL2) && !defined(WEBGPU) && !defined(NATIVE)
mat3 transpose(mat3 matrix) {return mat3(matrix[0][0],matrix[1][0],matrix[2][0],
matrix[0][1],matrix[1][1],matrix[2][1],
matrix[0][2],matrix[1][2],matrix[2][2]);}
#endif
vec2 getDataUV(float index,vec2 textureSize) {float y=floor(index/textureSize.x);float x=index-y*textureSize.x;return vec2((x+0.5)/textureSize.x,(y+0.5)/textureSize.y);}
#if SH_DEGREE>0
ivec2 getDataUVint(float index,vec2 textureSize) {float y=floor(index/textureSize.x);float x=index-y*textureSize.x;return ivec2(uint(x+0.5),uint(y+0.5));}
#endif
struct Splat {vec4 center;vec4 color;vec4 covA;vec4 covB;
#if SH_DEGREE>0
uvec4 sh0; 
#endif
#if SH_DEGREE>1
uvec4 sh1;
#endif
#if SH_DEGREE>2
uvec4 sh2;
#endif
};Splat readSplat(float splatIndex)
{Splat splat;vec2 splatUV=getDataUV(splatIndex,dataTextureSize);splat.center=texture2D(centersTexture,splatUV);splat.color=texture2D(colorsTexture,splatUV);splat.covA=texture2D(covariancesATexture,splatUV)*splat.center.w;splat.covB=texture2D(covariancesBTexture,splatUV)*splat.center.w;
#if SH_DEGREE>0
ivec2 splatUVint=getDataUVint(splatIndex,dataTextureSize);splat.sh0=texelFetch(shTexture0,splatUVint,0);
#endif
#if SH_DEGREE>1
splat.sh1=texelFetch(shTexture1,splatUVint,0);
#endif
#if SH_DEGREE>2
splat.sh2=texelFetch(shTexture2,splatUVint,0);
#endif
return splat;}
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
vec3 computeColorFromSHDegree(vec3 dir,const vec3 sh[16])
{const float SH_C0=0.28209479;const float SH_C1=0.48860251;float SH_C2[5];SH_C2[0]=1.092548430;SH_C2[1]=-1.09254843;SH_C2[2]=0.315391565;SH_C2[3]=-1.09254843;SH_C2[4]=0.546274215;float SH_C3[7];SH_C3[0]=-0.59004358;SH_C3[1]=2.890611442;SH_C3[2]=-0.45704579;SH_C3[3]=0.373176332;SH_C3[4]=-0.45704579;SH_C3[5]=1.445305721;SH_C3[6]=-0.59004358;vec3 result=/*SH_C0**/sh[0];
#if SH_DEGREE>0
float x=dir.x;float y=dir.y;float z=dir.z;result+=- SH_C1*y*sh[1]+SH_C1*z*sh[2]-SH_C1*x*sh[3];
#if SH_DEGREE>1
float xx=x*x,yy=y*y,zz=z*z;float xy=x*y,yz=y*z,xz=x*z;result+=
SH_C2[0]*xy*sh[4] +
SH_C2[1]*yz*sh[5] +
SH_C2[2]*(2.0*zz-xx-yy)*sh[6] +
SH_C2[3]*xz*sh[7] +
SH_C2[4]*(xx-yy)*sh[8];
#if SH_DEGREE>2
result+=
SH_C3[0]*y*(3.0*xx-yy)*sh[9] +
SH_C3[1]*xy*z*sh[10] +
SH_C3[2]*y*(4.0*zz-xx-yy)*sh[11] +
SH_C3[3]*z*(2.0*zz-3.0*xx-3.0*yy)*sh[12] +
SH_C3[4]*x*(4.0*zz-xx-yy)*sh[13] +
SH_C3[5]*z*(xx-yy)*sh[14] +
SH_C3[6]*x*(xx-3.0*yy)*sh[15];
#endif
#endif
#endif
return result;}
vec4 decompose(uint value)
{vec4 components=vec4(
float((value ) & 255u),
float((value>>uint( 8)) & 255u),
float((value>>uint(16)) & 255u),
float((value>>uint(24)) & 255u));return components*vec4(2./255.)-vec4(1.);}
vec3 computeSH(Splat splat,vec3 dir)
{vec3 sh[16];sh[0]=vec3(0.,0.,0.);
#if SH_DEGREE>0
vec4 sh00=decompose(splat.sh0.x);vec4 sh01=decompose(splat.sh0.y);vec4 sh02=decompose(splat.sh0.z);sh[1]=vec3(sh00.x,sh00.y,sh00.z);sh[2]=vec3(sh00.w,sh01.x,sh01.y);sh[3]=vec3(sh01.z,sh01.w,sh02.x);
#endif
#if SH_DEGREE>1
vec4 sh03=decompose(splat.sh0.w);vec4 sh04=decompose(splat.sh1.x);vec4 sh05=decompose(splat.sh1.y);sh[4]=vec3(sh02.y,sh02.z,sh02.w);sh[5]=vec3(sh03.x,sh03.y,sh03.z);sh[6]=vec3(sh03.w,sh04.x,sh04.y);sh[7]=vec3(sh04.z,sh04.w,sh05.x);sh[8]=vec3(sh05.y,sh05.z,sh05.w);
#endif
#if SH_DEGREE>2
vec4 sh06=decompose(splat.sh1.z);vec4 sh07=decompose(splat.sh1.w);vec4 sh08=decompose(splat.sh2.x);vec4 sh09=decompose(splat.sh2.y);vec4 sh10=decompose(splat.sh2.z);vec4 sh11=decompose(splat.sh2.w);sh[9]=vec3(sh06.x,sh06.y,sh06.z);sh[10]=vec3(sh06.w,sh07.x,sh07.y);sh[11]=vec3(sh07.z,sh07.w,sh08.x);sh[12]=vec3(sh08.y,sh08.z,sh08.w);sh[13]=vec3(sh09.x,sh09.y,sh09.z);sh[14]=vec3(sh09.w,sh10.x,sh10.y);sh[15]=vec3(sh10.z,sh10.w,sh11.x); 
#endif
return computeColorFromSHDegree(dir,sh);}
#else
vec3 computeSH(Splat splat,vec3 dir)
{return vec3(0.,0.,0.);}
#endif
vec4 gaussianSplatting(vec2 meshPos,vec3 worldPos,vec2 scale,vec3 covA,vec3 covB,mat4 worldMatrix,mat4 viewMatrix,mat4 projectionMatrix)
{mat4 modelView=viewMatrix*worldMatrix;vec4 camspace=viewMatrix*vec4(worldPos,1.);vec4 pos2d=projectionMatrix*camspace;float bounds=1.2*pos2d.w;if (pos2d.z<-pos2d.w || pos2d.x<-bounds || pos2d.x>bounds
|| pos2d.y<-bounds || pos2d.y>bounds) {return vec4(0.0,0.0,2.0,1.0);}
mat3 Vrk=mat3(
covA.x,covA.y,covA.z,
covA.y,covB.x,covB.y,
covA.z,covB.y,covB.z
);mat3 J=mat3(
focal.x/camspace.z,0.,-(focal.x*camspace.x)/(camspace.z*camspace.z),
0.,focal.y/camspace.z,-(focal.y*camspace.y)/(camspace.z*camspace.z),
0.,0.,0.
);mat3 invy=mat3(1,0,0,0,-1,0,0,0,1);mat3 T=invy*transpose(mat3(modelView))*J;mat3 cov2d=transpose(T)*Vrk*T;
#if COMPENSATION
float c00=cov2d[0][0];float c11=cov2d[1][1];float c01=cov2d[0][1];float detOrig=c00*c11-c01*c01;
#endif
cov2d[0][0]+=kernelSize;cov2d[1][1]+=kernelSize;
#if COMPENSATION
vec3 c2d=vec3(cov2d[0][0],c01,cov2d[1][1]);float detBlur=c2d.x*c2d.z-c2d.y*c2d.y;float compensation=sqrt(max(0.,detOrig/detBlur));vColor.w*=compensation;
#endif
float mid=(cov2d[0][0]+cov2d[1][1])/2.0;float radius=length(vec2((cov2d[0][0]-cov2d[1][1])/2.0,cov2d[0][1]));float epsilon=0.0001;float lambda1=mid+radius+epsilon,lambda2=mid-radius+epsilon;if (lambda2<0.0)
{return vec4(0.0,0.0,2.0,1.0);}
vec2 diagonalVector=normalize(vec2(cov2d[0][1],lambda1-cov2d[0][0]));vec2 majorAxis=min(sqrt(2.0*lambda1),1024.0)*diagonalVector;vec2 minorAxis=min(sqrt(2.0*lambda2),1024.0)*vec2(diagonalVector.y,-diagonalVector.x);vec2 vCenter=vec2(pos2d);return vec4(
vCenter 
+ ((meshPos.x*majorAxis
+ meshPos.y*minorAxis)*invViewport*pos2d.w)*scale,pos2d.zw);}`;g.IncludesShadersStore[n5]||(g.IncludesShadersStore[n5]=mie)});var l5={};V(l5,{gaussianSplattingVertexShader:()=>_ie});var z0,o5,_ie,X0=S(()=>{O();i5();s5();Fa();gu();Xa();Di();a5();Ga();vu();Su();z0="gaussianSplattingVertexShader",o5=`#include<__decl__gaussianSplattingVertex>
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<logDepthDeclaration>
#include<helperFunctions>
attribute float splatIndex;uniform vec2 invViewport;uniform vec2 dataTextureSize;uniform vec2 focal;uniform float kernelSize;uniform vec3 eyePosition;uniform vec3 viewDirectionFactor;uniform sampler2D covariancesATexture;uniform sampler2D covariancesBTexture;uniform sampler2D centersTexture;uniform sampler2D colorsTexture;
#if SH_DEGREE>0
uniform highp usampler2D shTexture0;
#endif
#if SH_DEGREE>1
uniform highp usampler2D shTexture1;
#endif
#if SH_DEGREE>2
uniform highp usampler2D shTexture2;
#endif
varying vec4 vColor;varying vec2 vPosition;
#include<gaussianSplatting>
void main () {Splat splat=readSplat(splatIndex);vec3 covA=splat.covA.xyz;vec3 covB=vec3(splat.covA.w,splat.covB.xy);vec4 worldPos=world*vec4(splat.center.xyz,1.0);vColor=splat.color;vPosition=position;
#if SH_DEGREE>0
mat3 worldRot=mat3(world);mat3 normWorldRot=inverseMat3(worldRot);vec3 dir=normalize(normWorldRot*(worldPos.xyz-eyePosition));dir*=viewDirectionFactor;vColor.xyz=splat.color.xyz+computeSH(splat,dir);
#endif
gl_Position=gaussianSplatting(position,worldPos.xyz,vec2(1.,1.),covA,covB,world,view,projection);
#include<clipPlaneVertex>
#include<fogVertex>
#include<logDepthVertex>
}
`;g.ShadersStore[z0]||(g.ShadersStore[z0]=o5);_ie={name:z0,shader:o5}});var c5,gie,f5=S(()=>{O();mu();_u();c5="gaussianSplattingFragmentDeclaration",gie=`fn gaussianColor(inColor: vec4f,inPosition: vec2f)->vec4f
{var A : f32=-dot(inPosition,inPosition);if (A>-4.0)
{var B: f32=exp(A)*inColor.a;
#include<logDepthFragment>
var color: vec3f=inColor.rgb;
#ifdef FOG
#include<fogFragment>
#endif
return vec4f(color,B);} else {return vec4f(0.0);}}
`;g.IncludesShadersStoreWGSL[c5]||(g.IncludesShadersStoreWGSL[c5]=gie)});var u5={};V(u5,{gaussianSplattingPixelShaderWGSL:()=>vie});var Y0,h5,vie,K0=S(()=>{O();ba();za();pu();f5();Ca();Y0="gaussianSplattingPixelShader",h5=`#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
varying vColor: vec4f;varying vPosition: vec2f;
#include<gaussianSplattingFragmentDeclaration>
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#include<clipPlaneFragment>
fragmentOutputs.color=gaussianColor(input.vColor,input.vPosition);}
`;g.ShadersStoreWGSL[Y0]||(g.ShadersStoreWGSL[Y0]=h5);vie={name:Y0,shader:h5}});var d5,Sie,p5=S(()=>{O();d5="gaussianSplatting",Sie=`fn getDataUV(index: f32,dataTextureSize: vec2f)->vec2<f32> {let y: f32=floor(index/dataTextureSize.x);let x: f32=index-y*dataTextureSize.x;return vec2f((x+0.5),(y+0.5));}
struct Splat {center: vec4f,
color: vec4f,
covA: vec4f,
covB: vec4f,
#if SH_DEGREE>0
sh0: vec4<u32>,
#endif
#if SH_DEGREE>1
sh1: vec4<u32>,
#endif
#if SH_DEGREE>2
sh2: vec4<u32>,
#endif
};fn readSplat(splatIndex: f32,dataTextureSize: vec2f)->Splat {var splat: Splat;let splatUV=getDataUV(splatIndex,dataTextureSize);let splatUVi32=vec2<i32>(i32(splatUV.x),i32(splatUV.y));splat.center=textureLoad(centersTexture,splatUVi32,0);splat.color=textureLoad(colorsTexture,splatUVi32,0);splat.covA=textureLoad(covariancesATexture,splatUVi32,0)*splat.center.w;splat.covB=textureLoad(covariancesBTexture,splatUVi32,0)*splat.center.w;
#if SH_DEGREE>0
splat.sh0=textureLoad(shTexture0,splatUVi32,0);
#endif
#if SH_DEGREE>1
splat.sh1=textureLoad(shTexture1,splatUVi32,0);
#endif
#if SH_DEGREE>2
splat.sh2=textureLoad(shTexture2,splatUVi32,0);
#endif
return splat;}
fn computeColorFromSHDegree(dir: vec3f,sh: array<vec3<f32>,16>)->vec3f
{let SH_C0: f32=0.28209479;let SH_C1: f32=0.48860251;var SH_C2: array<f32,5>=array<f32,5>(
1.092548430,
-1.09254843,
0.315391565,
-1.09254843,
0.546274215
);var SH_C3: array<f32,7>=array<f32,7>(
-0.59004358,
2.890611442,
-0.45704579,
0.373176332,
-0.45704579,
1.445305721,
-0.59004358
);var result: vec3f=/*SH_C0**/sh[0];
#if SH_DEGREE>0
let x: f32=dir.x;let y: f32=dir.y;let z: f32=dir.z;result+=-SH_C1*y*sh[1]+SH_C1*z*sh[2]-SH_C1*x*sh[3];
#if SH_DEGREE>1
let xx: f32=x*x;let yy: f32=y*y;let zz: f32=z*z;let xy: f32=x*y;let yz: f32=y*z;let xz: f32=x*z;result+=
SH_C2[0]*xy*sh[4] +
SH_C2[1]*yz*sh[5] +
SH_C2[2]*(2.0f*zz-xx-yy)*sh[6] +
SH_C2[3]*xz*sh[7] +
SH_C2[4]*(xx-yy)*sh[8];
#if SH_DEGREE>2
result+=
SH_C3[0]*y*(3.0f*xx-yy)*sh[9] +
SH_C3[1]*xy*z*sh[10] +
SH_C3[2]*y*(4.0f*zz-xx-yy)*sh[11] +
SH_C3[3]*z*(2.0f*zz-3.0f*xx-3.0f*yy)*sh[12] +
SH_C3[4]*x*(4.0f*zz-xx-yy)*sh[13] +
SH_C3[5]*z*(xx-yy)*sh[14] +
SH_C3[6]*x*(xx-3.0f*yy)*sh[15];
#endif
#endif
#endif
return result;}
fn decompose(value: u32)->vec4f
{let components : vec4f=vec4f(
f32((value ) & 255u),
f32((value>>u32( 8)) & 255u),
f32((value>>u32(16)) & 255u),
f32((value>>u32(24)) & 255u));return components*vec4f(2./255.)-vec4f(1.);}
fn computeSH(splat: Splat,dir: vec3f)->vec3f
{var sh: array<vec3<f32>,16>;sh[0]=vec3f(0.,0.,0.);
#if SH_DEGREE>0
let sh00: vec4f=decompose(splat.sh0.x);let sh01: vec4f=decompose(splat.sh0.y);let sh02: vec4f=decompose(splat.sh0.z);sh[1]=vec3f(sh00.x,sh00.y,sh00.z);sh[2]=vec3f(sh00.w,sh01.x,sh01.y);sh[3]=vec3f(sh01.z,sh01.w,sh02.x);
#endif
#if SH_DEGREE>1
let sh03: vec4f=decompose(splat.sh0.w);let sh04: vec4f=decompose(splat.sh1.x);let sh05: vec4f=decompose(splat.sh1.y);sh[4]=vec3f(sh02.y,sh02.z,sh02.w);sh[5]=vec3f(sh03.x,sh03.y,sh03.z);sh[6]=vec3f(sh03.w,sh04.x,sh04.y);sh[7]=vec3f(sh04.z,sh04.w,sh05.x);sh[8]=vec3f(sh05.y,sh05.z,sh05.w);
#endif
#if SH_DEGREE>2
let sh06: vec4f=decompose(splat.sh1.z);let sh07: vec4f=decompose(splat.sh1.w);let sh08: vec4f=decompose(splat.sh2.x);let sh09: vec4f=decompose(splat.sh2.y);let sh10: vec4f=decompose(splat.sh2.z);let sh11: vec4f=decompose(splat.sh2.w);sh[9]=vec3f(sh06.x,sh06.y,sh06.z);sh[10]=vec3f(sh06.w,sh07.x,sh07.y);sh[11]=vec3f(sh07.z,sh07.w,sh08.x);sh[12]=vec3f(sh08.y,sh08.z,sh08.w);sh[13]=vec3f(sh09.x,sh09.y,sh09.z);sh[14]=vec3f(sh09.w,sh10.x,sh10.y);sh[15]=vec3f(sh10.z,sh10.w,sh11.x); 
#endif
return computeColorFromSHDegree(dir,sh);}
fn gaussianSplatting(
meshPos: vec2<f32>,
worldPos: vec3<f32>,
scale: vec2<f32>,
covA: vec3<f32>,
covB: vec3<f32>,
worldMatrix: mat4x4<f32>,
viewMatrix: mat4x4<f32>,
projectionMatrix: mat4x4<f32>,
focal: vec2f,
invViewport: vec2f,
kernelSize: f32
)->vec4f {let modelView=viewMatrix*worldMatrix;let camspace=viewMatrix*vec4f(worldPos,1.0);let pos2d=projectionMatrix*camspace;let bounds=1.2*pos2d.w;if (pos2d.z<0. || pos2d.x<-bounds || pos2d.x>bounds || pos2d.y<-bounds || pos2d.y>bounds) {return vec4f(0.0,0.0,2.0,1.0);}
let Vrk=mat3x3<f32>(
covA.x,covA.y,covA.z,
covA.y,covB.x,covB.y,
covA.z,covB.y,covB.z
);let J=mat3x3<f32>(
focal.x/camspace.z,0.0,-(focal.x*camspace.x)/(camspace.z*camspace.z),
0.0,focal.y/camspace.z,-(focal.y*camspace.y)/(camspace.z*camspace.z),
0.0,0.0,0.0
);let invy=mat3x3<f32>(
1.0,0.0,0.0,
0.0,-1.0,0.0,
0.0,0.0,1.0
);let T=invy*transpose(mat3x3<f32>(
modelView[0].xyz,
modelView[1].xyz,
modelView[2].xyz))*J;var cov2d=transpose(T)*Vrk*T;
#if COMPENSATION
let c00: f32=cov2d[0][0];let c11: f32=cov2d[1][1];let c01: f32=cov2d[0][1];let detOrig: f32=c00*c11-c01*c01;
#endif
cov2d[0][0]+=kernelSize;cov2d[1][1]+=kernelSize;
#if COMPENSATION
let c2d: vec3f=vec3f(cov2d[0][0],c01,cov2d[1][1]);let detBlur: f32=c2d.x*c2d.z-c2d.y*c2d.y;let compensation: f32=sqrt(max(0.,detOrig/detBlur));vertexOutputs.vColor.w*=compensation;
#endif
let mid=(cov2d[0][0]+cov2d[1][1])/2.0;let radius=length(vec2<f32>((cov2d[0][0]-cov2d[1][1])/2.0,cov2d[0][1]));let lambda1=mid+radius;let lambda2=mid-radius;if (lambda2<0.0) {return vec4f(0.0,0.0,2.0,1.0);}
let diagonalVector=normalize(vec2<f32>(cov2d[0][1],lambda1-cov2d[0][0]));let majorAxis=min(sqrt(2.0*lambda1),1024.0)*diagonalVector;let minorAxis=min(sqrt(2.0*lambda2),1024.0)*vec2<f32>(diagonalVector.y,-diagonalVector.x);let vCenter=vec2<f32>(pos2d.x,pos2d.y);return vec4f(
vCenter+((meshPos.x*majorAxis+meshPos.y*minorAxis)*invViewport*pos2d.w)*scale,
pos2d.z,
pos2d.w
);}
`;g.IncludesShadersStoreWGSL[d5]||(g.IncludesShadersStoreWGSL[d5]=Sie)});var _5={};V(_5,{gaussianSplattingVertexShaderWGSL:()=>Eie});var q0,m5,Eie,Q0=S(()=>{O();wo();rf();Pi();ya();hu();za();p5();Pa();uu();du();q0="gaussianSplattingVertexShader",m5=`#include<sceneUboDeclaration>
#include<meshUboDeclaration>
#include<helperFunctions>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<logDepthDeclaration>
attribute splatIndex: f32;attribute position: vec2f;uniform invViewport: vec2f;uniform dataTextureSize: vec2f;uniform focal: vec2f;uniform kernelSize: f32;uniform eyePosition: vec3f;uniform viewDirectionFactor: vec3f;var covariancesATexture: texture_2d<f32>;var covariancesBTexture: texture_2d<f32>;var centersTexture: texture_2d<f32>;var colorsTexture: texture_2d<f32>;
#if SH_DEGREE>0
var shTexture0: texture_2d<u32>;
#endif
#if SH_DEGREE>1
var shTexture1: texture_2d<u32>;
#endif
#if SH_DEGREE>2
var shTexture2: texture_2d<u32>;
#endif
varying vColor: vec4f;varying vPosition: vec2f;
#include<gaussianSplatting>
@vertex
fn main(input : VertexInputs)->FragmentInputs {var splat: Splat=readSplat(input.splatIndex,uniforms.dataTextureSize);var covA: vec3f=splat.covA.xyz;var covB: vec3f=vec3f(splat.covA.w,splat.covB.xy);let worldPos: vec4f=mesh.world*vec4f(splat.center.xyz,1.0);vertexOutputs.vPosition=input.position;
#if SH_DEGREE>0
let worldRot: mat3x3f= mat3x3f(mesh.world[0].xyz,mesh.world[1].xyz,mesh.world[2].xyz);let normWorldRot: mat3x3f=inverseMat3(worldRot);var dir: vec3f=normalize(normWorldRot*(worldPos.xyz-uniforms.eyePosition.xyz));dir*=uniforms.viewDirectionFactor;vertexOutputs.vColor=vec4f(splat.color.xyz+computeSH(splat,dir),splat.color.w);
#else
vertexOutputs.vColor=splat.color;
#endif
vertexOutputs.position=gaussianSplatting(input.position,worldPos.xyz,vec2f(1.0,1.0),covA,covB,mesh.world,scene.view,scene.projection,uniforms.focal,uniforms.invViewport,uniforms.kernelSize);
#include<clipPlaneVertex>
#include<fogVertex>
#include<logDepthVertex>
}
`;g.ShadersStoreWGSL[q0]||(g.ShadersStoreWGSL[q0]=m5);Eie={name:q0,shader:m5}});var j0,oc,g5=S(()=>{ei();yt();fs();yf();Te();rn();Vn();H0();X0();K0();Q0();Xi();j0=class extends ri{constructor(){super(),this.FOG=!1,this.THIN_INSTANCES=!0,this.LOGARITHMICDEPTH=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.SH_DEGREE=0,this.COMPENSATION=!1,this.rebuild()}},oc=class s extends Fs{constructor(e,t){super(e,t),this.kernelSize=s.KernelSize,this._compensation=s.Compensation,this._isDirty=!1,this.backFaceCulling=!1}set compensation(e){this._isDirty=this._isDirty!=e,this._compensation=e}get compensation(){return this._compensation}get hasRenderTargetTextures(){return!1}needAlphaTesting(){return!1}needAlphaBlending(){return!0}isReadyForSubMesh(e,t){let r=t._drawWrapper,n=t.materialDefines;if(n&&this._isDirty&&n.markAsUnprocessed(),r.effect&&this.isFrozen&&r._wasPreviouslyReady&&r._wasPreviouslyUsingInstances===!0)return!0;t.materialDefines||(n=t.materialDefines=new j0);let a=this.getScene();if(this._isReadyForSubMesh(t))return!0;let o=a.getEngine(),l=e;yo(e,a,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,!1,n,void 0,void 0,void 0,this._setVertexOutputInvariant),Mo(a,o,this,n,!0,null,!0),Po(e,n,!1,!1),(o.version>1||o.isWebGPU)&&(n.SH_DEGREE=l.shDegree);let c=l.material;if(n.COMPENSATION=c&&c.compensation?c.compensation:s.Compensation,n.isDirty){n.markAsProcessed(),a.resetCachedMaterial();let f=[A.PositionKind,"splatIndex"];Io(f,n);let h=["world","view","projection","vFogInfos","vFogColor","logarithmicDepthConstant","invViewport","dataTextureSize","focal","eyePosition","kernelSize","viewDirectionFactor"],u=["covariancesATexture","covariancesBTexture","centersTexture","colorsTexture","shTexture0","shTexture1","shTexture2"],d=["Scene","Mesh"];Do({uniformsNames:h,uniformBuffersNames:d,samplers:u,defines:n}),Hi(h);let p=n.toString(),m=a.getEngine().createEffect("gaussianSplatting",{attributes:f,uniformsNames:h,uniformBuffersNames:d,samplers:u,defines:p,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{},shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{this._shaderLanguage===1?await Promise.all([Promise.resolve().then(()=>(K0(),u5)),Promise.resolve().then(()=>(Q0(),_5))]):await Promise.all([Promise.resolve().then(()=>(H0(),e5)),Promise.resolve().then(()=>(X0(),l5))])}},o);t.setEffect(m,n,this._materialContext)}return!t.effect||!t.effect.isReady()?!1:(n._renderId=a.getRenderId(),r._wasPreviouslyReady=!0,r._wasPreviouslyUsingInstances=!0,this._isDirty=!1,!0)}static BindEffect(e,t,i){let r=i.getEngine(),n=i.activeCamera,a=r.getRenderWidth(),o=r.getRenderHeight(),l=e,c=l.material,f=n?.rigParent?.rigCameras.length||1;t.setFloat2("invViewport",1/(a/f),1/o);let h=1e3;if(n){let u=n.getProjectionMatrix().m[5];n.fovMode==ye.FOVMODE_VERTICAL_FIXED?h=o*u/2:h=a*u/2}if(t.setFloat2("focal",h,h),t.setVector3("viewDirectionFactor",l.viewDirectionFactor),t.setFloat("kernelSize",c&&c.kernelSize?c.kernelSize:s.KernelSize),i.bindEyePosition(t,"eyePosition",!0),l.covariancesATexture){let u=l.covariancesATexture.getSize();if(t.setFloat2("dataTextureSize",u.width,u.height),t.setTexture("covariancesATexture",l.covariancesATexture),t.setTexture("covariancesBTexture",l.covariancesBTexture),t.setTexture("centersTexture",l.centersTexture),t.setTexture("colorsTexture",l.colorsTexture),l.shTextures)for(let d=0;d<l.shTextures?.length;d++)t.setTexture(`shTexture${d}`,l.shTextures[d])}}bindForSubMesh(e,t,i){let r=this.getScene(),n=i.materialDefines;if(!n)return;let a=i.effect;if(!a)return;this._activeEffect=a,t.getMeshUniformBuffer().bindToEffect(a,"Mesh"),t.transferToEffect(e),this._mustRebind(r,a,i,t.visibility)?(this.bindView(a),this.bindViewProjection(a),s.BindEffect(t,this._activeEffect,r),zi(a,this,r)):r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0),wn(r,t,a),this.useLogarithmicDepth&&Ln(n,a,r),this._afterBind(t,this._activeEffect,i)}clone(e){return _e.Clone(()=>new s(e,this.getScene()),this)}serialize(){let e=super.serialize();return e.customType="BABYLON.GaussianSplattingMaterial",e}getClassName(){return"GaussianSplattingMaterial"}static Parse(e,t,i){return _e.Parse(()=>new s(e.name,t),e,t,i)}};oc.KernelSize=.3;oc.Compensation=!1;G("BABYLON.GaussianSplattingMaterial",oc)});var Tie,ps,Z0=S(()=>{di();Tie=cp,ps={...PA,TwoPi:Math.PI*2,Sign:Math.sign,Log2:Math.log2,HCF:Tie}});var sa,v5,xie,Aie,S5,E5,Gs,T5=S(()=>{Sf();Ki();ln();ie();Ee();g5();Wu();$e();fy();Hc();Z0();t_();gt();sa=(s,e)=>{let t=(1<<e)-1;return(s&t)/t},v5=(s,e)=>{e.x=sa(s>>>21,11),e.y=sa(s>>>11,10),e.z=sa(s,11)},xie=(s,e)=>{e[0]=sa(s>>>24,8)*255,e[1]=sa(s>>>16,8)*255,e[2]=sa(s>>>8,8)*255,e[3]=sa(s,8)*255},Aie=(s,e)=>{let t=1/(Math.sqrt(2)*.5),i=(sa(s>>>20,10)-.5)*t,r=(sa(s>>>10,10)-.5)*t,n=(sa(s,10)-.5)*t,a=Math.sqrt(1-(i*i+r*r+n*n));switch(s>>>30){case 0:e.set(a,i,r,n);break;case 1:e.set(i,a,r,n);break;case 2:e.set(i,r,a,n);break;case 3:e.set(i,r,n,a);break}};(function(s){s[s.FLOAT=0]="FLOAT",s[s.INT=1]="INT",s[s.UINT=2]="UINT",s[s.DOUBLE=3]="DOUBLE",s[s.UCHAR=4]="UCHAR",s[s.UNDEFINED=5]="UNDEFINED"})(S5||(S5={}));(function(s){s[s.MIN_X=0]="MIN_X",s[s.MIN_Y=1]="MIN_Y",s[s.MIN_Z=2]="MIN_Z",s[s.MAX_X=3]="MAX_X",s[s.MAX_Y=4]="MAX_Y",s[s.MAX_Z=5]="MAX_Z",s[s.MIN_SCALE_X=6]="MIN_SCALE_X",s[s.MIN_SCALE_Y=7]="MIN_SCALE_Y",s[s.MIN_SCALE_Z=8]="MIN_SCALE_Z",s[s.MAX_SCALE_X=9]="MAX_SCALE_X",s[s.MAX_SCALE_Y=10]="MAX_SCALE_Y",s[s.MAX_SCALE_Z=11]="MAX_SCALE_Z",s[s.PACKED_POSITION=12]="PACKED_POSITION",s[s.PACKED_ROTATION=13]="PACKED_ROTATION",s[s.PACKED_SCALE=14]="PACKED_SCALE",s[s.PACKED_COLOR=15]="PACKED_COLOR",s[s.X=16]="X",s[s.Y=17]="Y",s[s.Z=18]="Z",s[s.SCALE_0=19]="SCALE_0",s[s.SCALE_1=20]="SCALE_1",s[s.SCALE_2=21]="SCALE_2",s[s.DIFFUSE_RED=22]="DIFFUSE_RED",s[s.DIFFUSE_GREEN=23]="DIFFUSE_GREEN",s[s.DIFFUSE_BLUE=24]="DIFFUSE_BLUE",s[s.OPACITY=25]="OPACITY",s[s.F_DC_0=26]="F_DC_0",s[s.F_DC_1=27]="F_DC_1",s[s.F_DC_2=28]="F_DC_2",s[s.F_DC_3=29]="F_DC_3",s[s.ROT_0=30]="ROT_0",s[s.ROT_1=31]="ROT_1",s[s.ROT_2=32]="ROT_2",s[s.ROT_3=33]="ROT_3",s[s.MIN_COLOR_R=34]="MIN_COLOR_R",s[s.MIN_COLOR_G=35]="MIN_COLOR_G",s[s.MIN_COLOR_B=36]="MIN_COLOR_B",s[s.MAX_COLOR_R=37]="MAX_COLOR_R",s[s.MAX_COLOR_G=38]="MAX_COLOR_G",s[s.MAX_COLOR_B=39]="MAX_COLOR_B",s[s.SH_0=40]="SH_0",s[s.SH_1=41]="SH_1",s[s.SH_2=42]="SH_2",s[s.SH_3=43]="SH_3",s[s.SH_4=44]="SH_4",s[s.SH_5=45]="SH_5",s[s.SH_6=46]="SH_6",s[s.SH_7=47]="SH_7",s[s.SH_8=48]="SH_8",s[s.SH_9=49]="SH_9",s[s.SH_10=50]="SH_10",s[s.SH_11=51]="SH_11",s[s.SH_12=52]="SH_12",s[s.SH_13=53]="SH_13",s[s.SH_14=54]="SH_14",s[s.SH_15=55]="SH_15",s[s.SH_16=56]="SH_16",s[s.SH_17=57]="SH_17",s[s.SH_18=58]="SH_18",s[s.SH_19=59]="SH_19",s[s.SH_20=60]="SH_20",s[s.SH_21=61]="SH_21",s[s.SH_22=62]="SH_22",s[s.SH_23=63]="SH_23",s[s.SH_24=64]="SH_24",s[s.SH_25=65]="SH_25",s[s.SH_26=66]="SH_26",s[s.SH_27=67]="SH_27",s[s.SH_28=68]="SH_28",s[s.SH_29=69]="SH_29",s[s.SH_30=70]="SH_30",s[s.SH_31=71]="SH_31",s[s.SH_32=72]="SH_32",s[s.SH_33=73]="SH_33",s[s.SH_34=74]="SH_34",s[s.SH_35=75]="SH_35",s[s.SH_36=76]="SH_36",s[s.SH_37=77]="SH_37",s[s.SH_38=78]="SH_38",s[s.SH_39=79]="SH_39",s[s.SH_40=80]="SH_40",s[s.SH_41=81]="SH_41",s[s.SH_42=82]="SH_42",s[s.SH_43=83]="SH_43",s[s.SH_44=84]="SH_44",s[s.UNDEFINED=85]="UNDEFINED"})(E5||(E5={}));Gs=class s extends fe{get viewDirectionFactor(){return this._viewDirectionFactor}get shDegree(){return this._shDegree}get splatsData(){return this._splatsData}get covariancesATexture(){return this._covariancesATexture}get covariancesBTexture(){return this._covariancesBTexture}get centersTexture(){return this._centersTexture}get colorsTexture(){return this._colorsTexture}get shTextures(){return this._shTextures}set material(e){this._material=e,this._material.backFaceCulling=!0,this._material.cullBackFaces=!1,e.resetDrawCache()}get material(){return this._material}constructor(e,t=null,i=null,r=!1){super(e,i),this._vertexCount=0,this._worker=null,this._frameIdLastUpdate=-1,this._modelViewMatrix=B.Identity(),this._canPostToWorker=!0,this._readyToDisplay=!1,this._covariancesATexture=null,this._covariancesBTexture=null,this._centersTexture=null,this._colorsTexture=null,this._splatPositions=null,this._splatIndex=null,this._shTextures=null,this._splatsData=null,this._sh=null,this._keepInRam=!1,this._delayedTextureUpdate=null,this._oldDirection=new E,this._useRGBACovariants=!1,this._material=null,this._tmpCovariances=[0,0,0,0,0,0],this._sortIsDirty=!1,this._shDegree=0,this._viewDirectionFactor=new E(1,1,-1);let n=new Ge;n.positions=[-2,-2,0,2,-2,0,2,2,0,-2,2,0],n.indices=[0,1,2,0,2,3],n.applyToMesh(this),this.subMeshes=[],new cr(0,0,4,0,6,this),this.setEnabled(!1),this._useRGBACovariants=!this.getEngine().isWebGPU&&this.getEngine().version===1,this._keepInRam=r,t&&this.loadFileAsync(t),this._material=new oc(this.name+"_material",this._scene)}getClassName(){return"GaussianSplattingMesh"}getTotalVertices(){return this._vertexCount}isReady(e=!1){return super.isReady(e,!0)?this._readyToDisplay?!0:(this._postToWorker(!0),!1):!1}_postToWorker(e=!1){let t=this.getScene().getFrameId();if((e||t!==this._frameIdLastUpdate)&&this._worker&&this._scene.activeCamera&&this._canPostToWorker){let i=this._scene.activeCamera.getViewMatrix();this.getWorldMatrix().multiplyToRef(i,this._modelViewMatrix),i.invertToRef(w.Matrix[0]),this.getWorldMatrix().multiplyToRef(w.Matrix[0],w.Matrix[1]),E.TransformNormalToRef(E.Forward(this._scene.useRightHandedSystem),w.Matrix[1],w.Vector3[2]),w.Vector3[2].normalize();let r=E.Dot(w.Vector3[2],this._oldDirection);(e||Math.abs(r-1)>=.01)&&(this._oldDirection.copyFrom(w.Vector3[2]),this._frameIdLastUpdate=t,this._canPostToWorker=!1,this._worker.postMessage({view:this._modelViewMatrix.m,depthMix:this._depthMix,useRightHandedSystem:this._scene.useRightHandedSystem},[this._depthMix.buffer]))}}render(e,t,i){return this._postToWorker(),super.render(e,t,i)}static _TypeNameToEnum(e){switch(e){case"float":return 0;case"int":return 1;case"uint":return 2;case"double":return 3;case"uchar":return 4}return 5}static _ValueNameToEnum(e){switch(e){case"min_x":return 0;case"min_y":return 1;case"min_z":return 2;case"max_x":return 3;case"max_y":return 4;case"max_z":return 5;case"min_scale_x":return 6;case"min_scale_y":return 7;case"min_scale_z":return 8;case"max_scale_x":return 9;case"max_scale_y":return 10;case"max_scale_z":return 11;case"packed_position":return 12;case"packed_rotation":return 13;case"packed_scale":return 14;case"packed_color":return 15;case"x":return 16;case"y":return 17;case"z":return 18;case"scale_0":return 19;case"scale_1":return 20;case"scale_2":return 21;case"diffuse_red":case"red":return 22;case"diffuse_green":case"green":return 23;case"diffuse_blue":case"blue":return 24;case"f_dc_0":return 26;case"f_dc_1":return 27;case"f_dc_2":return 28;case"f_dc_3":return 29;case"opacity":return 25;case"rot_0":return 30;case"rot_1":return 31;case"rot_2":return 32;case"rot_3":return 33;case"min_r":return 34;case"min_g":return 35;case"min_b":return 36;case"max_r":return 37;case"max_g":return 38;case"max_b":return 39;case"f_rest_0":return 40;case"f_rest_1":return 41;case"f_rest_2":return 42;case"f_rest_3":return 43;case"f_rest_4":return 44;case"f_rest_5":return 45;case"f_rest_6":return 46;case"f_rest_7":return 47;case"f_rest_8":return 48;case"f_rest_9":return 49;case"f_rest_10":return 50;case"f_rest_11":return 51;case"f_rest_12":return 52;case"f_rest_13":return 53;case"f_rest_14":return 54;case"f_rest_15":return 55;case"f_rest_16":return 56;case"f_rest_17":return 57;case"f_rest_18":return 58;case"f_rest_19":return 59;case"f_rest_20":return 60;case"f_rest_21":return 61;case"f_rest_22":return 62;case"f_rest_23":return 63;case"f_rest_24":return 64;case"f_rest_25":return 65;case"f_rest_26":return 66;case"f_rest_27":return 67;case"f_rest_28":return 68;case"f_rest_29":return 69;case"f_rest_30":return 70;case"f_rest_31":return 71;case"f_rest_32":return 72;case"f_rest_33":return 73;case"f_rest_34":return 74;case"f_rest_35":return 75;case"f_rest_36":return 76;case"f_rest_37":return 77;case"f_rest_38":return 78;case"f_rest_39":return 79;case"f_rest_40":return 80;case"f_rest_41":return 81;case"f_rest_42":return 82;case"f_rest_43":return 83;case"f_rest_44":return 84}return 85}static ParseHeader(e){let t=new Uint8Array(e),i=new TextDecoder().decode(t.slice(0,1024*10)),r=`end_header
`,n=i.indexOf(r);if(n<0||!i)return null;let a=parseInt(/element vertex (\d+)\n/.exec(i)[1]),o=/element chunk (\d+)\n/.exec(i),l=0;o&&(l=parseInt(o[1]));let c=0,f=0,h={double:8,int:4,uint:4,float:4,short:2,ushort:2,uchar:1,list:0},u;(function(b){b[b.Vertex=0]="Vertex",b[b.Chunk=1]="Chunk",b[b.SH=2]="SH"})(u||(u={}));let d=1,p=[],m=[],_=i.slice(0,n).split(`
`),v=0;for(let b of _)if(b.startsWith("property ")){let[,M,F]=b.split(" "),U=s._ValueNameToEnum(F);U>=84?v=3:U>=64?v=2:U>=48&&(v=1);let D=s._TypeNameToEnum(M);d==1?(m.push({value:U,type:D,offset:f}),f+=h[M]):d==0?(p.push({value:U,type:D,offset:c}),c+=h[M]):d==2&&p.push({value:U,type:D,offset:c}),h[M]||P.Warn(`Unsupported property type: ${M}.`)}else if(b.startsWith("element ")){let[,M]=b.split(" ");M=="chunk"?d=1:M=="vertex"?d=0:M=="sh"&&(d=2)}let T=new DataView(e,n+r.length),C=new ArrayBuffer(s._RowOutputLength*a),I=null,R=0;return v&&(R=((v+1)*(v+1)-1)*3,I=new ArrayBuffer(R*a)),{vertexCount:a,chunkCount:l,rowVertexLength:c,rowChunkLength:f,vertexProperties:p,chunkProperties:m,dataView:T,buffer:C,shDegree:v,shCoefficientCount:R,shBuffer:I}}static _GetCompressedChunks(e,t){if(!e.chunkCount)return null;let i=e.dataView,r=new Array(e.chunkCount);for(let n=0;n<e.chunkCount;n++){let a={min:new E,max:new E,minScale:new E,maxScale:new E,minColor:new E(0,0,0),maxColor:new E(1,1,1)};r[n]=a;for(let o=0;o<e.chunkProperties.length;o++){let l=e.chunkProperties[o],c;switch(l.type){case 0:c=i.getFloat32(l.offset+t.value,!0);break;default:continue}switch(l.value){case 0:a.min.x=c;break;case 1:a.min.y=c;break;case 2:a.min.z=c;break;case 3:a.max.x=c;break;case 4:a.max.y=c;break;case 5:a.max.z=c;break;case 6:a.minScale.x=c;break;case 7:a.minScale.y=c;break;case 8:a.minScale.z=c;break;case 9:a.maxScale.x=c;break;case 10:a.maxScale.y=c;break;case 11:a.maxScale.z=c;break;case 34:a.minColor.x=c;break;case 35:a.minColor.y=c;break;case 36:a.minColor.z=c;break;case 37:a.maxColor.x=c;break;case 38:a.maxColor.y=c;break;case 39:a.maxColor.z=c;break}}t.value+=e.rowChunkLength}return r}static _GetSplat(e,t,i,r){let n=w.Quaternion[0],a=w.Vector3[0],o=s._RowOutputLength,l=e.buffer,c=e.dataView,f=new Float32Array(l,t*o,3),h=new Float32Array(l,t*o+12,3),u=new Uint8ClampedArray(l,t*o+24,4),d=new Uint8ClampedArray(l,t*o+28,4),p=null;e.shBuffer&&(p=new Uint8ClampedArray(e.shBuffer,t*e.shCoefficientCount,e.shCoefficientCount));let m=t>>8,_=255,v=0,T=0,C=0,I=[];for(let R=0;R<e.vertexProperties.length;R++){let b=e.vertexProperties[R],M;switch(b.type){case 0:M=c.getFloat32(r.value+b.offset,!0);break;case 1:M=c.getInt32(r.value+b.offset,!0);break;case 2:M=c.getUint32(r.value+b.offset,!0);break;case 3:M=c.getFloat64(r.value+b.offset,!0);break;case 4:M=c.getUint8(r.value+b.offset);break;default:continue}switch(b.value){case 12:{let F=i[m];v5(M,a),f[0]=ps.Lerp(F.min.x,F.max.x,a.x),f[1]=ps.Lerp(F.min.y,F.max.y,a.y),f[2]=ps.Lerp(F.min.z,F.max.z,a.z)}break;case 13:Aie(M,n),_=n.x,v=n.y,T=n.z,C=n.w;break;case 14:{let F=i[m];v5(M,a),h[0]=Math.exp(ps.Lerp(F.minScale.x,F.maxScale.x,a.x)),h[1]=Math.exp(ps.Lerp(F.minScale.y,F.maxScale.y,a.y)),h[2]=Math.exp(ps.Lerp(F.minScale.z,F.maxScale.z,a.z))}break;case 15:{let F=i[m];xie(M,u),u[0]=ps.Lerp(F.minColor.x,F.maxColor.x,u[0]/255)*255,u[1]=ps.Lerp(F.minColor.y,F.maxColor.y,u[1]/255)*255,u[2]=ps.Lerp(F.minColor.z,F.maxColor.z,u[2]/255)*255}break;case 16:f[0]=M;break;case 17:f[1]=M;break;case 18:f[2]=M;break;case 19:h[0]=Math.exp(M);break;case 20:h[1]=Math.exp(M);break;case 21:h[2]=Math.exp(M);break;case 22:u[0]=M;break;case 23:u[1]=M;break;case 24:u[2]=M;break;case 26:u[0]=(.5+s._SH_C0*M)*255;break;case 27:u[1]=(.5+s._SH_C0*M)*255;break;case 28:u[2]=(.5+s._SH_C0*M)*255;break;case 29:u[3]=(.5+s._SH_C0*M)*255;break;case 25:u[3]=1/(1+Math.exp(-M))*255;break;case 30:_=M;break;case 31:v=M;break;case 32:T=M;break;case 33:C=M;break}if(p&&b.value>=40&&b.value<=84){let F=b.value-40;if(b.type==4&&e.chunkCount){let U=c.getUint8(e.rowChunkLength*e.chunkCount+e.vertexCount*e.rowVertexLength+t*e.shCoefficientCount+F);I[F]=(U*(8/255)-4)*127.5+127.5}else{let U=ps.Clamp(M*127.5+127.5,0,255);I[F]=U}}}if(p){let R=e.shDegree==1?3:e.shDegree==2?8:15;for(let b=0;b<R;b++)p[b*3+0]=I[b],p[b*3+1]=I[b+R],p[b*3+2]=I[b+R*2]}n.set(v,T,C,_),n.normalize(),d[0]=n.w*127.5+127.5,d[1]=n.x*127.5+127.5,d[2]=n.y*127.5+127.5,d[3]=n.z*127.5+127.5,r.value+=e.rowVertexLength}static*ConvertPLYWithSHToSplat(e,t=!1){let i=s.ParseHeader(e);if(!i)return{buffer:e};let r={value:0},n=s._GetCompressedChunks(i,r);for(let o=0;o<i.vertexCount;o++)s._GetSplat(i,o,n,r),o%s._PlyConversionBatchSize===0&&t&&(yield);let a=null;if(i.shDegree&&i.shBuffer){let o=Math.ceil(i.shCoefficientCount/16),l=0,c=new Uint8Array(i.shBuffer);a=[];let f=i.vertexCount,h=Z.LastCreatedEngine;if(h){let u=h.getCaps().maxTextureSize,d=Math.ceil(f/u);for(let p=0;p<o;p++){let m=new Uint8Array(d*u*4*4);a.push(m)}for(let p=0;p<f;p++)for(let m=0;m<i.shCoefficientCount;m++){let _=c[l++],v=Math.floor(m/16),T=a[v],C=m%16,I=p*16;T[C+I]=_}}}return{buffer:i.buffer,sh:a}}static*ConvertPLYToSplat(e,t=!1){let i=s.ParseHeader(e);if(!i)return e;let r={value:0},n=s._GetCompressedChunks(i,r);for(let a=0;a<i.vertexCount;a++)s._GetSplat(i,a,n,r),a%s._PlyConversionBatchSize===0&&t&&(yield);return i.buffer}static async ConvertPLYToSplatAsync(e){return await gf(s.ConvertPLYToSplat(e,!0),_f())}static async ConvertPLYWithSHToSplatAsync(e){return await gf(s.ConvertPLYWithSHToSplat(e,!0),_f())}async loadDataAsync(e){return await this.updateDataAsync(e)}async loadFileAsync(e){let t=await W.LoadFileAsync(e,!0),i=await s.ConvertPLYWithSHToSplatAsync(t);await this.updateDataAsync(i.buffer,i.sh)}dispose(e){if(this._covariancesATexture?.dispose(),this._covariancesBTexture?.dispose(),this._centersTexture?.dispose(),this._colorsTexture?.dispose(),this._shTextures)for(let t of this._shTextures)t.dispose();this._covariancesATexture=null,this._covariancesBTexture=null,this._centersTexture=null,this._colorsTexture=null,this._shTextures=null,this._worker?.terminate(),this._worker=null,super.dispose(e,!0)}_copyTextures(e){if(this._covariancesATexture=e.covariancesATexture?.clone(),this._covariancesBTexture=e.covariancesBTexture?.clone(),this._centersTexture=e.centersTexture?.clone(),this._colorsTexture=e.colorsTexture?.clone(),e._shTextures){this._shTextures=[];for(let t of this._shTextures)this._shTextures?.push(t.clone())}}clone(e=""){let t=new s(e,void 0,this.getScene());t._copySource(this),t.makeGeometryUnique(),t._vertexCount=this._vertexCount,t._copyTextures(this),t._modelViewMatrix=B.Identity(),t._splatPositions=this._splatPositions,t._readyToDisplay=!1,t._instanciateWorker();let i=this.getBoundingInfo();return t.getBoundingInfo().reConstruct(i.minimum,i.maximum,this.getWorldMatrix()),t.forcedInstanceCount=t._vertexCount,t.setEnabled(!0),t}_makeSplat(e,t,i,r,n,a,o,l){let c=w.Matrix[0],f=w.Matrix[1],h=w.Quaternion[0],u=this._useRGBACovariants?4:2,d=t[8*e+0],p=-t[8*e+1],m=t[8*e+2];this._splatPositions[4*e+0]=d,this._splatPositions[4*e+1]=p,this._splatPositions[4*e+2]=m,o.minimizeInPlaceFromFloats(d,p,m),l.maximizeInPlaceFromFloats(d,p,m),h.set((i[32*e+28+1]-127.5)/127.5,(i[32*e+28+2]-127.5)/127.5,(i[32*e+28+3]-127.5)/127.5,-(i[32*e+28+0]-127.5)/127.5),h.toRotationMatrix(c),B.ScalingToRef(t[8*e+3+0]*2,t[8*e+3+1]*2,t[8*e+3+2]*2,f);let _=c.multiplyToRef(f,w.Matrix[0]).m,v=this._tmpCovariances;v[0]=_[0]*_[0]+_[1]*_[1]+_[2]*_[2],v[1]=_[0]*_[4]+_[1]*_[5]+_[2]*_[6],v[2]=_[0]*_[8]+_[1]*_[9]+_[2]*_[10],v[3]=_[4]*_[4]+_[5]*_[5]+_[6]*_[6],v[4]=_[4]*_[8]+_[5]*_[9]+_[6]*_[10],v[5]=_[8]*_[8]+_[9]*_[9]+_[10]*_[10];let T=-1e4;for(let I=0;I<6;I++)T=Math.max(T,Math.abs(v[I]));this._splatPositions[4*e+3]=T;let C=T;r[e*4+0]=ki(v[0]/C),r[e*4+1]=ki(v[1]/C),r[e*4+2]=ki(v[2]/C),r[e*4+3]=ki(v[3]/C),n[e*u+0]=ki(v[4]/C),n[e*u+1]=ki(v[5]/C),a[e*4+0]=i[32*e+24+0],a[e*4+1]=i[32*e+24+1],a[e*4+2]=i[32*e+24+2],a[e*4+3]=i[32*e+24+3]}_updateTextures(e,t,i,r){let n=this._getTextureSize(this._vertexCount),a=(f,h,u,d)=>new yr(f,h,u,d,this._scene,!1,!1,2,1),o=(f,h,u,d)=>new yr(f,h,u,d,this._scene,!1,!1,2,0),l=(f,h,u,d)=>new yr(f,h,u,d,this._scene,!1,!1,1,7),c=(f,h,u,d)=>new yr(f,h,u,d,this._scene,!1,!1,2,2);if(this._covariancesATexture){this._delayedTextureUpdate={covA:e,covB:t,colors:i,centers:this._splatPositions,sh:r};let f=Float32Array.from(this._splatPositions),h=this._vertexCount;this._worker.postMessage({positions:f,vertexCount:h},[f.buffer]),this._postToWorker(!0)}else{if(this._covariancesATexture=c(e,n.x,n.y,5),this._covariancesBTexture=c(t,n.x,n.y,this._useRGBACovariants?5:7),this._centersTexture=a(this._splatPositions,n.x,n.y,5),this._colorsTexture=o(i,n.x,n.y,5),r){this._shTextures=[];for(let f of r){let h=new Uint32Array(f.buffer),u=l(h,n.x,n.y,11);u.wrapU=0,u.wrapV=0,this._shTextures.push(u)}}this._instanciateWorker()}}*_updateData(e,t,i){this._covariancesATexture||(this._readyToDisplay=!1);let r=new Uint8Array(e),n=new Float32Array(r.buffer);this._keepInRam&&(this._splatsData=e,i&&(this._sh=i));let a=r.length/s._RowOutputLength;a!=this._vertexCount&&this._updateSplatIndexBuffer(a),this._vertexCount=a,this._shDegree=i?i.length:0;let o=this._getTextureSize(a),l=o.x*o.y,c=s.ProgressiveUpdateAmount??o.y,f=o.x*c;this._splatPositions=new Float32Array(4*l);let h=new Uint16Array(l*4),u=new Uint16Array((this._useRGBACovariants?4:2)*l),d=new Uint8Array(l*4),p=new E(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),m=new E(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);if(s.ProgressiveUpdateAmount){this._updateTextures(h,u,d,i),this.setEnabled(!0);let _=Math.ceil(o.y/c);for(let C=0;C<_;C++){let I=C*c,R=I*o.x;for(let b=0;b<f;b++)this._makeSplat(R+b,n,r,h,u,d,p,m);this._updateSubTextures(this._splatPositions,h,u,d,I,Math.min(c,o.y-I)),this.getBoundingInfo().reConstruct(p,m,this.getWorldMatrix()),t&&(yield)}let v=Float32Array.from(this._splatPositions),T=this._vertexCount;this._worker.postMessage({positions:v,vertexCount:T},[v.buffer]),this._sortIsDirty=!0}else{for(let _=0;_<a;_++)this._makeSplat(_,n,r,h,u,d,p,m),t&&_%s._SplatBatchSize===0&&(yield);this._updateTextures(h,u,d,i),this.getBoundingInfo().reConstruct(p,m,this.getWorldMatrix()),this.setEnabled(!0)}this._postToWorker(!0)}async updateDataAsync(e,t){return await gf(this._updateData(e,!0,t),_f())}updateData(e,t){Fl(this._updateData(e,!1,t))}refreshBoundingInfo(){return this.thinInstanceRefreshBoundingInfo(!1),this}_updateSplatIndexBuffer(e){(!this._splatIndex||e>this._splatIndex.length)&&(this._splatIndex=new Float32Array(e),this.thinInstanceSetBuffer("splatIndex",this._splatIndex,1,!1)),this.forcedInstanceCount=e}_updateSubTextures(e,t,i,r,n,a,o){let l=(v,T,C,I,R)=>{this.getEngine().updateTextureData(v.getInternalTexture(),T,0,I,C,R,0,0,!1)},c=this._getTextureSize(this._vertexCount),f=this._useRGBACovariants?4:2,h=n*c.x,u=a*c.x,d=new Uint16Array(t.buffer,h*4*Uint16Array.BYTES_PER_ELEMENT,u*4),p=new Uint16Array(i.buffer,h*f*Uint16Array.BYTES_PER_ELEMENT,u*f),m=new Uint8Array(r.buffer,h*4,u*4),_=new Float32Array(e.buffer,h*4*Float32Array.BYTES_PER_ELEMENT,u*4);if(l(this._covariancesATexture,d,c.x,n,a),l(this._covariancesBTexture,p,c.x,n,a),l(this._centersTexture,_,c.x,n,a),l(this._colorsTexture,m,c.x,n,a),o)for(let v=0;v<o.length;v++){let C=new Uint8Array(this._sh[v].buffer,h*4,u*4);l(this._shTextures[v],C,c.x,n,a)}}_instanciateWorker(){if(!this._vertexCount)return;this._updateSplatIndexBuffer(this._vertexCount),this._worker?.terminate(),this._worker=new Worker(URL.createObjectURL(new Blob(["(",s._CreateWorker.toString(),")(self)"],{type:"application/javascript"}))),this._depthMix=new BigInt64Array(this._vertexCount);let e=Float32Array.from(this._splatPositions),t=this._vertexCount;this._worker.postMessage({positions:e,vertexCount:t},[e.buffer]),this._worker.onmessage=i=>{this._depthMix=i.data.depthMix;let r=new Uint32Array(i.data.depthMix.buffer);if(this._splatIndex)for(let n=0;n<this._vertexCount;n++)this._splatIndex[n]=r[2*n];if(this._delayedTextureUpdate){let n=this._getTextureSize(t);this._updateSubTextures(this._delayedTextureUpdate.centers,this._delayedTextureUpdate.covA,this._delayedTextureUpdate.covB,this._delayedTextureUpdate.colors,0,n.y,this._delayedTextureUpdate.sh),this._delayedTextureUpdate=null}this.thinInstanceBufferUpdated("splatIndex"),this._canPostToWorker=!0,this._readyToDisplay=!0,this._sortIsDirty&&(this._postToWorker(!0),this._sortIsDirty=!1)}}_getTextureSize(e){let t=this._scene.getEngine(),i=t.getCaps().maxTextureSize,r=1;if(t.version===1&&!t.isWebGPU)for(;i*r<e;)r*=2;else r=Math.ceil(e/i);return r>i&&(P.Error("GaussianSplatting texture size: ("+i+", "+r+"), maxTextureSize: "+i),r=i),new he(i,r)}};Gs._RowOutputLength=32;Gs._SH_C0=.28209479177387814;Gs._SplatBatchSize=327680;Gs._PlyConversionBatchSize=32768;Gs.ProgressiveUpdateAmount=0;Gs._CreateWorker=function(s){let e=0,t,i,r,n;s.onmessage=a=>{if(a.data.positions)t=a.data.positions,e=a.data.vertexCount;else{let o=a.data.view;if(!t||!o)throw new Error("positions or view is not defined!");i=a.data.depthMix,r=new Uint32Array(i.buffer),n=new Float32Array(i.buffer);for(let c=0;c<e;c++)r[2*c]=c;let l=-1;a.data.useRightHandedSystem&&(l=1);for(let c=0;c<e;c++)n[2*c+1]=1e4+(o[2]*t[4*c+0]+o[6]*t[4*c+1]+o[10]*t[4*c+2])*l;i.sort(),s.postMessage({depthMix:i},[i.buffer])}}}});var hx,oh,x5=S(()=>{ml();hx=class{constructor(e,t,i,r,n){this.idx=0,this.color=new me(1,1,1,1),this.position=E.Zero(),this.rotation=E.Zero(),this.uv=new he(0,0),this.velocity=E.Zero(),this.pivot=E.Zero(),this.translateFromPivot=!1,this._pos=0,this._ind=0,this.groupId=0,this.idxInGroup=0,this._stillInvisible=!1,this._rotationMatrix=[1,0,0,0,1,0,0,0,1],this.parentId=null,this._globalPosition=E.Zero(),this.idx=e,this._group=t,this.groupId=i,this.idxInGroup=r,this._pcs=n}get size(){return this.size}set size(e){this.size=e}get quaternion(){return this.rotationQuaternion}set quaternion(e){this.rotationQuaternion=e}intersectsMesh(e,t){if(!e.hasBoundingInfo)return!1;if(!this._pcs.mesh)throw new Error("Point Cloud System doesnt contain the Mesh");if(t)return e.getBoundingInfo().boundingSphere.intersectsPoint(this.position.add(this._pcs.mesh.position));let i=e.getBoundingInfo().boundingBox,r=i.maximumWorld.x,n=i.minimumWorld.x,a=i.maximumWorld.y,o=i.minimumWorld.y,l=i.maximumWorld.z,c=i.minimumWorld.z,f=this.position.x+this._pcs.mesh.position.x,h=this.position.y+this._pcs.mesh.position.y,u=this.position.z+this._pcs.mesh.position.z;return n<=f&&f<=r&&o<=h&&h<=a&&c<=u&&u<=l}getRotationMatrix(e){let t;if(this.rotationQuaternion)t=this.rotationQuaternion;else{t=w.Quaternion[0];let i=this.rotation;K.RotationYawPitchRollToRef(i.y,i.x,i.z,t)}t.toRotationMatrix(e)}},oh=class{get groupID(){return this.groupId}set groupID(e){this.groupId=e}constructor(e,t){this.groupId=e,this._positionFunction=t}}});function Td(s,e,t,i,r,n=!1){let a=Ai.Zero();return lh(s,e,t,i,a,r,n),a}function lh(s,e,t,i,r,n,a=!1,o=!1){let l=s.getEngine();if(!n&&!(n=s.activeCamera))return s;let c=n.viewport,f=l.getRenderHeight(),{x:h,y:u,width:d,height:p}=c.toGlobal(l.getRenderWidth(),f),m=1/l.getHardwareScalingLevel();return e=e*m-h,t=t*m-(f-u-p),r.update(e,t,d,p,i||B.IdentityReadOnly,a?B.IdentityReadOnly:n.getViewMatrix(),n.getProjectionMatrix(),o),s}function $0(s,e,t,i){let r=Ai.Zero();return dx(s,e,t,r,i),r}function dx(s,e,t,i,r){if(!Zi)return s;let n=s.getEngine();if(!r&&!(r=s.activeCamera))throw new Error("Active camera not set");let a=r.viewport,o=n.getRenderHeight(),{x:l,y:c,width:f,height:h}=a.toGlobal(n.getRenderWidth(),o),u=B.Identity(),d=1/n.getHardwareScalingLevel();return e=e*d-l,t=t*d-(o-c-h),i.update(e,t,f,h,u,u,r.getProjectionMatrix()),s}function A5(s,e,t,i,r,n,a,o){let l=e(i,t.enableDistantPicking),c=t.intersects(l,r,a,n,i,o);return!c||!c.hit||!r&&s!=null&&c.distance>=s.distance?null:c}function eM(s,e,t,i,r,n){let a=null,o=!!(s.activeCameras&&s.activeCameras.length>1&&s.cameraToUseForPointers!==s.activeCamera),l=s.cameraToUseForPointers||s.activeCamera,c=J0.internalPickerForMesh||A5;for(let f=0;f<s.meshes.length;f++){let h=s.meshes[f];if(t){if(!t(h,-1))continue}else if(!h.isEnabled()||!h.isVisible||!h.isPickable)continue;let u=o&&h.isWorldMatrixCameraDependent(),d=h.computeWorldMatrix(u,l);if(h.hasThinInstances&&h.thinInstanceEnablePicking){let p=c(a,e,h,d,!0,!0,n);if(p){if(r)return p;let m=w.Matrix[1],_=h.thinInstanceGetWorldMatrices();for(let v=0;v<_.length;v++){if(t&&!t(h,v))continue;_[v].multiplyToRef(d,m);let C=c(a,e,h,m,i,r,n,!0);if(C&&(a=C,a.thinInstanceIndex=v,i))return a}}}else{let p=c(a,e,h,d,i,r,n);if(p&&(a=p,i))return a}}return a||new Zi}function R5(s,e,t,i){if(!Zi)return null;let r=[],n=!!(s.activeCameras&&s.activeCameras.length>1&&s.cameraToUseForPointers!==s.activeCamera),a=s.cameraToUseForPointers||s.activeCamera,o=J0.internalPickerForMesh||A5;for(let l=0;l<s.meshes.length;l++){let c=s.meshes[l];if(t){if(!t(c,-1))continue}else if(!c.isEnabled()||!c.isVisible||!c.isPickable)continue;let f=n&&c.isWorldMatrixCameraDependent(),h=c.computeWorldMatrix(f,a);if(c.hasThinInstances&&c.thinInstanceEnablePicking){if(o(null,e,c,h,!0,!0,i)){let d=w.Matrix[1],p=c.thinInstanceGetWorldMatrices();for(let m=0;m<p.length;m++){if(t&&!t(c,m))continue;p[m].multiplyToRef(h,d);let v=o(null,e,c,d,!1,!1,i,!0);v&&(v.thinInstanceIndex=m,r.push(v))}}}else{let u=o(null,e,c,h,!1,!1,i);u&&r.push(u)}}return r}function tM(s,e,t,i,r,n){if(!Zi)return null;let a=eM(s,o=>(s._tempPickingRay||(s._tempPickingRay=Ai.Zero()),lh(s,e,t,o,s._tempPickingRay,n||null),s._tempPickingRay),i,r,!0);return a&&(a.ray=Td(s,e,t,B.Identity(),n||null)),a}function iM(s,e,t,i,r,n,a,o=!1){let l=eM(s,(c,f)=>(s._tempPickingRay||(s._tempPickingRay=Ai.Zero()),lh(s,e,t,c,s._tempPickingRay,n||null,!1,f),s._tempPickingRay),i,r,!1,a);return l&&(l.ray=Td(s,e,t,B.Identity(),n||null)),l}function rM(s,e,t,i,r){let n=eM(s,a=>(s._pickWithRayInverseMatrix||(s._pickWithRayInverseMatrix=B.Identity()),a.invertToRef(s._pickWithRayInverseMatrix),s._cachedRayForTransform||(s._cachedRayForTransform=Ai.Zero()),Ai.TransformToRef(e,s._pickWithRayInverseMatrix,s._cachedRayForTransform),s._cachedRayForTransform),t,i,!1,r);return n&&(n.ray=e),n}function sM(s,e,t,i,r,n){return R5(s,a=>Td(s,e,t,a,r||null),i,n)}function nM(s,e,t,i){return R5(s,r=>(s._pickWithRayInverseMatrix||(s._pickWithRayInverseMatrix=B.Identity()),r.invertToRef(s._pickWithRayInverseMatrix),s._cachedRayForTransform||(s._cachedRayForTransform=Ai.Zero()),Ai.TransformToRef(e,s._pickWithRayInverseMatrix,s._cachedRayForTransform),s._cachedRayForTransform),t,i)}function Rie(s,e=100,t,i){return ux(s,new Ai(E.Zero(),E.Zero(),e),e,t,i)}function ux(s,e,t=100,i,r){i||(i=s.getWorldMatrix()),e.length=t,r?e.origin.copyFrom(r):e.origin.copyFrom(s.position);let n=w.Vector3[2];n.set(0,0,s._scene.useRightHandedSystem?-1:1);let a=w.Vector3[3];return E.TransformNormalToRef(n,i,a),E.NormalizeToRef(a,e.direction),e}function aM(s,e){e&&(e.prototype.getForwardRay=function(t=100,i,r){return ux(this,new Ai(E.Zero(),E.Zero(),t),t,i,r)},e.prototype.getForwardRayToRef=function(t,i=100,r,n){return ux(this,t,i,r,n)}),s&&(Cl._IsPickingAvailable=!0,s.prototype.createPickingRay=function(t,i,r,n,a=!1){return Td(this,t,i,r,n,a)})}var J0,Ai,oM=S(()=>{xr();ie();Hs();nC();Yc();gt();GR();J0={internalPickerForMesh:void 0},Ai=class s{constructor(e,t,i=Number.MAX_VALUE,r=We){this.origin=e,this.direction=t,this.length=i,this.epsilon=r}clone(){return new s(this.origin.clone(),this.direction.clone(),this.length)}intersectsBoxMinMax(e,t,i=0){let r=s._TmpVector3[0].copyFromFloats(e.x-i,e.y-i,e.z-i),n=s._TmpVector3[1].copyFromFloats(t.x+i,t.y+i,t.z+i),a=0,o=Number.MAX_VALUE,l,c,f,h;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<r.x||this.origin.x>n.x)return!1}else if(l=1/this.direction.x,c=(r.x-this.origin.x)*l,f=(n.x-this.origin.x)*l,f===-1/0&&(f=1/0),c>f&&(h=c,c=f,f=h),a=Math.max(c,a),o=Math.min(f,o),a>o)return!1;if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<r.y||this.origin.y>n.y)return!1}else if(l=1/this.direction.y,c=(r.y-this.origin.y)*l,f=(n.y-this.origin.y)*l,f===-1/0&&(f=1/0),c>f&&(h=c,c=f,f=h),a=Math.max(c,a),o=Math.min(f,o),a>o)return!1;if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<r.z||this.origin.z>n.z)return!1}else if(l=1/this.direction.z,c=(r.z-this.origin.z)*l,f=(n.z-this.origin.z)*l,f===-1/0&&(f=1/0),c>f&&(h=c,c=f,f=h),a=Math.max(c,a),o=Math.min(f,o),a>o)return!1;return!0}intersectsBox(e,t=0){return this.intersectsBoxMinMax(e.minimum,e.maximum,t)}intersectsSphere(e,t=0){let i=e.center.x-this.origin.x,r=e.center.y-this.origin.y,n=e.center.z-this.origin.z,a=i*i+r*r+n*n,o=e.radius+t,l=o*o;if(a<=l)return!0;let c=i*this.direction.x+r*this.direction.y+n*this.direction.z;return c<0?!1:a-c*c<=l}intersectsTriangle(e,t,i){let r=s._TmpVector3[0],n=s._TmpVector3[1],a=s._TmpVector3[2],o=s._TmpVector3[3],l=s._TmpVector3[4];t.subtractToRef(e,r),i.subtractToRef(e,n),E.CrossToRef(this.direction,n,a);let c=E.Dot(r,a);if(c===0)return null;let f=1/c;this.origin.subtractToRef(e,o);let h=E.Dot(o,a)*f;if(h<-this.epsilon||h>1+this.epsilon)return null;E.CrossToRef(o,r,l);let u=E.Dot(this.direction,l)*f;if(u<-this.epsilon||h+u>1+this.epsilon)return null;let d=E.Dot(n,l)*f;return d>this.length?null:new Nl(1-h-u,h,d)}intersectsPlane(e){let t,i=E.Dot(e.normal,this.direction);if(Math.abs(i)<999999997475243e-21)return null;{let r=E.Dot(e.normal,this.origin);return t=(-e.d-r)/i,t<0?t<-999999997475243e-21?null:0:t}}intersectsAxis(e,t=0){switch(e){case"y":{let i=(this.origin.y-t)/this.direction.y;return i>0?null:new E(this.origin.x+this.direction.x*-i,t,this.origin.z+this.direction.z*-i)}case"x":{let i=(this.origin.x-t)/this.direction.x;return i>0?null:new E(t,this.origin.y+this.direction.y*-i,this.origin.z+this.direction.z*-i)}case"z":{let i=(this.origin.z-t)/this.direction.z;return i>0?null:new E(this.origin.x+this.direction.x*-i,this.origin.y+this.direction.y*-i,t)}default:return null}}intersectsMesh(e,t,i,r=!1,n,a=!1){let o=w.Matrix[0];return e.getWorldMatrix().invertToRef(o),this._tmpRay?s.TransformToRef(this,o,this._tmpRay):this._tmpRay=s.Transform(this,o),e.intersects(this._tmpRay,t,i,r,n,a)}intersectsMeshes(e,t,i){i?i.length=0:i=[];for(let r=0;r<e.length;r++){let n=this.intersectsMesh(e[r],t);n.hit&&i.push(n)}return i.sort(this._comparePickingInfo),i}_comparePickingInfo(e,t){return e.distance<t.distance?-1:e.distance>t.distance?1:0}intersectionSegment(e,t,i){let r=this.origin,n=w.Vector3[0],a=w.Vector3[1],o=w.Vector3[2],l=w.Vector3[3];t.subtractToRef(e,n),this.direction.scaleToRef(s._Rayl,o),r.addToRef(o,a),e.subtractToRef(r,l);let c=E.Dot(n,n),f=E.Dot(n,o),h=E.Dot(o,o),u=E.Dot(n,l),d=E.Dot(o,l),p=c*h-f*f,m,_=p,v,T=p;p<s._Smallnum?(m=0,_=1,v=d,T=h):(m=f*d-h*u,v=c*d-f*u,m<0?(m=0,v=d,T=h):m>_&&(m=_,v=d+f,T=h)),v<0?(v=0,-u<0?m=0:-u>c?m=_:(m=-u,_=c)):v>T&&(v=T,-u+f<0?m=0:-u+f>c?m=_:(m=-u+f,_=c));let C=Math.abs(m)<s._Smallnum?0:m/_,I=Math.abs(v)<s._Smallnum?0:v/T,R=w.Vector3[4];o.scaleToRef(I,R);let b=w.Vector3[5];n.scaleToRef(C,b),b.addInPlace(l);let M=w.Vector3[6];return b.subtractToRef(R,M),I>0&&I<=this.length&&M.lengthSquared()<i*i?b.length():-1}update(e,t,i,r,n,a,o,l=!1){if(l){s._RayDistant||(s._RayDistant=s.Zero()),s._RayDistant.unprojectRayToRef(e,t,i,r,B.IdentityReadOnly,a,o);let c=w.Matrix[0];n.invertToRef(c),s.TransformToRef(s._RayDistant,c,this)}else this.unprojectRayToRef(e,t,i,r,n,a,o);return this}static Zero(){return new s(E.Zero(),E.Zero())}static CreateNew(e,t,i,r,n,a,o){return s.Zero().update(e,t,i,r,n,a,o)}static CreateNewFromTo(e,t,i=B.IdentityReadOnly){let r=new s(new E(0,0,0),new E(0,0,0));return s.CreateFromToToRef(e,t,r,i)}static CreateFromToToRef(e,t,i,r=B.IdentityReadOnly){i.origin.copyFrom(e);let n=t.subtractToRef(e,i.direction),a=Math.sqrt(n.x*n.x+n.y*n.y+n.z*n.z);return i.length=a,i.direction.normalize(),s.TransformToRef(i,r,i)}static Transform(e,t){let i=new s(new E(0,0,0),new E(0,0,0));return s.TransformToRef(e,t,i),i}static TransformToRef(e,t,i){E.TransformCoordinatesToRef(e.origin,t,i.origin),E.TransformNormalToRef(e.direction,t,i.direction),i.length=e.length,i.epsilon=e.epsilon;let r=i.direction,n=r.length();if(!(n===0||n===1)){let a=1/n;r.x*=a,r.y*=a,r.z*=a,i.length*=n}return i}unprojectRayToRef(e,t,i,r,n,a,o){let l=w.Matrix[0];n.multiplyToRef(a,l),l.multiplyToRef(o,l),l.invert();let c=Z.LastCreatedEngine,f=w.Vector3[0];f.x=e/i*2-1,f.y=-(t/r*2-1),f.z=c?.useReverseDepthBuffer?1:c?.isNDCHalfZRange?0:-1;let h=w.Vector3[1].copyFromFloats(f.x,f.y,1-1e-8),u=w.Vector3[2],d=w.Vector3[3];E.TransformCoordinatesToRef(f,l,u),E.TransformCoordinatesToRef(h,l,d),this.origin.copyFrom(u),d.subtractToRef(u,this.direction),this.direction.normalize()}};Ai._TmpVector3=Gi(6,E.Zero);Ai._RayDistant=Ai.Zero();Ai._Smallnum=1e-8;Ai._Rayl=1e9});var lM={};V(lM,{AddRayExtensions:()=>aM,CreatePickingRay:()=>Td,CreatePickingRayInCameraSpace:()=>$0,CreatePickingRayInCameraSpaceToRef:()=>dx,CreatePickingRayToRef:()=>lh,GetForwardRay:()=>Rie,GetForwardRayToRef:()=>ux,MultiPick:()=>sM,MultiPickWithRay:()=>nM,Pick:()=>iM,PickWithBoundingInfo:()=>tM,PickWithRay:()=>rM,PickingCustomization:()=>J0,Ray:()=>Ai});var px=S(()=>{Xr();Vn();oM();oM();aM(ze,ye);ze.prototype.createPickingRayToRef=function(s,e,t,i,r,n=!1,a=!1){return lh(this,s,e,t,i,r,n,a)};ze.prototype.createPickingRayInCameraSpace=function(s,e,t){return $0(this,s,e,t)};ze.prototype.createPickingRayInCameraSpaceToRef=function(s,e,t,i){return dx(this,s,e,t,i)};ze.prototype.pickWithBoundingInfo=function(s,e,t,i,r){return tM(this,s,e,t,i,r)};ze.prototype.pick=function(s,e,t,i,r,n,a=!1){return iM(this,s,e,t,i,r,n,a)};ze.prototype.pickWithRay=function(s,e,t,i){return rM(this,s,e,t,i)};ze.prototype.multiPick=function(s,e,t,i,r){return sM(this,s,e,t,i,r)};ze.prototype.multiPickWithRay=function(s,e,t){return nM(this,s,e,t)}});var b5,mx,C5=S(()=>{ml();ie();Ee();yt();ln();Ki();gt();x5();px();nc();ma();di();(function(s){s[s.Color=2]="Color",s[s.UV=1]="UV",s[s.Random=0]="Random",s[s.Stated=3]="Stated"})(b5||(b5={}));mx=class{get positions(){return this._positions32}get colors(){return this._colors32}get uvs(){return this._uvs32}constructor(e,t,i,r){this.particles=new Array,this.nbParticles=0,this.counter=0,this.vars={},this._promises=[],this._positions=new Array,this._indices=new Array,this._normals=new Array,this._colors=new Array,this._uvs=new Array,this._updatable=!0,this._isVisibilityBoxLocked=!1,this._alwaysVisible=!1,this._groups=new Array,this._groupCounter=0,this._computeParticleColor=!0,this._computeParticleTexture=!0,this._computeParticleRotation=!0,this._computeBoundingBox=!1,this._isReady=!1,this.name=e,this._size=t,this._scene=i||Z.LastCreatedScene,r&&r.updatable!==void 0?this._updatable=r.updatable:this._updatable=!0}async buildMeshAsync(e){return await Promise.all(this._promises),this._isReady=!0,await this._buildMeshAsync(e)}async _buildMeshAsync(e){this.nbParticles===0&&this.addPoints(1),this._positions32=new Float32Array(this._positions),this._uvs32=new Float32Array(this._uvs),this._colors32=new Float32Array(this._colors);let t=new Ge;t.set(this._positions32,A.PositionKind),this._uvs32.length>0&&t.set(this._uvs32,A.UVKind);let i=0;this._colors32.length>0&&(i=1,t.set(this._colors32,A.ColorKind));let r=new fe(this.name,this._scene);t.applyToMesh(r,this._updatable),this.mesh=r,this._positions=null,this._uvs=null,this._colors=null,this._updatable||(this.particles.length=0);let n=e;return n||(n=new Se("point cloud material",this._scene),n.emissiveColor=new j(i,i,i),n.disableLighting=!0,n.pointsCloud=!0,n.pointSize=this._size),r.material=n,r}_addParticle(e,t,i,r){let n=new hx(e,t,i,r,this);return this.particles.push(n),n}_randomUnitVector(e){e.position=new E(Math.random(),Math.random(),Math.random()),e.color=new me(1,1,1,1)}_getColorIndicesForCoord(e,t,i,r){let n=e._groupImageData,a=i*(r*4)+t*4,o=[a,a+1,a+2,a+3],l=o[0],c=o[1],f=o[2],h=o[3],u=n[l],d=n[c],p=n[f],m=n[h];return new me(u/255,d/255,p/255,m)}_setPointsColorOrUV(e,t,i,r,n,a,o,l){l=l??0,i&&e.updateFacetData();let f=2*e.getBoundingInfo().boundingSphere.radius,h=e.getVerticesData(A.PositionKind),u=e.getIndices(),d=e.getVerticesData(A.UVKind+(l?l+1:"")),p=e.getVerticesData(A.ColorKind),m=E.Zero();e.computeWorldMatrix();let _=e.getWorldMatrix();if(!_.isIdentity()){h=h.slice(0);for(let qi=0;qi<h.length/3;qi++)E.TransformCoordinatesFromFloatsToRef(h[3*qi],h[3*qi+1],h[3*qi+2],_,m),h[3*qi]=m.x,h[3*qi+1]=m.y,h[3*qi+2]=m.z}let v=0,T=0,C=0,I=0,R=0,b=0,M=0,F=0,U=0,D=0,$=0,oe=0,re=0,se=E.Zero(),be=E.Zero(),Me=E.Zero(),ke=E.Zero(),de=E.Zero(),Qe=0,Re=0,Ae=0,ut=0,Et=0,Er=0,Tr=he.Zero(),Le=he.Zero(),uo=he.Zero(),Qt=he.Zero(),vn=he.Zero(),Sn=0,En=0,Tn=0,_s=0,gs=0,vs=0,Ss=0,Kd=0,qd=0,nD=0,aD=0,oD=0,Ah=Oe.Zero(),gA=Oe.Zero(),lD=Oe.Zero(),cD=Oe.Zero(),fD=Oe.Zero(),fl=0,Qd=0;o=o||0;let Rh,jd,Ht=new Oe(0,0,0,0),vA=E.Zero(),SA=E.Zero(),hD=E.Zero(),dc=0,uD=E.Zero(),dD=0,pD=0,Zd=new Ai(E.Zero(),new E(1,0,0)),EA,Jd=E.Zero();for(let qi=0;qi<u.length/3;qi++){T=u[3*qi],C=u[3*qi+1],I=u[3*qi+2],R=h[3*T],b=h[3*T+1],M=h[3*T+2],F=h[3*C],U=h[3*C+1],D=h[3*C+2],$=h[3*I],oe=h[3*I+1],re=h[3*I+2],se.set(R,b,M),be.set(F,U,D),Me.set($,oe,re),be.subtractToRef(se,ke),Me.subtractToRef(be,de),d&&(Qe=d[2*T],Re=d[2*T+1],Ae=d[2*C],ut=d[2*C+1],Et=d[2*I],Er=d[2*I+1],Tr.set(Qe,Re),Le.set(Ae,ut),uo.set(Et,Er),Le.subtractToRef(Tr,Qt),uo.subtractToRef(Le,vn)),p&&r&&(Sn=p[4*T],En=p[4*T+1],Tn=p[4*T+2],_s=p[4*T+3],gs=p[4*C],vs=p[4*C+1],Ss=p[4*C+2],Kd=p[4*C+3],qd=p[4*I],nD=p[4*I+1],aD=p[4*I+2],oD=p[4*I+3],Ah.set(Sn,En,Tn,_s),gA.set(gs,vs,Ss,Kd),lD.set(qd,nD,aD,oD),gA.subtractToRef(Ah,cD),lD.subtractToRef(gA,fD));let TA,mD,_D,gD,vD,pc,mc,$d,SD=new j(0,0,0),ep=new j(0,0,0),_c,Es;for(let xA=0;xA<t._groupDensity[qi];xA++)v=this.particles.length,this._addParticle(v,t,this._groupCounter,qi+xA),Es=this.particles[v],fl=Math.sqrt(bt(0,1)),Qd=bt(0,1),Rh=se.add(ke.scale(fl)).add(de.scale(fl*Qd)),i&&(vA=e.getFacetNormal(qi).normalize().scale(-1),SA=ke.clone().normalize(),hD=E.Cross(vA,SA),dc=bt(0,2*Math.PI),uD=SA.scale(Math.cos(dc)).add(hD.scale(Math.sin(dc))),dc=bt(.1,Math.PI/2),Jd=uD.scale(Math.cos(dc)).add(vA.scale(Math.sin(dc))),Zd.origin=Rh.add(Jd.scale(1e-5)),Zd.direction=Jd,Zd.length=f,EA=Zd.intersectsMesh(e),EA.hit&&(pD=EA.pickedPoint.subtract(Rh).length(),dD=bt(0,1)*pD,Rh.addInPlace(Jd.scale(dD)))),Es.position=Rh.clone(),this._positions.push(Es.position.x,Es.position.y,Es.position.z),r!==void 0?d&&(jd=Tr.add(Qt.scale(fl)).add(vn.scale(fl*Qd)),r?n&&t._groupImageData!==null?(TA=t._groupImgWidth,mD=t._groupImgHeight,_c=this._getColorIndicesForCoord(t,Math.round(jd.x*TA),Math.round(jd.y*mD),TA),Es.color=_c,this._colors.push(_c.r,_c.g,_c.b,_c.a)):p?(Ht=Ah.add(cD.scale(fl)).add(fD.scale(fl*Qd)),Es.color=new me(Ht.x,Ht.y,Ht.z,Ht.w),this._colors.push(Ht.x,Ht.y,Ht.z,Ht.w)):(Ht=Ah.set(Math.random(),Math.random(),Math.random(),1),Es.color=new me(Ht.x,Ht.y,Ht.z,Ht.w),this._colors.push(Ht.x,Ht.y,Ht.z,Ht.w)):(Es.uv=jd.clone(),this._uvs.push(Es.uv.x,Es.uv.y))):(a?(SD.set(a.r,a.g,a.b),_D=bt(-o,o),gD=bt(-o,o),$d=SD.toHSV(),vD=$d.r,pc=$d.g+_D,mc=$d.b+gD,pc<0&&(pc=0),pc>1&&(pc=1),mc<0&&(mc=0),mc>1&&(mc=1),j.HSVtoRGBToRef(vD,pc,mc,ep),Ht.set(ep.r,ep.g,ep.b,1)):Ht=Ah.set(Math.random(),Math.random(),Math.random(),1),Es.color=new me(Ht.x,Ht.y,Ht.z,Ht.w),this._colors.push(Ht.x,Ht.y,Ht.z,Ht.w))}}_colorFromTexture(e,t,i){if(e.material===null){P.Warn(e.name+"has no material."),t._groupImageData=null,this._setPointsColorOrUV(e,t,i,!0,!1);return}let n=e.material.getActiveTextures();if(n.length===0){P.Warn(e.name+"has no usable texture."),t._groupImageData=null,this._setPointsColorOrUV(e,t,i,!0,!1);return}let a=e.clone();a.setEnabled(!1),this._promises.push(new Promise(o=>{nt.WhenAllReady(n,()=>{let l=t._textureNb;l<0&&(l=0),l>n.length-1&&(l=n.length-1);let c=()=>{t._groupImgWidth=n[l].getSize().width,t._groupImgHeight=n[l].getSize().height,this._setPointsColorOrUV(a,t,i,!0,!0,void 0,void 0,n[l].coordinatesIndex),a.dispose(),o()};t._groupImageData=null;let f=n[l].readPixels();f?f.then(h=>{t._groupImageData=h,c()}):c()})}))}_calculateDensity(e,t,i){let r,n,a,o,l,c,f,h,u,d,p,m,_=E.Zero(),v=E.Zero(),T=E.Zero(),C=E.Zero(),I=E.Zero(),R=E.Zero(),b,M=[],F=0,U=i.length/3;for(let oe=0;oe<U;oe++)r=i[3*oe],n=i[3*oe+1],a=i[3*oe+2],o=t[3*r],l=t[3*r+1],c=t[3*r+2],f=t[3*n],h=t[3*n+1],u=t[3*n+2],d=t[3*a],p=t[3*a+1],m=t[3*a+2],_.set(o,l,c),v.set(f,h,u),T.set(d,p,m),v.subtractToRef(_,C),T.subtractToRef(v,I),E.CrossToRef(C,I,R),b=.5*R.length(),F+=b,M[oe]=F;let D=new Array(U),$=e;for(let oe=U-1;oe>0;oe--){let re=M[oe];if(re===0)D[oe]=0;else{let be=(re-M[oe-1])/re*$,Me=Math.floor(be),ke=be-Me,de=+(Math.random()<ke),Qe=Me+de;D[oe]=Qe,$-=Qe}}return D[0]=$,D}addPoints(e,t=this._randomUnitVector){let i=new oh(this._groupCounter,t),r,n=this.nbParticles;for(let a=0;a<e;a++)r=this._addParticle(n,i,this._groupCounter,a),i&&i._positionFunction&&i._positionFunction(r,n,a),this._positions.push(r.position.x,r.position.y,r.position.z),r.color&&this._colors.push(r.color.r,r.color.g,r.color.b,r.color.a),r.uv&&this._uvs.push(r.uv.x,r.uv.y),n++;return this.nbParticles+=e,this._groupCounter++,this._groupCounter}addSurfacePoints(e,t,i,r,n){let a=i||0;(isNaN(a)||a<0||a>3)&&(a=0);let o=e.getVerticesData(A.PositionKind),l=e.getIndices();this._groups.push(this._groupCounter);let c=new oh(this._groupCounter,null);switch(c._groupDensity=this._calculateDensity(t,o,l),a===2?c._textureNb=r||0:r=r||new me(1,1,1,1),a){case 2:this._colorFromTexture(e,c,!1);break;case 1:this._setPointsColorOrUV(e,c,!1,!1,!1);break;case 0:this._setPointsColorOrUV(e,c,!1);break;case 3:this._setPointsColorOrUV(e,c,!1,void 0,void 0,r,n);break}return this.nbParticles+=t,this._groupCounter++,this._groupCounter-1}addVolumePoints(e,t,i,r,n){let a=i||0;(isNaN(a)||a<0||a>3)&&(a=0);let o=e.getVerticesData(A.PositionKind),l=e.getIndices();this._groups.push(this._groupCounter);let c=new oh(this._groupCounter,null);switch(c._groupDensity=this._calculateDensity(t,o,l),a===2?c._textureNb=r||0:r=r||new me(1,1,1,1),a){case 2:this._colorFromTexture(e,c,!0);break;case 1:this._setPointsColorOrUV(e,c,!0,!1,!1);break;case 0:this._setPointsColorOrUV(e,c,!0);break;case 3:this._setPointsColorOrUV(e,c,!0,void 0,void 0,r,n);break}return this.nbParticles+=t,this._groupCounter++,this._groupCounter-1}setParticles(e=0,t=this.nbParticles-1,i=!0){if(!this._updatable||!this._isReady)return this;this.beforeUpdateParticles(e,t,i);let r=w.Matrix[0],n=this.mesh,a=this._colors32,o=this._positions32,l=this._uvs32,c=w.Vector3,f=c[5].copyFromFloats(1,0,0),h=c[6].copyFromFloats(0,1,0),u=c[7].copyFromFloats(0,0,1),d=c[8].setAll(Number.MAX_VALUE),p=c[9].setAll(-Number.MAX_VALUE);B.IdentityToRef(r);let m=0;if(this.mesh?.isFacetDataEnabled&&(this._computeBoundingBox=!0),t=t>=this.nbParticles?this.nbParticles-1:t,this._computeBoundingBox&&(e!=0||t!=this.nbParticles-1)){let C=this.mesh?.getBoundingInfo();C&&(d.copyFrom(C.minimum),p.copyFrom(C.maximum))}m=0;let _=0,v=0,T=0;for(let C=e;C<=t;C++){let I=this.particles[C];m=I.idx,_=3*m,v=4*m,T=2*m,this.updateParticle(I);let R=I._rotationMatrix,b=I.position,M=I._globalPosition;if(this._computeParticleRotation&&I.getRotationMatrix(r),I.parentId!==null){let Re=this.particles[I.parentId],Ae=Re._rotationMatrix,ut=Re._globalPosition,Et=b.x*Ae[1]+b.y*Ae[4]+b.z*Ae[7],Er=b.x*Ae[0]+b.y*Ae[3]+b.z*Ae[6],Tr=b.x*Ae[2]+b.y*Ae[5]+b.z*Ae[8];if(M.x=ut.x+Er,M.y=ut.y+Et,M.z=ut.z+Tr,this._computeParticleRotation){let Le=r.m;R[0]=Le[0]*Ae[0]+Le[1]*Ae[3]+Le[2]*Ae[6],R[1]=Le[0]*Ae[1]+Le[1]*Ae[4]+Le[2]*Ae[7],R[2]=Le[0]*Ae[2]+Le[1]*Ae[5]+Le[2]*Ae[8],R[3]=Le[4]*Ae[0]+Le[5]*Ae[3]+Le[6]*Ae[6],R[4]=Le[4]*Ae[1]+Le[5]*Ae[4]+Le[6]*Ae[7],R[5]=Le[4]*Ae[2]+Le[5]*Ae[5]+Le[6]*Ae[8],R[6]=Le[8]*Ae[0]+Le[9]*Ae[3]+Le[10]*Ae[6],R[7]=Le[8]*Ae[1]+Le[9]*Ae[4]+Le[10]*Ae[7],R[8]=Le[8]*Ae[2]+Le[9]*Ae[5]+Le[10]*Ae[8]}}else if(M.x=0,M.y=0,M.z=0,this._computeParticleRotation){let Re=r.m;R[0]=Re[0],R[1]=Re[1],R[2]=Re[2],R[3]=Re[4],R[4]=Re[5],R[5]=Re[6],R[6]=Re[8],R[7]=Re[9],R[8]=Re[10]}let U=c[11];I.translateFromPivot?U.setAll(0):U.copyFrom(I.pivot);let D=c[0];D.copyFrom(I.position);let $=D.x-I.pivot.x,oe=D.y-I.pivot.y,re=D.z-I.pivot.z,se=$*R[0]+oe*R[3]+re*R[6],be=$*R[1]+oe*R[4]+re*R[7],Me=$*R[2]+oe*R[5]+re*R[8];se+=U.x,be+=U.y,Me+=U.z;let ke=o[_]=M.x+f.x*se+h.x*be+u.x*Me,de=o[_+1]=M.y+f.y*se+h.y*be+u.y*Me,Qe=o[_+2]=M.z+f.z*se+h.z*be+u.z*Me;if(this._computeBoundingBox&&(d.minimizeInPlaceFromFloats(ke,de,Qe),p.maximizeInPlaceFromFloats(ke,de,Qe)),this._computeParticleColor&&I.color){let Re=I.color,Ae=this._colors32;Ae[v]=Re.r,Ae[v+1]=Re.g,Ae[v+2]=Re.b,Ae[v+3]=Re.a}if(this._computeParticleTexture&&I.uv){let Re=I.uv,Ae=this._uvs32;Ae[T]=Re.x,Ae[T+1]=Re.y}}return n&&(i&&(this._computeParticleColor&&n.updateVerticesData(A.ColorKind,a,!1,!1),this._computeParticleTexture&&n.updateVerticesData(A.UVKind,l,!1,!1),n.updateVerticesData(A.PositionKind,o,!1,!1)),this._computeBoundingBox&&(n.hasBoundingInfo?n.getBoundingInfo().reConstruct(d,p,n._worldMatrix):n.buildBoundingInfo(d,p,n._worldMatrix))),this.afterUpdateParticles(e,t,i),this}dispose(){this.mesh?.dispose(),this.vars=null,this._positions=null,this._indices=null,this._normals=null,this._uvs=null,this._colors=null,this._indices32=null,this._positions32=null,this._uvs32=null,this._colors32=null}refreshVisibleSize(){return this._isVisibilityBoxLocked||this.mesh?.refreshBoundingInfo(),this}setVisibilityBox(e){if(!this.mesh)return;let t=e/2;this.mesh.buildBoundingInfo(new E(-t,-t,-t),new E(t,t,t))}get isAlwaysVisible(){return this._alwaysVisible}set isAlwaysVisible(e){this.mesh&&(this._alwaysVisible=e,this.mesh.alwaysSelectAsActiveMesh=e)}set computeParticleRotation(e){this._computeParticleRotation=e}set computeParticleColor(e){this._computeParticleColor=e}set computeParticleTexture(e){this._computeParticleTexture=e}get computeParticleColor(){return this._computeParticleColor}get computeParticleTexture(){return this._computeParticleTexture}set computeBoundingBox(e){this._computeBoundingBox=e}get computeBoundingBox(){return this._computeBoundingBox}initParticles(){}recycleParticle(e){return e}updateParticle(e){return e}beforeUpdateParticles(e,t,i){}afterUpdateParticles(e,t,i){}}});var y5={};V(y5,{SPLATFileLoader:()=>xd});var I5,xd,M5=S(()=>{Qo();jI();T5();Gf();Ki();Ee();ie();C5();it();ln();Z0();(function(s){s[s.Splat=0]="Splat",s[s.PointCloud=1]="PointCloud",s[s.Mesh=2]="Mesh",s[s.Reject=3]="Reject"})(I5||(I5={}));xd=class s{constructor(e=s._DefaultLoadingOptions){this.name=kl.name,this._assetContainer=null,this.extensions=kl.extensions,this._loadingOptions=e}createPlugin(e){return new s(e[kl.name])}async importMeshAsync(e,t,i,r,n,a){return await this._parseAsync(e,t,i,r).then(o=>({meshes:o,particleSystems:[],skeletons:[],animationGroups:[],transformNodes:[],geometries:[],lights:[],spriteManagers:[]}))}static _BuildPointCloud(e,t){if(!t.byteLength)return!1;let i=new Uint8Array(t),r=new Float32Array(t),n=32,a=i.length/n,o=function(l,c){let f=r[8*c+0],h=r[8*c+1],u=r[8*c+2];l.position=new E(f,h,u);let d=i[n*c+24+0]/255,p=i[n*c+24+1]/255,m=i[n*c+24+2]/255;l.color=new me(d,p,m,1)};return e.addPoints(a,o),!0}static _BuildMesh(e,t){let i=new fe("PLYMesh",e),r=new Uint8Array(t.data),n=new Float32Array(t.data),a=32,o=r.length/a,l=[],c=new Ge;for(let f=0;f<o;f++){let h=n[8*f+0],u=n[8*f+1],d=n[8*f+2];l.push(h,u,d)}if(t.hasVertexColors){let f=new Float32Array(o*4);for(let h=0;h<o;h++){let u=r[a*h+24+0]/255,d=r[a*h+24+1]/255,p=r[a*h+24+2]/255;f[h*4+0]=u,f[h*4+1]=d,f[h*4+2]=p,f[h*4+3]=1}c.colors=f}return c.positions=l,c.indices=t.faces,c.applyToMesh(i),i}_parseSPZAsync(e,t){let i=new Uint8Array(e),r=new Uint32Array(e.slice(0,12)),n=r[2],a=i[12],o=i[13],l=i[14],c=i[15],f=r[1];if(c||r[0]!=1347635022||f!=2&&f!=3)return new Promise(U=>{U({mode:3,data:u,hasVertexColors:!1})});let h=32,u=new ArrayBuffer(h*n),d=1/(1<<o),p=new Int32Array(1),m=new Uint8Array(p.buffer),_=function(U,D){return m[0]=U[D+0],m[1]=U[D+1],m[2]=U[D+2],m[3]=U[D+2]&128?255:0,p[0]*d},v=16,T=new Float32Array(u),C=new Float32Array(u),I=new Uint8ClampedArray(u),R=new Uint8ClampedArray(u),b=1,M=0;this._loadingOptions.flipY||(b=-1,M=255);for(let U=0;U<n;U++)T[U*8+0]=_(i,v+0),T[U*8+1]=b*_(i,v+3),T[U*8+2]=b*_(i,v+6),v+=9;let F=.282;for(let U=0;U<n;U++){for(let D=0;D<3;D++){let oe=(i[v+n+U*3+D]-127.5)/(.15*255);I[U*32+24+D]=ps.Clamp((.5+F*oe)*255,0,255)}I[U*32+24+3]=i[v+U]}v+=n*4;for(let U=0;U<n;U++)C[U*8+3+0]=Math.exp(i[v+0]/16-10),C[U*8+3+1]=Math.exp(i[v+1]/16-10),C[U*8+3+2]=Math.exp(i[v+2]/16-10),v+=3;if(f>=3){let U=Math.SQRT1_2;for(let D=0;D<n;D++){let $=[i[v+0],i[v+1],i[v+2],i[v+3]],oe=$[0]+($[1]<<8)+($[2]<<16)+($[3]<<24),re=511,se=[],be=oe>>>30,Me=oe,ke=0;for(let Re=3;Re>=0;--Re)if(Re!==be){let Ae=Me&re,ut=Me>>>9&1;Me=Me>>>10,se[Re]=U*(Ae/re),ut===1&&(se[Re]=-se[Re]),ke+=se[Re]*se[Re]}let de=1-ke;se[be]=Math.sqrt(Math.max(de,0)),se[1]*=b,se[2]*=b;let Qe=[3,0,1,2];for(let Re=0;Re<4;Re++)R[D*32+28+Re]=Math.round(127.5+se[Qe[Re]]*127.5);v+=4}}else for(let U=0;U<n;U++){let D=i[v+0],$=i[v+1]*b+M,oe=i[v+2]*b+M,re=D/127.5-1,se=$/127.5-1,be=oe/127.5-1;R[U*32+28+1]=D,R[U*32+28+2]=$,R[U*32+28+3]=oe;let Me=1-(re*re+se*se+be*be);R[U*32+28+0]=127.5+Math.sqrt(Me<0?0:Me)*127.5,v+=3}if(a){let D=((a+1)*(a+1)-1)*3,$=Math.ceil(D/16),oe=v,re=[],be=t.getEngine().getCaps().maxTextureSize,Me=Math.ceil(n/be);for(let ke=0;ke<$;ke++){let de=new Uint8Array(Me*be*4*4);re.push(de)}for(let ke=0;ke<n;ke++)for(let de=0;de<D;de++){let Qe=i[oe++],Re=Math.floor(de/16),Ae=re[Re],ut=de%16,Et=ke*16;Ae[ut+Et]=Qe}return new Promise(ke=>{ke({mode:0,data:u,hasVertexColors:!1,sh:re,trainedWithAntialiasing:!!l})})}return new Promise(U=>{U({mode:0,data:u,hasVertexColors:!1,trainedWithAntialiasing:!!l})})}_parseAsync(e,t,i,r){let n=[],a=new ReadableStream({start(c){c.enqueue(new Uint8Array(i)),c.close()}}),o=new DecompressionStream("gzip"),l=a.pipeThrough(o);return new Promise(c=>{new Response(l).arrayBuffer().then(f=>{this._parseSPZAsync(f,t).then(h=>{t._blockEntityCollection=!!this._assetContainer;let u=new Gs("GaussianSplatting",null,t,this._loadingOptions.keepInRam);if(h.trainedWithAntialiasing){let d=u.material;d.kernelSize=.1,d.compensation=!0}u._parentContainer=this._assetContainer,n.push(u),u.updateData(h.data,h.sh),t._blockEntityCollection=!1,c(n)})}).catch(()=>{s._ConvertPLYToSplat(i).then(async f=>{switch(t._blockEntityCollection=!!this._assetContainer,f.mode){case 0:{let h=new Gs("GaussianSplatting",null,t,this._loadingOptions.keepInRam);h._parentContainer=this._assetContainer,n.push(h),h.updateData(f.data,f.sh),(f.compressed||!f.rawSplat)&&h.viewDirectionFactor.set(-1,-1,1)}break;case 1:{let h=new mx("PointCloud",1,t);s._BuildPointCloud(h,f.data)?await h.buildMeshAsync().then(u=>{n.push(u)}):h.dispose()}break;case 2:if(f.faces)n.push(s._BuildMesh(t,f));else throw new Error("PLY mesh doesn't contain face informations.");break;default:throw new Error("Unsupported Splat mode")}t._blockEntityCollection=!1,c(n)})})})}loadAssetContainerAsync(e,t,i){let r=new Bs(e);return this._assetContainer=r,this.importMeshAsync(null,e,t,i).then(n=>{for(let a of n.meshes)r.meshes.push(a);return this._assetContainer=null,r}).catch(n=>{throw this._assetContainer=null,n})}loadAsync(e,t,i){return this.importMeshAsync(null,e,t,i).then(()=>{})}static _ConvertPLYToSplat(e){let t=new Uint8Array(e),i=new TextDecoder().decode(t.slice(0,1024*10)),r=`end_header
`,n=i.indexOf(r);if(n<0||!i)return new Promise(R=>{R({mode:0,data:e,rawSplat:!0})});let a=parseInt(/element vertex (\d+)\n/.exec(i)[1]),o=/element face (\d+)\n/.exec(i),l=0;o&&(l=parseInt(o[1]));let c=/element chunk (\d+)\n/.exec(i),f=0;c&&(f=parseInt(c[1]));let h=0,u=0,d={double:8,int:4,uint:4,float:4,short:2,ushort:2,uchar:1,list:0},p;(function(R){R[R.Vertex=0]="Vertex",R[R.Chunk=1]="Chunk",R[R.SH=2]="SH"})(p||(p={}));let m=1,_=[],v=[],T=i.slice(0,n).split(`
`);for(let R of T)if(R.startsWith("property ")){let[,b,M]=R.split(" ");m==1?(v.push({name:M,type:b,offset:u}),u+=d[b]):m==0?(_.push({name:M,type:b,offset:h}),h+=d[b]):m==2&&_.push({name:M,type:b,offset:h}),d[b]||P.Warn(`Unsupported property type: ${b}.`)}else if(R.startsWith("element ")){let[,b]=R.split(" ");b=="chunk"?m=1:b=="vertex"?m=0:b=="sh"&&(m=2)}let C=h,I=u;return Gs.ConvertPLYWithSHToSplatAsync(e).then(async R=>{let b=new DataView(e,n+r.length),M=I*f+C*a,F=[];if(l)for(let be=0;be<l;be++){let Me=b.getUint8(M);if(Me==3){M+=1;for(let ke=0;ke<Me;ke++){let de=b.getUint32(M+(2-ke)*4,!0);F.push(de)}M+=12}}if(f)return await new Promise(be=>{be({mode:0,data:R.buffer,sh:R.sh,faces:F,hasVertexColors:!1,compressed:!0,rawSplat:!1})});let U=0,D=0,$=["x","y","z","scale_0","scale_1","scale_2","opacity","rot_0","rot_1","rot_2","rot_3"],oe=["red","green","blue","f_dc_0","f_dc_1","f_dc_2"];for(let be=0;be<_.length;be++){let Me=_[be];$.includes(Me.name)&&U++,oe.includes(Me.name)&&D++}let re=U==$.length&&D==3,se=l?2:re?0:1;return await new Promise(be=>{be({mode:se,data:R.buffer,sh:R.sh,faces:F,hasVertexColors:!!D,compressed:!1,rawSplat:!1})})})}};xd._DefaultLoadingOptions={keepInRam:!1,flipY:!1};$i(new xd)});var P5={};V(P5,{STLFileLoader:()=>Ad});var Ad,D5=S(()=>{$e();yt();Ki();Qo();Gf();ZI();nc();Ad=class s{constructor(){this.solidPattern=/solid (\S*)([\S\s]*?)endsolid[ ]*(\S*)/g,this.facetsPattern=/facet([\s\S]*?)endfacet/g,this.normalPattern=/normal[\s]+([-+]?[0-9]+\.?[0-9]*([eE][-+]?[0-9]+)?)+[\s]+([-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?)+[\s]+([-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?)+/g,this.vertexPattern=/vertex[\s]+([-+]?[0-9]+\.?[0-9]*([eE][-+]?[0-9]+)?)+[\s]+([-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?)+[\s]+([-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?)+/g,this.name=Vu.name,this.extensions=Vu.extensions}importMesh(e,t,i,r,n){let a;if(typeof i!="string"){if(this._isBinary(i)){let o=new fe("stlmesh",t);return this._parseBinary(o,i),n&&n.push(o),!0}i=new TextDecoder().decode(new Uint8Array(i))}for(;a=this.solidPattern.exec(i);){let o=a[1],l=a[3];if(l&&o!=l)return W.Error("Error in STL, solid name != endsolid name"),!1;if(e&&o){if(e instanceof Array){if(!e.indexOf(o))continue}else if(o!==e)continue}o=o||"stlmesh";let c=new fe(o,t);this._parseASCII(c,a[2]),n&&n.push(c)}return!0}load(e,t,i){return this.importMesh(null,e,t,i,null)}loadAssetContainer(e,t,i){let r=new Bs(e);return e._blockEntityCollection=!0,this.importMesh(null,e,t,i,r.meshes),e._blockEntityCollection=!1,r}_isBinary(e){let t=new DataView(e);if(t.byteLength<=80)return!1;let i=32/8*3+32/8*3*3+16/8,r=t.getUint32(80,!0);if(80+32/8+r*i===t.byteLength)return!0;let n=[115,111,108,105,100];for(let a=0;a<5;a++)if(t.getUint8(a)!==n[a])return!0;return!1}_parseBinary(e,t){let i=new DataView(t),r=i.getUint32(80,!0),n=84,a=50,o=0,l=new Float32Array(r*3*3),c=new Float32Array(r*3*3),f=new Uint32Array(r*3),h=0;for(let u=0;u<r;u++){let d=n+u*a,p=i.getFloat32(d,!0),m=i.getFloat32(d+4,!0),_=i.getFloat32(d+8,!0);for(let v=1;v<=3;v++){let T=d+v*12;l[o]=i.getFloat32(T,!0),c[o]=p,s.DO_NOT_ALTER_FILE_COORDINATES?(l[o+1]=i.getFloat32(T+4,!0),l[o+2]=i.getFloat32(T+8,!0),c[o+1]=m,c[o+2]=_):(l[o+2]=i.getFloat32(T+4,!0),l[o+1]=i.getFloat32(T+8,!0),c[o+2]=m,c[o+1]=_),o+=3}s.DO_NOT_ALTER_FILE_COORDINATES?(f[h]=h,f[h+1]=h+2,f[h+2]=h+1,h+=3):(f[h]=h++,f[h]=h++,f[h]=h++)}e.setVerticesData(A.PositionKind,l),e.setVerticesData(A.NormalKind,c),e.setIndices(f),e.computeWorldMatrix(!0)}_parseASCII(e,t){let i=[],r=[],n=[],a=0,o;for(;o=this.facetsPattern.exec(t);){let l=o[1],c=this.normalPattern.exec(l);if(this.normalPattern.lastIndex=0,!c)continue;let f=[Number(c[1]),Number(c[5]),Number(c[3])],h;for(;h=this.vertexPattern.exec(l);)s.DO_NOT_ALTER_FILE_COORDINATES?(i.push(Number(h[1]),Number(h[3]),Number(h[5])),r.push(f[0],f[2],f[1])):(i.push(Number(h[1]),Number(h[5]),Number(h[3])),r.push(f[0],f[1],f[2]));s.DO_NOT_ALTER_FILE_COORDINATES?(n.push(a,a+2,a+1),a+=3):n.push(a++,a++,a++),this.vertexPattern.lastIndex=0}this.facetsPattern.lastIndex=0,e.setVerticesData(A.PositionKind,i),e.setVerticesData(A.NormalKind,r),e.setIndices(n),e.computeWorldMatrix(!0)}};Ad.DO_NOT_ALTER_FILE_COORDINATES=!1;$i(new Ad)});var w5={};V(w5,{hdrFilteringVertexShaderWGSL:()=>bie});var cM,L5,bie,F5=S(()=>{O();cM="hdrFilteringVertexShader",L5=`attribute position: vec2f;varying direction: vec3f;uniform up: vec3f;uniform right: vec3f;uniform front: vec3f;
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
var view: mat3x3f= mat3x3f(uniforms.up,uniforms.right,uniforms.front);vertexOutputs.direction=view*vec3f(input.position,1.0);vertexOutputs.position= vec4f(input.position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;g.ShadersStoreWGSL[cM]||(g.ShadersStoreWGSL[cM]=L5);bie={name:cM,shader:L5}});var B5={};V(B5,{hdrFilteringPixelShaderWGSL:()=>Cie});var fM,N5,Cie,U5=S(()=>{O();Pi();Ru();Pf();bu();fM="hdrFilteringPixelShader",N5=`#include<helperFunctions>
#include<importanceSampling>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
uniform alphaG: f32;var inputTextureSampler: sampler;var inputTexture: texture_cube<f32>;uniform vFilteringInfo: vec2f;uniform hdrScale: f32;varying direction: vec3f;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var color: vec3f=radiance(uniforms.alphaG,inputTexture,inputTextureSampler,input.direction,uniforms.vFilteringInfo);fragmentOutputs.color= vec4f(color*uniforms.hdrScale,1.0);}`;g.ShadersStoreWGSL[fM]||(g.ShadersStoreWGSL[fM]=N5);Cie={name:fM,shader:N5}});var V5={};V(V5,{hdrFilteringVertexShader:()=>Iie});var hM,G5,Iie,k5=S(()=>{O();hM="hdrFilteringVertexShader",G5=`attribute vec2 position;varying vec3 direction;uniform vec3 up;uniform vec3 right;uniform vec3 front;
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
mat3 view=mat3(up,right,front);direction=view*vec3(position,1.0);gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;g.ShadersStore[hM]||(g.ShadersStore[hM]=G5);Iie={name:hM,shader:G5}});var H5={};V(H5,{hdrFilteringPixelShader:()=>yie});var uM,W5,yie,z5=S(()=>{O();Di();Iu();Df();yu();uM="hdrFilteringPixelShader",W5=`#include<helperFunctions>
#include<importanceSampling>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
uniform float alphaG;uniform samplerCube inputTexture;uniform vec2 vFilteringInfo;uniform float hdrScale;varying vec3 direction;void main() {vec3 color=radiance(alphaG,inputTexture,direction,vFilteringInfo);gl_FragColor=vec4(color*hdrScale,1.0);}`;g.ShadersStore[uM]||(g.ShadersStore[uM]=W5);yie={name:uM,shader:W5}});var _x,X5=S(()=>{ml();di();In();_x=class{constructor(e,t={}){this._lodGenerationOffset=0,this._lodGenerationScale=.8,this.quality=4096,this.hdrScale=1,this._engine=e,this.hdrScale=t.hdrScale||this.hdrScale,this.quality=t.quality||this.quality}_createRenderTarget(e){let t=0;this._engine.getCaps().textureHalfFloatRender?t=2:this._engine.getCaps().textureFloatRender&&(t=1);let i=this._engine.createRenderTargetCubeTexture(e,{format:5,type:t,createMipMaps:!0,generateMipMaps:!1,generateDepthBuffer:!1,generateStencilBuffer:!1,samplingMode:1,label:"HDR_Radiance_Filtering_Target"});return this._engine.updateTextureWrappingMode(i.texture,0,0,0),this._engine.updateTextureSamplingMode(3,i.texture,!0),i}_prefilterInternal(e){let t=e.getSize().width,i=bs(t)+1,r=this._effectWrapper.effect,n=this._createRenderTarget(t);this._effectRenderer.saveStates(),this._effectRenderer.setViewport();let a=e.getInternalTexture();a&&this._engine.updateTextureSamplingMode(3,a,!0),this._effectRenderer.applyEffectWrapper(this._effectWrapper);let o=[[new E(0,0,-1),new E(0,-1,0),new E(1,0,0)],[new E(0,0,1),new E(0,-1,0),new E(-1,0,0)],[new E(1,0,0),new E(0,0,1),new E(0,1,0)],[new E(1,0,0),new E(0,0,-1),new E(0,-1,0)],[new E(1,0,0),new E(0,-1,0),new E(0,0,1)],[new E(-1,0,0),new E(0,-1,0),new E(0,0,-1)]];r.setFloat("hdrScale",this.hdrScale),r.setFloat2("vFilteringInfo",e.getSize().width,i),r.setTexture("inputTexture",e);for(let f=0;f<6;f++){r.setVector3("up",o[f][0]),r.setVector3("right",o[f][1]),r.setVector3("front",o[f][2]);for(let h=0;h<i;h++){this._engine.bindFramebuffer(n,f,void 0,void 0,!0,h),this._effectRenderer.applyEffectWrapper(this._effectWrapper);let u=Math.pow(2,(h-this._lodGenerationOffset)/this._lodGenerationScale)/t;h===0&&(u=0),r.setFloat("alphaG",u),this._effectRenderer.draw()}}this._effectRenderer.restoreStates(),this._engine.restoreDefaultFramebuffer(),this._engine._releaseTexture(e._texture);let l=n.texture.type,c=n.texture.format;return n._swapAndDie(e._texture),e._texture.type=l,e._texture.format=c,e.gammaSpace=!1,e.lodGenerationOffset=this._lodGenerationOffset,e.lodGenerationScale=this._lodGenerationScale,e._prefiltered=!0,e}_createEffect(e,t){let i=[];e.gammaSpace&&i.push("#define GAMMA_INPUT"),i.push("#define NUM_SAMPLES "+this.quality+"u");let r=this._engine.isWebGPU;return new ti({engine:this._engine,name:"hdrFiltering",vertexShader:"hdrFiltering",fragmentShader:"hdrFiltering",samplerNames:["inputTexture"],uniformNames:["vSampleDirections","vWeights","up","right","front","vFilteringInfo","hdrScale","alphaG"],useShaderStore:!0,defines:i,onCompiled:t,shaderLanguage:r?1:0,extraInitializationsAsync:async()=>{r?await Promise.all([Promise.resolve().then(()=>(F5(),w5)),Promise.resolve().then(()=>(U5(),B5))]):await Promise.all([Promise.resolve().then(()=>(k5(),V5)),Promise.resolve().then(()=>(z5(),H5))])}})}isReady(e){return e.isReady()&&this._effectWrapper.effect.isReady()}async prefilter(e){if(!this._engine._features.allowTexturePrefiltering)throw new Error("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead.");this._effectRenderer=new Cn(this._engine),this._effectWrapper=this._createEffect(e),await this._effectWrapper.effect.whenCompiledAsync(),this._prefilterInternal(e),this._effectRenderer.dispose(),this._effectWrapper.dispose()}}});var gx,Y5=S(()=>{$e();Pn();gx=class{constructor(e){this.name=ne.NAME_PROCEDURALTEXTURE,this.scene=e}register(){this.scene._beforeClearStage.registerStep(ne.STEP_BEFORECLEAR_PROCEDURALTEXTURE,this,this._beforeClear)}rebuild(){}dispose(){}_beforeClear(){if(this.scene.proceduralTexturesEnabled){W.StartPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0);for(let e=0;e<this.scene.proceduralTextures.length;e++){let t=this.scene.proceduralTextures[e];t._shouldRender()&&t.render()}W.EndPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0)}}}});var pM={};V(pM,{proceduralVertexShaderWGSL:()=>Mie});var dM,K5,Mie,mM=S(()=>{O();dM="proceduralVertexShader",K5=`attribute position: vec2f;varying vPosition: vec2f;varying vUV: vec2f;const madd: vec2f= vec2f(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
vertexOutputs.vPosition=input.position;vertexOutputs.vUV=input.position*madd+madd;vertexOutputs.position= vec4f(input.position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;g.ShadersStoreWGSL[dM]||(g.ShadersStoreWGSL[dM]=K5);Mie={name:dM,shader:K5}});var gM={};V(gM,{proceduralVertexShader:()=>Pie});var _M,q5,Pie,vM=S(()=>{O();_M="proceduralVertexShader",q5=`attribute vec2 position;varying vec2 vPosition;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vPosition=position;vUV=position*madd+madd;gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;g.ShadersStore[_M]||(g.ShadersStore[_M]=q5);Pie={name:_M,shader:q5}});var ci,ch=S(()=>{Ye();je();we();yt();Pn();cs();Ut();Mn();Y5();Te();gt();El();ci=class s extends H{get shaderLanguage(){return this._shaderLanguage}constructor(e,t,i,r,n=null,a=!0,o=!1,l=0){super(null,r,!a),this.isEnabled=!0,this.autoClear=!0,this.onGeneratedObservable=new N,this.onBeforeGenerationObservable=new N,this.nodeMaterialSource=null,this.defines="",this._textures={},this._currentRefreshId=-1,this._frameId=-1,this._refreshRate=1,this._vertexBuffers={},this._uniforms=new Array,this._samplers=new Array,this._floats={},this._ints={},this._floatsArrays={},this._colors3={},this._colors4={},this._vectors2={},this._vectors3={},this._vectors4={},this._matrices={},this._fallbackTextureUsed=!1,this._cachedDefines=null,this._contentUpdateId=-1,this._rtWrapper=null,n!==null&&!(n instanceof H)?(this._options=n,this._fallbackTexture=n.fallbackTexture??null):(this._options={},this._fallbackTexture=n),this._shaderLanguage=this._options.shaderLanguage??0,r=this.getScene()||Z.LastCreatedScene;let c=r._getComponent(ne.NAME_PROCEDURALTEXTURE);c||(c=new gx(r),r._addComponent(c)),r.proceduralTextures.push(this),this._fullEngine=r.getEngine(),this.name=e,this.isRenderTarget=!0,this._size=t,this._textureType=l,this._generateMipMaps=a,this._drawWrapper=new Vr(this._fullEngine),this.setFragment(i);let f=this._createRtWrapper(o,t,a,l);this._texture=f.texture;let h=[];h.push(1,1),h.push(-1,1),h.push(-1,-1),h.push(1,-1),this._vertexBuffers[A.PositionKind]=new A(this._fullEngine,h,A.PositionKind,!1,!1,2),this._createIndexBuffer()}_createRtWrapper(e,t,i,r){return e?(this._rtWrapper=this._fullEngine.createRenderTargetCubeTexture(t,{generateMipMaps:i,generateDepthBuffer:!1,generateStencilBuffer:!1,type:r,...this._options}),this.setFloat("face",0)):(this._rtWrapper=this._fullEngine.createRenderTargetTexture(t,{generateMipMaps:i,generateDepthBuffer:!1,generateStencilBuffer:!1,type:r,...this._options}),this._rtWrapper.is3D&&(this.setFloat("layer",0),this.setInt("layerNum",0))),this._rtWrapper}getEffect(){return this._drawWrapper.effect}_setEffect(e){this._drawWrapper.effect=e}getContent(){return this._contentData&&this._frameId===this._contentUpdateId?this._contentData:(this._contentData?this._contentData.then(e=>{this._contentData=this.readPixels(0,0,e),this._contentUpdateId=this._frameId}):(this._contentData=this.readPixels(0,0),this._contentUpdateId=this._frameId),this._contentData)}_createIndexBuffer(){let e=this._fullEngine,t=[];t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this._indexBuffer=e.createIndexBuffer(t)}_rebuild(){let e=this._vertexBuffers[A.PositionKind];e&&e._rebuild(),this._createIndexBuffer(),this.refreshRate===Gt.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=Gt.REFRESHRATE_RENDER_ONCE)}reset(){this._drawWrapper.effect?.dispose(),this._drawWrapper.effect=null,this._cachedDefines=null}_getDefines(){return this.defines}executeWhenReady(e){if(this.isReady()){e(this);return}let t=this.getEffect();t&&t.executeWhenCompiled(()=>{e(this)})}isReady(){let e=this._fullEngine;if(this.nodeMaterialSource)return this._drawWrapper.effect.isReady();if(!this._fragment)return!1;if(this._fallbackTextureUsed)return!0;if(!this._texture)return!1;let t=this._getDefines();if(this._drawWrapper.effect&&t===this._cachedDefines&&this._drawWrapper.effect.isReady())return!0;let i={vertex:"procedural",fragmentElement:this._fragment.fragmentElement,fragmentSource:this._fragment.fragmentSource,fragment:typeof this._fragment=="string"?this._fragment:void 0};return this._cachedDefines!==t&&(this._cachedDefines=t,this._drawWrapper.effect=e.createEffect(i,[A.PositionKind],this._uniforms,this._samplers,t,void 0,void 0,()=>{this._rtWrapper?.dispose(),this._rtWrapper=this._texture=null,this._fallbackTexture&&(this._texture=this._fallbackTexture._texture,this._texture&&this._texture.incrementReferences()),this._fallbackTextureUsed=!0},void 0,this._shaderLanguage,async()=>{this._options.extraInitializationsAsync?this.shaderLanguage===1?await Promise.all([Promise.resolve().then(()=>(mM(),pM)),this._options.extraInitializationsAsync()]):await Promise.all([Promise.resolve().then(()=>(vM(),gM)),this._options.extraInitializationsAsync()]):this.shaderLanguage===1?await Promise.resolve().then(()=>(mM(),pM)):await Promise.resolve().then(()=>(vM(),gM))})),this._drawWrapper.effect.isReady()}resetRefreshCounter(){this._currentRefreshId=-1}setFragment(e){this._fragment=e}get refreshRate(){return this._refreshRate}set refreshRate(e){this._refreshRate=e,this.resetRefreshCounter()}_shouldRender(){return!this.isEnabled||!this.isReady()||!this._texture?(this._texture&&(this._texture.isReady=!1),!1):this._fallbackTextureUsed?!1:this._currentRefreshId===-1?(this._currentRefreshId=1,this._frameId++,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,this._frameId++,!0):(this._currentRefreshId++,!1)}getRenderSize(){return this._size}resize(e,t){if(this._fallbackTextureUsed||!this._rtWrapper||!this._texture)return;let i=this._texture.isCube;this._rtWrapper.dispose();let r=this._createRtWrapper(i,e,t,this._textureType);this._texture=r.texture,this._size=e,this._generateMipMaps=t}_checkUniform(e){this._uniforms.indexOf(e)===-1&&this._uniforms.push(e)}setTexture(e,t){return this._samplers.indexOf(e)===-1&&this._samplers.push(e),this._textures[e]=t,this}setFloat(e,t){return this._checkUniform(e),this._floats[e]=t,this}setInt(e,t){return this._checkUniform(e),this._ints[e]=t,this}setFloats(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this}setColor3(e,t){return this._checkUniform(e),this._colors3[e]=t,this}setColor4(e,t){return this._checkUniform(e),this._colors4[e]=t,this}setVector2(e,t){return this._checkUniform(e),this._vectors2[e]=t,this}setVector3(e,t){return this._checkUniform(e),this._vectors3[e]=t,this}setVector4(e,t){return this._checkUniform(e),this._vectors4[e]=t,this}setMatrix(e,t){return this._checkUniform(e),this._matrices[e]=t,this}render(e){let t=this.getScene();if(!t)return;let i=this._fullEngine;if(i.enableEffect(this._drawWrapper),this.onBeforeGenerationObservable.notifyObservers(this),i.setState(!1),!this.nodeMaterialSource){for(let n in this._textures)this._drawWrapper.effect.setTexture(n,this._textures[n]);for(let n in this._ints)this._drawWrapper.effect.setInt(n,this._ints[n]);for(let n in this._floats)this._drawWrapper.effect.setFloat(n,this._floats[n]);for(let n in this._floatsArrays)this._drawWrapper.effect.setArray(n,this._floatsArrays[n]);for(let n in this._colors3)this._drawWrapper.effect.setColor3(n,this._colors3[n]);for(let n in this._colors4){let a=this._colors4[n];this._drawWrapper.effect.setFloat4(n,a.r,a.g,a.b,a.a)}for(let n in this._vectors2)this._drawWrapper.effect.setVector2(n,this._vectors2[n]);for(let n in this._vectors3)this._drawWrapper.effect.setVector3(n,this._vectors3[n]);for(let n in this._vectors4)this._drawWrapper.effect.setVector4(n,this._vectors4[n]);for(let n in this._matrices)this._drawWrapper.effect.setMatrix(n,this._matrices[n])}if(!this._texture||!this._rtWrapper)return;i._debugPushGroup?.(`procedural texture generation for ${this.name}`,1);let r=i.currentViewport;if(this.isCube)for(let n=0;n<6;n++)i.bindFramebuffer(this._rtWrapper,n,void 0,void 0,!0),i.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this._drawWrapper.effect.setFloat("face",n),this.autoClear&&i.clear(t.clearColor,!0,!1,!1),i.drawElementsType(Q.TriangleFillMode,0,6),i.unBindFramebuffer(this._rtWrapper,!0);else{let n=1;this._rtWrapper.is3D?n=this._rtWrapper.depth:this._rtWrapper.is2DArray&&(n=this._rtWrapper.layers);for(let a=0;a<n;a++){if(i.bindFramebuffer(this._rtWrapper,0,void 0,void 0,!0,0,a),i.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this._rtWrapper.is3D||this._rtWrapper.is2DArray){this._drawWrapper.effect?.setFloat("layer",n!==1?a/(n-1):0),this._drawWrapper.effect?.setInt("layerNum",a);for(let o in this._textures)this._drawWrapper.effect.setTexture(o,this._textures[o])}this.autoClear&&i.clear(t.clearColor,!0,!1,!1),i.drawElementsType(Q.TriangleFillMode,0,6),i.unBindFramebuffer(this._rtWrapper,!this._generateMipMaps)}}r&&i.setViewport(r),this.isCube&&i.generateMipMapsForCubemap(this._texture,!0),i._debugPopGroup?.(1),this.onGenerated&&this.onGenerated(),this.onGeneratedObservable.notifyObservers(this)}clone(){let e=this.getSize(),t=new s(this.name,e.width,this._fragment,this.getScene(),this._fallbackTexture,this._generateMipMaps);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,t}dispose(){let e=this.getScene();if(!e)return;let t=e.proceduralTextures.indexOf(this);t>=0&&e.proceduralTextures.splice(t,1);let i=this._vertexBuffers[A.PositionKind];i&&(i.dispose(),this._vertexBuffers[A.PositionKind]=null),this._indexBuffer&&this._fullEngine._releaseBuffer(this._indexBuffer)&&(this._indexBuffer=null),this.onGeneratedObservable.clear(),this.onBeforeGenerationObservable.clear(),super.dispose()}};x([y()],ci.prototype,"isEnabled",void 0);x([y()],ci.prototype,"autoClear",void 0);x([y()],ci.prototype,"_generateMipMaps",void 0);x([y()],ci.prototype,"_size",void 0);x([y()],ci.prototype,"refreshRate",null);G("BABYLON.ProceduralTexture",ci)});var j5={};V(j5,{iblCdfxPixelShaderWGSL:()=>Die});var SM,Q5,Die,Z5=S(()=>{O();SM="iblCdfxPixelShader",Q5=`#define PI 3.1415927
varying vUV: vec2f;var cdfy: texture_2d<f32>;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var cdfyRes=textureDimensions(cdfy,0);var currentPixel=vec2u(fragmentInputs.position.xy);var cdfx: f32=0.0;for (var x: u32=1; x<=currentPixel.x; x++) {cdfx+=textureLoad(cdfy, vec2u(x-1,cdfyRes.y-1),0).x;}
fragmentOutputs.color= vec4f( vec3f(cdfx),1.0);}`;g.ShadersStoreWGSL[SM]||(g.ShadersStoreWGSL[SM]=Q5);Die={name:SM,shader:Q5}});var $5={};V($5,{iblCdfyPixelShaderWGSL:()=>Oie});var EM,J5,Oie,e6=S(()=>{O();EM="iblCdfyPixelShader",J5=`varying vUV : vec2f;
#include <helperFunctions>
#ifdef IBL_USE_CUBE_MAP
var iblSourceSampler: sampler;var iblSource: texture_cube<f32>;
#else
var iblSourceSampler: sampler;var iblSource: texture_2d<f32>;
#endif
uniform iblHeight: i32;
#ifdef IBL_USE_CUBE_MAP
fn fetchCube(uv: vec2f)->f32 {var direction: vec3f=equirectangularToCubemapDirection(uv);return sin(PI*uv.y) *
dot(textureSampleLevel(iblSource,iblSourceSampler,direction,0.0)
.rgb,
LuminanceEncodeApprox);}
#else
fn fetchPanoramic(Coords: vec2i,envmapHeight: f32)->f32 {return sin(PI*(f32(Coords.y)+0.5)/envmapHeight) *
dot(textureLoad(iblSource,Coords,0).rgb,LuminanceEncodeApprox);}
#endif
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var coords: vec2i= vec2i(fragmentInputs.position.xy);var cdfy: f32=0.0;for (var y: i32=1; y<=coords.y; y++) {
#ifdef IBL_USE_CUBE_MAP
var uv: vec2f= vec2f(input.vUV.x,( f32(y-1)+0.5)/ f32(uniforms.iblHeight));cdfy+=fetchCube(uv);
#else
cdfy+=fetchPanoramic( vec2i(coords.x,y-1), f32(uniforms.iblHeight));
#endif
}
fragmentOutputs.color= vec4f(cdfy,0.0,0.0,1.0);}`;g.ShadersStoreWGSL[EM]||(g.ShadersStoreWGSL[EM]=J5);Oie={name:EM,shader:J5}});var i6={};V(i6,{iblScaledLuminancePixelShaderWGSL:()=>Lie});var TM,t6,Lie,r6=S(()=>{O();Pi();TM="iblScaledLuminancePixelShader",t6=`#include<helperFunctions>
#ifdef IBL_USE_CUBE_MAP
var iblSourceSampler: sampler;var iblSource: texture_cube<f32>;
#else
var iblSourceSampler: sampler;var iblSource: texture_2d<f32>;
#endif
uniform iblHeight: i32;uniform iblWidth: i32;fn fetchLuminance(coords: vec2f)->f32 {
#ifdef IBL_USE_CUBE_MAP
var direction: vec3f=equirectangularToCubemapDirection(coords);var color: vec3f=textureSampleLevel(iblSource,iblSourceSampler,direction,0.0).rgb;
#else
var color: vec3f=textureSampleLevel(iblSource,iblSourceSampler,coords,0.0).rgb;
#endif
return dot(color,LuminanceEncodeApprox);}
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var deform: f32=sin(input.vUV.y*PI);var luminance: f32=fetchLuminance(input.vUV);fragmentOutputs.color=vec4f(vec3f(deform*luminance),1.0);}`;g.ShadersStoreWGSL[TM]||(g.ShadersStoreWGSL[TM]=t6);Lie={name:TM,shader:t6}});var n6={};V(n6,{iblCdfxPixelShader:()=>wie});var xM,s6,wie,a6=S(()=>{O();xM="iblCdfxPixelShader",s6=`precision highp sampler2D;
#define PI 3.1415927
varying vec2 vUV;uniform sampler2D cdfy;void main(void) {ivec2 cdfyRes=textureSize(cdfy,0);ivec2 currentPixel=ivec2(gl_FragCoord.xy);float cdfx=0.0;for (int x=1; x<=currentPixel.x; x++) {cdfx+=texelFetch(cdfy,ivec2(x-1,cdfyRes.y-1),0).x;}
gl_FragColor=vec4(vec3(cdfx),1.0);}`;g.ShadersStore[xM]||(g.ShadersStore[xM]=s6);wie={name:xM,shader:s6}});var l6={};V(l6,{iblCdfyPixelShader:()=>Fie});var AM,o6,Fie,c6=S(()=>{O();Di();AM="iblCdfyPixelShader",o6=`precision highp sampler2D;precision highp samplerCube;
#include<helperFunctions>
#define PI 3.1415927
varying vec2 vUV;
#ifdef IBL_USE_CUBE_MAP
uniform samplerCube iblSource;
#else
uniform sampler2D iblSource;
#endif
uniform int iblHeight;
#ifdef IBL_USE_CUBE_MAP
float fetchCube(vec2 uv) {vec3 direction=equirectangularToCubemapDirection(uv);return sin(PI*uv.y)*dot(textureCubeLodEXT(iblSource,direction,0.0).rgb,LuminanceEncodeApprox);}
#else
float fetchPanoramic(ivec2 Coords,float envmapHeight) {return sin(PI*(float(Coords.y)+0.5)/envmapHeight) *
dot(texelFetch(iblSource,Coords,0).rgb,LuminanceEncodeApprox);}
#endif
void main(void) {ivec2 coords=ivec2(gl_FragCoord.x,gl_FragCoord.y);float cdfy=0.0;for (int y=1; y<=coords.y; y++) {
#ifdef IBL_USE_CUBE_MAP
vec2 uv=vec2(vUV.x,(float(y-1)+0.5)/float(iblHeight));cdfy+=fetchCube(uv);
#else
cdfy+=fetchPanoramic(ivec2(coords.x,y-1),float(iblHeight));
#endif
}
gl_FragColor=vec4(cdfy,0.0,0.0,1.0);}`;g.ShadersStore[AM]||(g.ShadersStore[AM]=o6);Fie={name:AM,shader:o6}});var h6={};V(h6,{iblScaledLuminancePixelShader:()=>Nie});var RM,f6,Nie,u6=S(()=>{O();Di();RM="iblScaledLuminancePixelShader",f6=`precision highp sampler2D;precision highp samplerCube;
#include<helperFunctions>
varying vec2 vUV;
#ifdef IBL_USE_CUBE_MAP
uniform samplerCube iblSource;
#else
uniform sampler2D iblSource;
#endif
uniform int iblWidth;uniform int iblHeight;float fetchLuminance(vec2 coords) {
#ifdef IBL_USE_CUBE_MAP
vec3 direction=equirectangularToCubemapDirection(coords);vec3 color=textureCubeLodEXT(iblSource,direction,0.0).rgb;
#else
vec3 color=textureLod(iblSource,coords,0.0).rgb;
#endif
return dot(color,LuminanceEncodeApprox);}
void main(void) {float deform=sin(vUV.y*PI);float luminance=fetchLuminance(vUV);gl_FragColor=vec4(vec3(deform*luminance),1.0);}`;g.ShadersStore[RM]||(g.ShadersStore[RM]=f6);Nie={name:RM,shader:f6}});var p6={};V(p6,{iblIcdfPixelShaderWGSL:()=>Bie});var bM,d6,Bie,m6=S(()=>{O();Pi();bM="iblIcdfPixelShader",d6=`#include<helperFunctions>
varying vUV: vec2f;
#ifdef IBL_USE_CUBE_MAP
var iblSourceSampler: sampler;var iblSource: texture_cube<f32>;
#else
var iblSourceSampler: sampler;var iblSource: texture_2d<f32>;
#endif
var scaledLuminanceSamplerSampler : sampler;var scaledLuminanceSampler : texture_2d<f32>;var cdfx: texture_2d<f32>;var cdfy: texture_2d<f32>;fn fetchLuminance(coords: vec2f)->f32 {
#ifdef IBL_USE_CUBE_MAP
var direction: vec3f=equirectangularToCubemapDirection(coords);var color: vec3f=textureSampleLevel(iblSource,iblSourceSampler,direction,0.0).rgb;
#else
var color: vec3f=textureSampleLevel(iblSource,iblSourceSampler,coords,0.0).rgb;
#endif
return dot(color,LuminanceEncodeApprox);}
fn fetchCDFx(x: u32)->f32 {return textureLoad(cdfx, vec2u(x,0),0).x;}
fn bisectx(size: u32,targetValue: f32)->f32
{var a: u32=0;var b=size-1;while (b-a>1) {var c: u32=(a+b)>>1;if (fetchCDFx(c)<targetValue) {a=c;}
else {b=c;}}
return mix( f32(a), f32(b),(targetValue-fetchCDFx(a))/(fetchCDFx(b)-fetchCDFx(a)))/ f32(size-1);}
fn fetchCDFy(y: u32,invocationId: u32)->f32 {return textureLoad(cdfy, vec2u(invocationId,y),0).x;}
fn bisecty(size: u32,targetValue: f32,invocationId: u32)->f32
{var a: u32=0;var b=size-1;while (b-a>1) {var c=(a+b)>>1;if (fetchCDFy(c,invocationId)<targetValue) {a=c;}
else {b=c;}}
return mix( f32(a), f32(b),(targetValue-fetchCDFy(a,invocationId))/(fetchCDFy(b,invocationId)-fetchCDFy(a,invocationId)))/ f32(size-1);}
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var cdfxSize: vec2u=textureDimensions(cdfx,0);var cdfWidth: u32=cdfxSize.x;var icdfWidth: u32=cdfWidth-1;var currentPixel: vec2u= vec2u(fragmentInputs.position.xy);var outputColor: vec3f=vec3f(1.0);if (currentPixel.x==0)
{outputColor.x= 0.0;}
else if (currentPixel.x==icdfWidth-1) {outputColor.x= 1.0;} else {var targetValue: f32=fetchCDFx(cdfWidth-1)*input.vUV.x;outputColor.x= bisectx(cdfWidth,targetValue);}
var cdfySize: vec2u=textureDimensions(cdfy,0);var cdfHeight: u32=cdfySize.y;if (currentPixel.y==0) {outputColor.y= 0.0;}
else if (currentPixel.y==cdfHeight-2) {outputColor.y= 1.0;} else {var targetValue: f32=fetchCDFy(cdfHeight-1,currentPixel.x)*input.vUV.y;outputColor.y= max(bisecty(cdfHeight,targetValue,currentPixel.x),0.0);}
var size : vec2f=vec2f(textureDimensions(scaledLuminanceSampler,0));var highestMip: f32=floor(log2(size.x));var normalization : f32=textureSampleLevel(scaledLuminanceSampler,
scaledLuminanceSamplerSampler,
input.vUV,highestMip)
.r;var pixelLuminance: f32=fetchLuminance(input.vUV);outputColor.z=pixelLuminance/(2.0*PI*normalization);fragmentOutputs.color=vec4( outputColor,1.0);}`;g.ShadersStoreWGSL[bM]||(g.ShadersStoreWGSL[bM]=d6);Bie={name:bM,shader:d6}});var g6={};V(g6,{iblDominantDirectionPixelShaderWGSL:()=>Uie});var CM,_6,Uie,v6=S(()=>{O();Pi();Ru();Pf();bu();CM="iblDominantDirectionPixelShader",_6=`#include<helperFunctions>
#include<importanceSampling>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
var icdfSamplerSampler: sampler;var icdfSampler: texture_2d<f32>;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var lightDir: vec3f=vec3f(0.0,0.0,0.0);for(var i: u32=0u; i<NUM_SAMPLES; i++)
{var Xi: vec2f=hammersley(i,NUM_SAMPLES);var T: vec2f;T.x=textureSampleLevel(icdfSampler,icdfSamplerSampler,vec2(Xi.x,0.0),0.0).x;T.y=textureSampleLevel(icdfSampler,icdfSamplerSampler,vec2(T.x,Xi.y),0.0).y;var Ls: vec3f=uv_to_normal(vec2f(1.0-fract(T.x+0.25),T.y));lightDir+=Ls;}
lightDir/=vec3f(f32(NUM_SAMPLES));fragmentOutputs.color=vec4f(lightDir,1.0);}`;g.ShadersStoreWGSL[CM]||(g.ShadersStoreWGSL[CM]=_6);Uie={name:CM,shader:_6}});var E6={};V(E6,{iblIcdfPixelShader:()=>Gie});var IM,S6,Gie,T6=S(()=>{O();Di();IM="iblIcdfPixelShader",S6=`precision highp sampler2D;
#include<helperFunctions>
varying vec2 vUV;
#ifdef IBL_USE_CUBE_MAP
uniform samplerCube iblSource;
#else
uniform sampler2D iblSource;
#endif
uniform sampler2D scaledLuminanceSampler;uniform int iblWidth;uniform int iblHeight;uniform sampler2D cdfx;uniform sampler2D cdfy;float fetchLuminance(vec2 coords) {
#ifdef IBL_USE_CUBE_MAP
vec3 direction=equirectangularToCubemapDirection(coords);vec3 color=textureCubeLodEXT(iblSource,direction,0.0).rgb;
#else
vec3 color=textureLod(iblSource,coords,0.0).rgb;
#endif
return dot(color,LuminanceEncodeApprox);}
float fetchCDFx(int x) { return texelFetch(cdfx,ivec2(x,0),0).x; }
float bisectx(int size,float targetValue) {int a=0,b=size-1;while (b-a>1) {int c=a+b>>1;if (fetchCDFx(c)<targetValue)
a=c;else
b=c;}
return mix(float(a),float(b),
(targetValue-fetchCDFx(a))/(fetchCDFx(b)-fetchCDFx(a))) /
float(size-1);}
float fetchCDFy(int y,int invocationId) {return texelFetch(cdfy,ivec2(invocationId,y),0).x;}
float bisecty(int size,float targetValue,int invocationId) {int a=0,b=size-1;while (b-a>1) {int c=a+b>>1;if (fetchCDFy(c,invocationId)<targetValue)
a=c;else
b=c;}
return mix(float(a),float(b),
(targetValue-fetchCDFy(a,invocationId)) /
(fetchCDFy(b,invocationId)-fetchCDFy(a,invocationId))) /
float(size-1);}
void main(void) {ivec2 cdfxSize=textureSize(cdfx,0);int cdfWidth=cdfxSize.x;int icdfWidth=cdfWidth-1;ivec2 currentPixel=ivec2(gl_FragCoord.xy);vec3 outputColor=vec3(1.0);if (currentPixel.x==0) {outputColor.x=0.0;} else if (currentPixel.x==icdfWidth-1) {outputColor.x=1.0;} else {float targetValue=fetchCDFx(cdfWidth-1)*vUV.x;outputColor.x=bisectx(cdfWidth,targetValue);}
ivec2 cdfySize=textureSize(cdfy,0);int cdfHeight=cdfySize.y;if (currentPixel.y==0) {outputColor.y=0.0;} else if (currentPixel.y==cdfHeight-2) {outputColor.y=1.0;} else {float targetValue=fetchCDFy(cdfHeight-1,currentPixel.x)*vUV.y;outputColor.y=max(bisecty(cdfHeight,targetValue,currentPixel.x),0.0);}
vec2 size=vec2(textureSize(scaledLuminanceSampler,0));float highestMip=floor(log2(size.x));float normalization=texture(scaledLuminanceSampler,vUV,highestMip).r;float pixelLuminance=fetchLuminance(vUV);outputColor.z=pixelLuminance/(2.0*PI*normalization);gl_FragColor=vec4(outputColor,1.0);}
`;g.ShadersStore[IM]||(g.ShadersStore[IM]=S6);Gie={name:IM,shader:S6}});var A6={};V(A6,{iblDominantDirectionPixelShader:()=>Vie});var yM,x6,Vie,R6=S(()=>{O();Di();Iu();Df();yu();yM="iblDominantDirectionPixelShader",x6=`precision highp sampler2D;precision highp samplerCube;
#include<helperFunctions>
#include<importanceSampling>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
varying vec2 vUV;uniform sampler2D icdfSampler;void main(void) {vec3 lightDir=vec3(0.0,0.0,0.0);for(uint i=0u; i<NUM_SAMPLES; ++i)
{vec2 Xi=hammersley(i,NUM_SAMPLES);vec2 T;T.x=texture2D(icdfSampler,vec2(Xi.x,0.0)).x;T.y=texture2D(icdfSampler,vec2(T.x,Xi.y)).y;vec3 Ls=uv_to_normal(vec2(1.0-fract(T.x+0.25),T.y));lightDir+=Ls;}
lightDir/=float(NUM_SAMPLES);gl_FragColor=vec4(lightDir,1.0);}`;g.ShadersStore[yM]||(g.ShadersStore[yM]=x6);Vie={name:yM,shader:x6}});var C6={};V(C6,{iblCdfDebugPixelShaderWGSL:()=>kie});var MM,b6,kie,I6=S(()=>{O();MM="iblCdfDebugPixelShader",b6=`#define PI 3.1415927
varying vUV: vec2f;var cdfySampler: sampler;var cdfy: texture_2d<f32>;var cdfxSampler: sampler;var cdfx: texture_2d<f32>;var icdfSampler: sampler;var icdf: texture_2d<f32>;
#ifdef IBL_USE_CUBE_MAP
var iblSourceSampler: sampler;var iblSource: texture_cube<f32>;
#else
var iblSourceSampler: sampler;var iblSource: texture_2d<f32>;
#endif
var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;
#define cdfyVSize (0.8/3.0)
#define cdfxVSize 0.1
#define cdfyHSize 0.5
uniform sizeParams: vec4f;
#ifdef IBL_USE_CUBE_MAP
fn equirectangularToCubemapDirection(uv: vec2f)->vec3f {var longitude: f32=uv.x*2.0*PI-PI;var latitude: f32=PI*0.5-uv.y*PI;var direction: vec3f;direction.x=cos(latitude)*sin(longitude);direction.y=sin(latitude);direction.z=cos(latitude)*cos(longitude);return direction;}
#endif
@fragment
fn main(input: FragmentInputs)->FragmentOutputs { 
var colour: vec3f= vec3f(0.0);var uv: vec2f =
vec2f((uniforms.sizeParams.x+input.vUV.x)*uniforms.sizeParams.z,(uniforms.sizeParams.y+input.vUV.y)*uniforms.sizeParams.w);var backgroundColour: vec3f=textureSample(textureSampler,textureSamplerSampler,input.vUV).rgb;var cdfxWidth: u32=textureDimensions(cdfx,0).x;var cdfyHeight: u32=textureDimensions(cdfy,0).y;const iblStart: f32=1.0-cdfyVSize;const pdfStart: f32=1.0-2.0*cdfyVSize;const cdfyStart: f32=1.0-3.0*cdfyVSize;const cdfxStart: f32=1.0-3.0*cdfyVSize-cdfxVSize;const icdfxStart: f32=1.0-3.0*cdfyVSize-2.0*cdfxVSize;
#ifdef IBL_USE_CUBE_MAP
var direction: vec3f=equirectangularToCubemapDirection(
(uv- vec2f(0.0,iblStart))* vec2f(1.0,1.0/cdfyVSize));var iblColour: vec3f=textureSampleLevel(iblSource,iblSourceSampler,direction,0.0).rgb;
#else
var iblColour: vec3f=textureSample(iblSource,iblSourceSampler,(uv- vec2f(0.0,iblStart)) *
vec2f(1.0,1.0/cdfyVSize))
.rgb;
#endif
var pdfColour: vec3f =
textureSample(icdf,icdfSampler,(uv- vec2f(0.0,pdfStart))* vec2f(1.0,1.0/cdfyVSize)).zzz;var cdfyColour: f32 =
textureSample(cdfy,cdfySampler,(uv- vec2f(0.0,cdfyStart))* vec2f(2.0,1.0/cdfyVSize)).r;var icdfyColour: f32 =
textureSample(icdf,icdfSampler,(uv- vec2f(0.5,cdfyStart))* vec2f(2.0,1.0/cdfyVSize)).g;var cdfxColour: f32 =
textureSample(cdfx,cdfxSampler,(uv- vec2f(0.0,cdfxStart))* vec2f(1.0,1.0/cdfxVSize)).r;var icdfxColour: f32=textureSample(icdf,icdfSampler,(uv- vec2f(0.0,icdfxStart)) *
vec2f(1.0,1.0/cdfxVSize)).r;if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {colour=backgroundColour;} else if (uv.y>iblStart) {colour+=iblColour;} else if (uv.y>pdfStart) {colour+=pdfColour;} else if (uv.y>cdfyStart && uv.x<0.5) {colour.r+=cdfyColour/f32(cdfyHeight);} else if (uv.y>cdfyStart && uv.x>0.5) {colour.r+=icdfyColour;} else if (uv.y>cdfxStart) {colour.r+=cdfxColour/f32(cdfxWidth);} else if (uv.y>icdfxStart) {colour.r+=icdfxColour;}
fragmentOutputs.color =vec4(mix(colour,backgroundColour,0.5),1.0);}`;g.ShadersStoreWGSL[MM]||(g.ShadersStoreWGSL[MM]=b6);kie={name:MM,shader:b6}});var M6={};V(M6,{iblCdfDebugPixelShader:()=>Wie});var PM,y6,Wie,P6=S(()=>{O();PM="iblCdfDebugPixelShader",y6=`precision highp samplerCube;
#define PI 3.1415927
varying vec2 vUV;uniform sampler2D cdfy;uniform sampler2D cdfx;uniform sampler2D icdf;uniform sampler2D pdf;
#ifdef IBL_USE_CUBE_MAP
uniform samplerCube iblSource;
#else
uniform sampler2D iblSource;
#endif
uniform sampler2D textureSampler;
#define cdfyVSize (0.8/3.0)
#define cdfxVSize 0.1
#define cdfyHSize 0.5
uniform vec4 sizeParams;
#define offsetX sizeParams.x
#define offsetY sizeParams.y
#define widthScale sizeParams.z
#define heightScale sizeParams.w
#ifdef IBL_USE_CUBE_MAP
vec3 equirectangularToCubemapDirection(vec2 uv) {float longitude=uv.x*2.0*PI-PI;float latitude=PI*0.5-uv.y*PI;vec3 direction;direction.x=cos(latitude)*sin(longitude);direction.y=sin(latitude);direction.z=cos(latitude)*cos(longitude);return direction;}
#endif
void main(void) {vec3 colour=vec3(0.0);vec2 uv =
vec2((offsetX+vUV.x)*widthScale,(offsetY+vUV.y)*heightScale);vec3 backgroundColour=texture2D(textureSampler,vUV).rgb;int cdfxWidth=textureSize(cdfx,0).x;int cdfyHeight=textureSize(cdfy,0).y;const float iblStart=1.0-cdfyVSize;const float pdfStart=1.0-2.0*cdfyVSize;const float cdfyStart=1.0-3.0*cdfyVSize;const float cdfxStart=1.0-3.0*cdfyVSize-cdfxVSize;const float icdfxStart=1.0-3.0*cdfyVSize-2.0*cdfxVSize;
#ifdef IBL_USE_CUBE_MAP
vec3 direction=equirectangularToCubemapDirection(
(uv-vec2(0.0,iblStart))*vec2(1.0,1.0/cdfyVSize));vec3 iblColour=textureCubeLodEXT(iblSource,direction,0.0).rgb;
#else
vec3 iblColour=texture2D(iblSource,(uv-vec2(0.0,iblStart)) *
vec2(1.0,1.0/cdfyVSize))
.rgb;
#endif
vec3 pdfColour=texture(icdf,(uv-vec2(0.0,pdfStart)) *
vec2(1.0,1.0/cdfyVSize)).zzz;float cdfyColour =
texture2D(cdfy,(uv-vec2(0.0,cdfyStart))*vec2(2.0,1.0/cdfyVSize))
.r;float icdfyColour =
texture2D(icdf,(uv-vec2(0.5,cdfyStart))*vec2(2.0,1.0/cdfyVSize))
.g;float cdfxColour =
texture2D(cdfx,(uv-vec2(0.0,cdfxStart))*vec2(1.0,1.0/cdfxVSize))
.r;float icdfxColour=texture2D(icdf,(uv-vec2(0.0,icdfxStart)) *
vec2(1.0,1.0/cdfxVSize))
.r;if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {colour=backgroundColour;} else if (uv.y>iblStart) {colour+=iblColour;} else if (uv.y>pdfStart) {colour+=pdfColour;} else if (uv.y>cdfyStart && uv.x<0.5) {colour.r+=cdfyColour/float(cdfyHeight);} else if (uv.y>cdfyStart && uv.x>0.5) {colour.r+=icdfyColour;} else if (uv.y>cdfxStart) {colour.r+=cdfxColour/float(cdfxWidth);} else if (uv.y>icdfxStart) {colour.r+=icdfxColour;}
gl_FragColor=vec4(colour,1.0);glFragColor.rgb=mix(gl_FragColor.rgb,backgroundColour,0.5);}
`;g.ShadersStore[PM]||(g.ShadersStore[PM]=y6);Wie={name:PM,shader:y6}});var D6={};V(D6,{IblCdfGenerator:()=>co});var co,vx=S(()=>{Ut();ch();Wr();ie();Wu();we();Sa();Ii();gt();Ee();ys();co=class s{get isSupported(){let e=Z.LastCreatedEngine;return e?e.getCaps().texelFetch:!1}get iblSource(){return this._iblSource}set iblSource(e){this._iblSource!==e&&(this._disposeTextures(),this._iblSource=e,e&&(e.isCube?e.isReadyOrNotBlocking()?this._recreateAssetsFromNewIbl():e.onLoadObservable.addOnce(this._recreateAssetsFromNewIbl.bind(this,e)):e.isReadyOrNotBlocking()?this._recreateAssetsFromNewIbl():e.onLoadObservable.addOnce(this._recreateAssetsFromNewIbl.bind(this,e))))}_recreateAssetsFromNewIbl(){this._debugPass&&this._debugPass.dispose(),this._createTextures(),this._debugPass&&this._createDebugPass()}getIcdfTexture(){return this._icdfPT?this._icdfPT:this._dummyTexture}setDebugDisplayParams(e,t,i,r){this._debugSizeParams.set(e,t,i,r)}get debugPassName(){return this._debugPassName}getDebugPassPP(){return this._debugPass||this._createDebugPass(),this._debugPass}constructor(e){if(this._cachedDominantDirection=null,this.debugEnabled=!1,this._debugSizeParams=new Oe(0,0,1,1),this._debugPassName="CDF Debug",this.onGeneratedObservable=new N,e?s._IsScene(e)?this._scene=e:this._engine=e:this._scene=Z.LastCreatedScene,this._scene&&(this._engine=this._scene.getEngine()),!this.isSupported){P.Warn("CDF renderer is not supported by the current engine.");return}let t=new Uint16Array([0,0,0,255]);this._dummyTexture=new yr(t,1,1,ee.TEXTUREFORMAT_RGBA,e,!1,!1,void 0,2),this._scene&&s._SceneComponentInitialization(this._scene)}_createTextures(){let e=this._iblSource?{width:this._iblSource.getSize().width,height:this._iblSource.getSize().height}:{width:1,height:1};this._iblSource||(this._iblSource=yr.CreateRTexture(new Uint8Array([255]),1,1,this._engine,!1,!1,1,0),this._iblSource.name="Placeholder IBL Source"),this._iblSource.isCube&&(e.width*=4,e.height*=2,e.width=1<<Math.floor(Math.log2(e.width)),e.height=1<<Math.floor(Math.log2(e.height)));let t=this._engine.isWebGPU,i={generateDepthBuffer:!1,generateMipMaps:!1,format:6,type:1,samplingMode:1,shaderLanguage:t?1:0,gammaSpace:!1,extraInitializationsAsync:async()=>{t?await Promise.all([Promise.resolve().then(()=>(Z5(),j5)),Promise.resolve().then(()=>(e6(),$5)),Promise.resolve().then(()=>(r6(),i6))]):await Promise.all([Promise.resolve().then(()=>(a6(),n6)),Promise.resolve().then(()=>(c6(),l6)),Promise.resolve().then(()=>(u6(),h6))])}},r={generateDepthBuffer:!1,generateMipMaps:!1,format:5,type:2,samplingMode:1,shaderLanguage:t?1:0,gammaSpace:!1,extraInitializationsAsync:async()=>{t?await Promise.all([Promise.resolve().then(()=>(m6(),p6)),Promise.resolve().then(()=>(v6(),g6))]):await Promise.all([Promise.resolve().then(()=>(T6(),E6)),Promise.resolve().then(()=>(R6(),A6))])}};this._cdfyPT=new ci("cdfyTexture",{width:e.width,height:e.height+1},"iblCdfy",this._scene,i,!1,!1),this._cdfyPT.autoClear=!1,this._cdfyPT.setTexture("iblSource",this._iblSource),this._cdfyPT.setInt("iblHeight",e.height),this._cdfyPT.wrapV=0,this._cdfyPT.refreshRate=0,this._iblSource.isCube&&(this._cdfyPT.defines=`#define IBL_USE_CUBE_MAP
`),this._cdfxPT=new ci("cdfxTexture",{width:e.width+1,height:1},"iblCdfx",this._scene,i,!1,!1),this._cdfxPT.autoClear=!1,this._cdfxPT.setTexture("cdfy",this._cdfyPT),this._cdfxPT.refreshRate=0,this._cdfxPT.wrapU=0,this._scaledLuminancePT=new ci("iblScaledLuminance",{width:e.width,height:e.height},"iblScaledLuminance",this._scene,{...i,samplingMode:3,generateMipMaps:!0},!0,!1),this._scaledLuminancePT.autoClear=!1,this._scaledLuminancePT.setTexture("iblSource",this._iblSource),this._scaledLuminancePT.setInt("iblHeight",e.height),this._scaledLuminancePT.setInt("iblWidth",e.width),this._scaledLuminancePT.refreshRate=0,this._iblSource.isCube&&(this._scaledLuminancePT.defines=`#define IBL_USE_CUBE_MAP
`),this._icdfPT=new ci("icdfTexture",{width:e.width,height:e.height},"iblIcdf",this._scene,r,!1,!1),this._icdfPT.autoClear=!1,this._icdfPT.setTexture("cdfy",this._cdfyPT),this._icdfPT.setTexture("cdfx",this._cdfxPT),this._icdfPT.setTexture("iblSource",this._iblSource),this._icdfPT.setTexture("scaledLuminanceSampler",this._scaledLuminancePT),this._icdfPT.refreshRate=0,this._icdfPT.wrapV=0,this._icdfPT.wrapU=0,this._iblSource.isCube&&(this._icdfPT.defines=`#define IBL_USE_CUBE_MAP
`),this._icdfPT.onGeneratedObservable.addOnce(()=>{this.onGeneratedObservable.notifyObservers()}),this._dominantDirectionPT=new ci("iblDominantDirection",{width:1,height:1},"iblDominantDirection",this._scene,r,!1,!1),this._dominantDirectionPT.autoClear=!1,this._dominantDirectionPT.setTexture("icdfSampler",this._icdfPT),this._dominantDirectionPT.refreshRate=0,this._dominantDirectionPT.defines=`#define NUM_SAMPLES 32u
`}_disposeTextures(){this._cdfyPT?.dispose(),this._cdfxPT?.dispose(),this._icdfPT?.dispose(),this._scaledLuminancePT?.dispose(),this._dominantDirectionPT?.dispose()}_createDebugPass(){this._debugPass&&this._debugPass.dispose();let e=this._engine.isWebGPU,t={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight(),samplingMode:H.BILINEAR_SAMPLINGMODE,engine:this._engine,textureType:0,uniforms:["sizeParams"],samplers:["cdfy","icdf","cdfx","iblSource"],defines:this._iblSource?.isCube?`#define IBL_USE_CUBE_MAP
`:"",shaderLanguage:e?1:0,extraInitializations:(r,n)=>{r?n.push(Promise.resolve().then(()=>(I6(),C6))):n.push(Promise.resolve().then(()=>(P6(),M6)))}};this._debugPass=new at(this._debugPassName,"iblCdfDebug",t);let i=this._debugPass.getEffect();i&&(i.defines=this._iblSource?.isCube?`#define IBL_USE_CUBE_MAP
`:""),this._iblSource?.isCube&&this._debugPass.updateEffect(`#define IBL_USE_CUBE_MAP
`),this._debugPass.onApplyObservable.add(r=>{r.setTexture("cdfy",this._cdfyPT),r.setTexture("icdf",this._icdfPT),r.setTexture("cdfx",this._cdfxPT),r.setTexture("iblSource",this._iblSource),r.setFloat4("sizeParams",this._debugSizeParams.x,this._debugSizeParams.y,this._debugSizeParams.z,this._debugSizeParams.w)})}isReady(){return this._iblSource&&this._iblSource.name!=="Placeholder IBL Source"&&this._iblSource.isReady()&&this._cdfyPT&&this._cdfyPT.isReady()&&this._icdfPT&&this._icdfPT.isReady()&&this._cdfxPT&&this._cdfxPT.isReady()&&this._scaledLuminancePT&&this._scaledLuminancePT.isReady()}renderWhenReady(){return this._cachedDominantDirection=null,new Promise((t,i)=>{br(()=>!!this._icdfPT,()=>t(void 0),()=>i(new Error("Waiting for _icdfPT creation failed")))}).then(()=>{this._icdfPT.onGeneratedObservable.addOnce(()=>{this.onGeneratedObservable.notifyObservers()});let t=[],i=[this._cdfyPT,this._cdfxPT,this._scaledLuminancePT,this._icdfPT];for(let r of i)t.push(new Promise(n=>{r.isReady()?n():r.getEffect().executeWhenCompiled(()=>{n()})}));return Promise.all(t).then(()=>{for(let r of i)r.render()})})}findDominantDirection(){return this._cachedDominantDirection?Promise.resolve(this._cachedDominantDirection):new Promise(e=>{this._dominantDirectionPT.onGeneratedObservable.addOnce(()=>{let t=new Float32Array(4);this._dominantDirectionPT.readPixels(0,0,t,!0).then(()=>{let i=new E(t[0],t[1],t[2]);this._cachedDominantDirection=i,e(i)})}),this.isReady()?this._dominantDirectionPT.isReady()?this._dominantDirectionPT.render():this._dominantDirectionPT.getEffect().executeWhenCompiled(()=>{this._dominantDirectionPT.render()}):this.onGeneratedObservable.addOnce(()=>{this._dominantDirectionPT.isReady()?this._dominantDirectionPT.render():this._dominantDirectionPT.getEffect().executeWhenCompiled(()=>{this._dominantDirectionPT.render()})})})}dispose(){this._disposeTextures(),this._dummyTexture.dispose(),this._debugPass&&this._debugPass.dispose(),this.onGeneratedObservable.clear()}static _IsScene(e){return e.getClassName()==="Scene"}};co._SceneComponentInitialization=s=>{throw pe("IblCdfGeneratorSceneComponentSceneComponent")}});var L6={};V(L6,{hdrIrradianceFilteringVertexShaderWGSL:()=>Hie});var DM,O6,Hie,w6=S(()=>{O();DM="hdrIrradianceFilteringVertexShader",O6=`attribute position: vec2f;varying direction: vec3f;uniform up: vec3f;uniform right: vec3f;uniform front: vec3f;
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
var view: mat3x3f= mat3x3f(uniforms.up,uniforms.right,uniforms.front);vertexOutputs.direction=view*vec3f(input.position,1.0);vertexOutputs.position= vec4f(input.position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;g.ShadersStoreWGSL[DM]||(g.ShadersStoreWGSL[DM]=O6);Hie={name:DM,shader:O6}});var N6={};V(N6,{hdrIrradianceFilteringPixelShaderWGSL:()=>zie});var OM,F6,zie,B6=S(()=>{O();Pi();Ru();Pf();bu();OM="hdrIrradianceFilteringPixelShader",F6=`#include<helperFunctions>
#include<importanceSampling>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
var inputTextureSampler: sampler;var inputTexture: texture_cube<f32>;
#ifdef IBL_CDF_FILTERING
var icdfTextureSampler: sampler;var icdfTexture: texture_2d<f32>;
#endif
uniform vFilteringInfo: vec2f;uniform hdrScale: f32;varying direction: vec3f;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var color: vec3f=irradiance(inputTexture,inputTextureSampler,input.direction,uniforms.vFilteringInfo,0.0,vec3f(1.0),input.direction
#ifdef IBL_CDF_FILTERING
,icdfTexture,icdfTextureSampler
#endif
);fragmentOutputs.color= vec4f(color*uniforms.hdrScale,1.0);}`;g.ShadersStoreWGSL[OM]||(g.ShadersStoreWGSL[OM]=F6);zie={name:OM,shader:F6}});var G6={};V(G6,{hdrIrradianceFilteringVertexShader:()=>Xie});var LM,U6,Xie,V6=S(()=>{O();LM="hdrIrradianceFilteringVertexShader",U6=`attribute vec2 position;varying vec3 direction;uniform vec3 up;uniform vec3 right;uniform vec3 front;
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
mat3 view=mat3(up,right,front);direction=view*vec3(position,1.0);gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;g.ShadersStore[LM]||(g.ShadersStore[LM]=U6);Xie={name:LM,shader:U6}});var W6={};V(W6,{hdrIrradianceFilteringPixelShader:()=>Yie});var wM,k6,Yie,H6=S(()=>{O();Di();Iu();Df();yu();wM="hdrIrradianceFilteringPixelShader",k6=`#include<helperFunctions>
#include<importanceSampling>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
uniform samplerCube inputTexture;
#ifdef IBL_CDF_FILTERING
uniform sampler2D icdfTexture;
#endif
uniform vec2 vFilteringInfo;uniform float hdrScale;varying vec3 direction;void main() {vec3 color=irradiance(inputTexture,direction,vFilteringInfo,0.0,vec3(1.0),direction
#ifdef IBL_CDF_FILTERING
,icdfTexture
#endif
);gl_FragColor=vec4(color*hdrScale,1.0);}`;g.ShadersStore[wM]||(g.ShadersStore[wM]=k6);Yie={name:wM,shader:k6}});var Sx,z6=S(()=>{ml();di();ma();In();vx();Sx=class{constructor(e,t={}){this.quality=4096,this.hdrScale=1,this.useCdf=!1,this._engine=e,this.hdrScale=t.hdrScale||this.hdrScale,this.quality=t.quality||this.quality,this.useCdf=t.useCdf||this.useCdf}_createRenderTarget(e){let t=0;this._engine.getCaps().textureHalfFloatRender?t=2:this._engine.getCaps().textureFloatRender&&(t=1);let i=this._engine.createRenderTargetCubeTexture(e,{format:5,type:t,createMipMaps:!1,generateMipMaps:!1,generateDepthBuffer:!1,generateStencilBuffer:!1,samplingMode:2,label:"HDR_Irradiance_Filtering_Target"});return this._engine.updateTextureWrappingMode(i.texture,0,0,0),i}_prefilterInternal(e){let t=e.getSize().width,i=bs(t),r=this._effectWrapper.effect,n=Math.max(32,1<<bs(t>>3)),a=this._createRenderTarget(n);this._effectRenderer.saveStates(),this._effectRenderer.setViewport(),this._effectRenderer.applyEffectWrapper(this._effectWrapper);let o=[[new E(0,0,-1),new E(0,-1,0),new E(1,0,0)],[new E(0,0,1),new E(0,-1,0),new E(-1,0,0)],[new E(1,0,0),new E(0,0,1),new E(0,1,0)],[new E(1,0,0),new E(0,0,-1),new E(0,-1,0)],[new E(1,0,0),new E(0,-1,0),new E(0,0,1)],[new E(-1,0,0),new E(0,-1,0),new E(0,0,-1)]];r.setFloat("hdrScale",this.hdrScale),r.setFloat2("vFilteringInfo",e.getSize().width,i),r.setTexture("inputTexture",e),this._cdfGenerator&&r.setTexture("icdfTexture",this._cdfGenerator.getIcdfTexture());for(let c=0;c<6;c++)r.setVector3("up",o[c][0]),r.setVector3("right",o[c][1]),r.setVector3("front",o[c][2]),this._engine.bindFramebuffer(a,c,void 0,void 0,!0),this._effectRenderer.applyEffectWrapper(this._effectWrapper),this._effectRenderer.draw();this._effectRenderer.restoreStates(),this._engine.restoreDefaultFramebuffer(),r.setTexture("inputTexture",null),r.setTexture("icdfTexture",null);let l=new nt(e.getScene(),a.texture);return l.name=e.name+"_irradiance",l.displayName=e.name+"_irradiance",l.gammaSpace=!1,l}_createEffect(e,t){let i=[];e.gammaSpace&&i.push("#define GAMMA_INPUT"),i.push("#define NUM_SAMPLES "+this.quality+"u");let r=this._engine.isWebGPU,n=["inputTexture"];return this._cdfGenerator&&(n.push("icdfTexture"),i.push("#define IBL_CDF_FILTERING")),new ti({engine:this._engine,name:"HDRIrradianceFiltering",vertexShader:"hdrIrradianceFiltering",fragmentShader:"hdrIrradianceFiltering",samplerNames:n,uniformNames:["vSampleDirections","vWeights","up","right","front","vFilteringInfo","hdrScale"],useShaderStore:!0,defines:i,onCompiled:t,shaderLanguage:r?1:0,extraInitializationsAsync:async()=>{r?await Promise.all([Promise.resolve().then(()=>(w6(),L6)),Promise.resolve().then(()=>(B6(),N6))]):await Promise.all([Promise.resolve().then(()=>(V6(),G6)),Promise.resolve().then(()=>(H6(),W6))])}})}isReady(e){return e.isReady()&&this._effectWrapper.effect.isReady()}async prefilter(e){if(!this._engine._features.allowTexturePrefiltering)throw new Error("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead.");this.useCdf&&(this._cdfGenerator=new co(this._engine),this._cdfGenerator.iblSource=e,await this._cdfGenerator.renderWhenReady()),this._effectRenderer=new Cn(this._engine),this._effectWrapper=this._createEffect(e),await this._effectWrapper.effect.whenCompiledAsync();let t=this._prefilterInternal(e);return this.useCdf&&await this._cdfGenerator.findDominantDirection().then(i=>{t._dominantDirection=i}),this._effectRenderer.dispose(),this._effectWrapper.dispose(),this._cdfGenerator?.dispose(),t}}});var Rd,X6=S(()=>{ie();ma();Ut();Gp();we();$e();xr();X5();z6();Hc();Zh();Rd=class s extends nt{set isBlocking(e){this._isBlocking=e}get isBlocking(){return this._isBlocking}set rotationY(e){this._rotationY=e,this.setReflectionTextureMatrix(B.RotationY(this._rotationY))}get rotationY(){return this._rotationY}set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;let t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}constructor(e,t,i,r=!1,n=!0,a=!1,o=!1,l=null,c=null,f=!1,h=!1,u=!1){super(t),this._generateHarmonics=!0,this._onError=null,this._isBlocking=!0,this._rotationY=0,this.boundingBoxPosition=E.Zero(),this.onLoadObservable=new N,e&&(this._coordinatesMode=H.CUBIC_MODE,this.name=e,this.url=e,this.hasAlpha=!1,this.isCube=!0,this._textureMatrix=B.Identity(),this._prefilterOnLoad=o,this._prefilterIrradianceOnLoad=h,this._prefilterUsingCdf=u,this._onLoad=()=>{this.onLoadObservable.notifyObservers(this),l&&l()},this._onError=c,this.gammaSpace=a,this._noMipmap=r,this._size=i,this._supersample=f||u,this._generateHarmonics=n,this._texture=this._getFromCache(e,this._noMipmap,void 0,void 0,void 0,this.isCube),this._texture?this._texture.isReady?W.SetImmediate(()=>this._onLoad()):this._texture.onLoadedObservable.add(this._onLoad):this.getScene()?.useDelayedTextureLoading?this.delayLoadState=4:this._loadTexture())}getClassName(){return"EnvCubeTexture"}_loadTexture(){let e=this._getEngine(),t=e.getCaps(),i=0;t.textureFloat&&t.textureFloatLinearFiltering?i=1:t.textureHalfFloat&&t.textureHalfFloatLinearFiltering&&(i=2);let r=async n=>{this.lodGenerationOffset=0,this.lodGenerationScale=.8;let a=await this._getCubeMapTextureDataAsync(n,this._size,this._supersample);if(this._generateHarmonics){let f=qs.ConvertCubeMapToSphericalPolynomial(a);this.sphericalPolynomial=f}let o=[],l=null,c=null;for(let f=0;f<6;f++){i===2?c=new Uint16Array(this._size*this._size*3):i===0&&(l=new Uint8Array(this._size*this._size*3));let h=a[s._FacesMapping[f]];if(this.gammaSpace||c||l){for(let u=0;u<this._size*this._size;u++)if(this.gammaSpace&&(h[u*3+0]=Math.pow(h[u*3+0],Sc),h[u*3+1]=Math.pow(h[u*3+1],Sc),h[u*3+2]=Math.pow(h[u*3+2],Sc)),c&&(c[u*3+0]=ki(h[u*3+0]),c[u*3+1]=ki(h[u*3+1]),c[u*3+2]=ki(h[u*3+2])),l){let d=Math.max(h[u*3+0]*255,0),p=Math.max(h[u*3+1]*255,0),m=Math.max(h[u*3+2]*255,0),_=Math.max(Math.max(d,p),m);if(_>255){let v=255/_;d*=v,p*=v,m*=v}l[u*3+0]=d,l[u*3+1]=p,l[u*3+2]=m}}c?o.push(c):l?o.push(l):o.push(h)}return o};if(e._features.allowTexturePrefiltering&&(this._prefilterOnLoad||this._prefilterIrradianceOnLoad)){let n=this._onLoad,a=new _x(e);this._onLoad=()=>{let o=Promise.resolve(null),l=Promise.resolve();this._prefilterIrradianceOnLoad&&(o=new Sx(e,{useCdf:this._prefilterUsingCdf}).prefilter(this)),this._prefilterOnLoad&&(l=a.prefilter(this)),Promise.all([o,l]).then(c=>{let f=c[0];if(this._prefilterIrradianceOnLoad&&f){this.irradianceTexture=f;let h=this.getScene();h&&h.markAllMaterialsAsDirty(1)}n&&n()})}}this._texture=e.createRawCubeTextureFromUrl(this.url,this.getScene(),this._size,4,i,this._noMipmap,r,null,this._onLoad,this._onError)}delayLoad(){this.delayLoadState===4&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap),this._texture||this._loadTexture())}getReflectionTextureMatrix(){return this._textureMatrix}setReflectionTextureMatrix(e){this._textureMatrix=e,e.updateFlag!==this._textureMatrix.updateFlag&&e.isIdentity()!==this._textureMatrix.isIdentity()&&this.getScene()?.markAllMaterialsAsDirty(1,t=>t.getActiveTextures().indexOf(this)!==-1)}dispose(){this.onLoadObservable.clear(),super.dispose()}serialize(){if(!this.name)return null;let e={};return e.name=this.name,e.hasAlpha=this.hasAlpha,e.isCube=!0,e.level=this.level,e.size=this._size,e.coordinatesMode=this.coordinatesMode,e.useInGammaSpace=this.gammaSpace,e.generateHarmonics=this._generateHarmonics,e.noMipmap=this._noMipmap,e.isBlocking=this._isBlocking,e.rotationY=this._rotationY,e}clone(){let e=this._instantiateClone();return e.level=this.level,e.wrapU=this.wrapU,e.wrapV=this.wrapV,e.coordinatesIndex=this.coordinatesIndex,e.coordinatesMode=this.coordinatesMode,e}static _Parse(e,t){t.name=e.name,t.hasAlpha=e.hasAlpha,t.level=e.level,t.coordinatesMode=e.coordinatesMode,t.isBlocking=e.isBlocking,e.boundingBoxPosition&&(t.boundingBoxPosition=E.FromArray(e.boundingBoxPosition)),e.boundingBoxSize&&(t.boundingBoxSize=E.FromArray(e.boundingBoxSize)),e.rotationY&&(t.rotationY=e.rotationY)}};Rd._FacesMapping=["right","left","up","down","front","back"]});var Y6={};V(Y6,{HDRCubeTexture:()=>Ex});var Ex,K6=S(()=>{X6();Lb();Te();Zh();Ex=class s extends Rd{constructor(e,t,i,r=!1,n=!0,a=!1,o=!1,l=null,c=null,f=!1,h=!1,u=!1){super(e,t,i,r,n,a,o,l,c,f,h,u)}getClassName(){return"HDRCubeTexture"}async _getCubeMapTextureDataAsync(e,t,i){return a1(e,t,i)}_instantiateClone(){return new s(this.url,this.getScene()||this._getEngine(),this._size,this._noMipmap,this._generateHarmonics,this.gammaSpace)}serialize(){let e=super.serialize();return e?(e.customType="BABYLON.HDRCubeTexture",e):null}static Parse(e,t,i){if(!e.name||e.isRenderTarget)return null;let r=new s(i+e.name,t,e.size,e.noMipmap,e.generateHarmonics,e.useInGammaSpace);return this._Parse(e,r),r}};G("BABYLON.HDRCubeTexture",Ex)});var q6={};V(q6,{ShaderMaterial:()=>na});var FM,na,NM=S(()=>{ei();Xr();ie();yt();Ut();Te();bo();bc();yf();gt();rn();Xi();FM={effect:null,subMesh:null},na=class s extends Fs{constructor(e,t,i,r={},n=!0){super(e,t,n),this._textures={},this._textureArrays={},this._externalTextures={},this._floats={},this._ints={},this._uints={},this._floatsArrays={},this._colors3={},this._colors3Arrays={},this._colors4={},this._colors4Arrays={},this._vectors2={},this._vectors3={},this._vectors4={},this._quaternions={},this._quaternionsArrays={},this._matrices={},this._matrixArrays={},this._matrices3x3={},this._matrices2x2={},this._vectors2Arrays={},this._vectors3Arrays={},this._vectors4Arrays={},this._uniformBuffers={},this._textureSamplers={},this._storageBuffers={},this._cachedWorldViewMatrix=new B,this._cachedWorldViewProjectionMatrix=new B,this._multiview=!1,this._materialHelperNeedsPreviousMatrices=!1,this._shaderPath=i,this._options={needAlphaBlending:!1,needAlphaTesting:!1,attributes:["position","normal","uv"],uniforms:["worldViewProjection"],uniformBuffers:[],samplers:[],externalTextures:[],samplerObjects:[],storageBuffers:[],defines:[],useClipPlane:!1,...r}}get shaderPath(){return this._shaderPath}set shaderPath(e){this._shaderPath=e}get options(){return this._options}get isMultiview(){return this._multiview}getClassName(){return"ShaderMaterial"}needAlphaBlending(){return this.alpha<1||this._options.needAlphaBlending}needAlphaTesting(){return this._options.needAlphaTesting}_checkUniform(e){this._options.uniforms.indexOf(e)===-1&&this._options.uniforms.push(e)}setTexture(e,t){return this._options.samplers.indexOf(e)===-1&&this._options.samplers.push(e),this._textures[e]=t,this}removeTexture(e){delete this._textures[e]}setTextureArray(e,t){return this._options.samplers.indexOf(e)===-1&&this._options.samplers.push(e),this._checkUniform(e),this._textureArrays[e]=t,this}setExternalTexture(e,t){return this._options.externalTextures.indexOf(e)===-1&&this._options.externalTextures.push(e),this._externalTextures[e]=t,this}setFloat(e,t){return this._checkUniform(e),this._floats[e]=t,this}setInt(e,t){return this._checkUniform(e),this._ints[e]=t,this}setUInt(e,t){return this._checkUniform(e),this._uints[e]=t,this}setFloats(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this}setColor3(e,t){return this._checkUniform(e),this._colors3[e]=t,this}setColor3Array(e,t){return this._checkUniform(e),this._colors3Arrays[e]=t.reduce((i,r)=>(i.push(r.r,r.g,r.b),i),[]),this}setColor4(e,t){return this._checkUniform(e),this._colors4[e]=t,this}setColor4Array(e,t){return this._checkUniform(e),this._colors4Arrays[e]=t.reduce((i,r)=>(i.push(r.r,r.g,r.b,r.a),i),[]),this}setVector2(e,t){return this._checkUniform(e),this._vectors2[e]=t,this}setVector3(e,t){return this._checkUniform(e),this._vectors3[e]=t,this}setVector4(e,t){return this._checkUniform(e),this._vectors4[e]=t,this}setQuaternion(e,t){return this._checkUniform(e),this._quaternions[e]=t,this}setQuaternionArray(e,t){return this._checkUniform(e),this._quaternionsArrays[e]=t.reduce((i,r)=>(r.toArray(i,i.length),i),[]),this}setMatrix(e,t){return this._checkUniform(e),this._matrices[e]=t,this}setMatrices(e,t){this._checkUniform(e);let i=new Float32Array(t.length*16);for(let r=0;r<t.length;r++)t[r].copyToArray(i,r*16);return this._matrixArrays[e]=i,this}setMatrix3x3(e,t){return this._checkUniform(e),this._matrices3x3[e]=t,this}setMatrix2x2(e,t){return this._checkUniform(e),this._matrices2x2[e]=t,this}setArray2(e,t){return this._checkUniform(e),this._vectors2Arrays[e]=t,this}setArray3(e,t){return this._checkUniform(e),this._vectors3Arrays[e]=t,this}setArray4(e,t){return this._checkUniform(e),this._vectors4Arrays[e]=t,this}setUniformBuffer(e,t){return this._options.uniformBuffers.indexOf(e)===-1&&this._options.uniformBuffers.push(e),this._uniformBuffers[e]=t,this}setTextureSampler(e,t){return this._options.samplerObjects.indexOf(e)===-1&&this._options.samplerObjects.push(e),this._textureSamplers[e]=t,this}setStorageBuffer(e,t){return this._options.storageBuffers.indexOf(e)===-1&&this._options.storageBuffers.push(e),this._storageBuffers[e]=t,this}setDefine(e,t){let i=e.trimEnd()+" ",r=this.options.defines.findIndex(n=>n===e||n.startsWith(i));return r>=0&&this.options.defines.splice(r,1),(typeof t!="boolean"||t)&&this.options.defines.push(i+t),this}isReadyForSubMesh(e,t,i){return this.isReady(e,i,t)}isReady(e,t,i){let r=i&&this._storeEffectOnSubMeshes;if(this.isFrozen){let b=r?i._drawWrapper:this._drawWrapper;if(b.effect&&b._wasPreviouslyReady&&b._wasPreviouslyUsingInstances===t)return!0}let n=this.getScene(),a=n.getEngine(),o=[],l=[],c=null,f=this._shaderPath,h=this._options.uniforms,u=this._options.uniformBuffers,d=this._options.samplers;a.getCaps().multiview&&n.activeCamera&&n.activeCamera.outputRenderTarget&&n.activeCamera.outputRenderTarget.getViewCount()>1&&(this._multiview=!0,o.push("#define MULTIVIEW"),h.indexOf("viewProjection")!==-1&&h.indexOf("viewProjectionR")===-1&&h.push("viewProjectionR"));for(let b=0;b<this._options.defines.length;b++){let M=this._options.defines[b].indexOf("#define")===0?this._options.defines[b]:`#define ${this._options.defines[b]}`;o.push(M)}for(let b=0;b<this._options.attributes.length;b++)l.push(this._options.attributes[b]);if(e&&e.isVerticesDataPresent(A.ColorKind)&&(l.indexOf(A.ColorKind)===-1&&l.push(A.ColorKind),o.push("#define VERTEXCOLOR")),t&&(o.push("#define INSTANCES"),sn(l,this._materialHelperNeedsPreviousMatrices),e?.hasThinInstances&&(o.push("#define THIN_INSTANCES"),e&&e.isVerticesDataPresent(A.ColorInstanceKind)&&(l.push(A.ColorInstanceKind),o.push("#define INSTANCESCOLOR")))),e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton){l.push(A.MatricesIndicesKind),l.push(A.MatricesWeightsKind),e.numBoneInfluencers>4&&(l.push(A.MatricesIndicesExtraKind),l.push(A.MatricesWeightsExtraKind));let b=e.skeleton;o.push("#define NUM_BONE_INFLUENCERS "+e.numBoneInfluencers),c=new or,c.addCPUSkinningFallback(0,e),b.isUsingTextureForMatrices?(o.push("#define BONETEXTURE"),h.indexOf("boneTextureWidth")===-1&&h.push("boneTextureWidth"),this._options.samplers.indexOf("boneSampler")===-1&&this._options.samplers.push("boneSampler")):(o.push("#define BonesPerMesh "+(b.bones.length+1)),h.indexOf("mBones")===-1&&h.push("mBones"))}else o.push("#define NUM_BONE_INFLUENCERS 0");let p=0,m=e?e.morphTargetManager:null;if(m){let b=o.indexOf("#define UV1")!==-1,M=o.indexOf("#define UV2")!==-1,F=o.indexOf("#define TANGENT")!==-1,U=o.indexOf("#define NORMAL")!==-1,D=o.indexOf("#define VERTEXCOLOR")!==-1;p=Fn(m,o,l,e,!0,U,F,b,M,D),m.isUsingTextureForTargets&&(h.indexOf("morphTargetTextureIndices")===-1&&h.push("morphTargetTextureIndices"),this._options.samplers.indexOf("morphTargets")===-1&&this._options.samplers.push("morphTargets")),p>0&&(h=h.slice(),h.push("morphTargetInfluences"),h.push("morphTargetCount"),h.push("morphTargetTextureInfo"),h.push("morphTargetTextureIndices"))}else o.push("#define NUM_MORPH_INFLUENCERS 0");if(e){let b=e.bakedVertexAnimationManager;b&&b.isEnabled&&(o.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),h.indexOf("bakedVertexAnimationSettings")===-1&&h.push("bakedVertexAnimationSettings"),h.indexOf("bakedVertexAnimationTextureSizeInverted")===-1&&h.push("bakedVertexAnimationTextureSizeInverted"),h.indexOf("bakedVertexAnimationTime")===-1&&h.push("bakedVertexAnimationTime"),this._options.samplers.indexOf("bakedVertexAnimationTexture")===-1&&this._options.samplers.push("bakedVertexAnimationTexture")),jc(l,e,o)}for(let b in this._textures)if(!this._textures[b].isReady())return!1;e&&this.needAlphaTestingForMesh(e)&&o.push("#define ALPHATEST"),this._options.useClipPlane!==!1&&(Hi(h),On(this,n,o)),n.fogEnabled&&e?.applyFog&&n.fogMode!==ze.FOGMODE_NONE&&(o.push("#define FOG"),h.indexOf("view")===-1&&h.push("view"),h.indexOf("vFogInfos")===-1&&h.push("vFogInfos"),h.indexOf("vFogColor")===-1&&h.push("vFogColor")),this._useLogarithmicDepth&&(o.push("#define LOGARITHMICDEPTH"),h.indexOf("logarithmicDepthConstant")===-1&&h.push("logarithmicDepthConstant")),this.customShaderNameResolve&&(h=h.slice(),u=u.slice(),d=d.slice(),f=this.customShaderNameResolve(this.name,h,u,d,o,l));let _=i?i.getRenderingMesh():e;if(_&&this.useVertexPulling){o.push("#define USE_VERTEX_PULLING");let b=_.geometry?.getIndexBuffer();b&&(o.push("#define VERTEX_PULLING_USE_INDEX_BUFFER"),b.is32Bits&&o.push("#define VERTEX_PULLING_INDEX_BUFFER_32BITS"))}let v=r?i._getDrawWrapper(void 0,!0):this._drawWrapper,T=v?.effect??null,C=v?.defines??null,I=o.join(`
`),R=T;return C!==I&&(R=a.createEffect(f,{attributes:l,uniformsNames:h,uniformBuffersNames:u,samplers:d,defines:I,fallbacks:c,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousMorphTargets:p},shaderLanguage:this._options.shaderLanguage,extraInitializationsAsync:this._options.extraInitializationsAsync},a),r?i.setEffect(R,I,this._materialContext):v&&v.setEffect(R,I),this._onEffectCreatedObservable&&(FM.effect=R,FM.subMesh=i??e?.subMeshes[0]??null,this._onEffectCreatedObservable.notifyObservers(FM))),v._wasPreviouslyUsingInstances=!!t,R?.isReady()?(T!==R&&n.resetCachedMaterial(),v._wasPreviouslyReady=!0,!0):!1}bindOnlyWorldMatrix(e,t){let i=t??this.getEffect();if(!i)return;let r=this._options.uniforms;r.indexOf("world")!==-1&&i.setMatrix("world",e);let n=this.getScene();r.indexOf("worldView")!==-1&&(e.multiplyToRef(n.getViewMatrix(),this._cachedWorldViewMatrix),i.setMatrix("worldView",this._cachedWorldViewMatrix)),r.indexOf("worldViewProjection")!==-1&&(e.multiplyToRef(n.getTransformMatrix(),this._cachedWorldViewProjectionMatrix),i.setMatrix("worldViewProjection",this._cachedWorldViewProjectionMatrix)),r.indexOf("view")!==-1&&i.setMatrix("view",n.getViewMatrix())}bindForSubMesh(e,t,i){this.bind(e,t,i._drawWrapperOverride?.effect,i)}bind(e,t,i,r){let n=r&&this._storeEffectOnSubMeshes,a=i??(n?r.effect:this.getEffect());if(!a)return;let o=this.getScene();this._activeEffect=a,this.bindOnlyWorldMatrix(e,i);let l=this._options.uniformBuffers,c=!1;if(a&&l&&l.length>0&&o.getEngine().supportsUniformBuffers)for(let h=0;h<l.length;++h)switch(l[h]){case"Mesh":t&&(t.getMeshUniformBuffer().bindToEffect(a,"Mesh"),t.transferToEffect(e));break;case"Scene":Co(a,o.getSceneUniformBuffer()),o.finalizeSceneUbo(),c=!0;break}let f=t&&n?this._mustRebind(o,a,r,t.visibility):o.getCachedMaterial()!==this;if(a&&f){!c&&this._options.uniforms.indexOf("view")!==-1&&a.setMatrix("view",o.getViewMatrix()),!c&&this._options.uniforms.indexOf("projection")!==-1&&a.setMatrix("projection",o.getProjectionMatrix()),!c&&this._options.uniforms.indexOf("viewProjection")!==-1&&(a.setMatrix("viewProjection",o.getTransformMatrix()),this._multiview&&a.setMatrix("viewProjectionR",o._transformMatrixR)),o.activeCamera&&this._options.uniforms.indexOf("cameraPosition")!==-1&&a.setVector3("cameraPosition",o.activeCamera.globalPosition),Nn(t,a),zi(a,this,o),this._useLogarithmicDepth&&Ln(n?r.materialDefines:a.defines,a,o),t&&wn(o,t,a);let h;for(h in this._textures)a.setTexture(h,this._textures[h]);for(h in this._textureArrays)a.setTextureArray(h,this._textureArrays[h]);for(h in this._ints)a.setInt(h,this._ints[h]);for(h in this._uints)a.setUInt(h,this._uints[h]);for(h in this._floats)a.setFloat(h,this._floats[h]);for(h in this._floatsArrays)a.setArray(h,this._floatsArrays[h]);for(h in this._colors3)a.setColor3(h,this._colors3[h]);for(h in this._colors3Arrays)a.setArray3(h,this._colors3Arrays[h]);for(h in this._colors4){let _=this._colors4[h];a.setFloat4(h,_.r,_.g,_.b,_.a)}for(h in this._colors4Arrays)a.setArray4(h,this._colors4Arrays[h]);for(h in this._vectors2)a.setVector2(h,this._vectors2[h]);for(h in this._vectors3)a.setVector3(h,this._vectors3[h]);for(h in this._vectors4)a.setVector4(h,this._vectors4[h]);for(h in this._quaternions)a.setQuaternion(h,this._quaternions[h]);for(h in this._matrices)a.setMatrix(h,this._matrices[h]);for(h in this._matrixArrays)a.setMatrices(h,this._matrixArrays[h]);for(h in this._matrices3x3)a.setMatrix3x3(h,this._matrices3x3[h]);for(h in this._matrices2x2)a.setMatrix2x2(h,this._matrices2x2[h]);for(h in this._vectors2Arrays)a.setArray2(h,this._vectors2Arrays[h]);for(h in this._vectors3Arrays)a.setArray3(h,this._vectors3Arrays[h]);for(h in this._vectors4Arrays)a.setArray4(h,this._vectors4Arrays[h]);for(h in this._quaternionsArrays)a.setArray4(h,this._quaternionsArrays[h]);for(h in this._uniformBuffers){let _=this._uniformBuffers[h].getBuffer();_&&a.bindUniformBuffer(_,h)}let u=o.getEngine(),d=u.setExternalTexture;if(d)for(h in this._externalTextures)d.call(u,h,this._externalTextures[h]);let p=u.setTextureSampler;if(p)for(h in this._textureSamplers)p.call(u,h,this._textureSamplers[h]);let m=u.setStorageBuffer;if(m)for(h in this._storageBuffers)m.call(u,h,this._storageBuffers[h])}if(a&&t&&(f||!this.isFrozen)){lr(t,a),t.morphTargetManager&&t.morphTargetManager.isUsingTextureForTargets&&t.morphTargetManager._bind(a);let h=t.bakedVertexAnimationManager;if(h&&h.isEnabled){let u=n?r._drawWrapper:this._drawWrapper;t.bakedVertexAnimationManager?.bind(a,!!u._wasPreviouslyUsingInstances)}}this._afterBind(t,a,r)}getActiveTextures(){let e=super.getActiveTextures();for(let t in this._textures)e.push(this._textures[t]);for(let t in this._textureArrays){let i=this._textureArrays[t];for(let r=0;r<i.length;r++)e.push(i[r])}return e}hasTexture(e){if(super.hasTexture(e))return!0;for(let t in this._textures)if(this._textures[t]===e)return!0;for(let t in this._textureArrays){let i=this._textureArrays[t];for(let r=0;r<i.length;r++)if(i[r]===e)return!0}return!1}clone(e){let t=_e.Clone(()=>new s(e,this.getScene(),this._shaderPath,this._options,this._storeEffectOnSubMeshes),this);t.name=e,t.id=e,typeof t._shaderPath=="object"&&(t._shaderPath={...t._shaderPath}),this._options={...this._options};let i=Object.keys(this._options);for(let r of i){let n=this._options[r];Array.isArray(n)&&(this._options[r]=n.slice(0))}this.stencil.copyTo(t.stencil);for(let r in this._textures)t.setTexture(r,this._textures[r]);for(let r in this._textureArrays)t.setTextureArray(r,this._textureArrays[r]);for(let r in this._externalTextures)t.setExternalTexture(r,this._externalTextures[r]);for(let r in this._ints)t.setInt(r,this._ints[r]);for(let r in this._uints)t.setUInt(r,this._uints[r]);for(let r in this._floats)t.setFloat(r,this._floats[r]);for(let r in this._floatsArrays)t.setFloats(r,this._floatsArrays[r]);for(let r in this._colors3)t.setColor3(r,this._colors3[r]);for(let r in this._colors3Arrays)t._colors3Arrays[r]=this._colors3Arrays[r];for(let r in this._colors4)t.setColor4(r,this._colors4[r]);for(let r in this._colors4Arrays)t._colors4Arrays[r]=this._colors4Arrays[r];for(let r in this._vectors2)t.setVector2(r,this._vectors2[r]);for(let r in this._vectors3)t.setVector3(r,this._vectors3[r]);for(let r in this._vectors4)t.setVector4(r,this._vectors4[r]);for(let r in this._quaternions)t.setQuaternion(r,this._quaternions[r]);for(let r in this._quaternionsArrays)t._quaternionsArrays[r]=this._quaternionsArrays[r];for(let r in this._matrices)t.setMatrix(r,this._matrices[r]);for(let r in this._matrixArrays)t._matrixArrays[r]=this._matrixArrays[r].slice();for(let r in this._matrices3x3)t.setMatrix3x3(r,this._matrices3x3[r]);for(let r in this._matrices2x2)t.setMatrix2x2(r,this._matrices2x2[r]);for(let r in this._vectors2Arrays)t.setArray2(r,this._vectors2Arrays[r]);for(let r in this._vectors3Arrays)t.setArray3(r,this._vectors3Arrays[r]);for(let r in this._vectors4Arrays)t.setArray4(r,this._vectors4Arrays[r]);for(let r in this._uniformBuffers)t.setUniformBuffer(r,this._uniformBuffers[r]);for(let r in this._textureSamplers)t.setTextureSampler(r,this._textureSamplers[r]);for(let r in this._storageBuffers)t.setStorageBuffer(r,this._storageBuffers[r]);return t}dispose(e,t,i){if(t){let r;for(r in this._textures)this._textures[r].dispose();for(r in this._textureArrays){let n=this._textureArrays[r];for(let a=0;a<n.length;a++)n[a].dispose()}}this._textures={},super.dispose(e,t,i)}serialize(){let e=_e.Serialize(this);e.customType="BABYLON.ShaderMaterial",e.uniqueId=this.uniqueId,e.options=this._options,e.shaderPath=this._shaderPath,e.storeEffectOnSubMeshes=this._storeEffectOnSubMeshes;let t;e.stencil=this.stencil.serialize(),e.textures={};for(t in this._textures)e.textures[t]=this._textures[t].serialize();e.textureArrays={};for(t in this._textureArrays){e.textureArrays[t]=[];let i=this._textureArrays[t];for(let r=0;r<i.length;r++)e.textureArrays[t].push(i[r].serialize())}e.ints={};for(t in this._ints)e.ints[t]=this._ints[t];e.uints={};for(t in this._uints)e.uints[t]=this._uints[t];e.floats={};for(t in this._floats)e.floats[t]=this._floats[t];e.floatsArrays={};for(t in this._floatsArrays)e.floatsArrays[t]=this._floatsArrays[t];e.colors3={};for(t in this._colors3){let i=this._colors3[t];e.colors3[t]=[i.r,i.g,i.b]}e.colors3Arrays={};for(t in this._colors3Arrays)e.colors3Arrays[t]=this._colors3Arrays[t];e.colors4={};for(t in this._colors4){let i=this._colors4[t];e.colors4[t]=[i.r,i.g,i.b,i.a]}e.colors4Arrays={};for(t in this._colors4Arrays)e.colors4Arrays[t]=this._colors4Arrays[t];e.vectors2={};for(t in this._vectors2){let i=this._vectors2[t];e.vectors2[t]=[i.x,i.y]}e.vectors3={};for(t in this._vectors3){let i=this._vectors3[t];e.vectors3[t]=[i.x,i.y,i.z]}e.vectors4={};for(t in this._vectors4){let i=this._vectors4[t];e.vectors4[t]=[i.x,i.y,i.z,i.w]}e.quaternions={};for(t in this._quaternions)e.quaternions[t]=this._quaternions[t].asArray();e.matrices={};for(t in this._matrices)e.matrices[t]=this._matrices[t].asArray();e.matrixArray={};for(t in this._matrixArrays)e.matrixArray[t]=this._matrixArrays[t];e.matrices3x3={};for(t in this._matrices3x3)e.matrices3x3[t]=this._matrices3x3[t];e.matrices2x2={};for(t in this._matrices2x2)e.matrices2x2[t]=this._matrices2x2[t];e.vectors2Arrays={};for(t in this._vectors2Arrays)e.vectors2Arrays[t]=this._vectors2Arrays[t];e.vectors3Arrays={};for(t in this._vectors3Arrays)e.vectors3Arrays[t]=this._vectors3Arrays[t];e.vectors4Arrays={};for(t in this._vectors4Arrays)e.vectors4Arrays[t]=this._vectors4Arrays[t];e.quaternionsArrays={};for(t in this._quaternionsArrays)e.quaternionsArrays[t]=this._quaternionsArrays[t];return e}static Parse(e,t,i){let r=_e.Parse(()=>new s(e.name,t,e.shaderPath,e.options,e.storeEffectOnSubMeshes),e,t,i),n;e.stencil&&r.stencil.parse(e.stencil,t,i);for(n in e.textures)r.setTexture(n,H.Parse(e.textures[n],t,i));for(n in e.textureArrays){let a=e.textureArrays[n],o=[];for(let l=0;l<a.length;l++)o.push(H.Parse(a[l],t,i));r.setTextureArray(n,o)}for(n in e.ints)r.setInt(n,e.ints[n]);for(n in e.uints)r.setUInt(n,e.uints[n]);for(n in e.floats)r.setFloat(n,e.floats[n]);for(n in e.floatsArrays)r.setFloats(n,e.floatsArrays[n]);for(n in e.colors3){let a=e.colors3[n];r.setColor3(n,{r:a[0],g:a[1],b:a[2]})}for(n in e.colors3Arrays){let a=e.colors3Arrays[n].reduce((o,l,c)=>(c%3===0?o.push([l]):o[o.length-1].push(l),o),[]).map(o=>({r:o[0],g:o[1],b:o[2]}));r.setColor3Array(n,a)}for(n in e.colors4){let a=e.colors4[n];r.setColor4(n,{r:a[0],g:a[1],b:a[2],a:a[3]})}for(n in e.colors4Arrays){let a=e.colors4Arrays[n].reduce((o,l,c)=>(c%4===0?o.push([l]):o[o.length-1].push(l),o),[]).map(o=>({r:o[0],g:o[1],b:o[2],a:o[3]}));r.setColor4Array(n,a)}for(n in e.vectors2){let a=e.vectors2[n];r.setVector2(n,{x:a[0],y:a[1]})}for(n in e.vectors3){let a=e.vectors3[n];r.setVector3(n,{x:a[0],y:a[1],z:a[2]})}for(n in e.vectors4){let a=e.vectors4[n];r.setVector4(n,{x:a[0],y:a[1],z:a[2],w:a[3]})}for(n in e.quaternions)r.setQuaternion(n,K.FromArray(e.quaternions[n]));for(n in e.matrices)r.setMatrix(n,B.FromArray(e.matrices[n]));for(n in e.matrixArray)r._matrixArrays[n]=new Float32Array(e.matrixArray[n]);for(n in e.matrices3x3)r.setMatrix3x3(n,e.matrices3x3[n]);for(n in e.matrices2x2)r.setMatrix2x2(n,e.matrices2x2[n]);for(n in e.vectors2Arrays)r.setArray2(n,e.vectors2Arrays[n]);for(n in e.vectors3Arrays)r.setArray3(n,e.vectors3Arrays[n]);for(n in e.vectors4Arrays)r.setArray4(n,e.vectors4Arrays[n]);for(n in e.quaternionsArrays)r.setArray4(n,e.quaternionsArrays[n]);return r}static async ParseFromFileAsync(e,t,i,r=""){return await new Promise((n,a)=>{let o=new gi;o.addEventListener("readystatechange",()=>{if(o.readyState==4)if(o.status==200){let l=JSON.parse(o.responseText),c=this.Parse(l,i||Z.LastCreatedScene,r);e&&(c.name=e),n(c)}else a("Unable to load the ShaderMaterial")}),o.open("GET",t),o.send()})}static async ParseFromSnippetAsync(e,t,i=""){return await new Promise((r,n)=>{let a=new gi;a.addEventListener("readystatechange",()=>{if(a.readyState==4)if(a.status==200){let o=JSON.parse(JSON.parse(a.responseText).jsonPayload),l=JSON.parse(o.shaderMaterial),c=this.Parse(l,t||Z.LastCreatedScene,i);c.snippetId=e,r(c)}else n("Unable to load the snippet "+e)}),a.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),a.send()})}};na.SnippetUrl="https://snippet.babylonjs.com";na.CreateFromSnippetAsync=na.ParseFromSnippetAsync;G("BABYLON.ShaderMaterial",na)});var Q6={};V(Q6,{ShaderLanguage:()=>BM});var BM,j6=S(()=>{(function(s){s[s.GLSL=0]="GLSL",s[s.WGSL=1]="WGSL"})(BM||(BM={}))});var VM={};V(VM,{CreateDisc:()=>GM,CreateDiscVertexData:()=>UM,DiscBuilder:()=>Kie});function UM(s){let e=[],t=[],i=[],r=[],n=s.radius||.5,a=s.tessellation||64,o=s.arc&&(s.arc<=0||s.arc>1)?1:s.arc||1,l=s.sideOrientation===0?0:s.sideOrientation||Ge.DEFAULTSIDE;e.push(0,0,0),r.push(.5,.5);let c=Math.PI*2*o,f=o===1?c/a:c/(a-1),h=0;for(let p=0;p<a;p++){let m=Math.cos(h),_=Math.sin(h),v=(m+1)/2,T=(1-_)/2;e.push(n*m,n*_,0),r.push(v,Si?1-T:T),h+=f}o===1&&(e.push(e[3],e[4],e[5]),r.push(r[2],Si?1-r[3]:r[3]));let u=e.length/3;for(let p=1;p<u-1;p++)t.push(p+1,0,p);Ge.ComputeNormals(e,t,i),Ge._ComputeSides(l,e,t,i,r,s.frontUVs,s.backUVs);let d=new Ge;return d.indices=t,d.positions=e,d.normals=i,d.uvs=r,d}function GM(s,e={},t=null){let i=new fe(s,t);return e.sideOrientation=fe._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,UM(e).applyToMesh(i,e.updatable),i}var Kie,kM=S(()=>{Ki();ln();Fc();Kie={CreateDisc:GM};Ge.CreateDisc=UM;fe.CreateDisc=(s,e,t,i=null,r,n)=>GM(s,{radius:e,tessellation:t,sideOrientation:n,updatable:r},i)});var qie={};var Tx=S(()=>{vi();Ee();kr();Ne.prototype.restoreSingleAttachment=function(){let s=this._gl;this.bindAttachments([s.BACK])};Ne.prototype.restoreSingleAttachmentForRenderTarget=function(){let s=this._gl;this.bindAttachments([s.COLOR_ATTACHMENT0])};Ne.prototype.buildTextureLayout=function(s,e=!1){let t=this._gl,i=[];if(e)i.push(t.BACK);else for(let r=0;r<s.length;r++)s[r]?i.push(t["COLOR_ATTACHMENT"+r]):i.push(t.NONE);return i};Ne.prototype.bindAttachments=function(s){this._gl.drawBuffers(s)};Ne.prototype.unBindMultiColorAttachmentFramebuffer=function(s,e=!1,t){this._currentRenderTarget=null,s.disableAutomaticMSAAResolve||this.resolveMultiFramebuffer(s),e||this.generateMipMapsMultiFramebuffer(s),t&&(s._MSAAFramebuffer&&this._bindUnboundFramebuffer(s._framebuffer),t()),this._bindUnboundFramebuffer(null)};Ne.prototype.createMultipleRenderTarget=function(s,e,t=!0){let i=!1,r=!0,n=!1,a=!1,o,l=1,c=1,f=0,h=3,u=!1,d=5,p=3553,m=[],_=[],v=[],T=[],C=[],I=[],R=[],b=[],M=[],F=!1,U=this._createHardwareRenderTargetWrapper(!0,!1,s);e!==void 0&&(i=e.generateMipMaps===void 0?!1:e.generateMipMaps,r=e.generateDepthBuffer===void 0?!0:e.generateDepthBuffer,n=e.generateStencilBuffer===void 0?!1:e.generateStencilBuffer,a=e.generateDepthTexture===void 0?!1:e.generateDepthTexture,l=e.textureCount??1,c=e.samples??c,m=e.types||m,_=e.samplingModes||_,v=e.useSRGBBuffers||v,T=e.formats||T,C=e.targetTypes||C,I=e.faceIndex||I,R=e.layerIndex||R,b=e.layerCounts||b,M=e.labels||M,F=e.dontCreateTextures??!1,this.webGLVersion>1&&(e.depthTextureFormat===13||e.depthTextureFormat===17||e.depthTextureFormat===16||e.depthTextureFormat===14||e.depthTextureFormat===18)&&(o=e.depthTextureFormat)),o===void 0&&(o=n?13:14);let D=this._gl,$=this._currentFramebuffer,oe=D.createFramebuffer();this._bindUnboundFramebuffer(oe);let re=s.width??s,se=s.height??s,be=[],Me=[],ke=this.webGLVersion>1&&(o===13||o===17||o===18);U.label=e?.label??"MultiRenderTargetWrapper",U._framebuffer=oe,U._generateDepthBuffer=a||r,U._generateStencilBuffer=a?ke:n,U._depthStencilBuffer=this._setupFramebufferDepthAttachments(U._generateStencilBuffer,U._generateDepthBuffer,re,se,1,o),U._attachments=Me;for(let de=0;de<l;de++){let Qe=_[de]||h,Re=m[de]||f,Ae=v[de]||u,ut=T[de]||d,Et=C[de]||p,Er=b[de]??1;(Re===1&&!this._caps.textureFloatLinearFiltering||Re===2&&!this._caps.textureHalfFloatLinearFiltering)&&(Qe=1);let Tr=this._getSamplingParameters(Qe,i);Re===1&&!this._caps.textureFloat&&(Re=0,P.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")),Ae=Ae&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU);let Le=this.webGLVersion>1,uo=D[Le?"COLOR_ATTACHMENT"+de:"COLOR_ATTACHMENT"+de+"_WEBGL"];if(Me.push(uo),Et===-1||F)continue;let Qt=new Je(this,6);be[de]=Qt,D.activeTexture(D["TEXTURE"+de]),D.bindTexture(Et,Qt._hardwareTexture.underlyingResource),D.texParameteri(Et,D.TEXTURE_MAG_FILTER,Tr.mag),D.texParameteri(Et,D.TEXTURE_MIN_FILTER,Tr.min),D.texParameteri(Et,D.TEXTURE_WRAP_S,D.CLAMP_TO_EDGE),D.texParameteri(Et,D.TEXTURE_WRAP_T,D.CLAMP_TO_EDGE);let vn=this._getRGBABufferInternalSizedFormat(Re,ut,Ae),Sn=this._getInternalFormat(ut),En=this._getWebGLTextureType(Re);if(Le&&(Et===35866||Et===32879))Et===35866?Qt.is2DArray=!0:Qt.is3D=!0,Qt.baseDepth=Qt.depth=Er,D.texImage3D(Et,0,vn,re,se,Er,0,Sn,En,null);else if(Et===34067){for(let Tn=0;Tn<6;Tn++)D.texImage2D(D.TEXTURE_CUBE_MAP_POSITIVE_X+Tn,0,vn,re,se,0,Sn,En,null);Qt.isCube=!0}else D.texImage2D(D.TEXTURE_2D,0,vn,re,se,0,Sn,En,null);i&&D.generateMipmap(Et),this._bindTextureDirectly(Et,null),Qt.baseWidth=re,Qt.baseHeight=se,Qt.width=re,Qt.height=se,Qt.isReady=!0,Qt.samples=1,Qt.generateMipMaps=i,Qt.samplingMode=Qe,Qt.type=Re,Qt._useSRGBBuffer=Ae,Qt.format=ut,Qt.label=M[de]??U.label+"-Texture"+de,this._internalTexturesCache.push(Qt)}if(a&&this._caps.depthTextureExtension&&!F){let de=new Je(this,14),Qe=5,Re=D.DEPTH_COMPONENT16,Ae=D.DEPTH_COMPONENT,ut=D.UNSIGNED_SHORT,Et=D.DEPTH_ATTACHMENT;this.webGLVersion<2?Re=D.DEPTH_COMPONENT:o===14?(Qe=1,ut=D.FLOAT,Re=D.DEPTH_COMPONENT32F):o===18?(Qe=0,ut=D.FLOAT_32_UNSIGNED_INT_24_8_REV,Re=D.DEPTH32F_STENCIL8,Ae=D.DEPTH_STENCIL,Et=D.DEPTH_STENCIL_ATTACHMENT):o===16?(Qe=0,ut=D.UNSIGNED_INT,Re=D.DEPTH_COMPONENT24,Et=D.DEPTH_ATTACHMENT):(o===13||o===17)&&(Qe=12,ut=D.UNSIGNED_INT_24_8,Re=D.DEPTH24_STENCIL8,Ae=D.DEPTH_STENCIL,Et=D.DEPTH_STENCIL_ATTACHMENT),this._bindTextureDirectly(D.TEXTURE_2D,de,!0),D.texParameteri(D.TEXTURE_2D,D.TEXTURE_MAG_FILTER,D.NEAREST),D.texParameteri(D.TEXTURE_2D,D.TEXTURE_MIN_FILTER,D.NEAREST),D.texParameteri(D.TEXTURE_2D,D.TEXTURE_WRAP_S,D.CLAMP_TO_EDGE),D.texParameteri(D.TEXTURE_2D,D.TEXTURE_WRAP_T,D.CLAMP_TO_EDGE),D.texImage2D(D.TEXTURE_2D,0,Re,re,se,0,Ae,ut,null),D.framebufferTexture2D(D.FRAMEBUFFER,Et,D.TEXTURE_2D,de._hardwareTexture.underlyingResource,0),this._bindTextureDirectly(D.TEXTURE_2D,null),U._depthStencilTexture=de,U._depthStencilTextureWithStencil=ke,de.baseWidth=re,de.baseHeight=se,de.width=re,de.height=se,de.isReady=!0,de.samples=1,de.generateMipMaps=i,de.samplingMode=1,de.format=o,de.type=Qe,de.label=U.label+"-DepthStencil",be[l]=de,this._internalTexturesCache.push(de)}if(U.setTextures(be),t&&D.drawBuffers(Me),this._bindUnboundFramebuffer($),U.setLayerAndFaceIndices(R,I),this.resetTextureCache(),!F)this.updateMultipleRenderTargetTextureSampleCount(U,c,t);else if(c>1){let de=D.createFramebuffer();if(!de)throw new Error("Unable to create multi sampled framebuffer");U._samples=c,U._MSAAFramebuffer=de,l>0&&t&&(this._bindUnboundFramebuffer(de),D.drawBuffers(Me),this._bindUnboundFramebuffer($))}return U};Ne.prototype.updateMultipleRenderTargetTextureSampleCount=function(s,e,t=!0){if(this.webGLVersion<2||!s)return 1;if(s.samples===e)return e;let i=this._gl;e=Math.min(e,this.getCaps().maxMSAASamples),s._depthStencilBuffer&&(i.deleteRenderbuffer(s._depthStencilBuffer),s._depthStencilBuffer=null),s._MSAAFramebuffer&&(i.deleteFramebuffer(s._MSAAFramebuffer),s._MSAAFramebuffer=null);let r=s._attachments.length;for(let a=0;a<r;a++)s.textures[a]._hardwareTexture?.releaseMSAARenderBuffers();if(e>1&&typeof i.renderbufferStorageMultisample=="function"){let a=i.createFramebuffer();if(!a)throw new Error("Unable to create multi sampled framebuffer");s._MSAAFramebuffer=a,this._bindUnboundFramebuffer(a);let o=[];for(let l=0;l<r;l++){let c=s.textures[l],f=c._hardwareTexture,h=i[this.webGLVersion>1?"COLOR_ATTACHMENT"+l:"COLOR_ATTACHMENT"+l+"_WEBGL"],u=this._createRenderBuffer(c.width,c.height,e,-1,this._getRGBABufferInternalSizedFormat(c.type,c.format,c._useSRGBBuffer),h);if(!u)throw new Error("Unable to create multi sampled framebuffer");f.addMSAARenderBuffer(u),c.samples=e,o.push(h)}t&&i.drawBuffers(o)}else this._bindUnboundFramebuffer(s._framebuffer);let n=s._depthStencilTexture?s._depthStencilTexture.format:void 0;return s._depthStencilBuffer=this._setupFramebufferDepthAttachments(s._generateStencilBuffer,s._generateDepthBuffer,s.width,s.height,e,n),this._bindUnboundFramebuffer(null),s._samples=e,e};Ne.prototype.generateMipMapsMultiFramebuffer=function(s){let e=s,t=this._gl;if(e.isMulti)for(let i=0;i<e._attachments.length;i++){let r=e.textures[i];r?.generateMipMaps&&!r?.isCube&&!r?.is3D&&(this._bindTextureDirectly(t.TEXTURE_2D,r,!0),t.generateMipmap(t.TEXTURE_2D),this._bindTextureDirectly(t.TEXTURE_2D,null))}};Ne.prototype.resolveMultiFramebuffer=function(s){let e=s,t=this._gl;if(!e._MSAAFramebuffer||!e.isMulti)return;let i=e.resolveMSAAColors?t.COLOR_BUFFER_BIT:0;i|=e._generateDepthBuffer&&e.resolveMSAADepth?t.DEPTH_BUFFER_BIT:0,i|=e._generateStencilBuffer&&e.resolveMSAAStencil?t.STENCIL_BUFFER_BIT:0;let r=e._attachments,n=r.length;t.bindFramebuffer(t.READ_FRAMEBUFFER,e._MSAAFramebuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,e._framebuffer);for(let a=0;a<n;a++){let o=e.textures[a];for(let l=0;l<n;l++)r[l]=t.NONE;r[a]=t[this.webGLVersion>1?"COLOR_ATTACHMENT"+a:"COLOR_ATTACHMENT"+a+"_WEBGL"],t.readBuffer(r[a]),t.drawBuffers(r),t.blitFramebuffer(0,0,o.width,o.height,0,0,o.width,o.height,i,t.NEAREST)}for(let a=0;a<n;a++)r[a]=t[this.webGLVersion>1?"COLOR_ATTACHMENT"+a:"COLOR_ATTACHMENT"+a+"_WEBGL"];t.drawBuffers(r),t.bindFramebuffer(this._gl.FRAMEBUFFER,e._MSAAFramebuffer)}});var fh,WM=S(()=>{Ut();Mn();Tx();fh=class extends Gt{get isSupported(){return this._engine?.getCaps().drawBuffersExtension??!1}get textures(){return this._textures}get count(){return this._count}get depthTexture(){return this._textures[this._textures.length-1]}set wrapU(e){if(this._textures)for(let t=0;t<this._textures.length;t++)this._textures[t].wrapU=e}set wrapV(e){if(this._textures)for(let t=0;t<this._textures.length;t++)this._textures[t].wrapV=e}constructor(e,t,i,r,n,a){let o=n&&n.generateMipMaps?n.generateMipMaps:!1,l=n&&n.generateDepthTexture?n.generateDepthTexture:!1,c=n&&n.depthTextureFormat?n.depthTextureFormat:15,f=!n||n.doNotChangeAspectRatio===void 0?!0:n.doNotChangeAspectRatio,h=n&&n.drawOnlyOnFirstAttachmentByDefault?n.drawOnlyOnFirstAttachmentByDefault:!1;if(super(e,t,r,o,f,void 0,void 0,void 0,void 0,void 0,void 0,void 0,!0),!this.isSupported){this.dispose();return}this._textureNames=a;let u=[],d=[],p=[],m=[],_=[],v=[],T=[],C=[];this._initTypes(i,u,d,p,m,_,v,T,C,n);let I=!n||n.generateDepthBuffer===void 0?!0:n.generateDepthBuffer,R=!n||n.generateStencilBuffer===void 0?!1:n.generateStencilBuffer,b=n&&n.samples?n.samples:1;this._multiRenderTargetOptions={samplingModes:d,generateMipMaps:o,generateDepthBuffer:I,generateStencilBuffer:R,generateDepthTexture:l,depthTextureFormat:c,types:u,textureCount:i,useSRGBBuffers:p,samples:b,formats:m,targetTypes:_,faceIndex:v,layerIndex:T,layerCounts:C,labels:a,label:e},this._count=i,this._drawOnlyOnFirstAttachmentByDefault=h,i>0&&(this._createInternalTextures(),this._createTextures(a))}_initTypes(e,t,i,r,n,a,o,l,c,f){for(let h=0;h<e;h++)f&&f.types&&f.types[h]!==void 0?t.push(f.types[h]):t.push(f&&f.defaultType?f.defaultType:0),f&&f.samplingModes&&f.samplingModes[h]!==void 0?i.push(f.samplingModes[h]):i.push(H.BILINEAR_SAMPLINGMODE),f&&f.useSRGBBuffers&&f.useSRGBBuffers[h]!==void 0?r.push(f.useSRGBBuffers[h]):r.push(!1),f&&f.formats&&f.formats[h]!==void 0?n.push(f.formats[h]):n.push(5),f&&f.targetTypes&&f.targetTypes[h]!==void 0?a.push(f.targetTypes[h]):a.push(3553),f&&f.faceIndex&&f.faceIndex[h]!==void 0?o.push(f.faceIndex[h]):o.push(0),f&&f.layerIndex&&f.layerIndex[h]!==void 0?l.push(f.layerIndex[h]):l.push(0),f&&f.layerCounts&&f.layerCounts[h]!==void 0?c.push(f.layerCounts[h]):c.push(1)}_createInternaTextureIndexMapping(){let e={},t=[];if(!this._renderTarget)return t;let i=this._renderTarget.textures;for(let r=0;r<i.length;r++){let n=i[r];if(!n)continue;let a=e[n.uniqueId];a!==void 0?t[r]=a:e[n.uniqueId]=r}return t}_rebuild(e=!1,t=!1,i){if(this._count<1||e)return;let r=this._createInternaTextureIndexMapping();this.releaseInternalTextures(),this._createInternalTextures(),t&&(this._releaseTextures(),this._createTextures(i));let n=this._renderTarget.textures;for(let a=0;a<n.length;a++){let o=this._textures[a];r[a]!==void 0&&this._renderTarget.setTexture(n[r[a]],a),o._texture=n[a],o._texture&&(o._noMipmap=!o._texture.useMipMaps,o._useSRGBBuffer=o._texture._useSRGBBuffer)}this.samples!==1&&this._renderTarget.setSamples(this.samples,!this._drawOnlyOnFirstAttachmentByDefault,!0)}_createInternalTextures(){this._renderTarget=this._getEngine().createMultipleRenderTarget(this._size,this._multiRenderTargetOptions,!this._drawOnlyOnFirstAttachmentByDefault),this._texture=this._renderTarget.texture}_releaseTextures(){if(this._textures)for(let e=0;e<this._textures.length;e++)this._textures[e]._texture=null,this._textures[e].dispose()}_createTextures(e){let t=this._renderTarget.textures;this._textures=[];for(let i=0;i<t.length;i++){let r=new H(null,this.getScene());e?.[i]&&(r.name=e[i]),r._texture=t[i],r._texture&&(r._noMipmap=!r._texture.useMipMaps,r._useSRGBBuffer=r._texture._useSRGBBuffer),this._textures.push(r)}}setInternalTexture(e,t,i=!0){if(this.renderTarget&&(t===0&&(this._texture=e),this.renderTarget.setTexture(e,t,i),this.textures[t]||(this.textures[t]=new H(null,this.getScene()),this.textures[t].name=this._textureNames?.[t]??this.textures[t].name),this.textures[t]._texture=e,this.textures[t]._noMipmap=!e.useMipMaps,this.textures[t]._useSRGBBuffer=e._useSRGBBuffer,this._count=this.renderTarget.textures?this.renderTarget.textures.length:0,this._multiRenderTargetOptions.types&&(this._multiRenderTargetOptions.types[t]=e.type),this._multiRenderTargetOptions.samplingModes&&(this._multiRenderTargetOptions.samplingModes[t]=e.samplingMode),this._multiRenderTargetOptions.useSRGBBuffers&&(this._multiRenderTargetOptions.useSRGBBuffers[t]=e._useSRGBBuffer),this._multiRenderTargetOptions.targetTypes&&this._multiRenderTargetOptions.targetTypes[t]!==-1)){let r=0;e.is2DArray?r=35866:e.isCube?r=34067:e.is3D?r=32879:r=3553,this._multiRenderTargetOptions.targetTypes[t]=r}}setLayerAndFaceIndex(e,t=-1,i=-1){!this.textures[e]||!this.renderTarget||(this._multiRenderTargetOptions.layerIndex&&(this._multiRenderTargetOptions.layerIndex[e]=t),this._multiRenderTargetOptions.faceIndex&&(this._multiRenderTargetOptions.faceIndex[e]=i),this.renderTarget.setLayerAndFaceIndex(e,t,i))}setLayerAndFaceIndices(e,t){this.renderTarget&&(this._multiRenderTargetOptions.layerIndex=e,this._multiRenderTargetOptions.faceIndex=t,this.renderTarget.setLayerAndFaceIndices(e,t))}get samples(){return this._samples}set samples(e){this._renderTarget?this._samples=this._renderTarget.setSamples(e):this._samples=e}resize(e){this._processSizeParameter(e),this._rebuild(!1,void 0,this._textureNames)}updateCount(e,t,i){this._multiRenderTargetOptions.textureCount=e,this._count=e;let r=[],n=[],a=[],o=[],l=[],c=[],f=[],h=[];this._textureNames=i,this._initTypes(e,r,n,a,o,l,c,f,h,t),this._multiRenderTargetOptions.types=r,this._multiRenderTargetOptions.samplingModes=n,this._multiRenderTargetOptions.useSRGBBuffers=a,this._multiRenderTargetOptions.formats=o,this._multiRenderTargetOptions.targetTypes=l,this._multiRenderTargetOptions.faceIndex=c,this._multiRenderTargetOptions.layerIndex=f,this._multiRenderTargetOptions.layerCounts=h,this._multiRenderTargetOptions.labels=i,this._rebuild(!1,!0,i)}_unbindFrameBuffer(e,t){this._renderTarget&&e.unBindMultiColorAttachmentFramebuffer(this._renderTarget,this.isCube,()=>{this.onAfterRenderObservable.notifyObservers(t)})}dispose(e=!1){this._releaseTextures(),e?this._texture=null:this.releaseInternalTextures(),super.dispose()}releaseInternalTextures(){let e=this._renderTarget?.textures;if(e){for(let t=e.length-1;t>=0;t--)this._textures[t]._texture=null;this._renderTarget?.dispose(),this._renderTarget=null}}}});var J6={};V(J6,{iblVoxelGrid3dDebugPixelShaderWGSL:()=>Qie});var HM,Z6,Qie,$6=S(()=>{O();HM="iblVoxelGrid3dDebugPixelShader",Z6=`varying vUV: vec2f;var voxelTextureSampler: sampler;var voxelTexture: texture_3d<f32>;var voxelSlabTextureSampler: sampler;var voxelSlabTexture: texture_2d<f32>;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform sizeParams: vec4f;
#define offsetX uniforms.sizeParams.x
#define offsetY uniforms.sizeParams.y
#define widthScale uniforms.sizeParams.z
#define heightScale uniforms.sizeParams.w
uniform mipNumber: f32;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var uv: vec2f =
vec2f((offsetX+input.vUV.x)*widthScale,(offsetY+input.vUV.y)*heightScale);var background: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);var voxelSlab: vec4f=textureSample(voxelSlabTexture,voxelSlabTextureSampler,input.vUV);var size: vec3u=textureDimensions(voxelTexture, i32(uniforms.mipNumber));var dimension: f32=ceil(sqrt( f32(size.z)));var samplePos: vec2f=fract(uv.xy* vec2f(dimension));var sampleIndex: u32= u32(floor(uv.x* f32(dimension)) +
floor(uv.y* f32(dimension))*dimension);var mip_separator: f32=0.0;if (samplePos.x<0.01 || samplePos.y<0.01) {mip_separator=1.0;}
var outBounds: bool=select(false,true,sampleIndex>size.z-1);sampleIndex=clamp(sampleIndex,0,size.z-1);var samplePosInt: vec2i= vec2i(samplePos.xy* vec2f(size.xy));var voxel: vec3f=textureLoad(voxelTexture,
vec3i(i32(samplePosInt.x),i32(samplePosInt.y),i32(sampleIndex)),
i32(uniforms.mipNumber)).rgb;if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {fragmentOutputs.color=background;} else {if (outBounds) {voxel= vec3f(0.15,0.0,0.0);} else {if (voxel.r>0.001) {voxel.g=1.0;}
voxel.r+=mip_separator;}
fragmentOutputs.color=vec4f(mix(background.rgb,voxelSlab.rgb,voxelSlab.a)+voxel,1.0);}}`;g.ShadersStoreWGSL[HM]||(g.ShadersStoreWGSL[HM]=Z6);Qie={name:HM,shader:Z6}});var tY={};V(tY,{iblVoxelGrid3dDebugPixelShader:()=>jie});var zM,eY,jie,iY=S(()=>{O();zM="iblVoxelGrid3dDebugPixelShader",eY=`precision highp sampler3D;varying vec2 vUV;uniform sampler3D voxelTexture;uniform sampler2D voxelSlabTexture;uniform sampler2D textureSampler;uniform vec4 sizeParams;
#define offsetX sizeParams.x
#define offsetY sizeParams.y
#define widthScale sizeParams.z
#define heightScale sizeParams.w
uniform float mipNumber;void main(void) {vec2 uv =
vec2((offsetX+vUV.x)*widthScale,(offsetY+vUV.y)*heightScale);vec4 background=texture2D(textureSampler,vUV);vec4 voxelSlab=texture2D(voxelSlabTexture,vUV);ivec3 size=textureSize(voxelTexture,int(mipNumber));float dimension=ceil(sqrt(float(size.z)));vec2 samplePos=fract(uv.xy*vec2(dimension));int sampleIndex=int(floor(uv.x*float(dimension)) +
floor(uv.y*float(dimension))*dimension);float mip_separator=0.0;if (samplePos.x<0.01 || samplePos.y<0.01) {mip_separator=1.0;}
bool outBounds=sampleIndex>size.z-1 ? true : false;sampleIndex=clamp(sampleIndex,0,size.z-1);ivec2 samplePosInt=ivec2(samplePos.xy*vec2(size.xy));vec3 voxel=texelFetch(voxelTexture,
ivec3(samplePosInt.x,samplePosInt.y,sampleIndex),
int(mipNumber))
.rgb;if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {gl_FragColor.rgba=background;} else {if (outBounds) {voxel=vec3(0.15,0.0,0.0);} else {if (voxel.r>0.001) {voxel.g=1.0;}
voxel.r+=mip_separator;}
glFragColor.rgb=mix(background.rgb,voxelSlab.rgb,voxelSlab.a)+voxel;glFragColor.a=1.0;}}`;g.ShadersStore[zM]||(g.ShadersStore[zM]=eY);jie={name:zM,shader:eY}});var sY={};V(sY,{iblVoxelGrid2dArrayDebugPixelShaderWGSL:()=>Zie});var XM,rY,Zie,nY=S(()=>{O();XM="iblVoxelGrid2dArrayDebugPixelShader",rY=`varying vUV: vec2f;var voxelTextureSampler: sampler;var voxelTexture: texture_3d<f32>;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform slice: i32;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var size: vec3u=textureDimensions(voxelTexture,0);var dimension: f32=sqrt( f32(size.z));var samplePos: vec2f=fract(input.vUV.xy* vec2f(dimension));var sampleIndex: u32= u32(floor(input.vUV.x* f32(dimension))+floor(input.vUV.y* f32(dimension))*dimension);var color=textureSample(voxelTexture,voxelTextureSampler, vec3f(samplePos.xy,sampleIndex)).rrr;color+=textureSample(textureSampler,textureSamplerSampler,input.vUV.xy).rgb;fragmentOutputs.color=vec4f(color,1.0);}`;g.ShadersStoreWGSL[XM]||(g.ShadersStoreWGSL[XM]=rY);Zie={name:XM,shader:rY}});var oY={};V(oY,{iblVoxelGrid2dArrayDebugPixelShader:()=>Jie});var YM,aY,Jie,lY=S(()=>{O();YM="iblVoxelGrid2dArrayDebugPixelShader",aY="precision highp sampler2DArray;varying vec2 vUV;uniform sampler2DArray voxelTexture;uniform sampler2D textureSampler;uniform int slice;void main(void) {ivec3 size=textureSize(voxelTexture,0);float dimension=sqrt(float(size.z));vec2 samplePos=fract(vUV.xy*vec2(dimension));int sampleIndex=int(floor(vUV.x*float(dimension))+floor(vUV.y*float(dimension))*dimension);glFragColor.rgb=texture(voxelTexture,vec3(samplePos.xy,sampleIndex)).rrr;glFragColor.a=1.0;glFragColor.rgb+=texture(textureSampler,vUV.xy).rgb;}";g.ShadersStore[YM]||(g.ShadersStore[YM]=aY);Jie={name:YM,shader:aY}});var fY={};V(fY,{copyTexture3DLayerToTexturePixelShaderWGSL:()=>$ie});var KM,cY,$ie,hY=S(()=>{O();KM="copyTexture3DLayerToTexturePixelShader",cY=`var textureSampler: texture_3d<f32>;uniform layerNum: i32;varying vUV: vec2f;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {let coord=vec3f(vec2f(input.vUV.x,input.vUV.y)*vec2f(textureDimensions(textureSampler,0).xy),f32(uniforms.layerNum));let color=textureLoad(textureSampler,vec3i(coord),0).rgb;fragmentOutputs.color= vec4f(color,1);}`;g.ShadersStoreWGSL[KM]||(g.ShadersStoreWGSL[KM]=cY);$ie={name:KM,shader:cY}});var dY={};V(dY,{copyTexture3DLayerToTexturePixelShader:()=>ere});var qM,uY,ere,pY=S(()=>{O();qM="copyTexture3DLayerToTexturePixelShader",uY=`precision highp sampler3D;uniform sampler3D textureSampler;uniform int layerNum;varying vec2 vUV;void main(void) {vec3 coord=vec3(0.0,0.0,float(layerNum));coord.xy=vec2(vUV.x,vUV.y)*vec2(textureSize(textureSampler,0).xy);vec3 color=texelFetch(textureSampler,ivec3(coord),0).rgb;gl_FragColor=vec4(color,1);}
`;g.ShadersStore[qM]||(g.ShadersStore[qM]=uY);ere={name:qM,shader:uY}});var _Y={};V(_Y,{iblCombineVoxelGridsPixelShaderWGSL:()=>tre});var QM,mY,tre,gY=S(()=>{O();QM="iblCombineVoxelGridsPixelShader",mY=`varying vUV: vec2f;var voxelXaxisSamplerSampler: sampler;var voxelXaxisSampler: texture_3d<f32>;var voxelYaxisSamplerSampler: sampler;var voxelYaxisSampler: texture_3d<f32>;var voxelZaxisSamplerSampler: sampler;var voxelZaxisSampler: texture_3d<f32>;uniform layer: f32;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var coordZ: vec3f= vec3f(fragmentInputs.vUV.x,fragmentInputs.vUV.y,uniforms.layer);var voxelZ: f32=textureSample(voxelZaxisSampler,voxelZaxisSamplerSampler,coordZ).r;var coordX: vec3f= vec3f(1.0-uniforms.layer,fragmentInputs.vUV.y,fragmentInputs.vUV.x);var voxelX: f32=textureSample(voxelXaxisSampler,voxelXaxisSamplerSampler,coordX).r;var coordY: vec3f= vec3f(uniforms.layer,fragmentInputs.vUV.x,fragmentInputs.vUV.y);var voxelY: f32=textureSample(voxelYaxisSampler,voxelYaxisSamplerSampler,coordY).r;var voxel=select(0.0,1.0,(voxelX>0.0 || voxelY>0.0 || voxelZ>0.0));fragmentOutputs.color= vec4f( vec3f(voxel),1.0);}`;g.ShadersStoreWGSL[QM]||(g.ShadersStoreWGSL[QM]=mY);tre={name:QM,shader:mY}});var SY={};V(SY,{iblCombineVoxelGridsPixelShader:()=>ire});var jM,vY,ire,EY=S(()=>{O();jM="iblCombineVoxelGridsPixelShader",vY="precision highp float;precision highp sampler3D;varying vec2 vUV;uniform sampler3D voxelXaxisSampler;uniform sampler3D voxelYaxisSampler;uniform sampler3D voxelZaxisSampler;uniform float layer;void main(void) {vec3 coordZ=vec3(vUV.x,vUV.y,layer);float voxelZ=texture(voxelZaxisSampler,coordZ).r;vec3 coordX=vec3(1.0-layer,vUV.y,vUV.x);float voxelX=texture(voxelXaxisSampler,coordX).r;vec3 coordY=vec3(layer,vUV.x,vUV.y);float voxelY=texture(voxelYaxisSampler,coordY).r;float voxel=(voxelX>0.0 || voxelY>0.0 || voxelZ>0.0) ? 1.0 : 0.0;glFragColor=vec4(vec3(voxel),1.0);}";g.ShadersStore[jM]||(g.ShadersStore[jM]=vY);ire={name:jM,shader:vY}});var xY={};V(xY,{iblGenerateVoxelMipPixelShaderWGSL:()=>rre});var ZM,TY,rre,AY=S(()=>{O();ZM="iblGenerateVoxelMipPixelShader",TY=`varying vUV: vec2f;var srcMip: texture_3d<f32>;uniform layerNum: i32;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var Coords=vec3i(2)*vec3i(vec2i(fragmentInputs.position.xy),uniforms.layerNum);var tex =
(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(0,0,0),0).x>0.0f))
<< 0u) |
(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(1,0,0),0).x>0.0f))
<< 1u) |
(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(0,1,0),0).x>0.0f))
<< 2u) |
(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(1,1,0),0).x>0.0f))
<< 3u) |
(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(0,0,1),0).x>0.0f))
<< 4u) |
(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(1,0,1),0).x>0.0f))
<< 5u) |
(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(0,1,1),0).x>0.0f))
<< 6u) |
(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(1,1,1),0).x>0.0f))
<< 7u);fragmentOutputs.color=vec4f( f32(tex)/255.0f,0.0f,0.0f,1.0);}`;g.ShadersStoreWGSL[ZM]||(g.ShadersStoreWGSL[ZM]=TY);rre={name:ZM,shader:TY}});var bY={};V(bY,{iblGenerateVoxelMipPixelShader:()=>sre});var JM,RY,sre,CY=S(()=>{O();JM="iblGenerateVoxelMipPixelShader",RY=`precision highp float;precision highp sampler3D;varying vec2 vUV;uniform sampler3D srcMip;uniform int layerNum;void main(void) {ivec3 Coords=ivec3(2)*ivec3(gl_FragCoord.x,gl_FragCoord.y,layerNum);uint tex =
uint(texelFetch(srcMip,Coords+ivec3(0,0,0),0).x>0.0f ? 1u : 0u)
<< 0u |
uint(texelFetch(srcMip,Coords+ivec3(1,0,0),0).x>0.0f ? 1u : 0u)
<< 1u |
uint(texelFetch(srcMip,Coords+ivec3(0,1,0),0).x>0.0f ? 1u : 0u)
<< 2u |
uint(texelFetch(srcMip,Coords+ivec3(1,1,0),0).x>0.0f ? 1u : 0u)
<< 3u |
uint(texelFetch(srcMip,Coords+ivec3(0,0,1),0).x>0.0f ? 1u : 0u)
<< 4u |
uint(texelFetch(srcMip,Coords+ivec3(1,0,1),0).x>0.0f ? 1u : 0u)
<< 5u |
uint(texelFetch(srcMip,Coords+ivec3(0,1,1),0).x>0.0f ? 1u : 0u)
<< 6u |
uint(texelFetch(srcMip,Coords+ivec3(1,1,1),0).x>0.0f ? 1u : 0u)
<< 7u;glFragColor.rgb=vec3(float(tex)/255.0f,0.0f,0.0f);glFragColor.a=1.0;}`;g.ShadersStore[JM]||(g.ShadersStore[JM]=RY);sre={name:JM,shader:RY}});var yY={};V(yY,{iblVoxelGridPixelShaderWGSL:()=>nre});var $M,IY,nre,MY=S(()=>{O();$M="iblVoxelGridPixelShader",IY=`varying vNormalizedPosition: vec3f;uniform nearPlane: f32;uniform farPlane: f32;uniform stepSize: f32;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var normPos: vec3f=input.vNormalizedPosition.xyz;if (normPos.z<uniforms.nearPlane || normPos.z>uniforms.farPlane) {discard;}
fragmentOutputs.fragData0=select(vec4f(0.0),vec4f(1.0),normPos.z<uniforms.nearPlane+uniforms.stepSize);fragmentOutputs.fragData1=select(vec4f(0.0),vec4f(1.0),normPos.z>=uniforms.nearPlane+uniforms.stepSize && normPos.z<uniforms.nearPlane+2.0*uniforms.stepSize);fragmentOutputs.fragData2=select(vec4f(0.0),vec4f(1.0),normPos.z>=uniforms.nearPlane+2.0*uniforms.stepSize && normPos.z<uniforms.nearPlane+3.0*uniforms.stepSize);fragmentOutputs.fragData3=select(vec4f(0.0),vec4f(1.0),normPos.z>=uniforms.nearPlane+3.0*uniforms.stepSize && normPos.z<uniforms.nearPlane+4.0*uniforms.stepSize);
#if MAX_DRAW_BUFFERS>4
fragmentOutputs.fragData4=select(vec4f(0.0),vec4f(1.0),normPos.z>=uniforms.nearPlane+4.0*uniforms.stepSize && normPos.z<uniforms.nearPlane+5.0*uniforms.stepSize);fragmentOutputs.fragData5=select(vec4f(0.0),vec4f(1.0),normPos.z>=uniforms.nearPlane+5.0*uniforms.stepSize && normPos.z<uniforms.nearPlane+6.0*uniforms.stepSize);fragmentOutputs.fragData6=select(vec4f(0.0),vec4f(1.0),normPos.z>=uniforms.nearPlane+6.0*uniforms.stepSize && normPos.z<uniforms.nearPlane+7.0*uniforms.stepSize);fragmentOutputs.fragData7=select(vec4f(0.0),vec4f(1.0),normPos.z>=uniforms.nearPlane+7.0*uniforms.stepSize && normPos.z<uniforms.nearPlane+8.0*uniforms.stepSize);
#endif
}`;g.ShadersStoreWGSL[$M]||(g.ShadersStoreWGSL[$M]=IY);nre={name:$M,shader:IY}});var DY={};V(DY,{iblVoxelGridVertexShaderWGSL:()=>are});var eP,PY,are,OY=S(()=>{O();Ia();Bn();Va();Oo();Lo();Fo();No();Un();Ma();Gn();eP="iblVoxelGridVertexShader",PY=`attribute position: vec3f;varying vNormalizedPosition: vec3f;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
uniform invWorldScale: mat4x4f;uniform viewMatrix: mat4x4f;@vertex
fn main(input : VertexInputs)->FragmentInputs {var positionUpdated=vertexInputs.position;
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
let worldPos=finalWorld*vec4f(positionUpdated,1.0);vertexOutputs.position=uniforms.viewMatrix*uniforms.invWorldScale*worldPos;vertexOutputs.vNormalizedPosition=vertexOutputs.position.xyz*0.5+0.5;
#ifdef IS_NDC_HALF_ZRANGE
vertexOutputs.position=vec4f(vertexOutputs.position.x,vertexOutputs.position.y,vertexOutputs.position.z*0.5+0.5,vertexOutputs.position.w);
#endif
}
`;g.ShadersStoreWGSL[eP]||(g.ShadersStoreWGSL[eP]=PY);are={name:eP,shader:PY}});var wY={};V(wY,{iblVoxelGridPixelShader:()=>ore});var tP,LY,ore,FY=S(()=>{O();tP="iblVoxelGridPixelShader",LY=`precision highp float;layout(location=0) out highp float glFragData[MAX_DRAW_BUFFERS];varying vec3 vNormalizedPosition;uniform float nearPlane;uniform float farPlane;uniform float stepSize;void main(void) {vec3 normPos=vNormalizedPosition.xyz;if (normPos.z<nearPlane || normPos.z>farPlane) {discard;}
glFragData[0]=normPos.z<nearPlane+stepSize ? 1.0 : 0.0;glFragData[1]=normPos.z>=nearPlane+stepSize && normPos.z<nearPlane+2.0*stepSize ? 1.0 : 0.0;glFragData[2]=normPos.z>=nearPlane+2.0*stepSize && normPos.z<nearPlane+3.0*stepSize ? 1.0 : 0.0;glFragData[3]=normPos.z>=nearPlane+3.0*stepSize && normPos.z<nearPlane+4.0*stepSize ? 1.0 : 0.0;
#if MAX_DRAW_BUFFERS>4
glFragData[4]=normPos.z>=nearPlane+4.0*stepSize && normPos.z<nearPlane+5.0*stepSize ? 1.0 : 0.0;glFragData[5]=normPos.z>=nearPlane+5.0*stepSize && normPos.z<nearPlane+6.0*stepSize ? 1.0 : 0.0;glFragData[6]=normPos.z>=nearPlane+6.0*stepSize && normPos.z<nearPlane+7.0*stepSize ? 1.0 : 0.0;glFragData[7]=normPos.z>=nearPlane+7.0*stepSize && normPos.z<nearPlane+8.0*stepSize ? 1.0 : 0.0;
#endif
}`;g.ShadersStore[tP]||(g.ShadersStore[tP]=LY);ore={name:tP,shader:LY}});var BY={};V(BY,{iblVoxelGridVertexShader:()=>lre});var iP,NY,lre,UY=S(()=>{O();La();wa();ko();Bo();Uo();Go();Vo();Na();Ba();Ua();iP="iblVoxelGridVertexShader",NY=`attribute vec3 position;varying vec3 vNormalizedPosition;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
uniform mat4 invWorldScale;uniform mat4 viewMatrix;void main(void) {vec3 positionUpdated=position;
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);gl_Position=viewMatrix*invWorldScale*worldPos;vNormalizedPosition.xyz=gl_Position.xyz*0.5+0.5;
#ifdef IS_NDC_HALF_ZRANGE
gl_Position.z=gl_Position.z*0.5+0.5;
#endif
}`;g.ShadersStore[iP]||(g.ShadersStore[iP]=NY);lre={name:iP,shader:NY}});var VY={};V(VY,{iblVoxelSlabDebugPixelShaderWGSL:()=>cre});var rP,GY,cre,kY=S(()=>{O();rP="iblVoxelSlabDebugPixelShader",GY=`varying vNormalizedPosition: vec3f;uniform nearPlane: f32;uniform farPlane: f32;uniform stepSize: f32;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var normPos: vec3f=input.vNormalizedPosition.xyz;var chunkSize: f32=uniforms.stepSize* f32(MAX_DRAW_BUFFERS);var numChunks: f32=1.0/chunkSize;var positionInChunk: f32=fract(normPos.z/chunkSize);var slab: f32=floor(positionInChunk* f32(MAX_DRAW_BUFFERS)) /
f32(MAX_DRAW_BUFFERS);if (normPos.x<0.0 || normPos.y<0.0 || normPos.z<0.0 ||
normPos.x>1.0 || normPos.y>1.0 || normPos.z>1.0) {fragmentOutputs.color= vec4f(0.0,0.0,0.0,0.0);} else {fragmentOutputs.color= vec4f(slab,0.0,0.0,0.75);}}`;g.ShadersStoreWGSL[rP]||(g.ShadersStoreWGSL[rP]=GY);cre={name:rP,shader:GY}});var HY={};V(HY,{iblVoxelSlabDebugVertexShaderWGSL:()=>fre});var sP,WY,fre,zY=S(()=>{O();sP="iblVoxelSlabDebugVertexShader",WY=`attribute position: vec3f;varying vNormalizedPosition: vec3f;uniform world: mat4x4f;uniform invWorldScale: mat4x4f;uniform cameraViewMatrix: mat4x4f;uniform projection: mat4x4f;uniform viewMatrix: mat4x4f;@vertex
fn main(input : VertexInputs)->FragmentInputs {var worldPosition: vec4f=(uniforms.world* vec4f(input.position,1.));vertexOutputs.position=uniforms.projection*uniforms.cameraViewMatrix*worldPosition;vertexOutputs.vNormalizedPosition=(uniforms.viewMatrix*uniforms.invWorldScale*worldPosition).rgb;vertexOutputs.vNormalizedPosition=vertexOutputs.vNormalizedPosition* vec3f(0.5)+ vec3f(0.5);}`;g.ShadersStoreWGSL[sP]||(g.ShadersStoreWGSL[sP]=WY);fre={name:sP,shader:WY}});var YY={};V(YY,{iblVoxelSlabDebugPixelShader:()=>hre});var nP,XY,hre,KY=S(()=>{O();nP="iblVoxelSlabDebugPixelShader",XY=`precision highp float;varying vec3 vNormalizedPosition;uniform float nearPlane;uniform float farPlane;uniform float stepSize;void main(void) {vec3 normPos=vNormalizedPosition.xyz;float chunkSize=stepSize*float(MAX_DRAW_BUFFERS);float numChunks=1.0/chunkSize;float positionInChunk=fract(normPos.z/chunkSize);float slab=floor(positionInChunk*float(MAX_DRAW_BUFFERS)) /
float(MAX_DRAW_BUFFERS);if (normPos.x<0.0 || normPos.y<0.0 || normPos.z<0.0 ||
normPos.x>1.0 || normPos.y>1.0 || normPos.z>1.0) {gl_FragColor=vec4(0.0,0.0,0.0,0.0);} else {gl_FragColor=vec4(slab,0.0,0.0,0.75);}}`;g.ShadersStore[nP]||(g.ShadersStore[nP]=XY);hre={name:nP,shader:XY}});var QY={};V(QY,{iblVoxelSlabDebugVertexShader:()=>ure});var aP,qY,ure,jY=S(()=>{O();aP="iblVoxelSlabDebugVertexShader",qY="attribute vec3 position;varying vec3 vNormalizedPosition;uniform mat4 world;uniform mat4 invWorldScale;uniform mat4 cameraViewMatrix;uniform mat4 projection;uniform mat4 viewMatrix;void main(void) {vec4 worldPosition=(world*vec4(position,1.));gl_Position=projection*cameraViewMatrix*worldPosition;vNormalizedPosition=(viewMatrix*invWorldScale*worldPosition).rgb;vNormalizedPosition.xyz=vNormalizedPosition.xyz*vec3(0.5)+vec3(0.5);}";g.ShadersStore[aP]||(g.ShadersStore[aP]=qY);ure={name:aP,shader:qY}});var xx,ZY=S(()=>{Sa();NM();WM();Mn();it();ie();Ut();Ee();we();Wr();ch();In();xx=class{getVoxelGrid(){return this._triPlanarVoxelization?this._voxelGridRT:this._voxelGridZaxis}getDebugPassPP(){return this._voxelDebugPass||this._createDebugPass(),this._voxelDebugPass}get triPlanarVoxelization(){return this._triPlanarVoxelization}set triPlanarVoxelization(e){this._triPlanarVoxelization!==e&&(this._triPlanarVoxelization=e,this._disposeVoxelTextures(),this._createTextures())}setWorldScaleMatrix(e){this._invWorldScaleMatrix=e}isVoxelizationInProgress(){return this._voxelizationInProgress}get voxelResolutionExp(){return this._voxelResolutionExp}set voxelResolutionExp(e){this._voxelResolutionExp===e&&this._voxelGridZaxis||(this._voxelResolutionExp=Math.round(Math.min(Math.max(e,3),9)),this._voxelResolution=Math.pow(2,this._voxelResolutionExp),this._disposeVoxelTextures(),this._createTextures())}set voxelDebugAxis(e){this._voxelDebugAxis=e}get voxelDebugAxis(){return this._voxelDebugAxis}setDebugDisplayParams(e,t,i,r){this._debugSizeParams.set(e,t,i,r)}setDebugMipNumber(e){this._debugMipNumber=e}get debugPassName(){return this._debugPassName}get voxelDebugEnabled(){return this._voxelDebugEnabled}set voxelDebugEnabled(e){this._voxelDebugEnabled!==e&&(this._voxelDebugEnabled=e,e&&(this._voxelSlabDebugRT=new Gt("voxelSlabDebug",{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},this._scene,{generateDepthBuffer:!0,generateMipMaps:!1,type:0,format:5,samplingMode:1}),this._voxelSlabDebugRT.noPrePassRenderer=!0),this._voxelSlabDebugRT&&this._removeVoxelRTs([this._voxelSlabDebugRT]),this._voxelDebugEnabled?(this._addRTsForRender([this._voxelSlabDebugRT],this._includedMeshes,this._voxelDebugAxis,1,!0),this._setDebugBindingsBound=this._setDebugBindings.bind(this),this._scene.onBeforeRenderObservable.add(this._setDebugBindingsBound)):this._scene.onBeforeRenderObservable.removeCallback(this._setDebugBindingsBound))}_createDebugPass(){let e=this._engine.isWebGPU;if(!this._voxelDebugPass){let t={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight(),textureFormat:5,textureType:0,samplingMode:1,uniforms:["sizeParams","mipNumber"],samplers:["voxelTexture","voxelSlabTexture"],engine:this._engine,reusable:!1,shaderLanguage:e?1:0,extraInitializations:(i,r)=>{if(this._isVoxelGrid3D){i?r.push(Promise.resolve().then(()=>($6(),J6))):r.push(Promise.resolve().then(()=>(iY(),tY)));return}i?r.push(Promise.resolve().then(()=>(nY(),sY))):r.push(Promise.resolve().then(()=>(lY(),oY)))}};this._voxelDebugPass=new at(this.debugPassName,this._isVoxelGrid3D?"iblVoxelGrid3dDebug":"iblVoxelGrid2dArrayDebug",t),this._voxelDebugPass.onApplyObservable.add(i=>{this._voxelDebugAxis===0?i.setTexture("voxelTexture",this._voxelGridXaxis):this._voxelDebugAxis===1?i.setTexture("voxelTexture",this._voxelGridYaxis):this._voxelDebugAxis===2?i.setTexture("voxelTexture",this._voxelGridZaxis):i.setTexture("voxelTexture",this.getVoxelGrid()),i.setTexture("voxelSlabTexture",this._voxelSlabDebugRT),i.setVector4("sizeParams",this._debugSizeParams),i.setFloat("mipNumber",this._debugMipNumber)})}}constructor(e,t,i=6,r=!0){this._voxelMrtsXaxis=[],this._voxelMrtsYaxis=[],this._voxelMrtsZaxis=[],this._isVoxelGrid3D=!0,this.onVoxelizationCompleteObservable=new N,this._renderTargets=[],this._triPlanarVoxelization=!0,this._voxelizationInProgress=!1,this._invWorldScaleMatrix=B.Identity(),this._voxelResolution=64,this._voxelResolutionExp=6,this._mipArray=[],this._voxelDebugEnabled=!1,this._voxelDebugAxis=-1,this._debugSizeParams=new Oe(0,0,0,0),this._includedMeshes=[],this._debugMipNumber=0,this._debugPassName="Voxelization Debug Pass",this._scene=e,this._engine=e.getEngine(),this._triPlanarVoxelization=r,this._engine.getCaps().drawBuffersExtension||P.Error("Can't do voxel rendering without the draw buffers extension.");let n=this._engine.isWebGPU;this._maxDrawBuffers=this._engine.getCaps().maxDrawBuffers||0,this._copyMipEffectRenderer=new Cn(this._engine),this._copyMipEffectWrapper=new ti({engine:this._engine,fragmentShader:"copyTexture3DLayerToTexture",useShaderStore:!0,uniformNames:["layerNum"],samplerNames:["textureSampler"],shaderLanguage:n?1:0,extraInitializationsAsync:async()=>{n?await Promise.resolve().then(()=>(hY(),fY)):await Promise.resolve().then(()=>(pY(),dY))}}),this.voxelResolutionExp=i}_generateMipMaps(){let e=Math.ceil(Math.log2(this._voxelResolution));for(let t=1;t<e+1;t++)this._generateMipMap(t)}_generateMipMap(e){let t=this._mipArray[e-1];t&&(t.setTexture("srcMip",e===1?this.getVoxelGrid():this._mipArray[e-2]),t.render())}_copyMipMaps(){let e=Math.ceil(Math.log2(this._voxelResolution));for(let t=1;t<e+1;t++)this._copyMipMap(t)}_copyMipMap(e){let t=this._mipArray[e-1];if(!t)return;let i=this.getVoxelGrid(),r;if(i instanceof Gt&&i.renderTarget?r=i.renderTarget:r=i._rtWrapper,r){this._copyMipEffectRenderer.saveStates();let n=t.getSize().width;for(let a=0;a<n;a++)this._engine.bindFramebuffer(r,0,n,n,!0,e,a),this._copyMipEffectRenderer.applyEffectWrapper(this._copyMipEffectWrapper),this._copyMipEffectWrapper.effect.setTexture("textureSampler",t),this._copyMipEffectWrapper.effect.setInt("layerNum",a),this._copyMipEffectRenderer.draw(),this._engine.unBindFramebuffer(r,!0);this._copyMipEffectRenderer.restoreStates()}}_computeNumberOfSlabs(){return Math.ceil(this._voxelResolution/this._maxDrawBuffers)}_createTextures(){let e=this._engine.isWebGPU,t={width:this._voxelResolution,height:this._voxelResolution,layers:this._isVoxelGrid3D?void 0:this._voxelResolution,depth:this._isVoxelGrid3D?this._voxelResolution:void 0},i={generateDepthBuffer:!1,generateMipMaps:!1,type:0,format:6,samplingMode:1},r=this._computeNumberOfSlabs(),n={generateDepthBuffer:!1,generateMipMaps:!0,type:0,format:6,samplingMode:4,shaderLanguage:e?1:0,extraInitializationsAsync:async()=>{e?await Promise.resolve().then(()=>(gY(),_Y)):await Promise.resolve().then(()=>(EY(),SY))}};this._triPlanarVoxelization?(this._voxelGridXaxis=new Gt("voxelGridXaxis",t,this._scene,i),this._voxelGridYaxis=new Gt("voxelGridYaxis",t,this._scene,i),this._voxelGridZaxis=new Gt("voxelGridZaxis",t,this._scene,i),this._voxelMrtsXaxis=this._createVoxelMRTs("x_axis_",this._voxelGridXaxis,r),this._voxelMrtsYaxis=this._createVoxelMRTs("y_axis_",this._voxelGridYaxis,r),this._voxelMrtsZaxis=this._createVoxelMRTs("z_axis_",this._voxelGridZaxis,r),this._voxelGridRT=new ci("combinedVoxelGrid",t,"iblCombineVoxelGrids",this._scene,n,!1),this._scene.proceduralTextures.splice(this._scene.proceduralTextures.indexOf(this._voxelGridRT),1),this._voxelGridRT.setFloat("layer",0),this._voxelGridRT.setTexture("voxelXaxisSampler",this._voxelGridXaxis),this._voxelGridRT.setTexture("voxelYaxisSampler",this._voxelGridYaxis),this._voxelGridRT.setTexture("voxelZaxisSampler",this._voxelGridZaxis),this._voxelGridRT.autoClear=!1,this._voxelGridRT.wrapU=H.CLAMP_ADDRESSMODE,this._voxelGridRT.wrapV=H.CLAMP_ADDRESSMODE):(this._voxelGridZaxis=new Gt("voxelGridZaxis",t,this._scene,n),this._voxelMrtsZaxis=this._createVoxelMRTs("z_axis_",this._voxelGridZaxis,r));let a={generateDepthBuffer:!1,generateMipMaps:!1,type:0,format:6,samplingMode:1,shaderLanguage:e?1:0,extraInitializationsAsync:async()=>{e?await Promise.resolve().then(()=>(AY(),xY)):await Promise.resolve().then(()=>(CY(),bY))}};this._mipArray=new Array(Math.ceil(Math.log2(this._voxelResolution)));for(let o=1;o<=this._mipArray.length;o++){let l=this._voxelResolution>>o,c={width:l,height:l,depth:l};this._mipArray[o-1]=new ci("voxelMip"+o,c,"iblGenerateVoxelMip",this._scene,a,!1),this._scene.proceduralTextures.splice(this._scene.proceduralTextures.indexOf(this._mipArray[o-1]),1);let f=this._mipArray[o-1];f.autoClear=!1,f.wrapU=H.CLAMP_ADDRESSMODE,f.wrapV=H.CLAMP_ADDRESSMODE,f.setTexture("srcMip",o>1?this._mipArray[o-2]:this.getVoxelGrid()),f.setInt("layerNum",0)}this._createVoxelMaterials()}_createVoxelMRTs(e,t,i){t.wrapU=H.CLAMP_ADDRESSMODE,t.wrapV=H.CLAMP_ADDRESSMODE,t.noPrePassRenderer=!0;let r=[],n=new Array(this._maxDrawBuffers).fill(this._isVoxelGrid3D?32879:35866);for(let a=0;a<i;a++){let o=new Array(this._maxDrawBuffers).fill(0);o=o.map((f,h)=>a*this._maxDrawBuffers+h);let l=new Array(this._maxDrawBuffers).fill("");l=l.map((f,h)=>"voxel_grid_"+e+(a*this._maxDrawBuffers+h));let c=new fh("mrt_"+e+a,{width:this._voxelResolution,height:this._voxelResolution,depth:this._isVoxelGrid3D?this._voxelResolution:void 0},this._maxDrawBuffers,this._scene,{types:new Array(this._maxDrawBuffers).fill(0),samplingModes:new Array(this._maxDrawBuffers).fill(3),generateMipMaps:!1,targetTypes:n,formats:new Array(this._maxDrawBuffers).fill(6),faceIndex:new Array(this._maxDrawBuffers).fill(0),layerIndex:o,layerCounts:new Array(this._maxDrawBuffers).fill(this._voxelResolution),generateDepthBuffer:!1,generateStencilBuffer:!1},l);c.clearColor=new me(0,0,0,1),c.noPrePassRenderer=!0;for(let f=0;f<this._maxDrawBuffers;f++)c.setInternalTexture(t.getInternalTexture(),f);r.push(c)}return r}_disposeVoxelTextures(){this._stopVoxelization();for(let e=0;e<this._voxelMrtsZaxis.length;e++)this._triPlanarVoxelization&&(this._voxelMrtsXaxis[e].dispose(!0),this._voxelMrtsYaxis[e].dispose(!0)),this._voxelMrtsZaxis[e].dispose(!0);this._triPlanarVoxelization&&(this._voxelGridXaxis?.dispose(),this._voxelGridYaxis?.dispose(),this._voxelGridRT?.dispose()),this._voxelGridZaxis?.dispose();for(let e of this._mipArray)e.dispose();this._voxelMaterial?.dispose(),this._voxelSlabDebugMaterial?.dispose(),this._mipArray=[],this._voxelMrtsXaxis=[],this._voxelMrtsYaxis=[],this._voxelMrtsZaxis=[]}_createVoxelMaterials(){let e=this._engine.isWebGPU;this._voxelMaterial=new na("voxelization",this._scene,"iblVoxelGrid",{uniforms:["world","viewMatrix","invWorldScale","nearPlane","farPlane","stepSize"],defines:["MAX_DRAW_BUFFERS "+this._maxDrawBuffers],shaderLanguage:e?1:0,extraInitializationsAsync:async()=>{e?await Promise.all([Promise.resolve().then(()=>(MY(),yY)),Promise.resolve().then(()=>(OY(),DY))]):await Promise.all([Promise.resolve().then(()=>(FY(),wY)),Promise.resolve().then(()=>(UY(),BY))])}}),this._voxelMaterial.cullBackFaces=!1,this._voxelMaterial.backFaceCulling=!1,this._voxelMaterial.depthFunction=ee.ALWAYS,this._voxelSlabDebugMaterial=new na("voxelSlabDebug",this._scene,"iblVoxelSlabDebug",{uniforms:["world","viewMatrix","cameraViewMatrix","projection","invWorldScale","nearPlane","farPlane","stepSize"],defines:["MAX_DRAW_BUFFERS "+this._maxDrawBuffers],shaderLanguage:e?1:0,extraInitializationsAsync:async()=>{e?await Promise.all([Promise.resolve().then(()=>(kY(),VY)),Promise.resolve().then(()=>(zY(),HY))]):await Promise.all([Promise.resolve().then(()=>(KY(),YY)),Promise.resolve().then(()=>(jY(),QY))])}})}_setDebugBindings(){this._voxelSlabDebugMaterial.setMatrix("projection",this._scene.activeCamera.getProjectionMatrix()),this._voxelSlabDebugMaterial.setMatrix("cameraViewMatrix",this._scene.activeCamera.getViewMatrix())}isReady(){let e=this.getVoxelGrid().isReady();for(let t=0;t<this._mipArray.length;t++){let i=this._mipArray[t].isReady();e&&(e=i)}return!(!e||this._voxelizationInProgress)}_stopVoxelization(){this._removeVoxelRTs(this._voxelMrtsXaxis),this._removeVoxelRTs(this._voxelMrtsYaxis),this._removeVoxelRTs(this._voxelMrtsZaxis)}_removeVoxelRTs(e){let t=this._renderTargets.findIndex(i=>i===e[0]);if(t>=0)this._renderTargets.splice(t,e.length);else{let i=this._scene.customRenderTargets.findIndex(r=>r===e[0]);i>=0&&this._scene.customRenderTargets.splice(i,e.length)}}updateVoxelGrid(e){this._stopVoxelization(),this._includedMeshes=e,this._voxelizationInProgress=!0,this._triPlanarVoxelization?(this._addRTsForRender(this._voxelMrtsXaxis,e,0),this._addRTsForRender(this._voxelMrtsYaxis,e,1),this._addRTsForRender(this._voxelMrtsZaxis,e,2)):this._addRTsForRender(this._voxelMrtsZaxis,e,2),this._voxelDebugEnabled&&this._addRTsForRender([this._voxelSlabDebugRT],e,this._voxelDebugAxis,1,!0),this._renderVoxelGridBound=this._renderVoxelGrid.bind(this),this._scene.onAfterRenderObservable.add(this._renderVoxelGridBound)}_renderVoxelGrid(){if(this._voxelizationInProgress){let e=this.getVoxelGrid().isReady();for(let t=0;t<this._mipArray.length;t++){let i=this._mipArray[t].isReady();e&&(e=i)}for(let t=0;t<this._renderTargets.length;t++){let i=this._renderTargets[t].isReadyForRendering();e&&(e=i)}if(e){for(let t of this._renderTargets)t.render();this._stopVoxelization(),this._triPlanarVoxelization&&this._voxelGridRT.render(),this._generateMipMaps(),this._copyMipEffectWrapper.effect.whenCompiledAsync().then(()=>{this._copyMipMaps(),this._scene.onAfterRenderObservable.removeCallback(this._renderVoxelGridBound),this._voxelizationInProgress=!1,this.onVoxelizationCompleteObservable.notifyObservers()})}}}_addRTsForRender(e,t,i,r=0,n=!1){let a=1/this._computeNumberOfSlabs(),o;r===0?o=this._voxelMaterial:o=this._voxelSlabDebugMaterial;for(let l=0;l<e.length;l++){let c=e[l];c.renderList=[];let f=l*a,h=(l+1)*a,u=a/this._maxDrawBuffers,d=new E(0,0,0),p=new E(0,0,1);i===0?p=new E(1,0,0):i===1&&(p=new E(0,1,0));let m=new E(0,1,0);if(i===1&&(m=new E(1,0,0)),c.onBeforeRenderObservable.add(()=>{o.setMatrix("viewMatrix",B.LookAtLH(d,p,m)),o.setMatrix("invWorldScale",this._invWorldScaleMatrix),o.setFloat("nearPlane",f),o.setFloat("farPlane",h),o.setFloat("stepSize",u)}),t.length===0)return;for(let _ of t)if(_){_.subMeshes&&_.subMeshes.length>0&&(c.renderList?.push(_),c.setMaterialForRendering(_,o));let v=_.getChildMeshes();for(let T of v)T.subMeshes&&T.subMeshes.length>0&&(c.renderList?.push(T),c.setMaterialForRendering(T,o))}}if(n)for(let l of e)this._scene.customRenderTargets.indexOf(l)===-1&&this._scene.customRenderTargets.push(l);else this._renderTargets=this._renderTargets.concat(e)}resize(){this._voxelSlabDebugRT?.resize({width:this._scene.getEngine().getRenderWidth(),height:this._scene.getEngine().getRenderHeight()})}dispose(){this._disposeVoxelTextures(),this._voxelSlabDebugRT&&(this._removeVoxelRTs([this._voxelSlabDebugRT]),this._voxelSlabDebugRT.dispose()),this._voxelDebugPass&&this._voxelDebugPass.dispose()}}});var JY,dre,$Y=S(()=>{O();JY="mrtFragmentDeclaration",dre=`#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
layout(location=0) out vec4 glFragData[{X}];
#endif
`;g.IncludesShadersStore[JY]||(g.IncludesShadersStore[JY]=dre)});var t8={};V(t8,{geometryPixelShader:()=>pre});var oP,e8,pre,lP=S(()=>{O();Da();$Y();X_();Y_();Di();Oa();K_();oP="geometryPixelShader",e8=`#extension GL_EXT_draw_buffers : require
#if defined(BUMP) || !defined(NORMAL)
#extension GL_OES_standard_derivatives : enable
#endif
precision highp float;
#ifdef BUMP
varying mat4 vWorldView;varying vec3 vNormalW;
#else
varying vec3 vNormalV;
#endif
varying vec4 vViewPos;
#if defined(POSITION) || defined(BUMP)
varying vec3 vPositionW;
#endif
#if defined(VELOCITY) || defined(VELOCITY_LINEAR)
varying vec4 vCurrentPosition;varying vec4 vPreviousPosition;
#endif
#ifdef NEED_UV
varying vec2 vUV;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;uniform vec2 vTangentSpaceParams;
#endif
#if defined(REFLECTIVITY)
#if defined(ORMTEXTURE) || defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)
uniform sampler2D reflectivitySampler;varying vec2 vReflectivityUV;
#endif
#ifdef ALBEDOTEXTURE
varying vec2 vAlbedoUV;uniform sampler2D albedoSampler;
#endif
#ifdef REFLECTIVITYCOLOR
uniform vec3 reflectivityColor;
#endif
#ifdef ALBEDOCOLOR
uniform vec3 albedoColor;
#endif
#ifdef METALLIC
uniform float metallic;
#endif
#if defined(ROUGHNESS) || defined(GLOSSINESS)
uniform float glossiness;
#endif
#endif
#if defined(ALPHATEST) && defined(NEED_UV)
uniform sampler2D diffuseSampler;
#endif
#include<clipPlaneFragmentDeclaration>
#include<mrtFragmentDeclaration>[SCENE_MRT_COUNT]
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#include<helperFunctions>
void main() {
#include<clipPlaneFragment>
#ifdef ALPHATEST
if (texture2D(diffuseSampler,vUV).a<0.4)
discard;
#endif
vec3 normalOutput;
#ifdef BUMP
vec3 normalW=normalize(vNormalW);
#include<bumpFragment>
#ifdef NORMAL_WORLDSPACE
normalOutput=normalW;
#else
normalOutput=normalize(vec3(vWorldView*vec4(normalW,0.0)));
#endif
#else
normalOutput=normalize(vNormalV);
#endif
#ifdef ENCODE_NORMAL
normalOutput=normalOutput*0.5+0.5;
#endif
#ifdef DEPTH
gl_FragData[DEPTH_INDEX]=vec4(vViewPos.z/vViewPos.w,0.0,0.0,1.0);
#endif
#ifdef NORMAL
gl_FragData[NORMAL_INDEX]=vec4(normalOutput,1.0);
#endif
#ifdef SCREENSPACE_DEPTH
gl_FragData[SCREENSPACE_DEPTH_INDEX]=vec4(gl_FragCoord.z,0.0,0.0,1.0);
#endif
#ifdef POSITION
gl_FragData[POSITION_INDEX]=vec4(vPositionW,1.0);
#endif
#ifdef VELOCITY
vec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;vec2 velocity=abs(a-b);velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;gl_FragData[VELOCITY_INDEX]=vec4(velocity,0.0,1.0);
#endif
#ifdef VELOCITY_LINEAR
vec2 velocity=vec2(0.5)*((vPreviousPosition.xy/vPreviousPosition.w) -
(vCurrentPosition.xy/vCurrentPosition.w));gl_FragData[VELOCITY_LINEAR_INDEX]=vec4(velocity,0.0,1.0);
#endif
#ifdef REFLECTIVITY
vec4 reflectivity=vec4(0.0,0.0,0.0,1.0);
#ifdef METALLICWORKFLOW
float metal=1.0;float roughness=1.0;
#ifdef ORMTEXTURE
metal*=texture2D(reflectivitySampler,vReflectivityUV).b;roughness*=texture2D(reflectivitySampler,vReflectivityUV).g;
#endif
#ifdef METALLIC
metal*=metallic;
#endif
#ifdef ROUGHNESS
roughness*=(1.0-glossiness); 
#endif
reflectivity.a-=roughness;vec3 color=vec3(1.0);
#ifdef ALBEDOTEXTURE
color=texture2D(albedoSampler,vAlbedoUV).rgb;
#ifdef GAMMAALBEDO
color=toLinearSpace(color);
#endif
#endif
#ifdef ALBEDOCOLOR
color*=albedoColor.xyz;
#endif
reflectivity.rgb=mix(vec3(0.04),color,metal);
#else
#if defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)
reflectivity=texture2D(reflectivitySampler,vReflectivityUV);
#ifdef GAMMAREFLECTIVITYTEXTURE
reflectivity.rgb=toLinearSpace(reflectivity.rgb);
#endif
#else 
#ifdef REFLECTIVITYCOLOR
reflectivity.rgb=toLinearSpace(reflectivityColor.xyz);reflectivity.a=1.0;
#endif
#endif
#ifdef GLOSSINESSS
reflectivity.a*=glossiness; 
#endif
#endif
gl_FragData[REFLECTIVITY_INDEX]=reflectivity;
#endif
}
`;g.ShadersStore[oP]||(g.ShadersStore[oP]=e8);pre={name:oP,shader:e8}});var i8,mre,r8=S(()=>{O();i8="geometryVertexDeclaration",mre="uniform mat4 viewProjection;uniform mat4 view;";g.IncludesShadersStore[i8]||(g.IncludesShadersStore[i8]=mre)});var s8,_re,n8=S(()=>{O();Ml();s8="geometryUboDeclaration",_re=`#include<sceneUboDeclaration>
`;g.IncludesShadersStore[s8]||(g.IncludesShadersStore[s8]=_re)});var o8={};V(o8,{geometryVertexShader:()=>gre});var cP,a8,gre,fP=S(()=>{O();La();wa();Bo();Uo();ko();r8();n8();Fa();Go();Vo();Na();Ba();Ua();Ga();H_();cP="geometryVertexShader",a8=`precision highp float;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<instancesDeclaration>
#include<__decl__geometryVertex>
#include<clipPlaneVertexDeclaration>
attribute vec3 position;attribute vec3 normal;
#ifdef NEED_UV
varying vec2 vUV;
#ifdef ALPHATEST
uniform mat4 diffuseMatrix;
#endif
#ifdef BUMP
uniform mat4 bumpMatrix;varying vec2 vBumpUV;
#endif
#ifdef REFLECTIVITY
uniform mat4 reflectivityMatrix;uniform mat4 albedoMatrix;varying vec2 vReflectivityUV;varying vec2 vAlbedoUV;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#ifdef BUMP
varying mat4 vWorldView;
#endif
#ifdef BUMP
varying vec3 vNormalW;
#else
varying vec3 vNormalV;
#endif
varying vec4 vViewPos;
#if defined(POSITION) || defined(BUMP)
varying vec3 vPositionW;
#endif
#if defined(VELOCITY) || defined(VELOCITY_LINEAR)
uniform mat4 previousViewProjection;varying vec4 vCurrentPosition;varying vec4 vPreviousPosition;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{vec3 positionUpdated=position;vec3 normalUpdated=normal;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#ifdef UV2
vec2 uv2Updated=uv2;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#if (defined(VELOCITY) || defined(VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=vec4(finalWorld*vec4(positionUpdated,1.0));
#ifdef BUMP
vWorldView=view*finalWorld;mat3 normalWorld=mat3(finalWorld);vNormalW=normalize(normalWorld*normalUpdated);
#else
#ifdef NORMAL_WORLDSPACE
vNormalV=normalize(vec3(finalWorld*vec4(normalUpdated,0.0)));
#else
vNormalV=normalize(vec3((view*finalWorld)*vec4(normalUpdated,0.0)));
#endif
#endif
vViewPos=view*worldPos;
#if (defined(VELOCITY) || defined(VELOCITY_LINEAR)) && defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);
#if NUM_BONE_INFLUENCERS>0
mat4 previousInfluence;previousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
previousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
previousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
previousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif
vPreviousPosition=previousViewProjection*finalPreviousWorld*previousInfluence*vec4(positionUpdated,1.0);
#else
vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#endif
#if defined(POSITION) || defined(BUMP)
vPositionW=worldPos.xyz/worldPos.w;
#endif
gl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);
#include<clipPlaneVertex>
#ifdef NEED_UV
#ifdef UV1
#if defined(ALPHATEST) && defined(ALPHATEST_UV1)
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#else
vUV=uvUpdated;
#endif
#ifdef BUMP_UV1
vBumpUV=vec2(bumpMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef REFLECTIVITY_UV1
vReflectivityUV=vec2(reflectivityMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef ALBEDO_UV1
vAlbedoUV=vec2(albedoMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#endif
#ifdef UV2
#if defined(ALPHATEST) && defined(ALPHATEST_UV2)
vUV=vec2(diffuseMatrix*vec4(uv2Updated,1.0,0.0));
#else
vUV=uv2Updated;
#endif
#ifdef BUMP_UV2
vBumpUV=vec2(bumpMatrix*vec4(uv2Updated,1.0,0.0));
#endif
#ifdef REFLECTIVITY_UV2
vReflectivityUV=vec2(reflectivityMatrix*vec4(uv2Updated,1.0,0.0));
#endif
#ifdef ALBEDO_UV2
vAlbedoUV=vec2(albedoMatrix*vec4(uv2Updated,1.0,0.0));
#endif
#endif
#endif
#include<bumpVertex>
}
`;g.ShadersStore[cP]||(g.ShadersStore[cP]=a8);gre={name:cP,shader:a8}});var c8={};V(c8,{geometryVertexShaderWGSL:()=>vre});var hP,l8,vre,f8=S(()=>{O();Ia();Bn();Oo();Lo();Va();wo();ya();Fo();No();Un();Ma();Gn();Pa();B_();hP="geometryVertexShader",l8=`#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<instancesDeclaration>
#include<sceneUboDeclaration>
#include<clipPlaneVertexDeclaration>
attribute position: vec3f;attribute normal: vec3f;
#ifdef NEED_UV
varying vUV: vec2f;
#ifdef ALPHATEST
uniform diffuseMatrix: mat4x4f;
#endif
#ifdef BUMP
uniform bumpMatrix: mat4x4f;varying vBumpUV: vec2f;
#endif
#ifdef REFLECTIVITY
uniform reflectivityMatrix: mat4x4f;uniform albedoMatrix: mat4x4f;varying vReflectivityUV: vec2f;varying vAlbedoUV: vec2f;
#endif
#ifdef UV1
attribute uv: vec2f;
#endif
#ifdef UV2
attribute uv2: vec2f;
#endif
#endif
#ifdef BUMP
varying vWorldView0: vec4f;varying vWorldView1: vec4f;varying vWorldView2: vec4f;varying vWorldView3: vec4f;
#endif
#ifdef BUMP
varying vNormalW: vec3f;
#else
varying vNormalV: vec3f;
#endif
varying vViewPos: vec4f;
#if defined(POSITION) || defined(BUMP)
varying vPositionW: vec3f;
#endif
#if defined(VELOCITY) || defined(VELOCITY_LINEAR)
uniform previousViewProjection: mat4x4f;varying vCurrentPosition: vec4f;varying vPreviousPosition: vec4f;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {var positionUpdated: vec3f=input.position;var normalUpdated: vec3f=input.normal;
#ifdef UV1
var uvUpdated: vec2f=input.uv;
#endif
#ifdef UV2
var uv2Updated: vec2f=input.uv2;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#if (defined(VELOCITY) || defined(VELOCITY_LINEAR)) && !defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=scene.viewProjection*finalWorld*vec4f(positionUpdated,1.0);vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld* vec4f(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
var worldPos: vec4f= vec4f(finalWorld* vec4f(positionUpdated,1.0));
#ifdef BUMP
let vWorldView=scene.view*finalWorld;vertexOutputs.vWorldView0=vWorldView[0];vertexOutputs.vWorldView1=vWorldView[1];vertexOutputs.vWorldView2=vWorldView[2];vertexOutputs.vWorldView3=vWorldView[3];let normalWorld: mat3x3f= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);vertexOutputs.vNormalW=normalize(normalWorld*normalUpdated);
#else
#ifdef NORMAL_WORLDSPACE
vertexOutputs.vNormalV=normalize((finalWorld* vec4f(normalUpdated,0.0)).xyz);
#else
vertexOutputs.vNormalV=normalize(((scene.view*finalWorld)* vec4f(normalUpdated,0.0)).xyz);
#endif
#endif
vertexOutputs.vViewPos=scene.view*worldPos;
#if (defined(VELOCITY) || defined(VELOCITY_LINEAR)) && defined(BONES_VELOCITY_ENABLED)
vertexOutputs.vCurrentPosition=scene.viewProjection*finalWorld* vec4f(positionUpdated,1.0);
#if NUM_BONE_INFLUENCERS>0
var previousInfluence: mat4x4f;previousInfluence=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndices[0])]*vertexInputs.matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
previousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndices[1])]*vertexInputs.matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
previousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndices[2])]*vertexInputs.matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
previousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndices[3])]*vertexInputs.matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
previousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndicesExtra[0])]*vertexInputs.matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
previousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndicesExtra[1])]*vertexInputs.matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
previousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndicesExtra[2])]*vertexInputs.matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
previousInfluence+=uniforms.mPreviousBones[ i32(vertexInputs.matricesIndicesExtra[3])]*vertexInputs.matricesWeightsExtra[3];
#endif
vertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld*previousInfluence* vec4f(positionUpdated,1.0);
#else
vertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld* vec4f(positionUpdated,1.0);
#endif
#endif
#if defined(POSITION) || defined(BUMP)
vertexOutputs.vPositionW=worldPos.xyz/worldPos.w;
#endif
vertexOutputs.position=scene.viewProjection*finalWorld* vec4f(positionUpdated,1.0);
#include<clipPlaneVertex>
#ifdef NEED_UV
#ifdef UV1
#if defined(ALPHATEST) && defined(ALPHATEST_UV1)
vertexOutputs.vUV=(uniforms.diffuseMatrix* vec4f(uvUpdated,1.0,0.0)).xy;
#else
vertexOutputs.vUV=uvUpdated;
#endif
#ifdef BUMP_UV1
vertexOutputs.vBumpUV=(uniforms.bumpMatrix* vec4f(uvUpdated,1.0,0.0)).xy;
#endif
#ifdef REFLECTIVITY_UV1
vertexOutputs.vReflectivityUV=(uniforms.reflectivityMatrix* vec4f(uvUpdated,1.0,0.0)).xy;
#endif
#ifdef ALBEDO_UV1
vertexOutputs.vAlbedoUV=(uniforms.albedoMatrix* vec4f(uvUpdated,1.0,0.0)).xy;
#endif
#endif
#ifdef UV2
#if defined(ALPHATEST) && defined(ALPHATEST_UV2)
vertexOutputs.vUV=(uniforms.diffuseMatrix* vec4f(uv2Updated,1.0,0.0)).xy;
#else
vertexOutputs.vUV=uv2Updated;
#endif
#ifdef BUMP_UV2
vertexOutputs.vBumpUV=(uniforms.bumpMatrix* vec4f(uv2Updated,1.0,0.0)).xy;
#endif
#ifdef REFLECTIVITY_UV2
vertexOutputs.vReflectivityUV=(uniforms.reflectivityMatrix* vec4f(uv2Updated,1.0,0.0)).xy;
#endif
#ifdef ALBEDO_UV2
vertexOutputs.vAlbedoUV=(uniforms.albedoMatrix* vec4f(uv2Updated,1.0,0.0)).xy;
#endif
#endif
#endif
#include<bumpVertex>
}
`;g.ShadersStoreWGSL[hP]||(g.ShadersStoreWGSL[hP]=l8);vre={name:hP,shader:l8}});var u8={};V(u8,{geometryPixelShaderWGSL:()=>Sre});var uP,h8,Sre,d8=S(()=>{O();ba();G_();V_();Pi();Ca();W_();uP="geometryPixelShader",h8=`#ifdef BUMP
varying vWorldView0: vec4f;varying vWorldView1: vec4f;varying vWorldView2: vec4f;varying vWorldView3: vec4f;varying vNormalW: vec3f;
#else
varying vNormalV: vec3f;
#endif
varying vViewPos: vec4f;
#if defined(POSITION) || defined(BUMP)
varying vPositionW: vec3f;
#endif
#if defined(VELOCITY) || defined(VELOCITY_LINEAR)
varying vCurrentPosition: vec4f;varying vPreviousPosition: vec4f;
#endif
#ifdef NEED_UV
varying vUV: vec2f;
#endif
#ifdef BUMP
uniform vBumpInfos: vec3f;uniform vTangentSpaceParams: vec2f;
#endif
#if defined(REFLECTIVITY)
#if defined(ORMTEXTURE) || defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)
var reflectivitySamplerSampler: sampler;var reflectivitySampler: texture_2d<f32>;varying vReflectivityUV: vec2f;
#endif
#ifdef ALBEDOTEXTURE
varying vAlbedoUV: vec2f;var albedoSamplerSampler: sampler;var albedoSampler: texture_2d<f32>;
#endif
#ifdef REFLECTIVITYCOLOR
uniform reflectivityColor: vec3f;
#endif
#ifdef ALBEDOCOLOR
uniform albedoColor: vec3f;
#endif
#ifdef METALLIC
uniform metallic: f32;
#endif
#if defined(ROUGHNESS) || defined(GLOSSINESS)
uniform glossiness: f32;
#endif
#endif
#if defined(ALPHATEST) && defined(NEED_UV)
var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;
#endif
#include<clipPlaneFragmentDeclaration>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#include<helperFunctions>
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#include<clipPlaneFragment>
#ifdef ALPHATEST
if (textureSample(diffuseSampler,diffuseSamplerSampler,input.vUV).a<0.4) {discard;}
#endif
var normalOutput: vec3f;
#ifdef BUMP
var normalW: vec3f=normalize(input.vNormalW);
#include<bumpFragment>
#ifdef NORMAL_WORLDSPACE
normalOutput=normalW;
#else
normalOutput=normalize( (mat4x4f(input.vWorldView0,input.vWorldView1,input.vWorldView2,input.vWorldView3)* vec4f(normalW,0.0)).xyz);
#endif
#else
normalOutput=normalize(input.vNormalV);
#endif
#ifdef ENCODE_NORMAL
normalOutput=normalOutput*0.5+0.5;
#endif
var fragData: array<vec4<f32>,SCENE_MRT_COUNT>;
#ifdef DEPTH
fragData[DEPTH_INDEX]=vec4f(input.vViewPos.z/input.vViewPos.w,0.0,0.0,1.0);
#endif
#ifdef NORMAL
fragData[NORMAL_INDEX]=vec4f(normalOutput,1.0);
#endif
#ifdef SCREENSPACE_DEPTH
fragData[SCREENSPACE_DEPTH_INDEX]=vec4f(fragmentInputs.position.z,0.0,0.0,1.0);
#endif
#ifdef POSITION
fragData[POSITION_INDEX]= vec4f(input.vPositionW,1.0);
#endif
#ifdef VELOCITY
var a: vec2f=(input.vCurrentPosition.xy/input.vCurrentPosition.w)*0.5+0.5;var b: vec2f=(input.vPreviousPosition.xy/input.vPreviousPosition.w)*0.5+0.5;var velocity: vec2f=abs(a-b);velocity= vec2f(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;fragData[VELOCITY_INDEX]= vec4f(velocity,0.0,1.0);
#endif
#ifdef VELOCITY_LINEAR
var velocity : vec2f=vec2f(0.5)*((input.vPreviousPosition.xy /
input.vPreviousPosition.w) -
(input.vCurrentPosition.xy /
input.vCurrentPosition.w));fragData[VELOCITY_LINEAR_INDEX]=vec4f(velocity,0.0,1.0);
#endif
#ifdef REFLECTIVITY
var reflectivity: vec4f= vec4f(0.0,0.0,0.0,1.0);
#ifdef METALLICWORKFLOW
var metal: f32=1.0;var roughness: f32=1.0;
#ifdef ORMTEXTURE
metal*=textureSample(reflectivitySampler,reflectivitySamplerSampler,input.vReflectivityUV).b;roughness*=textureSample(reflectivitySampler,reflectivitySamplerSampler,input.vReflectivityUV).g;
#endif
#ifdef METALLIC
metal*=uniforms.metallic;
#endif
#ifdef ROUGHNESS
roughness*=(1.0-uniforms.glossiness); 
#endif
reflectivity=vec4f(reflectivity.rgb,reflectivity.a-roughness);var color: vec3f= vec3f(1.0);
#ifdef ALBEDOTEXTURE
color=textureSample(albedoSampler,albedoSamplerSampler,input.vAlbedoUV).rgb;
#ifdef GAMMAALBEDO
color=toLinearSpaceVec4(color);
#endif
#endif
#ifdef ALBEDOCOLOR
color*=uniforms.albedoColor.xyz;
#endif
reflectivity=vec4f(mix( vec3f(0.04),color,metal),reflectivity.a);
#else
#if defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)
reflectivity=textureSample(reflectivitySampler,reflectivitySamplerSampler,input.vReflectivityUV);
#ifdef GAMMAREFLECTIVITYTEXTURE
reflectivity=vec4f(toLinearSpaceVec3(reflectivity.rgb),reflectivity.a);
#endif
#else 
#ifdef REFLECTIVITYCOLOR
reflectivity=vec4f(toLinearSpaceVec3(uniforms.reflectivityColor.xyz),1.0);
#endif
#endif
#ifdef GLOSSINESSS
reflectivity=vec4f(reflectivity.rgb,reflectivity.a*glossiness); 
#endif
#endif
fragData[REFLECTIVITY_INDEX]=reflectivity;
#endif
#if SCENE_MRT_COUNT>0
fragmentOutputs.fragData0=fragData[0];
#endif
#if SCENE_MRT_COUNT>1
fragmentOutputs.fragData1=fragData[1];
#endif
#if SCENE_MRT_COUNT>2
fragmentOutputs.fragData2=fragData[2];
#endif
#if SCENE_MRT_COUNT>3
fragmentOutputs.fragData3=fragData[3];
#endif
#if SCENE_MRT_COUNT>4
fragmentOutputs.fragData4=fragData[4];
#endif
#if SCENE_MRT_COUNT>5
fragmentOutputs.fragData5=fragData[5];
#endif
#if SCENE_MRT_COUNT>6
fragmentOutputs.fragData6=fragData[6];
#endif
#if SCENE_MRT_COUNT>7
fragmentOutputs.fragData7=fragData[7];
#endif
}
`;g.ShadersStoreWGSL[uP]||(g.ShadersStoreWGSL[uP]=h8);Sre={name:uP,shader:h8}});var p8,Ot,hh=S(()=>{ie();yt();Ut();WM();it();Ii();cs();lP();fP();fn();rn();Xi();Tx();p8=["world","mBones","viewProjection","diffuseMatrix","view","previousWorld","previousViewProjection","mPreviousBones","bumpMatrix","reflectivityMatrix","albedoMatrix","reflectivityColor","albedoColor","metallic","glossiness","vTangentSpaceParams","vBumpInfos","morphTargetInfluences","morphTargetCount","morphTargetTextureInfo","morphTargetTextureIndices","boneTextureWidth"];Hi(p8);Ot=class s{get normalsAreUnsigned(){return this._normalsAreUnsigned}_linkPrePassRenderer(e){this._linkedWithPrePass=!0,this._prePassRenderer=e,this._multiRenderTarget&&(this._multiRenderTarget.onClearObservable.clear(),this._multiRenderTarget.onClearObservable.add(()=>{}))}_unlinkPrePassRenderer(){this._linkedWithPrePass=!1,this._createRenderTargets()}_resetLayout(){this._enableDepth=!0,this._enableNormal=!0,this._enablePosition=!1,this._enableReflectivity=!1,this._enableVelocity=!1,this._enableVelocityLinear=!1,this._enableScreenspaceDepth=!1,this._attachmentsFromPrePass=[]}_forceTextureType(e,t){e===s.POSITION_TEXTURE_TYPE?(this._positionIndex=t,this._enablePosition=!0):e===s.VELOCITY_TEXTURE_TYPE?(this._velocityIndex=t,this._enableVelocity=!0):e===s.VELOCITY_LINEAR_TEXTURE_TYPE?(this._velocityLinearIndex=t,this._enableVelocityLinear=!0):e===s.REFLECTIVITY_TEXTURE_TYPE?(this._reflectivityIndex=t,this._enableReflectivity=!0):e===s.DEPTH_TEXTURE_TYPE?(this._depthIndex=t,this._enableDepth=!0):e===s.NORMAL_TEXTURE_TYPE?(this._normalIndex=t,this._enableNormal=!0):e===s.SCREENSPACE_DEPTH_TEXTURE_TYPE&&(this._screenspaceDepthIndex=t,this._enableScreenspaceDepth=!0)}_setAttachments(e){this._attachmentsFromPrePass=e}_linkInternalTexture(e){this._multiRenderTarget.setInternalTexture(e,0,!1)}get renderList(){return this._multiRenderTarget.renderList}set renderList(e){this._multiRenderTarget.renderList=e}get isSupported(){return this._multiRenderTarget.isSupported}getTextureIndex(e){switch(e){case s.POSITION_TEXTURE_TYPE:return this._positionIndex;case s.VELOCITY_TEXTURE_TYPE:return this._velocityIndex;case s.VELOCITY_LINEAR_TEXTURE_TYPE:return this._velocityLinearIndex;case s.REFLECTIVITY_TEXTURE_TYPE:return this._reflectivityIndex;case s.DEPTH_TEXTURE_TYPE:return this._depthIndex;case s.NORMAL_TEXTURE_TYPE:return this._normalIndex;case s.SCREENSPACE_DEPTH_TEXTURE_TYPE:return this._screenspaceDepthIndex;default:return-1}}get enableDepth(){return this._enableDepth}set enableDepth(e){this._enableDepth=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enableNormal(){return this._enableNormal}set enableNormal(e){this._enableNormal=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enablePosition(){return this._enablePosition}set enablePosition(e){this._enablePosition=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enableVelocity(){return this._enableVelocity}set enableVelocity(e){this._enableVelocity=e,e||(this._previousTransformationMatrices={}),this._linkedWithPrePass||(this.dispose(),this._createRenderTargets()),this._scene.needsPreviousWorldMatrices=e}get enableVelocityLinear(){return this._enableVelocityLinear}set enableVelocityLinear(e){this._enableVelocityLinear=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enableReflectivity(){return this._enableReflectivity}set enableReflectivity(e){this._enableReflectivity=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enableScreenspaceDepth(){return this._enableScreenspaceDepth}set enableScreenspaceDepth(e){this._enableScreenspaceDepth=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get scene(){return this._scene}get ratio(){return typeof this._ratioOrDimensions=="object"?1:this._ratioOrDimensions}get shaderLanguage(){return this._shaderLanguage}constructor(e,t=1,i=15,r){this._previousTransformationMatrices={},this._previousBonesTransformationMatrices={},this.excludedSkinnedMeshesFromVelocity=[],this.renderTransparentMeshes=!0,this.generateNormalsInWorldSpace=!1,this._normalsAreUnsigned=!1,this._resizeObserver=null,this._enableDepth=!0,this._enableNormal=!0,this._enablePosition=!1,this._enableVelocity=!1,this._enableVelocityLinear=!1,this._enableReflectivity=!1,this._enableScreenspaceDepth=!1,this._clearColor=new me(0,0,0,0),this._clearDepthColor=new me(0,0,0,1),this._positionIndex=-1,this._velocityIndex=-1,this._velocityLinearIndex=-1,this._reflectivityIndex=-1,this._depthIndex=-1,this._normalIndex=-1,this._screenspaceDepthIndex=-1,this._linkedWithPrePass=!1,this.useSpecificClearForDepthTexture=!1,this._shaderLanguage=0,this._shadersLoaded=!1,this._scene=e,this._ratioOrDimensions=t,this._useUbo=e.getEngine().supportsUniformBuffers,this._depthFormat=i,this._textureTypesAndFormats=r||{},this._initShaderSourceAsync(),s._SceneComponentInitialization(this._scene),this._createRenderTargets()}async _initShaderSourceAsync(){this._scene.getEngine().isWebGPU&&!s.ForceGLSL?(this._shaderLanguage=1,await Promise.all([Promise.resolve().then(()=>(f8(),c8)),Promise.resolve().then(()=>(d8(),u8))])):await Promise.all([Promise.resolve().then(()=>(fP(),o8)),Promise.resolve().then(()=>(lP(),t8))]),this._shadersLoaded=!0}isReady(e,t){if(!this._shadersLoaded)return!1;let i=e.getMaterial();if(i&&i.disableDepthWrite)return!1;let r=[],n=[A.PositionKind,A.NormalKind],a=e.getMesh(),o=!1,l=!1,c=!1;if(i){let m=!1;if(i.needAlphaTestingForMesh(a)&&i.getAlphaTestTexture()&&(r.push("#define ALPHATEST"),r.push(`#define ALPHATEST_UV${i.getAlphaTestTexture().coordinatesIndex+1}`),m=!0),(i.bumpTexture||i.normalTexture)&&X.BumpTextureEnabled){let _=i.bumpTexture||i.normalTexture;r.push("#define BUMP"),r.push(`#define BUMP_UV${_.coordinatesIndex+1}`),m=!0}if(this._enableReflectivity){let _=!1;i.getClassName()==="PBRMetallicRoughnessMaterial"?(i.metallicRoughnessTexture&&(r.push("#define ORMTEXTURE"),r.push(`#define REFLECTIVITY_UV${i.metallicRoughnessTexture.coordinatesIndex+1}`),r.push("#define METALLICWORKFLOW"),m=!0,_=!0),i.metallic!=null&&(r.push("#define METALLIC"),r.push("#define METALLICWORKFLOW"),_=!0),i.roughness!=null&&(r.push("#define ROUGHNESS"),r.push("#define METALLICWORKFLOW"),_=!0),_&&(i.baseTexture&&(r.push("#define ALBEDOTEXTURE"),r.push(`#define ALBEDO_UV${i.baseTexture.coordinatesIndex+1}`),i.baseTexture.gammaSpace&&r.push("#define GAMMAALBEDO"),m=!0),i.baseColor&&r.push("#define ALBEDOCOLOR"))):i.getClassName()==="PBRSpecularGlossinessMaterial"?(i.specularGlossinessTexture?(r.push("#define SPECULARGLOSSINESSTEXTURE"),r.push(`#define REFLECTIVITY_UV${i.specularGlossinessTexture.coordinatesIndex+1}`),m=!0,i.specularGlossinessTexture.gammaSpace&&r.push("#define GAMMAREFLECTIVITYTEXTURE")):i.specularColor&&r.push("#define REFLECTIVITYCOLOR"),i.glossiness!=null&&r.push("#define GLOSSINESS")):i.getClassName()==="PBRMaterial"?(i.metallicTexture&&(r.push("#define ORMTEXTURE"),r.push(`#define REFLECTIVITY_UV${i.metallicTexture.coordinatesIndex+1}`),r.push("#define METALLICWORKFLOW"),m=!0,_=!0),i.metallic!=null&&(r.push("#define METALLIC"),r.push("#define METALLICWORKFLOW"),_=!0),i.roughness!=null&&(r.push("#define ROUGHNESS"),r.push("#define METALLICWORKFLOW"),_=!0),_?(i.albedoTexture&&(r.push("#define ALBEDOTEXTURE"),r.push(`#define ALBEDO_UV${i.albedoTexture.coordinatesIndex+1}`),i.albedoTexture.gammaSpace&&r.push("#define GAMMAALBEDO"),m=!0),i.albedoColor&&r.push("#define ALBEDOCOLOR")):(i.reflectivityTexture?(r.push("#define SPECULARGLOSSINESSTEXTURE"),r.push(`#define REFLECTIVITY_UV${i.reflectivityTexture.coordinatesIndex+1}`),i.reflectivityTexture.gammaSpace&&r.push("#define GAMMAREFLECTIVITYTEXTURE"),m=!0):i.reflectivityColor&&r.push("#define REFLECTIVITYCOLOR"),i.microSurface!=null&&r.push("#define GLOSSINESS"))):i.getClassName()==="StandardMaterial"&&(i.specularTexture&&(r.push("#define REFLECTIVITYTEXTURE"),r.push(`#define REFLECTIVITY_UV${i.specularTexture.coordinatesIndex+1}`),i.specularTexture.gammaSpace&&r.push("#define GAMMAREFLECTIVITYTEXTURE"),m=!0),i.specularColor&&r.push("#define REFLECTIVITYCOLOR"))}m&&(r.push("#define NEED_UV"),a.isVerticesDataPresent(A.UVKind)&&(n.push(A.UVKind),r.push("#define UV1"),o=!0),a.isVerticesDataPresent(A.UV2Kind)&&(n.push(A.UV2Kind),r.push("#define UV2"),l=!0))}this._enableDepth&&(r.push("#define DEPTH"),r.push("#define DEPTH_INDEX "+this._depthIndex)),this._enableNormal&&(r.push("#define NORMAL"),r.push("#define NORMAL_INDEX "+this._normalIndex)),this._enablePosition&&(r.push("#define POSITION"),r.push("#define POSITION_INDEX "+this._positionIndex)),this._enableVelocity&&(r.push("#define VELOCITY"),r.push("#define VELOCITY_INDEX "+this._velocityIndex),this.excludedSkinnedMeshesFromVelocity.indexOf(a)===-1&&r.push("#define BONES_VELOCITY_ENABLED")),this._enableVelocityLinear&&(r.push("#define VELOCITY_LINEAR"),r.push("#define VELOCITY_LINEAR_INDEX "+this._velocityLinearIndex),this.excludedSkinnedMeshesFromVelocity.indexOf(a)===-1&&r.push("#define BONES_VELOCITY_ENABLED")),this._enableReflectivity&&(r.push("#define REFLECTIVITY"),r.push("#define REFLECTIVITY_INDEX "+this._reflectivityIndex)),this._enableScreenspaceDepth&&this._screenspaceDepthIndex!==-1&&(r.push("#define SCREENSPACE_DEPTH_INDEX "+this._screenspaceDepthIndex),r.push("#define SCREENSPACE_DEPTH")),this.generateNormalsInWorldSpace&&r.push("#define NORMAL_WORLDSPACE"),this._normalsAreUnsigned&&r.push("#define ENCODE_NORMAL"),a.useBones&&a.computeBonesUsingShaders&&a.skeleton?(n.push(A.MatricesIndicesKind),n.push(A.MatricesWeightsKind),a.numBoneInfluencers>4&&(n.push(A.MatricesIndicesExtraKind),n.push(A.MatricesWeightsExtraKind)),r.push("#define NUM_BONE_INFLUENCERS "+a.numBoneInfluencers),r.push("#define BONETEXTURE "+a.skeleton.isUsingTextureForMatrices),r.push("#define BonesPerMesh "+(a.skeleton.bones.length+1))):(r.push("#define NUM_BONE_INFLUENCERS 0"),r.push("#define BONETEXTURE false"),r.push("#define BonesPerMesh 0"));let f=a.morphTargetManager?Fn(a.morphTargetManager,r,n,a,!0,!0,!1,o,l,c):0;t&&(r.push("#define INSTANCES"),sn(n,this._enableVelocity||this._enableVelocityLinear),e.getRenderingMesh().hasThinInstances&&r.push("#define THIN_INSTANCES")),this._linkedWithPrePass?r.push("#define SCENE_MRT_COUNT "+this._attachmentsFromPrePass.length):r.push("#define SCENE_MRT_COUNT "+this._multiRenderTarget.textures.length),On(i,this._scene,r);let h=this._scene.getEngine(),u=e._getDrawWrapper(void 0,!0),d=u.defines,p=r.join(`
`);return d!==p&&u.setEffect(h.createEffect("geometry",{attributes:n,uniformsNames:p8,samplers:["diffuseSampler","bumpSampler","reflectivitySampler","albedoSampler","morphTargets","boneSampler"],defines:p,onCompiled:null,fallbacks:null,onError:null,uniformBuffersNames:["Scene"],indexParameters:{buffersCount:this._multiRenderTarget.textures.length-1,maxSimultaneousMorphTargets:f},shaderLanguage:this.shaderLanguage},h),p),u.effect.isReady()}getGBuffer(){return this._multiRenderTarget}get samples(){return this._multiRenderTarget.samples}set samples(e){this._multiRenderTarget.samples=e}dispose(){this._resizeObserver&&(this._scene.getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this.getGBuffer().dispose()}_assignRenderTargetIndices(){let e=[],t=[],i=0;return this._enableDepth&&(this._depthIndex=i,i++,e.push("gBuffer_Depth"),t.push(this._textureTypesAndFormats[s.DEPTH_TEXTURE_TYPE])),this._enableNormal&&(this._normalIndex=i,i++,e.push("gBuffer_Normal"),t.push(this._textureTypesAndFormats[s.NORMAL_TEXTURE_TYPE])),this._enablePosition&&(this._positionIndex=i,i++,e.push("gBuffer_Position"),t.push(this._textureTypesAndFormats[s.POSITION_TEXTURE_TYPE])),this._enableVelocity&&(this._velocityIndex=i,i++,e.push("gBuffer_Velocity"),t.push(this._textureTypesAndFormats[s.VELOCITY_TEXTURE_TYPE])),this._enableVelocityLinear&&(this._velocityLinearIndex=i,i++,e.push("gBuffer_VelocityLinear"),t.push(this._textureTypesAndFormats[s.VELOCITY_LINEAR_TEXTURE_TYPE])),this._enableReflectivity&&(this._reflectivityIndex=i,i++,e.push("gBuffer_Reflectivity"),t.push(this._textureTypesAndFormats[s.REFLECTIVITY_TEXTURE_TYPE])),this._enableScreenspaceDepth&&(this._screenspaceDepthIndex=i,i++,e.push("gBuffer_ScreenspaceDepth"),t.push(this._textureTypesAndFormats[s.SCREENSPACE_DEPTH_TEXTURE_TYPE])),[i,e,t]}_createRenderTargets(){let e=this._scene.getEngine(),[t,i,r]=this._assignRenderTargetIndices(),n=0;e._caps.textureFloat&&e._caps.textureFloatLinearFiltering?n=1:e._caps.textureHalfFloat&&e._caps.textureHalfFloatLinearFiltering&&(n=2);let a=this._ratioOrDimensions.width!==void 0?this._ratioOrDimensions:{width:e.getRenderWidth()*this._ratioOrDimensions,height:e.getRenderHeight()*this._ratioOrDimensions},o=[],l=[];for(let _ of r)_?(o.push(_.textureType),l.push(_.textureFormat)):(o.push(n),l.push(5));if(this._normalsAreUnsigned=o[s.NORMAL_TEXTURE_TYPE]===11||o[s.NORMAL_TEXTURE_TYPE]===13,this._multiRenderTarget=new fh("gBuffer",a,t,this._scene,{generateMipMaps:!1,generateDepthTexture:!0,types:o,formats:l,depthTextureFormat:this._depthFormat},i.concat("gBuffer_DepthBuffer")),!this.isSupported)return;this._multiRenderTarget.wrapU=H.CLAMP_ADDRESSMODE,this._multiRenderTarget.wrapV=H.CLAMP_ADDRESSMODE,this._multiRenderTarget.refreshRate=1,this._multiRenderTarget.renderParticles=!1,this._multiRenderTarget.renderList=null;let c=[!0],f=[!1],h=[!0];for(let _=1;_<t;++_)c.push(!0),h.push(!1),f.push(!0);let u=e.buildTextureLayout(c),d=e.buildTextureLayout(f),p=e.buildTextureLayout(h);this._multiRenderTarget.onClearObservable.add(_=>{_.bindAttachments(this.useSpecificClearForDepthTexture?d:u),_.clear(this._clearColor,!0,!0,!0),this.useSpecificClearForDepthTexture&&(_.bindAttachments(p),_.clear(this._clearDepthColor,!0,!0,!0)),_.bindAttachments(u)}),this._resizeObserver=e.onResizeObservable.add(()=>{if(this._multiRenderTarget){let _=this._ratioOrDimensions.width!==void 0?this._ratioOrDimensions:{width:e.getRenderWidth()*this._ratioOrDimensions,height:e.getRenderHeight()*this._ratioOrDimensions};this._multiRenderTarget.resize(_)}});let m=_=>{let v=_.getRenderingMesh(),T=_.getEffectiveMesh(),C=this._scene,I=C.getEngine(),R=_.getMaterial();if(!R)return;if(T._internalAbstractMeshDataInfo._isActiveIntermediate=!1,(this._enableVelocity||this._enableVelocityLinear)&&!this._previousTransformationMatrices[T.uniqueId]&&(this._previousTransformationMatrices[T.uniqueId]={world:B.Identity(),viewProjection:C.getTransformMatrix()},v.skeleton)){let U=v.skeleton.getTransformMatrices(v);this._previousBonesTransformationMatrices[v.uniqueId]=this._copyBonesTransformationMatrices(U,new Float32Array(U.length))}let b=v._getInstancesRenderList(_._id,!!_.getReplacementMesh());if(b.mustReturn)return;let M=I.getCaps().instancedArrays&&(b.visibleInstances[_._id]!==null||v.hasThinInstances),F=T.getWorldMatrix();if(this.isReady(_,M)){let U=_._getDrawWrapper();if(!U)return;let D=U.effect;I.enableEffect(U),M||v._bind(_,D,R.fillMode),this._useUbo?(Co(D,this._scene.getSceneUniformBuffer()),this._scene.finalizeSceneUbo()):(D.setMatrix("viewProjection",C.getTransformMatrix()),D.setMatrix("view",C.getViewMatrix()));let $;if(!v._instanceDataStorage.isFrozen&&(R.backFaceCulling||R.sideOrientation!==null)){let re=T._getWorldMatrixDeterminant();$=R._getEffectiveOrientation(v),re<0&&($=$===Q.ClockWiseSideOrientation?Q.CounterClockWiseSideOrientation:Q.ClockWiseSideOrientation)}else $=v._effectiveSideOrientation;if(R._preBind(U,$),R.needAlphaTestingForMesh(T)){let re=R.getAlphaTestTexture();re&&(D.setTexture("diffuseSampler",re),D.setMatrix("diffuseMatrix",re.getTextureMatrix()))}if((R.bumpTexture||R.normalTexture)&&C.getEngine().getCaps().standardDerivatives&&X.BumpTextureEnabled){let re=R.bumpTexture||R.normalTexture;D.setFloat3("vBumpInfos",re.coordinatesIndex,1/re.level,R.parallaxScaleBias),D.setMatrix("bumpMatrix",re.getTextureMatrix()),D.setTexture("bumpSampler",re),D.setFloat2("vTangentSpaceParams",R.invertNormalMapX?-1:1,R.invertNormalMapY?-1:1)}if(this._enableReflectivity&&(R.getClassName()==="PBRMetallicRoughnessMaterial"?(R.metallicRoughnessTexture!==null&&(D.setTexture("reflectivitySampler",R.metallicRoughnessTexture),D.setMatrix("reflectivityMatrix",R.metallicRoughnessTexture.getTextureMatrix())),R.metallic!==null&&D.setFloat("metallic",R.metallic),R.roughness!==null&&D.setFloat("glossiness",1-R.roughness),R.baseTexture!==null&&(D.setTexture("albedoSampler",R.baseTexture),D.setMatrix("albedoMatrix",R.baseTexture.getTextureMatrix())),R.baseColor!==null&&D.setColor3("albedoColor",R.baseColor)):R.getClassName()==="PBRSpecularGlossinessMaterial"?(R.specularGlossinessTexture!==null?(D.setTexture("reflectivitySampler",R.specularGlossinessTexture),D.setMatrix("reflectivityMatrix",R.specularGlossinessTexture.getTextureMatrix())):R.specularColor!==null&&D.setColor3("reflectivityColor",R.specularColor),R.glossiness!==null&&D.setFloat("glossiness",R.glossiness)):R.getClassName()==="PBRMaterial"?(R.metallicTexture!==null&&(D.setTexture("reflectivitySampler",R.metallicTexture),D.setMatrix("reflectivityMatrix",R.metallicTexture.getTextureMatrix())),R.metallic!==null&&D.setFloat("metallic",R.metallic),R.roughness!==null&&D.setFloat("glossiness",1-R.roughness),R.roughness!==null||R.metallic!==null||R.metallicTexture!==null?(R.albedoTexture!==null&&(D.setTexture("albedoSampler",R.albedoTexture),D.setMatrix("albedoMatrix",R.albedoTexture.getTextureMatrix())),R.albedoColor!==null&&D.setColor3("albedoColor",R.albedoColor)):(R.reflectivityTexture!==null?(D.setTexture("reflectivitySampler",R.reflectivityTexture),D.setMatrix("reflectivityMatrix",R.reflectivityTexture.getTextureMatrix())):R.reflectivityColor!==null&&D.setColor3("reflectivityColor",R.reflectivityColor),R.microSurface!==null&&D.setFloat("glossiness",R.microSurface))):R.getClassName()==="StandardMaterial"&&(R.specularTexture!==null&&(D.setTexture("reflectivitySampler",R.specularTexture),D.setMatrix("reflectivityMatrix",R.specularTexture.getTextureMatrix())),R.specularColor!==null&&D.setColor3("reflectivityColor",R.specularColor))),zi(D,R,this._scene),v.useBones&&v.computeBonesUsingShaders&&v.skeleton){let re=v.skeleton;if(re.isUsingTextureForMatrices&&D.getUniformIndex("boneTextureWidth")>-1){let se=re.getTransformMatrixTexture(v);D.setTexture("boneSampler",se),D.setFloat("boneTextureWidth",4*(re.bones.length+1))}else D.setMatrices("mBones",v.skeleton.getTransformMatrices(v));(this._enableVelocity||this._enableVelocityLinear)&&D.setMatrices("mPreviousBones",this._previousBonesTransformationMatrices[v.uniqueId])}lr(v,D),v.morphTargetManager&&v.morphTargetManager.isUsingTextureForTargets&&v.morphTargetManager._bind(D),(this._enableVelocity||this._enableVelocityLinear)&&(D.setMatrix("previousWorld",this._previousTransformationMatrices[T.uniqueId].world),D.setMatrix("previousViewProjection",this._previousTransformationMatrices[T.uniqueId].viewProjection)),M&&v.hasThinInstances&&D.setMatrix("world",F),v._processRendering(T,_,D,R.fillMode,b,M,(re,se)=>{re||D.setMatrix("world",se)})}(this._enableVelocity||this._enableVelocityLinear)&&(this._previousTransformationMatrices[T.uniqueId].world=F.clone(),this._previousTransformationMatrices[T.uniqueId].viewProjection=this._scene.getTransformMatrix().clone(),v.skeleton&&this._copyBonesTransformationMatrices(v.skeleton.getTransformMatrices(v),this._previousBonesTransformationMatrices[T.uniqueId]))};this._multiRenderTarget.customIsReadyFunction=(_,v,T)=>{if((T||v===0)&&_.subMeshes)for(let C=0;C<_.subMeshes.length;++C){let I=_.subMeshes[C],R=I.getMaterial(),b=I.getRenderingMesh();if(!R)continue;let M=b._getInstancesRenderList(I._id,!!I.getReplacementMesh()),F=e.getCaps().instancedArrays&&(M.visibleInstances[I._id]!==null||b.hasThinInstances);if(!this.isReady(I,F))return!1}return!0},this._multiRenderTarget.customRenderFunction=(_,v,T,C)=>{let I;if(this._linkedWithPrePass){if(!this._prePassRenderer.enabled)return;this._scene.getEngine().bindAttachments(this._attachmentsFromPrePass)}if(C.length){for(e.setColorWrite(!1),I=0;I<C.length;I++)m(C.data[I]);e.setColorWrite(!0)}for(I=0;I<_.length;I++)m(_.data[I]);for(e.setDepthWrite(!1),I=0;I<v.length;I++)m(v.data[I]);if(this.renderTransparentMeshes)for(I=0;I<T.length;I++)m(T.data[I]);e.setDepthWrite(!0)}}_copyBonesTransformationMatrices(e,t){for(let i=0;i<e.length;i++)t[i]=e[i];return t}};Ot.ForceGLSL=!1;Ot.DEPTH_TEXTURE_TYPE=0;Ot.NORMAL_TEXTURE_TYPE=1;Ot.POSITION_TEXTURE_TYPE=2;Ot.VELOCITY_TEXTURE_TYPE=3;Ot.REFLECTIVITY_TEXTURE_TYPE=4;Ot.SCREENSPACE_DEPTH_TEXTURE_TYPE=5;Ot.VELOCITY_LINEAR_TEXTURE_TYPE=6;Ot._SceneComponentInitialization=s=>{throw pe("GeometryBufferRendererSceneComponent")}});var Ax={};V(Ax,{iblShadowDebugPixelShaderWGSL:()=>Ere});var dP,m8,Ere,Rx=S(()=>{O();dP="iblShadowDebugPixelShader",m8=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var debugSamplerSampler: sampler;var debugSampler: texture_2d<f32>;uniform sizeParams: vec4f;
#define offsetX uniforms.sizeParams.x
#define offsetY uniforms.sizeParams.y
#define widthScale uniforms.sizeParams.z
#define heightScale uniforms.sizeParams.w
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var uv: vec2f =
vec2f((offsetX+fragmentInputs.vUV.x)*widthScale,(offsetY+fragmentInputs.vUV.y)*heightScale);var background: vec4f=textureSample(textureSampler,textureSamplerSampler,fragmentInputs.vUV);var debugColour: vec4f=textureSample(debugSampler,debugSamplerSampler,fragmentInputs.vUV);if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {fragmentOutputs.color=background;} else {fragmentOutputs.color=vec4f(mix(debugColour.rgb,background.rgb,0.0),1.0);}}`;g.ShadersStoreWGSL[dP]||(g.ShadersStoreWGSL[dP]=m8);Ere={name:dP,shader:m8}});var bx={};V(bx,{iblShadowDebugPixelShader:()=>Tre});var pP,_8,Tre,Cx=S(()=>{O();pP="iblShadowDebugPixelShader",_8=`#ifdef GL_ES
precision mediump float;
#endif
varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D debugSampler;uniform vec4 sizeParams;
#define offsetX sizeParams.x
#define offsetY sizeParams.y
#define widthScale sizeParams.z
#define heightScale sizeParams.w
void main(void) {vec2 uv =
vec2((offsetX+vUV.x)*widthScale,(offsetY+vUV.y)*heightScale);vec4 background=texture2D(textureSampler,vUV);vec4 debugColour=texture2D(debugSampler,vUV);if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {gl_FragColor.rgba=background;} else {gl_FragColor.rgb=mix(debugColour.rgb,background.rgb,0.0);gl_FragColor.a=1.0;}}`;g.ShadersStore[pP]||(g.ShadersStore[pP]=_8);Tre={name:pP,shader:_8}});var v8={};V(v8,{iblShadowVoxelTracingPixelShaderWGSL:()=>xre});var mP,g8,xre,S8=S(()=>{O();mP="iblShadowVoxelTracingPixelShader",g8=`#define PI 3.1415927
varying vUV: vec2f;
#define DISABLE_UNIFORMITY_ANALYSIS
var depthSampler: texture_2d<f32>;var worldNormalSampler : texture_2d<f32>;var blueNoiseSampler: texture_2d<f32>;var icdfSamplerSampler: sampler;var icdfSampler: texture_2d<f32>;var voxelGridSamplerSampler: sampler;var voxelGridSampler: texture_3d<f32>;
#ifdef COLOR_SHADOWS
var iblSamplerSampler: sampler;var iblSampler: texture_cube<f32>;
#endif
uniform shadowParameters: vec4f;
#define SHADOWdirs uniforms.shadowParameters.x
#define SHADOWframe uniforms.shadowParameters.y
#define SHADOWenvRot uniforms.shadowParameters.w
uniform voxelBiasParameters : vec4f;
#define highestMipLevel uniforms.voxelBiasParameters.z
uniform sssParameters: vec4f;
#define SSSsamples uniforms.sssParameters.x
#define SSSstride uniforms.sssParameters.y
#define SSSmaxDistance uniforms.sssParameters.z
#define SSSthickness uniforms.sssParameters.w
uniform shadowOpacity: vec4f;uniform projMtx: mat4x4f;uniform viewMtx: mat4x4f;uniform invProjMtx: mat4x4f;uniform invViewMtx: mat4x4f;uniform wsNormalizationMtx: mat4x4f;uniform invVPMtx: mat4x4f;
#define PI 3.1415927
#define GOLD 0.618034
struct AABB3f {m_min: vec3f,
m_max: vec3f,};struct Ray {orig: vec3f,
dir: vec3f,
dir_rcp: vec3f,
t_min: f32,
t_max: f32,};fn make_ray(origin: vec3f,direction: vec3f,tmin: f32,
tmax: f32)->Ray {var ray: Ray;ray.orig=origin;ray.dir=direction;ray.dir_rcp=1.0f/direction;ray.t_min=tmin;ray.t_max=tmax;return ray;}
fn ray_box_intersection(aabb: AABB3f,ray: Ray ,
distance_near: ptr<function,f32>,distance_far: ptr<function,f32>)->bool{var tbot: vec3f=ray.dir_rcp*(aabb.m_min-ray.orig);var ttop: vec3f=ray.dir_rcp*(aabb.m_max-ray.orig);var tmin: vec3f=min(ttop,tbot);var tmax: vec3f=max(ttop,tbot);*distance_near=max(ray.t_min,max(tmin.x,max(tmin.y,tmin.z)));*distance_far=min(ray.t_max,min(tmax.x,min(tmax.y,tmax.z)));return *distance_near<=*distance_far;}
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
struct VoxelMarchDiagnosticInfo {heat: f32,
voxel_intersect_coords: vec3i,};
#endif
fn hash(i: u32)->u32 {var temp=i ^ (i>>16u);temp*=0x7FEB352Du;temp ^= temp>>15u;temp*=0x846CA68Bu;temp ^= temp>>16u;return temp;}
fn uintBitsToFloat(x: u32)->f32 {return bitcast<f32>(x);}
fn uint2float(i: u32)->f32 {return uintBitsToFloat(0x3F800000u | (i>>9u))-1.0;}
fn uv_to_normal(uv: vec2f)->vec3f {var N: vec3f;var uvRange: vec2f=uv;var theta: f32=uvRange.x*2.0*PI;var phi: f32=uvRange.y*PI;N.x=cos(theta)*sin(phi);N.z=sin(theta)*sin(phi);N.y=cos(phi);return N;}
fn plasticSequence(rstate: u32)->vec2f {return vec2f(uint2float(rstate*3242174889u),
uint2float(rstate*2447445414u));}
fn goldenSequence(rstate: u32)->f32 {return uint2float(rstate*2654435769u);}
fn distanceSquared(a: vec2f,b: vec2f)->f32 {var diff: vec2f=a-b;return dot(diff,diff);}
fn genTB(N: vec3f,T: ptr<function,vec3f>,B: ptr<function,vec3f>) {var s: f32=select(1.0,-1.0,N.z<0.0);var a: f32=-1.0/(s+N.z);var b: f32=N.x*N.y*a;*T= vec3f(1.0+s*N.x*N.x*a,s*b,-s*N.x);*B= vec3f(b,s+N.y*N.y*a,-N.y);}
fn lessThan(x: vec3f,y: vec3f)->vec3<bool> {return x<y;}
#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
fn anyHitVoxels(ray_vs: Ray,
voxel_march_diagnostic_info: ptr<function,VoxelMarchDiagnosticInfo>)->bool {
#else
fn anyHitVoxels(ray_vs: Ray)->bool {
#endif
var stack=array<i32,24>(); 
var invD: vec3f=ray_vs.dir_rcp;var D: vec3f=ray_vs.dir;var O: vec3f=ray_vs.orig;var negD=vec3i(lessThan(D, vec3f(0,0,0)));var voxel0: i32=negD.x | (negD.y<<1) | (negD.z<<2);var t0: vec3f=-O*invD;var t1=(vec3f(1.0)-O)*invD;var maxLod: i32= i32(highestMipLevel);var stackLevel: i32=0;
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
var steps: u32=0u;
#endif
stack[stackLevel]=maxLod<<24;stackLevel++;while (stackLevel>0) {stackLevel=stackLevel-1;var elem: i32=stack[stackLevel];var Coords: vec4i =
vec4i(elem & 0xFF,(elem>>8) & 0xFF,(elem>>16) & 0xFF,elem>>24);if (Coords.w==0) {
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
*voxel_march_diagnostic_info.heat= f32(steps)/24.0;
#endif
return true;}
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
++steps;
#endif
var invRes: f32=exp2(f32(Coords.w-maxLod));var bbmin: vec3f=invRes*vec3f(Coords.xyz+negD);var bbmax: vec3f=invRes*vec3f(Coords.xyz-negD+vec3i(1));var mint: vec3f=mix(t0,t1,bbmin);var maxt: vec3f=mix(t0,t1,bbmax);var midt: vec3f=0.5*(mint+maxt);mint.x=max(0.0,mint.x);midt.x=max(0.0,midt.x);var nodeMask: u32= u32(
round(textureLoad(voxelGridSampler,Coords.xyz,Coords.w).x*255.0));Coords.w--;var voxelBit: u32=u32(voxel0);Coords=vec4i((Coords.xyz<<vec3u(1))+negD,Coords.w);var packedCoords: i32 =
Coords.x | (Coords.y<<8) | (Coords.z<<16) | (Coords.w<<24);if (max(mint.x,max(mint.y,mint.z))<min(midt.x,min(midt.y,midt.z)) &&
((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}
voxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(midt.x,max(mint.y,mint.z))<min(maxt.x,min(midt.y,midt.z)) &&
((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}
voxelBit ^= 0x2;packedCoords ^= 0x00100;if (max(midt.x,max(midt.y,mint.z))<min(maxt.x,min(maxt.y,midt.z)) &&
((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}
voxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(mint.x,max(midt.y,mint.z))<min(midt.x,min(maxt.y,midt.z)) &&
((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}
voxelBit ^= 0x4;packedCoords ^= 0x10000;if (max(mint.x,max(midt.y,midt.z))<min(midt.x,min(maxt.y,maxt.z)) &&
((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}
voxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(midt.x,max(midt.y,midt.z))<min(maxt.x,min(maxt.y,maxt.z)) &&
((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}
voxelBit ^= 0x2;packedCoords ^= 0x00100;if (max(midt.x,max(mint.y,midt.z))<min(maxt.x,min(midt.y,maxt.z)) &&
((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}
voxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(mint.x,max(mint.y,midt.z))<min(midt.x,min(midt.y,maxt.z)) &&
((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}}
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
*voxel_march_diagnostic_info.heat= f32(steps)/24.0;
#endif
return false;}
fn linearizeDepth(depth: f32,near: f32,far: f32)->f32 {return (near*far)/(far-depth*(far-near));}
fn screenSpaceShadow(csOrigin: vec3f,csDirection: vec3f,csZBufferSize: vec2f,
nearPlaneZ: f32,farPlaneZ: f32,noise: f32)->f32 {
#ifdef RIGHT_HANDED
var csZDir : f32=-1.0;
#else 
var csZDir : f32=1.0;
#endif
var ssSamples: f32=SSSsamples;var ssMaxDist: f32=SSSmaxDistance;var ssStride: f32=SSSstride;var ssThickness: f32=SSSthickness;var rayLength: f32 =
select(ssMaxDist,(nearPlaneZ-csOrigin.z)/csDirection.z,
csZDir*(csOrigin.z+ssMaxDist*csDirection.z)<csZDir*nearPlaneZ);var csEndPoint: vec3f=csOrigin+rayLength*csDirection;var H0: vec4f=uniforms.projMtx*vec4f(csOrigin,1.0);var H1: vec4f=uniforms.projMtx*vec4f(csEndPoint,1.0);var Z0=vec2f(csOrigin.z ,1.0)/H0.w;var Z1=vec2f(csEndPoint.z,1.0)/H1.w;var P0=csZBufferSize*(0.5*H0.xy*Z0.y+0.5);var P1=csZBufferSize*(0.5*H1.xy*Z1.y+0.5);P1+= vec2f(select(0.0,0.01,distanceSquared(P0,P1)<0.0001));var delta: vec2f=P1-P0;var permute: bool=false;if (abs(delta.x)<abs(delta.y)) {permute=true;P0=P0.yx;P1=P1.yx;delta=delta.yx;}
var stepDirection: f32=sign(delta.x);var invdx: f32=stepDirection/delta.x;var dP: vec2f=ssStride* vec2f(stepDirection,invdx*delta.y);var dZ: vec2f=ssStride*invdx*(Z1-Z0);var opacity: f32=0.0;var P: vec2f=P0+noise*dP;var Z: vec2f=Z0+noise*dZ;var end: f32=P1.x*stepDirection;var rayZMax=csZDir*Z.x/Z.y;var sceneDepth=rayZMax;Z+=dZ;for (var stepCount: f32=0.0; 
opacity<1.0 && P.x*stepDirection<end && sceneDepth>0.0 && stepCount<ssSamples;stepCount+=1) { 
var coords=vec2i(select(P,P.yx,permute));sceneDepth=textureLoad(depthSampler,coords,0).x;sceneDepth=linearizeDepth(sceneDepth,nearPlaneZ,farPlaneZ);sceneDepth=csZDir*sceneDepth;if (sceneDepth<=0.0) {break;}
var rayZMin: f32=rayZMax;rayZMax=csZDir*Z.x/Z.y;opacity+=max(opacity,step(rayZMax,sceneDepth+ssThickness)*step(sceneDepth,rayZMin));P+=dP;Z+=dZ;}
return opacity;}
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
fn voxelShadow(wsOrigin: vec3f,wsDirection: vec3f,wsNormal: vec3f,
DitherNoise: vec2f,
voxel_march_diagnostic_info: ptr<function,VoxelMarchDiagnosticInfo>)->f32 {
#else
fn voxelShadow(wsOrigin: vec3f,wsDirection: vec3f,wsNormal: vec3f,
DitherNoise: vec2f)->f32 {
#endif
var vxResolution: f32=f32(textureDimensions(voxelGridSampler,0).x);var T: vec3f;var B: vec3f;genTB(wsDirection,&T,&B);var DitherXY: vec2f=sqrt(DitherNoise.x)* vec2f(cos(2.0*PI*DitherNoise.y),
sin(2.0*PI*DitherNoise.y));var Dithering : vec3f=(uniforms.voxelBiasParameters.x*wsNormal +
uniforms.voxelBiasParameters.y*wsDirection +
DitherXY.x*T+DitherXY.y*B) /
vxResolution;var O: vec3f=0.5*wsOrigin+0.5+Dithering;var ray_vs=make_ray(O,wsDirection,0.0,10.0);var voxel_aabb: AABB3f;voxel_aabb.m_min=vec3f(0);voxel_aabb.m_max=vec3f(1);var near: f32=0;var far: f32=0;if (!ray_box_intersection(voxel_aabb,ray_vs,&near,&far)) {return 0.0;}
ray_vs.t_min=max(ray_vs.t_min,near);ray_vs.t_max=min(ray_vs.t_max,far);
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
return select(0.0f,1.0f,anyHitVoxels(ray_vs,voxel_march_diagnostic_info));
#else
return select(0.0f,1.0f,anyHitVoxels(ray_vs));
#endif
}
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var nbDirs=u32(SHADOWdirs);var frameId=u32(SHADOWframe);var envRot: f32=SHADOWenvRot;var Resolution: vec2f= vec2f(textureDimensions(depthSampler,0));var currentPixel=vec2i(fragmentInputs.vUV*Resolution);var GlobalIndex =
(frameId*u32(Resolution.y)+u32(currentPixel.y))*u32(Resolution.x) +
u32(currentPixel.x);var N : vec3f=textureLoad(worldNormalSampler,currentPixel,0).xyz;if (length(N)<0.01) {fragmentOutputs.color=vec4f(1.0,1.0,0.0,1.0);return fragmentOutputs;}
var normalizedRotation: f32=envRot/(2.0*PI);var depth : f32=textureLoad(depthSampler,currentPixel,0).x;
#ifndef IS_NDC_HALF_ZRANGE
depth=depth*2.0-1.0;
#endif
var temp : vec2f=(vec2f(currentPixel)+vec2f(0.5))*2.0/Resolution -
vec2f(1.0);var VP : vec4f=uniforms.invProjMtx*vec4f(temp.x,-temp.y,depth,1.0);VP/=VP.w;N=normalize(N);var noise : vec3f=textureLoad(blueNoiseSampler,currentPixel & vec2i(0xFF),0).xyz;noise.z=fract(noise.z+goldenSequence(frameId*nbDirs));
#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
var heat: f32=0.0f;
#endif
var shadowAccum: f32=0.001;var specShadowAccum: f32=0.001;var sampleWeight : f32=0.001;
#ifdef COLOR_SHADOWS
var totalLight: vec3f=vec3f(0.001);var shadowedLight: vec3f=vec3f(0.0);
#endif
for (var i: u32=0; i<nbDirs; i++) {var dirId: u32=nbDirs*GlobalIndex+i;var L: vec4f;var T: vec2f;{var r: vec2f=plasticSequence(frameId*nbDirs+i);r=fract(r+ vec2f(2.0)*abs(noise.xy- vec2f(0.5)));T.x=textureSampleLevel(icdfSampler,icdfSamplerSampler,vec2f(r.x,0.0),0.0).x;T.y=textureSampleLevel(icdfSampler,icdfSamplerSampler,vec2f(T.x,r.y),0.0).y;L= vec4f(uv_to_normal(vec2f(T.x-normalizedRotation,T.y)),0);
#ifndef RIGHT_HANDED
L.z*=-1.0;
#endif
}
#ifdef COLOR_SHADOWS
var lightDir: vec3f=uv_to_normal(vec2f(1.0-fract(T.x+0.25),T.y));var ibl: vec3f=textureSampleLevel(iblSampler,iblSamplerSampler,lightDir,0.0).xyz;var pdf: f32=textureSampleLevel(icdfSampler,icdfSamplerSampler,T,0.0).z;
#endif
var cosNL: f32=dot(N,L.xyz);var opacity: f32=0.0;if (cosNL>0.0) {var VP2: vec4f=VP;VP2.y*=-1.0;var unormWP : vec4f=uniforms.invViewMtx*VP2;var WP: vec3f=(uniforms.wsNormalizationMtx*unormWP).xyz;var vxNoise: vec2f=vec2f(uint2float(hash(dirId*2)),uint2float(hash(dirId*2+1)));
#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
VoxelMarchDiagnosticInfo voxel_march_diagnostic_info;opacity=max(opacity,
uniforms.shadowOpacity.x*voxelShadow(WP,L.xyz,N,vxNoise,
voxel_march_diagnostic_info));heat+=voxel_march_diagnostic_info.heat;
#else
opacity =
max(opacity,uniforms.shadowOpacity.x*voxelShadow(WP,L.xyz,N,vxNoise));
#endif
var VL : vec3f=(uniforms.viewMtx*L).xyz;
#ifdef RIGHT_HANDED
var nearPlaneZ: f32=-2.0*uniforms.projMtx[3][2]/(uniforms.projMtx[2][2]-1.0); 
var farPlaneZ: f32=-uniforms.projMtx[3][2]/(uniforms.projMtx[2][2]+1.0);
#else
var nearPlaneZ: f32=-2.0*uniforms.projMtx[3][2]/(uniforms.projMtx[2][2]+1.0); 
var farPlaneZ: f32=-uniforms.projMtx[3][2]/(uniforms.projMtx[2][2]-1.0);
#endif
var ssShadow: f32=uniforms.shadowOpacity.y *
screenSpaceShadow(VP2.xyz,VL,Resolution,nearPlaneZ,farPlaneZ,
abs(2.0*noise.z-1.0));opacity=max(opacity,ssShadow);
#ifdef COLOR_SHADOWS
var light: vec3f=select(vec3f(0.0),vec3f(cosNL)/vec3f(pdf)*ibl,pdf>1e-6);shadowedLight+=light*opacity;totalLight+=light;
#else
var rcos: f32=1.0-cosNL;shadowAccum+=(1.0-opacity*(1.0-pow(rcos,8.0)));sampleWeight+=1.0;var VR : vec3f=abs((uniforms.viewMtx*vec4f(reflect(-L.xyz,N),0.0)).xyz);specShadowAccum+=max(1.0-(opacity*pow(VR.z,8.0)),0.0);
#endif
}
noise.z=fract(noise.z+GOLD);}
#ifdef COLOR_SHADOWS
var shadow: vec3f=(totalLight-shadowedLight)/totalLight;var maxShadow: f32=max(max(shadow.x,max(shadow.y,shadow.z)),1.0);fragmentOutputs.color=vec4f(shadow/maxShadow,1.0);
#else
#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
fragmentOutputs.color =
vec4f(shadowAccum/sampleWeight,specShadowAccum/sampleWeight,heat/sampleWeight,1.0);
#else
fragmentOutputs.color=vec4f(shadowAccum/sampleWeight,specShadowAccum/sampleWeight,0.0,1.0);
#endif
#endif
}`;g.ShadersStoreWGSL[mP]||(g.ShadersStoreWGSL[mP]=g8);xre={name:mP,shader:g8}});var T8={};V(T8,{iblShadowVoxelTracingPixelShader:()=>Are});var _P,E8,Are,x8=S(()=>{O();_P="iblShadowVoxelTracingPixelShader",E8=`precision highp sampler2D;precision highp sampler3D;
#define PI 3.1415927
varying vec2 vUV;
#define DISABLE_UNIFORMITY_ANALYSIS
uniform sampler2D depthSampler;uniform sampler2D worldNormalSampler;uniform sampler2D blueNoiseSampler;uniform sampler2D icdfSampler;uniform sampler3D voxelGridSampler;
#ifdef COLOR_SHADOWS
uniform samplerCube iblSampler;
#endif
uniform vec4 shadowParameters;
#define SHADOWdirs shadowParameters.x
#define SHADOWframe shadowParameters.y
#define SHADOWenvRot shadowParameters.w
uniform vec4 voxelBiasParameters;
#define highestMipLevel voxelBiasParameters.z
uniform vec4 sssParameters;
#define SSSsamples sssParameters.x
#define SSSstride sssParameters.y
#define SSSmaxDistance sssParameters.z
#define SSSthickness sssParameters.w
uniform vec4 shadowOpacity;uniform mat4 projMtx;uniform mat4 viewMtx;uniform mat4 invProjMtx;uniform mat4 invViewMtx;uniform mat4 wsNormalizationMtx;uniform mat4 invVPMtx;
#define PI 3.1415927
#define GOLD 0.618034
struct AABB3f {vec3 m_min;vec3 m_max;};struct Ray {vec3 orig;vec3 dir;vec3 dir_rcp;float t_min;float t_max;};Ray make_ray(const vec3 origin,const vec3 direction,const float tmin,
const float tmax) {Ray ray;ray.orig=origin;ray.dir=direction;ray.dir_rcp=1.0f/direction;ray.t_min=tmin;ray.t_max=tmax;return ray;}
bool ray_box_intersection(const in AABB3f aabb,const in Ray ray,
out float distance_near,out float distance_far) {vec3 tbot=ray.dir_rcp*(aabb.m_min-ray.orig);vec3 ttop=ray.dir_rcp*(aabb.m_max-ray.orig);vec3 tmin=min(ttop,tbot);vec3 tmax=max(ttop,tbot);distance_near=max(ray.t_min,max(tmin.x,max(tmin.y,tmin.z)));distance_far=min(ray.t_max,min(tmax.x,min(tmax.y,tmax.z)));return distance_near<=distance_far;}
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
struct VoxelMarchDiagnosticInfo {float heat;ivec3 voxel_intersect_coords;};
#endif
uint hash(uint i) {i ^= i>>16u;i*=0x7FEB352Du;i ^= i>>15u;i*=0x846CA68Bu;i ^= i>>16u;return i;}
float uint2float(uint i) {return uintBitsToFloat(0x3F800000u | (i>>9u))-1.0;}
vec3 uv_to_normal(vec2 uv) {vec3 N;vec2 uvRange=uv;float theta=uvRange.x*2.0*PI;float phi=uvRange.y*PI;N.x=cos(theta)*sin(phi);N.z=sin(theta)*sin(phi);N.y=cos(phi);return N;}
vec2 plasticSequence(const uint rstate) {return vec2(uint2float(rstate*3242174889u),
uint2float(rstate*2447445414u));}
float goldenSequence(const uint rstate) {return uint2float(rstate*2654435769u);}
float distanceSquared(vec2 a,vec2 b) {vec2 diff=a-b;return dot(diff,diff);}
void genTB(const vec3 N,out vec3 T,out vec3 B) {float s=N.z<0.0 ? -1.0 : 1.0;float a=-1.0/(s+N.z);float b=N.x*N.y*a;T=vec3(1.0+s*N.x*N.x*a,s*b,-s*N.x);B=vec3(b,s+N.y*N.y*a,-N.y);}
int stack[24]; 
#define PUSH(i) stack[stackLevel++]=i; 
#define POP() stack[--stackLevel] 
#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
bool anyHitVoxels(const Ray ray_vs,
out VoxelMarchDiagnosticInfo voxel_march_diagnostic_info) {
#else
bool anyHitVoxels(const Ray ray_vs) {
#endif
vec3 invD=ray_vs.dir_rcp;vec3 D=ray_vs.dir;vec3 O=ray_vs.orig;ivec3 negD=ivec3(lessThan(D,vec3(0,0,0)));int voxel0=negD.x | negD.y<<1 | negD.z<<2;vec3 t0=-O*invD,t1=(vec3(1.0)-O)*invD;int maxLod=int(highestMipLevel);int stackLevel=0;
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
uint steps=0u;
#endif
PUSH(maxLod<<24);while (stackLevel>0) {int elem=POP();ivec4 Coords =
ivec4(elem & 0xFF,elem>>8 & 0xFF,elem>>16 & 0xFF,elem>>24);if (Coords.w==0) {
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
voxel_march_diagnostic_info.heat=float(steps)/24.0;
#endif
return true;}
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
++steps;
#endif
float invRes=exp2(float(Coords.w-maxLod));vec3 bbmin=invRes*vec3(Coords.xyz+negD);vec3 bbmax=invRes*vec3(Coords.xyz-negD+ivec3(1));vec3 mint=mix(t0,t1,bbmin);vec3 maxt=mix(t0,t1,bbmax);vec3 midt=0.5*(mint+maxt);mint.x=max(0.0,mint.x);midt.x=max(0.0,midt.x);int nodeMask=int(
round(texelFetch(voxelGridSampler,Coords.xyz,Coords.w).x*255.0));Coords.w--;int voxelBit=voxel0;Coords.xyz=(Coords.xyz<<1)+negD;int packedCoords =
Coords.x | Coords.y<<8 | Coords.z<<16 | Coords.w<<24;if (max(mint.x,max(mint.y,mint.z))<min(midt.x,min(midt.y,midt.z)) &&
(1<<voxelBit & nodeMask) != 0)
PUSH(packedCoords);voxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(midt.x,max(mint.y,mint.z))<min(maxt.x,min(midt.y,midt.z)) &&
(1<<voxelBit & nodeMask) != 0)
PUSH(packedCoords);voxelBit ^= 0x2;packedCoords ^= 0x00100;if (max(midt.x,max(midt.y,mint.z))<min(maxt.x,min(maxt.y,midt.z)) &&
(1<<voxelBit & nodeMask) != 0)
PUSH(packedCoords);voxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(mint.x,max(midt.y,mint.z))<min(midt.x,min(maxt.y,midt.z)) &&
(1<<voxelBit & nodeMask) != 0)
PUSH(packedCoords);voxelBit ^= 0x4;packedCoords ^= 0x10000;if (max(mint.x,max(midt.y,midt.z))<min(midt.x,min(maxt.y,maxt.z)) &&
(1<<voxelBit & nodeMask) != 0)
PUSH(packedCoords);voxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(midt.x,max(midt.y,midt.z))<min(maxt.x,min(maxt.y,maxt.z)) &&
(1<<voxelBit & nodeMask) != 0)
PUSH(packedCoords);voxelBit ^= 0x2;packedCoords ^= 0x00100;if (max(midt.x,max(mint.y,midt.z))<min(maxt.x,min(midt.y,maxt.z)) &&
(1<<voxelBit & nodeMask) != 0)
PUSH(packedCoords);voxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(mint.x,max(mint.y,midt.z))<min(midt.x,min(midt.y,maxt.z)) &&
(1<<voxelBit & nodeMask) != 0)
PUSH(packedCoords);}
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
voxel_march_diagnostic_info.heat=float(steps)/24.0;
#endif
return false;}
float linearizeDepth(float depth,float near,float far) {return (near*far)/(far-depth*(far-near));}
float screenSpaceShadow(vec3 csOrigin,vec3 csDirection,vec2 csZBufferSize,
float nearPlaneZ,float farPlaneZ,float noise) {
#ifdef RIGHT_HANDED
float csZDir=-1.0;
#else 
float csZDir=1.0;
#endif
float ssSamples=SSSsamples;float ssMaxDist=SSSmaxDistance;float ssStride=SSSstride;float ssThickness=SSSthickness;float rayLength =
csZDir*(csOrigin.z+ssMaxDist*csDirection.z)<csZDir*nearPlaneZ
? 
(nearPlaneZ-csOrigin.z)/csDirection.z
: ssMaxDist;vec3 csEndPoint=csOrigin+rayLength*csDirection;vec4 H0=projMtx*vec4(csOrigin,1.0);vec4 H1=projMtx*vec4(csEndPoint,1.0);vec2 Z0=vec2(csOrigin.z ,1.0)/H0.w;vec2 Z1=vec2(csEndPoint.z,1.0)/H1.w;vec2 P0=csZBufferSize*(0.5*H0.xy*Z0.y+0.5);vec2 P1=csZBufferSize*(0.5*H1.xy*Z1.y+0.5);P1+=vec2(distanceSquared(P0,P1)<0.0001 ? 0.01 : 0.0);vec2 delta=P1-P0;bool permute=false;if (abs(delta.x)<abs(delta.y)) {permute=true;P0=P0.yx;P1=P1.yx;delta=delta.yx;}
float stepDirection=sign(delta.x);float invdx=stepDirection/delta.x;vec2 dP=ssStride*vec2(stepDirection,invdx*delta.y);vec2 dZ=ssStride*invdx*(Z1-Z0);float opacity=0.0;vec2 P=P0+noise*dP;vec2 Z=Z0+noise*dZ;float end=P1.x*stepDirection;float rayZMax=csZDir*Z.x/Z.y;float sceneDepth=rayZMax;Z+=dZ;for (float stepCount=0.0;opacity<1.0 && P.x*stepDirection<end && sceneDepth>0.0 && stepCount<ssSamples;stepCount++,P+=dP,
Z+=dZ) { 
ivec2 coords=ivec2(permute ? P.yx : P);sceneDepth=texelFetch(depthSampler,coords,0).x;sceneDepth=linearizeDepth(sceneDepth,nearPlaneZ,farPlaneZ);sceneDepth=csZDir*sceneDepth;if (sceneDepth<=0.0) {break;}
float rayZMin=rayZMax;rayZMax=csZDir*Z.x/Z.y;opacity+=max(opacity,step(rayZMax,sceneDepth+ssThickness)*step(sceneDepth,rayZMin));}
return opacity;}
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
float voxelShadow(vec3 wsOrigin,vec3 wsDirection,vec3 wsNormal,
vec2 DitherNoise,
out VoxelMarchDiagnosticInfo voxel_march_diagnostic_info) {
#else
float voxelShadow(vec3 wsOrigin,vec3 wsDirection,vec3 wsNormal,
vec2 DitherNoise) {
#endif
float vxResolution=float(textureSize(voxelGridSampler,0).x);vec3 T,B;genTB(wsDirection,T,B);vec2 DitherXY=sqrt(DitherNoise.x)*vec2(cos(2.0*PI*DitherNoise.y),
sin(2.0*PI*DitherNoise.y));float sceneScale=wsNormalizationMtx[0][0];vec3 Dithering =
(voxelBiasParameters.x*wsNormal+voxelBiasParameters.y*wsDirection +
DitherXY.x*T+DitherXY.y*B) /
vxResolution;vec3 O=0.5*wsOrigin+0.5+Dithering;Ray ray_vs=make_ray(O,wsDirection,0.0,10.0);AABB3f voxel_aabb;voxel_aabb.m_min=vec3(0);voxel_aabb.m_max=vec3(1);float near,far;if (!ray_box_intersection(voxel_aabb,ray_vs,near,far))
return 0.0;ray_vs.t_min=max(ray_vs.t_min,near);ray_vs.t_max=min(ray_vs.t_max,far);
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
return anyHitVoxels(ray_vs,voxel_march_diagnostic_info) ? 1.0f : 0.0f;
#else
return anyHitVoxels(ray_vs) ? 1.0f : 0.0f;
#endif
}
void main(void) {uint nbDirs=uint(SHADOWdirs);uint frameId=uint(SHADOWframe);float envRot=SHADOWenvRot;vec2 Resolution=vec2(textureSize(depthSampler,0));ivec2 currentPixel=ivec2(vUV*Resolution);uint GlobalIndex=(frameId*uint(Resolution.y)+uint(currentPixel.y)) *
uint(Resolution.x) +
uint(currentPixel.x);vec3 N=texelFetch(worldNormalSampler,currentPixel,0).xyz;if (length(N)<0.01) {glFragColor=vec4(1.0,1.0,0.0,1.0);return;}
float normalizedRotation=envRot/(2.0*PI);float depth=texelFetch(depthSampler,currentPixel,0).x;
#ifndef IS_NDC_HALF_ZRANGE
depth=depth*2.0-1.0;
#endif
vec2 temp=(vec2(currentPixel)+vec2(0.5))*2.0/Resolution-vec2(1.0);vec4 VP=invProjMtx*vec4(temp.x,-temp.y,depth,1.0);VP/=VP.w;N=normalize(N);vec3 noise=texelFetch(blueNoiseSampler,currentPixel & 0xFF,0).xyz;noise.z=fract(noise.z+goldenSequence(frameId*nbDirs));
#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
float heat=0.0f;
#endif
float shadowAccum=0.001;float specShadowAccum=0.001;float sampleWeight=0.001;
#ifdef COLOR_SHADOWS
vec3 totalLight=vec3(0.001);vec3 shadowedLight=vec3(0.0);
#endif
for (uint i=0u; i<nbDirs; i++) {uint dirId=nbDirs*GlobalIndex+i;vec4 L;vec2 T;{vec2 r=plasticSequence(frameId*nbDirs+i);r=fract(r+vec2(2.0)*abs(noise.xy-vec2(0.5)));T.x=textureLod(icdfSampler,vec2(r.x,0.0),0.0).x;T.y=textureLod(icdfSampler,vec2(T.x,r.y),0.0).y;L=vec4(uv_to_normal(vec2(T.x-normalizedRotation,T.y)),0);
#ifndef RIGHT_HANDED
L.z*=-1.0;
#endif
}
#ifdef COLOR_SHADOWS
vec3 lightDir=uv_to_normal(vec2(1.0-fract(T.x+0.25),T.y));vec3 ibl=textureLod(iblSampler,lightDir,0.0).xyz;float pdf=textureLod(icdfSampler,T,0.0).z;
#endif
float cosNL=dot(N,L.xyz);float opacity=0.0;if (cosNL>0.0) {vec4 VP2=VP;VP2.y*=-1.0;vec4 unormWP=invViewMtx*VP2;vec3 WP=(wsNormalizationMtx*unormWP).xyz;vec2 vxNoise=vec2(uint2float(hash(dirId*2u)),uint2float(hash(dirId*2u+1u)));
#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
VoxelMarchDiagnosticInfo voxel_march_diagnostic_info;opacity=max(opacity,shadowOpacity.x*voxelShadow(WP,L.xyz,N,vxNoise,voxel_march_diagnostic_info));heat+=voxel_march_diagnostic_info.heat;
#else
opacity =
max(opacity,shadowOpacity.x*voxelShadow(WP,L.xyz,N,vxNoise));
#endif
vec3 VL=(viewMtx*L).xyz;
#ifdef RIGHT_HANDED
float nearPlaneZ=-projMtx[3][2]/(projMtx[2][2]-1.0); 
float farPlaneZ=-projMtx[3][2]/(projMtx[2][2]+1.0);
#else
float nearPlaneZ=-projMtx[3][2]/(projMtx[2][2]+1.0); 
float farPlaneZ=-projMtx[3][2]/(projMtx[2][2]-1.0);
#endif
float ssShadow=shadowOpacity.y *
screenSpaceShadow(VP2.xyz,VL,Resolution,nearPlaneZ,farPlaneZ,
abs(2.0*noise.z-1.0));opacity=max(opacity,ssShadow);
#ifdef COLOR_SHADOWS
vec3 light=pdf<1e-6 ? vec3(0.0) : vec3(cosNL)/vec3(pdf)*ibl;shadowedLight+=light*opacity;totalLight+=light;
#else
float rcos=(1.0-cosNL);shadowAccum+=(1.0-opacity*(1.0-pow(rcos,8.0)));sampleWeight+=1.0;vec3 VR=-(viewMtx*vec4(reflect(-L.xyz,N),0.0)).xyz;specShadowAccum+=max(1.0-(opacity*pow(VR.z,8.0)),0.0);
#endif
}
noise.z=fract(noise.z+GOLD);}
#ifdef COLOR_SHADOWS
vec3 shadow=(totalLight-shadowedLight)/totalLight;float maxShadow=max(max(shadow.x,max(shadow.y,shadow.z)),1.0);glFragColor=vec4(shadow/maxShadow,1.0);
#else
#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
gl_FragColor=vec4(shadowAccum/float(sampleWeight),
specShadowAccum/float(sampleWeight),heat/float(sampleWeight),1.0);
#else
gl_FragColor=vec4(shadowAccum/float(sampleWeight),specShadowAccum/float(sampleWeight),0.0,1.0);
#endif
#endif
}`;g.ShadersStore[_P]||(g.ShadersStore[_P]=E8);Are={name:_P,shader:E8}});var Ix,A8=S(()=>{ie();Wr();hh();ch();Ee();Ix=class{get voxelShadowOpacity(){return this._voxelShadowOpacity}set voxelShadowOpacity(e){this._voxelShadowOpacity=e}get ssShadowOpacity(){return this._ssShadowOpacity}set ssShadowOpacity(e){this._ssShadowOpacity=e}get sssSamples(){return this._sssSamples}set sssSamples(e){this._sssSamples=e}get sssStride(){return this._sssStride}set sssStride(e){this._sssStride=e}get sssMaxDist(){return this._sssMaxDist}set sssMaxDist(e){this._sssMaxDist=e}get sssThickness(){return this._sssThickness}set sssThickness(e){this._sssThickness=e}get voxelNormalBias(){return this._voxelNormalBias}set voxelNormalBias(e){this._voxelNormalBias=e}get voxelDirectionBias(){return this._voxelDirectionBias}set voxelDirectionBias(e){this._voxelDirectionBias=e}get sampleDirections(){return this._sampleDirections}set sampleDirections(e){this._sampleDirections=e}get envRotation(){return this._envRotation}set envRotation(e){this._envRotation=e}getOutputTexture(){return this._outputTexture}getDebugPassPP(){return this._debugPassPP||this._createDebugPass(),this._debugPassPP}get debugPassName(){return this._debugPassName}setWorldScaleMatrix(e){this._invWorldScaleMatrix=e}set coloredShadows(e){this._coloredShadows=e}get coloredShadows(){return this._coloredShadows}setDebugDisplayParams(e,t,i,r){this._debugSizeParams.set(e,t,i,r)}_createDebugPass(){let e=this._engine.isWebGPU;if(!this._debugPassPP){let t={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight(),uniforms:["sizeParams"],samplers:["debugSampler"],engine:this._engine,reusable:!0,shaderLanguage:e?1:0,extraInitializations:(i,r)=>{i?r.push(Promise.resolve().then(()=>(Rx(),Ax))):r.push(Promise.resolve().then(()=>(Cx(),bx)))}};this._debugPassPP=new at(this.debugPassName,"iblShadowDebug",t),this._debugPassPP.autoClear=!1,this._debugPassPP.onApplyObservable.add(i=>{i.setTexture("debugSampler",this._outputTexture),i.setVector4("sizeParams",this._debugSizeParams)})}}constructor(e,t){this._voxelShadowOpacity=1,this._sssSamples=16,this._sssStride=8,this._sssMaxDist=.05,this._sssThickness=.5,this._ssShadowOpacity=1,this._cameraInvView=B.Identity(),this._cameraInvProj=B.Identity(),this._invWorldScaleMatrix=B.Identity(),this._frameId=0,this._sampleDirections=4,this._shadowParameters=new Oe(0,0,0,0),this._sssParameters=new Oe(0,0,0,0),this._opacityParameters=new Oe(0,0,0,0),this._voxelBiasParameters=new Oe(0,0,0,0),this._voxelNormalBias=1.4,this._voxelDirectionBias=1.75,this.enabled=!0,this.debugEnabled=!1,this._debugPassName="Voxel Tracing Debug Pass",this._envRotation=0,this._coloredShadows=!1,this._debugVoxelMarchEnabled=!1,this._debugSizeParams=new Oe(0,0,0,0),this._renderWhenGBufferReady=null,this._scene=e,this._engine=e.getEngine(),this._renderPipeline=t,this._createTextures()}_createTextures(){let e=this._createDefines(),t=this._engine.isWebGPU,i={type:0,format:5,samplingMode:1,generateDepthBuffer:!1,shaderLanguage:t?1:0,extraInitializationsAsync:async()=>{t?await Promise.all([Promise.resolve().then(()=>(S8(),v8))]):await Promise.all([Promise.resolve().then(()=>(x8(),T8))])}};this._outputTexture=new ci("voxelTracingPass",{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},"iblShadowVoxelTracing",this._scene,i),this._outputTexture.refreshRate=-1,this._outputTexture.autoClear=!1,this._outputTexture.defines=e,this._setBindings(this._scene.activeCamera),this._renderWhenGBufferReady=this._render.bind(this),this._renderPipeline.onVoxelizationCompleteObservable.addOnce(()=>{this._scene.geometryBufferRenderer.getGBuffer().onAfterRenderObservable.add(this._renderWhenGBufferReady)})}_createDefines(){let e="";return this._scene.useRightHandedSystem&&(e+=`#define RIGHT_HANDED
`),this._debugVoxelMarchEnabled&&(e+=`#define VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION 1u
`),this._coloredShadows&&(e+=`#define COLOR_SHADOWS 1u
`),e}_setBindings(e){this._outputTexture.defines=this._createDefines(),this._outputTexture.setMatrix("viewMtx",e.getViewMatrix()),this._outputTexture.setMatrix("projMtx",e.getProjectionMatrix()),e.getProjectionMatrix().invertToRef(this._cameraInvProj),e.getViewMatrix().invertToRef(this._cameraInvView),this._outputTexture.setMatrix("invProjMtx",this._cameraInvProj),this._outputTexture.setMatrix("invViewMtx",this._cameraInvView),this._outputTexture.setMatrix("wsNormalizationMtx",this._invWorldScaleMatrix),this._frameId++;let t=0;this._scene.environmentTexture&&(t=this._scene.environmentTexture.rotationY??0),t=this._scene.useRightHandedSystem?-(t+.5*Math.PI):t-.5*Math.PI,t=t%(2*Math.PI),this._shadowParameters.set(this._sampleDirections,this._frameId,1,t),this._outputTexture.setVector4("shadowParameters",this._shadowParameters);let i=this._renderPipeline._getVoxelGridTexture(),r=Math.floor(Math.log2(i.getSize().width));this._voxelBiasParameters.set(this._voxelNormalBias,this._voxelDirectionBias,r,0),this._outputTexture.setVector4("voxelBiasParameters",this._voxelBiasParameters),this._sssParameters.set(this._sssSamples,this._sssStride,this._sssMaxDist,this._sssThickness),this._outputTexture.setVector4("sssParameters",this._sssParameters),this._opacityParameters.set(this._voxelShadowOpacity,this._ssShadowOpacity,0,0),this._outputTexture.setVector4("shadowOpacity",this._opacityParameters),this._outputTexture.setTexture("voxelGridSampler",i),this._outputTexture.setTexture("blueNoiseSampler",this._renderPipeline._getNoiseTexture());let n=this._scene.iblCdfGenerator;if(!n)return P.Warn("IBLShadowsVoxelTracingPass: Can't bind for render because iblCdfGenerator is not enabled."),!1;this._outputTexture.setTexture("icdfSampler",n.getIcdfTexture()),this._coloredShadows&&this._scene.environmentTexture&&this._outputTexture.setTexture("iblSampler",this._scene.environmentTexture);let a=this._scene.geometryBufferRenderer;if(!a)return P.Warn("IBLShadowsVoxelTracingPass: Can't bind for render because GeometryBufferRenderer is not enabled."),!1;let o=a.getTextureIndex(Ot.SCREENSPACE_DEPTH_TEXTURE_TYPE);this._outputTexture.setTexture("depthSampler",a.getGBuffer().textures[o]);let l=a.getTextureIndex(Ot.NORMAL_TEXTURE_TYPE);return this._outputTexture.setTexture("worldNormalSampler",a.getGBuffer().textures[l]),!0}_render(){this.enabled&&this._outputTexture.isReady()&&this._outputTexture.getEffect()?.isReady()&&this._setBindings(this._scene.activeCamera)&&this._outputTexture.render()}resize(e=1){let t={width:Math.max(1,Math.floor(this._engine.getRenderWidth()*e)),height:Math.max(1,Math.floor(this._engine.getRenderHeight()*e))};this._outputTexture.getSize().width===t.width&&this._outputTexture.getSize().height===t.height||this._outputTexture.resize(t,!1)}isReady(){return this._outputTexture.isReady()&&!(this._debugPassPP&&!this._debugPassPP.isReady())&&this._scene.iblCdfGenerator&&this._scene.iblCdfGenerator.getIcdfTexture().isReady()&&this._renderPipeline._getVoxelGridTexture().isReady()}dispose(){this._scene.geometryBufferRenderer&&this._renderWhenGBufferReady&&this._scene.geometryBufferRenderer.getGBuffer().onAfterRenderObservable.removeCallback(this._renderWhenGBufferReady),this._outputTexture.dispose(),this._debugPassPP&&this._debugPassPP.dispose()}}});var b8={};V(b8,{iblShadowSpatialBlurPixelShaderWGSL:()=>Rre});var gP,R8,Rre,C8=S(()=>{O();gP="iblShadowSpatialBlurPixelShader",R8=`#define PI 3.1415927
varying vUV: vec2f;var depthSampler: texture_2d<f32>;var worldNormalSampler: texture_2d<f32>;var voxelTracingSampler : texture_2d<f32>;uniform blurParameters: vec4f;
#define stridef uniforms.blurParameters.x
#define worldScale uniforms.blurParameters.y
const weights=array<f32,5>(0.0625,0.25,0.375,0.25,0.0625);const nbWeights: i32=5;fn max2(v: vec2f,w: vec2f)->vec2f {return vec2f(max(v.x,w.x),max(v.y,w.y));}
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var gbufferRes=vec2f(textureDimensions(depthSampler,0));var gbufferPixelCoord= vec2i(fragmentInputs.vUV*gbufferRes);var shadowRes=vec2f(textureDimensions(voxelTracingSampler,0));var shadowPixelCoord= vec2i(fragmentInputs.vUV*shadowRes);var N: vec3f=textureLoad(worldNormalSampler,gbufferPixelCoord,0).xyz;if (length(N)<0.01) {fragmentOutputs.color=vec4f(1.0,1.0,0.0,1.0);return fragmentOutputs;}
var depth: f32=-textureLoad(depthSampler,gbufferPixelCoord,0).x;var X: vec4f= vec4f(0.0);for(var y: i32=0; y<nbWeights; y++) {for(var x: i32=0; x<nbWeights; x++) {var gBufferCoords: vec2i=gbufferPixelCoord+i32(stridef)*vec2i(x-(nbWeights>>1),y-(nbWeights>>1));var shadowCoords: vec2i=shadowPixelCoord+i32(stridef)*vec2i(x-(nbWeights>>1),y-(nbWeights>>1));var T : vec3f=textureLoad(voxelTracingSampler,shadowCoords,0).xyz;var ddepth: f32=-textureLoad(depthSampler,gBufferCoords,0).x-depth;var dN: vec3f=textureLoad(worldNormalSampler,gBufferCoords,0).xyz-N;var w: f32=weights[x]*weights[y] *
exp2(max(-1000.0/(worldScale*worldScale),-0.5) *
(ddepth*ddepth) -
1e1*dot(dN,dN));X+= vec4f(w*T.x,w*T.y,w*T.z,w);}}
fragmentOutputs.color= vec4f(X.x/X.w,X.y/X.w,X.z/X.w,1.0);}`;g.ShadersStoreWGSL[gP]||(g.ShadersStoreWGSL[gP]=R8);Rre={name:gP,shader:R8}});var y8={};V(y8,{iblShadowSpatialBlurPixelShader:()=>bre});var vP,I8,bre,M8=S(()=>{O();vP="iblShadowSpatialBlurPixelShader",I8=`precision highp sampler2D;
#define PI 3.1415927
varying vec2 vUV;uniform sampler2D depthSampler;uniform sampler2D worldNormalSampler;uniform sampler2D voxelTracingSampler;uniform vec4 blurParameters;
#define stridef blurParameters.x
#define worldScale blurParameters.y
const float weights[5]=float[5](0.0625,0.25,0.375,0.25,0.0625);const int nbWeights=5;vec2 max2(vec2 v,vec2 w) {return vec2(max(v.x,w.x),max(v.y,w.y));}
void main(void)
{vec2 gbufferRes=vec2(textureSize(depthSampler,0));ivec2 gbufferPixelCoord=ivec2(vUV*gbufferRes);vec2 shadowRes=vec2(textureSize(voxelTracingSampler,0));ivec2 shadowPixelCoord=ivec2(vUV*shadowRes);vec3 N=texelFetch(worldNormalSampler,gbufferPixelCoord,0).xyz;if (length(N)<0.01) {glFragColor=vec4(1.0,1.0,0.0,1.0);return;}
float depth=-texelFetch(depthSampler,gbufferPixelCoord,0).x;vec4 X=vec4(0.0);for(int y=0; y<nbWeights; ++y) {for(int x=0; x<nbWeights; ++x) {ivec2 gBufferCoords=gbufferPixelCoord+int(stridef)*ivec2(x-(nbWeights>>1),y-(nbWeights>>1));ivec2 shadowCoords=shadowPixelCoord+int(stridef)*ivec2(x-(nbWeights>>1),y-(nbWeights>>1));vec4 T=texelFetch(voxelTracingSampler,shadowCoords,0);float ddepth=-texelFetch(depthSampler,gBufferCoords,0).x-depth;vec3 dN=texelFetch(worldNormalSampler,gBufferCoords,0).xyz-N;float w=weights[x]*weights[y] *
exp2(max(-1000.0/(worldScale*worldScale),-0.5) *
(ddepth*ddepth) -
1e1*dot(dN,dN));X+=vec4(w*T.x,w*T.y,w*T.z,w);}}
gl_FragColor=vec4(X.x/X.w,X.y/X.w,X.z/X.w,1.0);}`;g.ShadersStore[vP]||(g.ShadersStore[vP]=I8);bre={name:vP,shader:I8}});var yx,P8=S(()=>{ie();Wr();hh();ch();yx=class{getOutputTexture(){return this._outputTexture}getDebugPassPP(){return this._debugPassPP||this._createDebugPass(),this._debugPassPP}get debugPassName(){return this._debugPassName}setWorldScale(e){this._worldScale=e}setDebugDisplayParams(e,t,i,r){this._debugSizeParams.set(e,t,i,r)}_createDebugPass(){if(!this._debugPassPP){let e=this._engine.isWebGPU,t={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight(),textureFormat:5,textureType:0,samplingMode:1,uniforms:["sizeParams"],samplers:["debugSampler"],engine:this._engine,reusable:!1,shaderLanguage:e?1:0,extraInitializations:(i,r)=>{i?r.push(Promise.resolve().then(()=>(Rx(),Ax))):r.push(Promise.resolve().then(()=>(Cx(),bx)))}};this._debugPassPP=new at(this.debugPassName,"iblShadowDebug",t),this._debugPassPP.autoClear=!1,this._debugPassPP.onApplyObservable.add(i=>{i.setTexture("debugSampler",this._outputTexture),i.setVector4("sizeParams",this._debugSizeParams)})}}constructor(e,t){this._worldScale=1,this._blurParameters=new Oe(0,0,0,0),this.enabled=!0,this._debugPassName="Spatial Blur Debug Pass",this.debugEnabled=!1,this._debugSizeParams=new Oe(0,0,0,0),this._renderWhenGBufferReady=null,this._scene=e,this._engine=e.getEngine(),this._renderPipeline=t,this._createTextures()}_createTextures(){let e=this._engine.isWebGPU,t={type:0,format:5,samplingMode:1,generateDepthBuffer:!1,generateMipMaps:!1,shaderLanguage:e?1:0,extraInitializationsAsync:async()=>{e?await Promise.all([Promise.resolve().then(()=>(C8(),b8))]):await Promise.all([Promise.resolve().then(()=>(M8(),y8))])}};this._outputTexture=new ci("spatialBlurPass",{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},"iblShadowSpatialBlur",this._scene,t,!1,!1,0),this._outputTexture.refreshRate=-1,this._outputTexture.autoClear=!1,this._setBindings(),this._renderWhenGBufferReady=this._render.bind(this),this._renderPipeline.onVoxelizationCompleteObservable.addOnce(()=>{this._scene.geometryBufferRenderer.getGBuffer().onAfterRenderObservable.add(this._renderWhenGBufferReady)})}_setBindings(){this._outputTexture.setTexture("voxelTracingSampler",this._renderPipeline._getVoxelTracingTexture()),this._blurParameters.set(1,this._worldScale,0,0),this._outputTexture.setVector4("blurParameters",this._blurParameters);let t=this._scene.geometryBufferRenderer;if(!t)return!1;let i=t.getTextureIndex(Ot.SCREENSPACE_DEPTH_TEXTURE_TYPE);this._outputTexture.setTexture("depthSampler",t.getGBuffer().textures[i]);let r=t.getTextureIndex(Ot.NORMAL_TEXTURE_TYPE);return this._outputTexture.setTexture("worldNormalSampler",t.getGBuffer().textures[r]),!0}_render(){this.enabled&&this._outputTexture.isReady()&&this._outputTexture.getEffect()?.isReady()&&this._setBindings()&&this._outputTexture.render()}resize(e=1){let t={width:Math.max(1,Math.floor(this._engine.getRenderWidth()*e)),height:Math.max(1,Math.floor(this._engine.getRenderHeight()*e))};this._outputTexture.getSize().width===t.width&&this._outputTexture.getSize().height===t.height||this._outputTexture.resize(t,!1)}isReady(){return this._outputTexture.isReady()&&!(this._debugPassPP&&!this._debugPassPP.isReady())}dispose(){this._scene.geometryBufferRenderer&&this._renderWhenGBufferReady&&this._scene.geometryBufferRenderer.getGBuffer().onAfterRenderObservable.removeCallback(this._renderWhenGBufferReady),this._outputTexture.dispose(),this._debugPassPP&&this._debugPassPP.dispose()}}});var O8={};V(O8,{iblShadowAccumulationPixelShaderWGSL:()=>Cre});var SP,D8,Cre,L8=S(()=>{O();SP="iblShadowAccumulationPixelShader",D8=`varying vUV: vec2f;uniform accumulationParameters: vec4f;
#define remanence uniforms.accumulationParameters.x
#define resetb uniforms.accumulationParameters.y
#define sceneSize uniforms.accumulationParameters.z
var motionSampler: texture_2d<f32>;var positionSampler: texture_2d<f32>;var spatialBlurSampler : texture_2d<f32>;var oldAccumulationSamplerSampler: sampler;var oldAccumulationSampler: texture_2d<f32>;var prevPositionSamplerSampler: sampler;var prevPositionSampler: texture_2d<f32>;fn max2(v: vec2f,w: vec2f)->vec2f { 
return vec2f(max(v.x,w.x),max(v.y,w.y)); }
fn lessThan(x: vec2f,y: vec2f)->vec2<bool> {return x<y;}
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var reset: bool= bool(resetb);var gbufferRes : vec2f=vec2f(textureDimensions(positionSampler,0));var gbufferPixelCoord: vec2i= vec2i(input.vUV*gbufferRes);var shadowRes : vec2f=vec2f(textureDimensions(spatialBlurSampler,0));var shadowPixelCoord: vec2i= vec2i(input.vUV*shadowRes);var LP: vec4f=textureLoad(positionSampler,gbufferPixelCoord,0);if (0.0==LP.w) {fragmentOutputs.color=vec4f(1.0,0.0,0.0,1.0);return fragmentOutputs;}
var velocityColor: vec2f=textureLoad(motionSampler,gbufferPixelCoord,0).xy;var prevCoord: vec2f=input.vUV+velocityColor;var PrevLP: vec3f=textureSampleLevel(prevPositionSampler,prevPositionSamplerSampler,prevCoord,0.0).xyz;var PrevShadows: vec4f=textureSampleLevel(oldAccumulationSampler,oldAccumulationSamplerSampler,prevCoord,0.0);var newShadows : vec3f=textureLoad(spatialBlurSampler,shadowPixelCoord,0).xyz;PrevShadows.a=select(1.0,max(PrevShadows.a/(1.0+PrevShadows.a),1.0-remanence),!reset && all(lessThan(abs(prevCoord- vec2f(0.5)), vec2f(0.5))) &&
distance(LP.xyz,PrevLP)<5e-2*sceneSize);PrevShadows=max( vec4f(0.0),PrevShadows);fragmentOutputs.color= vec4f(mix(PrevShadows.x,newShadows.x,PrevShadows.a),
mix(PrevShadows.y,newShadows.y,PrevShadows.a),
mix(PrevShadows.z,newShadows.z,PrevShadows.a),PrevShadows.a);}`;g.ShadersStoreWGSL[SP]||(g.ShadersStoreWGSL[SP]=D8);Cre={name:SP,shader:D8}});var F8={};V(F8,{iblShadowAccumulationPixelShader:()=>Ire});var EP,w8,Ire,N8=S(()=>{O();EP="iblShadowAccumulationPixelShader",w8=`#ifdef GL_ES
precision mediump float;
#endif
varying vec2 vUV;uniform vec4 accumulationParameters;
#define remanence accumulationParameters.x
#define resetb accumulationParameters.y
#define sceneSize accumulationParameters.z
uniform sampler2D motionSampler;uniform sampler2D positionSampler;uniform sampler2D spatialBlurSampler;uniform sampler2D oldAccumulationSampler;uniform sampler2D prevPositionSampler;vec2 max2(vec2 v,vec2 w) { return vec2(max(v.x,w.x),max(v.y,w.y)); }
void main(void) {bool reset=bool(resetb);vec2 gbufferRes=vec2(textureSize(motionSampler,0));ivec2 gbufferPixelCoord=ivec2(vUV*gbufferRes);vec2 shadowRes=vec2(textureSize(spatialBlurSampler,0));ivec2 shadowPixelCoord=ivec2(vUV*shadowRes);vec4 LP=texelFetch(positionSampler,gbufferPixelCoord,0);if (0.0==LP.w) {gl_FragColor=vec4(1.0,0.0,0.0,1.0);return;}
vec2 velocityColor=texelFetch(motionSampler,gbufferPixelCoord,0).xy;vec2 prevCoord=vUV+velocityColor;vec3 PrevLP=texture(prevPositionSampler,prevCoord).xyz;vec4 PrevShadows=texture(oldAccumulationSampler,prevCoord);vec3 newShadows=texelFetch(spatialBlurSampler,shadowPixelCoord,0).xyz;PrevShadows.a =
!reset && all(lessThan(abs(prevCoord-vec2(0.5)),vec2(0.5))) &&
distance(LP.xyz,PrevLP)<5e-2*sceneSize
? max(PrevShadows.a/(1.0+PrevShadows.a),1.0-remanence)
: 1.0;PrevShadows=max(vec4(0.0),PrevShadows);gl_FragColor =
vec4(mix(PrevShadows.x,newShadows.x,PrevShadows.a),
mix(PrevShadows.y,newShadows.y,PrevShadows.a),
mix(PrevShadows.z,newShadows.z,PrevShadows.a),PrevShadows.a);}`;g.ShadersStore[EP]||(g.ShadersStore[EP]=w8);Ire={name:EP,shader:w8}});var Mx,B8=S(()=>{ie();Wr();hh();ch();we();Mx=class{getOutputTexture(){return this._outputTexture}getDebugPassPP(){return this._debugPassPP||this._createDebugPass(),this._debugPassPP}get debugPassName(){return this._debugPassName}get remanence(){return this._remanence}set remanence(e){this._remanence=e}get reset(){return this._reset}set reset(e){this._reset=e}set isMoving(e){this._isMoving=e}setDebugDisplayParams(e,t,i,r){this._debugSizeParams.set(e,t,i,r)}_createDebugPass(){if(!this._debugPassPP){let e=this._engine.isWebGPU,t={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight(),textureFormat:5,textureType:0,samplingMode:1,uniforms:["sizeParams"],samplers:["debugSampler"],engine:this._engine,reusable:!1,shaderLanguage:e?1:0,extraInitializations:(i,r)=>{i?r.push(Promise.resolve().then(()=>(Rx(),Ax))):r.push(Promise.resolve().then(()=>(Cx(),bx)))}};this._debugPassPP=new at(this.debugPassName,"iblShadowDebug",t),this._debugPassPP.autoClear=!1,this._debugPassPP.onApplyObservable.add(i=>{i.setTexture("debugSampler",this._outputTexture),i.setVector4("sizeParams",this._debugSizeParams)})}}constructor(e,t){this._accumulationParams=new Oe(0,0,0,0),this.debugEnabled=!1,this.enabled=!0,this.onReadyObservable=new N,this._debugPassName="Shadow Accumulation Debug Pass",this._remanence=.9,this._reset=!0,this._isMoving=!1,this._debugSizeParams=new Oe(0,0,0,0),this._renderWhenGBufferReady=null,this._scene=e,this._engine=e.getEngine(),this._renderPipeline=t,this._createTextures()}_createTextures(){let e=this._engine.isWebGPU,t={type:2,format:5,samplingMode:1,generateDepthBuffer:!1,generateMipMaps:!1,shaderLanguage:e?1:0,extraInitializationsAsync:async()=>{e?await Promise.all([Promise.resolve().then(()=>(L8(),O8))]):await Promise.all([Promise.resolve().then(()=>(N8(),F8))])}};this._outputTexture=new ci("shadowAccumulationPass",{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},"iblShadowAccumulation",this._scene,t),this._outputTexture.refreshRate=1,this._outputTexture.autoClear=!1,this._outputTexture.onGeneratedObservable.addOnce(()=>{this.onReadyObservable.notifyObservers()}),this._setOutputTextureBindings(),this._renderWhenGBufferReady=this._render.bind(this),this._renderPipeline.onVoxelizationCompleteObservable.addOnce(()=>{this._scene.geometryBufferRenderer.getGBuffer().onAfterRenderObservable.add(this._renderWhenGBufferReady)});let i={type:2,format:5,samplingMode:1,generateDepthBuffer:!1,generateMipMaps:!1,shaderLanguage:e?1:0,extraInitializationsAsync:async()=>{e?await Promise.all([Promise.resolve().then(()=>(fm(),cm))]):await Promise.all([Promise.resolve().then(()=>(Bh(),Nh))])}};this._oldAccumulationCopy=new ci("oldAccumulationRT",{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},"pass",this._scene,i,!1),this._oldAccumulationCopy.autoClear=!1,this._oldAccumulationCopy.refreshRate=1,this._oldAccumulationCopy.onBeforeGenerationObservable.add(this._setAccumulationCopyBindings.bind(this)),this._setAccumulationCopyBindings();let r={type:2,format:5,samplingMode:1,generateDepthBuffer:!1,generateMipMaps:!1,shaderLanguage:e?1:0,extraInitializationsAsync:async()=>{e?await Promise.all([Promise.resolve().then(()=>(fm(),cm))]):await Promise.all([Promise.resolve().then(()=>(Bh(),Nh))])}};this._oldPositionCopy=new ci("oldLocalPositionRT",{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},"pass",this._scene,r,!1),this._updatePositionCopy(),this._oldPositionCopy.autoClear=!1,this._oldPositionCopy.refreshRate=1,this._oldPositionCopy.onBeforeGenerationObservable.add(this._updatePositionCopy.bind(this))}_setOutputTextureBindings(){let e=this._isMoving?this.remanence:.99;this._accumulationParams.set(e,this.reset?1:0,this._renderPipeline.voxelGridSize,0),this._outputTexture.setTexture("spatialBlurSampler",this._renderPipeline._getSpatialBlurTexture()),this._outputTexture.setVector4("accumulationParameters",this._accumulationParams),this._outputTexture.setTexture("oldAccumulationSampler",this._oldAccumulationCopy?this._oldAccumulationCopy:this._renderPipeline._dummyTexture2d),this._outputTexture.setTexture("prevPositionSampler",this._oldPositionCopy?this._oldPositionCopy:this._renderPipeline._dummyTexture2d);let t=this._scene.geometryBufferRenderer;if(!t)return!1;let i=t.getTextureIndex(Ot.VELOCITY_LINEAR_TEXTURE_TYPE);this._outputTexture.setTexture("motionSampler",t.getGBuffer().textures[i]);let r=t.getTextureIndex(Ot.POSITION_TEXTURE_TYPE);return this._outputTexture.setTexture("positionSampler",t.getGBuffer().textures[r]),this.reset=!1,this._isMoving=!1,!0}_updatePositionCopy(){let e=this._scene.geometryBufferRenderer,t=e.getTextureIndex(Ot.POSITION_TEXTURE_TYPE);this._oldPositionCopy.setTexture("textureSampler",e.getGBuffer().textures[t])}_setAccumulationCopyBindings(){this._oldAccumulationCopy.setTexture("textureSampler",this._outputTexture)}_render(){this.enabled&&this._outputTexture.isReady()&&this._outputTexture.getEffect()?.isReady()&&this._setOutputTextureBindings()&&this._outputTexture.render()}resize(e=1){let t={width:Math.max(1,Math.floor(this._engine.getRenderWidth()*e)),height:Math.max(1,Math.floor(this._engine.getRenderHeight()*e))};this._outputTexture.getSize().width===t.width&&this._outputTexture.getSize().height===t.height||(this._outputTexture.resize(t,!1),this._oldAccumulationCopy.resize(t,!1),this._oldPositionCopy.resize({width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},!1),this.reset=!0)}_disposeTextures(){this._oldAccumulationCopy.dispose(),this._oldPositionCopy.dispose(),this._outputTexture.dispose()}isReady(){return this._oldAccumulationCopy&&this._oldAccumulationCopy.isReady()&&this._oldPositionCopy&&this._oldPositionCopy.isReady()&&this._outputTexture.isReady()&&!(this._debugPassPP&&!this._debugPassPP.isReady())}dispose(){this._scene.geometryBufferRenderer&&this._renderWhenGBufferReady&&this._scene.geometryBufferRenderer.getGBuffer().onAfterRenderObservable.removeCallback(this._renderWhenGBufferReady),this._disposeTextures(),this._debugPassPP&&this._debugPassPP.dispose(),this.onReadyObservable.clear()}}});var bd,U8=S(()=>{Ye();$e();je();ym();bd=class{get name(){return this._name}get cameras(){return this._cameras}get engine(){return this._engine}constructor(e,t){this._engine=e,this.uniqueId=xa.UniqueId,this._name=t,this._renderEffects={},this._renderEffectsForIsolatedPass=new Array,this._cameras=[]}getClassName(){return"PostProcessRenderPipeline"}get isSupported(){for(let e in this._renderEffects)if(Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&!this._renderEffects[e].isSupported)return!1;return!0}addEffect(e){this._renderEffects[e._name]=e}_rebuild(){}_enableEffect(e,t){let i=this._renderEffects[e];i&&i._enable(W.MakeArray(t||this._cameras))}_disableEffect(e,t){let i=this._renderEffects[e];i&&i._disable(W.MakeArray(t||this._cameras))}_attachCameras(e,t){let i=W.MakeArray(e||this._cameras);if(!i)return;let r=[],n;for(n=0;n<i.length;n++){let a=i[n];a&&(this._cameras.indexOf(a)===-1?this._cameras.push(a):t&&r.push(n))}for(n=0;n<r.length;n++)i.splice(r[n],1);for(let a in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,a)&&this._renderEffects[a]._attachCameras(i)}_detachCameras(e){let t=W.MakeArray(e||this._cameras);if(t){for(let i in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,i)&&this._renderEffects[i]._detachCameras(t);for(let i=0;i<t.length;i++)this._cameras.splice(this._cameras.indexOf(t[i]),1)}}_update(){for(let e in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&this._renderEffects[e]._update();for(let e=0;e<this._cameras.length;e++){if(!this._cameras[e])continue;let t=this._cameras[e].name;this._renderEffectsForIsolatedPass[t]&&this._renderEffectsForIsolatedPass[t]._update()}}_reset(){this._renderEffects={},this._renderEffectsForIsolatedPass=new Array}_enableMSAAOnFirstPostProcess(e){if(!this._engine._features.supportMSAA)return!1;let t=Object.keys(this._renderEffects);if(t.length>0){let i=this._renderEffects[t[0]].getPostProcesses();i&&(i[0].samples=e)}return!0}_adaptPostProcessesToViewPort(){let e=Object.keys(this._renderEffects);for(let t of e){let i=this._renderEffects[t].getPostProcesses();if(i)for(let r of i)r.adaptScaleToCurrentViewport=!0}}setPrePassRenderer(e){return!1}dispose(){}};x([y()],bd.prototype,"_name",void 0)});var Px,G8=S(()=>{$e();Px=class{constructor(e,t,i,r=!0){this._name=t,this._singleInstance=r,this._getPostProcesses=i,this._cameras={},this._indicesForCamera={},this._postProcesses={}}get isSupported(){for(let e in this._postProcesses)if(Object.prototype.hasOwnProperty.call(this._postProcesses,e)){let t=this._postProcesses[e];for(let i=0;i<t.length;i++)if(!t[i].isSupported)return!1}return!0}_update(){}_attachCameras(e){let t,i=W.MakeArray(e||this._cameras);if(i)for(let r=0;r<i.length;r++){let n=i[r];if(!n)continue;let a=n.name;if(this._singleInstance?t=0:t=a,!this._postProcesses[t]){let l=this._getPostProcesses();l&&(this._postProcesses[t]=Array.isArray(l)?l:[l])}this._indicesForCamera[a]||(this._indicesForCamera[a]=[]);let o=this._postProcesses[t];for(let l of o){let c=n.attachPostProcess(l);this._indicesForCamera[a].push(c)}this._cameras[a]||(this._cameras[a]=n)}}_detachCameras(e){let t=W.MakeArray(e||this._cameras);if(t)for(let i=0;i<t.length;i++){let r=t[i],n=r.name,a=this._postProcesses[this._singleInstance?0:n];if(a)for(let o of a)r.detachPostProcess(o);this._cameras[n]&&(this._cameras[n]=null),delete this._indicesForCamera[n]}}_enable(e){let t=W.MakeArray(e||this._cameras);if(t)for(let i=0;i<t.length;i++){let r=t[i],n=r.name,a=this._singleInstance?0:n;for(let o=0;o<this._indicesForCamera[n].length;o++){let l=this._indicesForCamera[n][o],c=r._postProcesses[l];c==null&&t[i].attachPostProcess(this._postProcesses[a][o],l)}}}_disable(e){let t=W.MakeArray(e||this._cameras);if(t)for(let i=0;i<t.length;i++){let r=t[i],n=r.name,a=this._postProcesses[this._singleInstance?0:n];for(let o of a)r.detachPostProcess(o)}}getPostProcesses(e){return this._singleInstance?this._postProcesses[0]:e?this._postProcesses[e.name]:null}}});var Dx,V8=S(()=>{Ut();Dx=class extends H{get width(){return this._texture?this._texture.width:0}get height(){return this._texture?this._texture.height:0}get depth(){return this._texture?this._texture.depth:0}constructor(e,t,i,r,n,a,o=!0,l=!1,c=H.TRILINEAR_SAMPLINGMODE,f=0,h){super(null,a,!o,l),this.format=n,this._texture=a.getEngine().createRawTexture3D(e,t,i,r,n,o,l,c,null,f,h),this.is3D=!0}update(e){this._texture&&this._getEngine().updateRawTexture3D(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type)}}});var TP,is,k8=S(()=>{Ye();fs();Ya();Q_();je();Te();TP=class extends ri{constructor(){super(...arguments),this.RENDER_WITH_IBL_SHADOWS=!1,this.COLORED_IBL_SHADOWS=!1}},is=class s extends hi{get isColored(){return this._isColored}set isColored(e){this._isColored!==e&&(this._isColored=e,this._markAllSubMeshesAsTexturesDirty())}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e){super(e,s.Name,310,new TP),this.shadowOpacity=1,this._isEnabled=!1,this._isColored=!1,this.isEnabled=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}prepareDefines(e){e.RENDER_WITH_IBL_SHADOWS=this._isEnabled,e.COLORED_IBL_SHADOWS=this.isColored}getClassName(){return"IBLShadowsPluginMaterial"}getUniforms(){return{ubo:[{name:"renderTargetSize",size:2,type:"vec2"},{name:"shadowOpacity",size:1,type:"float"}],fragment:`#ifdef RENDER_WITH_IBL_SHADOWS
                    uniform vec2 renderTargetSize;
                    uniform float shadowOpacity;
                #endif`}}getSamplers(e){e.push("iblShadowsTexture")}bindForSubMesh(e){this._isEnabled&&(e.bindTexture("iblShadowsTexture",this.iblShadowsTexture),e.updateFloat2("renderTargetSize",this._material.getScene().getEngine().getRenderWidth(),this._material.getScene().getEngine().getRenderHeight()),e.updateFloat("shadowOpacity",this.shadowOpacity))}getCustomCode(e,t){let i;return t===1?(i={CUSTOM_FRAGMENT_DEFINITIONS:`
                #ifdef RENDER_WITH_IBL_SHADOWS
                    var iblShadowsTextureSampler: sampler;
                    var iblShadowsTexture: texture_2d<f32>;

                    #ifdef COLORED_IBL_SHADOWS
                        fn computeIndirectShadow() -> vec3f {
                            var uv = fragmentInputs.position.xy / uniforms.renderTargetSize;
                            var shadowValue: vec3f = textureSample(iblShadowsTexture, iblShadowsTextureSampler, uv).rgb;
                            return mix(shadowValue, vec3f(1.0), 1.0 - uniforms.shadowOpacity);
                        }
                    #else
                        fn computeIndirectShadow() -> vec2f {
                            var uv = fragmentInputs.position.xy / uniforms.renderTargetSize;
                            var shadowValue: vec2f = textureSample(iblShadowsTexture, iblShadowsTextureSampler, uv).rg;
                            return mix(shadowValue, vec2f(1.0), 1.0 - uniforms.shadowOpacity);
                        }
                    #endif
                #endif
            `},this._material instanceof Ft?i.CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION=`
                #ifdef RENDER_WITH_IBL_SHADOWS
                    #ifndef UNLIT
                        #ifdef REFLECTION
                            #ifdef COLORED_IBL_SHADOWS
                                var shadowValue: vec3f = computeIndirectShadow();
                                finalIrradiance *= shadowValue;
                                finalRadianceScaled *= mix(vec3f(1.0), shadowValue, roughness);
                            #else
                                var shadowValue: vec2f = computeIndirectShadow();
                                finalIrradiance *= vec3f(shadowValue.x);
                                finalRadianceScaled *= vec3f(mix(pow(shadowValue.y, 4.0), shadowValue.x, roughness));
                            #endif
                        #endif
                    #else
                        finalDiffuse *= computeIndirectShadow().x;
                    #endif
                #endif
            `:i.CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR=`
                #ifdef RENDER_WITH_IBL_SHADOWS
                    #ifdef COLORED_IBL_SHADOWS
                        var shadowValue: vec3f = computeIndirectShadow();
                        color *= toGammaSpace(vec4f(shadowValue, 1.0f));
                    #else
                        var shadowValue: vec2f = computeIndirectShadow();
                        color *= toGammaSpace(vec4f(shadowValue.x, shadowValue.x, shadowValue.x, 1.0f));
                    #endif
                #endif
            `):(i={CUSTOM_FRAGMENT_DEFINITIONS:`
                #ifdef RENDER_WITH_IBL_SHADOWS
                    uniform sampler2D iblShadowsTexture;
                #ifdef COLORED_IBL_SHADOWS
                    vec3 computeIndirectShadow() {
                        vec2 uv = gl_FragCoord.xy / renderTargetSize;
                        vec3 shadowValue = texture2D(iblShadowsTexture, uv).rgb;
                        return mix(shadowValue.rgb, vec3(1.0), 1.0 - shadowOpacity);
                    }
                #else
                    vec2 computeIndirectShadow() {
                        vec2 uv = gl_FragCoord.xy / renderTargetSize;
                        vec2 shadowValue = texture2D(iblShadowsTexture, uv).rg;
                        return mix(shadowValue.rg, vec2(1.0), 1.0 - shadowOpacity);
                    }
                #endif
                #endif
            `},this._material instanceof Ft?i.CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION=`
                #ifdef RENDER_WITH_IBL_SHADOWS
                    #ifndef UNLIT
                        #ifdef REFLECTION
                            #ifdef COLORED_IBL_SHADOWS
                                vec3 shadowValue = computeIndirectShadow();
                                finalIrradiance.rgb *= shadowValue.rgb;
                                finalRadianceScaled *= mix(vec3(1.0), shadowValue.rgb, roughness);
                            #else
                                vec2 shadowValue = computeIndirectShadow();
                                finalIrradiance *= shadowValue.x;
                                finalRadianceScaled *= mix(pow(shadowValue.y, 4.0), shadowValue.x, roughness);
                            #endif
                        #endif
                    #else
                        finalDiffuse *= computeIndirectShadow().x;
                    #endif
                #endif
            `:i.CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR=`
                #ifdef RENDER_WITH_IBL_SHADOWS
                    #ifdef COLORED_IBL_SHADOWS
                        vec3 shadowValue = computeIndirectShadow();
                        color.rgb *= toGammaSpace(shadowValue.rgb);
                    #else
                        vec2 shadowValue = computeIndirectShadow();
                        color.rgb *= toGammaSpace(shadowValue.x);
                    #endif
                #endif
            `),e==="vertex"?null:i}};is.Name="IBLShadowsPluginMaterial";x([y()],is.prototype,"shadowOpacity",void 0);x([y(),z("_markAllSubMeshesAsTexturesDirty")],is.prototype,"isEnabled",void 0);G("BABYLON.IBLShadowsPluginMaterial",is)});var xP,W8=S(()=>{Xr();Pn();hh();Object.defineProperty(ze.prototype,"geometryBufferRenderer",{get:function(){return this._geometryBufferRenderer},set:function(s){s&&s.isSupported&&(this._geometryBufferRenderer=s)},enumerable:!0,configurable:!0});ze.prototype.enableGeometryBufferRenderer=function(s=1,e=15,t){return this._geometryBufferRenderer?this._geometryBufferRenderer:(this._geometryBufferRenderer=new Ot(this,s,e,t),this._geometryBufferRenderer.isSupported||(this._geometryBufferRenderer=null),this._geometryBufferRenderer)};ze.prototype.disableGeometryBufferRenderer=function(){this._geometryBufferRenderer&&(this._geometryBufferRenderer.dispose(),this._geometryBufferRenderer=null)};xP=class{constructor(e){this.name=ne.NAME_GEOMETRYBUFFERRENDERER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(ne.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER,this,this._gatherRenderTargets)}rebuild(){}dispose(){}_gatherRenderTargets(e){this.scene._geometryBufferRenderer&&e.push(this.scene._geometryBufferRenderer.getGBuffer())}};Ot._SceneComponentInitialization=s=>{let e=s._getComponent(ne.NAME_GEOMETRYBUFFERRENDERER);e||(e=new xP(s),s._addComponent(e))}});var H8={};V(H8,{IblCdfGeneratorSceneComponent:()=>Ox});var Ox,AP=S(()=>{Xr();Pn();vx();Object.defineProperty(ze.prototype,"iblCdfGenerator",{get:function(){return this._iblCdfGenerator},set:function(s){s&&(this._iblCdfGenerator=s)},enumerable:!0,configurable:!0});ze.prototype.enableIblCdfGenerator=function(){return this._iblCdfGenerator?this._iblCdfGenerator:(this._iblCdfGenerator=new co(this),this._iblCdfGenerator.isSupported?(this.environmentTexture&&(this._iblCdfGenerator.iblSource=this.environmentTexture),this._iblCdfGenerator):(this._iblCdfGenerator=null,null))};ze.prototype.disableIblCdfGenerator=function(){this._iblCdfGenerator&&(this._iblCdfGenerator.dispose(),this._iblCdfGenerator=null)};Ox=class{constructor(e){this.name=ne.NAME_IBLCDFGENERATOR,this._newIblObserver=null,this.scene=e}register(){this._updateIblSource(),this._newIblObserver=this.scene.onEnvironmentTextureChangedObservable.add(this._updateIblSource.bind(this))}rebuild(){}dispose(){this.scene.onEnvironmentTextureChangedObservable.remove(this._newIblObserver)}_updateIblSource(){this.scene.iblCdfGenerator&&this.scene.environmentTexture&&(this.scene.iblCdfGenerator.iblSource=this.scene.environmentTexture)}};co._SceneComponentInitialization=s=>{let e=s._getComponent(ne.NAME_IBLCDFGENERATOR);e||(e=new Ox(s),s._addComponent(e))}});var X8={};V(X8,{iblShadowGBufferDebugPixelShaderWGSL:()=>yre});var RP,z8,yre,Y8=S(()=>{O();RP="iblShadowGBufferDebugPixelShader",z8=`varying vUV : vec2f;var textureSamplerSampler : sampler;var textureSampler : texture_2d<f32>;var depthSamplerSampler : sampler;var depthSampler : texture_2d<f32>;var normalSamplerSampler : sampler;var normalSampler : texture_2d<f32>;var positionSamplerSampler : sampler;var positionSampler : texture_2d<f32>;var velocitySamplerSampler : sampler;var velocitySampler : texture_2d<f32>;uniform sizeParams : vec4f;
#define offsetX uniforms.sizeParams.x
#define offsetY uniforms.sizeParams.y
#define widthScale uniforms.sizeParams.z
#define heightScale uniforms.sizeParams.w
@fragment fn main(input : FragmentInputs)->FragmentOutputs {var uv : vec2f=
vec2f((offsetX+input.vUV.x)*widthScale,(offsetY+input.vUV.y)*heightScale);var backgroundColour: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV).rgba;var depth : vec4f=textureSample(depthSampler,depthSamplerSampler,input.vUV);var worldNormal: vec4f=textureSample(normalSampler,normalSamplerSampler,input.vUV);var worldPosition : vec4f=textureSample(positionSampler,positionSamplerSampler,input.vUV);var velocityLinear : vec4f=textureSample(velocitySampler,velocitySamplerSampler,input.vUV);if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {fragmentOutputs.color=backgroundColour;} else {if (uv.x<=0.25) {fragmentOutputs.color=vec4f(depth.rgb,1.0);} else if (uv.x<=0.5) {velocityLinear =
vec4f(velocityLinear.r*0.5+0.5,velocityLinear.g*0.5+0.5,
velocityLinear.b,velocityLinear.a);fragmentOutputs.color=vec4f(velocityLinear.rgb,1.0);} else if (uv.x<=0.75) {fragmentOutputs.color=vec4f(worldPosition.rgb,1.0);} else {fragmentOutputs.color=vec4f(worldNormal.rgb,1.0);}}}`;g.ShadersStoreWGSL[RP]||(g.ShadersStoreWGSL[RP]=z8);yre={name:RP,shader:z8}});var q8={};V(q8,{iblShadowGBufferDebugPixelShader:()=>Mre});var bP,K8,Mre,Q8=S(()=>{O();bP="iblShadowGBufferDebugPixelShader",K8=`#ifdef GL_ES
precision mediump float;
#endif
varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D depthSampler;uniform sampler2D normalSampler;uniform sampler2D positionSampler;uniform sampler2D velocitySampler;uniform vec4 sizeParams;uniform float maxDepth;
#define offsetX sizeParams.x
#define offsetY sizeParams.y
#define widthScale sizeParams.z
#define heightScale sizeParams.w
void main(void) {vec2 uv =
vec2((offsetX+vUV.x)*widthScale,(offsetY+vUV.y)*heightScale);vec4 backgroundColour=texture2D(textureSampler,vUV).rgba;vec4 depth=texture2D(depthSampler,vUV);vec4 worldNormal=texture2D(normalSampler,vUV);vec4 worldPosition=texture2D(positionSampler,vUV);vec4 velocityLinear=texture2D(velocitySampler,vUV);if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {gl_FragColor.rgba=backgroundColour;} else {gl_FragColor.a=1.0;if (uv.x<=0.25) {gl_FragColor.rgb=depth.rgb;gl_FragColor.a=1.0;} else if (uv.x<=0.5) {velocityLinear.rg=velocityLinear.rg*0.5+0.5;gl_FragColor.rgb=velocityLinear.rgb;} else if (uv.x<=0.75) {gl_FragColor.rgb=worldPosition.rgb;} else {gl_FragColor.rgb=worldNormal.rgb;}}}`;g.ShadersStore[bP]||(g.ShadersStore[bP]=K8);Mre={name:bP,shader:K8}});var j8={};V(j8,{IblShadowsRenderPipeline:()=>CP});var CP,Z8=S(()=>{gt();ie();Ut();Ee();ZY();A8();Wr();P8();B8();U8();G8();hh();Wu();V8();Sa();k8();Q_();nc();we();W8();AP();CP=class extends bd{resetAccumulation(){this._accumulationPass.reset=!0}get shadowOpacity(){return this._shadowOpacity}set shadowOpacity(e){this._shadowOpacity=e,this._setPluginParameters()}get coloredShadows(){return this._coloredShadows}set coloredShadows(e){this._coloredShadows=e,this._voxelTracingPass.coloredShadows=e,this._setPluginParameters()}get shadowRenderSizeFactor(){return this._renderSizeFactor}set shadowRenderSizeFactor(e){this._renderSizeFactor=Math.max(Math.min(e,1),0),this._voxelTracingPass.resize(e),this._spatialBlurPass.resize(e),this._accumulationPass.resize(e),this._setPluginParameters()}get voxelShadowOpacity(){return this._voxelTracingPass?.voxelShadowOpacity}set voxelShadowOpacity(e){this._voxelTracingPass&&(this._voxelTracingPass.voxelShadowOpacity=e)}get ssShadowOpacity(){return this._voxelTracingPass?.ssShadowOpacity}set ssShadowOpacity(e){this._voxelTracingPass&&(this._voxelTracingPass.ssShadowOpacity=e)}get ssShadowSampleCount(){return this._voxelTracingPass?.sssSamples}set ssShadowSampleCount(e){this._voxelTracingPass&&(this._voxelTracingPass.sssSamples=e)}get ssShadowStride(){return this._voxelTracingPass?.sssStride}set ssShadowStride(e){this._voxelTracingPass&&(this._voxelTracingPass.sssStride=e)}get ssShadowDistanceScale(){return this._sssMaxDistScale}set ssShadowDistanceScale(e){this._sssMaxDistScale=e,this._updateSsShadowParams()}get ssShadowThicknessScale(){return this._sssThicknessScale}set ssShadowThicknessScale(e){this._sssThicknessScale=e,this._updateSsShadowParams()}_getVoxelGridTexture(){let e=this._voxelRenderer?.getVoxelGrid();return e&&e.isReady()?e:this._dummyTexture3d}_getNoiseTexture(){let e=this._noiseTexture;return e&&e.isReady()?e:this._dummyTexture2d}_getVoxelTracingTexture(){let e=this._voxelTracingPass?.getOutputTexture();return e&&e.isReady()?e:this._dummyTexture2d}_getSpatialBlurTexture(){let e=this._spatialBlurPass.getOutputTexture();return e&&e.isReady()?e:this._dummyTexture2d}_getAccumulatedTexture(){let e=this._accumulationPass?.getOutputTexture();return e&&e.isReady()?e:this._dummyTexture2d}get gbufferDebugEnabled(){return this._gbufferDebugEnabled}set gbufferDebugEnabled(e){if(e&&!this.allowDebugPasses){P.Warn("Can't enable G-Buffer debug view without setting allowDebugPasses to true.");return}this._gbufferDebugEnabled=e,e?this._enableEffect(this._getGBufferDebugPass().name,this.cameras):this._disableEffect(this._getGBufferDebugPass().name,this.cameras)}get cdfDebugEnabled(){return this.scene.iblCdfGenerator?this.scene.iblCdfGenerator.debugEnabled:!1}set cdfDebugEnabled(e){if(this.scene.iblCdfGenerator){if(e&&!this.allowDebugPasses){P.Warn("Can't enable importance sampling debug view without setting allowDebugPasses to true.");return}e!==this.scene.iblCdfGenerator.debugEnabled&&(this.scene.iblCdfGenerator.debugEnabled=e,e?this._enableEffect(this.scene.iblCdfGenerator.debugPassName,this.cameras):this._disableEffect(this.scene.iblCdfGenerator.debugPassName,this.cameras))}}get voxelDebugEnabled(){return this._voxelRenderer?.voxelDebugEnabled}set voxelDebugEnabled(e){if(this._voxelRenderer){if(e&&!this.allowDebugPasses){P.Warn("Can't enable voxel debug view without setting allowDebugPasses to true.");return}this._voxelRenderer.voxelDebugEnabled=e,e?this._enableEffect(this._voxelRenderer.debugPassName,this.cameras):this._disableEffect(this._voxelRenderer.debugPassName,this.cameras)}}get voxelDebugAxis(){return this._voxelRenderer?.voxelDebugAxis}set voxelDebugAxis(e){this._voxelRenderer&&(this._voxelRenderer.voxelDebugAxis=e)}set voxelDebugDisplayMip(e){this._voxelRenderer&&this._voxelRenderer.setDebugMipNumber(e)}get voxelTracingDebugEnabled(){return this._voxelTracingPass?.debugEnabled}set voxelTracingDebugEnabled(e){if(this._voxelTracingPass){if(e&&!this.allowDebugPasses){P.Warn("Can't enable voxel tracing debug view without setting allowDebugPasses to true.");return}e!==this._voxelTracingPass.debugEnabled&&(this._voxelTracingPass.debugEnabled=e,e?this._enableEffect(this._voxelTracingPass.debugPassName,this.cameras):this._disableEffect(this._voxelTracingPass.debugPassName,this.cameras))}}get spatialBlurPassDebugEnabled(){return this._spatialBlurPass.debugEnabled}set spatialBlurPassDebugEnabled(e){if(this._spatialBlurPass){if(e&&!this.allowDebugPasses){P.Warn("Can't enable spatial blur debug view without setting allowDebugPasses to true.");return}e!==this._spatialBlurPass.debugEnabled&&(this._spatialBlurPass.debugEnabled=e,e?this._enableEffect(this._spatialBlurPass.debugPassName,this.cameras):this._disableEffect(this._spatialBlurPass.debugPassName,this.cameras))}}get accumulationPassDebugEnabled(){return this._accumulationPass?.debugEnabled}set accumulationPassDebugEnabled(e){if(this._accumulationPass){if(e&&!this.allowDebugPasses){P.Warn("Can't enable accumulation pass debug view without setting allowDebugPasses to true.");return}e!==this._accumulationPass.debugEnabled&&(this._accumulationPass.debugEnabled=e,e?this._enableEffect(this._accumulationPass.debugPassName,this.cameras):this._disableEffect(this._accumulationPass.debugPassName,this.cameras))}}addShadowCastingMesh(e){if(Array.isArray(e))for(let t of e)t&&this._shadowCastingMeshes.indexOf(t)===-1&&this._shadowCastingMeshes.push(t);else e&&this._shadowCastingMeshes.indexOf(e)===-1&&this._shadowCastingMeshes.push(e)}removeShadowCastingMesh(e){if(Array.isArray(e))for(let t of e){let i=this._shadowCastingMeshes.indexOf(t);i!==-1&&this._shadowCastingMeshes.splice(i,1)}else{let t=this._shadowCastingMeshes.indexOf(e);t!==-1&&this._shadowCastingMeshes.splice(t,1)}}clearShadowCastingMeshes(){this._shadowCastingMeshes.length=0}get resolutionExp(){return this._voxelRenderer.voxelResolutionExp}set resolutionExp(e){if(e!==this._voxelRenderer.voxelResolutionExp){if(this._voxelRenderer.isVoxelizationInProgress()){P.Warn("Can't change the resolution of the voxel grid while voxelization is in progress.");return}this._voxelRenderer.voxelResolutionExp=Math.max(1,Math.min(e,8)),this._accumulationPass.reset=!0}}get sampleDirections(){return this._voxelTracingPass?.sampleDirections}set sampleDirections(e){this._voxelTracingPass&&(this._voxelTracingPass.sampleDirections=e)}get shadowRemanence(){return this._accumulationPass?.remanence}set shadowRemanence(e){this._accumulationPass&&(this._accumulationPass.remanence=e)}get envRotation(){return this._voxelTracingPass?.envRotation}set envRotation(e){this._voxelTracingPass&&(this._voxelTracingPass.envRotation=e,this._accumulationPass.reset=!0)}get allowDebugPasses(){return this._allowDebugPasses}set allowDebugPasses(e){this._allowDebugPasses!==e&&(this._allowDebugPasses=e,e&&this.scene.iblCdfGenerator?this.scene.iblCdfGenerator.isReady()?this._createDebugPasses():this.scene.iblCdfGenerator.onGeneratedObservable.addOnce(()=>{this._createDebugPasses()}):this._disposeDebugPasses())}static get IsSupported(){let e=Z.LastCreatedEngine;return e?e._features.supportIBLShadows:!1}toggleShadow(e){this._enabled=e,this._voxelTracingPass.enabled=e,this._spatialBlurPass.enabled=e,this._accumulationPass.enabled=e;for(let t of this._materialsWithRenderPlugin)if(t.pluginManager){let i=t.pluginManager.getPlugin(is.Name);i.isEnabled=e}this._setPluginParameters()}updateVoxelization(){if(this._shadowCastingMeshes.length===0){P.Warn("IBL Shadows: updateVoxelization called with no shadow-casting meshes to voxelize.");return}this._voxelRenderer.updateVoxelGrid(this._shadowCastingMeshes),this._voxelRenderer.onVoxelizationCompleteObservable.addOnce(()=>{this.onVoxelizationCompleteObservable.notifyObservers()}),this._updateSsShadowParams()}updateSceneBounds(){let e={min:new E(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),max:new E(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)};for(let o of this._shadowCastingMeshes){let l=o.getHierarchyBoundingVectors(!0);e.min=E.Minimize(e.min,l.min),e.max=E.Maximize(e.max,l.max)}let t=e.max.subtract(e.min);if(this.voxelGridSize=Math.max(t.x,t.y,t.z),this._shadowCastingMeshes.length===0||!isFinite(this.voxelGridSize)||this.voxelGridSize===0){P.Warn("IBL Shadows: Scene size is invalid. Can't update bounds."),this.voxelGridSize=1;return}let i=this.voxelGridSize/2,r=e.max.add(e.min).multiplyByFloats(-.5,-.5,-.5),n=B.Compose(new E(1/i,1/i,1/i),new K,new E(0,0,0));B.Compose(new E(1,1,1),new K,r).multiplyToRef(n,n),this._voxelTracingPass.setWorldScaleMatrix(n),this._voxelRenderer.setWorldScaleMatrix(n),this._spatialBlurPass.setWorldScale(i*2),this._updateSsShadowParams()}constructor(e,t,i={},r){super(t.getEngine(),e),this._allowDebugPasses=!1,this._debugPasses=[],this._shadowCastingMeshes=[],this._shadowOpacity=.8,this._enabled=!0,this._coloredShadows=!1,this._materialsWithRenderPlugin=[],this.onShadowTextureReadyObservable=new N,this.onNewIblReadyObservable=new N,this.onVoxelizationCompleteObservable=new N,this.voxelGridSize=1,this._renderSizeFactor=1,this._gbufferDebugEnabled=!1,this._gBufferDebugSizeParams=new Oe(0,0,0,0),this.scene=t,this._cameras=r||[t.activeCamera];let n=new Uint8Array([0,0,0,255]);this._dummyTexture2d=new yr(n,1,1,ee.TEXTUREFORMAT_RGBA,t,!1),this._dummyTexture3d=new Dx(n,1,1,1,ee.TEXTUREFORMAT_RGBA,t,!1);let a={};a[Ot.SCREENSPACE_DEPTH_TEXTURE_TYPE]={textureFormat:6,textureType:1},a[Ot.VELOCITY_LINEAR_TEXTURE_TYPE]={textureFormat:7,textureType:2},a[Ot.POSITION_TEXTURE_TYPE]={textureFormat:5,textureType:2},a[Ot.NORMAL_TEXTURE_TYPE]={textureFormat:5,textureType:2};let o=t.enableGeometryBufferRenderer(void 0,14,a);if(!o){P.Error("Geometry buffer renderer is required for IBL shadows to work.");return}this._geometryBufferRenderer=o,this._geometryBufferRenderer.enableScreenspaceDepth=!0,this._geometryBufferRenderer.enableVelocityLinear=!0,this._geometryBufferRenderer.enablePosition=!0,this._geometryBufferRenderer.enableNormal=!0,this._geometryBufferRenderer.generateNormalsInWorldSpace=!0,this.scene.enableIblCdfGenerator(),this.shadowOpacity=i.shadowOpacity||.8,this._voxelRenderer=new xx(this.scene,this,i?i.resolutionExp:6,i.triPlanarVoxelization!==void 0?i.triPlanarVoxelization:!0),this._voxelTracingPass=new Ix(this.scene,this),this._spatialBlurPass=new yx(this.scene,this),this._accumulationPass=new Mx(this.scene,this),this._accumulationPass.onReadyObservable.addOnce(()=>{this.onShadowTextureReadyObservable.notifyObservers()}),this.sampleDirections=i.sampleDirections||2,this.voxelShadowOpacity=i.voxelShadowOpacity??1,this.envRotation=i.envRotation??0,this.shadowRenderSizeFactor=i.shadowRenderSizeFactor||1,this.ssShadowOpacity=i.ssShadowsEnabled===void 0||i.ssShadowsEnabled?1:0,this.ssShadowDistanceScale=i.ssShadowDistanceScale||1.25,this.ssShadowSampleCount=i.ssShadowSampleCount||16,this.ssShadowStride=i.ssShadowStride||8,this.ssShadowThicknessScale=i.ssShadowThicknessScale||1,this.shadowRemanence=i.shadowRemanence??.75,this._noiseTexture=new H("https://assets.babylonjs.com/textures/blue_noise/blue_noise_rgb.png",this.scene,!1,!0,1),t.postProcessRenderPipelineManager.addPipeline(this),this.scene.onActiveCameraChanged.add(this._listenForCameraChanges.bind(this)),this.scene.onBeforeRenderObservable.add(this._updateBeforeRender.bind(this)),this._listenForCameraChanges(),this.scene.getEngine().onResizeObservable.add(this._handleResize.bind(this)),this.scene.iblCdfGenerator&&this.scene.iblCdfGenerator.onGeneratedObservable.add(()=>{this._setPluginParameters(),this.onNewIblReadyObservable.notifyObservers()})}_handleResize(){this._voxelRenderer.resize(),this._voxelTracingPass.resize(this.shadowRenderSizeFactor),this._spatialBlurPass.resize(this.shadowRenderSizeFactor),this._accumulationPass.resize(this.shadowRenderSizeFactor),this._setPluginParameters()}_getGBufferDebugPass(){if(this._gbufferDebugPass)return this._gbufferDebugPass;let e=this.engine.isWebGPU,t=["depthSampler","normalSampler","positionSampler","velocitySampler"],i={width:this.scene.getEngine().getRenderWidth(),height:this.scene.getEngine().getRenderHeight(),samplingMode:1,engine:this.scene.getEngine(),textureType:0,textureFormat:5,uniforms:["sizeParams"],samplers:t,reusable:!1,shaderLanguage:e?1:0,extraInitializations:(r,n)=>{r?n.push(Promise.resolve().then(()=>(Y8(),X8))):n.push(Promise.resolve().then(()=>(Q8(),q8)))}};return this._gbufferDebugPass=new at("iblShadowGBufferDebug","iblShadowGBufferDebug",i),this.engine.isWebGPU&&(this._gbufferDebugPass.samples=this.engine.currentSampleCount??1),this._gbufferDebugPass.autoClear=!1,this._gbufferDebugPass.onApplyObservable.add(r=>{let n=this._geometryBufferRenderer.getTextureIndex(Ot.SCREENSPACE_DEPTH_TEXTURE_TYPE);r.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[n]);let a=this._geometryBufferRenderer.getTextureIndex(Ot.NORMAL_TEXTURE_TYPE);r.setTexture("normalSampler",this._geometryBufferRenderer.getGBuffer().textures[a]);let o=this._geometryBufferRenderer.getTextureIndex(Ot.POSITION_TEXTURE_TYPE);r.setTexture("positionSampler",this._geometryBufferRenderer.getGBuffer().textures[o]);let l=this._geometryBufferRenderer.getTextureIndex(Ot.VELOCITY_LINEAR_TEXTURE_TYPE);r.setTexture("velocitySampler",this._geometryBufferRenderer.getGBuffer().textures[l]),r.setVector4("sizeParams",this._gBufferDebugSizeParams),this.scene.activeCamera&&r.setFloat("maxDepth",this.scene.activeCamera.maxZ)}),this._gbufferDebugPass}_createDebugPasses(){this.scene.iblCdfGenerator?this._debugPasses=[{pass:this.scene.iblCdfGenerator.getDebugPassPP(),enabled:this.cdfDebugEnabled}]:this._debugPasses=[],this._debugPasses.push({pass:this._voxelRenderer.getDebugPassPP(),enabled:this.voxelDebugEnabled},{pass:this._voxelTracingPass.getDebugPassPP(),enabled:this.voxelTracingDebugEnabled},{pass:this._spatialBlurPass.getDebugPassPP(),enabled:this.spatialBlurPassDebugEnabled},{pass:this._accumulationPass.getDebugPassPP(),enabled:this.accumulationPassDebugEnabled},{pass:this._getGBufferDebugPass(),enabled:this.gbufferDebugEnabled});for(let t=0;t<this._debugPasses.length;t++)this._debugPasses[t].pass&&this.addEffect(new Px(this.scene.getEngine(),this._debugPasses[t].pass.name,()=>this._debugPasses[t].pass,!0));let e=this.cameras.slice();this.scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this.name,this.cameras),this.scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this.name,e);for(let t=0;t<this._debugPasses.length;t++)this._debugPasses[t].pass&&(this._debugPasses[t].enabled?this._enableEffect(this._debugPasses[t].pass.name,this.cameras):this._disableEffect(this._debugPasses[t].pass.name,this.cameras))}_disposeEffectPasses(){this.scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this.name,this.cameras),this._disposeDebugPasses(),this._reset()}_disposeDebugPasses(){for(let e=0;e<this._debugPasses.length;e++)this._disableEffect(this._debugPasses[e].pass.name,this.cameras),this._debugPasses[e].pass.dispose();this._debugPasses=[]}_updateDebugPasses(){let e=0;this._gbufferDebugEnabled&&e++,this.cdfDebugEnabled&&e++,this.voxelDebugEnabled&&e++,this.voxelTracingDebugEnabled&&e++,this.spatialBlurPassDebugEnabled&&e++,this.accumulationPassDebugEnabled&&e++;let t=Math.ceil(Math.sqrt(e)),i=Math.ceil(e/t),r=1/i,n=1/t,a=0,o=0;this.gbufferDebugEnabled&&(this._gBufferDebugSizeParams.set(a,o,i,t),a-=r,a<=-1&&(a=0,o-=n)),this.cdfDebugEnabled&&this.scene.iblCdfGenerator&&(this.scene.iblCdfGenerator.setDebugDisplayParams(a,o,i,t),a-=r,a<=-1&&(a=0,o-=n)),this.voxelDebugEnabled&&(this._voxelRenderer.setDebugDisplayParams(a,o,i,t),a-=r,a<=-1&&(a=0,o-=n)),this.voxelTracingDebugEnabled&&(this._voxelTracingPass.setDebugDisplayParams(a,o,i,t),a-=r,a<=-1&&(a=0,o-=n)),this.spatialBlurPassDebugEnabled&&(this._spatialBlurPass.setDebugDisplayParams(a,o,i,t),a-=r,a<=-1&&(a=0,o-=n)),this.accumulationPassDebugEnabled&&(this._accumulationPass.setDebugDisplayParams(a,o,i,t),a-=r,a<=-1&&(a=0,o-=n))}_updateSsShadowParams(){this._voxelTracingPass.sssMaxDist=this._sssMaxDistScale*this.voxelGridSize/(1<<this.resolutionExp),this._voxelTracingPass.sssThickness=this._sssThicknessScale*.005*this.voxelGridSize}addShadowReceivingMaterial(e){if(e)if(Array.isArray(e))for(let t of e)this._addShadowSupportToMaterial(t);else this._addShadowSupportToMaterial(e);else for(let t of this.scene.materials)this._addShadowSupportToMaterial(t)}removeShadowReceivingMaterial(e){if(Array.isArray(e))for(let t of e){let i=this._materialsWithRenderPlugin.indexOf(t);if(i!==-1){this._materialsWithRenderPlugin.splice(i,1);let r=t.pluginManager?.getPlugin(is.Name);r.isEnabled=!1}}else{let t=this._materialsWithRenderPlugin.indexOf(e);if(t!==-1){this._materialsWithRenderPlugin.splice(t,1);let i=e.pluginManager.getPlugin(is.Name);i.isEnabled=!1}}}clearShadowReceivingMaterials(){for(let e of this._materialsWithRenderPlugin){let t=e.pluginManager?.getPlugin(is.Name);t&&(t.isEnabled=!1)}this._materialsWithRenderPlugin.length=0}_addShadowSupportToMaterial(e){if(!(e instanceof Ft)&&!(e instanceof Se))return;let t=e.pluginManager?.getPlugin(is.Name);t||(t=new is(e)),this._materialsWithRenderPlugin.indexOf(e)===-1&&(this._enabled&&(t.iblShadowsTexture=this._getAccumulatedTexture().getInternalTexture(),t.shadowOpacity=this.shadowOpacity),t.isEnabled=this._enabled,t.isColored=this._coloredShadows,this._materialsWithRenderPlugin.push(e))}_setPluginParameters(){if(this._enabled){for(let e of this._materialsWithRenderPlugin)if(e.pluginManager){let t=e.pluginManager.getPlugin(is.Name);t.iblShadowsTexture=this._getAccumulatedTexture().getInternalTexture(),t.shadowOpacity=this.shadowOpacity,t.isColored=this._coloredShadows}}}_updateBeforeRender(){this._updateDebugPasses()}_listenForCameraChanges(){this.scene.activeCamera?.onViewMatrixChangedObservable.add(()=>{this._accumulationPass.isMoving=!0})}isReady(){return this._noiseTexture.isReady()&&this._voxelRenderer.isReady()&&this.scene.iblCdfGenerator&&this.scene.iblCdfGenerator.isReady()&&(!this._voxelTracingPass||this._voxelTracingPass.isReady())&&(!this._spatialBlurPass||this._spatialBlurPass.isReady())&&(!this._accumulationPass||this._accumulationPass.isReady())}getClassName(){return"IBLShadowsRenderPipeline"}dispose(){let e=this._materialsWithRenderPlugin.splice(0);for(let t of e)this.removeShadowReceivingMaterial(t);this._disposeEffectPasses(),this._noiseTexture.dispose(),this._voxelRenderer.dispose(),this._voxelTracingPass.dispose(),this._spatialBlurPass.dispose(),this._accumulationPass.dispose(),this._dummyTexture2d.dispose(),this._dummyTexture3d.dispose(),this.onNewIblReadyObservable.clear(),this.onShadowTextureReadyObservable.clear(),this.onVoxelizationCompleteObservable.clear(),super.dispose()}}});var tt,fo=S(()=>{di();tt=class{static ComputeNumMipmapLevels(e,t){return bs(Math.max(e,t))+1}static GetTextureTypeFromFormat(e){switch(e){case"r8unorm":case"r8uint":case"rg8unorm":case"rg8uint":case"rgba8unorm":case"rgba8unorm-srgb":case"rgba8uint":case"bgra8unorm":case"bgra8unorm-srgb":case"rgb10a2uint":case"rgb10a2unorm":case"rgb9e5ufloat":case"rg11b10ufloat":case"bc7-rgba-unorm":case"bc7-rgba-unorm-srgb":case"bc6h-rgb-ufloat":case"bc5-rg-unorm":case"bc3-rgba-unorm":case"bc3-rgba-unorm-srgb":case"bc2-rgba-unorm":case"bc2-rgba-unorm-srgb":case"bc4-r-unorm":case"bc1-rgba-unorm":case"bc1-rgba-unorm-srgb":case"etc2-rgb8unorm":case"etc2-rgb8unorm-srgb":case"etc2-rgb8a1unorm":case"etc2-rgb8a1unorm-srgb":case"etc2-rgba8unorm":case"etc2-rgba8unorm-srgb":case"eac-r11unorm":case"eac-rg11unorm":case"astc-4x4-unorm":case"astc-4x4-unorm-srgb":case"astc-5x4-unorm":case"astc-5x4-unorm-srgb":case"astc-5x5-unorm":case"astc-5x5-unorm-srgb":case"astc-6x5-unorm":case"astc-6x5-unorm-srgb":case"astc-6x6-unorm":case"astc-6x6-unorm-srgb":case"astc-8x5-unorm":case"astc-8x5-unorm-srgb":case"astc-8x6-unorm":case"astc-8x6-unorm-srgb":case"astc-8x8-unorm":case"astc-8x8-unorm-srgb":case"astc-10x5-unorm":case"astc-10x5-unorm-srgb":case"astc-10x6-unorm":case"astc-10x6-unorm-srgb":case"astc-10x8-unorm":case"astc-10x8-unorm-srgb":case"astc-10x10-unorm":case"astc-10x10-unorm-srgb":case"astc-12x10-unorm":case"astc-12x10-unorm-srgb":case"astc-12x12-unorm":case"astc-12x12-unorm-srgb":case"stencil8":return 0;case"r8snorm":case"r8sint":case"rg8snorm":case"rg8sint":case"rgba8snorm":case"rgba8sint":case"bc6h-rgb-float":case"bc5-rg-snorm":case"bc4-r-snorm":case"eac-r11snorm":case"eac-rg11snorm":return 3;case"r16uint":case"r16unorm":case"rg16unorm":case"rgba16unorm":case"rg16uint":case"rgba16uint":case"depth16unorm":return 5;case"r16sint":case"r16snorm":case"rg16snorm":case"rgba16snorm":case"rg16sint":case"rgba16sint":return 4;case"r16float":case"rg16float":case"rgba16float":return 2;case"r32uint":case"rg32uint":case"rgba32uint":return 7;case"r32sint":case"rg32sint":case"rgba32sint":return 7;case"r32float":case"rg32float":case"rgba32float":case"depth32float":case"depth32float-stencil8":case"depth24plus":case"depth24plus-stencil8":return 1}return 0}static GetBlockInformationFromFormat(e){switch(e){case"r8unorm":case"r8snorm":case"r8uint":case"r8sint":return{width:1,height:1,length:1};case"r16uint":case"r16sint":case"r16unorm":case"r16snorm":case"r16float":case"rg8unorm":case"rg8snorm":case"rg8uint":case"rg8sint":return{width:1,height:1,length:2};case"r32uint":case"r32sint":case"r32float":case"rg16uint":case"rg16sint":case"rg16float":case"rg16unorm":case"rg16snorm":case"rgba8unorm":case"rgba8unorm-srgb":case"rgba8snorm":case"rgba8uint":case"rgba8sint":case"bgra8unorm":case"bgra8unorm-srgb":case"rgb9e5ufloat":case"rgb10a2uint":case"rgb10a2unorm":case"rg11b10ufloat":return{width:1,height:1,length:4};case"rg32uint":case"rg32sint":case"rg32float":case"rgba16uint":case"rgba16sint":case"rgba16float":case"rgba16unorm":case"rgba16snorm":return{width:1,height:1,length:8};case"rgba32uint":case"rgba32sint":case"rgba32float":return{width:1,height:1,length:16};case"stencil8":throw"No fixed size for Stencil8 format!";case"depth16unorm":return{width:1,height:1,length:2};case"depth24plus":throw"No fixed size for Depth24Plus format!";case"depth24plus-stencil8":throw"No fixed size for Depth24PlusStencil8 format!";case"depth32float":return{width:1,height:1,length:4};case"depth32float-stencil8":return{width:1,height:1,length:5};case"bc7-rgba-unorm":case"bc7-rgba-unorm-srgb":case"bc6h-rgb-ufloat":case"bc6h-rgb-float":case"bc5-rg-unorm":case"bc5-rg-snorm":case"bc3-rgba-unorm":case"bc3-rgba-unorm-srgb":case"bc2-rgba-unorm":case"bc2-rgba-unorm-srgb":return{width:4,height:4,length:16};case"bc4-r-unorm":case"bc4-r-snorm":case"bc1-rgba-unorm":case"bc1-rgba-unorm-srgb":return{width:4,height:4,length:8};case"etc2-rgb8unorm":case"etc2-rgb8unorm-srgb":case"etc2-rgb8a1unorm":case"etc2-rgb8a1unorm-srgb":case"eac-r11unorm":case"eac-r11snorm":return{width:4,height:4,length:8};case"etc2-rgba8unorm":case"etc2-rgba8unorm-srgb":case"eac-rg11unorm":case"eac-rg11snorm":return{width:4,height:4,length:16};case"astc-4x4-unorm":case"astc-4x4-unorm-srgb":return{width:4,height:4,length:16};case"astc-5x4-unorm":case"astc-5x4-unorm-srgb":return{width:5,height:4,length:16};case"astc-5x5-unorm":case"astc-5x5-unorm-srgb":return{width:5,height:5,length:16};case"astc-6x5-unorm":case"astc-6x5-unorm-srgb":return{width:6,height:5,length:16};case"astc-6x6-unorm":case"astc-6x6-unorm-srgb":return{width:6,height:6,length:16};case"astc-8x5-unorm":case"astc-8x5-unorm-srgb":return{width:8,height:5,length:16};case"astc-8x6-unorm":case"astc-8x6-unorm-srgb":return{width:8,height:6,length:16};case"astc-8x8-unorm":case"astc-8x8-unorm-srgb":return{width:8,height:8,length:16};case"astc-10x5-unorm":case"astc-10x5-unorm-srgb":return{width:10,height:5,length:16};case"astc-10x6-unorm":case"astc-10x6-unorm-srgb":return{width:10,height:6,length:16};case"astc-10x8-unorm":case"astc-10x8-unorm-srgb":return{width:10,height:8,length:16};case"astc-10x10-unorm":case"astc-10x10-unorm-srgb":return{width:10,height:10,length:16};case"astc-12x10-unorm":case"astc-12x10-unorm-srgb":return{width:12,height:10,length:16};case"astc-12x12-unorm":case"astc-12x12-unorm-srgb":return{width:12,height:12,length:16}}return{width:1,height:1,length:4}}static IsHardwareTexture(e){return!!e.release}static IsInternalTexture(e){return!!e.dispose}static IsImageBitmap(e){return e.close!==void 0}static IsImageBitmapArray(e){return Array.isArray(e)&&e[0].close!==void 0}static IsCompressedFormat(e){switch(e){case"bc7-rgba-unorm-srgb":case"bc7-rgba-unorm":case"bc6h-rgb-float":case"bc6h-rgb-ufloat":case"bc5-rg-snorm":case"bc5-rg-unorm":case"bc4-r-snorm":case"bc4-r-unorm":case"bc3-rgba-unorm-srgb":case"bc3-rgba-unorm":case"bc2-rgba-unorm-srgb":case"bc2-rgba-unorm":case"bc1-rgba-unorm-srgb":case"bc1-rgba-unorm":case"etc2-rgb8unorm":case"etc2-rgb8unorm-srgb":case"etc2-rgb8a1unorm":case"etc2-rgb8a1unorm-srgb":case"etc2-rgba8unorm":case"etc2-rgba8unorm-srgb":case"eac-r11unorm":case"eac-r11snorm":case"eac-rg11unorm":case"eac-rg11snorm":case"astc-4x4-unorm":case"astc-4x4-unorm-srgb":case"astc-5x4-unorm":case"astc-5x4-unorm-srgb":case"astc-5x5-unorm":case"astc-5x5-unorm-srgb":case"astc-6x5-unorm":case"astc-6x5-unorm-srgb":case"astc-6x6-unorm":case"astc-6x6-unorm-srgb":case"astc-8x5-unorm":case"astc-8x5-unorm-srgb":case"astc-8x6-unorm":case"astc-8x6-unorm-srgb":case"astc-8x8-unorm":case"astc-8x8-unorm-srgb":case"astc-10x5-unorm":case"astc-10x5-unorm-srgb":case"astc-10x6-unorm":case"astc-10x6-unorm-srgb":case"astc-10x8-unorm":case"astc-10x8-unorm-srgb":case"astc-10x10-unorm":case"astc-10x10-unorm-srgb":case"astc-12x10-unorm":case"astc-12x10-unorm-srgb":case"astc-12x12-unorm":case"astc-12x12-unorm-srgb":return!0}return!1}static GetWebGPUTextureFormat(e,t,i=!1){switch(t){case 15:return"depth16unorm";case 16:return"depth24plus";case 13:return"depth24plus-stencil8";case 14:return"depth32float";case 18:return"depth32float-stencil8";case 19:return"stencil8";case 36492:return i?"bc7-rgba-unorm-srgb":"bc7-rgba-unorm";case 36495:return"bc6h-rgb-ufloat";case 36494:return"bc6h-rgb-float";case 33779:return i?"bc3-rgba-unorm-srgb":"bc3-rgba-unorm";case 33778:return i?"bc2-rgba-unorm-srgb":"bc2-rgba-unorm";case 33777:case 33776:return i?"bc1-rgba-unorm-srgb":"bc1-rgba-unorm";case 37808:return i?"astc-4x4-unorm-srgb":"astc-4x4-unorm";case 36196:case 37492:return i?"etc2-rgb8unorm-srgb":"etc2-rgb8unorm";case 37496:return i?"etc2-rgba8unorm-srgb":"etc2-rgba8unorm"}switch(e){case 3:switch(t){case 6:return"r8snorm";case 7:return"rg8snorm";case 4:throw"RGB format not supported in WebGPU";case 8:return"r8sint";case 9:return"rg8sint";case 10:throw"RGB_INTEGER format not supported in WebGPU";case 11:return"rgba8sint";default:return"rgba8snorm"}case 0:switch(t){case 6:return"r8unorm";case 7:return"rg8unorm";case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return i?"rgba8unorm-srgb":"rgba8unorm";case 12:return i?"bgra8unorm-srgb":"bgra8unorm";case 8:return"r8uint";case 9:return"rg8uint";case 10:throw"RGB_INTEGER format not supported in WebGPU";case 11:return"rgba8uint";case 0:throw"TEXTUREFORMAT_ALPHA format not supported in WebGPU";case 1:throw"TEXTUREFORMAT_LUMINANCE format not supported in WebGPU";case 2:throw"TEXTUREFORMAT_LUMINANCE_ALPHA format not supported in WebGPU";default:return"rgba8unorm"}case 4:switch(t){case 8:return"r16sint";case 9:return"rg16sint";case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return"rgba16sint";default:return"rgba16sint"}case 5:switch(t){case 8:return"r16uint";case 9:return"rg16uint";case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return"rgba16uint";default:return"rgba16uint"}case 6:switch(t){case 8:return"r32sint";case 9:return"rg32sint";case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return"rgba32sint";default:return"rgba32sint"}case 7:switch(t){case 8:return"r32uint";case 9:return"rg32uint";case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return"rgba32uint";default:return"rgba32uint"}case 1:switch(t){case 6:return"r32float";case 7:return"rg32float";case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return"rgba32float";default:return"rgba32float"}case 2:switch(t){case 6:return"r16float";case 7:return"rg16float";case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return"rgba16float";default:return"rgba16float"}case 10:throw"TEXTURETYPE_UNSIGNED_SHORT_5_6_5 format not supported in WebGPU";case 13:switch(t){case 5:return"rg11b10ufloat";case 11:throw"TEXTUREFORMAT_RGBA_INTEGER format not supported in WebGPU when type is TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV";default:return"rg11b10ufloat"}case 14:switch(t){case 5:return"rgb9e5ufloat";case 11:throw"TEXTUREFORMAT_RGBA_INTEGER format not supported in WebGPU when type is TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV";default:return"rgb9e5ufloat"}case 8:throw"TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4 format not supported in WebGPU";case 9:throw"TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1 format not supported in WebGPU";case 11:switch(t){case 5:return"rgb10a2unorm";case 11:return"rgb10a2uint";default:return"rgb10a2unorm"}}return i?"rgba8unorm-srgb":"rgba8unorm"}static GetNumChannelsFromWebGPUTextureFormat(e){switch(e){case"r8unorm":case"r8snorm":case"r8uint":case"r8sint":case"bc4-r-unorm":case"bc4-r-snorm":case"r16uint":case"r16sint":case"depth16unorm":case"r16float":case"r16unorm":case"r16snorm":case"r32uint":case"r32sint":case"r32float":case"depth32float":case"stencil8":case"depth24plus":case"eac-r11unorm":case"eac-r11snorm":return 1;case"rg8unorm":case"rg8snorm":case"rg8uint":case"rg8sint":case"depth32float-stencil8":case"bc5-rg-unorm":case"bc5-rg-snorm":case"rg16uint":case"rg16sint":case"rg16float":case"rg16unorm":case"rg16snorm":case"rg32uint":case"rg32sint":case"rg32float":case"depth24plus-stencil8":case"eac-rg11unorm":case"eac-rg11snorm":return 2;case"rgb9e5ufloat":case"rg11b10ufloat":case"bc6h-rgb-ufloat":case"bc6h-rgb-float":case"etc2-rgb8unorm":case"etc2-rgb8unorm-srgb":return 3;case"rgba8unorm":case"rgba8unorm-srgb":case"rgba8snorm":case"rgba8uint":case"rgba8sint":case"bgra8unorm":case"bgra8unorm-srgb":case"rgba16unorm":case"rgba16snorm":case"rgb10a2uint":case"rgb10a2unorm":case"bc7-rgba-unorm":case"bc7-rgba-unorm-srgb":case"bc3-rgba-unorm":case"bc3-rgba-unorm-srgb":case"bc2-rgba-unorm":case"bc2-rgba-unorm-srgb":case"bc1-rgba-unorm":case"bc1-rgba-unorm-srgb":case"rgba16uint":case"rgba16sint":case"rgba16float":case"rgba32uint":case"rgba32sint":case"rgba32float":case"etc2-rgb8a1unorm":case"etc2-rgb8a1unorm-srgb":case"etc2-rgba8unorm":case"etc2-rgba8unorm-srgb":case"astc-4x4-unorm":case"astc-4x4-unorm-srgb":case"astc-5x4-unorm":case"astc-5x4-unorm-srgb":case"astc-5x5-unorm":case"astc-5x5-unorm-srgb":case"astc-6x5-unorm":case"astc-6x5-unorm-srgb":case"astc-6x6-unorm":case"astc-6x6-unorm-srgb":case"astc-8x5-unorm":case"astc-8x5-unorm-srgb":case"astc-8x6-unorm":case"astc-8x6-unorm-srgb":case"astc-8x8-unorm":case"astc-8x8-unorm-srgb":case"astc-10x5-unorm":case"astc-10x5-unorm-srgb":case"astc-10x6-unorm":case"astc-10x6-unorm-srgb":case"astc-10x8-unorm":case"astc-10x8-unorm-srgb":case"astc-10x10-unorm":case"astc-10x10-unorm-srgb":case"astc-12x10-unorm":case"astc-12x10-unorm-srgb":case"astc-12x12-unorm":case"astc-12x12-unorm-srgb":return 4}throw`Unknown format ${e}!`}static HasStencilAspect(e){switch(e){case"stencil8":case"depth32float-stencil8":case"depth24plus-stencil8":return!0}return!1}static HasDepthAndStencilAspects(e){switch(e){case"depth32float-stencil8":case"depth24plus-stencil8":return!0}return!1}static GetDepthFormatOnly(e){switch(e){case"depth16unorm":return"depth16unorm";case"depth24plus":return"depth24plus";case"depth24plus-stencil8":return"depth24plus";case"depth32float":return"depth32float";case"depth32float-stencil8":return"depth32float"}return e}static GetSample(e){return e>1?4:1}}});var uh,IP=S(()=>{Wc();uh=class{constructor(){this._gpuTimeInFrameId=-1,this.counter=new sr}_addDuration(e,t){e<this._gpuTimeInFrameId||(this._gpuTimeInFrameId!==e?(this.counter._fetchResult(),this.counter.fetchNewFrame(),this.counter.addCount(t,!1),this._gpuTimeInFrameId=e):this.counter.addCount(t,!1))}}});var ft,aa=S(()=>{Jt();Ee();fo();IP();ft=class extends k{constructor(){super(...arguments),this.dbgShowShaderCode=!1,this.dbgSanityChecks=!0,this.dbgVerboseLogsNumFrames=10,this.dbgLogIfNotDrawWrapper=!0,this.dbgShowEmptyEnableEffectCalls=!0,this.dbgVerboseLogsForFirstFrames=!1,this._currentRenderPass=null,this._snapshotRenderingMode=0,this._timestampIndex=0,this._debugStackRenderPass=[]}get enableGPUTimingMeasurements(){return this._timestampQuery.enable}set enableGPUTimingMeasurements(e){this._timestampQuery.enable!==e&&(this.gpuTimeInFrameForMainPass=e?new uh:void 0,this._timestampQuery.enable=e)}_currentPassIsMainPass(){return this._currentRenderTarget===null}_endCurrentRenderPass(){if(!this._currentRenderPass)return 0;if(this._debugStackRenderPass.length!==0)for(let t=0;t<this._debugStackRenderPass.length;++t)this._currentRenderPass.popDebugGroup();let e=this._currentPassIsMainPass()?2:1;return!this._snapshotRendering.endRenderPass(this._currentRenderPass)&&!this.compatibilityMode&&(this._bundleList.run(this._currentRenderPass),this._bundleList.reset()),this._currentRenderPass.end(),this._timestampQuery.endPass(this._timestampIndex,this._currentRenderTarget&&this._currentRenderTarget.gpuTimeInFrame?this._currentRenderTarget.gpuTimeInFrame:this.gpuTimeInFrameForMainPass),this._timestampIndex+=2,this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&P.Log("frame #"+this._count+" - "+(e===2?"main":"render target")+" end pass"+(e===1?" - internalTexture.uniqueId="+this._currentRenderTarget?.texture?.uniqueId:""))),this._debugPopGroup?.(0),this._currentRenderPass=null,e}_generateMipmaps(e,t){t=t??this._renderEncoder;let i=e._hardwareTexture;if(!i)return;t===this._renderEncoder&&this._endCurrentRenderPass();let r=e._hardwareTexture.format,n=tt.ComputeNumMipmapLevels(e.width,e.height);this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&P.Log("frame #"+this._count+" - generate mipmaps - width="+e.width+", height="+e.height+", isCube="+e.isCube+", command encoder="+(t===this._renderEncoder?"render":"copy"))),e.isCube?this._textureHelper.generateCubeMipmaps(i,r,n,t):this._textureHelper.generateMipmaps(i,r,n,0,e.is3D,t)}}});var J8,$8,eK,rt,tK,iK,rK,sK,nK,aK,oK,lK,cK,fK,hK,uK,dK,pK,mK,_K,gK,vK,SK,EK,TK,xK,AK,RK,bK,CK,IK,yK,MK,PK,DK,OK,LK,wK,FK,NK,BK,dh=S(()=>{(function(s){s.LowPower="low-power",s.HighPerformance="high-performance"})(J8||(J8={}));(function(s){s.CoreFeaturesAndLimits="core-features-and-limits",s.DepthClipControl="depth-clip-control",s.Depth32FloatStencil8="depth32float-stencil8",s.TextureCompressionBC="texture-compression-bc",s.TextureCompressionBCSliced3D="texture-compression-bc-sliced-3d",s.TextureCompressionETC2="texture-compression-etc2",s.TextureCompressionASTC="texture-compression-astc",s.TextureCompressionASTCSliced3D="texture-compression-astc-sliced-3d",s.TimestampQuery="timestamp-query",s.IndirectFirstInstance="indirect-first-instance",s.ShaderF16="shader-f16",s.RG11B10UFloatRenderable="rg11b10ufloat-renderable",s.BGRA8UnormStorage="bgra8unorm-storage",s.Float32Filterable="float32-filterable",s.Float32Blendable="float32-blendable",s.ClipDistances="clip-distances",s.DualSourceBlending="dual-source-blending",s.Subgroups="subgroups",s.TextureFormatsTier1="texture-formats-tier1",s.TextureFormatsTier2="texture-formats-tier2"})($8||($8={}));(function(s){s.Unmapped="unmapped",s.Pending="pending",s.Mapped="mapped"})(eK||(eK={}));(function(s){s[s.MapRead=1]="MapRead",s[s.MapWrite=2]="MapWrite",s[s.CopySrc=4]="CopySrc",s[s.CopyDst=8]="CopyDst",s[s.Index=16]="Index",s[s.Vertex=32]="Vertex",s[s.Uniform=64]="Uniform",s[s.Storage=128]="Storage",s[s.Indirect=256]="Indirect",s[s.QueryResolve=512]="QueryResolve"})(rt||(rt={}));(function(s){s[s.Read=1]="Read",s[s.Write=2]="Write"})(tK||(tK={}));(function(s){s.E1d="1d",s.E2d="2d",s.E3d="3d"})(iK||(iK={}));(function(s){s[s.CopySrc=1]="CopySrc",s[s.CopyDst=2]="CopyDst",s[s.TextureBinding=4]="TextureBinding",s[s.StorageBinding=8]="StorageBinding",s[s.RenderAttachment=16]="RenderAttachment"})(rK||(rK={}));(function(s){s.E1d="1d",s.E2d="2d",s.E2dArray="2d-array",s.Cube="cube",s.CubeArray="cube-array",s.E3d="3d"})(sK||(sK={}));(function(s){s.All="all",s.StencilOnly="stencil-only",s.DepthOnly="depth-only"})(nK||(nK={}));(function(s){s.R8Unorm="r8unorm",s.R8Snorm="r8snorm",s.R8Uint="r8uint",s.R8Sint="r8sint",s.R16Uint="r16uint",s.R16Sint="r16sint",s.R16Float="r16float",s.RG8Unorm="rg8unorm",s.RG8Snorm="rg8snorm",s.RG8Uint="rg8uint",s.RG8Sint="rg8sint",s.R16Unorm="r16unorm",s.R16Snorm="r16snorm",s.R32Uint="r32uint",s.R32Sint="r32sint",s.R32Float="r32float",s.RG16Uint="rg16uint",s.RG16Sint="rg16sint",s.RG16Float="rg16float",s.RGBA8Unorm="rgba8unorm",s.RGBA8UnormSRGB="rgba8unorm-srgb",s.RGBA8Snorm="rgba8snorm",s.RGBA8Uint="rgba8uint",s.RGBA8Sint="rgba8sint",s.BGRA8Unorm="bgra8unorm",s.BGRA8UnormSRGB="bgra8unorm-srgb",s.RG16Unorm="rg16unorm",s.RG16Snorm="rg16snorm",s.RGB9E5UFloat="rgb9e5ufloat",s.RGB10A2UINT="rgb10a2uint",s.RGB10A2Unorm="rgb10a2unorm",s.RG11B10UFloat="rg11b10ufloat",s.RG32Uint="rg32uint",s.RG32Sint="rg32sint",s.RG32Float="rg32float",s.RGBA16Uint="rgba16uint",s.RGBA16Sint="rgba16sint",s.RGBA16Float="rgba16float",s.RGBA16Unorm="rgba16unorm",s.RGBA16Snorm="rgba16snorm",s.RGBA32Uint="rgba32uint",s.RGBA32Sint="rgba32sint",s.RGBA32Float="rgba32float",s.Stencil8="stencil8",s.Depth16Unorm="depth16unorm",s.Depth24Plus="depth24plus",s.Depth24PlusStencil8="depth24plus-stencil8",s.Depth32Float="depth32float",s.BC1RGBAUnorm="bc1-rgba-unorm",s.BC1RGBAUnormSRGB="bc1-rgba-unorm-srgb",s.BC2RGBAUnorm="bc2-rgba-unorm",s.BC2RGBAUnormSRGB="bc2-rgba-unorm-srgb",s.BC3RGBAUnorm="bc3-rgba-unorm",s.BC3RGBAUnormSRGB="bc3-rgba-unorm-srgb",s.BC4RUnorm="bc4-r-unorm",s.BC4RSnorm="bc4-r-snorm",s.BC5RGUnorm="bc5-rg-unorm",s.BC5RGSnorm="bc5-rg-snorm",s.BC6HRGBUFloat="bc6h-rgb-ufloat",s.BC6HRGBFloat="bc6h-rgb-float",s.BC7RGBAUnorm="bc7-rgba-unorm",s.BC7RGBAUnormSRGB="bc7-rgba-unorm-srgb",s.ETC2RGB8Unorm="etc2-rgb8unorm",s.ETC2RGB8UnormSRGB="etc2-rgb8unorm-srgb",s.ETC2RGB8A1Unorm="etc2-rgb8a1unorm",s.ETC2RGB8A1UnormSRGB="etc2-rgb8a1unorm-srgb",s.ETC2RGBA8Unorm="etc2-rgba8unorm",s.ETC2RGBA8UnormSRGB="etc2-rgba8unorm-srgb",s.EACR11Unorm="eac-r11unorm",s.EACR11Snorm="eac-r11snorm",s.EACRG11Unorm="eac-rg11unorm",s.EACRG11Snorm="eac-rg11snorm",s.ASTC4x4Unorm="astc-4x4-unorm",s.ASTC4x4UnormSRGB="astc-4x4-unorm-srgb",s.ASTC5x4Unorm="astc-5x4-unorm",s.ASTC5x4UnormSRGB="astc-5x4-unorm-srgb",s.ASTC5x5Unorm="astc-5x5-unorm",s.ASTC5x5UnormSRGB="astc-5x5-unorm-srgb",s.ASTC6x5Unorm="astc-6x5-unorm",s.ASTC6x5UnormSRGB="astc-6x5-unorm-srgb",s.ASTC6x6Unorm="astc-6x6-unorm",s.ASTC6x6UnormSRGB="astc-6x6-unorm-srgb",s.ASTC8x5Unorm="astc-8x5-unorm",s.ASTC8x5UnormSRGB="astc-8x5-unorm-srgb",s.ASTC8x6Unorm="astc-8x6-unorm",s.ASTC8x6UnormSRGB="astc-8x6-unorm-srgb",s.ASTC8x8Unorm="astc-8x8-unorm",s.ASTC8x8UnormSRGB="astc-8x8-unorm-srgb",s.ASTC10x5Unorm="astc-10x5-unorm",s.ASTC10x5UnormSRGB="astc-10x5-unorm-srgb",s.ASTC10x6Unorm="astc-10x6-unorm",s.ASTC10x6UnormSRGB="astc-10x6-unorm-srgb",s.ASTC10x8Unorm="astc-10x8-unorm",s.ASTC10x8UnormSRGB="astc-10x8-unorm-srgb",s.ASTC10x10Unorm="astc-10x10-unorm",s.ASTC10x10UnormSRGB="astc-10x10-unorm-srgb",s.ASTC12x10Unorm="astc-12x10-unorm",s.ASTC12x10UnormSRGB="astc-12x10-unorm-srgb",s.ASTC12x12Unorm="astc-12x12-unorm",s.ASTC12x12UnormSRGB="astc-12x12-unorm-srgb",s.Depth32FloatStencil8="depth32float-stencil8"})(aK||(aK={}));(function(s){s.ClampToEdge="clamp-to-edge",s.Repeat="repeat",s.MirrorRepeat="mirror-repeat"})(oK||(oK={}));(function(s){s.Nearest="nearest",s.Linear="linear"})(lK||(lK={}));(function(s){s.Nearest="nearest",s.Linear="linear"})(cK||(cK={}));(function(s){s.Never="never",s.Less="less",s.Equal="equal",s.LessEqual="less-equal",s.Greater="greater",s.NotEqual="not-equal",s.GreaterEqual="greater-equal",s.Always="always"})(fK||(fK={}));(function(s){s[s.Vertex=1]="Vertex",s[s.Fragment=2]="Fragment",s[s.Compute=4]="Compute"})(hK||(hK={}));(function(s){s.Uniform="uniform",s.Storage="storage",s.ReadOnlyStorage="read-only-storage"})(uK||(uK={}));(function(s){s.Filtering="filtering",s.NonFiltering="non-filtering",s.Comparison="comparison"})(dK||(dK={}));(function(s){s.Float="float",s.UnfilterableFloat="unfilterable-float",s.Depth="depth",s.Sint="sint",s.Uint="uint"})(pK||(pK={}));(function(s){s.WriteOnly="write-only",s.ReadOnly="read-only",s.ReadWrite="read-write"})(mK||(mK={}));(function(s){s.Error="error",s.Warning="warning",s.Info="info"})(_K||(_K={}));(function(s){s.Validation="validation",s.Internal="internal"})(gK||(gK={}));(function(s){s.Auto="auto"})(vK||(vK={}));(function(s){s.PointList="point-list",s.LineList="line-list",s.LineStrip="line-strip",s.TriangleList="triangle-list",s.TriangleStrip="triangle-strip"})(SK||(SK={}));(function(s){s.CCW="ccw",s.CW="cw"})(EK||(EK={}));(function(s){s.None="none",s.Front="front",s.Back="back"})(TK||(TK={}));(function(s){s[s.Red=1]="Red",s[s.Green=2]="Green",s[s.Blue=4]="Blue",s[s.Alpha=8]="Alpha",s[s.All=15]="All"})(xK||(xK={}));(function(s){s.Zero="zero",s.One="one",s.Src="src",s.OneMinusSrc="one-minus-src",s.SrcAlpha="src-alpha",s.OneMinusSrcAlpha="one-minus-src-alpha",s.Dst="dst",s.OneMinusDst="one-minus-dst",s.DstAlpha="dst-alpha",s.OneMinusDstAlpha="one-minus-dst-alpha",s.SrcAlphaSaturated="src-alpha-saturated",s.Constant="constant",s.OneMinusConstant="one-minus-constant",s.Src1="src1",s.OneMinusSrc1="one-minus-src1",s.Src1Alpha="src1-alpha",s.OneMinusSrc1Alpha="one-minus-src1-alpha"})(AK||(AK={}));(function(s){s.Add="add",s.Subtract="subtract",s.ReverseSubtract="reverse-subtract",s.Min="min",s.Max="max"})(RK||(RK={}));(function(s){s.Keep="keep",s.Zero="zero",s.Replace="replace",s.Invert="invert",s.IncrementClamp="increment-clamp",s.DecrementClamp="decrement-clamp",s.IncrementWrap="increment-wrap",s.DecrementWrap="decrement-wrap"})(bK||(bK={}));(function(s){s.Uint16="uint16",s.Uint32="uint32"})(CK||(CK={}));(function(s){s.Uint8="uint8",s.Uint8x2="uint8x2",s.Uint8x4="uint8x4",s.Sint8="sint8",s.Sint8x2="sint8x2",s.Sint8x4="sint8x4",s.Unorm8="unorm8",s.Unorm8x2="unorm8x2",s.Unorm8x4="unorm8x4",s.Snorm8="snorm8",s.Snorm8x2="snorm8x2",s.Snorm8x4="snorm8x4",s.Uint16="uint16",s.Uint16x2="uint16x2",s.Uint16x4="uint16x4",s.Sint16="sint16",s.Sint16x2="sint16x2",s.Sint16x4="sint16x4",s.Unorm16="unorm16",s.Unorm16x2="unorm16x2",s.Unorm16x4="unorm16x4",s.Snorm16="snorm16",s.Snorm16x2="snorm16x2",s.Snorm16x4="snorm16x4",s.Float16="float16",s.Float16x2="float16x2",s.Float16x4="float16x4",s.Float32="float32",s.Float32x2="float32x2",s.Float32x3="float32x3",s.Float32x4="float32x4",s.Uint32="uint32",s.Uint32x2="uint32x2",s.Uint32x3="uint32x3",s.Uint32x4="uint32x4",s.Sint32="sint32",s.Sint32x2="sint32x2",s.Sint32x3="sint32x3",s.Sint32x4="sint32x4",s.UNORM10x10x10x2="unorm10-10-10-2",s.UNORM8x4BGRA="unorm8x4-bgra"})(IK||(IK={}));(function(s){s.Vertex="vertex",s.Instance="instance"})(yK||(yK={}));(function(s){s.Beginning="beginning",s.End="end"})(MK||(MK={}));(function(s){s.Beginning="beginning",s.End="end"})(PK||(PK={}));(function(s){s.Load="load",s.Clear="clear"})(DK||(DK={}));(function(s){s.Store="store",s.Discard="discard"})(OK||(OK={}));(function(s){s.Occlusion="occlusion",s.Timestamp="timestamp"})(LK||(LK={}));(function(s){s.Opaque="opaque",s.Premultiplied="premultiplied"})(wK||(wK={}));(function(s){s.Standard="standard",s.Extended="extended"})(FK||(FK={}));(function(s){s.Unknown="unknown",s.Destroyed="destroyed"})(NK||(NK={}));(function(s){s.Validation="validation",s.OutOfMemory="out-of-memory",s.Internal="internal"})(BK||(BK={}))});var Kt,Id=S(()=>{Kt=class s{constructor(){this.shaderLanguage=0}_addUniformToLeftOverUBO(e,t,i){let r=0;[e,t,r]=this._getArraySize(e,t,i);for(let n=0;n<this._webgpuProcessingContext.leftOverUniforms.length;n++)if(this._webgpuProcessingContext.leftOverUniforms[n].name===e)return;this._webgpuProcessingContext.leftOverUniforms.push({name:e,type:t,length:r})}_buildLeftOverUBO(){if(!this._webgpuProcessingContext.leftOverUniforms.length)return"";let e=s.LeftOvertUBOName,t=this._webgpuProcessingContext.availableBuffers[e];return t||(t={binding:this._webgpuProcessingContext.getNextFreeUBOBinding()},this._webgpuProcessingContext.availableBuffers[e]=t,this._addBufferBindingDescription(e,t,"uniform",!0),this._addBufferBindingDescription(e,t,"uniform",!1)),this._generateLeftOverUBOCode(e,t)}_collectBindingNames(){for(let e=0;e<this._webgpuProcessingContext.bindGroupLayoutEntries.length;e++){let t=this._webgpuProcessingContext.bindGroupLayoutEntries[e];if(t===void 0){this._webgpuProcessingContext.bindGroupLayoutEntries[e]=[];continue}for(let i=0;i<t.length;i++){let r=this._webgpuProcessingContext.bindGroupLayoutEntries[e][i],n=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[e][r.binding].name,a=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[e][r.binding].nameInArrayOfTexture;r&&(r.texture||r.externalTexture||r.storageTexture?this._webgpuProcessingContext.textureNames.push(a):r.sampler?this._webgpuProcessingContext.samplerNames.push(n):r.buffer&&this._webgpuProcessingContext.bufferNames.push(n))}}}_preCreateBindGroupEntries(){let e=this._webgpuProcessingContext.bindGroupEntries;for(let t=0;t<this._webgpuProcessingContext.bindGroupLayoutEntries.length;t++){let i=this._webgpuProcessingContext.bindGroupLayoutEntries[t],r=[];for(let n=0;n<i.length;n++){let a=this._webgpuProcessingContext.bindGroupLayoutEntries[t][n];a.sampler||a.texture||a.storageTexture||a.externalTexture?r.push({binding:a.binding,resource:void 0}):a.buffer&&r.push({binding:a.binding,resource:{buffer:void 0,offset:0,size:0}})}e[t]=r}}_addTextureBindingDescription(e,t,i,r,n,a){let{groupIndex:o,bindingIndex:l}=t.textures[i];if(this._webgpuProcessingContext.bindGroupLayoutEntries[o]||(this._webgpuProcessingContext.bindGroupLayoutEntries[o]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[o]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[o][l]){let c;r===null?c=this._webgpuProcessingContext.bindGroupLayoutEntries[o].push({binding:l,visibility:0,externalTexture:{}}):n?c=this._webgpuProcessingContext.bindGroupLayoutEntries[o].push({binding:l,visibility:0,storageTexture:{access:"write-only",format:n,viewDimension:r}}):c=this._webgpuProcessingContext.bindGroupLayoutEntries[o].push({binding:l,visibility:0,texture:{sampleType:t.sampleType,viewDimension:r,multisampled:!1}});let f=t.isTextureArray?e+i:e;this._webgpuProcessingContext.bindGroupLayoutEntryInfo[o][l]={name:e,index:c-1,nameInArrayOfTexture:f}}l=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[o][l].index,a?this._webgpuProcessingContext.bindGroupLayoutEntries[o][l].visibility|=1:this._webgpuProcessingContext.bindGroupLayoutEntries[o][l].visibility|=2}_addSamplerBindingDescription(e,t,i){let{groupIndex:r,bindingIndex:n}=t.binding;if(this._webgpuProcessingContext.bindGroupLayoutEntries[r]||(this._webgpuProcessingContext.bindGroupLayoutEntries[r]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[r]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[r][n]){let a=this._webgpuProcessingContext.bindGroupLayoutEntries[r].push({binding:n,visibility:0,sampler:{type:t.type}});this._webgpuProcessingContext.bindGroupLayoutEntryInfo[r][n]={name:e,index:a-1}}n=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[r][n].index,i?this._webgpuProcessingContext.bindGroupLayoutEntries[r][n].visibility|=1:this._webgpuProcessingContext.bindGroupLayoutEntries[r][n].visibility|=2}_addBufferBindingDescription(e,t,i,r){let{groupIndex:n,bindingIndex:a}=t.binding;if(this._webgpuProcessingContext.bindGroupLayoutEntries[n]||(this._webgpuProcessingContext.bindGroupLayoutEntries[n]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[n]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[n][a]){let o=this._webgpuProcessingContext.bindGroupLayoutEntries[n].push({binding:a,visibility:0,buffer:{type:i}});this._webgpuProcessingContext.bindGroupLayoutEntryInfo[n][a]={name:e,index:o-1}}a=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[n][a].index,r?this._webgpuProcessingContext.bindGroupLayoutEntries[n][a].visibility|=1:this._webgpuProcessingContext.bindGroupLayoutEntries[n][a].visibility|=2}};Kt.LeftOvertUBOName="LeftOver";Kt.InternalsUBOName="Internals";Kt.UniformSizes={bool:1,int:1,float:1,vec2:2,ivec2:2,uvec2:2,vec3:3,ivec3:3,uvec3:3,vec4:4,ivec4:4,uvec4:4,mat2:4,mat3:12,mat4:16,i32:1,u32:1,f32:1,mat2x2:4,mat3x3:12,mat4x4:16,mat2x2f:4,mat3x3f:12,mat4x4f:16,vec2i:2,vec3i:3,vec4i:4,vec2u:2,vec3u:3,vec4u:4,vec2f:2,vec3f:3,vec4f:4,vec2h:1,vec3h:2,vec4h:2};Kt._SamplerFunctionByWebGLSamplerType={sampler2D:"sampler2D",sampler2DArray:"sampler2DArray",sampler2DShadow:"sampler2DShadow",sampler2DArrayShadow:"sampler2DArrayShadow",samplerCube:"samplerCube",sampler3D:"sampler3D"};Kt._TextureTypeByWebGLSamplerType={sampler2D:"texture2D",sampler2DArray:"texture2DArray",sampler2DShadow:"texture2D",sampler2DArrayShadow:"texture2DArray",samplerCube:"textureCube",samplerCubeArray:"textureCubeArray",sampler3D:"texture3D"};Kt._GpuTextureViewDimensionByWebGPUTextureType={textureCube:"cube",textureCubeArray:"cube-array",texture2D:"2d",texture2DArray:"2d-array",texture3D:"3d"};Kt._SamplerTypeByWebGLSamplerType={sampler2DShadow:"samplerShadow",sampler2DArrayShadow:"samplerShadow"};Kt._IsComparisonSamplerByWebGPUSamplerType={samplerShadow:!0,samplerArrayShadow:!0,sampler:!1}});var Lx,UK=S(()=>{Rl();Id();Lx=class{get isAsync(){return!1}get isReady(){return!!this.stages}constructor(e,t){this.bindGroupLayouts={},this._name="unnamed",this.shaderProcessingContext=e,this._leftOverUniformsByName={},this.engine=t,this.vertexBufferKindToType={}}_handlesSpectorRebuildCallback(){}_fillEffectInformation(e,t,i,r,n,a,o,l){let c=this.engine;c._doNotHandleContextLost&&(e._fragmentSourceCode="",e._vertexSourceCode="");let f=this.shaderProcessingContext.availableTextures,h;for(h=0;h<n.length;h++){let p=n[h],m=f[n[h]];m==null||m==null?(n.splice(h,1),h--):a[p]=h}for(let p of c.getAttributes(this,o))l.push(p);this.buildUniformLayout();let u=[],d=[];for(h=0;h<o.length;h++){let p=l[h];p>=0&&(u.push(o[h]),d.push(p))}this.shaderProcessingContext.attributeNamesFromEffect=u,this.shaderProcessingContext.attributeLocationsFromEffect=d}buildUniformLayout(){if(this.shaderProcessingContext.leftOverUniforms.length){this.uniformBuffer?.dispose(),this.uniformBuffer=new ii(this.engine,void 0,void 0,"leftOver-"+this._name);for(let e of this.shaderProcessingContext.leftOverUniforms){let t=e.type.replace(/^(.*?)(<.*>)?$/,"$1"),i=Kt.UniformSizes[t];this.uniformBuffer.addUniform(e.name,i,e.length),this._leftOverUniformsByName[e.name]=e.type}this.uniformBuffer.create()}}setEngine(e){this.engine=e}dispose(){this.uniformBuffer&&this.uniformBuffer.dispose()}setInt(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt(e,t)}setInt2(e,t,i){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt2(e,t,i)}setInt3(e,t,i,r){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt3(e,t,i,r)}setInt4(e,t,i,r,n){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt4(e,t,i,r,n)}setIntArray(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateIntArray(e,t)}setIntArray2(e,t){this.setIntArray(e,t)}setIntArray3(e,t){this.setIntArray(e,t)}setIntArray4(e,t){this.setIntArray(e,t)}setUInt(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUInt(e,t)}setUInt2(e,t,i){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUInt2(e,t,i)}setUInt3(e,t,i,r){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUInt3(e,t,i,r)}setUInt4(e,t,i,r,n){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUInt4(e,t,i,r,n)}setUIntArray(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUIntArray(e,t)}setUIntArray2(e,t){this.setUIntArray(e,t)}setUIntArray3(e,t){this.setUIntArray(e,t)}setUIntArray4(e,t){this.setUIntArray(e,t)}setArray(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateArray(e,t)}setArray2(e,t){this.setArray(e,t)}setArray3(e,t){this.setArray(e,t)}setArray4(e,t){this.setArray(e,t)}setMatrices(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrices(e,t)}setMatrix(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrix(e,t)}setMatrix3x3(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrix3x3(e,t)}setMatrix2x2(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrix2x2(e,t)}setFloat(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat(e,t)}setVector2(e,t){this.setFloat2(e,t.x,t.y)}setFloat2(e,t,i){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat2(e,t,i)}setVector3(e,t){this.setFloat3(e,t.x,t.y,t.z)}setFloat3(e,t,i,r){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat3(e,t,i,r)}setVector4(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)}setQuaternion(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)}setFloat4(e,t,i,r,n){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat4(e,t,i,r,n)}setColor3(e,t){this.setFloat3(e,t.r,t.g,t.b)}setColor4(e,t,i){this.setFloat4(e,t.r,t.g,t.b,i)}setDirectColor4(e,t){this.setFloat4(e,t.r,t.g,t.b,t.a)}_getVertexShaderCode(){return this.sources?.vertex}_getFragmentShaderCode(){return this.sources?.fragment}}});var GK,wr,yd=S(()=>{GK={mat2:2,mat3:3,mat4:4,mat2x2:2,mat3x3:3,mat4x4:4},wr=class s{static get KnownUBOs(){return s._SimplifiedKnownBindings?s._SimplifiedKnownUBOs:s._KnownUBOs}constructor(e,t=!1){this.vertexBufferKindToNumberOfComponents={},this.shaderLanguage=e,this._attributeNextLocation=0,this._varyingNextLocation=0,this.freeGroupIndex=0,this.freeBindingIndex=0,this.availableVaryings={},this.availableAttributes={},this.availableBuffers={},this.availableTextures={},this.availableSamplers={},this.orderedAttributes=[],this.bindGroupLayoutEntries=[],this.bindGroupLayoutEntryInfo=[],this.bindGroupEntries=[],this.bufferNames=[],this.textureNames=[],this.samplerNames=[],this.leftOverUniforms=[],t||this._findStartingGroupBinding()}_findStartingGroupBinding(){let e=s.KnownUBOs,t=[];for(let i in e){let r=e[i].binding;r.groupIndex!==-1&&(t[r.groupIndex]===void 0?t[r.groupIndex]=r.bindingIndex:t[r.groupIndex]=Math.max(t[r.groupIndex],r.bindingIndex))}this.freeGroupIndex=t.length-1,this.freeGroupIndex===0?(this.freeGroupIndex++,this.freeBindingIndex=0):this.freeBindingIndex=t[t.length-1]+1}getAttributeNextLocation(e,t=0){let i=this._attributeNextLocation;return this._attributeNextLocation+=(GK[e]??1)*(t||1),i}getVaryingNextLocation(e,t=0){let i=this._varyingNextLocation;return this._varyingNextLocation+=(GK[e]??1)*(t||1),i}getNextFreeUBOBinding(){return this._getNextFreeBinding(1)}_getNextFreeBinding(e){if(this.freeBindingIndex>65536-e&&(this.freeGroupIndex++,this.freeBindingIndex=0),this.freeGroupIndex===4)throw"Too many textures or UBOs have been declared and it is not supported in WebGPU.";let t={groupIndex:this.freeGroupIndex,bindingIndex:this.freeBindingIndex};return this.freeBindingIndex+=e,t}};wr._SimplifiedKnownBindings=!0;wr._SimplifiedKnownUBOs={Scene:{binding:{groupIndex:0,bindingIndex:0}},Light0:{binding:{groupIndex:-1,bindingIndex:-1}},Light1:{binding:{groupIndex:-1,bindingIndex:-1}},Light2:{binding:{groupIndex:-1,bindingIndex:-1}},Light3:{binding:{groupIndex:-1,bindingIndex:-1}},Light4:{binding:{groupIndex:-1,bindingIndex:-1}},Light5:{binding:{groupIndex:-1,bindingIndex:-1}},Light6:{binding:{groupIndex:-1,bindingIndex:-1}},Light7:{binding:{groupIndex:-1,bindingIndex:-1}},Light8:{binding:{groupIndex:-1,bindingIndex:-1}},Light9:{binding:{groupIndex:-1,bindingIndex:-1}},Light10:{binding:{groupIndex:-1,bindingIndex:-1}},Light11:{binding:{groupIndex:-1,bindingIndex:-1}},Light12:{binding:{groupIndex:-1,bindingIndex:-1}},Light13:{binding:{groupIndex:-1,bindingIndex:-1}},Light14:{binding:{groupIndex:-1,bindingIndex:-1}},Light15:{binding:{groupIndex:-1,bindingIndex:-1}},Light16:{binding:{groupIndex:-1,bindingIndex:-1}},Light17:{binding:{groupIndex:-1,bindingIndex:-1}},Light18:{binding:{groupIndex:-1,bindingIndex:-1}},Light19:{binding:{groupIndex:-1,bindingIndex:-1}},Light20:{binding:{groupIndex:-1,bindingIndex:-1}},Light21:{binding:{groupIndex:-1,bindingIndex:-1}},Light22:{binding:{groupIndex:-1,bindingIndex:-1}},Light23:{binding:{groupIndex:-1,bindingIndex:-1}},Light24:{binding:{groupIndex:-1,bindingIndex:-1}},Light25:{binding:{groupIndex:-1,bindingIndex:-1}},Light26:{binding:{groupIndex:-1,bindingIndex:-1}},Light27:{binding:{groupIndex:-1,bindingIndex:-1}},Light28:{binding:{groupIndex:-1,bindingIndex:-1}},Light29:{binding:{groupIndex:-1,bindingIndex:-1}},Light30:{binding:{groupIndex:-1,bindingIndex:-1}},Light31:{binding:{groupIndex:-1,bindingIndex:-1}},Material:{binding:{groupIndex:-1,bindingIndex:-1}},Mesh:{binding:{groupIndex:-1,bindingIndex:-1}},Internals:{binding:{groupIndex:-1,bindingIndex:-1}}};wr._KnownUBOs={Scene:{binding:{groupIndex:0,bindingIndex:0}},Light0:{binding:{groupIndex:1,bindingIndex:0}},Light1:{binding:{groupIndex:1,bindingIndex:1}},Light2:{binding:{groupIndex:1,bindingIndex:2}},Light3:{binding:{groupIndex:1,bindingIndex:3}},Light4:{binding:{groupIndex:1,bindingIndex:4}},Light5:{binding:{groupIndex:1,bindingIndex:5}},Light6:{binding:{groupIndex:1,bindingIndex:6}},Light7:{binding:{groupIndex:1,bindingIndex:7}},Light8:{binding:{groupIndex:1,bindingIndex:8}},Light9:{binding:{groupIndex:1,bindingIndex:9}},Light10:{binding:{groupIndex:1,bindingIndex:10}},Light11:{binding:{groupIndex:1,bindingIndex:11}},Light12:{binding:{groupIndex:1,bindingIndex:12}},Light13:{binding:{groupIndex:1,bindingIndex:13}},Light14:{binding:{groupIndex:1,bindingIndex:14}},Light15:{binding:{groupIndex:1,bindingIndex:15}},Light16:{binding:{groupIndex:1,bindingIndex:16}},Light17:{binding:{groupIndex:1,bindingIndex:17}},Light18:{binding:{groupIndex:1,bindingIndex:18}},Light19:{binding:{groupIndex:1,bindingIndex:19}},Light20:{binding:{groupIndex:1,bindingIndex:20}},Light21:{binding:{groupIndex:1,bindingIndex:21}},Light22:{binding:{groupIndex:1,bindingIndex:22}},Light23:{binding:{groupIndex:1,bindingIndex:23}},Light24:{binding:{groupIndex:1,bindingIndex:24}},Light25:{binding:{groupIndex:1,bindingIndex:25}},Light26:{binding:{groupIndex:1,bindingIndex:26}},Light27:{binding:{groupIndex:1,bindingIndex:27}},Light28:{binding:{groupIndex:1,bindingIndex:28}},Light29:{binding:{groupIndex:1,bindingIndex:29}},Light30:{binding:{groupIndex:1,bindingIndex:30}},Light31:{binding:{groupIndex:1,bindingIndex:31}},Material:{binding:{groupIndex:2,bindingIndex:0}},Mesh:{binding:{groupIndex:2,bindingIndex:1}},Internals:{binding:{groupIndex:2,bindingIndex:2}}}});function Md(s,e,t,i){let r=i,n=0,a="";for(;r<t.length;){let o=t.charAt(r);if(a)o===a?a==='"'||a==="'"?t.charAt(r-1)!=="\\"&&(a=""):a="":a==="*/"&&o==="*"&&r+1<t.length&&(t.charAt(r+1)==="/"&&(a=""),a===""&&r++);else switch(o){case s:n++;break;case e:n--;break;case'"':case"'":case"`":a=o;break;case"/":if(r+1<t.length){let l=t.charAt(r+1);l==="/"?a=`
`:l==="*"&&(a="*/")}break}if(r++,n===0)break}return n===0?r-1:-1}function yP(s,e){for(;e<s.length;){let t=s[e];if(t!==" "&&t!==`
`&&t!=="\r"&&t!=="	"&&t!==`
`&&t!=="\xA0")break;e++}return e}function wx(s){let e=s.charCodeAt(0);return e>=48&&e<=57||e>=65&&e<=90||e>=97&&e<=122||e==95}function Pd(s){let e=0,t="",i=!1,r=[];for(;e<s.length;){let n=s.charAt(e);if(t)n===t?t==='"'||t==="'"?(s.charAt(e-1)!=="\\"&&(t=""),r.push(n)):(t="",i=!1):t==="*/"&&n==="*"&&e+1<s.length?(s.charAt(e+1)==="/"&&(t=""),t===""&&(i=!1,e++)):i||r.push(n);else{switch(n){case'"':case"'":case"`":t=n;break;case"/":if(e+1<s.length){let a=s.charAt(e+1);a==="/"?(t=`
`,i=!0):a==="*"&&(t="*/",i=!0)}break}i||r.push(n)}e++}return r.join("")}function VK(s,e,t,i){for(;e>=0&&s.charAt(e)!==t&&(!i||s.charAt(e)!==i);)e--;return e}function kK(s){return s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Dd(s,e,t,i){let r=s.indexOf(e);if(r<0)return s;if(t){for(;r++<s.length&&s.charAt(r)!="{";);if(r<s.length){let n=s.substring(0,r+1),a=s.substring(r+1);s=n+t+a}}if(i){let n=s.lastIndexOf("}");s=s.substring(0,n),s+=i+`
}`}return s}var Fx=S(()=>{});var Nx,WK=S(()=>{yd();Ee();Id();Fx();Nx=class extends Kt{constructor(){super(...arguments),this._missingVaryings=[],this._textureArrayProcessing=[],this._vertexIsGLES3=!1,this._fragmentIsGLES3=!1,this.shaderLanguage=0,this.parseGLES3=!0}_getArraySize(e,t,i){let r=0,n=e.indexOf("["),a=e.indexOf("]");if(n>0&&a>0){let o=e.substring(n+1,a);r=+o,isNaN(r)&&(r=+i[o.trim()]),e=e.substring(0,n)}return[e,t,r]}initializeShaders(e){this._webgpuProcessingContext=e,this._missingVaryings.length=0,this._textureArrayProcessing.length=0,this.attributeKeywordName=void 0,this.varyingVertexKeywordName=void 0,this.varyingFragmentKeywordName=void 0}preProcessShaderCode(e,t){let i=`// Internals UBO
uniform ${Kt.InternalsUBOName} {
float yFactor_;
float textureOutputHeight_;
};
`,r=e.indexOf("// Internals UBO")!==-1;return t?(this._fragmentIsGLES3=e.indexOf("#version 3")!==-1,this._fragmentIsGLES3&&(this.varyingFragmentKeywordName="in"),r?e:i+`##INJECTCODE##
`+e):(this._vertexIsGLES3=e.indexOf("#version 3")!==-1,this._vertexIsGLES3&&(this.attributeKeywordName="in",this.varyingVertexKeywordName="out"),r?e:i+e)}varyingCheck(e,t){let i=/(flat\s)?\s*\bout\b/,r=/(flat\s)?\s*\bin\b/,n=/(flat\s)?\s*\bvarying\b/;return(t&&this._fragmentIsGLES3?r:!t&&this._vertexIsGLES3?i:n).test(e)}varyingProcessor(e,t,i){this._preProcessors=i;let r=/\s*(flat)?\s*out\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm,n=/\s*(flat)?\s*in\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm,a=/\s*(flat)?\s*varying\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm,l=(t&&this._fragmentIsGLES3?n:!t&&this._vertexIsGLES3?r:a).exec(e);if(l!==null){let c=l[1]??"",f=l[2],h=l[3],u;t?(u=this._webgpuProcessingContext.availableVaryings[h],this._missingVaryings[u]="",u===void 0&&P.Warn(`Invalid fragment shader: The varying named "${h}" is not declared in the vertex shader! This declaration will be ignored.`)):(u=this._webgpuProcessingContext.getVaryingNextLocation(f,this._getArraySize(h,f,i)[2]),this._webgpuProcessingContext.availableVaryings[h]=u,this._missingVaryings[u]=`layout(location = ${u}) ${c} in ${f} ${h};`),e=e.replace(l[0],u===void 0?"":`layout(location = ${u}) ${c} ${t?"in":"out"} ${f} ${h};`)}return e}attributeProcessor(e,t){this._preProcessors=t;let i=/\s*in\s+(\S+)\s+(\S+)\s*;/gm,r=/\s*attribute\s+(\S+)\s+(\S+)\s*;/gm,a=(this._vertexIsGLES3?i:r).exec(e);if(a!==null){let o=a[1],l=a[2],c=this._webgpuProcessingContext.getAttributeNextLocation(o,this._getArraySize(l,o,t)[2]);this._webgpuProcessingContext.availableAttributes[l]=c,this._webgpuProcessingContext.orderedAttributes[c]=l;let f=this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents[l];if(f!==void 0){let h=f<0?f===-1?"int":"ivec"+-f:f===1?"uint":"uvec"+f,u=`_int_${l}_`;e=e.replace(a[0],`layout(location = ${c}) in ${h} ${u}; ${o} ${l} = ${o}(${u});`)}else e=e.replace(a[0],`layout(location = ${c}) in ${o} ${l};`)}return e}uniformProcessor(e,t,i){this._preProcessors=i;let n=/\s*uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm.exec(e);if(n!==null){let a=n[1],o=n[2];if(a.indexOf("sampler")===0||a.indexOf("sampler")===1){let l=0;[o,a,l]=this._getArraySize(o,a,i);let c=this._webgpuProcessingContext.availableTextures[o];if(!c){c={autoBindSampler:!0,isTextureArray:l>0,isStorageTexture:!1,textures:[],sampleType:"float"};for(let M=0;M<(l||1);++M)c.textures.push(this._webgpuProcessingContext.getNextFreeUBOBinding())}let f=Kt._SamplerTypeByWebGLSamplerType[a]??"sampler",h=!!Kt._IsComparisonSamplerByWebGPUSamplerType[f],u=h?"comparison":"filtering",d=o+"Sampler",p=this._webgpuProcessingContext.availableSamplers[d];p||(p={binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),type:u});let m=a.charAt(0)==="u"?"u":a.charAt(0)==="i"?"i":"";m&&(a=a.substring(1));let _=h?"depth":m==="u"?"uint":m==="i"?"sint":"float";c.sampleType=_;let v=l>0,T=p.binding.groupIndex,C=p.binding.bindingIndex,I=Kt._SamplerFunctionByWebGLSamplerType[a],R=Kt._TextureTypeByWebGLSamplerType[a],b=Kt._GpuTextureViewDimensionByWebGPUTextureType[R];if(!v)l=1,e=`layout(set = ${T}, binding = ${C}) uniform ${f} ${d};
                        layout(set = ${c.textures[0].groupIndex}, binding = ${c.textures[0].bindingIndex}) uniform ${m}${R} ${o}Texture;
                        #define ${o} ${m}${I}(${o}Texture, ${d})`;else{let M=[];M.push(`layout(set = ${T}, binding = ${C}) uniform ${m}${f} ${d};`),e=`
`;for(let F=0;F<l;++F){let U=c.textures[F].groupIndex,D=c.textures[F].bindingIndex;M.push(`layout(set = ${U}, binding = ${D}) uniform ${R} ${o}Texture${F};`),e+=`${F>0?`
`:""}#define ${o}${F} ${m}${I}(${o}Texture${F}, ${d})`}e=M.join(`
`)+e,this._textureArrayProcessing.push(o)}this._webgpuProcessingContext.availableTextures[o]=c,this._webgpuProcessingContext.availableSamplers[d]=p,this._addSamplerBindingDescription(d,p,!t);for(let M=0;M<l;++M)this._addTextureBindingDescription(o,c,M,b,null,!t)}else this._addUniformToLeftOverUBO(o,a,i),e=""}return e}uniformBufferProcessor(e,t){let r=/uniform\s+(\w+)/gm.exec(e);if(r!==null){let n=r[1],a=this._webgpuProcessingContext.availableBuffers[n];if(!a){let o=wr.KnownUBOs[n],l;o&&o.binding.groupIndex!==-1?l=o.binding:l=this._webgpuProcessingContext.getNextFreeUBOBinding(),a={binding:l},this._webgpuProcessingContext.availableBuffers[n]=a}this._addBufferBindingDescription(n,a,"uniform",!t),e=e.replace("uniform",`layout(set = ${a.binding.groupIndex}, binding = ${a.binding.bindingIndex}) uniform`)}return e}postProcessor(e,t,i,r,n,a){let o=e.search(/#extension.+GL_EXT_draw_buffers.+require/)!==-1,l=/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g;if(e=e.replace(l,""),e=e.replace(/texture2D\s*\(/g,"texture("),i){let c=e.indexOf("gl_FragCoord")>=0,f=`
                glFragCoord_ = gl_FragCoord;
                if (yFactor_ == 1.) {
                    glFragCoord_.y = textureOutputHeight_ - glFragCoord_.y;
                }
            `,h=c?`vec4 glFragCoord_;
`:"",u=e.search(/layout *\(location *= *0\) *out/g)!==-1;if(e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCubeLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCube\s*\(/g,"texture("),e=e.replace(/gl_FragDepthEXT/g,"gl_FragDepth"),e=e.replace(/gl_FragColor/g,"glFragColor"),e=e.replace(/gl_FragData/g,"glFragData"),e=e.replace(/gl_FragCoord/g,"glFragCoord_"),!this._fragmentIsGLES3)e=e.replace(/void\s+?main\s*\(/g,(o||u?"":`layout(location = 0) out vec4 glFragColor;
`)+"void main(");else{let d=/^\s*out\s+\S+\s+\S+\s*;/gm.exec(e);d!==null&&(e=e.substring(0,d.index)+"layout(location = 0) "+e.substring(d.index))}e=e.replace(/dFdy/g,"(-yFactor_)*dFdy"),e=e.replace("##INJECTCODE##",h),c&&(e=Dd(e,"void main",f))}else if("VERTEXOUTPUT_INVARIANT"in a&&(e=`invariant gl_Position;
`+e),e=e.replace(/gl_InstanceID/g,"gl_InstanceIndex"),e=e.replace(/gl_VertexID/g,"gl_VertexIndex"),t.indexOf("#define MULTIVIEW")!==-1)return`#extension GL_OVR_multiview2 : require
layout (num_views = 2) in;
`+e;if(!i){let c=e.lastIndexOf("}");e=e.substring(0,c),e+=`gl_Position.y *= yFactor_;
`,e+="}"}return e}_applyTextureArrayProcessing(e,t){let i=new RegExp(t+"\\s*\\[(.+)?\\]","gm"),r=i.exec(e);for(;r!==null;){let n=r[1],a=+n;this._preProcessors&&isNaN(a)&&(a=+this._preProcessors[n.trim()]),e=e.replace(r[0],t+a),r=i.exec(e)}return e}_generateLeftOverUBOCode(e,t){let i=`layout(set = ${t.binding.groupIndex}, binding = ${t.binding.bindingIndex}) uniform ${e} {
    `;for(let r of this._webgpuProcessingContext.leftOverUniforms)r.length>0?i+=`    ${r.type} ${r.name}[${r.length}];
`:i+=`    ${r.type} ${r.name};
`;return i+=`};

`,i}finalizeShaders(e,t){for(let r=0;r<this._textureArrayProcessing.length;++r){let n=this._textureArrayProcessing[r];e=this._applyTextureArrayProcessing(e,n),t=this._applyTextureArrayProcessing(t,n)}for(let r=0;r<this._missingVaryings.length;++r){let n=this._missingVaryings[r];n&&n.length>0&&(t=n+`
`+t)}let i=this._buildLeftOverUBO();return e=i+e,t=i+t,this._collectBindingNames(),this._preCreateBindGroupEntries(),this._preProcessors=null,this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents={},{vertexCode:e,fragmentCode:t}}}});var HK,Pre,Dre,Ore,Bx,zK=S(()=>{yd();Ee();Id();Fx();Bn();Gn();Va();Un();Pi();F0();rf();wo();k_();HK="fragmentOutputs.fragDepth",Pre="uniforms",Dre="internals",Ore={texture_1d:"1d",texture_2d:"2d",texture_2d_array:"2d-array",texture_3d:"3d",texture_cube:"cube",texture_cube_array:"cube-array",texture_multisampled_2d:"2d",texture_depth_2d:"2d",texture_depth_2d_array:"2d-array",texture_depth_cube:"cube",texture_depth_cube_array:"cube-array",texture_depth_multisampled_2d:"2d",texture_storage_1d:"1d",texture_storage_2d:"2d",texture_storage_2d_array:"2d-array",texture_storage_3d:"3d",texture_external:null},Bx=class extends Kt{constructor(){super(...arguments),this.shaderLanguage=1,this.uniformRegexp=/uniform\s+(\w+)\s*:\s*(.+)\s*;/,this.textureRegexp=/var\s+(\w+)\s*:\s*((array<\s*)?(texture_\w+)\s*(<\s*(.+)\s*>)?\s*(,\s*\w+\s*>\s*)?);/,this.noPrecision=!0,this.pureMode=!1}_getArraySize(e,t,i){let r=0,n=t.lastIndexOf(">");if(t.indexOf("array")>=0&&n>0){let a=n;for(;a>0&&t.charAt(a)!==" "&&t.charAt(a)!==",";)a--;let o=t.substring(a+1,n);for(r=+o,isNaN(r)&&(r=+i[o.trim()]);a>0&&(t.charAt(a)===" "||t.charAt(a)===",");)a--;t=t.substring(t.indexOf("<")+1,a+1)}return[e,t,r]}initializeShaders(e){this._webgpuProcessingContext=e,this._attributesInputWGSL=[],this._attributesWGSL=[],this._attributesConversionCodeWGSL=[],this._hasNonFloatAttribute=!1,this._varyingsWGSL=[],this._varyingNamesWGSL=[],this._stridedUniformArrays=[]}preProcessShaderCode(e){let t=this.pureMode?"":`struct ${Kt.InternalsUBOName} {
  yFactor_: f32,
  textureOutputHeight_: f32,
};
var<uniform> ${Dre} : ${Kt.InternalsUBOName};
`;return e.indexOf(t)!==-1?e:t+Pd(e)}varyingCheck(e){return/(flat|linear|perspective)?\s*(center|centroid|sample)?\s*\bvarying\b/.test(e)}varyingProcessor(e,t,i){let n=/\s*(flat|linear|perspective)?\s*(center|centroid|sample)?\s*varying\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s*:\s*(.+)\s*;/gm.exec(e);if(n!==null){let a=n[1]??"perspective",o=n[2]??"center",l=n[4],c=n[3],f=a==="flat"?`@interpolate(${a})`:`@interpolate(${a}, ${o})`,h;t?(h=this._webgpuProcessingContext.availableVaryings[c],h===void 0&&P.Warn(`Invalid fragment shader: The varying named "${c}" is not declared in the vertex shader! This declaration will be ignored.`)):(h=this._webgpuProcessingContext.getVaryingNextLocation(l,this._getArraySize(c,l,i)[2]),this._webgpuProcessingContext.availableVaryings[c]=h,this._varyingsWGSL.push(`  @location(${h}) ${f} ${c} : ${l},`),this._varyingNamesWGSL.push(c)),e=""}return e}attributeProcessor(e,t){let r=/\s*attribute\s+(\S+)\s*:\s*(.+)\s*;/gm.exec(e);if(r!==null){let n=r[2],a=r[1],o=this._webgpuProcessingContext.getAttributeNextLocation(n,this._getArraySize(a,n,t)[2]);this._webgpuProcessingContext.availableAttributes[a]=o,this._webgpuProcessingContext.orderedAttributes[o]=a;let l=this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents[a];if(l!==void 0){let c=l<0?l===-1?"i32":"vec"+-l+"<i32>":l===1?"u32":"vec"+l+"<u32>",f=`_int_${a}_`;this._attributesInputWGSL.push(`@location(${o}) ${f} : ${c},`),this._attributesWGSL.push(`${a} : ${n},`),this._attributesConversionCodeWGSL.push(`vertexInputs.${a} = ${n}(vertexInputs_.${f});`),this._hasNonFloatAttribute=!0}else this._attributesInputWGSL.push(`@location(${o}) ${a} : ${n},`),this._attributesWGSL.push(`${a} : ${n},`),this._attributesConversionCodeWGSL.push(`vertexInputs.${a} = vertexInputs_.${a};`);e=""}return e}uniformProcessor(e,t,i){let r=this.uniformRegexp.exec(e);if(r!==null){let n=r[2],a=r[1];this._addUniformToLeftOverUBO(a,n,i),e=""}return e}textureProcessor(e,t,i){let r=this.textureRegexp.exec(e);if(r!==null){let n=r[1],a=r[2],o=!!r[3],l=r[4],c=l.indexOf("storage")>0,f=r[6],h=c?f.substring(0,f.indexOf(",")).trim():null,u=o?this._getArraySize(n,a,i)[2]:0,d=this._webgpuProcessingContext.availableTextures[n];if(d)u=d.textures.length;else{d={isTextureArray:u>0,isStorageTexture:c,textures:[],sampleType:"float"},u=u||1;for(let v=0;v<u;++v)d.textures.push(this._webgpuProcessingContext.getNextFreeUBOBinding())}this._webgpuProcessingContext.availableTextures[n]=d;let p=l.indexOf("depth")>0,m=Ore[l],_=p?"depth":f==="u32"?"uint":f==="i32"?"sint":"float";if(d.sampleType=_,m===void 0)throw`Can't get the texture dimension corresponding to the texture function "${l}"!`;for(let v=0;v<u;++v){let{groupIndex:T,bindingIndex:C}=d.textures[v];v===0&&(e=`@group(${T}) @binding(${C}) ${e}`),this._addTextureBindingDescription(n,d,v,m,h,!t)}}return e}_convertDefinesToConst(e){let t="";for(let i in e){let r=e[i];i.startsWith("__")||(!isNaN(parseInt(r))||!isNaN(parseFloat(r))?t+=`const ${i} = ${r};
`:i&&r===""&&(t+=`const ${i} = true;
`))}return t}postProcessor(e,t,i,r,n,a,o){let l=[];for(let c in o)o[c]!=="true"&&l.push(c);l.sort((c,f)=>c.length-f.length>0?-1:c.length===f.length?0:1);for(let c of l){let f=e.indexOf("#define "+c),h=e.indexOf(`
`,f);h===-1&&(h=e.length);let u=e.substring(f+8+c.length+1,h);e=e.replace(new RegExp(c,"g"),u)}return e=this._convertDefinesToConst(a)+e,"VERTEXOUTPUT_INVARIANT"in a&&(e=`#define VERTEXOUTPUT_INVARIANT
`+e),e}finalizeShaders(e,t){let i=[],r=t.indexOf("fragmentInputs.position")>=0&&!this.pureMode?`
            if (internals.yFactor_ == 1.) {
                fragmentInputs.position.y = internals.textureOutputHeight_ - fragmentInputs.position.y;
            }
        `:"";e=this._processSamplers(e,!0),t=this._processSamplers(t,!1),e=this._processCustomBuffers(e,!0),t=this._processCustomBuffers(t,!1);let n=this._buildLeftOverUBO();e=n+e,t=n+t,e=e.replace(/#define /g,"//#define "),e=this._processStridedUniformArrays(e);let a=`struct VertexInputs {
  @builtin(vertex_index) vertexIndex : u32,
  @builtin(instance_index) instanceIndex : u32,
`;this._attributesInputWGSL.length>0&&(a+=this._attributesInputWGSL.join(`
`)),a+=`
};
var<private> vertexInputs`+(this._hasNonFloatAttribute?"_":"")+` : VertexInputs;
`,this._hasNonFloatAttribute&&(a+=`struct VertexInputs_ {
  vertexIndex : u32, instanceIndex : u32,
`,a+=this._attributesWGSL.join(`
`),a+=`
};
var<private> vertexInputs : VertexInputs_;
`);let o=`struct FragmentInputs {
  @builtin(position)`+(e.indexOf("#define VERTEXOUTPUT_INVARIANT")>=0?" @invariant":"")+` position : vec4<f32>,
`;this._varyingsWGSL.length>0&&(o+=this._varyingsWGSL.join(`
`)),o+=`
};
var<private> vertexOutputs : FragmentInputs;
`,e=a+o+e;let l=`
  vertexInputs${this._hasNonFloatAttribute?"_":""} = input;
`;this._hasNonFloatAttribute&&(l+=`vertexInputs.vertexIndex = vertexInputs_.vertexIndex;
vertexInputs.instanceIndex = vertexInputs_.instanceIndex;
`,l+=this._attributesConversionCodeWGSL.join(`
`),l+=`
`);let c=this.pureMode?"  return vertexOutputs;":`  vertexOutputs.position.y = vertexOutputs.position.y * internals.yFactor_;
  return vertexOutputs;`,f=e.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS")!==-1;e=(f?`diagnostic(off, derivative_uniformity);
`:"")+`diagnostic(off, chromium.unreachable_code);
`+Dd(e,"fn main",l,c),t=t.replace(/#define /g,"//#define "),t=this._processStridedUniformArrays(t),this.pureMode||(t=t.replace(/dpdy/g,"(-internals.yFactor_)*dpdy"));let h=`struct FragmentInputs {
  @builtin(position) position : vec4<f32>,
  @builtin(front_facing) frontFacing : bool,
`;this._varyingsWGSL.length>0&&(h+=this._varyingsWGSL.join(`
`)),h+=`
};
var<private> fragmentInputs : FragmentInputs;
`;let u=`struct FragmentOutputs {
`,d="fragmentOutputs\\.fragData",p=t.match(new RegExp(d+"0","g")),m=0;if(p){u+=` @location(${m}) fragData0 : vec4<f32>,
`,m++;for(let R=1;R<8;R++)p=t.match(new RegExp(d+R,"g")),p&&(u+=` @location(${m}) fragData${m} : vec4<f32>,
`,m++);t.indexOf("MRT_AND_COLOR")!==-1&&(u+=`  @location(${m}) color : vec4<f32>,
`,m++)}let _=/oitDepthSampler/;p=t.match(_),p&&(u+=` @location(${m++}) depth : vec2<f32>,
`,u+=` @location(${m++}) frontColor : vec4<f32>,
`,u+=` @location(${m++}) backColor : vec4<f32>,
`),m===0&&(t.indexOf("DUAL_SOURCE_BLENDING")!==-1?(i.push("dual_source_blending"),u+=`  @location(0) @blend_src(0) color : vec4<f32>,
`,u+=`  @location(0) @blend_src(1) color2 : vec4<f32>,
`):u+=`  @location(0) color : vec4<f32>,
`,m++);let v=!1,T=0;for(;!v&&(T=t.indexOf(HK,T),!(T<0));){let R=T;for(v=!0;T>1&&t.charAt(T)!==`
`;){if(t.charAt(T)==="/"&&t.charAt(T-1)==="/"){v=!1;break}T--}T=R+HK.length}v&&(u+=`  @builtin(frag_depth) fragDepth: f32,
`),u+=`};
var<private> fragmentOutputs : FragmentOutputs;
`,t=h+u+t;let C=`  fragmentInputs = input;
  `+r,I="  return fragmentOutputs;";return f=t.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS")!==-1,i.length>0&&(t="enable "+i.join(`;
enable `)+`;
`+t),t=(f?`diagnostic(off, derivative_uniformity);
`:"")+`diagnostic(off, chromium.unreachable_code);
`+Dd(t,"fn main",C,I),this._collectBindingNames(),this._preCreateBindGroupEntries(),this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents={},{vertexCode:e,fragmentCode:t}}_generateLeftOverUBOCode(e,t){let i="",r=`struct ${e} {
`;for(let n of this._webgpuProcessingContext.leftOverUniforms){let a=n.type.replace(/^(.*?)(<.*>)?$/,"$1"),o=Kt.UniformSizes[a];if(n.length>0)if(o<=2){let l=`${e}_${this._stridedUniformArrays.length}_strided_arr`;i+=`struct ${l} {
                        @size(16)
                        el: ${a},
                    }`,this._stridedUniformArrays.push(n.name),r+=` @align(16) ${n.name} : array<${l}, ${n.length}>,
`}else r+=` ${n.name} : array<${n.type}, ${n.length}>,
`;else r+=`  ${n.name} : ${n.type},
`}return r+=`};
`,r=`${i}
${r}`,r+=`@group(${t.binding.groupIndex}) @binding(${t.binding.bindingIndex}) var<uniform> ${Pre} : ${e};
`,r}_processSamplers(e,t){let i=/var\s+(\w+Sampler)\s*:\s*(sampler|sampler_comparison)\s*;/gm;for(;;){let r=i.exec(e);if(r===null)break;let n=r[1],a=r[2],o=n.length-7,l=n.lastIndexOf("Sampler")===o?n.substring(0,o):null,c=a==="sampler_comparison"?"comparison":"filtering";if(l){let p=this._webgpuProcessingContext.availableTextures[l];p&&(p.autoBindSampler=!0)}let f=this._webgpuProcessingContext.availableSamplers[n];f||(f={binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),type:c},this._webgpuProcessingContext.availableSamplers[n]=f),this._addSamplerBindingDescription(n,f,t);let h=e.substring(0,r.index),u=`@group(${f.binding.groupIndex}) @binding(${f.binding.bindingIndex}) `,d=e.substring(r.index);e=h+u+d,i.lastIndex+=u.length}return e}_processCustomBuffers(e,t){let i=/var<\s*(uniform|storage)\s*(,\s*(read|read_write)\s*)?>\s+(\S+)\s*:\s*(\S+)\s*;/gm;for(;;){let r=i.exec(e);if(r===null)break;let n=r[1],a=r[3],o=r[4],l=r[5],c=this._webgpuProcessingContext.availableBuffers[o];if(!c){let m=n==="uniform"?wr.KnownUBOs[l]:null,_;m?(o=l,_=m.binding,_.groupIndex===-1&&(_=this._webgpuProcessingContext.availableBuffers[o]?.binding,_||(_=this._webgpuProcessingContext.getNextFreeUBOBinding()))):_=this._webgpuProcessingContext.getNextFreeUBOBinding(),c={binding:_},this._webgpuProcessingContext.availableBuffers[o]=c}this._addBufferBindingDescription(o,this._webgpuProcessingContext.availableBuffers[o],a==="read_write"?"storage":n==="storage"?"read-only-storage":"uniform",t);let f=c.binding.groupIndex,h=c.binding.bindingIndex,u=e.substring(0,r.index),d=`@group(${f}) @binding(${h}) `,p=e.substring(r.index);e=u+d+p,i.lastIndex+=d.length}return e}_processStridedUniformArrays(e){for(let t of this._stridedUniformArrays)e=e.replace(new RegExp(`${t}\\s*\\[(.*?)\\]`,"g"),`${t}[$1].el`);return e}}});var al,MP=S(()=>{di();fo();al=class{get underlyingResource(){return this._webgpuTexture}getMSAATexture(e){return this._webgpuMSAATexture?.[e]??null}setMSAATexture(e,t){this._webgpuMSAATexture||(this._webgpuMSAATexture=[]),this._webgpuMSAATexture[t]=e}releaseMSAATexture(e){if(this._webgpuMSAATexture)if(e!==void 0)this._engine._textureHelper.releaseTexture(this._webgpuMSAATexture[e]),delete this._webgpuMSAATexture[e];else{for(let t of this._webgpuMSAATexture)this._engine._textureHelper.releaseTexture(t);this._webgpuMSAATexture=null}}constructor(e,t=null){this._engine=e,this._originalFormatIsRGB=!1,this.format="rgba8unorm",this.textureUsages=0,this.textureAdditionalUsages=0,this._webgpuTexture=t,this._webgpuMSAATexture=null,this.view=null,this.viewForWriting=null}set(e){this._webgpuTexture=e}setUsage(e,t,i,r,n,a,o,l){let c="2d",f=1;r?(c=i?"cube-array":"cube",f=6*(l||1)):n?(c="3d",f=1):i&&(c="2d-array",f=l);let h=tt.GetDepthFormatOnly(this.format),u=tt.HasDepthAndStencilAspects(this.format)?"depth-only":"all";this.createView({label:`TextureView${n?"3D":r?"Cube":"2D"}${i?"_Array"+f:""}_${a}x${o}_${t?"wmips":"womips"}_${this.format}_${c}`,format:h,dimension:c,mipLevelCount:t?bs(Math.max(a,o))+1:1,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:f,aspect:u})}createView(e,t=!1){if(this.view=this._webgpuTexture.createView(e),t&&e){let i=e.mipLevelCount;e.mipLevelCount=1,this.viewForWriting=this._webgpuTexture.createView(e),e.mipLevelCount=i}}reset(){this._webgpuTexture=null,this._webgpuMSAATexture=null,this.view=null,this.viewForWriting=null}release(){this._webgpuTexture?.destroy(),this.releaseMSAATexture(),this._copyInvertYTempTexture?.destroy(),this.reset()}}});var Lre,wre,YK,Fre,Nre,Bre,Ure,Gre,Vre,kre,Wre,gn,ph,XK,Vs,Ux,Gx=S(()=>{dh();MP();fo();Mh();Lre=`
    const pos = array<vec2<f32>, 4>( vec2f(-1.0f, 1.0f),  vec2f(1.0f, 1.0f),  vec2f(-1.0f, -1.0f),  vec2f(1.0f, -1.0f));
    const tex = array<vec2<f32>, 4>( vec2f(0.0f, 0.0f),  vec2f(1.0f, 0.0f),  vec2f(0.0f, 1.0f),  vec2f(1.0f, 1.0f));

    varying vTex: vec2f;

    @vertex
    fn main(input : VertexInputs) -> FragmentInputs {
        vertexOutputs.vTex = tex[input.vertexIndex];
        vertexOutputs.position = vec4f(pos[input.vertexIndex], 0.0, 1.0);
    }
    `,wre=`
    var imgSampler: sampler;
    var img: texture_2d<f32>;

    varying vTex: vec2f;

    @fragment
    fn main(input: FragmentInputs) -> FragmentOutputs {
        fragmentOutputs.color = textureSample(img, imgSampler, input.vTex);
    }
    `,YK=`
    const pos = array<vec2<f32>, 4>( vec2f(-1.0f, 1.0f),  vec2f(1.0f, 1.0f),  vec2f(-1.0f, -1.0f),  vec2f(1.0f, -1.0f));
    const tex = array<vec2<f32>, 4>( vec2f(0.0f, 0.0f),  vec2f(1.0f, 0.0f),  vec2f(0.0f, 1.0f),  vec2f(1.0f, 1.0f));

    var img: texture_2d<f32>;

    #ifdef INVERTY
        varying vTextureSize: vec2f;
    #endif

    @vertex
    fn main(input : VertexInputs) -> FragmentInputs {
        #ifdef INVERTY
            vertexOutputs.vTextureSize = vec2f(textureDimensions(img, 0));
        #endif
        vertexOutputs.position =  vec4f(pos[input.vertexIndex], 0.0, 1.0);
    }
    `,Fre=`
    var img: texture_2d<f32>;

    #ifdef INVERTY
        varying vTextureSize: vec2f;
    #endif

    @fragment
    fn main(input: FragmentInputs) -> FragmentOutputs {
    #ifdef INVERTY
        var color: vec4f = textureLoad(img, vec2i(i32(input.position.x), i32(input.vTextureSize.y - input.position.y)), 0);
    #else
        var color: vec4f = textureLoad(img, vec2i(input.position.xy), 0);
    #endif
    #ifdef PREMULTIPLYALPHA
        color = vec4f(color.rgb * color.a, color.a);
    #endif
        fragmentOutputs.color = color;
    }
    `,Nre=YK,Bre=`
    var img: texture_2d<f32>;
    uniform ofstX: f32;
    uniform ofstY: f32;
    uniform width: f32;
    uniform height: f32;

    #ifdef INVERTY
        varying vTextureSize: vec2f;
    #endif

    @fragment
    fn main(input: FragmentInputs) -> FragmentOutputs {
        if (input.position.x < uniforms.ofstX || input.position.x >= uniforms.ofstX + uniforms.width) {
            discard;
        }
        if (input.position.y < uniforms.ofstY || input.position.y >= uniforms.ofstY + uniforms.height) {
            discard;
        }
    #ifdef INVERTY
        var color: vec4f = textureLoad(img, vec2i(i32(input.position.x), i32(uniforms.ofstY + uniforms.height - (input.position.y - uniforms.ofstY))), 0);
    #else
        var color: vec4f = textureLoad(img, vec2i(input.position.xy), 0);
    #endif
    #ifdef PREMULTIPLYALPHA
        color = vec4f(color.rgb * color.a, color.a);
    #endif
        fragmentOutputs.color = color;
    }
    `,Ure=`
    const pos = array<vec2<f32>, 4>( vec2f(-1.0f, 1.0f),  vec2f(1.0f, 1.0f),  vec2f(-1.0f, -1.0f),  vec2f(1.0f, -1.0f));

    @vertex
    fn main(input : VertexInputs) -> FragmentInputs {
        vertexOutputs.position =  vec4f(pos[input.vertexIndex], 0.0, 1.0);
    }
    `,Gre=`
    uniform color: vec4f;


    @fragment
    fn main(input: FragmentInputs) -> FragmentOutputs {
        fragmentOutputs.color = uniforms.color;
    }
    `,Vre=`
    struct VertexOutput {
        @builtin(position) Position : vec4<f32>,
        @location(0) fragUV : vec2<f32>
    }

    @vertex
    fn main(
        @builtin(vertex_index) VertexIndex : u32
    ) -> VertexOutput {
        var pos = array<vec2<f32>, 4>(
            vec2(-1.0,  1.0),
            vec2( 1.0,  1.0),
            vec2(-1.0, -1.0),
            vec2( 1.0, -1.0)
        );
        var tex = array<vec2<f32>, 4>(
            vec2(0.0, 0.0),
            vec2(1.0, 0.0),
            vec2(0.0, 1.0),
            vec2(1.0, 1.0)
        );

        var output: VertexOutput;

        output.Position = vec4<f32>(pos[VertexIndex], 0.0, 1.0);
        output.fragUV = tex[VertexIndex];

        return output;
    }
    `,kre=`
    @group(0) @binding(0) var videoSampler: sampler;
    @group(0) @binding(1) var videoTexture: texture_external;

    @fragment
    fn main(
        @location(0) fragUV: vec2<f32>
    ) -> @location(0) vec4<f32> {
        return textureSampleBaseClampToEdge(videoTexture, videoSampler, fragUV);
    }
    `,Wre=`
    @group(0) @binding(0) var videoSampler: sampler;
    @group(0) @binding(1) var videoTexture: texture_external;

    @fragment
    fn main(
        @location(0) fragUV: vec2<f32>
    ) -> @location(0) vec4<f32> {
        return textureSampleBaseClampToEdge(videoTexture, videoSampler, vec2<f32>(fragUV.x, 1.0 - fragUV.y));
    }
    `;(function(s){s[s.MipMap=0]="MipMap",s[s.InvertYPremultiplyAlpha=1]="InvertYPremultiplyAlpha",s[s.Clear=2]="Clear",s[s.InvertYPremultiplyAlphaWithOfst=3]="InvertYPremultiplyAlphaWithOfst"})(gn||(gn={}));(function(s){s[s.DontInvertY=0]="DontInvertY",s[s.InvertY=1]="InvertY"})(ph||(ph={}));XK=[{vertex:Lre,fragment:wre},{vertex:YK,fragment:Fre},{vertex:Ure,fragment:Gre},{vertex:Nre,fragment:Bre}],Vs={"":0,r8unorm:1,r8uint:2,r8sint:3,r16uint:4,r16sint:5,r16float:6,rg8unorm:7,rg8uint:8,rg8sint:9,r32uint:10,r32sint:11,r32float:12,rg16uint:13,rg16sint:14,rg16float:15,rgba8unorm:16,"rgba8unorm-srgb":17,rgba8uint:18,rgba8sint:19,bgra8unorm:20,"bgra8unorm-srgb":21,rgb10a2uint:22,rgb10a2unorm:23,rg32uint:24,rg32sint:25,rg32float:26,rgba16uint:27,rgba16sint:28,rgba16float:29,rgba32uint:30,rgba32sint:31,rgba32float:32,stencil8:33,depth16unorm:34,depth24plus:35,"depth24plus-stencil8":36,depth32float:37,"depth32float-stencil8":38,r16unorm:39,rg16unorm:40,rgba16unorm:41,r16snorm:42,rg16snorm:43,rgba16snorm:44},Ux=class{constructor(e,t,i,r){if(this._pipelines={},this._compiledShaders=[],this._videoPipelines={},this._videoCompiledShaders=[],this._deferredReleaseTextures=[],this._engine=e,this._device=t,this._bufferManager=i,r.indexOf("rg11b10ufloat-renderable")!==-1){let n=Object.keys(Vs);Vs.rg11b10ufloat=Vs[n[n.length-1]]+1}this._mipmapSampler=t.createSampler({minFilter:"linear"}),this._videoSampler=t.createSampler({minFilter:"linear"}),this._ubCopyWithOfst=this._bufferManager.createBuffer(16,rt.Uniform|rt.CopyDst,"UBCopyWithOffset").underlyingResource,this._getPipeline("rgba8unorm"),this._getVideoPipeline("rgba8unorm")}_getPipeline(e,t=gn.MipMap,i){let r=t===gn.MipMap?1:t===gn.InvertYPremultiplyAlpha?((i.invertY?1:0)<<1)+((i.premultiplyAlpha?1:0)<<2):t===gn.Clear?8:t===gn.InvertYPremultiplyAlphaWithOfst?((i.invertY?1:0)<<4)+((i.premultiplyAlpha?1:0)<<5):0;this._pipelines[e]||(this._pipelines[e]=[]);let n=this._pipelines[e][r];if(!n){let a="";(t===gn.InvertYPremultiplyAlpha||t===gn.InvertYPremultiplyAlphaWithOfst)&&(i.invertY&&(a+=`#define INVERTY
`),i.premultiplyAlpha&&(a+=`#define PREMULTIPLYALPHA
`));let o=this._compiledShaders[r];if(!o){let c=XK[t].vertex,f=XK[t].fragment,h={defines:a.split(`
`),indexParameters:null,isFragment:!1,shouldUseHighPrecisionShader:!0,processor:this._engine._getShaderProcessor(1),supportsUniformBuffers:!0,shadersRepository:"",includesShadersStore:{},version:(this._engine.version*100).toString(),platformName:this._engine.shaderPlatformName,processingContext:this._engine._getShaderProcessingContext(1,!0),isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer};Cp(h),h.processor.pureMode=!0,Pc(c,h,m=>{c=m},this._engine),h.isFragment=!0,Pc(f,h,m=>{f=m},this._engine);let u=Ip(c,f,h);h.processor.pureMode=!1;let d=this._device.createShaderModule({label:`BabylonWebGPUDevice${this._engine.uniqueId}_InternalVertexShader_${r}`,code:u.vertexCode}),p=this._device.createShaderModule({label:`BabylonWebGPUDevice${this._engine.uniqueId}_InternalFragmentShader_${r}`,code:u.fragmentCode});o=this._compiledShaders[r]=[d,p]}let l=this._device.createRenderPipeline({label:`BabylonWebGPUDevice${this._engine.uniqueId}_InternalPipeline_${e}_${r}`,layout:"auto",vertex:{module:o[0],entryPoint:"main"},fragment:{module:o[1],entryPoint:"main",targets:[{format:e}]},primitive:{topology:"triangle-strip",stripIndexFormat:"uint16"}});n=this._pipelines[e][r]=[l,l.getBindGroupLayout(0)]}return n}_getVideoPipeline(e,t=ph.DontInvertY){let i=t===ph.InvertY?1:0;this._videoPipelines[e]||(this._videoPipelines[e]=[]);let r=this._videoPipelines[e][i];if(!r){let n=this._videoCompiledShaders[i];if(!n){let o=this._device.createShaderModule({code:Vre,label:`BabylonWebGPUDevice${this._engine.uniqueId}_CopyVideoToTexture_VertexShader`}),l=this._device.createShaderModule({code:i===0?kre:Wre,label:`BabylonWebGPUDevice${this._engine.uniqueId}_CopyVideoToTexture_FragmentShader_${i===0?"DontInvertY":"InvertY"}`});n=this._videoCompiledShaders[i]=[o,l]}let a=this._device.createRenderPipeline({label:`BabylonWebGPUDevice${this._engine.uniqueId}_InternalVideoPipeline_${e}_${i===0?"DontInvertY":"InvertY"}`,layout:"auto",vertex:{module:n[0],entryPoint:"main"},fragment:{module:n[1],entryPoint:"main",targets:[{format:e}]},primitive:{topology:"triangle-strip",stripIndexFormat:"uint16"}});r=this._videoPipelines[e][i]=[a,a.getBindGroupLayout(0)]}return r}setCommandEncoder(e){this._commandEncoderForCreation=e}copyVideoToTexture(e,t,i,r=!1,n){let a=n===void 0,[o,l]=this._getVideoPipeline(i,r?ph.InvertY:ph.DontInvertY);a&&(n=this._device.createCommandEncoder({})),n.pushDebugGroup?.(`copy video to texture - invertY=${r}`);let c=t._hardwareTexture,f={label:`BabylonWebGPUDevice${this._engine.uniqueId}_copyVideoToTexture_${i}_${r?"InvertY":"DontInvertY"}${t.label?"_"+t.label:""}`,colorAttachments:[{view:c.underlyingResource.createView({format:i,dimension:"2d",mipLevelCount:1,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:1,aspect:"all"}),loadOp:"load",storeOp:"store"}]},h=n.beginRenderPass(f),u={layout:l,entries:[{binding:0,resource:this._videoSampler},{binding:1,resource:this._device.importExternalTexture({source:e.underlyingResource})}]},d=this._device.createBindGroup(u);h.setPipeline(o),h.setBindGroup(0,d),h.draw(4,1,0,0),h.end(),n.popDebugGroup?.(),a&&(this._device.queue.submit([n.finish()]),n=null)}invertYPreMultiplyAlpha(e,t,i,r,n=!1,a=!1,o=0,l=0,c=1,f=0,h=0,u=0,d=0,p,m){let _=u!==0,v=p===void 0,[T,C]=this._getPipeline(r,_?gn.InvertYPremultiplyAlphaWithOfst:gn.InvertYPremultiplyAlpha,{invertY:n,premultiplyAlpha:a});o=Math.max(o,0),v&&(p=this._device.createCommandEncoder({})),p.pushDebugGroup?.(`internal process texture - invertY=${n} premultiplyAlpha=${a}`);let I;if(tt.IsHardwareTexture(e)?(I=e.underlyingResource,n&&!a&&c===1&&o===0||(e=void 0)):(I=e,e=void 0),!I)return;_&&this._bufferManager.setRawData(this._ubCopyWithOfst,0,new Float32Array([f,h,u,d]),0,16);let R=e,b=R?._copyInvertYTempTexture??this.createTexture({width:t,height:i,layers:1},!1,!1,!1,!1,!1,r,1,p,21,void 0,"TempTextureForCopyWithInvertY"),M=R?._copyInvertYRenderPassDescr??{label:`BabylonWebGPUDevice${this._engine.uniqueId}_invertYPreMultiplyAlpha_${r}_${n?"InvertY":"DontInvertY"}_${a?"PremultiplyAlpha":"DontPremultiplyAlpha"}`,colorAttachments:[{view:b.createView({format:r,dimension:"2d",baseMipLevel:0,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:0}),loadOp:"load",storeOp:"store"}]},F=p.beginRenderPass(M),U=_?R?._copyInvertYBindGroupWithOfst:R?._copyInvertYBindGroup;if(!U){let D={layout:C,entries:[{binding:0,resource:I.createView({format:r,dimension:"2d",baseMipLevel:l,mipLevelCount:1,arrayLayerCount:c,baseArrayLayer:o})}]};_&&D.entries.push({binding:1,resource:{buffer:this._ubCopyWithOfst}}),U=this._device.createBindGroup(D)}F.setPipeline(T),F.setBindGroup(0,U),F.draw(4,1,0,0),F.end(),p.copyTextureToTexture({texture:b},{texture:I,mipLevel:l,origin:{x:0,y:0,z:o}},{width:u||t,height:d||i,depthOrArrayLayers:1}),R?(R._copyInvertYTempTexture=b,R._copyInvertYRenderPassDescr=M,_?R._copyInvertYBindGroupWithOfst=U:R._copyInvertYBindGroup=U):this._deferredReleaseTextures.push([b,null]),p.popDebugGroup?.(),v&&(this._device.queue.submit([p.finish()]),p=null)}createTexture(e,t=!1,i=!1,r=!1,n=!1,a=!1,o="rgba8unorm",l=1,c,f=-1,h=0,u){l=tt.GetSample(l);let d=e.layers||1,p={width:e.width,height:e.height,depthOrArrayLayers:d},m=Vs[o]?16:0,_=tt.IsCompressedFormat(o),v=t?tt.ComputeNumMipmapLevels(e.width,e.height):1,T=f>=0?f:7;h|=t&&!_?1|m:0,!_&&!a&&(h|=m|2);let C=this._device.createTexture({label:`BabylonWebGPUDevice${this._engine.uniqueId}_Texture${a?"3D":"2D"}_${u?u+"_":""}${p.width}x${p.height}x${p.depthOrArrayLayers}_${t?"wmips":"womips"}_${o}_samples${l}`,size:p,dimension:a?"3d":"2d",format:o,usage:T|h,sampleCount:l,mipLevelCount:v});return tt.IsImageBitmap(e)&&(this.updateTexture(e,C,e.width,e.height,d,o,0,0,r,n,0,0),t&&i&&this.generateMipmaps(C,o,v,0,a,c)),C}createCubeTexture(e,t=!1,i=!1,r=!1,n=!1,a="rgba8unorm",o=1,l,c=-1,f=0,h){o=tt.GetSample(o);let u=tt.IsImageBitmapArray(e)?e[0].width:e.width,d=tt.IsImageBitmapArray(e)?e[0].height:e.height,p=Vs[a]?16:0,m=tt.IsCompressedFormat(a),_=t?tt.ComputeNumMipmapLevels(u,d):1,v=c>=0?c:7;f|=t&&!m?1|p:0,m||(f|=p|2);let T=this._device.createTexture({label:`BabylonWebGPUDevice${this._engine.uniqueId}_TextureCube_${h?h+"_":""}${u}x${d}x6_${t?"wmips":"womips"}_${a}_samples${o}`,size:{width:u,height:d,depthOrArrayLayers:6},dimension:"2d",format:a,usage:v|f,sampleCount:o,mipLevelCount:_});return tt.IsImageBitmapArray(e)&&(this.updateCubeTextures(e,T,u,d,a,r,n,0,0),t&&i&&this.generateCubeMipmaps(T,a,_,l)),T}generateCubeMipmaps(e,t,i,r){let n=r===void 0;n&&(r=this._device.createCommandEncoder({})),r.pushDebugGroup?.(`create cube mipmaps - ${i} levels`);for(let a=0;a<6;++a)this.generateMipmaps(e,t,i,a,!1,r);r.popDebugGroup?.(),n&&(this._device.queue.submit([r.finish()]),r=null)}generateMipmaps(e,t,i,r=0,n=!1,a){let o=a===void 0,[l,c]=this._getPipeline(t);r=Math.max(r,0),o&&(a=this._device.createCommandEncoder({})),a.pushDebugGroup?.(`create mipmaps for face #${r} - ${i} levels`);let f;if(tt.IsHardwareTexture(e)?(f=e.underlyingResource,e._mipmapGenRenderPassDescr=e._mipmapGenRenderPassDescr||[],e._mipmapGenBindGroup=e._mipmapGenBindGroup||[]):(f=e,e=void 0),!f)return;let h=e;for(let u=1;u<i;++u){let d=h?._mipmapGenRenderPassDescr[r]?.[u-1]??{label:`BabylonWebGPUDevice${this._engine.uniqueId}_generateMipmaps_${t}_faceIndex${r}_level${u}`,colorAttachments:[{view:f.createView({format:t,dimension:n?"3d":"2d",baseMipLevel:u,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:r}),loadOp:"load",storeOp:"store"}]};h&&(h._mipmapGenRenderPassDescr[r]=h._mipmapGenRenderPassDescr[r]||[],h._mipmapGenRenderPassDescr[r][u-1]=d);let p=a.beginRenderPass(d),m=h?._mipmapGenBindGroup[r]?.[u-1]??this._device.createBindGroup({layout:c,entries:[{binding:0,resource:f.createView({format:t,dimension:n?"3d":"2d",baseMipLevel:u-1,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:r})},{binding:1,resource:this._mipmapSampler}]});h&&(h._mipmapGenBindGroup[r]=h._mipmapGenBindGroup[r]||[],h._mipmapGenBindGroup[r][u-1]=m),p.setPipeline(l),p.setBindGroup(0,m),p.draw(4,1,0,0),p.end()}a.popDebugGroup?.(),o&&(this._device.queue.submit([a.finish()]),a=null)}createGPUTextureForInternalTexture(e,t,i,r,n,a){e._hardwareTexture||(e._hardwareTexture=new al(this._engine)),t===void 0&&(t=e.width),i===void 0&&(i=e.height),r===void 0&&(r=e.depth);let o=e._hardwareTexture,l=((n??0)&1)!==0;o.format=tt.GetWebGPUTextureFormat(e.type,e.format,e._useSRGBBuffer),o.textureUsages=e._source===5||e.source===6?21:e._source===12?20:-1,o.textureAdditionalUsages=l?8:0;let c=e.generateMipMaps,f=r||1,h;if(e._maxLodLevel!==null?h=e._maxLodLevel:h=c?tt.ComputeNumMipmapLevels(t,i):1,e.isCube){let u=this.createCubeTexture({width:t,height:i},e.generateMipMaps,e.generateMipMaps,e.invertY,!1,o.format,1,this._commandEncoderForCreation,o.textureUsages,o.textureAdditionalUsages,e.label);o.set(u);let d=e.is3D?1:f,p=tt.GetDepthFormatOnly(o.format),m=tt.HasDepthAndStencilAspects(o.format)?"depth-only":"all",_=e.is2DArray?"cube-array":"cube";o.createView({label:`BabylonWebGPUDevice${this._engine.uniqueId}_TextureViewCube${e.is2DArray?"_Array"+d:""}_${t}x${i}_${c?"wmips":"womips"}_${p}_${_}_${m}_${e.label??"noname"}`,format:p,dimension:_,mipLevelCount:h,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:6,aspect:m},l)}else{let u=this.createTexture({width:t,height:i,layers:f},e.generateMipMaps,e.generateMipMaps,e.invertY,!1,e.is3D,o.format,1,this._commandEncoderForCreation,o.textureUsages,o.textureAdditionalUsages,e.label);o.set(u);let d=e.is3D?1:f,p=tt.GetDepthFormatOnly(o.format),m=tt.HasDepthAndStencilAspects(o.format)?"depth-only":"all",_=e.is2DArray?"2d-array":e.is3D?"3d":"2d";o.createView({label:`BabylonWebGPUDevice${this._engine.uniqueId}_TextureView${e.is3D?"3D":"2D"}${e.is2DArray?"_Array"+d:""}_${t}x${i}${e.is3D?"x"+f:""}_${c?"wmips":"womips"}_${p}_${_}_${m}_${e.label??"noname"}`,format:p,dimension:_,mipLevelCount:h,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:d,aspect:m},l)}return e.width=e.baseWidth=t,e.height=e.baseHeight=i,e.depth=e.baseDepth=r,a||this.createMSAATexture(e,e.samples),o}createMSAATexture(e,t,i=!0,r=0){let n=e._hardwareTexture;if(i&&n?.releaseMSAATexture(),!n||(t??1)<=1)return;let a=e.width,o=e.height,l=this.createTexture({width:a,height:o,layers:1},!1,!1,!1,!1,!1,n.format,t,this._commandEncoderForCreation,16,0,e.label?"MSAA_"+e.label:"MSAA");n.setMSAATexture(l,r)}updateCubeTextures(e,t,i,r,n,a=!1,o=!1,l=0,c=0){let f=[0,3,1,4,2,5];for(let h=0;h<f.length;++h){let u=e[f[h]];this.updateTexture(u,t,i,r,1,n,h,0,a,o,l,c)}}updateTexture(e,t,i,r,n,a,o=0,l=0,c=!1,f=!1,h=0,u=0,d){let p=tt.IsInternalTexture(t)?t._hardwareTexture.underlyingResource:t,m=tt.GetBlockInformationFromFormat(a),_=tt.IsInternalTexture(t)?t._hardwareTexture:t,v={texture:p,origin:{x:h,y:u,z:Math.max(o,0)},mipLevel:l,premultipliedAlpha:f},T={width:Math.ceil(i/m.width)*m.width,height:Math.ceil(r/m.height)*m.height,depthOrArrayLayers:n||1};if(e.byteLength!==void 0){e=e;let C=Math.ceil(i/m.width)*m.length;if(Math.ceil(C/256)*256===C){let R=this._device.createCommandEncoder({}),b=this._bufferManager.createRawBuffer(e.byteLength,rt.MapWrite|rt.CopySrc,!0,"TempBufferForUpdateTexture"+(p?"_"+p.label:"")),M=b.getMappedRange();new Uint8Array(M).set(e),b.unmap(),R.copyBufferToTexture({buffer:b,offset:0,bytesPerRow:C,rowsPerImage:r},v,T),this._device.queue.submit([R.finish()]),this._bufferManager.releaseBuffer(b)}else this._device.queue.writeTexture(v,e,{offset:0,bytesPerRow:C,rowsPerImage:r},T);if(c||f)if(tt.IsInternalTexture(t)){let R=h===0&&u===0&&i===t.width&&r===t.height;this.invertYPreMultiplyAlpha(_,t.width,t.height,a,c,f,o,l,n||1,h,u,R?0:i,R?0:r,void 0,d)}else throw"updateTexture: Can't process the texture data because a GPUTexture was provided instead of an InternalTexture!"}else e=e,this._device.queue.copyExternalImageToTexture({source:e,flipY:c},v,T)}readPixels(e,t,i,r,n,a,o=0,l=0,c=null,f=!1){let h=tt.GetBlockInformationFromFormat(a),u=Math.ceil(r/h.width)*h.length,d=Math.ceil(u/256)*256,p=d*n,m=this._bufferManager.createRawBuffer(p,rt.MapRead|rt.CopyDst,void 0,"TempBufferForReadPixels"+(e.label?"_"+e.label:"")),_=this._device.createCommandEncoder({});return _.copyTextureToBuffer({texture:e,mipLevel:l,origin:{x:t,y:i,z:Math.max(o,0)}},{buffer:m,offset:0,bytesPerRow:d},{width:r,height:n,depthOrArrayLayers:1}),this._device.queue.submit([_.finish()]),this._bufferManager.readDataFromBuffer(m,p,r,n,u,d,tt.GetTextureTypeFromFormat(a),0,c,!0,f)}releaseTexture(e){if(tt.IsInternalTexture(e)){let t=e._hardwareTexture,i=e._irradianceTexture;this._deferredReleaseTextures.push([t,i])}else this._deferredReleaseTextures.push([e,null])}destroyDeferredTextures(){for(let e=0;e<this._deferredReleaseTextures.length;++e){let[t,i]=this._deferredReleaseTextures[e];t&&(tt.IsHardwareTexture(t)?t.release():t.destroy()),i?.dispose()}this._deferredReleaseTextures.length=0}}});var Vx,KK=S(()=>{kp();Vx=class extends ga{set buffer(e){this._buffer=e}constructor(e,t=0){super(),this.engineId=-1,this.capacity=t,e&&(this._buffer=e)}get underlyingResource(){return this._buffer}}});var kx,qK=S(()=>{KK();Hc();fa();dh();kx=class s{static _IsGPUBuffer(e){return e.underlyingResource===void 0}static _FlagsToString(e,t=""){let i=t;for(let r=0;r<=9;++r)e&1<<r&&(i&&(i+="_"),i+=rt[1<<r]);return i}constructor(e,t){this._deferredReleaseBuffers=[],this._engine=e,this._device=t}createRawBuffer(e,t,i=!1,r){let n=e.byteLength!==void 0?e.byteLength+3&-4:e+3&-4,a={label:"BabylonWebGPUDevice"+this._engine.uniqueId+"_"+s._FlagsToString(t,r??"Buffer")+"_size"+n,mappedAtCreation:i,size:n,usage:t};return this._device.createBuffer(a)}createBuffer(e,t,i){let r=e.byteLength!==void 0,n=new Vx,a="DataBufferUniqueId="+n.uniqueId;return n.buffer=this.createRawBuffer(e,t,void 0,i?a+"-"+i:a),n.references=1,n.capacity=r?e.byteLength:e,n.engineId=this._engine.uniqueId,r&&this.setSubData(n,0,e),n}setRawData(e,t,i,r,n){r+=i.byteOffset,this._device.queue.writeBuffer(e,t,i.buffer,r,n)}setSubData(e,t,i,r=0,n=0){let a=e.underlyingResource;n=n||i.byteLength-r;let o=t&3;r-=o,t-=o;let l=n;if(n=n+o+3&-4,i.buffer.byteLength-i.byteOffset<n){let f=new Uint8Array(n);f.set(new Uint8Array(i.buffer,i.byteOffset+r,l)),i=f,r=0}this.setRawData(a,t,i,r,n)}_getHalfFloatAsFloatRGBAArrayBuffer(e,t,i){i?e=Math.min(e,i.length):i=new Float32Array(e);let r=new Uint16Array(t);for(;e--;)i[e]=Zs(r[e]);return i}readDataFromBuffer(e,t,i,r,n,a,o=0,l=0,c=null,f=!0,h=!1){let u=o===1?2:o===2?1:0,d=this._engine.uniqueId;return new Promise((p,m)=>{e.mapAsync(1,l,t).then(()=>{let _=e.getMappedRange(l,t),v=c;if(h)v===null?v=Ih(o,t,!0,_):v=Ih(o,v.buffer,void 0,_);else if(v===null)switch(u){case 0:v=new Uint8Array(t),v.set(new Uint8Array(_));break;case 1:v=this._getHalfFloatAsFloatRGBAArrayBuffer(t/2,_);break;case 2:v=new Float32Array(t/4),v.set(new Float32Array(_));break}else switch(u){case 0:v=new Uint8Array(v.buffer),v.set(new Uint8Array(_,0,Math.min(v.byteLength,t)));break;case 1:v=this._getHalfFloatAsFloatRGBAArrayBuffer(t/2,_,c);break;case 2:v=new Float32Array(v.buffer),v.set(new Float32Array(_,0,v.byteLength/4));break}if(n!==a){u===1&&!h&&(n*=2,a*=2);let T=new Uint8Array(v.buffer),C=n,I=0;for(let R=1;R<r;++R){I=R*a;for(let b=0;b<n;++b)T[C++]=T[I++]}u!==0&&!h?v=new Float32Array(T.buffer,0,C/4):v=new Uint8Array(T.buffer,0,C)}e.unmap(),f&&this.releaseBuffer(e),p(v)},_=>{this._engine.isDisposed||this._engine.uniqueId!==d?p(new Uint8Array):m(_)})})}releaseBuffer(e){return s._IsGPUBuffer(e)?(this._deferredReleaseBuffers.push(e),!0):(e.references--,e.references===0?(this._deferredReleaseBuffers.push(e.underlyingResource),!0):!1)}destroyDeferredBuffers(){for(let e=0;e<this._deferredReleaseBuffers.length;++e)this._deferredReleaseBuffers[e].destroy();this._deferredReleaseBuffers.length=0}}});var Hre,zre,Xre,mh,PP=S(()=>{Hre=[0,0,3,7,0,2,6,2,4,1,5,3,1],zre=[0,64,32,96,16,80,48,112,8],Xre=[0,128,128,0,0,0,0,128,0,0,0,0,128],mh=class s{constructor(e){this._samplers={},this._device=e,this.disabled=!1}static GetSamplerHashCode(e){let t=e._cachedAnisotropicFilteringLevel?e._cachedAnisotropicFilteringLevel:1;return Hre[e.samplingMode]+zre[(e._comparisonFunction||514)-512+1]+Xre[e.samplingMode]+((e._cachedWrapU??1)<<8)+((e._cachedWrapV??1)<<10)+((e._cachedWrapR??1)<<12)+((e.useMipMaps?1:0)<<14)+(t<<15)}static _GetSamplerFilterDescriptor(e,t){let i,r,n,a,o,l=e.useMipMaps;switch(e.samplingMode){case 11:i="linear",r="linear",n="nearest",l||(a=o=0);break;case 3:case 3:i="linear",r="linear",l?n="linear":(n="nearest",a=o=0);break;case 8:i="nearest",r="nearest",l?n="linear":(n="nearest",a=o=0);break;case 4:i="nearest",r="nearest",n="nearest",l||(a=o=0);break;case 5:i="nearest",r="linear",n="nearest",l||(a=o=0);break;case 6:i="nearest",r="linear",l?n="linear":(n="nearest",a=o=0);break;case 7:i="nearest",r="linear",n="nearest",a=o=0;break;case 1:case 1:i="nearest",r="nearest",n="nearest",a=o=0;break;case 9:i="linear",r="nearest",n="nearest",l||(a=o=0);break;case 10:i="linear",r="nearest",l?n="linear":(n="nearest",a=o=0);break;case 2:case 2:i="linear",r="linear",t>1?n="linear":(n="nearest",a=o=0);break;case 12:i="linear",r="nearest",n="nearest",a=o=0;break;default:i="nearest",r="nearest",n="nearest",a=o=0;break}return t>1&&(a!==0||o!==0)?{magFilter:"linear",minFilter:"linear",mipmapFilter:"linear",anisotropyEnabled:!0}:{magFilter:i,minFilter:r,mipmapFilter:n,lodMinClamp:a,lodMaxClamp:o}}static _GetWrappingMode(e){switch(e){case 1:return"repeat";case 0:return"clamp-to-edge";case 2:return"mirror-repeat"}return"repeat"}static _GetSamplerWrappingDescriptor(e){return{addressModeU:this._GetWrappingMode(e._cachedWrapU),addressModeV:this._GetWrappingMode(e._cachedWrapV),addressModeW:this._GetWrappingMode(e._cachedWrapR)}}static _GetSamplerDescriptor(e,t){let i=(e.useMipMaps||e.samplingMode===2)&&e._cachedAnisotropicFilteringLevel?e._cachedAnisotropicFilteringLevel:1;e.samplingMode!==11&&e.samplingMode!==3&&e.samplingMode!==2&&(i=1);let r=this._GetSamplerFilterDescriptor(e,i);return{label:t,...r,...this._GetSamplerWrappingDescriptor(e),compare:e._comparisonFunction?s.GetCompareFunction(e._comparisonFunction):void 0,maxAnisotropy:r.anisotropyEnabled?i:1}}static GetCompareFunction(e){switch(e){case 519:return"always";case 514:return"equal";case 516:return"greater";case 518:return"greater-equal";case 513:return"less";case 515:return"less-equal";case 512:return"never";case 517:return"not-equal";default:return"less"}}getSampler(e,t=!1,i=0,r){if(this.disabled)return this._device.createSampler(s._GetSamplerDescriptor(e,r));t?i=0:i===0&&(i=s.GetSamplerHashCode(e));let n=t?void 0:this._samplers[i];return n||(n=this._device.createSampler(s._GetSamplerDescriptor(e,r)),t||(this._samplers[i]=n)),n}}});function Kre(s){switch(s){case A.BYTE:case A.SHORT:case A.INT:case A.FLOAT:return!0;case A.UNSIGNED_BYTE:case A.UNSIGNED_SHORT:case A.UNSIGNED_INT:return!1;default:throw new Error(`Invalid type '${s}'`)}}function QK(s,e){let t=e.getEngine(),i=e._pipelineContext;if(!i?.vertexBufferKindToType)return;let r=null;for(let n in s){let a=s[n];if(!a||!Yre[n])continue;let o=a.normalized?A.FLOAT:a.type,l=i.vertexBufferKindToType[n];(o!==A.FLOAT&&l===void 0||l!==void 0&&l!==o)&&(r||(r=t._getShaderProcessingContext(e.shaderLanguage,!1)),i.vertexBufferKindToType[n]=o,o!==A.FLOAT&&(r.vertexBufferKindToNumberOfComponents[n]=A.DeduceStride(n),Kre(o)&&(r.vertexBufferKindToNumberOfComponents[n]*=-1)))}if(r){let n=t._caps.parallelShaderCompile;t._caps.parallelShaderCompile=void 0,e._processShaderCodeAsync(null,t._features._checkNonFloatVertexBuffersDontRecreatePipelineContext,r),t._caps.parallelShaderCompile=n}}var Yre,jK=S(()=>{wy();Yre={[A.PositionKind]:!0,[A.NormalKind]:!0,[A.TangentKind]:!0,[A.UVKind]:!0,[A.UV2Kind]:!0,[A.UV3Kind]:!0,[A.UV4Kind]:!0,[A.UV5Kind]:!0,[A.UV6Kind]:!0,[A.ColorKind]:!0,[A.ColorInstanceKind]:!0,[A.MatricesIndicesKind]:!0,[A.MatricesWeightsKind]:!0,[A.MatricesIndicesExtraKind]:!0,[A.MatricesWeightsExtraKind]:!0}});var ai,Wx,ZK,ks,lc,oa,JK=S(()=>{yt();fo();Gx();jK();Ee();(function(s){s[s.StencilReadMask=0]="StencilReadMask",s[s.StencilWriteMask=1]="StencilWriteMask",s[s.DepthBias=2]="DepthBias",s[s.DepthBiasSlopeScale=3]="DepthBiasSlopeScale",s[s.DepthStencilState=4]="DepthStencilState",s[s.MRTAttachments=5]="MRTAttachments",s[s.RasterizationState=6]="RasterizationState",s[s.ColorStates1=7]="ColorStates1",s[s.ColorStates2=8]="ColorStates2",s[s.ColorStates3=9]="ColorStates3",s[s.ColorStates4=10]="ColorStates4",s[s.ShaderStage=11]="ShaderStage",s[s.TextureStage=12]="TextureStage",s[s.VertexState=13]="VertexState",s[s.NumStates=14]="NumStates"})(ai||(ai={}));Wx={0:1,1:2,768:3,769:4,770:5,771:6,772:7,773:8,774:9,775:10,776:11,32769:12,32770:13,32771:14,32772:15,35065:16,35066:17,34185:18,35067:19},ZK={32774:0,32775:1,32776:2,32778:3,32779:4},ks={0:0,7680:1,7681:2,7682:3,7683:4,5386:5,34055:6,34056:7},lc=[0,0,0,0],oa=class s{constructor(e,t){this.mrtTextureCount=0,this._device=e,this._useTextureStage=!0,this._states=new Array(30),this._statesLength=0,this._stateDirtyLowestIndex=0,this._emptyVertexBuffer=t,this._mrtFormats=[],this._parameter={token:void 0,pipeline:null},this.disabled=!1,this.vertexBuffers=[],this._kMaxVertexBufferStride=e.limits.maxVertexBufferArrayStride||2048,this.reset()}reset(){this._isDirty=!0,this.vertexBuffers.length=0,this.setAlphaToCoverage(!1),this.resetDepthCullingState(),this.setClampDepth(!1),this.setDepthBias(0),this._webgpuColorFormat=["bgra8unorm"],this.setColorFormat("bgra8unorm"),this.setMRT([]),this.setAlphaBlendEnabled([!1],1),this.setAlphaBlendFactors([null,null,null,null],[null,null]),this.setWriteMask(15),this.setDepthStencilFormat("depth24plus-stencil8"),this.setStencilEnabled(!1),this.resetStencilState(),this.setBuffers(null,null,null),this._setTextureState(0)}get colorFormats(){return this._mrtAttachments>0?this._mrtFormats:this._webgpuColorFormat}getRenderPipeline(e,t,i,r=0){if(i=tt.GetSample(i),this.disabled){let a=s._GetTopology(e);return this._setVertexState(t),this._setTextureState(r),this._parameter.pipeline=this._createRenderPipeline(t,a,i),s.NumCacheMiss++,s._NumPipelineCreationCurrentFrame++,this._parameter.pipeline}if(this._setShaderStage(t.uniqueId),this._setRasterizationState(e,i),this._setColorStates(),this._setDepthStencilState(),this._setVertexState(t),this._setTextureState(r),this.lastStateDirtyLowestIndex=this._stateDirtyLowestIndex,!this._isDirty&&this._parameter.pipeline)return this._stateDirtyLowestIndex=this._statesLength,s.NumCacheHitWithoutHash++,this._parameter.pipeline;if(this._getRenderPipeline(this._parameter),this._isDirty=!1,this._stateDirtyLowestIndex=this._statesLength,this._parameter.pipeline)return s.NumCacheHitWithHash++,this._parameter.pipeline;let n=s._GetTopology(e);return this._parameter.pipeline=this._createRenderPipeline(t,n,i),this._setRenderPipeline(this._parameter),s.NumCacheMiss++,s._NumPipelineCreationCurrentFrame++,this._parameter.pipeline}endFrame(){s.NumPipelineCreationLastFrame=s._NumPipelineCreationCurrentFrame,s._NumPipelineCreationCurrentFrame=0}setAlphaToCoverage(e){this._alphaToCoverageEnabled=e}setFrontFace(e){this._frontFace=e}setCullEnabled(e){this._cullEnabled=e}setCullFace(e){this._cullFace=e}setClampDepth(e){this._clampDepth=e}resetDepthCullingState(){this.setDepthCullingState(!1,2,1,0,0,!0,!0,519)}setDepthCullingState(e,t,i,r,n,a,o,l){this._depthWriteEnabled=o,this._depthTestEnabled=a,this._depthCompare=(l??519)-512,this._cullFace=i,this._cullEnabled=e,this._frontFace=t,this.setDepthBiasSlopeScale(r),this.setDepthBias(n)}setDepthBias(e){this._depthBias!==e&&(this._depthBias=e,this._states[ai.DepthBias]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ai.DepthBias))}setDepthBiasSlopeScale(e){this._depthBiasSlopeScale!==e&&(this._depthBiasSlopeScale=e,this._states[ai.DepthBiasSlopeScale]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ai.DepthBiasSlopeScale))}setColorFormat(e){this._webgpuColorFormat[0]=e,this._colorFormat=Vs[e??""]}setMRTAttachments(e){this.mrtAttachments=e;let t=0;for(let i=0;i<e.length;++i)e[i]!==0&&(t+=1<<i);this._mrtEnabledMask!==t&&(this._mrtEnabledMask=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ai.MRTAttachments))}setMRT(e,t){if(t=t??e.length,t>8)throw new Error("Can't handle more than 8 attachments for a MRT in cache render pipeline!");this.mrtTextureArray=e,this.mrtTextureCount=t,this._mrtEnabledMask=65535;let i=0,r=0;for(let n=0;n<t;++n){let o=e[n]?._hardwareTexture;this._mrtFormats[n]=o?.format??this._webgpuColorFormat[0],i+=Vs[this._mrtFormats[n]??""]*2**r,r+=6}this._mrtFormats.length=t,this._mrtAttachments!==i&&(this._mrtAttachments=i,this._states[ai.MRTAttachments]=i,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ai.MRTAttachments))}setAlphaBlendEnabled(e,t){this._alphaBlendEnabled=e,this._numAlphaBlendTargetsEnabled=t}setAlphaBlendFactors(e,t){this._alphaBlendFuncParams=e,this._alphaBlendEqParams=t}setWriteMask(e){this._writeMask=e}setDepthStencilFormat(e){this._webgpuDepthStencilFormat=e,this._depthStencilFormat=e===void 0?0:Vs[e]}setDepthTestEnabled(e){this._depthTestEnabled=e}setDepthWriteEnabled(e){this._depthWriteEnabled=e}setDepthCompare(e){this._depthCompare=(e??519)-512}setStencilEnabled(e){this._stencilEnabled=e}setStencilCompare(e){this._stencilFrontCompare=(e??519)-512}setStencilDepthFailOp(e){this._stencilFrontDepthFailOp=e===null?1:ks[e]}setStencilPassOp(e){this._stencilFrontPassOp=e===null?2:ks[e]}setStencilFailOp(e){this._stencilFrontFailOp=e===null?1:ks[e]}setStencilBackCompare(e){this._stencilBackCompare=(e??519)-512}setStencilBackDepthFailOp(e){this._stencilBackDepthFailOp=e===null?1:ks[e]}setStencilBackPassOp(e){this._stencilBackPassOp=e===null?2:ks[e]}setStencilBackFailOp(e){this._stencilBackFailOp=e===null?1:ks[e]}setStencilReadMask(e){this._stencilReadMask!==e&&(this._stencilReadMask=e,this._states[ai.StencilReadMask]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ai.StencilReadMask))}setStencilWriteMask(e){this._stencilWriteMask!==e&&(this._stencilWriteMask=e,this._states[ai.StencilWriteMask]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ai.StencilWriteMask))}resetStencilState(){this.setStencilState(!1,519,7680,7681,7680,255,255)}setStencilState(e,t,i,r,n,a,o,l=null,c=null,f=null,h=null){this._stencilEnabled=e,this._stencilFrontCompare=(t??519)-512,this._stencilFrontDepthFailOp=i===null?1:ks[i],this._stencilFrontPassOp=r===null?2:ks[r],this._stencilFrontFailOp=n===null?1:ks[n],this._stencilBackCompare=(l??519)-512,this._stencilBackDepthFailOp=c===null?1:ks[c],this._stencilBackPassOp=f===null?2:ks[f],this._stencilBackFailOp=h===null?1:ks[h],this.setStencilReadMask(a),this.setStencilWriteMask(o)}setBuffers(e,t,i){this._vertexBuffers=e,this._overrideVertexBuffers=i,this.indexBuffer=t}static _GetTopology(e){switch(e){case 0:return"triangle-list";case 2:return"point-list";case 1:return"line-list";case 3:return"point-list";case 4:return"line-list";case 5:throw"LineLoop is an unsupported fillmode in WebGPU";case 6:return"line-strip";case 7:return"triangle-strip";case 8:throw"TriangleFan is an unsupported fillmode in WebGPU";default:return"triangle-list"}}static _GetAphaBlendOperation(e){switch(e){case 32774:return"add";case 32778:return"subtract";case 32779:return"reverse-subtract";case 32775:return"min";case 32776:return"max";default:return"add"}}static _GetAphaBlendFactor(e){switch(e){case 0:return"zero";case 1:return"one";case 768:return"src";case 769:return"one-minus-src";case 770:return"src-alpha";case 771:return"one-minus-src-alpha";case 772:return"dst-alpha";case 773:return"one-minus-dst-alpha";case 774:return"dst";case 775:return"one-minus-dst";case 776:return"src-alpha-saturated";case 32769:case 32771:return"constant";case 32770:case 32772:return"one-minus-constant";case 35065:return"src1";case 35066:return"one-minus-src1";case 34185:return"src1-alpha";case 35067:return"one-minus-src1-alpha";default:return"one"}}static _GetCompareFunction(e){switch(e){case 0:return"never";case 1:return"less";case 2:return"equal";case 3:return"less-equal";case 4:return"greater";case 5:return"not-equal";case 6:return"greater-equal";case 7:return"always"}return"never"}static _GetStencilOpFunction(e){switch(e){case 0:return"zero";case 1:return"keep";case 2:return"replace";case 3:return"increment-clamp";case 4:return"decrement-clamp";case 5:return"invert";case 6:return"increment-wrap";case 7:return"decrement-wrap"}return"keep"}static _GetVertexInputDescriptorFormat(e){let t=e.type,i=e.normalized,r=e.getSize();switch(t){case A.BYTE:switch(r){case 1:case 2:return i?"snorm8x2":"sint8x2";case 3:case 4:return i?"snorm8x4":"sint8x4"}break;case A.UNSIGNED_BYTE:switch(r){case 1:case 2:return i?"unorm8x2":"uint8x2";case 3:case 4:return i?"unorm8x4":"uint8x4"}break;case A.SHORT:switch(r){case 1:case 2:return i?"snorm16x2":"sint16x2";case 3:case 4:return i?"snorm16x4":"sint16x4"}break;case A.UNSIGNED_SHORT:switch(r){case 1:case 2:return i?"unorm16x2":"uint16x2";case 3:case 4:return i?"unorm16x4":"uint16x4"}break;case A.INT:switch(r){case 1:return"sint32";case 2:return"sint32x2";case 3:return"sint32x3";case 4:return"sint32x4"}break;case A.UNSIGNED_INT:switch(r){case 1:return"uint32";case 2:return"uint32x2";case 3:return"uint32x3";case 4:return"uint32x4"}break;case A.FLOAT:switch(r){case 1:return"float32";case 2:return"float32x2";case 3:return"float32x3";case 4:return"float32x4"}break}throw new Error(`Invalid Format '${e.getKind()}' - type=${t}, normalized=${i}, size=${r}`)}_getAphaBlendState(e){return this._alphaBlendEnabled[e]?{srcFactor:s._GetAphaBlendFactor(this._alphaBlendFuncParams[e*4+2]),dstFactor:s._GetAphaBlendFactor(this._alphaBlendFuncParams[e*4+3]),operation:s._GetAphaBlendOperation(this._alphaBlendEqParams[e*2+1])}:null}_getColorBlendState(e){return this._alphaBlendEnabled?{srcFactor:s._GetAphaBlendFactor(this._alphaBlendFuncParams[e*4+0]),dstFactor:s._GetAphaBlendFactor(this._alphaBlendFuncParams[e*4+1]),operation:s._GetAphaBlendOperation(this._alphaBlendEqParams[e*2+0])}:null}_setShaderStage(e){this._shaderId!==e&&(this._shaderId=e,this._states[ai.ShaderStage]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ai.ShaderStage))}_setRasterizationState(e,t){let i=this._frontFace,r=this._cullEnabled?this._cullFace:0,n=this._clampDepth?1:0,a=this._alphaToCoverageEnabled?1:0,o=i-1+(r<<1)+(n<<3)+(a<<4)+(e<<5)+(t<<8);this._rasterizationState!==o&&(this._rasterizationState=o,this._states[ai.RasterizationState]=this._rasterizationState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ai.RasterizationState))}_setColorStates(){lc[0]=(this._writeMask?1:0)*2**53,lc[1]=(this._depthWriteEnabled?1:0)*2**53,lc[2]=(this._colorFormat&7)*2**50,lc[3]=(this._colorFormat&56)*2**47;let e=0,t=!1;for(let i=0;i<8;i++){if(this._alphaBlendEnabled[i]){let r=i*4+0,n=i*4+1,a=i*4+2,o=i*4+3,l=i*2+0,c=i*2+1,f=this._alphaBlendEqParams[l]===null?0:ZK[this._alphaBlendEqParams[l]],h=this._alphaBlendEqParams[c]===null?0:ZK[this._alphaBlendEqParams[c]];lc[e]+=((this._alphaBlendFuncParams[r]===null?1:Wx[this._alphaBlendFuncParams[r]])<<0)+((this._alphaBlendFuncParams[n]===null?1:Wx[this._alphaBlendFuncParams[n]])<<5)+((this._alphaBlendFuncParams[a]===null?1:Wx[this._alphaBlendFuncParams[a]])<<10)+((this._alphaBlendFuncParams[o]===null?1:Wx[this._alphaBlendFuncParams[o]])<<15)+(f+h*5)*(1<<20)}i&1&&(t=t||this._states[ai.ColorStates1+e]!==lc[e],this._states[ai.ColorStates1+e]=lc[e],e++)}t&&(this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ai.ColorStates1))}_setDepthStencilState(){let e=this._stencilEnabled?this._stencilFrontCompare+(this._stencilFrontDepthFailOp<<3)+(this._stencilFrontPassOp<<6)+(this._stencilFrontFailOp<<9)+(this._stencilBackCompare<<12)+(this._stencilBackDepthFailOp<<15)+(this._stencilBackPassOp<<18)+(this._stencilBackFailOp<<21):2421327,t=this._depthStencilFormat+((this._depthTestEnabled?this._depthCompare:7)<<6)+e*1024;this._depthStencilState!==t&&(this._depthStencilState=t,this._states[ai.DepthStencilState]=this._depthStencilState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ai.DepthStencilState))}_setVertexState(e){let t=this._statesLength,i=ai.VertexState,r=e._pipelineContext,n=r.shaderProcessingContext.attributeNamesFromEffect,a=r.shaderProcessingContext.attributeLocationsFromEffect,o,l=0;for(let c=0;c<n.length;c++){let f=a[c],h=(this._overrideVertexBuffers&&this._overrideVertexBuffers[n[c]])??this._vertexBuffers[n[c]];h||(h=this._emptyVertexBuffer,s.LogErrorIfNoVertexBuffer&&P.Error(`No vertex buffer is provided for the "${n[c]}" attribute. A default empty vertex buffer will be used, but this may generate errors in some browsers.`));let u=h.effectiveBuffer?.underlyingResource;if(h._validOffsetRange===void 0){let p=h.effectiveByteOffset,m=h.getSize(!0),_=h.effectiveByteStride;h._validOffsetRange=p+m<=this._kMaxVertexBufferStride&&_===0||_!==0&&p+m<=_}o&&o===u&&h._validOffsetRange||(this.vertexBuffers[l++]=h,o=h._validOffsetRange?u:null);let d=h.hashCode+(f<<7);this._isDirty=this._isDirty||this._states[i]!==d,this._states[i++]=d}this.vertexBuffers.length=l,this._statesLength=i,this._isDirty=this._isDirty||i!==t,this._isDirty&&(this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ai.VertexState))}_setTextureState(e){this._textureState!==e&&(this._textureState=e,this._states[ai.TextureStage]=this._textureState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ai.TextureStage))}_createPipelineLayout(e){if(this._useTextureStage)return this._createPipelineLayoutWithTextureStage(e);let t=[],i=e.shaderProcessingContext.bindGroupLayoutEntries;for(let r=0;r<i.length;r++){let n=i[r];t[r]=this._device.createBindGroupLayout({entries:n})}return e.bindGroupLayouts[0]=t,this._device.createPipelineLayout({bindGroupLayouts:t})}_createPipelineLayoutWithTextureStage(e){let t=e.shaderProcessingContext,i=t.bindGroupLayoutEntries,r=1;for(let a=0;a<i.length;a++){let o=i[a];for(let l=0;l<o.length;l++){let c=i[a][l];if(c.texture){let f=t.bindGroupLayoutEntryInfo[a][c.binding].name,h=t.availableTextures[f],u=h.autoBindSampler?t.availableSamplers[f+"Sampler"]:null,d=h.sampleType,p=u?.type??"filtering";if(this._textureState&r&&d!=="depth"&&(h.autoBindSampler&&(p="non-filtering"),d="unfilterable-float"),c.texture.sampleType=d,u){let m=t.bindGroupLayoutEntryInfo[u.binding.groupIndex][u.binding.bindingIndex].index;i[u.binding.groupIndex][m].sampler.type=p}r=r<<1}}}let n=[];for(let a=0;a<i.length;++a)n[a]=this._device.createBindGroupLayout({entries:i[a]});return e.bindGroupLayouts[this._textureState]=n,this._device.createPipelineLayout({bindGroupLayouts:n})}_getVertexInputDescriptor(e){let t=[],i=e._pipelineContext,r=i.shaderProcessingContext.attributeNamesFromEffect,n=i.shaderProcessingContext.attributeLocationsFromEffect,a,o;for(let l=0;l<r.length;l++){let c=n[l],f=(this._overrideVertexBuffers&&this._overrideVertexBuffers[r[l]])??this._vertexBuffers[r[l]];f||(f=this._emptyVertexBuffer);let h=f.effectiveBuffer?.underlyingResource,u=f.effectiveByteOffset,d=!f._validOffsetRange;if(!(a&&o&&a===h)||d){let p={arrayStride:f.effectiveByteStride,stepMode:f.getIsInstanced()?"instance":"vertex",attributes:[]};t.push(p),o=p.attributes,d&&(u=0,h=null)}o.push({shaderLocation:c,offset:u,format:s._GetVertexInputDescriptorFormat(f)}),a=h}return t}_createRenderPipeline(e,t,i){let r=e._pipelineContext,n=this._getVertexInputDescriptor(e),a=this._createPipelineLayout(r),o=[];if(this._vertexBuffers&&QK(this._vertexBuffers,e),this._mrtAttachments>0)for(let d=0;d<this._mrtFormats.length;++d){let p=this._mrtFormats[d];if(p){let m={format:p,writeMask:(this._mrtEnabledMask&1<<d)!==0?this._writeMask:0},_=this._getAphaBlendState(d<this._numAlphaBlendTargetsEnabled?d:0),v=this._getColorBlendState(d<this._numAlphaBlendTargetsEnabled?d:0);_&&v&&(m.blend={alpha:_,color:v}),o.push(m)}else o.push(null)}else if(this._webgpuColorFormat[0]){let d={format:this._webgpuColorFormat[0],writeMask:this._writeMask},p=this._getAphaBlendState(0),m=this._getColorBlendState(0);p&&m&&(d.blend={alpha:p,color:m}),o.push(d)}else o.push(null);let l={compare:s._GetCompareFunction(this._stencilEnabled?this._stencilFrontCompare:7),depthFailOp:s._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontDepthFailOp:1),failOp:s._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontFailOp:1),passOp:s._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontPassOp:1)},c={compare:s._GetCompareFunction(this._stencilEnabled?this._stencilBackCompare:7),depthFailOp:s._GetStencilOpFunction(this._stencilEnabled?this._stencilBackDepthFailOp:1),failOp:s._GetStencilOpFunction(this._stencilEnabled?this._stencilBackFailOp:1),passOp:s._GetStencilOpFunction(this._stencilEnabled?this._stencilBackPassOp:1)},f=t==="triangle-list"||t==="triangle-strip",h;(t==="line-strip"||t==="triangle-strip")&&(h=!this.indexBuffer||this.indexBuffer.is32Bits?"uint32":"uint16");let u=this._webgpuDepthStencilFormat?tt.HasStencilAspect(this._webgpuDepthStencilFormat):!1;return this._device.createRenderPipeline({label:`RenderPipeline_${o[0]?.format??"nooutput"}_${this._webgpuDepthStencilFormat??"nodepth"}_samples${i}_textureState${this._textureState}`,layout:a,vertex:{module:r.stages.vertexStage.module,entryPoint:r.stages.vertexStage.entryPoint,buffers:n},primitive:{topology:t,stripIndexFormat:h,frontFace:this._frontFace===1?"ccw":"cw",cullMode:this._cullEnabled?this._cullFace===2?"front":"back":"none"},fragment:r.stages.fragmentStage?{module:r.stages.fragmentStage.module,entryPoint:r.stages.fragmentStage.entryPoint,targets:o}:void 0,multisample:{count:i},depthStencil:this._webgpuDepthStencilFormat===void 0?void 0:{depthWriteEnabled:this._depthWriteEnabled,depthCompare:this._depthTestEnabled?s._GetCompareFunction(this._depthCompare):"always",format:this._webgpuDepthStencilFormat,stencilFront:this._stencilEnabled&&u?l:void 0,stencilBack:this._stencilEnabled&&u?c:void 0,stencilReadMask:this._stencilEnabled&&u?this._stencilReadMask:void 0,stencilWriteMask:this._stencilEnabled&&u?this._stencilWriteMask:void 0,depthBias:this._depthBias,depthBiasClamp:f?this._depthBiasClamp:0,depthBiasSlopeScale:f?this._depthBiasSlopeScale:0}})}};oa.LogErrorIfNoVertexBuffer=!1;oa.NumCacheHitWithoutHash=0;oa.NumCacheHitWithHash=0;oa.NumCacheMiss=0;oa.NumPipelineCreationLastFrame=0;oa._NumPipelineCreationCurrentFrame=0});var Od,ol,DP=S(()=>{JK();Od=class{constructor(){this.values={}}count(){let e=0,t=this.pipeline?1:0;for(let i in this.values){let r=this.values[i],[n,a]=r.count();e+=n,t+=a,e++}return[e,t]}},ol=class s extends oa{static GetNodeCounts(){let e=s._Cache.count();return{nodeCount:e[0],pipelineCount:e[1]}}static _GetPipelines(e,t,i,r){if(e.pipeline){let n=i.slice();n.length=r,t.push(n)}for(let n in e.values){let a=e.values[n];i[r]=parseInt(n),s._GetPipelines(a,t,i,r+1)}}static GetPipelines(){let e=[];return s._GetPipelines(s._Cache,e,[],0),e}static ResetCache(){s._Cache=new Od}reset(){this._nodeStack=[],this._nodeStack[0]=s._Cache,super.reset()}_getRenderPipeline(e){let t=this._nodeStack[this._stateDirtyLowestIndex];for(let i=this._stateDirtyLowestIndex;i<this._statesLength;++i){let r=t.values[this._states[i]];r||(r=new Od,t.values[this._states[i]]=r),t=r,this._nodeStack[i+1]=t}e.token=t,e.pipeline=t.pipeline}_setRenderPipeline(e){e.token.pipeline=e.pipeline}};ol._Cache=new Od});var Hx,$K=S(()=>{zA();Hx=class extends Lc{constructor(e){super(!1),this._cache=e,this.reset()}get func(){return this._func}set func(e){this._func!==e&&(this._func=e,this._cache.setStencilCompare(e))}get backFunc(){return this._backFunc}set backFunc(e){this._backFunc!==e&&(this._backFunc=e,this._cache.setStencilBackCompare(e))}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask!==e&&(this._funcMask=e,this._cache.setStencilReadMask(e))}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._cache.setStencilFailOp(e))}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._cache.setStencilDepthFailOp(e))}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._cache.setStencilPassOp(e))}get backOpStencilFail(){return this._backOpStencilFail}set backOpStencilFail(e){this._backOpStencilFail!==e&&(this._backOpStencilFail=e,this._cache.setStencilBackFailOp(e))}get backOpDepthFail(){return this._backOpDepthFail}set backOpDepthFail(e){this._backOpDepthFail!==e&&(this._backOpDepthFail=e,this._cache.setStencilBackDepthFailOp(e))}get backOpStencilDepthPass(){return this._backOpStencilDepthPass}set backOpStencilDepthPass(e){this._backOpStencilDepthPass!==e&&(this._backOpStencilDepthPass=e,this._cache.setStencilBackPassOp(e))}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._cache.setStencilWriteMask(e))}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this._cache.setStencilEnabled(e))}reset(){super.reset(),this._cache.resetStencilState()}apply(){let e=!this.useStencilGlobalOnly&&!!this.stencilMaterial?.enabled;this.enabled=e?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.enabled&&(this.mask=e?this.stencilMaterial.mask:this.stencilGlobal.mask,this.funcRef=e?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=e?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.func=e?this.stencilMaterial.func:this.stencilGlobal.func,this.opStencilFail=e?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=e?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=e?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.backFunc=e?this.stencilMaterial.backFunc:this.stencilGlobal.backFunc,this.backOpStencilFail=e?this.stencilMaterial.backOpStencilFail:this.stencilGlobal.backOpStencilFail,this.backOpDepthFail=e?this.stencilMaterial.backOpDepthFail:this.stencilGlobal.backOpDepthFail,this.backOpStencilDepthPass=e?this.stencilMaterial.backOpStencilDepthPass:this.stencilGlobal.backOpStencilDepthPass)}}});var zx,e7=S(()=>{HA();zx=class extends Oc{constructor(e){super(!1),this._cache=e,this.reset()}get zOffset(){return this._zOffset}set zOffset(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0,this._cache.setDepthBiasSlopeScale(e))}get zOffsetUnits(){return this._zOffsetUnits}set zOffsetUnits(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=!0,this._cache.setDepthBias(e))}get cullFace(){return this._cullFace}set cullFace(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0,this._cache.setCullFace(e??1))}get cull(){return this._cull}set cull(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0,this._cache.setCullEnabled(!!e))}get depthFunc(){return this._depthFunc}set depthFunc(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0,this._cache.setDepthCompare(e))}get depthMask(){return this._depthMask}set depthMask(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0,this._cache.setDepthWriteEnabled(e))}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0,this._cache.setDepthTestEnabled(e))}get frontFace(){return this._frontFace}set frontFace(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0,this._cache.setFrontFace(e??2))}reset(){super.reset(),this._cache.resetDepthCullingState()}apply(){}}});var _h,OP=S(()=>{vi();_h=class{static IsExternalTexture(e){return e.underlyingResource!==void 0}getClassName(){return"ExternalTexture"}get underlyingResource(){return this._video}constructor(e){this.useMipMaps=!1,this.type=16,this.format=4294967295,this._video=e,this.uniqueId=Je._Counter++}isReady(){return this._video.readyState>=this._video.HAVE_CURRENT_DATA}dispose(){}}});var Ld,t7=S(()=>{OP();PP();Ld=class s{get forceBindGroupCreation(){return this._numExternalTextures>0}get hasFloatOrDepthTextures(){return this._numFloatOrDepthTextures>0}constructor(){this.useVertexPulling=!1,this.uniqueId=s._Counter++,this.updateId=0,this.textureState=0,this.reset()}reset(){this.samplers={},this.textures={},this.isDirty=!0,this._numFloatOrDepthTextures=0,this._numExternalTextures=0}setSampler(e,t){let i=this.samplers[e],r=-1;i?r=i.hashCode:this.samplers[e]=i={sampler:t,hashCode:0},i.sampler=t,i.hashCode=t?mh.GetSamplerHashCode(t):0;let n=r!==i.hashCode;n&&this.updateId++,this.isDirty||(this.isDirty=n)}setTexture(e,t){let i=this.textures[e],r=-1;i?r=i.texture?.uniqueId??-1:this.textures[e]=i={texture:t,isFloatOrDepthTexture:!1,isExternalTexture:!1},i.isExternalTexture&&this._numExternalTextures--,i.isFloatOrDepthTexture&&this._numFloatOrDepthTextures--,t?(i.isFloatOrDepthTexture=t.type===1||t.format>=13&&t.format<=18,i.isExternalTexture=_h.IsExternalTexture(t),i.isFloatOrDepthTexture&&this._numFloatOrDepthTextures++,i.isExternalTexture&&this._numExternalTextures++):(i.isFloatOrDepthTexture=!1,i.isExternalTexture=!1),i.texture=t;let n=r!==(t?.uniqueId??-1);n&&this.updateId++,this.isDirty||(this.isDirty=n)}};Ld._Counter=0});var wd,i7=S(()=>{dh();wd=class s{isDirty(e){return this._isDirty||this._materialContextUpdateId!==e}resetIsDirty(e){this._isDirty=!1,this._materialContextUpdateId=e}get enableIndirectDraw(){return this._enableIndirectDraw}set enableIndirectDraw(e){this._enableIndirectDrawInCompatMode=!0,this._enableIndirectDraw!==e&&(this._enableIndirectDraw=e,!e&&!this._useInstancing&&this.indirectDrawBuffer?(this._bufferManager.releaseBuffer(this.indirectDrawBuffer),this.indirectDrawBuffer=void 0,this._indirectDrawData=void 0):e&&!this.indirectDrawBuffer&&(this.indirectDrawBuffer=this._bufferManager.createRawBuffer(20,rt.CopyDst|rt.Indirect|rt.Storage,void 0,"IndirectDrawBuffer"),this._indirectDrawData=new Uint32Array(5),this._indirectDrawData[3]=0,this._indirectDrawData[4]=0))}get useInstancing(){return this._useInstancing}set useInstancing(e){if(this._useInstancing===e)return;this._useInstancing=e,this._currentInstanceCount=-1;let t=this._enableIndirectDrawInCompatMode;this.enableIndirectDraw=e,this._enableIndirectDrawInCompatMode=t}constructor(e,t){this._dummyIndexBuffer=t,this._enableIndirectDrawInCompatMode=!1,this._bufferManager=e,this.uniqueId=s._Counter++,this._useInstancing=!1,this._currentInstanceCount=0,this._enableIndirectDraw=!1,this._vertexPullingEnabled=!1,this.reset()}reset(){this.buffers={},this._isDirty=!0,this._materialContextUpdateId=0,this.fastBundle=void 0,this.bindGroups=void 0,this._vertexPullingEnabled=!1}setBuffer(e,t){this._isDirty||(this._isDirty=t?.uniqueId!==this.buffers[e]?.uniqueId),this.buffers[e]=t}setIndirectData(e,t,i,r=!1){!r&&t===this._currentInstanceCount||!this.indirectDrawBuffer||!this._indirectDrawData||(this._currentInstanceCount=t,this._indirectDrawData[0]=e,this._indirectDrawData[1]=t,this._indirectDrawData[2]=i,this._bufferManager.setRawData(this.indirectDrawBuffer,0,this._indirectDrawData,0,20))}setVertexPulling(e,t,i,r,n){if(this._vertexPullingEnabled===e)return;this._vertexPullingEnabled=e,this._isDirty=!0;let a=t.shaderProcessingContext.bufferNames;if(n)for(let o in n){let l=n[o];if(!l||a.indexOf(o)===-1)continue;let c=l.effectiveBuffer;this.setBuffer(o,e?c:null)}for(let o in i){if(n&&o in n)continue;let l=i[o];if(!l||a.indexOf(o)===-1)continue;let c=l.effectiveBuffer;this.setBuffer(o,e?c:null)}a.indexOf("indices")!==-1&&this.setBuffer("indices",e?r??this._dummyIndexBuffer:null)}dispose(){this.indirectDrawBuffer&&(this._bufferManager.releaseBuffer(this.indirectDrawBuffer),this.indirectDrawBuffer=void 0,this._indirectDrawData=void 0),this.fastBundle=void 0,this.bindGroups=void 0,this.buffers=void 0,this._enableIndirectDraw=!1}};wd._Counter=0});var qre,Qre,cc,ms,r7=S(()=>{Ee();qre=1<<20,Qre=2**35,cc=class{constructor(){this.values={}}},ms=class s{static get Statistics(){return{totalCreated:s.NumBindGroupsCreatedTotal,lastFrameCreated:s.NumBindGroupsCreatedLastFrame,lookupLastFrame:s.NumBindGroupsLookupLastFrame,noLookupLastFrame:s.NumBindGroupsNoLookupLastFrame}}static ResetCache(){s._Cache=new cc,s.NumBindGroupsCreatedTotal=0,s.NumBindGroupsCreatedLastFrame=0,s.NumBindGroupsLookupLastFrame=0,s.NumBindGroupsNoLookupLastFrame=0,s._NumBindGroupsCreatedCurrentFrame=0,s._NumBindGroupsLookupCurrentFrame=0,s._NumBindGroupsNoLookupCurrentFrame=0}constructor(e,t,i){this.disabled=!1,this._device=e,this._cacheSampler=t,this._engine=i}endFrame(){s.NumBindGroupsCreatedLastFrame=s._NumBindGroupsCreatedCurrentFrame,s.NumBindGroupsLookupLastFrame=s._NumBindGroupsLookupCurrentFrame,s.NumBindGroupsNoLookupLastFrame=s._NumBindGroupsNoLookupCurrentFrame,s._NumBindGroupsCreatedCurrentFrame=0,s._NumBindGroupsLookupCurrentFrame=0,s._NumBindGroupsNoLookupCurrentFrame=0}getBindGroups(e,t,i){let r,n=s._Cache,a=this.disabled||i.forceBindGroupCreation;if(!a){if(!t.isDirty(i.updateId)&&!i.isDirty)return s._NumBindGroupsNoLookupCurrentFrame++,t.bindGroups;for(let l of e.shaderProcessingContext.bufferNames){let c=(t.buffers[l]?.uniqueId??0)+qre,f=n.values[c];f||(f=new cc,n.values[c]=f),n=f}for(let l of e.shaderProcessingContext.samplerNames){let c=i.samplers[l]?.hashCode??0,f=n.values[c];f||(f=new cc,n.values[c]=f),n=f}for(let l of e.shaderProcessingContext.textureNames){let c=(i.textures[l]?.texture?.uniqueId??0)+Qre,f=n.values[c];f||(f=new cc,n.values[c]=f),n=f}r=n.bindGroups}if(t.resetIsDirty(i.updateId),i.isDirty=!1,r)return t.bindGroups=r,s._NumBindGroupsLookupCurrentFrame++,r;r=[],t.bindGroups=r,a||(n.bindGroups=r),s.NumBindGroupsCreatedTotal++,s._NumBindGroupsCreatedCurrentFrame++;let o=e.bindGroupLayouts[i.textureState];for(let l=0;l<e.shaderProcessingContext.bindGroupLayoutEntries.length;l++){let c=e.shaderProcessingContext.bindGroupLayoutEntries[l],f=e.shaderProcessingContext.bindGroupEntries[l];for(let u=0;u<c.length;u++){let d=e.shaderProcessingContext.bindGroupLayoutEntries[l][u],p=e.shaderProcessingContext.bindGroupLayoutEntryInfo[l][d.binding],m=p.nameInArrayOfTexture??p.name;if(d.sampler){let _=i.samplers[m];if(_){let v=_.sampler;if(!v){this._engine.dbgSanityChecks&&P.Error(`Trying to bind a null sampler! entry=${JSON.stringify(d)}, name=${m}, bindingInfo=${JSON.stringify(_,(T,C)=>T==="texture"?"<no dump>":C)}, materialContext.uniqueId=${i.uniqueId}`,50);continue}f[u].resource=this._cacheSampler.getSampler(v,!1,_.hashCode,v.label)}else P.Error(`Sampler "${m}" not found in the material context. Make sure you bound it. entry=${JSON.stringify(d)}, materialContext=${JSON.stringify(i,(v,T)=>v==="texture"||v==="sampler"?"<no dump>":T)}`,50)}else if(d.texture||d.storageTexture){let _=i.textures[m];if(_){if(this._engine.dbgSanityChecks&&_.texture===null){P.Error(`Trying to bind a null texture! name="${m}", entry=${JSON.stringify(d)}, bindingInfo=${JSON.stringify(_,(T,C)=>T==="texture"?"<no dump>":C)}, materialContext.uniqueId=${i.uniqueId}`,50);continue}let v=_.texture._hardwareTexture;if(this._engine.dbgSanityChecks&&(!v||d.texture&&!v.view||d.storageTexture&&!v.viewForWriting)){P.Error(`Trying to bind a null gpu texture or view! entry=${JSON.stringify(d)}, name=${m}, bindingInfo=${JSON.stringify(_,(T,C)=>T==="texture"?"<no dump>":C)}, isReady=${_.texture?.isReady}, materialContext.uniqueId=${i.uniqueId}`,50);continue}f[u].resource=d.storageTexture?v.viewForWriting:v.view}else P.Error(`Texture "${m}" not found in the material context. Make sure you bound it (something like effect.setTexture("${m}", texture)). entry=${JSON.stringify(d)}, materialContext=${JSON.stringify(i,(v,T)=>v==="texture"||v==="sampler"?"<no dump>":T)}`,50)}else if(d.externalTexture){let _=i.textures[m];if(_){if(this._engine.dbgSanityChecks&&_.texture===null){P.Error(`Trying to bind a null external texture! entry=${JSON.stringify(d)}, name=${m}, bindingInfo=${JSON.stringify(_,(T,C)=>T==="texture"?"<no dump>":C)}, materialContext.uniqueId=${i.uniqueId}`,50);continue}let v=_.texture.underlyingResource;if(this._engine.dbgSanityChecks&&!v){P.Error(`Trying to bind a null gpu external texture! entry=${JSON.stringify(d)}, name=${m}, bindingInfo=${JSON.stringify(_,(T,C)=>T==="texture"?"<no dump>":C)}, isReady=${_.texture?.isReady}, materialContext.uniqueId=${i.uniqueId}`,50);continue}f[u].resource=this._device.importExternalTexture({source:v})}else P.Error(`External texture "${m}" not found in the material context. Make sure you bound it. entry=${JSON.stringify(d)}, materialContext=${JSON.stringify(i,(v,T)=>v==="texture"||v==="sampler"?"<no dump>":T)}`,50)}else if(d.buffer){let _=t.buffers[m];if(_){let v=_.underlyingResource;f[u].resource.buffer=v,f[u].resource.size=_.capacity}else P.Error(`Can't find buffer "${m}" in the draw context. Make sure you bound it. entry=${JSON.stringify(d)}, buffers=${JSON.stringify(t.buffers)}, drawContext.uniqueId=${t.uniqueId}`,50)}}let h=o[l];r[l]=this._device.createBindGroup({layout:h,entries:f})}return r}};ms.NumBindGroupsCreatedTotal=0;ms.NumBindGroupsCreatedLastFrame=0;ms.NumBindGroupsLookupLastFrame=0;ms.NumBindGroupsNoLookupLastFrame=0;ms._Cache=new cc;ms._NumBindGroupsCreatedCurrentFrame=0;ms._NumBindGroupsLookupCurrentFrame=0;ms._NumBindGroupsNoLookupCurrentFrame=0});var s7,jre,n7=S(()=>{O();s7="clearQuadVertexShader",jre=`uniform depthValue: f32;const pos=array(
vec2f(-1.0,1.0),
vec2f(1.0,1.0),
vec2f(-1.0,-1.0),
vec2f(1.0,-1.0)
);
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
vertexOutputs.position=vec4f(pos[input.vertexIndex],uniforms.depthValue,1.0);
#define CUSTOM_VERTEX_MAIN_END
}
`;g.ShadersStoreWGSL[s7]||(g.ShadersStoreWGSL[s7]=jre)});var a7,Zre,o7=S(()=>{O();a7="clearQuadPixelShader",Zre=`uniform color: vec4f;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=uniforms.color;}
`;g.ShadersStoreWGSL[a7]||(g.ShadersStoreWGSL[a7]=Zre)});var Xx,l7=S(()=>{DP();yd();fo();Gx();n7();o7();Xx=class{setDepthStencilFormat(e){this._depthTextureFormat=e,this._cacheRenderPipeline.setDepthStencilFormat(e)}setColorFormat(e){this._cacheRenderPipeline.setColorFormat(e)}setMRTAttachments(e,t,i){this._cacheRenderPipeline.setMRT(t,i),this._cacheRenderPipeline.setMRTAttachments(e)}constructor(e,t,i){this._bindGroups={},this._bundleCache={},this._keyTemp=[],this._device=e,this._engine=t,this._cacheRenderPipeline=new ol(this._device,i),this._cacheRenderPipeline.setDepthTestEnabled(!1),this._cacheRenderPipeline.setStencilReadMask(255),this._effect=t.createEffect("clearQuad",[],["color","depthValue"],void 0,void 0,void 0,void 0,void 0,void 0,1)}clear(e,t,i,r,n=1){let a,o=null,l,c=!!this._engine._currentRenderTarget;if(e)a=e;else{let _=0;this._keyTemp.length=0;for(let T=0;T<this._cacheRenderPipeline.colorFormats.length;++T)this._keyTemp[_++]=Vs[this._cacheRenderPipeline.colorFormats[T]??""];let v=Vs[this._depthTextureFormat??0];if(this._keyTemp[_]=(t?t.r+t.g*256+t.b*256*256+t.a*256*256*256:0)+(i?2**32:0)+(r?2**33:0)+(this._engine.useReverseDepthBuffer?2**34:0)+(c?2**35:0)+(n>1?2**36:0)+v*2**37,l=this._keyTemp.join("_"),o=this._bundleCache[l],o)return o;a=this._device.createRenderBundleEncoder({label:"clearQuadRenderBundle",colorFormats:this._cacheRenderPipeline.colorFormats,depthStencilFormat:this._depthTextureFormat,sampleCount:tt.GetSample(n)})}this._cacheRenderPipeline.setDepthWriteEnabled(!!i),this._cacheRenderPipeline.setStencilEnabled(!!r&&!!this._depthTextureFormat&&tt.HasStencilAspect(this._depthTextureFormat)),this._cacheRenderPipeline.setStencilWriteMask(r?255:0),this._cacheRenderPipeline.setStencilCompare(r?519:512),this._cacheRenderPipeline.setStencilPassOp(r?7681:7680),this._cacheRenderPipeline.setWriteMask(t?15:0);let f=this._cacheRenderPipeline.getRenderPipeline(7,this._effect,n),h=this._effect._pipelineContext;t&&this._effect.setDirectColor4("color",t),this._effect.setFloat("depthValue",this._engine.useReverseDepthBuffer?this._engine._clearReverseDepthValue:this._engine._clearDepthValue),h.uniformBuffer.update();let u=c?this._engine._ubInvertY:this._engine._ubDontInvertY,d=h.uniformBuffer.getBuffer(),p=d.uniqueId+"-"+u.uniqueId,m=this._bindGroups[p];if(!m){let _=h.bindGroupLayouts[0];m=this._bindGroups[p]=[],m.push(this._device.createBindGroup({label:`clearQuadBindGroup0-${p}`,layout:_[0],entries:[]})),wr._SimplifiedKnownBindings||m.push(this._device.createBindGroup({label:`clearQuadBindGroup1-${p}`,layout:_[1],entries:[]})),m.push(this._device.createBindGroup({label:`clearQuadBindGroup${wr._SimplifiedKnownBindings?1:2}-${p}`,layout:_[wr._SimplifiedKnownBindings?1:2],entries:[{binding:0,resource:{buffer:u.underlyingResource,size:u.capacity}},{binding:1,resource:{buffer:d.underlyingResource,size:d.capacity}}]}))}a.setPipeline(f);for(let _=0;_<m.length;++_)a.setBindGroup(_,m[_]);return a.draw(4,1,0,0),e||(o=a.finish(),this._bundleCache[l]=o),o}}});var Yx,Kx,Fd,qx,Qx,jx,LP,Zx,wP=S(()=>{fo();Yx=class s{constructor(e,t,i,r){this.x=Math.floor(e),this.y=Math.floor(t),this.w=Math.floor(i),this.h=Math.floor(r)}run(e){e.setViewport(this.x,this.y,this.w,this.h,0,1)}clone(){return new s(this.x,this.y,this.w,this.h)}},Kx=class s{constructor(e,t,i,r){this.x=e,this.y=t,this.w=i,this.h=r}run(e){e.setScissorRect(this.x,this.y,this.w,this.h)}clone(){return new s(this.x,this.y,this.w,this.h)}},Fd=class s{constructor(e){this.ref=e}run(e){e.setStencilReference(this.ref)}clone(){return new s(this.ref)}},qx=class s{constructor(e){this.color=e}run(e){e.setBlendConstant(this.color)}clone(){return new s(this.color)}},Qx=class s{constructor(e){this.query=e}run(e){e.beginOcclusionQuery(this.query)}clone(){return new s(this.query)}},jx=class s{constructor(){}run(e){e.endOcclusionQuery()}clone(){return new s}},LP=class s{constructor(){this.bundles=[]}run(e){e.executeBundles(this.bundles)}clone(){let e=new s;return e.bundles=this.bundles,e}},Zx=class s{constructor(e){this.numDrawCalls=0,this._device=e,this._list=new Array(10),this._listLength=0}addBundle(e){if(!this._currentItemIsBundle){let t=new LP;this._list[this._listLength++]=t,this._currentBundleList=t.bundles,this._currentItemIsBundle=!0}e&&this._currentBundleList.push(e)}_finishBundle(){this._currentItemIsBundle&&this._bundleEncoder&&(this._currentBundleList.push(this._bundleEncoder.finish()),this._bundleEncoder=void 0,this._currentItemIsBundle=!1)}addItem(e){this._finishBundle(),this._list[this._listLength++]=e,this._currentItemIsBundle=!1}getBundleEncoder(e,t,i){return this._currentItemIsBundle||(this.addBundle(),this._bundleEncoder=this._device.createRenderBundleEncoder({colorFormats:e,depthStencilFormat:t,sampleCount:tt.GetSample(i)})),this._bundleEncoder}close(){this._finishBundle()}run(e){this.close();for(let t=0;t<this._listLength;++t)this._list[t].run(e)}reset(){this._listLength=0,this._currentItemIsBundle=!1,this.numDrawCalls=0}clone(){this.close();let e=new s(this._device);e._list=new Array(this._listLength),e._listLength=this._listLength,e.numDrawCalls=this.numDrawCalls;for(let t=0;t<this._listLength;++t)e._list[t]=this._list[t].clone();return e}}});var gh,FP=S(()=>{dh();gh=class{get querySet(){return this._querySet}constructor(e,t,i,r,n,a=!0,o){this._dstBuffers=[],this._engine=e,this._device=r,this._bufferManager=n,this._count=t,this._canUseMultipleBuffers=a,this._querySet=r.createQuerySet({label:o??"QuerySet",type:i,count:t}),this._queryBuffer=n.createRawBuffer(8*t,rt.QueryResolve|rt.CopySrc,void 0,"QueryBuffer"),a||this._dstBuffers.push(this._bufferManager.createRawBuffer(8*this._count,rt.MapRead|rt.CopyDst,void 0,"QueryBufferNoMultipleBuffers"))}_getBuffer(e,t){if(!this._canUseMultipleBuffers&&this._dstBuffers.length===0)return null;let i=this._device.createCommandEncoder(),r;return this._dstBuffers.length===0?r=this._bufferManager.createRawBuffer(8*this._count,rt.MapRead|rt.CopyDst,void 0,"QueryBufferAdditionalBuffer"):(r=this._dstBuffers[this._dstBuffers.length-1],this._dstBuffers.length--),i.resolveQuerySet(this._querySet,e,t,this._queryBuffer,0),i.copyBufferToBuffer(this._queryBuffer,0,r,0,8*t),this._device.queue.submit([i.finish()]),r}async readValues(e=0,t=1){let i=this._getBuffer(e,t);if(i===null)return null;let r=this._engine.uniqueId;try{await i.mapAsync(1);let n=new BigUint64Array(i.getMappedRange()).slice();return i.unmap(),this._dstBuffers[this._dstBuffers.length]=i,n}catch(n){if(this._engine.isDisposed||this._engine.uniqueId!==r)return null;throw n}}async readValue(e=0){let t=this._getBuffer(e,1);if(t===null)return null;let i=this._engine.uniqueId;try{await t.mapAsync(1);let r=new BigUint64Array(t.getMappedRange()),n=Number(r[0]);return t.unmap(),this._dstBuffers[this._dstBuffers.length]=t,n}catch(r){if(this._engine.isDisposed||this._engine.uniqueId!==i)return 0;throw r}}async readTwoValuesAndSubtract(e=0){let t=this._getBuffer(e,2);if(t===null)return null;let i=this._engine.uniqueId;try{await t.mapAsync(1);let r=new BigUint64Array(t.getMappedRange()),n=Number(r[1]-r[0]);return t.unmap(),this._dstBuffers[this._dstBuffers.length]=t,n}catch(r){if(this._engine.isDisposed||this._engine.uniqueId!==i)return 0;throw r}}dispose(){this._querySet.destroy(),this._bufferManager.releaseBuffer(this._queryBuffer);for(let e=0;e<this._dstBuffers.length;++e)this._bufferManager.releaseBuffer(this._dstBuffers[e])}}});var Jx,NP,c7=S(()=>{Wc();FP();Ee();Jx=class{get gpuFrameTimeCounter(){return this._gpuFrameTimeCounter}constructor(e,t,i){this._enabled=!1,this._gpuFrameTimeCounter=new sr,this._measureDurationState=0,this._engine=e,this._device=t,this._bufferManager=i}get enable(){return this._enabled}set enable(e){if(this._enabled!==e)if(this._enabled=e,this._measureDurationState=0,e)try{this._measureDuration=new NP(this._engine,this._device,this._bufferManager,2e3,"QuerySet_TimestampQuery")}catch(t){this._enabled=!1,P.Error(`Could not create a WebGPUDurationMeasure!
Error: `+t.message+`
Make sure timestamp query is supported and enabled in your browser.`);return}else this._measureDuration.dispose()}startFrame(e){this._enabled&&this._measureDurationState===0&&(this._measureDuration.start(e),this._measureDurationState=1)}endFrame(e){this._measureDurationState===1&&(this._measureDurationState=2,this._measureDuration.stop(e).then(t=>{t!==null&&t>=0&&(this._gpuFrameTimeCounter.fetchNewFrame(),this._gpuFrameTimeCounter.addCount(t,!0)),this._measureDurationState=0}))}startPass(e,t){this._enabled?this._measureDuration.startPass(e,t):e.timestampWrites=void 0}endPass(e,t){if(!this._enabled||!t)return;let i=this._engine.frameId;this._measureDuration.stopPass(e).then(r=>{t._addDuration(i,r!==null&&r>0?r:0)})}dispose(){this._measureDuration?.dispose()}},NP=class{constructor(e,t,i,r=2,n){this._count=r,this._querySet=new gh(e,r,"timestamp",t,i,!0,n)}start(e){e.writeTimestamp?.(this._querySet.querySet,0)}async stop(e){return e.writeTimestamp?.(this._querySet.querySet,1),e.writeTimestamp?await this._querySet.readTwoValuesAndSubtract(0):0}startPass(e,t){if(t+3>this._count)throw new Error("WebGPUDurationMeasure: index out of range ("+t+")");e.timestampWrites={querySet:this._querySet.querySet,beginningOfPassWriteIndex:t+2,endOfPassWriteIndex:t+3}}async stopPass(e){return await this._querySet.readTwoValuesAndSubtract(e+2)}dispose(){this._querySet.dispose()}}});var $x,f7=S(()=>{FP();$x=class{get querySet(){return this._querySet.querySet}get hasQueries(){return this._currentTotalIndices!==this._availableIndices.length}canBeginQuery(e){if(this._frameQuerySetIsDirty===this._engine.frameId||this._queryFrameId[e]===this._engine.frameId)return!1;let t=this._engine._getCurrentRenderPassWrapper().renderPassDescriptor.occlusionQuerySet!==void 0;return t&&(this._queryFrameId[e]=this._engine.frameId),t}constructor(e,t,i,r=50,n=100){this._availableIndices=[],this._frameQuerySetIsDirty=-1,this._queryFrameId=[],this._engine=e,this._device=t,this._bufferManager=i,this._frameLastBuffer=-1,this._currentTotalIndices=0,this._countIncrement=n,this._allocateNewIndices(r)}createQuery(){this._availableIndices.length===0&&this._allocateNewIndices();let e=this._availableIndices[this._availableIndices.length-1];return this._availableIndices.length--,e}deleteQuery(e){this._availableIndices[this._availableIndices.length]=e}isQueryResultAvailable(e){return this._retrieveQueryBuffer(),!!this._lastBuffer&&e<this._lastBuffer.length}getQueryResult(e){return Number(this._lastBuffer?.[e]??-1)}_retrieveQueryBuffer(){this._lastBuffer&&this._frameLastBuffer===this._engine.frameId||this._frameLastBuffer!==this._engine.frameId&&(this._frameLastBuffer=this._engine.frameId,this._querySet.readValues(0,this._currentTotalIndices).then(e=>{this._lastBuffer=e}))}_allocateNewIndices(e){e=e??this._countIncrement,this._delayQuerySetDispose();for(let t=0;t<e;++t)this._availableIndices.push(this._currentTotalIndices+t);this._currentTotalIndices+=e,this._querySet=new gh(this._engine,this._currentTotalIndices,"occlusion",this._device,this._bufferManager,!1,"QuerySet_OcclusionQuery_count_"+this._currentTotalIndices),this._frameQuerySetIsDirty=this._engine.frameId}_delayQuerySetDispose(){let e=this._querySet;e&&setTimeout(()=>e.dispose,1e3)}dispose(){this._querySet?.dispose(),this._availableIndices.length=0}}});var Nd,h7=S(()=>{Ee();Fx();Nd=class s{get code(){return this._sourceCode}constructor(e,t=20){this.debug=!1,this._sourceCode=e,this._numMaxIterations=t,this._functionDescr=[],this.inlineToken="#define inline"}processCode(){this.debug&&P.Log(`Start inlining process (code size=${this._sourceCode.length})...`),this._collectFunctions(),this._processInlining(this._numMaxIterations),this.debug&&P.Log("End of inlining process.")}_collectFunctions(){let e=0;for(;e<this._sourceCode.length;){let t=this._sourceCode.indexOf(this.inlineToken,e);if(t<0)break;let i=this._sourceCode.indexOf("(",t+this.inlineToken.length);if(i<0){this.debug&&P.Warn(`Could not find the opening parenthesis after the token. startIndex=${e}`),e=t+this.inlineToken.length;continue}let r=s._RegexpFindFunctionNameAndType.exec(this._sourceCode.substring(t+this.inlineToken.length,i));if(!r){this.debug&&P.Warn(`Could not extract the name/type of the function from: ${this._sourceCode.substring(t+this.inlineToken.length,i)}`),e=t+this.inlineToken.length;continue}let[n,a]=[r[3],r[4]],o=Md("(",")",this._sourceCode,i);if(o<0){this.debug&&P.Warn(`Could not extract the parameters the function '${a}' (type=${n}). funcParamsStartIndex=${i}`),e=t+this.inlineToken.length;continue}let l=this._sourceCode.substring(i+1,o),c=yP(this._sourceCode,o+1);if(c===this._sourceCode.length){this.debug&&P.Warn(`Could not extract the body of the function '${a}' (type=${n}). funcParamsEndIndex=${o}`),e=t+this.inlineToken.length;continue}let f=Md("{","}",this._sourceCode,c);if(f<0){this.debug&&P.Warn(`Could not extract the body of the function '${a}' (type=${n}). funcBodyStartIndex=${c}`),e=t+this.inlineToken.length;continue}let h=this._sourceCode.substring(c,f+1),u=Pd(l).split(","),d=[];for(let _=0;_<u.length;++_){let v=u[_].trim(),T=v.lastIndexOf(" ");T>=0&&d.push(v.substring(T+1))}n!=="void"&&d.push("return"),this._functionDescr.push({name:a,type:n,parameters:d,body:h,callIndex:0}),e=f+1;let p=t>0?this._sourceCode.substring(0,t):"",m=f+1<this._sourceCode.length-1?this._sourceCode.substring(f+1):"";this._sourceCode=p+m,e-=f+1-t}this.debug&&P.Log(`Collect functions: ${this._functionDescr.length} functions found. functionDescr=${this._functionDescr}`)}_processInlining(e=20){for(;e-->=0&&this._replaceFunctionCallsByCode(););return this.debug&&P.Log(`numMaxIterations is ${e} after inlining process`),e>=0}_replaceFunctionCallsByCode(){let e=!1;for(let t of this._functionDescr){let{name:i,type:r,parameters:n,body:a}=t,o=0;for(;o<this._sourceCode.length;){let l=this._sourceCode.indexOf(i,o);if(l<0)break;if(l===0||wx(this._sourceCode.charAt(l-1))){o=l+i.length;continue}let c=yP(this._sourceCode,l+i.length);if(c===this._sourceCode.length||this._sourceCode.charAt(c)!=="("){o=l+i.length;continue}let f=Md("(",")",this._sourceCode,c);if(f<0){this.debug&&P.Warn(`Could not extract the parameters of the function call. Function '${i}' (type=${r}). callParamsStartIndex=${c}`),o=l+i.length;continue}let h=this._sourceCode.substring(c+1,f),d=(C=>{let I=[],R=0,b=0;for(;R<C.length;){if(C.charAt(R)==="("){let M=Md("(",")",C,R);if(M<0)return null;R=M}else C.charAt(R)===","&&(I.push(C.substring(b,R)),b=R+1);R++}return b<R&&I.push(C.substring(b,R)),I})(Pd(h));if(d===null){this.debug&&P.Warn(`Invalid function call: can't extract the parameters of the function call. Function '${i}' (type=${r}). callParamsStartIndex=${c}, callParams=`+h),o=l+i.length;continue}let p=[];for(let C=0;C<d.length;++C){let I=d[C].trim();p.push(I)}let m=r!=="void"?i+"_"+t.callIndex++:null;if(m&&p.push(m+" ="),p.length!==n.length){this.debug&&P.Warn(`Invalid function call: not the same number of parameters for the call than the number expected by the function. Function '${i}' (type=${r}). function parameters=${n}, call parameters=${p}`),o=l+i.length;continue}o=f+1;let _=this._replaceNames(a,n,p),v=l>0?this._sourceCode.substring(0,l):"",T=f+1<this._sourceCode.length-1?this._sourceCode.substring(f+1):"";if(m){let C=VK(this._sourceCode,l-1,`
`,"{");v=this._sourceCode.substring(0,C+1);let I=this._sourceCode.substring(C+1,l);this._sourceCode=v+r+" "+m+`;
`+_+`
`+I+m+T,this.debug&&P.Log(`Replace function call by code. Function '${i}' (type=${r}). injectDeclarationIndex=${C}, call parameters=${p}`)}else this._sourceCode=v+_+T,o+=_.length-(f+1-l),this.debug&&P.Log(`Replace function call by code. Function '${i}' (type=${r}). functionCallIndex=${l}, call parameters=${p}`);e=!0}}return e}_replaceNames(e,t,i){for(let r=0;r<t.length;++r){let n=new RegExp(kK(t[r]),"g"),a=t[r].length,o=i[r];e=e.replace(n,(l,...c)=>{let f=c[0];return wx(e.charAt(f-1))||wx(e.charAt(f+a))?t[r]:o})}return e}};Nd._RegexpFindFunctionNameAndType=/((\s+?)(\w+)\s+(\w+)\s*?)$/});var ll,u7=S(()=>{Ee();$e();ll=class s{async initTwgsl(e){if(!s._Twgsl){if(e=e||{},e={...s._TwgslDefaultOptions,...e},e.twgsl){s._Twgsl=e.twgsl;return}if(e.jsPath&&e.wasmPath&&await W.LoadBabylonScriptAsync(e.jsPath),self.twgsl){s._Twgsl=await self.twgsl(W.GetBabylonScriptURL(e.wasmPath));return}throw new Error("twgsl is not available.")}}convertSpirV2WGSL(e,t=!1){let i=s._Twgsl.convertSpirV2WGSL(e,s.DisableUniformityAnalysis||t);return s.ShowWGSLShaderCode&&(P.Log(i),P.Log("***********************************************")),s.DisableUniformityAnalysis||t?`diagnostic(off, derivative_uniformity);
`+i:i}};ll._TwgslDefaultOptions={jsPath:`${W._DefaultCdnUrl}/twgsl/twgsl.js`,wasmPath:`${W._DefaultCdnUrl}/twgsl/twgsl.wasm`};ll.ShowWGSLShaderCode=!1;ll.DisableUniformityAnalysis=!1;ll._Twgsl=null});var eA,d7=S(()=>{Ee();eA=class{constructor(e,t,i){this._record=!1,this._play=!1,this._playBundleListIndex=0,this._allBundleLists=[],this._enabled=!1,this.showDebugLogs=!1,this._engine=e,this._mode=t,this._bundleList=i}get enabled(){return this._enabled}get play(){return this._play}get record(){return this._record}set enabled(e){this._log("enabled",`activate=${e}, mode=${this._mode}`),this._allBundleLists.length=0,this._record=this._enabled=e,this._play=!1,e&&(this._modeSaved=this._mode,this._mode=0)}get mode(){return this._mode}set mode(e){this._record?this._modeSaved=e:this._mode=e}endRenderPass(e){if(!this._record&&!this._play)return!1;let t=null;return this._record?(t=this._bundleList.clone(),this._allBundleLists.push(t),this._bundleList.reset(),this._log("endRenderPass",`bundleList recorded at position #${this._allBundleLists.length-1}`)):this._playBundleListIndex>=this._allBundleLists.length?this._log("endRenderPass",`empty or out-of-sync bundleList (_allBundleLists.length=${this._allBundleLists.length}, playBundleListIndex=${this._playBundleListIndex})`):(this._log("endRenderPass",`run bundleList #${this._playBundleListIndex}`),t=this._allBundleLists[this._playBundleListIndex++]),t&&(t.run(e),this._mode===1&&this._engine._reportDrawCall(t.numDrawCalls)),!0}endFrame(){this._record&&(this._record=!1,this._play=!0,this._mode=this._modeSaved,this._log("endFrame","bundles recorded, switching to play mode")),this._playBundleListIndex=0}reset(){this._log("reset","called"),this._record&&(this._mode=this._modeSaved),this.enabled=!1,this.enabled=!0}_log(e,t){this.showDebugLogs&&P.Log(`[Frame: ${this._engine.frameId}] WebGPUSnapshotRendering:${e} - ${t}`)}}});var Bd,p7=S(()=>{yt();Nc();Bd=(()=>{let s=new Uint8Array(4),e=new Uint32Array(s.buffer);return!!((e[0]=1)&s[0])})();Object.defineProperty(A.prototype,"effectiveByteStride",{get:function(){return this._alignedBuffer&&this._alignedBuffer.byteStride||this.byteStride},enumerable:!0,configurable:!0});Object.defineProperty(A.prototype,"effectiveByteOffset",{get:function(){return this._alignedBuffer?0:this.byteOffset},enumerable:!0,configurable:!0});Object.defineProperty(A.prototype,"effectiveBuffer",{get:function(){return this._alignedBuffer&&this._alignedBuffer.getBuffer()||this._buffer.getBuffer()},enumerable:!0,configurable:!0});A.prototype._rebuild=function(){this._buffer?._rebuild(),this._alignedBuffer?._rebuild()};A.prototype.dispose=function(){this._ownsBuffer&&this._buffer.dispose(),this._alignedBuffer?.dispose(),this._alignedBuffer=void 0,this._isDisposed=!0};A.prototype.getWrapperBuffer=function(){return this._alignedBuffer||this._buffer};A.prototype._alignBuffer=function(){let s=this._buffer.getData();if(!this.engine._features.forceVertexBufferStrideAndOffsetMultiple4Bytes||this.byteStride%4===0&&this.byteOffset%4===0||!s)return;let e=Qs(this.type),t=this.byteStride+3&-4,i=t/e,r=this._maxVerticesCount,a=r*t/e,o;if(Array.isArray(s)){let h=new Float32Array(s);o=new DataView(h.buffer,h.byteOffset,h.byteLength)}else s instanceof ArrayBuffer?o=new DataView(s,0,s.byteLength):o=new DataView(s.buffer,s.byteOffset,s.byteLength);let l;this.type===A.BYTE?l=new Int8Array(a):this.type===A.UNSIGNED_BYTE?l=new Uint8Array(a):this.type===A.SHORT?l=new Int16Array(a):this.type===A.UNSIGNED_SHORT?l=new Uint16Array(a):this.type===A.INT?l=new Int32Array(a):this.type===A.UNSIGNED_INT?l=new Uint32Array(a):l=new Float32Array(a);let c=this.getSize(),f=this.byteOffset;for(let h=0;h<r;++h){for(let u=0;u<c;++u)switch(this.type){case A.BYTE:l[h*i+u]=o.getInt8(f+u);break;case A.UNSIGNED_BYTE:l[h*i+u]=o.getUint8(f+u);break;case A.SHORT:l[h*i+u]=o.getInt16(f+u*2,Bd);break;case A.UNSIGNED_SHORT:l[h*i+u]=o.getUint16(f+u*2,Bd);break;case A.INT:l[h*i+u]=o.getInt32(f+u*4,Bd);break;case A.UNSIGNED_INT:l[h*i+u]=o.getUint32(f+u*4,Bd);break;case A.FLOAT:l[h*i+u]=o.getFloat32(f+u*4,Bd);break}f+=this.byteStride}this._alignedBuffer?.dispose(),this._alignedBuffer=new Gr(this.engine,l,!1,t,!1,this.getIsInstanced(),!0,this.instanceDivisor,(this._label??"VertexBuffer")+"_aligned")}});var tA,m7=S(()=>{OP();tA=class extends _h{constructor(e){super(e)}}});var _7=S(()=>{Jt();em();aa();ft.prototype.setAlphaMode=function(s,e=!1,t=0){let i=this._alphaState._alphaBlend[t];if(this._alphaMode[t]===s&&(s===0&&!i||s!==0&&i)){if(!e){let n=s===0;this.depthCullingState.depthMask!==n&&(this.setDepthWrite(n),this._cacheRenderPipeline.setDepthWriteEnabled(n))}return}let r=s===0;this._alphaState.setAlphaBlend(!r,t),this._alphaState.setAlphaMode(s,t),e||(this.setDepthWrite(r),this._cacheRenderPipeline.setDepthWriteEnabled(r)),this._alphaMode[t]=s,this._cacheRenderPipeline.setAlphaBlendEnabled(this._alphaState._alphaBlend,this._alphaState._numTargetEnabled),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters)};ft.prototype.setAlphaEquation=function(s,e=0){k.prototype.setAlphaEquation.call(this,s,e),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters)}});function Ud(s,e,t,i){let r,n=1;i===1?r=new Float32Array(e*t*4):i===2?(r=new Uint16Array(e*t*4),n=15360):i===7?r=new Uint32Array(e*t*4):r=new Uint8Array(e*t*4);for(let a=0;a<e;a++)for(let o=0;o<t;o++){let l=(o*e+a)*3,c=(o*e+a)*4;r[c+0]=s[l+0],r[c+1]=s[l+1],r[c+2]=s[l+2],r[c+3]=n}return r}var g7=S(()=>{vi();Ee();aa();ft.prototype.createRawTexture=function(s,e,t,i,r,n,a,o=null,l=0,c=0,f=!1){let h=new Je(this,3);return h.baseWidth=e,h.baseHeight=t,h.width=e,h.height=t,h.format=i,h.generateMipMaps=r,h.samplingMode=a,h.invertY=n,h._compression=o,h.type=l,h._creationFlags=c,h._useSRGBBuffer=f,this._doNotHandleContextLost||(h._bufferView=s),this._textureHelper.createGPUTextureForInternalTexture(h,e,t,void 0,c),this.updateRawTexture(h,s,i,n,o,l,f),this._internalTexturesCache.push(h),h};ft.prototype.updateRawTexture=function(s,e,t,i,r=null,n=0,a=!1){if(s){if(this._doNotHandleContextLost||(s._bufferView=e,s.invertY=i,s._compression=r,s._useSRGBBuffer=a),e){let o=s._hardwareTexture;t===4&&(e=Ud(e,s.width,s.height,n));let c=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);this._textureHelper.updateTexture(c,s,s.width,s.height,s.depth,o.format,0,0,i,!1,0,0),s.generateMipMaps&&this._generateMipmaps(s,this._uploadEncoder)}s.isReady=!0}};ft.prototype.createRawCubeTexture=function(s,e,t,i,r,n,a,o=null){let l=new Je(this,8);if(i===1&&!this._caps.textureFloatLinearFiltering?(r=!1,a=1,P.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):i===2&&!this._caps.textureHalfFloatLinearFiltering?(r=!1,a=1,P.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):i===1&&!this._caps.textureFloatRender?(r=!1,P.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):i===2&&!this._caps.colorBufferFloat&&(r=!1,P.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")),l.isCube=!0,l._originalFormat=t,l.format=t===4?5:t,l.type=i,l.generateMipMaps=r,l.width=e,l.height=e,l.samplingMode=a,this._doNotHandleContextLost||(l._bufferViewArray=s),l.invertY=n,l._compression=o,l._cachedWrapU=0,l._cachedWrapV=0,this._textureHelper.createGPUTextureForInternalTexture(l),t===4){let c=l._hardwareTexture;c._originalFormatIsRGB=!0}return s&&this.updateRawCubeTexture(l,s,t,i,n,o),l.isReady=!0,l};ft.prototype.updateRawCubeTexture=function(s,e,t,i,r,n=null){s._bufferViewArray=e,s.invertY=r,s._compression=n;let a=s._hardwareTexture,o=a._originalFormatIsRGB,l=[0,2,4,1,3,5],c=[];for(let f=0;f<e.length;++f){let h=e[l[f]];o&&(h=Ud(h,s.width,s.height,i)),c.push(new Uint8Array(h.buffer,h.byteOffset,h.byteLength))}this._textureHelper.updateCubeTextures(c,a.underlyingResource,s.width,s.height,a.format,r,!1,0,0),s.generateMipMaps&&this._generateMipmaps(s,this._uploadEncoder),s.isReady=!0};ft.prototype.createRawCubeTextureFromUrl=function(s,e,t,i,r,n,a,o,l=null,c=null,f=3,h=!1){let u=this.createRawCubeTexture(null,t,i,r,!n,h,f,null);e?.addPendingData(u),u.url=s,u.isReady=!1,this._internalTexturesCache.push(u);let d=(m,_)=>{e?.removePendingData(u),c&&m&&c(m.status+" "+m.statusText,_)},p=async m=>{let _=a(m);if(!_)return;let v=_ instanceof Promise?await _:_,T=u.width;if(o){let C=i===4,I=o(v),R=u._hardwareTexture,b=[0,1,2,3,4,5];for(let M=0;M<I.length;M++){let F=T>>M,U=[];for(let D=0;D<6;D++){let $=I[M][b[D]];C&&($=Ud($,F,F,r)),U.push(new Uint8Array($.buffer,$.byteOffset,$.byteLength))}this._textureHelper.updateCubeTextures(U,R.underlyingResource,F,F,R.format,h,!1,0,0)}}else this.updateRawCubeTexture(u,v,i,r,h);u.isReady=!0,e?.removePendingData(u),l&&l()};return this._loadFile(s,m=>{p(m).catch(_=>{d(void 0,_)})},void 0,e?.offlineProvider,!0,d),u};ft.prototype.createRawTexture3D=function(s,e,t,i,r,n,a,o,l=null,c=0,f=0){let u=new Je(this,10);return u.baseWidth=e,u.baseHeight=t,u.baseDepth=i,u.width=e,u.height=t,u.depth=i,u.format=r,u.type=c,u.generateMipMaps=n,u.samplingMode=o,u.is3D=!0,u._creationFlags=f,this._doNotHandleContextLost||(u._bufferView=s),this._textureHelper.createGPUTextureForInternalTexture(u,e,t,void 0,f),this.updateRawTexture3D(u,s,r,a,l,c),this._internalTexturesCache.push(u),u};ft.prototype.updateRawTexture3D=function(s,e,t,i,r=null,n=0){if(this._doNotHandleContextLost||(s._bufferView=e,s.format=t,s.invertY=i,s._compression=r),e){let a=s._hardwareTexture;t===4&&(e=Ud(e,s.width,s.height,n));let l=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);this._textureHelper.updateTexture(l,s,s.width,s.height,s.depth,a.format,0,0,i,!1,0,0),s.generateMipMaps&&this._generateMipmaps(s,this._uploadEncoder)}s.isReady=!0};ft.prototype.createRawTexture2DArray=function(s,e,t,i,r,n,a,o,l=null,c=0,f=0){let u=new Je(this,11);return u.baseWidth=e,u.baseHeight=t,u.baseDepth=i,u.width=e,u.height=t,u.depth=i,u.format=r,u.type=c,u.generateMipMaps=n,u.samplingMode=o,u.is2DArray=!0,u._creationFlags=f,this._doNotHandleContextLost||(u._bufferView=s),this._textureHelper.createGPUTextureForInternalTexture(u,e,t,i,f),this.updateRawTexture2DArray(u,s,r,a,l,c),this._internalTexturesCache.push(u),u};ft.prototype.updateRawTexture2DArray=function(s,e,t,i,r=null,n=0){if(this._doNotHandleContextLost||(s._bufferView=e,s.format=t,s.invertY=i,s._compression=r),e){let a=s._hardwareTexture;t===4&&(e=Ud(e,s.width,s.height,n));let l=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);this._textureHelper.updateTexture(l,s,s.width,s.height,s.depth,a.format,0,0,i,!1,0,0),s.generateMipMaps&&this._generateMipmaps(s,this._uploadEncoder)}s.isReady=!0}});var v7=S(()=>{aa();ft.prototype._readTexturePixels=function(s,e,t,i=-1,r=0,n=null,a=!0,o=!1,l=0,c=0){let f=s._hardwareTexture;return a&&this.flushFramebuffer(),this._textureHelper.readPixels(f.underlyingResource,l,c,e,t,f.format,i,r,n,o)};ft.prototype._readTexturePixelsSync=function(){throw"_readTexturePixelsSync is unsupported in WebGPU!"}});var S7=S(()=>{vi();fo();aa();ft.prototype._createDepthStencilCubeTexture=function(s,e){let t=new Je(this,e.generateStencil?12:14);t.isCube=!0,t.label=e.label;let i={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,samples:1,depthTextureFormat:e.generateStencil?13:14,...e};t.format=i.depthTextureFormat,this._setupDepthStencilTexture(t,s,i.bilinearFiltering,i.comparisonFunction,i.samples),this._textureHelper.createGPUTextureForInternalTexture(t);let r=t._hardwareTexture;return t.type=tt.GetTextureTypeFromFormat(r.format),this._internalTexturesCache.push(t),t};ft.prototype.createCubeTexture=function(s,e,t,i,r=null,n=null,a,o=null,l=!1,c=0,f=0,h=null,u,d=!1,p=null){return this.createCubeTextureBase(s,e,t,!!i,r,n,a,o,l,c,f,h,null,(m,_)=>{let v=_,T=v[0].width,C=T;this._setCubeMapTextureParams(m,!i),m.format=a??-1;let I=this._textureHelper.createGPUTextureForInternalTexture(m,T,C);this._textureHelper.updateCubeTextures(v,I.underlyingResource,T,C,I.format,!1,!1,0,0),i||this._generateMipmaps(m,this._uploadEncoder),m.isReady=!0,m.onLoadedObservable.notifyObservers(m),m.onLoadedObservable.clear(),r&&r()},!!d,p)};ft.prototype._setCubeMapTextureParams=function(s,e,t){s.samplingMode=e?3:2,s._cachedWrapU=0,s._cachedWrapV=0,t&&(s._maxLodLevel=t)};ft.prototype.generateMipMapsForCubemap=function(s){s.generateMipMaps&&(s._hardwareTexture?.underlyingResource||this._textureHelper.createGPUTextureForInternalTexture(s),this._generateMipmaps(s))}});var iA,E7=S(()=>{dR();IP();iA=class extends kc{constructor(e,t,i,r,n){super(e,t,i,r,n),r.enableGPUTimingMeasurements&&(this.gpuTimeInFrame=new uh)}}});var T7=S(()=>{vi();E7();Tl();$p();aa();ft.prototype._createHardwareRenderTargetWrapper=function(s,e,t){let i=new iA(s,e,t,this);return this._renderTargetWrapperCache.push(i),i};ft.prototype.createRenderTargetTexture=function(s,e){let t=this._createHardwareRenderTargetWrapper(!1,!1,s),i={};e!==void 0&&typeof e=="object"?(i.generateMipMaps=e.generateMipMaps,i.generateDepthBuffer=e.generateDepthBuffer===void 0?!0:e.generateDepthBuffer,i.generateStencilBuffer=i.generateDepthBuffer&&e.generateStencilBuffer,i.samplingMode=e.samplingMode===void 0?3:e.samplingMode,i.creationFlags=e.creationFlags??0,i.noColorAttachment=!!e.noColorAttachment,i.colorAttachment=e.colorAttachment,i.samples=e.samples,i.label=e.label,i.format=e.format,i.type=e.type):(i.generateMipMaps=e,i.generateDepthBuffer=!0,i.generateStencilBuffer=!1,i.samplingMode=3,i.creationFlags=0,i.noColorAttachment=!1);let r=i.colorAttachment||(i.noColorAttachment?null:this._createInternalTexture(s,i,!0,5));return t.label=i.label??"RenderTargetWrapper",t._samples=i.colorAttachment?.samples??i.samples??1,t._generateDepthBuffer=i.generateDepthBuffer,t._generateStencilBuffer=!!i.generateStencilBuffer,t.setTextures(r),(t._generateDepthBuffer||t._generateStencilBuffer)&&t.createDepthStencilTexture(0,!1,t._generateStencilBuffer,t.samples,i.generateStencilBuffer?13:14,i.label?i.label+"-DepthStencil":void 0),r&&!i.colorAttachment&&(e!==void 0&&typeof e=="object"&&e.createMipMaps&&!i.generateMipMaps&&(r.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(r,void 0,void 0,void 0,i.creationFlags),e!==void 0&&typeof e=="object"&&e.createMipMaps&&!i.generateMipMaps&&(r.generateMipMaps=!1)),t};ft.prototype._createDepthStencilTexture=function(s,e,t){let i={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,samples:1,depthTextureFormat:e.generateStencil?13:14,...e},r=ss(i.depthTextureFormat);t._depthStencilTextureWithStencil=r;let n=new Je(this,r?12:14);return n.label=e.label,n.format=i.depthTextureFormat,n.type=jp(n.format),this._setupDepthStencilTexture(n,s,i.bilinearFiltering,i.comparisonFunction,i.samples),this._textureHelper.createGPUTextureForInternalTexture(n),this._internalTexturesCache.push(n),n};ft.prototype._setupDepthStencilTexture=function(s,e,t,i,r=1){let n=e.width??e,a=e.height??e,o=e.layers||0,l=e.depth||0;s.baseWidth=n,s.baseHeight=a,s.width=n,s.height=a,s.is2DArray=o>0,s.is3D=l>0,s.depth=o||l,s.isReady=!0,s.samples=r,s.generateMipMaps=!1,s.samplingMode=t?2:1,s.type=1,s._comparisonFunction=i,s._cachedWrapU=0,s._cachedWrapV=0};ft.prototype.updateRenderTargetTextureSampleCount=function(s,e){return!s||!s.texture||s.samples===e||(e=Math.min(e,this.getCaps().maxMSAASamples),this._textureHelper.createMSAATexture(s.texture,e),s._depthStencilTexture&&(this._textureHelper.createMSAATexture(s._depthStencilTexture,e),s._depthStencilTexture.samples=e),s._samples=e,s.texture.samples=e),e}});var x7=S(()=>{aa();ft.prototype.setDepthStencilTexture=function(s,e,t,i){!t||!t.depthStencilTexture?this._setTexture(s,null,void 0,void 0,i):this._setTexture(s,t,!1,!0,i)}});var A7=S(()=>{aa();vi();ft.prototype.createRenderTargetCubeTexture=function(s,e){let t=this._createHardwareRenderTargetWrapper(!1,!0,s),i={generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,samples:1,...e};i.generateStencilBuffer=i.generateDepthBuffer&&i.generateStencilBuffer,t.label=i.label??"RenderTargetWrapper",t._generateDepthBuffer=i.generateDepthBuffer,t._generateStencilBuffer=i.generateStencilBuffer;let r=new Je(this,5);return r.width=s,r.height=s,r.depth=0,r.isReady=!0,r.isCube=!0,r.samples=i.samples,r.generateMipMaps=i.generateMipMaps,r.samplingMode=i.samplingMode,r.type=i.type,r.format=i.format,this._internalTexturesCache.push(r),t.setTextures(r),(t._generateDepthBuffer||t._generateStencilBuffer)&&t.createDepthStencilTexture(0,i.samplingMode===void 0||i.samplingMode===2||i.samplingMode===2||i.samplingMode===3||i.samplingMode===3||i.samplingMode===5||i.samplingMode===6||i.samplingMode===7||i.samplingMode===11,t._generateStencilBuffer,t.samples),e&&e.createMipMaps&&!i.generateMipMaps&&(r.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(r),e&&e.createMipMaps&&!i.generateMipMaps&&(r.generateMipMaps=!1),t}});var BP,R7=S(()=>{Ef();Jt();BP=class{constructor(){this.occlusionInternalRetryCounter=0,this.isOcclusionQueryInProgress=!1,this.isOccluded=!1,this.occlusionRetryCount=-1,this.occlusionType=Ct.OCCLUSION_TYPE_NONE,this.occlusionQueryAlgorithmType=Ct.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE,this.forceRenderingWhenOccluded=!1}};k.prototype.createQuery=function(){return null};k.prototype.deleteQuery=function(s){return this};k.prototype.isQueryResultAvailable=function(s){return!1};k.prototype.getQueryResult=function(s){return 0};k.prototype.beginOcclusionQuery=function(s,e){return!1};k.prototype.endOcclusionQuery=function(s){return this};Object.defineProperty(Ct.prototype,"isOcclusionQueryInProgress",{get:function(){return this._occlusionDataStorage.isOcclusionQueryInProgress},set:function(s){this._occlusionDataStorage.isOcclusionQueryInProgress=s},enumerable:!1,configurable:!0});Object.defineProperty(Ct.prototype,"_occlusionDataStorage",{get:function(){return this.__occlusionDataStorage||(this.__occlusionDataStorage=new BP),this.__occlusionDataStorage},enumerable:!1,configurable:!0});Object.defineProperty(Ct.prototype,"isOccluded",{get:function(){return this._occlusionDataStorage.isOccluded},set:function(s){this._occlusionDataStorage.isOccluded=s},enumerable:!0,configurable:!0});Object.defineProperty(Ct.prototype,"occlusionQueryAlgorithmType",{get:function(){return this._occlusionDataStorage.occlusionQueryAlgorithmType},set:function(s){this._occlusionDataStorage.occlusionQueryAlgorithmType=s},enumerable:!0,configurable:!0});Object.defineProperty(Ct.prototype,"occlusionType",{get:function(){return this._occlusionDataStorage.occlusionType},set:function(s){this._occlusionDataStorage.occlusionType=s},enumerable:!0,configurable:!0});Object.defineProperty(Ct.prototype,"occlusionRetryCount",{get:function(){return this._occlusionDataStorage.occlusionRetryCount},set:function(s){this._occlusionDataStorage.occlusionRetryCount=s},enumerable:!0,configurable:!0});Object.defineProperty(Ct.prototype,"forceRenderingWhenOccluded",{get:function(){return this._occlusionDataStorage.forceRenderingWhenOccluded},set:function(s){this._occlusionDataStorage.forceRenderingWhenOccluded=s},enumerable:!0,configurable:!0});Ct.prototype._checkOcclusionQuery=function(){let s=this._occlusionDataStorage;if(s.occlusionType===Ct.OCCLUSION_TYPE_NONE)return s.isOccluded=!1,!1;let e=this.getEngine();if(!e.getCaps().supportOcclusionQuery||!e.isQueryResultAvailable)return s.isOccluded=!1,!1;if(this.isOcclusionQueryInProgress&&this._occlusionQuery!==null&&this._occlusionQuery!==void 0)if(e.isQueryResultAvailable(this._occlusionQuery)){let r=e.getQueryResult(this._occlusionQuery);s.isOcclusionQueryInProgress=!1,s.occlusionInternalRetryCounter=0,s.isOccluded=!(r>0)}else if(s.occlusionInternalRetryCounter++,s.occlusionRetryCount!==-1&&s.occlusionInternalRetryCounter>s.occlusionRetryCount)s.isOcclusionQueryInProgress=!1,s.occlusionInternalRetryCounter=0,s.isOccluded=s.occlusionType===Ct.OCCLUSION_TYPE_OPTIMISTIC?!1:s.isOccluded;else return s.occlusionType===Ct.OCCLUSION_TYPE_OPTIMISTIC?!1:s.isOccluded;let t=this.getScene();if(t.getBoundingBoxRenderer){let i=t.getBoundingBoxRenderer();this._occlusionQuery===null&&(this._occlusionQuery=e.createQuery()),this._occlusionQuery&&e.beginOcclusionQuery(s.occlusionQueryAlgorithmType,this._occlusionQuery)&&(i.renderOcclusionBoundingBox(this),e.endOcclusionQuery(s.occlusionQueryAlgorithmType),this._occlusionDataStorage.isOcclusionQueryInProgress=!0)}return s.isOccluded}});var b7=S(()=>{aa();wP();R7();ft.prototype.getGPUFrameTimeCounter=function(){return this._timestampQuery.gpuFrameTimeCounter};ft.prototype.captureGPUFrameTime=function(s){this._timestampQuery.enable=s&&!!this._caps.timerQuery};ft.prototype.createQuery=function(){return this._occlusionQuery.createQuery()};ft.prototype.deleteQuery=function(s){return this._occlusionQuery.deleteQuery(s),this};ft.prototype.isQueryResultAvailable=function(s){return this._occlusionQuery.isQueryResultAvailable(s)};ft.prototype.getQueryResult=function(s){return this._occlusionQuery.getQueryResult(s)};ft.prototype.beginOcclusionQuery=function(s,e){if(this.compatibilityMode){if(this._occlusionQuery.canBeginQuery(e))return this._currentRenderPass?.beginOcclusionQuery(e),!0}else return this._bundleList.addItem(new Qx(e)),!0;return!1};ft.prototype.endOcclusionQuery=function(){return this.compatibilityMode?this._currentRenderPass?.endOcclusionQuery():this._bundleList.addItem(new jx),this}});var y7={};V(y7,{WebGPUEngine:()=>Fr});var C7,I7,Jre,Fr,UP=S(()=>{Ee();aa();ml();vi();dl();dh();yt();UK();WK();zK();yd();$e();fo();Gx();Jt();qK();MP();Rl();PP();DP();$K();e7();t7();i7();r7();l7();wP();c7();f7();h7();u7();Id();d7();wp();p7();gl();uR();ER();Yp();Wc();mR();_R();gR();vR();SR();M0();Lp();m7();_7();g7();v7();S7();T7();x7();A7();b7();C7={label:"TextureView_SwapChain_ResolveTarget",dimension:"2d",format:void 0,mipLevelCount:1,arrayLayerCount:1},I7={label:"TextureView_SwapChain",dimension:"2d",format:void 0,mipLevelCount:1,arrayLayerCount:1},Jre=new me,Fr=class s extends ft{get snapshotRenderingMode(){return this._snapshotRendering.mode}set snapshotRenderingMode(e){this._snapshotRendering.mode=e}snapshotRenderingReset(){this._snapshotRendering.reset()}get snapshotRendering(){return this._snapshotRendering.enabled}set snapshotRendering(e){this._snapshotRendering.enabled=e}get disableCacheSamplers(){return this._cacheSampler?this._cacheSampler.disabled:!1}set disableCacheSamplers(e){this._cacheSampler&&(this._cacheSampler.disabled=e)}get disableCacheRenderPipelines(){return this._cacheRenderPipeline?this._cacheRenderPipeline.disabled:!1}set disableCacheRenderPipelines(e){this._cacheRenderPipeline&&(this._cacheRenderPipeline.disabled=e)}get disableCacheBindGroups(){return this._cacheBindGroups?this._cacheBindGroups.disabled:!1}set disableCacheBindGroups(e){this._cacheBindGroups&&(this._cacheBindGroups.disabled=e)}areAllEffectsReady(){return!0}getFontOffset(e){return rm(e)}static get IsSupportedAsync(){return navigator.gpu?navigator.gpu.requestAdapter().then(e=>!!e,()=>!1).catch(()=>!1):Promise.resolve(!1)}static get IsSupported(){return P.Warn("You must call IsSupportedAsync for WebGPU!"),!1}get supportsUniformBuffers(){return!0}get supportedExtensions(){return this._adapterSupportedExtensions}get enabledExtensions(){return this._deviceEnabledExtensions}get supportedLimits(){return this._adapterSupportedLimits}get currentLimits(){return this._deviceLimits}get description(){return this.name+this.version}get version(){return 1}getInfo(){return{vendor:this._adapterInfo.vendor||"unknown vendor",renderer:this._adapterInfo.architecture||"unknown renderer",version:this._adapterInfo.description||"unknown version"}}get compatibilityMode(){return this._compatibilityMode}set compatibilityMode(e){this._compatibilityMode=e}get currentSampleCount(){return this._currentRenderTarget?this._currentRenderTarget.samples:this._mainPassSampleCount}static CreateAsync(e,t={}){let i=new s(e,t);return new Promise(r=>{i.initAsync(t.glslangOptions,t.twgslOptions).then(()=>r(i))})}constructor(e,t={}){if(super(t.antialias??!0,t),this.uniqueId=-1,this._uploadEncoderDescriptor={label:"upload"},this._renderEncoderDescriptor={label:"render"},this._clearDepthValue=1,this._clearReverseDepthValue=0,this._clearStencilValue=0,this._defaultSampleCount=4,this._glslang=null,this._tintWASM=null,this._glslangAndTintAreFullyLoaded=!1,this._adapterInfo={vendor:"",architecture:"",device:"",description:"",subgroupMinSize:0,subgroupMaxSize:0,isFallbackAdapter:!1},this._compiledComputeEffects={},this._counters={numEnableEffects:0,numEnableDrawWrapper:0,numBundleCreationNonCompatMode:0,numBundleReuseNonCompatMode:0},this.countersLastFrame={numEnableEffects:0,numEnableDrawWrapper:0,numBundleCreationNonCompatMode:0,numBundleReuseNonCompatMode:0},this.numMaxUncapturedErrors=20,this.scenes=[],this._virtualScenes=new Array,this._commandBuffers=[null,null],this._mainRenderPassWrapper={renderPassDescriptor:null,colorAttachmentViewDescriptor:null,depthAttachmentViewDescriptor:null,colorAttachmentGPUTextures:[],depthTextureFormat:void 0},this._rttRenderPassWrapper={renderPassDescriptor:null,colorAttachmentViewDescriptor:null,depthAttachmentViewDescriptor:null,colorAttachmentGPUTextures:[],depthTextureFormat:void 0},this._pendingDebugCommands=[],this._currentVertexBuffers={},this._currentOverrideVertexBuffers=null,this._currentIndexBuffer=null,this._colorWriteLocal=!0,this._forceEnableEffect=!1,this.isNDCHalfZRange=!0,this.hasOriginBottomLeft=!1,this._workingGlslangAndTintPromise=null,this._viewportsCurrent={x:0,y:0,w:0,h:0},this._scissorsCurrent={x:0,y:0,w:0,h:0},this._scissorCached={x:0,y:0,z:0,w:0},this._stencilRefsCurrent=-1,this._blendColorsCurrent=[null,null,null,null],this._performanceMonitor=new Vc,this._name="WebGPU",this._drawCalls=new sr,t.deviceDescriptor=t.deviceDescriptor||{},t.enableGPUDebugMarkers=t.enableGPUDebugMarkers??!1,P.Log(`Babylon.js v${k.Version} - ${this.description} engine`),!navigator.gpu){P.Error("WebGPU is not supported by your browser.");return}t.swapChainFormat=t.swapChainFormat||navigator.gpu.getPreferredCanvasFormat(),this._isWebGPU=!0,this._shaderPlatformName="WEBGPU",this._renderingCanvas=e,this._options=t,this._mainPassSampleCount=t.antialias?this._defaultSampleCount:1,navigator&&navigator.userAgent&&this._setupMobileChecks(),this._sharedInit(this._renderingCanvas),this._shaderProcessor=new Nx,this._shaderProcessorWGSL=new Bx}prepareGlslangAndTintAsync(){return this._workingGlslangAndTintPromise||(this._workingGlslangAndTintPromise=new Promise(e=>{this._initGlslangAsync(this._glslangOptions??this._options?.glslangOptions).then(t=>{this._glslang=t,this._tintWASM=new ll,this._tintWASM.initTwgsl(this._twgslOptions??this._options?.twgslOptions).then(()=>{this._glslangAndTintAreFullyLoaded=!0,e()})})})),this._workingGlslangAndTintPromise}initAsync(e,t){return this.uniqueId=s._InstanceId++,this._glslangOptions=e,this._twgslOptions=t,navigator.gpu.requestAdapter(this._options).then(async i=>{if(i){this._adapter=i,this._adapterSupportedExtensions=[],this._adapter.features?.forEach(a=>{this._adapterSupportedExtensions.push(a)}),this._adapterSupportedLimits=this._adapter.limits,this._adapterInfo=this._adapter.info;let r=this._options.deviceDescriptor??{},n=r?.requiredFeatures??(this._options.enableAllFeatures?this._adapterSupportedExtensions:void 0);if(n){let a=n,o=[];for(let l of a)this._adapterSupportedExtensions.indexOf(l)!==-1&&o.push(l);r.requiredFeatures=o}if(this._options.setMaximumLimits&&!r.requiredLimits){r.requiredLimits={};for(let a in this._adapterSupportedLimits)a==="minSubgroupSize"||a==="maxSubgroupSize"||(r.requiredLimits[a]=this._adapterSupportedLimits[a])}return r.label=`BabylonWebGPUDevice${this.uniqueId}`,await this._adapter.requestDevice(r)}else throw"Could not retrieve a WebGPU adapter (adapter is null)."}).then(i=>{this._device=i,this._deviceEnabledExtensions=[],this._device.features?.forEach(n=>{this._deviceEnabledExtensions.push(n)}),this._deviceLimits=i.limits;let r=-1;this._device.addEventListener("uncapturederror",n=>{++r<this.numMaxUncapturedErrors?P.Warn(`WebGPU uncaptured error (${r+1}): ${n.error} - ${n.error.message}`):r++===this.numMaxUncapturedErrors&&P.Warn(`WebGPU uncaptured error: too many warnings (${this.numMaxUncapturedErrors}), no more warnings will be reported to the console for this engine.`)}),this._doNotHandleContextLost||this._device.lost?.then(n=>{this._isDisposed||(this._contextWasLost=!0,P.Warn("WebGPU context lost. "+n),this.onContextLostObservable.notifyObservers(this),this._restoreEngineAfterContextLost(async()=>{let a=this.snapshotRenderingMode,o=this.snapshotRendering,l=this.disableCacheSamplers,c=this.disableCacheRenderPipelines,f=this.disableCacheBindGroups,h=this.enableGPUTimingMeasurements;await this.initAsync(this._glslangOptions??this._options?.glslangOptions,this._twgslOptions??this._options?.twgslOptions),this.snapshotRenderingMode=a,this.snapshotRendering=o,this.disableCacheSamplers=l,this.disableCacheRenderPipelines=c,this.disableCacheBindGroups=f,this.enableGPUTimingMeasurements=h,this._currentRenderPass=null}))})}).then(()=>{this._initializeLimits(),this._bufferManager=new kx(this,this._device),this._textureHelper=new Ux(this,this._device,this._bufferManager,this._deviceEnabledExtensions),this._cacheSampler=new mh(this._device),this._cacheBindGroups=new ms(this._device,this._cacheSampler,this),this._timestampQuery=new Jx(this,this._device,this._bufferManager),this._occlusionQuery=this._device.createQuerySet?new $x(this,this._device,this._bufferManager):void 0,this._bundleList=new Zx(this._device),this._snapshotRendering=new eA(this,this._snapshotRenderingMode,this._bundleList),this._ubInvertY=this._bufferManager.createBuffer(new Float32Array([-1,0]),rt.Uniform|rt.CopyDst,"UBInvertY"),this._ubDontInvertY=this._bufferManager.createBuffer(new Float32Array([1,0]),rt.Uniform|rt.CopyDst,"UBDontInvertY"),this.dbgVerboseLogsForFirstFrames&&this._count===void 0&&(this._count=0,P.Log(["%c frame #"+this._count+" - begin","background: #ffff00"])),this._uploadEncoder=this._device.createCommandEncoder(this._uploadEncoderDescriptor),this._renderEncoder=this._device.createCommandEncoder(this._renderEncoderDescriptor),this._emptyVertexBuffer=new A(this,[0],"",{stride:1,offset:0,size:1,label:"EmptyVertexBuffer"}),this._dummyIndexBuffer=this._bufferManager.createBuffer(new Uint16Array([0,0,0,0]),rt.Storage|rt.CopyDst,"DummyIndices"),this._cacheRenderPipeline=new ol(this._device,this._emptyVertexBuffer),this._depthCullingState=new zx(this._cacheRenderPipeline),this._stencilStateComposer=new Hx(this._cacheRenderPipeline),this._stencilStateComposer.stencilGlobal=this._stencilState,this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=515,this._depthCullingState.depthMask=!0,this._textureHelper.setCommandEncoder(this._uploadEncoder),this._clearQuad=new Xx(this._device,this,this._emptyVertexBuffer),this._defaultDrawContext=this.createDrawContext(),this._currentDrawContext=this._defaultDrawContext,this._defaultMaterialContext=this.createMaterialContext(),this._currentMaterialContext=this._defaultMaterialContext,this._initializeContextAndSwapChain(),this._initializeMainAttachments(),this.resize()}).catch(i=>{throw P.Error("A fatal error occurred during WebGPU creation/initialization."),i})}_initGlslangAsync(e){if(e=e||{},e={...s._GlslangDefaultOptions,...e},e.glslang)return e.glslang;if(self.glslang)return self.glslang(e.wasmPath);if(e.jsPath&&e.wasmPath)return W.LoadBabylonScriptAsync(e.jsPath).then(()=>self.glslang(W.GetBabylonScriptURL(e.wasmPath)));throw new Error("glslang is not available")}_initializeLimits(){let e=this._deviceEnabledExtensions.indexOf("texture-formats-tier1")>=0;this._caps={maxTexturesImageUnits:this._deviceLimits.maxSampledTexturesPerShaderStage,maxVertexTextureImageUnits:this._deviceLimits.maxSampledTexturesPerShaderStage,maxCombinedTexturesImageUnits:this._deviceLimits.maxSampledTexturesPerShaderStage*2,maxTextureSize:this._deviceLimits.maxTextureDimension2D,maxCubemapTextureSize:this._deviceLimits.maxTextureDimension2D,maxRenderTextureSize:this._deviceLimits.maxTextureDimension2D,maxVertexAttribs:this._deviceLimits.maxVertexAttributes,maxDrawBuffers:8,maxVaryingVectors:this._deviceLimits.maxInterStageShaderVariables,maxFragmentUniformVectors:Math.floor(this._deviceLimits.maxUniformBufferBindingSize/4),maxVertexUniformVectors:Math.floor(this._deviceLimits.maxUniformBufferBindingSize/4),shaderFloatPrecision:23,standardDerivatives:!0,astc:this._deviceEnabledExtensions.indexOf("texture-compression-astc")>=0?!0:void 0,s3tc:this._deviceEnabledExtensions.indexOf("texture-compression-bc")>=0?!0:void 0,pvrtc:null,etc1:null,etc2:this._deviceEnabledExtensions.indexOf("texture-compression-etc2")>=0?!0:void 0,bptc:this._deviceEnabledExtensions.indexOf("texture-compression-bc")>=0?!0:void 0,maxAnisotropy:16,uintIndices:!0,fragmentDepthSupported:!0,highPrecisionShaderSupported:!0,colorBufferFloat:!0,blendFloat:this._deviceEnabledExtensions.indexOf("float32-blendable")>=0,supportFloatTexturesResolve:!1,rg11b10ufColorRenderable:this._deviceEnabledExtensions.indexOf("rg11b10ufloat-renderable")>=0,textureFloat:!0,textureFloatLinearFiltering:this._deviceEnabledExtensions.indexOf("float32-filterable")>=0,textureFloatRender:!0,textureHalfFloat:!0,textureHalfFloatLinearFiltering:!0,textureHalfFloatRender:!0,textureLOD:!0,texelFetch:!0,drawBuffersExtension:!0,depthTextureExtension:!0,vertexArrayObject:!1,instancedArrays:!0,timerQuery:typeof BigUint64Array<"u"&&this._deviceEnabledExtensions.indexOf("timestamp-query")!==-1?!0:void 0,supportOcclusionQuery:typeof BigUint64Array<"u",canUseTimestampForTimerQuery:!0,multiview:!1,oculusMultiview:!1,parallelShaderCompile:void 0,blendMinMax:!0,maxMSAASamples:4,canUseGLInstanceID:!0,canUseGLVertexID:!0,supportComputeShaders:!0,supportSRGBBuffers:!0,supportTransformFeedbacks:!1,textureMaxLevel:!0,texture2DArrayMaxLayerCount:this._deviceLimits.maxTextureArrayLayers,disableMorphTargetTexture:!1,textureNorm16:e,blendParametersPerTarget:!0,dualSourceBlending:!0},this._features={forceBitmapOverHTMLImageElement:!0,supportRenderAndCopyToLodForFloatTextures:!0,supportDepthStencilTexture:!0,supportShadowSamplers:!0,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:!0,trackUbosInFrame:!0,checkUbosContentBeforeUpload:!0,supportCSM:!0,basisNeedsPOT:!1,support3DTextures:!0,needTypeSuffixInShaderConstants:!0,supportMSAA:!0,supportSSAO2:!0,supportIBLShadows:!0,supportExtendedTextureFormats:!0,supportSwitchCaseInShader:!0,supportSyncTextureRead:!1,needsInvertingBitmap:!1,useUBOBindingCache:!1,needShaderCodeInlining:!0,needToAlwaysBindUniformBuffers:!0,supportRenderPasses:!0,supportSpriteInstancing:!0,forceVertexBufferStrideAndOffsetMultiple4Bytes:!0,_checkNonFloatVertexBuffersDontRecreatePipelineContext:!0,_collectUbosUpdatedInFrame:!1},this._alphaState=new go(this._caps.blendParametersPerTarget)}_initializeContextAndSwapChain(){if(!this._renderingCanvas)throw"The rendering canvas has not been set!";this._context=this._renderingCanvas.getContext("webgpu"),this._configureContext(),this._colorFormat=this._options.swapChainFormat,this._mainRenderPassWrapper.colorAttachmentGPUTextures=[new al(this)],this._mainRenderPassWrapper.colorAttachmentGPUTextures[0].format=this._colorFormat,this._setColorFormat(this._mainRenderPassWrapper)}_initializeMainAttachments(){if(!this._bufferManager)return;this.flushFramebuffer(),this._mainTextureExtends={width:this.getRenderWidth(!0),height:this.getRenderHeight(!0),depthOrArrayLayers:1};let e=new Float32Array([this.getRenderHeight(!0)]);this._bufferManager.setSubData(this._ubInvertY,4,e),this._bufferManager.setSubData(this._ubDontInvertY,4,e);let t;if(this._options.antialias){let n={label:`Texture_MainColor_${this._mainTextureExtends.width}x${this._mainTextureExtends.height}_antialiasing`,size:this._mainTextureExtends,mipLevelCount:1,sampleCount:this._mainPassSampleCount,dimension:"2d",format:this._options.swapChainFormat,usage:16};this._mainTexture&&this._textureHelper.releaseTexture(this._mainTexture),this._mainTexture=this._device.createTexture(n),t=[{view:this._mainTexture.createView({label:"TextureView_MainColor_antialiasing",dimension:"2d",format:this._options.swapChainFormat,mipLevelCount:1,arrayLayerCount:1}),clearValue:new me(0,0,0,1),loadOp:"clear",storeOp:"store"}]}else t=[{view:void 0,clearValue:new me(0,0,0,1),loadOp:"clear",storeOp:"store"}];this._mainRenderPassWrapper.depthTextureFormat=this.isStencilEnable?"depth24plus-stencil8":"depth32float",this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper);let i={label:`Texture_MainDepthStencil_${this._mainTextureExtends.width}x${this._mainTextureExtends.height}`,size:this._mainTextureExtends,mipLevelCount:1,sampleCount:this._mainPassSampleCount,dimension:"2d",format:this._mainRenderPassWrapper.depthTextureFormat,usage:16};this._depthTexture&&this._textureHelper.releaseTexture(this._depthTexture),this._depthTexture=this._device.createTexture(i);let r={view:this._depthTexture.createView({label:`TextureView_MainDepthStencil_${this._mainTextureExtends.width}x${this._mainTextureExtends.height}`,dimension:"2d",format:this._depthTexture.format,mipLevelCount:1,arrayLayerCount:1}),depthClearValue:this._clearDepthValue,depthLoadOp:"clear",depthStoreOp:"store",stencilClearValue:this._clearStencilValue,stencilLoadOp:this.isStencilEnable?"clear":void 0,stencilStoreOp:this.isStencilEnable?"store":void 0};this._mainRenderPassWrapper.renderPassDescriptor={label:"MainRenderPass",colorAttachments:t,depthStencilAttachment:r},this.beginFrame(),this._startMainRenderPass(!0,null,!0,!1),this._endCurrentRenderPass(),this.endFrame(),this._frameId--}_sharedInit(e){super._sharedInit(e),tm(this,e,this._creationOptions)}_configureContext(){this._context.configure({device:this._device,format:this._options.swapChainFormat,usage:17,alphaMode:this.premultipliedAlpha?"premultiplied":"opaque"})}resizeImageBitmap(e,t,i){return nm(this,e,t,i)}async _createImageBitmapFromSource(e,t){return await sm(this,e,t)}switchFullscreen(e){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(e)}enterFullscreen(e){this.isFullscreen||(this._pointerLockRequested=e,this._renderingCanvas&&am(this._renderingCanvas))}exitFullscreen(){this.isFullscreen&&om()}enterPointerlock(){this._renderingCanvas&&Gh(this._renderingCanvas)}exitPointerlock(){lm()}_rebuildBuffers(){super._rebuildBuffers();for(let e of this._storageBuffers)e.getBuffer().engineId!==this.uniqueId&&e._rebuild()}_restoreEngineAfterContextLost(e){ol.ResetCache(),ms.ResetCache();let t=r=>{for(let n of r){for(let a of n.meshes){let o=a.subMeshes;if(o)for(let l of o)l._drawWrappers=[]}for(let a of n.materials)a._materialContext?.reset()}};t(this.scenes),t(this._virtualScenes);let i=[];for(let r of this._uniformBuffers)r.name.indexOf("leftOver")<0&&i.push(r);this._uniformBuffers=i,super._restoreEngineAfterContextLost(e)}setSize(e,t,i=!1){return super.setSize(e,t,i)?(this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&P.Log(["frame #"+this._count+" - setSize -",e,t])),this._initializeMainAttachments(),this.snapshotRendering&&this.snapshotRenderingReset(),!0):!1}_getShaderProcessor(e){return e===1?this._shaderProcessorWGSL:this._shaderProcessor}_getShaderProcessingContext(e,t){return new wr(e,t)}_getCurrentRenderPass(){return this._currentRenderTarget&&!this._currentRenderPass?this._startRenderTargetRenderPass(this._currentRenderTarget,!1,null,!1,!1):this._currentRenderPass||this._startMainRenderPass(!1),this._currentRenderPass}_getCurrentRenderPassWrapper(){return this._currentRenderTarget?this._rttRenderPassWrapper:this._mainRenderPassWrapper}applyStates(){this._stencilStateComposer.apply(),this._cacheRenderPipeline.setAlphaBlendEnabled(this._alphaState._alphaBlend,this._alphaState._numTargetEnabled)}wipeCaches(e){this.preventCacheWipeBetweenFrames&&!e||(this._forceEnableEffect=!0,this._currentIndexBuffer=null,this._currentOverrideVertexBuffers=null,this._cacheRenderPipeline.setBuffers(null,null,null),e&&(this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=515,this._alphaState.reset(),this._resetAlphaMode(),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters),this._cacheRenderPipeline.setAlphaBlendEnabled(this._alphaState._alphaBlend,this._alphaState._numTargetEnabled),this.setColorWrite(!0)),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null)}setColorWrite(e){this._colorWriteLocal=e,this._cacheRenderPipeline.setWriteMask(e?15:0)}getColorWrite(){return this._colorWriteLocal}_mustUpdateViewport(){let e=this._viewportCached.x,t=this._viewportCached.y,i=this._viewportCached.z,r=this._viewportCached.w,n=this._viewportsCurrent.x!==e||this._viewportsCurrent.y!==t||this._viewportsCurrent.w!==i||this._viewportsCurrent.h!==r;return n&&(this._viewportsCurrent.x=this._viewportCached.x,this._viewportsCurrent.y=this._viewportCached.y,this._viewportsCurrent.w=this._viewportCached.z,this._viewportsCurrent.h=this._viewportCached.w),n}_applyViewport(e){let t=Math.floor(this._viewportCached.x),i=Math.floor(this._viewportCached.z),r=Math.floor(this._viewportCached.w),n=Math.floor(this._viewportCached.y);this._currentRenderTarget||(n=this.getRenderHeight(!0)-n-r),e?e.addItem(new Yx(t,n,i,r)):this._getCurrentRenderPass().setViewport(t,n,i,r,0,1),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&P.Log(["frame #"+this._count+" - viewport applied - (",this._viewportCached.x,this._viewportCached.y,this._viewportCached.z,this._viewportCached.w,") current pass is main pass="+this._currentPassIsMainPass()]))}_viewport(e,t,i,r){this._viewportCached.x=e,this._viewportCached.y=t,this._viewportCached.z=i,this._viewportCached.w=r}_mustUpdateScissor(){let e=this._scissorCached.x,t=this._scissorCached.y,i=this._scissorCached.z,r=this._scissorCached.w,n=this._scissorsCurrent.x!==e||this._scissorsCurrent.y!==t||this._scissorsCurrent.w!==i||this._scissorsCurrent.h!==r;return n&&(this._scissorsCurrent.x=this._scissorCached.x,this._scissorsCurrent.y=this._scissorCached.y,this._scissorsCurrent.w=this._scissorCached.z,this._scissorsCurrent.h=this._scissorCached.w),n}_applyScissor(e){let t=this._currentRenderTarget?this._scissorCached.y:this.getRenderHeight()-this._scissorCached.w-this._scissorCached.y;e?e.addItem(new Kx(this._scissorCached.x,t,this._scissorCached.z,this._scissorCached.w)):this._getCurrentRenderPass().setScissorRect(this._scissorCached.x,t,this._scissorCached.z,this._scissorCached.w),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&P.Log(["frame #"+this._count+" - scissor applied - (",this._scissorCached.x,this._scissorCached.y,this._scissorCached.z,this._scissorCached.w,") current pass is main pass="+this._currentPassIsMainPass()]))}_scissorIsActive(){return this._scissorCached.x!==0||this._scissorCached.y!==0||this._scissorCached.z!==0||this._scissorCached.w!==0}enableScissor(e,t,i,r){this._scissorCached.x=e,this._scissorCached.y=t,this._scissorCached.z=i,this._scissorCached.w=r}disableScissor(){this._scissorCached.x=this._scissorCached.y=this._scissorCached.z=this._scissorCached.w=0,this._scissorsCurrent.x=this._scissorsCurrent.y=this._scissorsCurrent.w=this._scissorsCurrent.h=0}_mustUpdateStencilRef(){let e=this._stencilStateComposer.funcRef!==this._stencilRefsCurrent;return e&&(this._stencilRefsCurrent=this._stencilStateComposer.funcRef),e}_applyStencilRef(e){e?e.addItem(new Fd(this._stencilStateComposer.funcRef??0)):this._getCurrentRenderPass().setStencilReference(this._stencilStateComposer.funcRef??0)}_mustUpdateBlendColor(){let e=this._alphaState._blendConstants,t=e[0]!==this._blendColorsCurrent[0]||e[1]!==this._blendColorsCurrent[1]||e[2]!==this._blendColorsCurrent[2]||e[3]!==this._blendColorsCurrent[3];return t&&(this._blendColorsCurrent[0]=e[0],this._blendColorsCurrent[1]=e[1],this._blendColorsCurrent[2]=e[2],this._blendColorsCurrent[3]=e[3]),t}_applyBlendColor(e){e?e.addItem(new qx(this._alphaState._blendConstants.slice())):this._getCurrentRenderPass().setBlendConstant(this._alphaState._blendConstants)}_resetRenderPassStates(){this._viewportsCurrent.x=this._viewportsCurrent.y=this._viewportsCurrent.w=this._viewportsCurrent.h=0,this._scissorsCurrent.x=this._scissorsCurrent.y=this._scissorsCurrent.w=this._scissorsCurrent.h=0,this._stencilRefsCurrent=-1,this._blendColorsCurrent[0]=this._blendColorsCurrent[1]=this._blendColorsCurrent[2]=this._blendColorsCurrent[3]=null}clear(e,t,i,r=!1,n=0){e&&e.a===void 0&&(e.a=1),r&&(this._clearStencilValue=n);let a=this._scissorIsActive();this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&P.Log(["frame #"+this._count+" - clear - backBuffer=",t," depth=",i," stencil=",r," scissor is active=",a])),this._currentRenderTarget?a?(this._currentRenderPass||this._startRenderTargetRenderPass(this._currentRenderTarget,!1,t?e:null,i,r),this._applyScissor(this.compatibilityMode?null:this._bundleList),this._clearFullQuad(t?e:null,i,r)):(this._currentRenderPass&&this._endCurrentRenderPass(),this._startRenderTargetRenderPass(this._currentRenderTarget,!0,t?e:null,i,r)):((!this._currentRenderPass||!a)&&this._startMainRenderPass(!a,t?e:null,i,r),a&&(this._applyScissor(this.compatibilityMode?null:this._bundleList),this._clearFullQuad(t?e:null,i,r)))}_clearFullQuad(e,t,i){let r=this.compatibilityMode?this._getCurrentRenderPass():null;this._clearQuad.setColorFormat(this._colorFormat),this._clearQuad.setDepthStencilFormat(this._depthTextureFormat),this._clearQuad.setMRTAttachments(this._cacheRenderPipeline.mrtAttachments??[],this._cacheRenderPipeline.mrtTextureArray??[],this._cacheRenderPipeline.mrtTextureCount),this.compatibilityMode?r.setStencilReference(this._clearStencilValue):this._bundleList.addItem(new Fd(this._clearStencilValue));let n=this._clearQuad.clear(r,e,t,i,this.currentSampleCount);this.compatibilityMode?this._applyStencilRef(null):(this._bundleList.addBundle(n),this._applyStencilRef(this._bundleList),this._reportDrawCall())}createVertexBuffer(e,t,i){let r;return e instanceof Array?r=new Float32Array(e):e instanceof ArrayBuffer?r=new Uint8Array(e):r=e,this._bufferManager.createBuffer(r,rt.Vertex|rt.CopyDst|rt.Storage,i)}createDynamicVertexBuffer(e,t){return this.createVertexBuffer(e,void 0,t)}createIndexBuffer(e,t,i){let r=!0,n;if(e instanceof Uint32Array||e instanceof Int32Array)n=e;else if(e instanceof Uint16Array)n=e,r=!1;else{for(let o=0;o<e.length;o++)if(e[o]>65535){n=new Uint32Array(e);break}n||(n=new Uint16Array(e),r=!1)}let a=this._bufferManager.createBuffer(n,rt.Index|rt.CopyDst|rt.Storage,i);return a.is32Bits=r,a}updateDynamicIndexBuffer(e,t,i=0){let r=e,n;e.is32Bits?n=t instanceof Uint32Array?t:new Uint32Array(t):n=t instanceof Uint16Array?t:new Uint16Array(t),this._bufferManager.setSubData(r,i,n)}updateDynamicVertexBuffer(e,t,i,r){let n=e;i===void 0&&(i=0);let a;r===void 0?(t instanceof Array?a=new Float32Array(t):t instanceof ArrayBuffer?a=new Uint8Array(t):a=t,r=a.byteLength):t instanceof Array?a=new Float32Array(t):t instanceof ArrayBuffer?a=new Uint8Array(t):a=t,this._bufferManager.setSubData(n,i,a,0,r)}_createBuffer(e,t,i){let r;e instanceof Array?r=new Float32Array(e):e instanceof ArrayBuffer?r=new Uint8Array(e):r=e;let n=0;return t&1&&(n|=rt.CopySrc),t&2&&(n|=rt.CopyDst),t&4&&(n|=rt.Uniform),t&8&&(n|=rt.Vertex),t&16&&(n|=rt.Index),t&32&&(n|=rt.Storage),t&64&&(n|=rt.Indirect),this._bufferManager.createBuffer(r,n,i)}bindBuffersDirectly(){throw"Not implemented on WebGPU"}updateAndBindInstancesBuffer(){throw"Not implemented on WebGPU"}unbindInstanceAttributes(){}bindBuffers(e,t,i,r){this._currentVertexBuffers=e,this._currentIndexBuffer=t,this._currentOverrideVertexBuffers=r??null,this._cacheRenderPipeline.setBuffers(this._currentVertexBuffers,this._currentIndexBuffer,this._currentOverrideVertexBuffers)}_releaseBuffer(e){return this._bufferManager.releaseBuffer(e)}createUniformBuffer(e,t){let i;return e instanceof Array?i=new Float32Array(e):i=e,this._bufferManager.createBuffer(i,rt.Uniform|rt.CopyDst,t)}createDynamicUniformBuffer(e,t){return this.createUniformBuffer(e,t)}updateUniformBuffer(e,t,i,r){i===void 0&&(i=0);let n=e,a;r===void 0?(t instanceof Float32Array?a=t:a=new Float32Array(t),r=a.byteLength):t instanceof Float32Array?a=t:a=new Float32Array(t),this._bufferManager.setSubData(n,i,a,0,r)}bindUniformBufferBase(e,t,i){this._currentDrawContext.setBuffer(i,e)}bindUniformBlock(){}createEffect(e,t,i,r,n,a,o,l,c,f=0,h){let u=typeof e=="string"?e:e.vertexToken||e.vertexSource||e.vertexElement||e.vertex,d=typeof e=="string"?e:e.fragmentToken||e.fragmentSource||e.fragmentElement||e.fragment,p=this._getGlobalDefines(),m=t.attributes!==void 0,_=n??t.defines??"";p&&(_+=`
`+p);let v=u+"+"+d+"@"+_;if(this._compiledEffects[v]){let C=this._compiledEffects[v];return o&&C.isReady()&&o(C),C._refCount++,C}let T=new li(e,t,m?this:i,r,this,n,a,o,l,c,v,t.shaderLanguage??f,t.extraInitializationsAsync??h);return this._compiledEffects[v]=T,T}_compileRawShaderToSpirV(e,t){return this._glslang.compileGLSL(e,t)}_compileShaderToSpirV(e,t,i,r){return this._compileRawShaderToSpirV(r+(i?i+`
`:"")+e,t)}_getWGSLShader(e,t,i){return i?i="//"+i.split(`
`).join(`
//`)+`
`:i="",i+e}_createPipelineStageDescriptor(e,t,i,r,n){return this._tintWASM&&i===0&&(e=this._tintWASM.convertSpirV2WGSL(e,r),t=this._tintWASM.convertSpirV2WGSL(t,n)),{vertexStage:{module:this._device.createShaderModule({label:"vertex",code:e}),entryPoint:"main"},fragmentStage:{module:this._device.createShaderModule({label:"fragment",code:t}),entryPoint:"main"}}}_compileRawPipelineStageDescriptor(e,t,i){let r=e.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS")>=0,n=t.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS")>=0,a=i===0?this._compileRawShaderToSpirV(e,"vertex"):e,o=i===0?this._compileRawShaderToSpirV(t,"fragment"):t;return this._createPipelineStageDescriptor(a,o,i,r,n)}_compilePipelineStageDescriptor(e,t,i,r){this.onBeforeShaderCompilationObservable.notifyObservers(this);let n=e.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS")>=0,a=t.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS")>=0,o=`#version 450
`,l=r===0?this._compileShaderToSpirV(e,"vertex",i,o):this._getWGSLShader(e,"vertex",i),c=r===0?this._compileShaderToSpirV(t,"fragment",i,o):this._getWGSLShader(t,"fragment",i),f=this._createPipelineStageDescriptor(l,c,r,n,a);return this.onAfterShaderCompilationObservable.notifyObservers(this),f}createRawShaderProgram(){throw"Not available on WebGPU"}createShaderProgram(){throw"Not available on WebGPU"}inlineShaderCode(e){let t=new Nd(e);return t.debug=!1,t.processCode(),t.code}createPipelineContext(e){return new Lx(e,this)}createMaterialContext(){return new Ld}createDrawContext(){return new wd(this._bufferManager,this._dummyIndexBuffer)}async _preparePipelineContextAsync(e,t,i,r,n,a,o,l,c,f,h){let u=e,d=u.shaderProcessingContext.shaderLanguage;d===0&&!this._glslangAndTintAreFullyLoaded&&await this.prepareGlslangAndTintAsync(),this.dbgShowShaderCode&&(P.Log(["defines",l]),P.Log(t),P.Log(i),P.Log("***********************************************")),u.sources={fragment:i,vertex:t,rawVertex:n,rawFragment:a},r?u.stages=this._compileRawPipelineStageDescriptor(t,i,d):u.stages=this._compilePipelineStageDescriptor(t,i,l,d),h()}getAttributes(e,t){let i=new Array(t.length),r=e;for(let n=0;n<t.length;n++){let a=t[n],o=r.shaderProcessingContext.availableAttributes[a];o!==void 0&&(i[n]=o)}return i}enableEffect(e){if(e){if(!Bc(e))this._currentEffect=e,this._currentMaterialContext=this._defaultMaterialContext,this._currentDrawContext=this._defaultDrawContext,this._counters.numEnableEffects++,this.dbgLogIfNotDrawWrapper&&P.Warn(`enableEffect has been called with an Effect and not a Wrapper! effect.uniqueId=${e.uniqueId}, effect.name=${e.name}, effect.name.vertex=${typeof e.name=="string"?"":e.name.vertex}, effect.name.fragment=${typeof e.name=="string"?"":e.name.fragment}`,10);else if(!e.effect||e.effect===this._currentEffect&&e.materialContext===this._currentMaterialContext&&e.drawContext===this._currentDrawContext&&!this._forceEnableEffect){if(!e.effect&&this.dbgShowEmptyEnableEffectCalls)throw P.Log(["drawWrapper=",e]),"Invalid call to enableEffect: the effect property is empty!";return}else if(this._currentEffect=e.effect,this._currentMaterialContext=e.materialContext,this._currentDrawContext=e.drawContext,this._counters.numEnableDrawWrapper++,!this._currentMaterialContext)throw P.Log(["drawWrapper=",e]),"Invalid call to enableEffect: the materialContext property is empty!";this._stencilStateComposer.stencilMaterial=void 0,this._forceEnableEffect=!1,this._currentEffect.onBind&&this._currentEffect.onBind(this._currentEffect),this._currentEffect._onBindObservable&&this._currentEffect._onBindObservable.notifyObservers(this._currentEffect)}}_releaseEffect(e){this._compiledEffects[e._key]&&(delete this._compiledEffects[e._key],this._deletePipelineContext(e.getPipelineContext()))}releaseEffects(){for(let e in this._compiledEffects){let t=this._compiledEffects[e].getPipelineContext();this._deletePipelineContext(t)}this._compiledEffects={},this.onReleaseEffectsObservable.notifyObservers(this)}_deletePipelineContext(e){let t=e;t&&Dc(t)}get needPOTTextures(){return!1}_createHardwareTexture(){return new al(this)}_releaseTexture(e){let t=this._internalTexturesCache.indexOf(e);t!==-1&&this._internalTexturesCache.splice(t,1),this._textureHelper.releaseTexture(e)}_getRGBABufferInternalSizedFormat(){return 5}updateTextureComparisonFunction(e,t){e._comparisonFunction=t}_createInternalTexture(e,t,i=!0,r=0){let n={};t!==void 0&&typeof t=="object"?(n.generateMipMaps=t.generateMipMaps,n.createMipMaps=t.createMipMaps,n.type=t.type===void 0?0:t.type,n.samplingMode=t.samplingMode===void 0?3:t.samplingMode,n.format=t.format===void 0?5:t.format,n.samples=t.samples??1,n.creationFlags=t.creationFlags??0,n.useSRGBBuffer=t.useSRGBBuffer??!1,n.label=t.label):(n.generateMipMaps=t,n.type=0,n.samplingMode=3,n.format=5,n.samples=1,n.creationFlags=0,n.useSRGBBuffer=!1),(n.type===1&&!this._caps.textureFloatLinearFiltering||n.type===2&&!this._caps.textureHalfFloatLinearFiltering)&&(n.samplingMode=1),n.type===1&&!this._caps.textureFloat&&(n.type=0,P.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));let a=new Je(this,r),o=e.width??e,l=e.height??e,c=e.depth??0,f=e.layers??0;if(a.baseWidth=o,a.baseHeight=l,a.width=o,a.height=l,a.depth=c||f,a.isReady=!0,a.samples=n.samples,a.generateMipMaps=!!n.generateMipMaps,a.samplingMode=n.samplingMode,a.type=n.type,a.format=n.format,a.is2DArray=f>0,a.is3D=c>0,a._cachedWrapU=0,a._cachedWrapV=0,a._useSRGBBuffer=n.useSRGBBuffer,a.label=n.label,this._internalTexturesCache.push(a),!i){let h=!n.generateMipMaps&&n.createMipMaps;h&&(a.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(a,o,l,f||1,n.creationFlags),h&&(a.generateMipMaps=!1)}return a}createTexture(e,t,i,r,n=3,a=null,o=null,l=null,c=null,f=null,h=null,u,d,p,m){return this._createTextureBase(e,t,i,r,n,a,o,(_,v,T,C,I,R,b,M)=>{let F=C;if(_.baseWidth=F.width,_.baseHeight=F.height,_.width=F.width,_.height=F.height,_.format=_.format!==-1?_.format:f??5,_.type=_.type!==-1?_.type:0,_._creationFlags=p??0,M(_.width,_.height,F,v,_,()=>{}),_._hardwareTexture?.underlyingResource)!R&&!b&&this._generateMipmaps(_,this._uploadEncoder);else{let U=this._textureHelper.createGPUTextureForInternalTexture(_,F.width,F.height,void 0,p);tt.IsImageBitmap(F)&&(this._textureHelper.updateTexture(F,_,F.width,F.height,_.depth,U.format,0,0,I,!1,0,0),!R&&!b&&this._generateMipmaps(_,this._uploadEncoder))}T&&T.removePendingData(_),_.isReady=!0,_.onLoadedObservable.notifyObservers(_),_.onLoadedObservable.clear()},()=>!1,l,c,f,h,u,d,m)}wrapWebGPUTexture(e){let t=new al(this,e),i=new Je(this,0,!0);return i._hardwareTexture=t,i.isReady=!0,i}wrapWebGLTexture(){throw new Error("wrapWebGLTexture is not supported, use wrapWebGPUTexture instead.")}_getUseSRGBBuffer(e,t){return e&&this._caps.supportSRGBBuffers}_unpackFlipY(e){}updateTextureSamplingMode(e,t,i=!1){i&&(t.generateMipMaps=!0,this._generateMipmaps(t)),t.samplingMode=e}updateTextureWrappingMode(e,t,i=null,r=null){t!==null&&(e._cachedWrapU=t),i!==null&&(e._cachedWrapV=i),(e.is2DArray||e.is3D)&&r!==null&&(e._cachedWrapR=r)}updateTextureDimensions(e,t,i,r=1){if(!e._hardwareTexture||e.width===t&&e.height===i&&e.depth===r)return;let n=e._hardwareTexture.textureAdditionalUsages;e._hardwareTexture.release(),this._textureHelper.createGPUTextureForInternalTexture(e,t,i,r,n)}_setInternalTexture(e,t,i){if(i=i??e,this._currentEffect){let n=this._currentEffect._pipelineContext.shaderProcessingContext.availableTextures[i];if(this._currentMaterialContext.setTexture(e,t),n&&n.autoBindSampler){let a=i+"Sampler";this._currentMaterialContext.setSampler(a,t)}}}createPrefilteredCubeTexture(e,t,i,r,n=null,a=null,o,l=null,c=!0){let f=h=>{if(!h){n&&n(null);return}let u=h.texture;c?h.info.sphericalPolynomial&&(u._sphericalPolynomial=h.info.sphericalPolynomial):u._sphericalPolynomial=new Ur,u._source=9,n&&n(u)};return this.createCubeTexture(e,t,null,!1,f,a,o,l,c,i,r)}setTexture(e,t,i,r){this._setTexture(e,i,!1,!1,r,r)}setTextureArray(e,t,i,r){for(let n=0;n<i.length;n++)this._setTexture(-1,i[n],!0,!1,r+n.toString(),r)}_setTexture(e,t,i=!1,r=!1,n="",a){if(a=a??n,this._currentEffect){if(!t)return this._currentMaterialContext.setTexture(n,null),!1;if(t.video)t.update();else if(t.delayLoadState===4)return t.delayLoad(),!1;let o=null;if(r?o=t.depthStencilTexture:t.isReady()?o=t.getInternalTexture():t.isCube?o=this.emptyCubeTexture:t.is3D?o=this.emptyTexture3D:t.is2DArray?o=this.emptyTexture2DArray:o=this.emptyTexture,o&&!o.isMultiview){if(o.isCube&&o._cachedCoordinatesMode!==t.coordinatesMode){o._cachedCoordinatesMode=t.coordinatesMode;let l=t.coordinatesMode!==3&&t.coordinatesMode!==5?1:0;t.wrapU=l,t.wrapV=l}o._cachedWrapU=t.wrapU,o._cachedWrapV=t.wrapV,o.is3D&&(o._cachedWrapR=t.wrapR),this._setAnisotropicLevel(0,o,t.anisotropicFilteringLevel)}this._setInternalTexture(n,o,a)}else this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&P.Log(["frame #"+this._count+" - _setTexture called with a null _currentEffect! texture=",t]));return!0}_setAnisotropicLevel(e,t,i){t._cachedAnisotropicFilteringLevel!==i&&(t._cachedAnisotropicFilteringLevel=Math.min(i,this._caps.maxAnisotropy))}_bindTexture(e,t,i){e!==void 0&&this._setInternalTexture(i,t)}generateMipmaps(e){this._generateMipmaps(e)}updateTextureData(e,t,i,r,n,a,o=0,l=0,c=!1){let f=e._hardwareTexture;e._hardwareTexture?.underlyingResource||(f=this._textureHelper.createGPUTextureForInternalTexture(e));let h=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(h,e,n,a,e.depth,f.format,o,l,e.invertY,!1,i,r),c&&this._generateMipmaps(e)}_uploadCompressedDataToTextureDirectly(e,t,i,r,n,a=0,o=0){let l=e._hardwareTexture;e._hardwareTexture?.underlyingResource||(e.format=t,l=this._textureHelper.createGPUTextureForInternalTexture(e,i,r));let c=new Uint8Array(n.buffer,n.byteOffset,n.byteLength);this._textureHelper.updateTexture(c,e,i,r,e.depth,l.format,a,o,!1,!1,0,0)}_uploadDataToTextureDirectly(e,t,i=0,r=0,n,a=!1){let o=Math.round(Math.log(e.width)*Math.LOG2E),l=Math.round(Math.log(e.height)*Math.LOG2E),c=a?e.width:Math.pow(2,Math.max(o-r,0)),f=a?e.height:Math.pow(2,Math.max(l-r,0)),h=e._hardwareTexture;e._hardwareTexture?.underlyingResource||(h=this._textureHelper.createGPUTextureForInternalTexture(e,c,f));let u=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(u,e,c,f,e.depth,h.format,i,r,e.invertY,!1,0,0)}_uploadArrayBufferViewToTexture(e,t,i=0,r=0){this._uploadDataToTextureDirectly(e,t,i,r)}_uploadImageToTexture(e,t,i=0,r=0){let n=e._hardwareTexture;if(e._hardwareTexture?.underlyingResource||(n=this._textureHelper.createGPUTextureForInternalTexture(e)),t instanceof HTMLImageElement)throw"WebGPU engine: HTMLImageElement not supported in _uploadImageToTexture!";let a=t,o=Math.ceil(e.width/(1<<r)),l=Math.ceil(e.height/(1<<r));this._textureHelper.updateTexture(a,e,o,l,e.depth,n.format,i,r,e.invertY,!1,0,0)}readPixels(e,t,i,r,n=!0,a=!0,o=null){let c=this._getCurrentRenderPassWrapper().colorAttachmentGPUTextures[0];if(!c)return Promise.resolve(new Uint8Array(0));let f=c.underlyingResource,h=c.format;return f?(a&&this.flushFramebuffer(),this._textureHelper.readPixels(f,e,t,i,r,h,void 0,void 0,o)):Promise.resolve(new Uint8Array(0))}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}get performanceMonitor(){return this._performanceMonitor}beginFrame(){this._measureFps(),super.beginFrame()}endFrame(){if(this._endCurrentRenderPass(),this._snapshotRendering.endFrame(),this._timestampQuery.endFrame(this._renderEncoder),this._timestampIndex=0,this.flushFramebuffer(),this._textureHelper.destroyDeferredTextures(),this._bufferManager.destroyDeferredBuffers(),this._features._collectUbosUpdatedInFrame){if(this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),!this._count||this._count<this.dbgVerboseLogsNumFrames)){let e=[];for(let t in ii._UpdatedUbosInFrame)e.push(t+":"+ii._UpdatedUbosInFrame[t]);P.Log(["frame #"+this._count+" - updated ubos -",e.join(", ")])}ii._UpdatedUbosInFrame={}}this.countersLastFrame.numEnableEffects=this._counters.numEnableEffects,this.countersLastFrame.numEnableDrawWrapper=this._counters.numEnableDrawWrapper,this.countersLastFrame.numBundleCreationNonCompatMode=this._counters.numBundleCreationNonCompatMode,this.countersLastFrame.numBundleReuseNonCompatMode=this._counters.numBundleReuseNonCompatMode,this._counters.numEnableEffects=0,this._counters.numEnableDrawWrapper=0,this._counters.numBundleCreationNonCompatMode=0,this._counters.numBundleReuseNonCompatMode=0,this._cacheRenderPipeline.endFrame(),this._cacheBindGroups.endFrame(),this._pendingDebugCommands.length=0,this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),this._count<this.dbgVerboseLogsNumFrames&&P.Log(["%c frame #"+this._count+" - end","background: #ffff00"]),this._count<this.dbgVerboseLogsNumFrames&&(this._count++,this._count!==this.dbgVerboseLogsNumFrames&&P.Log(["%c frame #"+this._count+" - begin","background: #ffff00"]))),super.endFrame()}extractDriverInfo(){return""}flushFramebuffer(){this._endCurrentRenderPass(),this._commandBuffers[0]=this._uploadEncoder.finish(),this._commandBuffers[1]=this._renderEncoder.finish(),this._device.queue.submit(this._commandBuffers),this._uploadEncoder=this._device.createCommandEncoder(this._uploadEncoderDescriptor),this._renderEncoder=this._device.createCommandEncoder(this._renderEncoderDescriptor),this._timestampQuery.startFrame(this._uploadEncoder),this._textureHelper.setCommandEncoder(this._uploadEncoder),this._bundleList.reset()}_currentFrameBufferIsDefaultFrameBuffer(){return this._currentPassIsMainPass()}_startRenderTargetRenderPass(e,t,i,r,n){this._endCurrentRenderPass();let a=e,o=a._depthStencilTexture,l=o?._hardwareTexture,c=l?.underlyingResource,f=l?.getMSAATexture(0),h=c?.createView(this._rttRenderPassWrapper.depthAttachmentViewDescriptor),u=f?.createView(this._rttRenderPassWrapper.depthAttachmentViewDescriptor),d=l?tt.HasStencilAspect(l.format):!1,p=[];this.useReverseDepthBuffer&&this.setDepthFunctionToGreaterOrEqual();let m=Jre;i&&(m.r=i.r*255,m.g=i.g*255,m.b=i.b*255,m.a=i.a*255);let _=t&&i,v=t&&r,T=t&&n;if(a._attachments&&a.isMulti){(!this._mrtAttachments||this._mrtAttachments.length===0)&&(this._mrtAttachments=a._defaultAttachments);for(let C=0;C<this._mrtAttachments.length;++C){let I=this._mrtAttachments[C],R=a.textures[C],b=R?._hardwareTexture,M=b?.underlyingResource;if(b&&M){let F=a.getBaseArrayLayer(C),U=b.getMSAATexture(F),D={...this._rttRenderPassWrapper.colorAttachmentViewDescriptor,dimension:R.is3D?"3d":"2d",format:b.format,baseArrayLayer:F},$={...this._rttRenderPassWrapper.colorAttachmentViewDescriptor,dimension:R.is3D?"3d":"2d",format:b.format,baseArrayLayer:0},oe=R.type===7||R.type===5,re=M.createView(D),se=U?.createView($);p.push({view:se||re,resolveTarget:U?re:void 0,depthSlice:R.is3D?a.layerIndices?.[C]??0:void 0,clearValue:I!==0&&_?oe?m:i:void 0,loadOp:I!==0&&_?"clear":"load",storeOp:"store"})}}this._cacheRenderPipeline.setMRT(a.textures,this._mrtAttachments.length),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments)}else{let C=a.texture;if(C){let I=C._hardwareTexture,R=I.underlyingResource,b;a.is3D&&(b=this._rttRenderPassWrapper.colorAttachmentViewDescriptor.baseArrayLayer,this._rttRenderPassWrapper.colorAttachmentViewDescriptor.baseArrayLayer=0);let M=I.getMSAATexture(0),F=R.createView(this._rttRenderPassWrapper.colorAttachmentViewDescriptor),U=M?.createView(this._rttRenderPassWrapper.colorAttachmentViewDescriptor),D=C.type===7||C.type===5;p.push({view:U||F,resolveTarget:M?F:void 0,depthSlice:b,clearValue:_?D?m:i:void 0,loadOp:_?"clear":"load",storeOp:"store"})}else p.push(null)}if(this._debugPushGroup?.("render target pass"+(e.label?" ("+e.label+")":""),0),this._rttRenderPassWrapper.renderPassDescriptor={label:(e.label??"RTT")+" - RenderPass",colorAttachments:p,depthStencilAttachment:o&&c?{view:u||h,depthClearValue:v?this.useReverseDepthBuffer?this._clearReverseDepthValue:this._clearDepthValue:void 0,depthLoadOp:a.depthReadOnly?void 0:v?"clear":"load",depthStoreOp:a.depthReadOnly?void 0:"store",depthReadOnly:a.depthReadOnly,stencilClearValue:a._depthStencilTextureWithStencil&&T?this._clearStencilValue:void 0,stencilLoadOp:a.stencilReadOnly?void 0:d?a._depthStencilTextureWithStencil&&T?"clear":"load":void 0,stencilStoreOp:a.stencilReadOnly?void 0:d?"store":void 0,stencilReadOnly:a.stencilReadOnly}:void 0,occlusionQuerySet:this._occlusionQuery?.hasQueries?this._occlusionQuery.querySet:void 0},this._timestampQuery.startPass(this._rttRenderPassWrapper.renderPassDescriptor,this._timestampIndex),this._currentRenderPass=this._renderEncoder.beginRenderPass(this._rttRenderPassWrapper.renderPassDescriptor),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),!this._count||this._count<this.dbgVerboseLogsNumFrames)){let C=a.texture;P.Log(["frame #"+this._count+" - render target begin pass - rtt name="+e.label+", internalTexture.uniqueId="+C.uniqueId+", width="+C.width+", height="+C.height+", setClearStates="+t,"renderPassDescriptor=",this._rttRenderPassWrapper.renderPassDescriptor])}this._debugFlushPendingCommands?.(),this._resetRenderPassStates(),(!l||!tt.HasStencilAspect(l.format))&&(this._stencilStateComposer.enabled=!1)}_startMainRenderPass(e,t,i,r){this._endCurrentRenderPass(),this.useReverseDepthBuffer&&this.setDepthFunctionToGreaterOrEqual();let n=e&&t,a=e&&i,o=e&&r;this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].clearValue=n?t:void 0,this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].loadOp=n?"clear":"load",this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.depthClearValue=a?this.useReverseDepthBuffer?this._clearReverseDepthValue:this._clearDepthValue:void 0,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.depthLoadOp=a?"clear":"load",this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.stencilClearValue=o?this._clearStencilValue:void 0,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.stencilLoadOp=this.isStencilEnable?o?"clear":"load":void 0,this._mainRenderPassWrapper.renderPassDescriptor.occlusionQuerySet=this._occlusionQuery?.hasQueries?this._occlusionQuery.querySet:void 0;let l=this._context.getCurrentTexture();this._mainRenderPassWrapper.colorAttachmentGPUTextures[0].set(l),this._options.antialias?(C7.format=l.format,this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].resolveTarget=l.createView(C7)):(I7.format=l.format,this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].view=l.createView(I7)),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&P.Log(["frame #"+this._count+" - main begin pass - texture width="+this._mainTextureExtends.width," height="+this._mainTextureExtends.height+", setClearStates="+e,"renderPassDescriptor=",this._mainRenderPassWrapper.renderPassDescriptor])),this._debugPushGroup?.("main pass",0),this._timestampQuery.startPass(this._mainRenderPassWrapper.renderPassDescriptor,this._timestampIndex),this._currentRenderPass=this._renderEncoder.beginRenderPass(this._mainRenderPassWrapper.renderPassDescriptor),this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper),this._debugFlushPendingCommands?.(),this._resetRenderPassStates(),this._isStencilEnable||(this._stencilStateComposer.enabled=!1)}bindFramebuffer(e,t=0,i,r,n,a=0,o=0){let l=e.texture?._hardwareTexture;this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._endCurrentRenderPass(),this._currentRenderTarget=e;let c=this._currentRenderTarget._depthStencilTexture;this._rttRenderPassWrapper.colorAttachmentGPUTextures[0]=l,this._rttRenderPassWrapper.depthTextureFormat=c?tt.GetWebGPUTextureFormat(-1,c.format):void 0,this._setDepthTextureFormat(this._rttRenderPassWrapper),this._setColorFormat(this._rttRenderPassWrapper),this._rttRenderPassWrapper.colorAttachmentViewDescriptor={format:this._colorFormat,dimension:e.is3D?"3d":"2d",mipLevelCount:1,baseArrayLayer:e.isCube?o*6+t:o,baseMipLevel:a,arrayLayerCount:1,aspect:"all"},this._rttRenderPassWrapper.depthAttachmentViewDescriptor={format:this._depthTextureFormat,dimension:c&&c.is3D?"3d":"2d",mipLevelCount:1,baseArrayLayer:c?c.isCube?o*6+t:o:0,baseMipLevel:0,arrayLayerCount:1,aspect:"all"},this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&P.Log(["frame #"+this._count+" - bindFramebuffer - rtt name="+e.label+", internalTexture.uniqueId="+e.texture?.uniqueId+", face="+t+", lodLevel="+a+", layer="+o,"colorAttachmentViewDescriptor=",this._rttRenderPassWrapper.colorAttachmentViewDescriptor,"depthAttachmentViewDescriptor=",this._rttRenderPassWrapper.depthAttachmentViewDescriptor])),(this._snapshotRendering.play||this._snapshotRendering.record)&&this._startRenderTargetRenderPass(this._currentRenderTarget,!1,null,!1,!1),this._cachedViewport&&!n?this.setViewport(this._cachedViewport,i,r):(i||(i=e.width,a&&(i=i/Math.pow(2,a))),r||(r=e.height,a&&(r=r/Math.pow(2,a))),this._viewport(0,0,i,r)),this.wipeCaches()}unBindFramebuffer(e,t=!1,i){let r=this._currentRenderTarget;this._currentRenderTarget=null,i&&i(),this._currentRenderTarget=r,this._endCurrentRenderPass(),t||(e.isMulti?this.generateMipMapsMultiFramebuffer(e):this.generateMipMapsFramebuffer(e)),this._currentRenderTarget=null,this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&P.Log("frame #"+this._count+" - unBindFramebuffer - rtt name="+e.label+", internalTexture.uniqueId=",e.texture?.uniqueId)),this._mrtAttachments=[],this._cacheRenderPipeline.setMRT([]),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments)}generateMipMapsFramebuffer(e){!e.isMulti&&e.texture?.generateMipMaps&&!e.isCube&&this._generateMipmaps(e.texture)}resolveFramebuffer(e){throw new Error("resolveFramebuffer is not yet implemented in WebGPU!")}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._currentRenderPass||this._startMainRenderPass(!1),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_setColorFormat(e){let t=e.colorAttachmentGPUTextures[0]?.format??null;this._cacheRenderPipeline.setColorFormat(t),this._colorFormat!==t&&(this._colorFormat=t)}_setDepthTextureFormat(e){this._cacheRenderPipeline.setDepthStencilFormat(e.depthTextureFormat),this._depthTextureFormat!==e.depthTextureFormat&&(this._depthTextureFormat=e.depthTextureFormat)}setDitheringState(){}setRasterizerState(){}_executeWhenRenderingStateIsCompiled(e,t){t()}bindSamplers(){}_getUnpackAlignement(){return 1}_bindTextureDirectly(){return!1}setStateCullFaceType(e,t=!1){let i=this.cullBackFaces??e??!0?1:2;(this._depthCullingState.cullFace!==i||t)&&(this._depthCullingState.cullFace=i)}setState(e,t=0,i,r=!1,n,a,o=0){(this._depthCullingState.cull!==e||i)&&(this._depthCullingState.cull=e),this.setStateCullFaceType(n,i),this.setZOffset(t),this.setZOffsetUnits(o);let l=r?this._currentRenderTarget?1:2:this._currentRenderTarget?2:1;(this._depthCullingState.frontFace!==l||i)&&(this._depthCullingState.frontFace=l),this._stencilStateComposer.stencilMaterial=a}_applyRenderPassChanges(e){let t=this._stencilStateComposer.enabled?this._mustUpdateStencilRef():!1,i=this._alphaState.alphaBlend?this._mustUpdateBlendColor():!1;this._mustUpdateViewport()&&this._applyViewport(e),this._mustUpdateScissor()&&this._applyScissor(e),t&&this._applyStencilRef(e),i&&this._applyBlendColor(e)}_draw(e,t,i,r,n){let a=this._getCurrentRenderPass(),o=this._bundleList;this.applyStates();let l=this._currentEffect._pipelineContext;if(this.bindUniformBufferBase(this._currentRenderTarget?this._ubInvertY:this._ubDontInvertY,0,Kt.InternalsUBOName),this._currentDrawContext.setVertexPulling(this._currentMaterialContext.useVertexPulling,l,this._currentVertexBuffers,this._cacheRenderPipeline.indexBuffer,this._currentOverrideVertexBuffers),l.uniformBuffer&&(l.uniformBuffer.update(),this.bindUniformBufferBase(l.uniformBuffer.getBuffer(),0,Kt.LeftOvertUBOName)),this._snapshotRendering.play){this._reportDrawCall();return}!this.compatibilityMode&&(this._currentDrawContext.isDirty(this._currentMaterialContext.updateId)||this._currentMaterialContext.isDirty||this._currentMaterialContext.forceBindGroupCreation)&&(this._currentDrawContext.fastBundle=void 0);let c=!this.compatibilityMode&&this._currentDrawContext.fastBundle,f=a;if(c||this._snapshotRendering.record){if(this._applyRenderPassChanges(o),!this._snapshotRendering.record){this._counters.numBundleReuseNonCompatMode++,this._currentDrawContext.indirectDrawBuffer&&this._currentDrawContext.setIndirectData(r,n||1,i),o.addBundle(this._currentDrawContext.fastBundle),this._reportDrawCall();return}f=o.getBundleEncoder(this._cacheRenderPipeline.colorFormats,this._depthTextureFormat,this.currentSampleCount),o.numDrawCalls++}let h=0;if(this._currentMaterialContext.hasFloatOrDepthTextures){let _=1;for(let v=0;v<l.shaderProcessingContext.textureNames.length;++v){let T=l.shaderProcessingContext.textureNames[v],C=this._currentMaterialContext.textures[T]?.texture,I=C&&C.format>=13&&C.format<=18;(C?.type===1&&!this._caps.textureFloatLinearFiltering||I)&&(h|=_),_=_<<1}}this._currentMaterialContext.textureState=h;let u=this._cacheRenderPipeline.getRenderPipeline(t,this._currentEffect,this.currentSampleCount,h),d=this._cacheBindGroups.getBindGroups(l,this._currentDrawContext,this._currentMaterialContext);this._snapshotRendering.record||(this._applyRenderPassChanges(this.compatibilityMode?null:o),this.compatibilityMode||(this._counters.numBundleCreationNonCompatMode++,f=this._device.createRenderBundleEncoder({colorFormats:this._cacheRenderPipeline.colorFormats,depthStencilFormat:this._depthTextureFormat,sampleCount:tt.GetSample(this.currentSampleCount)}))),f.setPipeline(u),this._currentIndexBuffer&&f.setIndexBuffer(this._currentIndexBuffer.underlyingResource,this._currentIndexBuffer.is32Bits?"uint32":"uint16",0);let p=this._cacheRenderPipeline.vertexBuffers;for(let _=0;_<p.length;_++){let v=p[_],T=v.effectiveBuffer;T&&f.setVertexBuffer(_,T.underlyingResource,v._validOffsetRange?0:v.byteOffset)}for(let _=0;_<d.length;_++)f.setBindGroup(_,d[_]);let m=!this.compatibilityMode&&!this._snapshotRendering.record;(m||this._currentDrawContext._enableIndirectDrawInCompatMode)&&this._currentDrawContext.indirectDrawBuffer?(this._currentDrawContext.setIndirectData(r,n||1,i),e===0?f.drawIndexedIndirect(this._currentDrawContext.indirectDrawBuffer,0):f.drawIndirect(this._currentDrawContext.indirectDrawBuffer,0)):e===0?f.drawIndexed(r,n||1,i,0,0):f.draw(r,n||1,i,0),m&&(this._currentDrawContext.fastBundle=f.finish(),o.addBundle(this._currentDrawContext.fastBundle)),this._reportDrawCall()}drawElementsType(e,t,i,r=1){this._draw(0,e,t,i,r)}drawArraysType(e,t,i,r=1){this._currentIndexBuffer=null,this._draw(1,e,t,i,r)}dispose(){this._isDisposed=!0,this.hideLoadingUI(),this._timestampQuery.dispose(),this._mainTexture?.destroy(),this._depthTexture?.destroy(),this._textureHelper.destroyDeferredTextures(),this._bufferManager.destroyDeferredBuffers(),this._device.destroy(),im(this,this._renderingCanvas),super.dispose()}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._renderingCanvas?.width??0}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._renderingCanvas?.height??0}getError(){return 0}createExternalTexture(e){return new tA(e)}setExternalTexture(e,t){if(!t){this._currentMaterialContext.setTexture(e,null);return}this._setInternalTexture(e,t)}setTextureSampler(e,t){this._currentMaterialContext?.setSampler(e,t)}createStorageBuffer(e,t,i){return this._createBuffer(e,t|32,i)}clearStorageBuffer(e,t,i){this._renderEncoder.clearBuffer(e.underlyingResource,t,i)}updateStorageBuffer(e,t,i,r){let n=e;i===void 0&&(i=0);let a;r===void 0?(t instanceof Array?a=new Float32Array(t):t instanceof ArrayBuffer?a=new Uint8Array(t):a=t,r=a.byteLength):t instanceof Array?a=new Float32Array(t):t instanceof ArrayBuffer?a=new Uint8Array(t):a=t,this._bufferManager.setSubData(n,i,a,0,r)}async _readFromGPUBuffer(e,t,i,r){return await new Promise((n,a)=>{let o=()=>{e.mapAsync(1,0,t).then(()=>{let l=e.getMappedRange(0,t),c=i;if(c===void 0)c=new Uint8Array(t),c.set(new Uint8Array(l));else{let f=c.constructor;c=new f(c.buffer),c.set(new f(l))}e.unmap(),this._bufferManager.releaseBuffer(e),n(c)},l=>{this.isDisposed?n(new Uint8Array):a(l)})};r?(this.flushFramebuffer(),o()):this.onEndFrameObservable.addOnce(()=>{o()})})}readFromStorageBuffer(e,t,i,r,n){i=i||e.capacity;let a=this._bufferManager.createRawBuffer(i,rt.MapRead|rt.CopyDst,void 0,"TempReadFromStorageBuffer");return this._renderEncoder.copyBufferToBuffer(e.underlyingResource,t??0,a,0,i),this._readFromGPUBuffer(a,i,r,n)}readFromMultipleStorageBuffers(e,t,i,r,n){i=i||e[0].capacity;let a=this._bufferManager.createRawBuffer(i*e.length,rt.MapRead|rt.CopyDst,void 0,"TempReadFromMultipleStorageBuffers");for(let o=0;o<e.length;o++)this._renderEncoder.copyBufferToBuffer(e[o].underlyingResource,t??0,a,o*i,i);return this._readFromGPUBuffer(a,i*e.length,r,n)}setStorageBuffer(e,t){this._currentDrawContext?.setBuffer(e,t?.getBuffer()??null)}};Fr._GlslangDefaultOptions={jsPath:`${W._DefaultCdnUrl}/glslang/glslang.js`,wasmPath:`${W._DefaultCdnUrl}/glslang/glslang.wasm`};Fr._InstanceId=0});var $re={};var M7=S(()=>{vi();Ee();UP();Fr.prototype.unBindMultiColorAttachmentFramebuffer=function(s,e=!1,t){t&&t(),this._endCurrentRenderPass(),e||this.generateMipMapsMultiFramebuffer(s),this._currentRenderTarget=null,this._mrtAttachments=[],this._cacheRenderPipeline.setMRT([]),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments)};Fr.prototype.createMultipleRenderTarget=function(s,e,t){let i=!1,r=!0,n=!1,a=!1,o=15,l=1,c=1,f=0,h=3,u=!1,d=5,p=3553,m=[],_=[],v=[],T=[],C=[],I=[],R=[],b=[],M=[],F=[],U=!1,D=this._createHardwareRenderTargetWrapper(!0,!1,s);e!==void 0&&(i=e.generateMipMaps??!1,r=e.generateDepthBuffer??!0,n=e.generateStencilBuffer??!1,a=e.generateDepthTexture??!1,l=e.textureCount??1,o=e.depthTextureFormat??15,m=e.types||m,_=e.samplingModes||_,v=e.useSRGBBuffers||v,T=e.formats||T,C=e.targetTypes||C,I=e.faceIndex||I,R=e.layerIndex||R,b=e.layerCounts||b,M=e.labels||M,F=e.creationFlags||F,c=e.samples??c,U=e.dontCreateTextures??!1);let $=s.width??s,oe=s.height??s,re=[],se=[],be=[];D.label=e?.label??"MultiRenderTargetWrapper",D._generateDepthBuffer=r,D._generateStencilBuffer=n,D._attachments=se,D._defaultAttachments=be;let Me=null;(r||n||a)&&!U&&(a||(r&&n?o=13:r?o=14:o=19),Me=D.createDepthStencilTexture(0,!1,n,1,o,D.label+"-DepthStencil"));let ke=e!==void 0&&typeof e=="object"&&e.createMipMaps&&!i;for(let de=0;de<l;de++){let Qe=_[de]||h,Re=m[de]||f,Ae=T[de]||d,ut=(v[de]||u)&&this._caps.supportSRGBBuffers,Et=C[de]||p,Er=b[de]??1,Tr=F[de];if((Re===1&&!this._caps.textureFloatLinearFiltering||Re===2&&!this._caps.textureHalfFloatLinearFiltering)&&(Qe=1),Re===1&&!this._caps.textureFloat&&(Re=0,P.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")),se.push(de+1),be.push(t?de+1:de===0?1:0),Et===-1||U)continue;let Le=new Je(this,6);switch(re[de]=Le,Et){case 34067:Le.isCube=!0;break;case 32879:Le.is3D=!0,Le.baseDepth=Le.depth=Er;break;case 35866:Le.is2DArray=!0,Le.baseDepth=Le.depth=Er;break}Le.baseWidth=$,Le.baseHeight=oe,Le.width=$,Le.height=oe,Le.isReady=!0,Le.samples=1,Le.generateMipMaps=i,Le.samplingMode=Qe,Le.type=Re,Le._cachedWrapU=0,Le._cachedWrapV=0,Le._useSRGBBuffer=ut,Le.format=Ae,Le.label=M[de]??D.label+"-Texture"+de,this._internalTexturesCache.push(Le),ke&&(Le.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(Le,void 0,void 0,void 0,Tr,!0),ke&&(Le.generateMipMaps=!1)}return Me&&(Me.incrementReferences(),re[l]=Me,this._internalTexturesCache.push(Me)),D.setTextures(re),D.setLayerAndFaceIndices(R,I),U?D._samples=c:this.updateMultipleRenderTargetTextureSampleCount(D,c),D};Fr.prototype.updateMultipleRenderTargetTextureSampleCount=function(s,e){if(!s||!s.textures||s.textures.length===0||s.textures[0].samples===e)return e;let t=s.textures.length;if(t===0)return 1;e=Math.min(e,this.getCaps().maxMSAASamples);for(let r=0;r<t;++r)s.textures[r]._hardwareTexture?.releaseMSAATexture(s.getBaseArrayLayer(r));let i=s._depthStencilTexture===s.textures[t-1];for(let r=0;r<t;++r){let n=s.textures[r];this._textureHelper.createMSAATexture(n,e,!1,s.getBaseArrayLayer(r)),n.samples=e}return s._depthStencilTexture&&!i&&(this._textureHelper.createMSAATexture(s._depthStencilTexture,e),s._depthStencilTexture.samples=e),s._samples=e,e};Fr.prototype.generateMipMapsMultiFramebuffer=function(s){let e=s;if(!e.isMulti)return;let i=e._attachments.length;for(let r=0;r<i;r++){let n=e.textures[r];n.generateMipMaps&&!n.isCube&&!n.is3D&&this._generateMipmaps(n)}};Fr.prototype.resolveMultiFramebuffer=function(s){throw new Error("resolveMultiFramebuffer is not yet implemented in WebGPU!")};Fr.prototype.bindAttachments=function(s){s.length===0||!this._currentRenderTarget||(this._mrtAttachments=s,this._currentRenderPass&&this._cacheRenderPipeline.setMRTAttachments(s))};Fr.prototype.buildTextureLayout=function(s,e=!1){let t=[];if(e)t.push(1);else for(let i=0;i<s.length;i++)s[i]?t.push(i+1):t.push(0);return t};Fr.prototype.restoreSingleAttachment=function(){};Fr.prototype.restoreSingleAttachmentForRenderTarget=function(){}});var rA,P7=S(()=>{we();rA=class{constructor(){this._renderPipelines={},this._onNewPipelineAddedObservable=new N,this._onPipelineRemovedObservable=new N}get onNewPipelineAddedObservable(){return this._onNewPipelineAddedObservable}get onPipelineRemovedObservable(){return this._onPipelineRemovedObservable}get supportedPipelines(){let e=[];for(let t in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,t)){let i=this._renderPipelines[t];i.isSupported&&e.push(i)}return e}addPipeline(e){this.removePipeline(e._name),this._renderPipelines[e._name]=e,this._onNewPipelineAddedObservable.notifyObservers(e)}removePipeline(e){let t=this._renderPipelines[e];t&&(this._onPipelineRemovedObservable.notifyObservers(t),delete this._renderPipelines[e])}attachCamerasToRenderPipeline(e,t,i=!1){let r=this._renderPipelines[e];r&&r._attachCameras(t,i)}detachCamerasFromRenderPipeline(e,t){let i=this._renderPipelines[e];i&&i._detachCameras(t)}enableEffectInPipeline(e,t,i){let r=this._renderPipelines[e];r&&r._enableEffect(t,i)}disableEffectInPipeline(e,t,i){let r=this._renderPipelines[e];r&&r._disableEffect(t,i)}update(){for(let e in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,e)){let t=this._renderPipelines[e];t.isSupported?t._update():(t.dispose(),delete this._renderPipelines[e])}}_rebuild(){for(let e in this._renderPipelines)Object.prototype.hasOwnProperty.call(this._renderPipelines,e)&&this._renderPipelines[e]._rebuild()}dispose(){for(let e in this._renderPipelines)Object.prototype.hasOwnProperty.call(this._renderPipelines,e)&&this._renderPipelines[e].dispose()}}});var D7={};V(D7,{PostProcessRenderPipelineManagerSceneComponent:()=>sA});var sA,O7=S(()=>{Pn();P7();Xr();Object.defineProperty(ze.prototype,"postProcessRenderPipelineManager",{get:function(){if(!this._postProcessRenderPipelineManager){let s=this._getComponent(ne.NAME_POSTPROCESSRENDERPIPELINEMANAGER);s||(s=new sA(this),this._addComponent(s)),this._postProcessRenderPipelineManager=new rA}return this._postProcessRenderPipelineManager},enumerable:!0,configurable:!0});sA=class{constructor(e){this.name=ne.NAME_POSTPROCESSRENDERPIPELINEMANAGER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(ne.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER,this,this._gatherRenderTargets)}rebuild(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager._rebuild()}dispose(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.dispose()}_gatherRenderTargets(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.update()}}});var w7={};V(w7,{envShadowGroundVertexShaderWGSL:()=>ese});var GP,L7,ese,F7=S(()=>{O();GP="envShadowGroundVertexShader",L7=`attribute position: vec3f;attribute uv: vec2f;uniform viewProjection: mat4x4f;uniform worldViewProjection: mat4x4f;varying vUV: vec2f;@vertex
fn main(input : VertexInputs)->FragmentInputs {vertexOutputs.position=uniforms.worldViewProjection*vec4f(input.position,1.0);vertexOutputs.vUV=input.uv;}`;g.ShadersStoreWGSL[GP]||(g.ShadersStoreWGSL[GP]=L7);ese={name:GP,shader:L7}});var B7={};V(B7,{envShadowGroundPixelShaderWGSL:()=>tse});var VP,N7,tse,U7=S(()=>{O();VP="envShadowGroundPixelShader",N7=`var shadowTextureSampler: sampler;var shadowTexture : texture_2d<f32>;uniform shadowOpacity : f32;uniform renderTargetSize: vec2<f32>;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {let uvBasedOpacity=1.0-pow(clamp(length(input.vUV*vec2<f32>(2.0)-vec2<f32>(1.0)),0.0,1.0),2.0);let screenUv=fragmentInputs.position.xy/uniforms.renderTargetSize;let shadowValue=textureSampleLevel(shadowTexture,shadowTextureSampler,screenUv,0.0).rrr;let totalOpacity=uniforms.shadowOpacity*uvBasedOpacity;let finalShadowValue=mix(vec3<f32>(1.0),shadowValue,totalOpacity);let invertedShadowValue=vec3(1.0)-shadowValue;fragmentOutputs.color=vec4f(finalShadowValue,invertedShadowValue.r*totalOpacity);}`;g.ShadersStoreWGSL[VP]||(g.ShadersStoreWGSL[VP]=N7);tse={name:VP,shader:N7}});var V7={};V(V7,{envShadowGroundVertexShader:()=>ise});var kP,G7,ise,k7=S(()=>{O();kP="envShadowGroundVertexShader",G7="precision highp float;attribute vec3 position;attribute vec2 uv;uniform mat4 worldViewProjection;varying vec2 vUV;void main(void) {gl_Position=worldViewProjection*vec4(position,1.0);vUV=uv;}";g.ShadersStore[kP]||(g.ShadersStore[kP]=G7);ise={name:kP,shader:G7}});var H7={};V(H7,{envShadowGroundPixelShader:()=>rse});var WP,W7,rse,z7=S(()=>{O();WP="envShadowGroundPixelShader",W7="precision highp float;uniform sampler2D shadowTexture;uniform vec2 renderTargetSize;uniform float shadowOpacity;varying vec2 vUV;void main(void) {float uvBasedOpacity=clamp(length(vUV*vec2(2.0)-vec2(1.0)),0.0,1.0);uvBasedOpacity=uvBasedOpacity*uvBasedOpacity;uvBasedOpacity=1.0-uvBasedOpacity;vec2 screenUv=gl_FragCoord.xy/renderTargetSize;vec3 shadowValue=texture2D(shadowTexture,screenUv).rrr;float totalOpacity=shadowOpacity*uvBasedOpacity;vec3 invertedShadowValue=vec3(1.0)-shadowValue;gl_FragColor.rgb=shadowValue;gl_FragColor.a=invertedShadowValue.r*totalOpacity;}";g.ShadersStore[WP]||(g.ShadersStore[WP]=W7);rse={name:WP,shader:W7}});var X7={};V(X7,{ShadowGeneratorSceneComponent:()=>nA});var nA,Y7=S(()=>{Qh();gb();Pn();P0();JT(ne.NAME_SHADOWGENERATOR,(s,e)=>{if(s.shadowGenerators!==void 0&&s.shadowGenerators!==null)for(let t=0,i=s.shadowGenerators.length;t<i;t++){let r=s.shadowGenerators[t];r.className===zr.CLASSNAME?zr.Parse(r,e):vt.Parse(r,e)}});nA=class{constructor(e){this.name=ne.NAME_SHADOWGENERATOR,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(ne.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR,this,this._gatherRenderTargets)}rebuild(){}serialize(e){e.shadowGenerators=[];let t=this.scene.lights;for(let i of t){if(i.doNotSerialize)continue;let r=i.getShadowGenerators();if(r){let n=r.values();for(let a=n.next();a.done!==!0;a=n.next()){let o=a.value;o.doNotSerialize||e.shadowGenerators.push(o.serialize())}}}}addFromContainer(e){}removeFromContainer(e,t){}dispose(){}_gatherRenderTargets(e){let t=this.scene;if(this.scene.shadowsEnabled)for(let i=0;i<t.lights.length;i++){let r=t.lights[i],n=r.getShadowGenerators();if(r.isEnabled()&&r.shadowEnabled&&n){let a=n.values();for(let o=a.next();o.done!==!0;o=a.next()){let c=o.value.getShadowMap();t.textures.indexOf(c)!==-1&&e.push(c)}}}}};vt._SceneComponentInitialization=s=>{let e=s._getComponent(ne.NAME_SHADOWGENERATOR);e||(e=new nA(s),s._addComponent(e))}});var K7={};V(K7,{default:()=>sse});var sse,q7=S(()=>{sse="data:application/octet-stream;base64,hhaHlvbWljZ7InZlcnNpb24iOjIsIndpZHRoIjo2NCwiaW1hZ2VUeXBlIjoiaW1hZ2UvcG5nIiwiaXJyYWRpYW5jZSI6eyJ4IjpbMC4xMTIyOTI0OTg2OTk3MzQyOCwwLjA4OTU2OTQzNDAzNTY5OTE4LDAuMTM0MTU5NjUwODY3OTE5OTVdLCJ5IjpbMC40MjUyMDE3MTIxODY3ODkxLDAuNDAzODI2MzIyMjEzNzkwMDYsMC40MjU2Njk1MzAwNTA0MTg2M10sInoiOlstMC4wNzczNjU5NDM2OTgyOTM5NCwtMC4wNDE1MDU3NTUzOTI0MjIzMSwtMC4xMTc4NDI2ODM2OTc0MTA5NF0sInh4IjpbMS4wMTEzMDEzMTAyMzUyMDc1LDAuOTQ3ODM3MDg2Mjk1MTM5NSwxLjA0NzQyMTE3MTA1MTAzNzVdLCJ5eSI6WzEuMTUwNDYyOTExNjAxODgxNCwxLjA3OTY3OTc5NDI1MDU1MjcsMS4xODUxNTg0MTA4NjM1MTcxXSwienoiOlsxLjAxNzU1NDQzNDk5ODk1NjUsMC45NDc1NjI2NDgzNTQ1NTQ3LDEuMDU5MDg0MTM5OTEyMTA0M10sInl6IjpbMC4wMDY0ODAzNDE3MTk3NDgzMjYsMC4wMTc2MzAzNTkzNjE2NTc3MjYsLTAuMDA4MTkwNjkxMTk0NjE0NjU2XSwiengiOlstMC4wNTA3ODMxNjkzMjkxMDk4MiwtMC4wNDAzMDk2MjY0MDc0MzQ2NCwtMC4wNjA0NTIxNjM3ODQ5NzA0OF0sInh5IjpbMC4wMzg0NDQ5ODQ3MDc0MDUxNiwwLjAzMDY4MTg0OTIzMDI3NjE1NiwwLjA0NTQyMDI1NTczMTQzNTQ1XSwiaXJyYWRpYW5jZVRleHR1cmUiOnsic2l6ZSI6MzIsImZhY2VzIjpbeyJsZW5ndGgiOjE0ODksInBvc2l0aW9uIjo1MjgzOX0seyJsZW5ndGgiOjExNzksInBvc2l0aW9uIjo1NDMyOH0seyJsZW5ndGgiOjEzOTEsInBvc2l0aW9uIjo1NTUwN30seyJsZW5ndGgiOjk5NSwicG9zaXRpb24iOjU2ODk4fSx7Imxlbmd0aCI6MTEzOCwicG9zaXRpb24iOjU3ODkzfSx7Imxlbmd0aCI6MTQ2MCwicG9zaXRpb24iOjU5MDMxfV19fSwic3BlY3VsYXIiOnsibWlwbWFwcyI6W3sibGVuZ3RoIjo2MDU0LCJwb3NpdGlvbiI6MH0seyJsZW5ndGgiOjYwMjEsInBvc2l0aW9uIjo2MDU0fSx7Imxlbmd0aCI6NDYyNywicG9zaXRpb24iOjEyMDc1fSx7Imxlbmd0aCI6NTM3MiwicG9zaXRpb24iOjE2NzAyfSx7Imxlbmd0aCI6NTIyNSwicG9zaXRpb24iOjIyMDc0fSx7Imxlbmd0aCI6NjEzNiwicG9zaXRpb24iOjI3Mjk5fSx7Imxlbmd0aCI6MjE2OCwicG9zaXRpb24iOjMzNDM1fSx7Imxlbmd0aCI6MjEyOCwicG9zaXRpb24iOjM1NjAzfSx7Imxlbmd0aCI6MjM1NiwicG9zaXRpb24iOjM3NzMxfSx7Imxlbmd0aCI6MTI4OSwicG9zaXRpb24iOjQwMDg3fSx7Imxlbmd0aCI6MTQ1MCwicG9zaXRpb24iOjQxMzc2fSx7Imxlbmd0aCI6MjAzNiwicG9zaXRpb24iOjQyODI2fSx7Imxlbmd0aCI6NzgxLCJwb3NpdGlvbiI6NDQ4NjJ9LHsibGVuZ3RoIjo3ODcsInBvc2l0aW9uIjo0NTY0M30seyJsZW5ndGgiOjgzNywicG9zaXRpb24iOjQ2NDMwfSx7Imxlbmd0aCI6NTI1LCJwb3NpdGlvbiI6NDcyNjd9LHsibGVuZ3RoIjo1OTcsInBvc2l0aW9uIjo0Nzc5Mn0seyJsZW5ndGgiOjgwMCwicG9zaXRpb24iOjQ4Mzg5fSx7Imxlbmd0aCI6Mjg5LCJwb3NpdGlvbiI6NDkxODl9LHsibGVuZ3RoIjozMTEsInBvc2l0aW9uIjo0OTQ3OH0seyJsZW5ndGgiOjI4MSwicG9zaXRpb24iOjQ5Nzg5fSx7Imxlbmd0aCI6MjQ2LCJwb3NpdGlvbiI6NTAwNzB9LHsibGVuZ3RoIjoyNjgsInBvc2l0aW9uIjo1MDMxNn0seyJsZW5ndGgiOjMwMCwicG9zaXRpb24iOjUwNTg0fSx7Imxlbmd0aCI6MTQ5LCJwb3NpdGlvbiI6NTA4ODR9LHsibGVuZ3RoIjoxNDksInBvc2l0aW9uIjo1MTAzM30seyJsZW5ndGgiOjE0MywicG9zaXRpb24iOjUxMTgyfSx7Imxlbmd0aCI6MTQzLCJwb3NpdGlvbiI6NTEzMjV9LHsibGVuZ3RoIjoxNDIsInBvc2l0aW9uIjo1MTQ2OH0seyJsZW5ndGgiOjE0OSwicG9zaXRpb24iOjUxNjEwfSx7Imxlbmd0aCI6OTcsInBvc2l0aW9uIjo1MTc1OX0seyJsZW5ndGgiOjk3LCJwb3NpdGlvbiI6NTE4NTZ9LHsibGVuZ3RoIjo5NywicG9zaXRpb24iOjUxOTUzfSx7Imxlbmd0aCI6OTcsInBvc2l0aW9uIjo1MjA1MH0seyJsZW5ndGgiOjk3LCJwb3NpdGlvbiI6NTIxNDd9LHsibGVuZ3RoIjo5NywicG9zaXRpb24iOjUyMjQ0fSx7Imxlbmd0aCI6ODMsInBvc2l0aW9uIjo1MjM0MX0seyJsZW5ndGgiOjgzLCJwb3NpdGlvbiI6NTI0MjR9LHsibGVuZ3RoIjo4MywicG9zaXRpb24iOjUyNTA3fSx7Imxlbmd0aCI6ODMsInBvc2l0aW9uIjo1MjU5MH0seyJsZW5ndGgiOjgzLCJwb3NpdGlvbiI6NTI2NzN9LHsibGVuZ3RoIjo4MywicG9zaXRpb24iOjUyNzU2fV0sImxvZEdlbmVyYXRpb25TY2FsZSI6MC44fX0AiVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAAF2BJREFUeF6lW2uwleV1Xt+39z4HzgEVRKXmYloUUQTkokkbTYrViJYCIhdx6iT6o206vaT94STTNp1mOp1IJvmT1j9pkpkm1rZTDYlJVASOpmnTVoVURVOsBXQOOlwETbics/f+vs6znvW833tMYA7pdnDv8+3v8q7bs5611ruL1145UJetlrVbLSvK0sqiMCsKK8vSWmVpZoXhhb+LOI5j/h3OxRlF0fcPteGCysy6VlvfCqvr2vq4I06rzazX7U73a3B9zfvWdWV1jfvgc+3PqavK3/1SvNXG73BT/KnzcGF8l06MC+oKZ/oC/X7+VxzC9RWeMbr3jRoParXa1q/61m61rbbaWmXL5Stbba6+KDIFmJ/v4ocSXHFW9EJj3Xgv69pwTDJU3W53mEJDGAjCNVLJLasq6A2a062pRb2ogEboXCiXLxRTVVQkboRjOA9rdKGL0no9LrHYu+fVGg/GovDqdDp+Ubvdtio03u60XXNSQquF87HYyvAZx/EZD8Dx8AJ4RWm1e4T+dUIhlRXxXW3QeN8FKQxmwkLcyHE9ZO7VzfGiqK2seT2eAY3I89q4BuoJp4Gm3fN8/XHTfj8cFsf2vfyaf4+F4wSEA54IwaoaQpVWlIV7hp8X4dLvU3gpAedB0612y90N96vNqgLCY8F8vhYcvm3jErSuPGSgjB4eb7XBRHwoDEjDQ2j4QwuBgfub+bm4BtfiOVQlPhQQoS7pAbWlkIBFKtyosuLlF/fWZcmYx507YXkIDMFT7Bdl+owbwkNyfJDrSWHuCeG6EcsI9LIoCkSmrIfL4DjyUq6f0eEQ4cIxGiCcvEOxLEXyMggKwRQv7v4QFnrKwwNL4bnFS8+97Oe323TrFAZZ3AMPfKUtgCTBMP8HPDj29pv27M5n7IYP3+T4AU9Q2OTgpHDRPT0Ow8ge9zRgXVVVEWHZr+va3YlGpV7pFAg9RYtZ1UfcU3o/WlXWR8wHGnv8u1v0k2KK53e+5CAIBbibB9LTagCO0oWh4PQuLExABqX95MTb1u12bdfOXXbD8httoDOQFOSLqaA8YgXvQCH0N4/xO+COK64EcieRZVPr9fq+lmTx8DK3KNNDREB4Q12FkniLJv5r/1zs/Pf/qiGggM0BsNMOBDVrdzoT0J9eUlMJQNN+zw6/+YbNmjHbnnxqxG668WYbHBjMFAD/Jpakl3sQ0mCkvEBqxw2ltbCwBFPGkRV5nM4O5blggXLIZvQOur4L6hhVGbBLKdDD9j//dWfdapV+AbQOq8CCcHe+CmaGSCMOlp42WzbeHXfrYx3nTZthj2191FatXGO4n8AUrgrPgqviOF2Wi/Z8nyyop0XERyDjfGCUpzWl8bAyBKSQEUSuPCocl+O7JGzwCigA4I7w8Cz3Lzv+rQagKRVKOBAj+Lz+dmKEEHEsaFm/37Ox8ZPWaQ/Y2PiYTR0Ysgf/6UG7+6P32MAAQ0CCCmBz3FBoQOk5kUnhEUILSB3cIvY9n4enKBRkbdwLFpeH8DyQntoFr9wDiA3uTdseG6lhIcX04OBg4gQQVLF//MRxO378uA1NHXLv6Fc9V8jw1GE79vYxe3X/q3bs6Fv267euNNwDHkKIJ2i6MtziwSd4IDGz9F1mZa6d4SZLSzDPqbB+hvKwLm7pwlbMuBWUodgHLa0CAPt9/1x8Z8tj7mywGg502h1iAMAuUL9s4UaVjR44YGPjp+wXZl9s490x5zKnTp1yL3h4yz/b0sXX2PUfvN6mDg25EiR0A3GkuxAWVkokql8RfIsy4jWD8khfHgpB0/s9Whje40KHgMnq7vpQHq2M43ieQkafHRse+scttS8ETAKhADwoCleE4pcAiRBoWbfbsxd2P2/j42O2ZPEyGxoa8gd97/tP2UBnis2bO88uvPAix40pU6YQO6KmcOIBBWTxj4WSRBGwPE26JZ3zhIWZ3oTycGvlcY/nCAcJmCvChcW9a7Nur+sewWORBb7+1QfrgcEBf3i7TcTHwxAWEBhKcYUAGCP9AZQOHz5so6+P2mVz5tr5M8+3J7+3w65etNROnDyOgsdmzphl06dNt6FhKIhor9xPLkAhlFWUBgWKsCye3ev2EtUWTLJ4ggBUmgT3MImQQHZyPKh6fh6+A27huXiHEtwDvnT/l2tUZngYhIblIDi0ACB06+M9QFBA5ud3OvbG6wfsrbffsoMHD9p1H/yQ84GjR9+0ffv32uzZs21o6rBddulcrj3in0Iyk7BYCRYXisIzPN+DCwTPoaXJKXAjFjtmvV4v2B/zfg8x7whf+XdMe/G56rt3wRMgPAqi4otfuL+GZRH3cEXFPRYHZdDq+ExajuMAP6Q0Mr62nThxwrZ862FbcNVCm3X+BTZr1gU2PDRsAwNIn6LZSIOR510ZUADCjTVEAjknTaUhzgVo0h6YnmKawOaFZhISSnGFeL6HsAA6Co/rYBxcg/SNv10Bm//q86kYgsXl5rCwFkyvaNNLIiRcaXEOPj+782m79poPhDCsFXCdp9OIefeeqO+JBQ1lZfyTJ+A4K1F+D0H4HQXL3R6fuy4Qkd+VAFcP0MNnekLPFYDPOAYM82f9+Z98pp5g+XZTDaryUwgICIEHSm1Syq4f7rRlS69hqYZwgaKscC8QoWXFScLlhMirx3ZYm9iTFy94BkCXwAglIDRodbcgjkUGkJUhnNwbSoSVEQZQEj53oQA/RoUU9/7xp7wEoaXYqUHsERAhTGQAZIiMGMEjcJ4wY/eLL9jVi5ZEziZ7U9PEmaSnOVJg4YiDoyhr3Ns7NyQLHtOpkouOTp7OIADxoIlruToVBCHHaXlXDIV2ZTgI9qz4/Y9/InWEyPIaWgyLwZpQChYNAWAxx4JIix4SZWn/u/cVu+LyK6Mxwh4CUin7CrUNiE4DBwLAFP+eJh2xAXxswym+HeEBZCEow4BKgiWF7inOe3RzKgVW7/k7FDc+DsGVAaCUvhW/dc/Ha9xMpCRVgS40vaGp8bNyOPqHjuRm9troa/ZL75vj5/O6poeoc8Qn9DyvD8DywhOYKJj7XRlBmLBQ3A/Wk+AiNzxWOR3HC7FN6/at2x3z+7jVe7oWIBltB/CSuzZ9tJZbUvtIL3nNz24R0TxrkISAdOfSDrw+au9+13sm5HoJjEBFKDGLNMjP6o/NTzE3/xzdG7n/hBzuQIcUFpas6MqwLl5QBDxDLi9vYqXcAKx6hcX6tXd4/8y7tPGKBmeq1mRBFS7yFmUMPOTwkUN20YUXuXsrTIjs9CBvYAgHvOPcSlZWVegMTq4ONuhgyTQGJcq1iQN9F5LCUgn+z5seqhPYHRKANpYnxngxdNuqdR4CLFyiN+U8m3HJrBUNuShK2DFu2tUQ9CfHf2znTD83kSbcD/hAoXgPhkU0QiLHkaY2bSwt3jMA8jRa6SEkzpXwuC/AzAuewA5VeF79hZs3945OcmrkRat/7ap1ngVykBGBEAHRvdSU8ONRmip/I/amDJL7exmdtdRccGCDevzhDd4U8eqNhYospL+drwPQgvrqeHQ7uYxoeuCzrC+DshvMPpt4R5PSkd0KeoCvOdKRtAwmBgBhbU3OzfvRldXY0DF2fdC6m9jGcrcPbPHCBw+NoYtbP4AP3uf8PVV2GmQ0nZ+GMUbrLARU/08CCzuUvUTpPd1HFlOhV6xbs6F2YWCJd3RLUNSkvAsBA7EduVMnhi7tORX9w6C7LHQIprKIYwiKLq811BMkIkPZuCebHdGsSI0P5no1N3RvYYI4Bmkwan4qVm0771BF2GoC5kaHMW5fs752y6WamQvBy7kzXDNIhciPCAx6iSpGsGgSnwjuwIim9I2aXziQhQOJT9PFhYIlBPt5TR9fTBHCARvU+tLUp/EgZjMIjxfrF/YzdbxVtq24ffV6T4N+wz4qKxAIahIxh1Bg/c1BiDSLd7cYFuvlZt8GBgZTK1oZAgJg1uDxGSmOXCNK5BiueAdHuvOOMENAhnEvwj1CcD4brTk2R5oKEfQZBKnvbFbvLOKaWid5KEIANxUIIQz8ppg7BaHAOwkO3dl7gyGAABKeAEHZ3W7OdfobnRtXnjNNEh624ZquDRupFFrA5x3fCA9PW5G+5BnM8/QSGAKhiLXgPBhERqInsAT3Qg7eirVtWHsHMSBQW2wrPTQ0jAWxMcIOscCP15U2NnbKBgen+OIxYxgf76aGKhfI8pegx//nCuD34AZMiy5syeIHn7FgGUYC4i4qjvDOsCDfF/6oevXULQyKKtbXBSKkTo0LHR5Al6Q7yc3UE5CFRWOxkFOnTtqUKVO58FBQYnoBhszXnDo7zrhHwZWjOZI1OnEO2B0UjvrdQy6aG+oIy0s5nwDVZdtL3SVnn74Ydp5Say8A0Sn4xtvvTEOnvNJiyci4pAI4PssxgJhAF8QiO6gQEdNRszN0oskSTNOPhSeo2wvPYBwzZfqIHA1SNwhTMTEqUnLUCvJEcIWiRL+SjQ4oBAWQshKKMqxLPUkP5wiHYtP633QmKDf1oiGaC15Xq3eG6WRUgHIvJ1DRqsJ1GKggBqEYuKIzQVR+EevcgBHcJKzOZ/NcuL9nAFc8ewBaFwA69Q0xOu7C5QvrjndTSlX4ep0fIaW07A0dKEF7H6KYK+5cf1ctwiNkx4KwMC84si6M6n8Bi0CJ3Zo+C55IWWJgPhJLrs6agMRIu0NIdEStOQBh/68BvVBIDDNYKgMfuo4NXhOgceLFWstOnDjubX5hB9bk0yml6sLcWP7cOzfcVcv1FeuO/oG8AhkIr0Uz9XGGIOsiXvOJEEdh3PEhKxJpGZYaliolNmjO54iBqjWG+3tVqhIEtQCKJHlvlO2wvleGEDpqEQ8BeKF3vttNjwPL2bT+rhqLdItDcEddTlPgcuD4cG+Oz5opDxaGG8vloW0KrL09tGB+zGu9aI5oQqPyGIpW6CjVMe1ObIHjecIDFkqwfJnCBd4GQBZpU0cLSlUP01P2wAD7HBvWbnL8Yc+cxAYaJKWMIYIzQ8ayOkGwEBb87Ucfebko7Atmdsv+fftX/e7v/F5WL/B+DAsKIjamnKxjIjPI5UyPDIWGikfoZKHJ+oF9QQ06PHyjswwB1bECngiQHWxRo4B3IAuw4UAy0TQXIyVG84F8mv82f/4+u+qq+X9ZluX30YMINJ5tZm9EtfneqqouKYry3hUfuWXYt3oEAdIOBg+DbKeZgFhs0/sAANSoP1j1sfQVbwHqo/dA0CMRYrrkNMi91lkuQ8fLfYwBvd3PLUDFhrV31tK0CIaDTHAAYgCzxMhT2/cZrf1i7PdRJsK7FJAfw+dpN9+44hGFQ8KRwAf2GmIkBsLTRhg1WQlemKa7WUixUYKmKPEEHEG1AcKWgEx+oYwApTdEjh2uYsNtm+qm0cCbeNMxOjN4+OPbH9tWFHa/mR19p3TZ36dTAPT3wEduWnGxusGOhT4q4z4CVXFy/bw34OvwcGs7Frnb9zgbEKdUtuIhKo+MlPsSMKN0ntLppA1cGgAX69ZsdB6Al/pq6pziwVu+/Q0bHBxYrjr651FAr9drfeIP/mjbnv/eE+mOtUKeCpVZYBWNuSGo+glYG9YAt2f9rxKegK1xOJSiMPY9DzHXjLkce5a+aYPMsFi7ar1jAF5+YRQnzuYKs8e3PbrRzA6eQXB9dXoP4Bnzb/q1m/9abTdYgNMcPrsZm2keFAgfmUDEKEYGiQipdlDvD2A4NjbmcQ6P4XQKhQ8AEdVj5Xue5I3FujV31KqgoBlnU767qm/bRrY+YGZ/Ownhz4QB+eVb5vzipef6vsPI0QAp9u+aGb4jN4hOv0e3DaHwGcec6gIAsas1shUsi2Pavjc8PGzDw9PSwMdZbDBTESMnQmtW3u4eAOEVi/SGrj2x4/FbzezkWSjgTUTSGc5vXTrnsm1ei8ckSM1Lldr5tdzSFnv6Ikx1niN4tPHEG0SStH9gyuCgnXfuDCdoXmkixbZK5y+sGAsrVt16m0+GsNOD5SgmKGO248ltj1lh901SeJyGGThS4v4zXXP53HkjwhzhgDpMKrl1vUiVOIIKJl2vIUr6W52l2DCh4gebOKZNm8YBb2zzVTnuIHjy5MnU1zty9Iidf8FM++53v3Pjz0h1p5Pt/ddf96uffe8l77EHHvja8jMooH353HlPKN5FvCRADIViSKpd45wVEOCziU6M1RvlMCuoQaPzFTJQNsJi+vRzvHHD8ri0YuWK1V4LoK9/6PBBD4OXX9nz22a2Z7LW33zf5pEf/OA/7BtbHnrYzL54huvmXHnFfGJKbJbIrS6A810eXiDxTqwouaFK5+fdoVw5ORVXUaV2mcJmxnkz7JxzzuWw5sPXLa8PHT6USMQnP3Wv3XPPPWey4k/Jt3Xr1pGjR4/Zxo0b1pjZW6dTQFVVyxdctfDT2rToIaBdoeG2YUe3JCdUbJ8l66ffAFAx/I4bzpRRpBDS6WYzpr5XaMyYMdOKyy+bV0PbetiP9ry0IqO3k3WCJned6YraPrlgwaKb6aocjXs32BepH0tMvEG+w1szB80p6O6hnGz/MO6XeooTNmPG5iqfR8RobN7cK9QQ9KLixR/tPhvkn6yC/LxvbvnmyJ/96af9MzvEFF4V4wTerx87hA94ulRTNNsm23SDm11kPqdwCs3KJPcMtuz0o4vaiisuvzLtRcGFu1964Wkzu/esJJvkyb/8/l8ZOQHApQaaq1JDhO3wCa8gQu4h8V1KgZEKaXFyiRwP8uwgj8vDyZdx5bz5HI1FXr7wogtt+45tN6S7TVK4yZy2eNGSkdz6GlxyeKLlsw/RjEtjvhcLcqFiiiyv0Llqoef4wb5DOHnGK7TeYsH8hZzNZjH0/O7n7jazfZMRarLnVJV9aNmSpX/h7TO3HL1AIOUhEb/n0T2dMMWIXBPHfPOUFEGlNCsRsVPdrxlkU2Q1kOUKeKfLbf7cZ23FihVnlQnOoAg8bfXSxcv+EA9iLUBkd6/TmCTtEWzAMMVuco9m9JoUEakxPT+srX2FCXBjB6pANyl+wVWLPI9waBAjKyvsh8/tugXt/sla+DTnwZf/ZumSZVdM2A/0M04mnWX1p8afFplye7iBNksy3rknWFvMNCHO2aIyiZqiaPu5AfDfQiggNkHkwLRz1zNfLcvy7/4fCuiMjh7Yunrl6rT7xIUE6kdXOKfECkM1SRPtTSkzgDNZeOJvaJRK9XMY/YgLf+Pl3pT2NOjnc2bF4kVLiJ+RGxUdS5Yutq985cs/LxiWo6MHtq/+DfAiTmUYz802HNUBCYxiYKpNDtxk0fz4gSjuwNH8Xkj7FpQWRZxikJoodjxExMgVEhmkuHrh4rQVm9tiIs6KwnbuemaDmR06Sy9oHzp06IlbV6xMACfBG6FDlLRHIMhQdHfp2twxrrRGWiBGyKyRBjPa4BEKYa7PaofwgPyYewSeDw8QKUmcMtDg2V3P/L2ZfStK3B8rE8UPIX9KL71er9y/f//2jes3+Xdqo3taSvuDCHJUiprvvJWGphSUbE2h0Twskl6wwOa6hhqrIoppW6a4XIm8sli8aGmdc5K0X9XMZs6cae9698X2/HMv2LUfuNbr6rvv/pgdOXLE1zNnzhy75JL3jdd19bmyLMde+Z9XPrNxA4X37SkxJndh8xAIzOFQJVw7s6gzuZgoK3Wln9Z4IDdKEJjJUyhWlvf1y5Fo7es8sdBi6eJlKQ2q2ZAaDC6JfqkQMz1VaBN+9haIGjGe9hnGNhRNkx3fYyNlnv/Tc+N52i7b9PqyvUkRuyp9tTxOmTmJSoAYP4+JeGgIUQxeRx569mOugKYb02xYzmnlxNgNt230kjZOkE020yNtSqBcBDV/j+ksM14wgawgaur/+NVX3hWa8JsDBUbkx9jnlI5mnCD/eaoywiP/8Mys8AAKnrel1FgQ+LgSYgOzbqZ2lmJdOfydoJf/jXM4MOUy0x6iIEYqj/VjJ26ViY1PWbdjAsIT3YIT5CVw85O6Zldb82OLR7709PD/AV0YyoiOxdZoAAAAAElFTkSuQmCCiVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAAFz9JREFUeF6tW3uwVfV5/fY+59wHai5cUEdrUdQA8lDeURQVkKeotRlSmRqbaTOZSdtpm44zNrEPJjP5I+nDWGMzaXV0EoNRJIkTsYljvbaKMcYoUpAWJGmtkdhWBAmX+zjn7LrW963f3gcfFztehrn3nrPP3r/vtb71rd/vZi8882JRq+WWZZmZZYZvWZabWcHvfNnM8tyvyfIMVxk+UxSFv8efzXL/ML/jularZbVazW+Au8fr7Vab98NXUbSt2Wza1u8/ZMuWLrMJff3W1d1teGy73eZn8H663gprt/Fcf7auwVr0H6/hPxbVjjXqNb8G7/v12fand+Eyy/NaOMGsXq/xBvV6nQ9ptVtWr9X5PhaC9/I8szyMc+eVDuNiC6MT9IXX+MAsSwuFlXDW0NCwPTbwT/aRCxfaGadPtgzXhhG8HjcrzNpFOzmShrThjBavh1Mtk3PcMXCcnll1AJ1D5xeW7fjx7gJRchMqkaaxyAj8LzMB18oJnjk5F6gI1bCYwiOH/7VanR5HduG7roNztLjBI4M28PiALbpwgU2cMMly3BORo7Pa/BmvYeGMfdyfwWm1UiYoI/CM0dFRWtRstrgOfBbXMlv5M7KgZRlKgNGGEyItGd2IWA2ZEZHE+zW+F2mNjI8Q04nhDJUUbMDDaGjuzkCyeOkU7hwr7MDrB+zpH/3IFi/+iHV1d1lv9zhrtpD2uCfugVRus5zoBEQwjKLRrZa1IiuxIhiK/3QcS7HNLGYWtf11lAauyX7y1I7CI+ORxQdkFiNY99JgXcd/WI2fWRaVSOp9LwmuMRmhUsDDYYicgGvfeOOg/eCRR2zdurU2NDxo4/v6iTOIlqdyyxqNuo2OjHI9Kgc5A+5EuruDWo4RGRzjzsd7viRkgjunCePx75l/eY5oQnDL3AGe8l57jcABr9c8rkM0aw56AW54AiJ/bO1XAVT38NR3sIXz4YDvbX3Ifu2aq21oZNAm9E1MpUd0DW86frRttNm0Rq1GI5jWuQOl39ed5hngtY7s8Ew0ZpZjR2TmE48+TQxwlPfIwlPwPl8TLgT6V7sBHKJsUNQRKa25LCVggqO+G+POJJBFCWz74TZbsuRivtbb02u9PeMc/Igd7jB1HRnIZ2ZmzdGmGxpGs/SiKwALFMzq51rNJssge+wfnyiE6GpjSA10AuGAnKHUdVzwCKo82P4CKxwPfOHoJEhhZAfvx26RMQpYPBZ4+PBh27btSZs3b6719Y23dtGycT0nWL1RZ0bhM2p3QnDYPhqG8708s9GRkQSs/l7B6OMeyBCWRaVFsgwe3fo4A4aIsLcD0cMwLF4Rd/R0g9QOhf6O9oiw44SwJGFGlBg+nzDDMhttjnJhh9/8pT34ve/Y0eEj9rH11xGQkQGo4Z7eHpabOAXAsJWQHR0gI8Dh3t7fPdX9NYAf0t9BVBmgboELs4e/80jhBAXpDtDL6QClqRtT1j5+RgbwfXYNb4HiEXAUiygAky0TCJ7XUrvEeyPDIzY8PMQ63rN3j/342Wds7pw51je+jwb3fWi8OwEcpF633t7e1MKQUXiuGxR13moGf3BH4BoCHiIOMGQqFXyeHIDukW3Z9GAB45HysArehwUiQVg4jWKUcY0IT0ZkVlS9i4QjlQVRo3igHAAnv37gQHSV3Hbv2WXnTDnXdu7aaf39E+y86dPt4Jtv2P5X91t//0R7+b9ettdee80uuXiJ9ff3M/peFCQErGMYqOiKLBEPosyQZTBW3UIASGzZdPdmJ0JRw+r76NFqfWB8nuLe2ur1Bn8WzVXnUP+Xs0Sb1YLg2L1799jLr7xsJ598sp104kk2adJEGxkZtX0/fYn3mzVzlh0Z/KVtf2G7NeoNmzZ1up086RRP5UB1tEMEDPgBxyOTAiVTfyeTRMRBiIIzOFt0sEyAePff31N2ARQBCYsDIFyG6Ot3ZYBID64Rbe7q6gp27lRa7I2OqlJrIr/ZoUMH7Wf/8bPoGIW9uv9VOhnOO+fsc+3000+zRqPBhTYaXal1IZrIztHRERootB8ZHnYeUBQsL2ENez4AMKgvOgZW4BnStuxrt93pGBAprlQW+Ck79D6dwTp3sCMhYvl43SsrOrKgigdgbBmAC63RURlGIOKIzrw581N0YUQVuMgpgB+IfHwPyxL7w3NR5yUXwMzg2YDyERgyG1DOt3zptgLGwNupzdVq0Qa95lkOAsLgCOD8aoPuJC8JRFeTIsoJOIEFqbRITbkQZ4StAC+UBp513vQZie8rVZEmTnW9E4nNOQ444ivKanPOEgt2GjkcOJBAELiBmeILG79YAPgYOUQwUWJHfqQbgTEYDI3F63E9bu4OioyIAUoGk/rmOQ3AvcTPUfdqs3jtpX17+d60adMTuKGbDI8M+0g8Chpc9xYI5jfaTLQXhjCdYwgSKxRnqDqlIzMAgn9y481FV6MrRVmG4TvAT9Mb21/8nthg9H9kAoz0LHFGmUgU6HWQINUhDFVfh+MAqntfQgaYTTlrSvosIkuEZ+8v2xzoLJxDIlOZ9NTeUubEjCAyRcYYjNJZo1n2yd/+VNHd1W093b0cbrAYGEqDKgCImyhLUvRjMhSNTt0kpkLWrMqAA4ljjRwRacX7vvzKfzKNzz7r7EB8Z4yc2GIiZGSDHpPlYRaIuvZJz1Ee2aL2KNRPvT+EEIki2XW/saHAkrq7eqyrq5vf0X6A6jSAQ4+i74tXNog3SEcolSVnlpqVxSnE6eEUN8zvh4W/uv/nNG7yGZMdIKX5oM+HuCFjjo26xBGOvPEFx3DS4OcFhA644gek0Os/+rGCQBRUuF7vMmREF7739NCQYzuC9ADxew1QAkJF2MsHEFtOm+rleM/B0TvJL17bT6ecftrpyTGSwljDrHMfnlJtBwtMv4d4wqEpFCQZrNbnUYFjHEGza6/5aJCq8A5FhNx6enqtnteZFQSrDD3f54AqzS3JEMZQILvrg/iOhQkLqp/zGY9YlybQ//nf/2bsTjnlVB+AQvWh4hOSG+d8dgTPHr4Xw5IyyiPu84DKRAHxzCm5Ax2wbu3VvBRoLnqpVAK6AxfQIrsa3TRGziiHHo6FHdqAUpvRj67gLcylsuqXq1CFHTjwOhcO1ud02zlANJ/g8+4YkR9lBbtECKckR8EtvORcEXLBr7xnkGnL1qy6spDEhCjLu0pVeBKgB3CEI+AQl7aqk18MUiFZuUbgBotbyLklCHoaaHA69OYhBnp834QOwyNhk6ZY7SRVsdSnQS8Rz6ByXvBcUPK7xMZugOl0xbKVhQsNFYEvQkRpOgRNESInNw0aqG5QZYVe8ZUvOIpA54uj40LkkFiKVjgy6rN8T3cPr5PjpBy5HlAKHQI43E/YkL4L6LCMyE7J4xJVkPGcYFcsX0VESLKR1h6yTtVzDmZSioI0UVF2BUmGiTtE003epwIjR7P+PYvg5GYTKq5Zd3dPRWQJ6Vqtk+CFDuEagAMd8CAUY+KG/+wO8wGOIB5rRwClXXCIW71iTUFSEO2Ic3arTYT2ektlGJoBHuqRTN2B6q07oOz1pTDqYOcKkaQwV948G/AzSU/RZgdyYUVkykWNcv53KUt9PIIcwqeviQpUEDesC8OUOEq5v+FzS7Z65doCHJnEQaADfa3ZdDEhxlASmhiDlUYeTKfLLqiGMELbYnwOz6sdqgzwOxYpMMJ0h/uNgwhS2UCBI5qtUecCrSZnB3yvEh9OrUGDXQ/06GO9yMxGrUEMcwrvSjaezTXJAXA5xQaCg+vumLe9p3q/gqESNsgM63Xy8TzzWaLEgjL1fBbAmOodQHJbyohQkh0D2jZu3AlRhI4ZoK9wABkeJTR3RsrYEEWEBXIEfgdYY13sZHSG/yxpnYFbvWItQZD/wnBEXw9QX8UNmUohh7HGVFfk+9o/cM+6dObcQLM5OUNESy1KEtrQ8BAjf+IJJ6Y2h2g7gcHg0yZQtto+26NMcT/PCmj8LAY6GoIJMgBsFmCHdSODfbDzyVZzTbZ29TruDFUFRKUlHkJxEepu8IEqscHnJI74/OC7S2ptToxizzEIC8tEW1++ZmYGSgDfgQG4B40PIRMjrYAyMULqe83kZGFC6RA33OcbzwR3hJeGY1hm2ZqVaym6c2eFHN29zchLcSGjq9GjYn6l9q/aF2UOUTUSOfEA7uhq38EHK0Tfaxlzuu8Ag3k6eXFZG2XImZ6tEiUZmx7B8xV9zvmBY8MjI7xvT09PRNxbd3XYUxZka1etoyKkNqTdE/WuKjBibCZ4YbyNMZepGPI5DMRD1De8Lv19ko/QFMtOUbZCpDe+sCkiYZNgx5E2QBCtMrLFA+TzAUuCEniLkyA3QyLSJHCp/h3Ima2BD3SAjCTohH4mFdUFjJwAiQwQFUbqihHi8+wQseMjHoASSHpCZYfZ25/nv0Zppnm7beN6x4k+eGYA+FgOMf5yI9SnPmWrsgeGEytGRrhOoD+eBW4BPFIZIwBwDJ+9ZuWVYCcEFbackJ1VFpScYnStNxrW09UdiO5Aoq7A+g9ugNdhPJiiMzZvgmVvL4cgOQPKj4gQW1TohS5utFgGmgFGRoaDG5ROUAYgI4aGjjI4yFgiPUorfkYpi80yBOvWXF2kbSM+LNqPhot4DQtCfbJ3Yz6o+40omVcOV1RH5dIJkeqgwEGHPf4ORL7JCQxAtHpjXO1Mbam7AkbhFLKBKR+0HeiPDMDvKk2yP/yPqdZLIFo3MqBaAklhiVbj9eybIcgA3JjaHhA+xuM0EgcZwvvCBpQSjU1nD8oN12orlFwNsOITA9BIr6M01a4ZbRI1l7XIRUCEgBGF2dDQEO/hM0vJX9I0G4Ku84CVa9M06O1QG5G++Ug6zJ0djMIOIFgUOoRUI3ED0UyeF6Kk7fqAU9uQw0INdjD1Evn6N+/aneX2N2b2CzM7c+Cxf/7KXXfcndQcH43jYEMwU9/0LMgNqm0VThk6OuSZSd4BHlKO8dQnSY/h6MyyVVesTsNgan+xnyZs0OTFNtJoWKNWJw6QXASiykBfrJ/McNT3MwfOBmPKaxf25dv+2k497ZQ/MLOdMa0i9/Ghwfg+tWjbF67fcMNEZYo2OR0LPPLHiiMSRFkqwV8YjAJnHTyAouHUKlatWMMSIKnJa37QQFpabCr6ZBXIGWMko8ddmwadAtHBR8w4TRbnDDTOOgDWbNP9X/+zPM+fjF5Z/VZ1QOfbbVvSbLU+f8NvfoLrw7O0qSLhRGtUFyB5Q6mak7jqusQB+Bk4gBJzszxXQ+oaW8oaipA2IBbeurR9FjtCor6RdmKIWCg1vzh2c/+We3+S5XbjOxhPClDJgLdd0mw2s833PfDYtx94MB2YwJo9O1zwAAdwVunM0blKKNxx5im1a02LK5evLnSmD3fRh+EUH0O9DTqANNKY6fzAS6AT4DD2epcove4z+pYH77sCt/v/OCA+M2P9tdfdrvUIvHXsReDJIa5yzsHnDe2A++YuSoQguGLZKh+G4jCR1y2M9j11UU2Nu35SzDmAi5+loZLPZaBPZH7dA9/91qY8z//hXYwfMwP0uSef2DZwy1/dmkQPrV2lQKY4MuLUntOrrxVf2pliOXMszi27fMnSgm2rcN6tG5H96bhZTImsdzC+dNLLuwNH5dANERUei2k1ST6wwEUXLrTP3nzT0vcw/rgdYGbTf/3q9V/FczT6aq24CV4fHh5m2ak7qFspIMpMfr9i6UoyDu6xR/jZZ6N/wwAwL4iWopjwnk59wFD9ziwBEAZAgjgdPTpoe/ft+aSZ7fuAHGCbN28e+OxNn0sRRbTxLO0jAszH9423E088KU2oDoShAknaRxtcdvkVRTo25nIq29ho09MIB5iODB4p9wOC1GhGqEpd+hnf3ZlmDz+81aZOmzpW9HH1uADBI2M4Cm//ytRzp90jZUoEKYmt1DYKiisT+yda30njfXROh7d834K/X37pslCF41SnmR09epSnNAYHj3SIi1J01JerhjLdwBiD9CBDpk2balsf3nqtmR08DqOmxTXIFB8D3+PrLQz+/PSp05fICZogtVFSdcb4D02w/gn9hl0vbNcTtyCeooMsvWx54UdNXIRAxJHu3D6imlMqql4h3nMSs2OwXb3na5LFs8xmzZphW769ZZm2+d7DnjMuWbzkG08+9cQLb/n/JlTkWA4AOV0wf+Gjb7552DeOgj4nvTIEGGZqCDD9EyYa/nd3d9M2qliXXnJZgX4KJ7xx8ADrXIamc4PxBP2uxXUYzNLwU6bU+6mnZ/Zv//7i2BnQtssuuujijb86+Qy7f/N9v2dmLx6HA3DJVedNn/HHrlv6I0V9maUakGIfQllyyqRTbcL4flef5s9dUBw8dDDpAMeKFXJGh56vU+Qp2qH5hkqsaCCrdu3e+Tkz++EYBk38+PU3PLB48UX26d/99Eoz802CMb727ds3cNW6q1P0hUH+gm/qqBT0nuOF73YhG7IzJ5+V9gZFaDSBpS3uOPsvJ1DkiP2C5KC0eRF/OBF5v+vFf930Fmi9V/+XmZCDYbin4NhftYULFj16dPBoue1V2RpTbFyLKLNDOoPWn005cwq5JDdHY4qjSFHZwtIpr5TyfF9Kf7npke5TScU//4s/tfXr1x9PFxjb5M4rps6eef7XPNiR/7JU+36xGYNrqtmQPoMqnXLW2YV2hiVfSd9/W3TDndL21Qp1HWuxihcBTDt2vvCBO6Ddbn9izvlzf4vETX+QEUNbwE/aJPVrtL/h6aAEzs45+9x0TI4pH1+dKO8veqvzlEotUNeH4JEk8QAhXLd9x/MfuAMGBh4f+MwffiadIK9mAes9lC0GJ0DQE7OsXQLlh8+dWuhPYtQy3m6c9vDKnV9eE6qvqCUe5VzAv9QRtu94fsXx9Pb3UQNdF8ye8wMFSZoA27P+gENGR1l0kKYQejkOT/3wNJ4TFFKQ7MSenTJCDqluisQBDMeCxPy4f51Ohcjj23c8/3Eze+V9GDjWpefPmzP/1mRUXI1STuVQacX0QQx8scfOTzBYcIALmU4YOkogSJBqXAquDBYjLDHAIaACBUzAZ5975uY8z58ay6r38f6GeXPmf0oZWMrskeIJ9r1etXdQXh9lAQecN20Gc/ad6p+1pOMzEdlI7g72JYf49/LpctBFiy+yr9x+2++Y2U/fh5Hveumdd9w58He3f7WsZ7HRjp5XOkMapjIh8QVk78zzZnEWSB0g/nagep5HtSZnlE4o//TNXxNE+sN1wlzCxbPPPfv0Wz7aeJxU990c0L1g3sLv400gu3ewOPXVsa1e4pVK0SlQ4s2OUzNnzCIIkkIGsOGNjj+ICkAT369mgdehDkA6wnrknRJrdmD6vbX9/aW//KItv2L59Wb28/eZDajPyWZ24/y5C2Y6bHmGOuqXB7BkqCJ+7HOqgJjNnnk+V00WGE6QIzp3eYUPnZ71tNe5OwFi+TudFguVc2ZfMMvuvuuunZYZVOEKp3xHl+DIyOo777jzj5D2qveEP/F8DWFVhahKjXW9qHDiTHBANf39AeV0p5TxMqCrOs5ceQfx42eSwqtEQ2XhCxAau6FXXXOlbdy4EWT+8DGmw9tnFIX97YbrNvTt3ftS4h5V4E3ZFsGrjukytBrU6kZv4jMXzJ6TIlA6ovzrkE7QcydUDziqBGSoe708W+QbJOXBxXIoccz48q232JJLl/y+me3GC+12e1Ge5zcunL9oEhecNlJjJQG0+jNcsU+le9qYFfN7p6SKkmE455w/10tAFDZOdfiNYsZXn48NzirSe/27U5IT4qdqOvLwour1mDNA2Eb75rfusXs33WtbH3o4HaiqrqvElrIEsUYBoTRCtboqmdOYfOw9KIjMvWAeqbA/zI+6C8RUv86uYkc3sT2dKyy3vOSC2A5muVQBx4NRntN9O2BCPocErz/O0ufl5LJbVY2R849tw36NMieeXqHCuP7/AMWVEhy/7HuGAAAAAElFTkSuQmCCiVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAAEc1JREFUeF7FW0vobXUV/p3HFTUjsIRAJe01qCC9T23QpIIgMKKBOIicpzjLgqIiaGCTwKAG0SxISEivpvhIg4QmDQwSC5xZkfT3eu/9P85rnxPf+ta31vrte23WvX+49+yzH2fv9frWt9b67cnpk2d2u92uTSaThs/ZbGaf+N4a/nGbx1uz3Tji36dT38G9PGjH8zu2d9tdm8S59Zo8n7+vYzt/jql98ub80K3wm3g+/MV+2+b+rR3n33a7je0drrGf3LYJFFCf2sSOh9B2KoLCTU3AqpBUChQ2jZ+kAvEdt4Ei7X9/bJ7GB9a9dnZ860bAg0+h7FC6BM7H1vUQzJ7UhKMCU9j+Oghvz3/qxGlTbbWkvAEPzpvLI/iQl/MGWcEELApMj3APkiDhX0VXxXNkRXmVnknC5lUQNBUJhfFcWrxaHkql5k0tbTtsqYCxxSWkQgA3nU5hdQgPl+RN5IvcdiXRVGHxallTtCu0hos/flEswzF9lg/8bt/DA/waWV/eJWXi8BaKMc+gq0QIpJumlVNA33KhqxdQwLR6de903QyX9K6KKVRYYIAe0MOm95G09ljwFFjWh1H6kCA2bOOXwwMu5wWyXn+M8TwGyXxWj3O7s0e+A6Jd42AWiBYh1dnY4bcXvXoFjc04l+A6Wx5g1uZpcQ6OyQsAkukBUwJXgmC68Rgf0q0ZBp2C8B1o76Egoes5ihJ6i4OjgmYyMQvp/BDalNkrqXfxsWdkFqhKQvgyO3iWOX3yLtnJgLAHsARHKLo/TkvjmewaDwO5sSBCmYKKYLwoRRKxmd7wX6RfF1bXwGIKnR4K0vrhER7bAr/IBu4p+C2mT957cuYUFKAYdy+IWGfKkoCytpTBowHdHUcI9Ha3itQojtFFQyb4TPNIhVtPmUyN4QHFG7r8rtTnfAWWpsWpQMY+7W3XwWjgAR3q05jh2tUjpsjnhQjpmKlhRHyY82lVyyCuCIE79pkFZAnP9W4aIiujIzzDYjaSmDIFQS0zFgnO2PL1u7GDrSsmPSDBq/KAyvykqHGYJOtLcMzrKLzLYoJReFnXlV0t7AYwV01iGAgQHCHSOgmPzq8xPgxQTg0Vxr48pwsBWQWfcvf/mR1keTznVGmNub5KLfc3BSYoM7REw4XWfoLcvQJY4EjFDs/ttLA7jgko9+cn/kCEYHk8K0hQ8IDLWTbdvfeMsJdTWoJfWhlASdeeRDaoGDKdzoKIBH5E3q8QJ1TXPpnbs4F/7UjOdohYx1WyPqnxNhQgADRsMAxQjHpKk6ahKVotUT4VkABoadKzQdJmXlvJkHAhQNe9AcpWNuhzfSUSPeVVUNn5rsAa5wZ4gQWqDZgCCYgD+YxAUC4fBYsXPBATIQFEnk1nUZSEm7PE6VJhZIeiUEQhr3HFuRtzv4Or0p/wwNybwMcI8SrOih4WTAJNw4Di+rI6jm82g4fkzryCkefKUDWoCk9W4rP2WDCmvIYZbdd+//yzJ9t2e661hlp63bbblT3vbPaetttt7Pt0eo394DActesn87YwQnDMCcDQrt0u22J6rF2La6fXtMPt2ouPebt2N7S2Xbf93a7dcOy9bWG/uX7o4W//47XX/ibttMGsWoSD8MOQdYWzQANAKTsVQD3TGop7lr22/xJg5Dk4/4WXzt7WLqwuXhrB/989Z196ee/RR3/Wpbwu3Tna5z6mRwFkECExsABDj3m5ZocDArdSQr/47NMfacvlO/9fcS/99S9+9b69Pv1lCRz1gGFBpj5hDDFip35A6zpBCof8TCCUN0hZUNLzv3vy9rZaXbjSCnjq5T/s/fTRnwdDBA9gocOyV9+pADZAJDh5gCkATNCx3TbI/60Z4i0scgHl95IWHfyuVgj84teP7T3++BNuYbTdSHUNAH0bgkroSoBGHaE+xkMJ7u49T6Aigj5PWnvhmaeuSgjc/8BDe2/9+z/e+spUZxY3IkSPqNtShhEj8ICT6AhFuiKhUfNSXaAEwUmbORgapXVFPP/M2Y+25RJZ4Ir+fener+3B0iaM+ICnxiFiX8CXAKimiKV+9gTHKY/ozjTHFGrKiLZYNjfhCc8/c/bjbbncu6LSt9agAKa9rAPM9UWMttsGRSAm7HMUHkaLTx4/FQow5mZx7zhAnhtWN7efslGaFWS7agq4576v70EwVZTW5oDrixSBAwQvcHB0BVloIAucPI6maNpOlo9S16s30eXpbGYnZ8o0BXysLZdvX2kPuOe++/eyFhBV9p6fxb/TZOcDVgyVUnk7DPIA5+2O/hQedfwsBBWNxSdJEYsdnPnci098uF1Ynb/SCnj1jTf2vvudH456/0l08IzGDj0EMjwYMtZwUQjkREjtbwrH2Pe02KF/guBzTz9xW1tdeSbYbrj+r1++594PRmz7IESon1ngUjJEnLAQAAb0oBbuLuHN2lSMPIHZgF7w3Au/vSoe8Mqrf9n78SM/6TrDCgnQ3UyBmQmU/joMwEUiPzgB3mAsyStBdXEIkkyVkSInk/bc009clTT4y8d+s/fU2WdjBNZNgQoBYtpj/As0ERo2rzx+x4kdYp2NjCxZKSCUMbcYAvgFX5hOu8zwyU99ot16y83tzTf/2V5//e/mKTfd9P729tvv2LaV0bttp7Tbb/9Qu+WWm2Ma9Morf4oeooYrMWAi6saQlBMulsLDgBjP76z0NPzw+SAwwMtgnK96YDNsmAUM8Lz0TZQnFwirB/gxA1SAVOkc9UHhC6oi6TnZWBG9zrZYNlytQcIEb5/WVPGBJ1OQd3V9X+32RuFT0V6pD1ZXdwgeAhA8cecpS4MStic7lf9zm57BPoHCpvIHKQznmfAWXjO2oL12EJ+gLK4UNVVKKsF50UxFA0SDT8v35P3m2lEDeMtbPUC3tnqB+C10giIdIgSSBygV0ur6Ax6EUD4cNYUJBItnCB+MLPk/Amf+Ztd+i2lUP5BRczZmC+7+ppAobTn3qwMQCwecY9YlB8A+jsioLFWBCgVTgCF7obsERTE+uiYUEV1jDwGxRilMwEgQdSXtHFS9FSYFMFz6jpOGZEnCYl7WzQg0c7Q6QAMPb3GJ6AjlLd/D9b34ucQDToEJOv2lZZ381ALJ22MCRpbK4gvu2jXuYXFvqHbMshRQ2XpL66sEJxiz3RYdRB+QqPkaAhaPULmraZC8BYgf4OiTomiRox8gaisLh9urielubJ5gCtIqkb4m6NzePIgWlkdEX2FG7woleM0RHuWoH81Vnx9oWhQzA58IQRmgtRJKyqnND0t7lh2oDIWIdYWhcSM2YnpufXoDvQI3VViwWErGGP1C7J8RJHUdCyd5DGEvy2xt+/7oGvde0bXANXPxQQjnh83yuwk4DL7N75vNxoyAlCcFICzkFT4eT0uK7UUcRs5XDZAkqDZKFNOwIhWV5XPWEWOlqerMkFFW4KxARVdigXJ4NDp9JFatri5QWLtYfRjQUFaXyAYjd3E46m5X87UECYAU4vv4qnqBMoVcHqEij1JzdT6dMx26V8jrIgRHvIPxnjMDDkqNINhvGOo7uGX8w+prc3GGBdjfEJ5B4Qe71sphKCDIit9MYy2mr4z3xABmjUp81EMQT1D6y/5iIVU1DEqaJAYxHIOP+FhEKTDys6N/9vtoVQgm95ag+sR+CW7pEaO0M6fujvUBHQ64Vyjfj60tATUbDJKkosmZn0JCOEBvcm5RskmvOOKGFEyhWbBpGGR+4J3eYevxPdDaUgLcXdvAAmUHbLMW2FIBoqOV7ycget1fLNXHvrzEY9/qClWOfcwzu9RjVAbxQiU3t01JsfxGoJi8sDJBojozQVWACSoljJRhoYGGiCmgDkVLylMaszBwoVQGy13NxeXS/uC1ZIbASqsRFiBVPoEyd/f1iEyjqUBYPVJoGcXHKg/n+3RnxjbQHt9l5fV6ZUqRMnScAGlLZHoFQFDFtwGZs/FMXSqG3Lqe+pTe1C80b/JKUABpyvC6AJ+pGO4Pz3FFZEbivWT/Ot2R9c3Vh40pAMICCNfxuXZP2Ng+ZQKTUyEQWaDwdub0HH2HErpwKIUU9o8Ez+KIAkaKhHKMXsMb6PLhAao2R6EQQOioJTeucU7B16YA7F+sFm2zXrfNwP3ylgBxgSDTH+09Tn/B64Mg9QAlgAsm6CGRzJBTphDSwQ/HZ9N5KsYtT28gJgg39MBWInuZHG7vVqXgsPKqLZfLtlqv2nK1dG9YdRMiKNOqy7tOf8YwQHN7A6kyEsuuUJazkTa9ItTyOQFXjWNZ1QTxDFBjHfvl/rhOodErL3sJlrs994P9mdu7AharZRs2m7ZcLdpiuWjL5aKtNqsGHLCsUVrmzCLCAFVq7np1cXSf/nxy5JQ5KHABMbr8jEheLG3bpgS4/rzNUA+4wOYJHg5SgCnFwbJPh6C97AIR0DZmaShhsThqq/WyHS2O2mKJ7VUX78Eey+sBkzNgguL1o2xQaemY9uYQlYLaAMXL4Pls3pEk0WIT0pUSAocHEBQh+HyO6x0YgUOjZomIDqwNIfEPVt4/3G/L5VE7ODpo69UqhiIiT7V3IOaYPMDX9YsFkh6XosTTne3vSE42UCuqB+B5XSBrAlihhLHF4Q3H5sei76AwYvXpz+FjbwhCq69NcMT5xf0L7eLBBdvOeWG/XkC0WQoJKiykViMkCiG5+iVLZcTUcqosK9fqr8a6hLbUOHZ3WN7CwjHAU2TPCRizzPFEdAh7eHRgwu8fXCjdH4ooK2u7KsCEh3xcKMliyDgADkQ/z5fC14ZmbZXHCrLsFyoNCjwjvifOC+bzSHsgQfP5McsCUABCB9vwBMMev6/SHywv4RHn+wcX2/mL5wzwOBzx1ePeJY7vGoV7ASUDkwlisbS3xGpFJzZnKVBFksKihkMwx6zzGefZB6joLpCE8PIExHyi/8wUQTyh67P5SeFXq1U7OITg59vR4sA8QUtIY3GEZwotmqoVo7whPCCXyeV0SHXAOP8HLjjCS5NZ3Gh63NcAzPeJ6pEa3fKXgJ+TKb2dwsbGuh0ujtrBwcW2f3jRUL72Bjqg05xg9IZIns+OkHm9ESFfYyqBYJ26trcC4uUKoX5ZTba7sqOcLFD0OKwvNujKIAnLdpko7dHi0OIcCI/U17FCb2KPUV5kR/MFdYTpEaSTEzRFOfriTYMilvYYSZJ3hEp/P/f78SA73hYzT2FbDTFO4XlMXWaFB3iDEF9uitwOtIerHx4dttVqadxAguDTirLLEJzq6rEeyNkfQtSmQpBFL00x5xcFODuMirAsh2UlWF+kyulxN0csNb3Gb8zvIEUJhlks8f5yeYAbhAejU0PUrOpVYNBjH5HJ4nq+uh5IIAkj534fjKik5QsdqYR3w4BLvCTG5v0oLThFlLX0InpBjxdqgSvHg85ScLzeNjBDjf70Mqa9/uZg2c8K8oVQZQTOHdkdtmcYL5HRTMi0WBUSCyQ9K5RjSZezhYZnDWLkaF7L3brCXBikMhUAZ+0te0h/2WK0VjgE0ksZnqkq3a1hYANTayfpjVRf3i8F0Kp6I0wvTGbfr7obw4JvhJrHjOZ+rBH6LrJCxhRjfQa+3CjLo1y1Ot4BToOMMERYjnEf5KYgvoamGqrU9Me5oq8m89Ru+zAa44uQ6WKa/6s07lzeH1zdWlkoCyNqFsVOjr58tuAW0H5rVvo4G2AHxSC+47dsRbgvZnIgjlfh3AOF/LKwQriyPmx/68EftM/e/flH2qT96Py0Lef/apOvPHDmcHLnp7E+QGknLZ49+RyURtksbu4xGcPPUlUKtOj2+eKkgZDe3rS1O1zDYxb1XoTQPdKY36d6EWIZ3tL/cQBalfDNb3yvfe7UFz5w/lw7vOV9bfjzUbx50269sd04OX7HSXMiXpSdV3vwmEfkGn/S5ciYuX7AXdSs5x2bcNU8PZa0h+XKG6NkZ+ZvXTqWB1ZqiyciRuTrdtgGvX34ge+b0PsH7ejcdW1zVISuCrvuujaZ3HnHCesxkuDwcJ8J6n5/0yuqs3yfPgiSFDGpL1mUl5RioOGz4CIwV5HwlRrkew0+oMjI+fFqXB+2T//qjw+2SXtyWLdzbw1t+W5CjzPJfwE115LvDkogEAAAAABJRU5ErkJggolQTkcNChoKAAAADUlIRFIAAABAAAAAQAgGAAAAqmlx3gAAAAFzUkdCAK7OHOkAABS2SURBVHhebVvbjiRHEc2s7pn1A34C8Rv+bl6Q+A8kG7DXrGfv3pvX6ztI4JmqROeWGT2m5fV0V1dXZdxOnIjI6p//9dHYTlvb+tZab/zbe+c/vLZNn/UX5+m7vm2tjdbmb3EyzvO5uFiuwevguhuObQ0/7P6+fm69D960tR1X47vRjtbaqY1223rb+Lm3PkYbvbfTwF1Hu2ud5+A//A6/4Yr874QPx5HDej/G0frDT29GBIaQVAR+tUGYpQwsdCmC4lEYnMe7lvOlC30PhUAqKtAy5X74O8Zop+00uHacgDXq/xQe+pRc7a6NBkHucAYOQDp811vDBai83tt5QCFQ2lLmA14OQvO0TgXAxv3hp1+N00nnasEbFyslYNESJgLwmL1AxyRcDJb3vHjxGN9AyppeIs/gonrH6vAzKUMvHIN1ccrZlsX7bfS2y0XoFVII9NnaicehrN4O6HcuDofH0Y5j3ah/+dnjcZpCxU3lynJhCH/iD0+nsxcfq1sZPGeTNa3MqUR7Ar7jNe1l+IwVS4gOd8ZrH0fb+0Yr7hQ73oCF6LPMrjCBsAoRHfb1qBQoCd6Ba+EXsiq1clDNO7zgq78/pTq4wG2jAAkDqhfKme4Nga32YECUF2+xNyh8ZG3hgcImFwjmtNHh5nlBGOrGsb/CAUcSAtJbUYcDJqGA7+VDFJpYQQ+iisYYR4dr4Eb9y89uGAKwMteBs096j2MMzRIWcfHTSdaPS9NTciwYYKCLm0/FEixtELv6cGwzBBD7VslYgCYjCyngHfgLS0/fkE/ZzPIVa53hk9ChcuAFVMBX/3hKXUFYhIKuJyXQYHlvoeLi0ztwBoAQqwmACjiEFSUb4B4IAy1MyjPiB8y4tj7awRgftCDie8H3woeIjltDIVdY7wRDW9/hkWyAa20QXIDYWr/5/PnYNqGHssBKcxO56RVKexUQk/aI5lYQJDrBm0oalbwLU/QVcQv/sBKg6V07LKhcPJmAAjIs7C0WCvGdvAlXFWYIBoTKzrb+HbIJXvAGWp9p8MnDF/aAhf5OTTP3xxOgKIYIQ2MJlZQ3vWJZd4Ji5QQXuR/eKCXcThF1LIkRguKFsOXfYtUokbcuv6cdyBjyUjo9Ma3yV8aAx1+8oAeE8EgIu2pNVzMlrjTInOO4rx5U0H3xBF4LnuFojJDyAlgPcd+PNtMbzoRSQHaiBEWNLC1Gtf7FzXFc3ykV5tx6XKGALAAF0L2ZyqQIva853jndiB/rR2nxGIG8foe7KhTkKXFhAaKEtEsineFfrHjrjBnWAsvdGTGA5iRH9oiCldMDcNkr55ETbsd7gylKeWfddyAdtP7s0atRgYnQakXEqlHQoq9RVI3tRaOp8skhVuxHcV4IXJlxTua28n2iHV4hC8JbW7sF4wt4UAKFhVOVCJGvuXBg0eF4AKwBr1IYP3/0ij8Lgk/Ob4q7ISXaXMoMQvaLeCceKO8n5UmR4BAAz5CeFZKmtNP9ZZzFAA1wUBAWDmXQ6j5PqxfICfxl5bOVEtYYr4pXzM9jjDOx68XN6xGBmP+D1uT3S6jEdRieOIL9NtTZ1DfKSVZWVgwIk6eL3x/tjhGDtCfhGOsl7SX9qQiKMvB3xVCsPvm4CyJF/2hnJikVUAgNv8QM+8ub11aecv8lhV25nMepHCLEVFQUNo7RtvOJ1q41QPJS36gA/rOVcH/FvoQzNgsMyQdC3QrQmSeoshIYBuTwhnkq3m1OwHN98NpYZMAcnQoQ00upmuJmxbdoq1yasZ00h6A0aNL9WTPg7yJhTH+6fYAO71HZRXAHI+N5NytXfLoyismc21kOW3EpCannwgQpNMHUCsGyyAEMiDAYl/b14zejujO8IHVBrdrC6iYTDNHpqB8AtZbDx5EBeC+xSWcvlbKzqpP1AYCXXqCFw23lFfJpVvPbKnwQNqOD48fZDZLxACsZgKefKntEKQTC/vLxG1WDTnthd8rZCgEpRGA7+YKZY85P6mRqKQ0VF0CwLAgI8row9Wh3xO3A8aWHiNKK4qZWoz0QLqjlnBESAkR9p8vryS4NUfaOACEV4NDc+tdP3jINSgEqaFKpBckJau4YkfwY9BIWcXhS6tL9kZsx3FS7mwRRESgdxPkRDkL6BIPec41Ha8cm90UZD8EJoHZtHvexgGTuVIkPhDu3o+2472jMFsLm18/eDdXyq2tTOzaJbcWkCBbDoHSBqtVX+bu8x7lKeR9CO9YVARdsLoowV6EiKuMTeKktxiXBOQmsivkJgFY3P9MpVdeJIAkLjmOMU3/z7BveLDkb3gBVx9VR6Yn7y2kCmGmAzKZJqfu5MvcLXAMw9Znv40KKXzOEhuaHYc3ZrYZG7e9N/uIwiEKsS14Fi4VXsF84iyL5BfiBkiLDYGz97Yv3PK82RKQy9/yYRNm3c/0/zA+UNmX9SoLiW+pHbX2La2Pxd5PKsgEmhpfqraMjJMAKyovqrDRJpMc5Gzo9dn8ZWdV7SXPhBfgKPcHgBRQDHFD4vH3+niGAxZ6Rx5Nj3OFNGptdYxF+nqfUaUVNH1GnWODW09IKr086xAVQ4kbYuDqzxCRDobZC7yiCgGcmmUKJpGbiqdQmYeRLcHnzRjdHpGSFAPM7rXmUpobzfgiQ3ZoGYVZIOLjbe9H+Sijy5iI5SnfquNjSVI9qgJS6THcrMUzihAwiC6Y1LsBUH0DCpHkST2BDWu49G6q5AnqJV+wMv3v5rWyVNra7O0T6kuv1vbBC1H6Fzez6WAmz06tskxhOkxOiYNGxPtGbTdCYXwqZ8W7h2Cab9cL6NjFNhfj7tM/jBatXABxQf5a9eGKAyM1qXCYLLPor6rWIkSxcewg1S7iwEolRnEIT+AwlwBOqO+OnUAK7vA6NNRiRUsCqarv8wuNtYalEHmKQ443THUb6uwbOWFFY3UYPWAWOrAvr11q/zgdEfNLxVbFdFaF+gOc1EhhWwU1R07MbXdy4ekjqgaScKAa/ibcY6ygqKUe846L5oRYb1CrLi4rifUIGIEVaLA8gbVV+p5XdRaAnWBnMDK4F1vBjxrpCAzGVCdCa7gjt5dK3qu5VTzmfVyJUwQPkicqwFzG9uX2GaCSaBwwLyMUDkkGEFYofpMEAJpGaCqicvw42ZplcsgPVnnlh7fSgNRZ2smZ8RHtHMxCe8c/6OzGuH6EDDCvVbHCfADEEZlNEmDHz/vQExXg8Rd+j2bqRBKWdfj6OIbR7/+q7gR75+XS+mOzMNJfGhvnArAwLCIYUpanCu0sJEYg1ABmg0BsrlNCgwqkv9RkFTjAj9DY5PE2R0OF8ZquszAOVpxUmGY1B6cADtN3ZF+B89f2rD6wGSWjSCjtWOGS1HHpkBmDaTG9wpqjEyTKm15dFuhFPxP+V1FWRDUWcPMaaLu5r5E+tEyIcpAOuXIUFub2eYgsLjlJCirIWkKjOkH374ptxPqtRMtHfff7ZISqzPw1B9CI7zHS4KMIMMD2/JCxYAp4gsWExoUFZv5ogM7YFZjgXCsAi6Um/AUAdQG6Hl6FOEPgpEK4yYnfqY2jtx94J5sAAEiG3v4QHa7BBcXtvV2dcJ2TKvNNTnwl8HKOZxZorlBQXJMcJAEORTud/A5ywW3VDCp5YsdYHsUFG59EKlJCCCkNREi2mQtFfdoRhX2AAQfDPf/rL+OSTT9rHv/u4ndzSwspqYyQtctwVjDHaFU1OQ1S2c+Y4juPYWAfIXhUL0rBUgaTuUEX/THzi9sEBhE44RX4QoHSGZYmt7otoDbxmdmNSMWpvhRbWv/jbw/GH3//R+wJEfzU/X0pgNbg8f26ciJJWr9At8Hl5LpitaxSZYXsGxwBb8v1m2xMrCoGCIMAGu5aNb1o9SZbKYhEhvaicWRGq4jsngsSqRutvXnzjwYiaHoz75HT387RpwrsPXAEGM/JXijva+YwOlaQl7G7sPGUhGGrwvqO1/4B6ZMhhBhghQ5/HSOPEsO2wMdtyYs0mCTc/rTx1hsQXCFkNV+v92PedSqJ4P3/418DGB7m/Dp7OHKUDcJLK4I74jIv+1xrG32xaWNYU05N/ud/Hkre32w0cQN2g0F4RI+/vMW4hxkAxQTfVZVVRglQXAJStFxusdQOOYwJ8dP6eNBrpD2SI4sHBkfDYMocCENdrFIb3ZIDs3phpRQFB4l9Ljz6YoCaHVAIAm1Wg6e8tlrWhF9g6FoRrRBAOPsz58UMIEULDOA6o530hO2t2sJSiEDApYtdI2QAauLZcV8wcVMDMAqs97kkwAEq+rI1H0DQWHu3H8rXljXOVrrq8aMhrjDrtbotiPTGSt4xttL6PNs4wPZUwBsBncviJA0J0eJNCxrXa3FUi8pPcj6trl1hrHzmLK0OgNygFnNTaZm7XdjiyDZHF22Cau7qc5NptJbjYHATHD3/1XwifNjg6PXgPr9rb1vaGNLRBztY27FvCrVvbD83vQ2W1KFEapBmTR4GicXmdS20nGrgwuD3AVeRJRRHCGAfgWdf9l+/+zV/UiRCALG3w1tXRNdXMXj3E+U5xggJubFhoXDI1f+gDS2Hs/FBaBA8EumLbFjOV0dvHhS+p2yM5czrWf/Sxl9TE6NtG3zBen5RYPUC+xmjXxPE1HmNo9e/f/TSurq9mFUhkTIvc/rJt3FMga4a4wL3dkWVYrDSE8zjXt1f86tSE43gx9rFFZ+7wSdNE0SyE3iYGqJTBTxChRxsHIApdXW2VS2cYFt4RR4f7B7xD1DrYC8hAU2E12oP+04dfRgqcEJlsmqJPr30CcDuNtBZ4BRcClrF8xYawuxkOZTKUbk7l+rzDAadEKEjgxHPcPUCLEGFVSJK/2mXwTFq/y+URYiBJ6iH29tGkxz9++/PgYNOZIAKn9k9TlEGkZigiKm2tpEkKPkNF85HF5BQE6vpo5h8cuRRIK+a8CPHBabsHIs7/tHJhjqhpydvoEer4ne0dAU8Yju1weoBCIFlm6z+8/2k2RCS86G12jKYlnkml22RxvXRxUvmFL0pACZQ2WJoXNjC/XSnM53sSlBZQ7Q6F4WWUbgMTidYLitZscc7vrUwoAcLH/ckX+vfvflRDxK1sdYdHO2evwNwQuSY9GXwiLrt2cK3G5+oCw1My4kohpP2+ywPkNBp5CaxkKWSNZINKcgSWKouSWaIYICk3+wBotTFSDZS6m2ztHOVQ9UH/7t0Pg80QzYrmHoFsn03Pj+rOFjp3kOeaQ34ElMGBkAUsVilQIJr2uMbcFsbewlA2b0YFl0Ko/tVSPAw5Rjs4klTlx8zhaTERZLT2wEbCOj6KB3Au2doVFcDY9tZ3FtZsgbnKMx/I1ri6H7icoywRAqzcC/RPiOQbgePaD1R8VzZI27tMcNMqS6rULpIlcFhnWuC5BnaGwLJYF1mge5MAxTjcdf/w5ntyooy3tCF67QBnVeiN0OEKWPXkDQ4RytU7dnjlNUdeJjZih97vb6+Amya9QlB0eGD5ZI45JipxkL02OYctGWeo2ZZ0WpZHKWxEhwXWVAKpMBSQIQdui3AQJmhSlJE5MgUIUn2lmZpBiaiZNj8bF5ImExZpVlCHM4SEIcvNlyexwxNAs3fEeqJhIcMSkFhknk6Qm61w0WE9YKFMc0IvtL9//WE+MJGWuLa4eCuc58rp9OA4QgT9NDZDQajTJPFO7N63OysBF0r3NliQqU1QT7wb50kkYUV2dDpT2DNwXjyLbXIrEZ1f/FaNl9QG8jhey/VADLCNNk7sg6IpmlSXbfHUYnlYQiGiMflShG49R2WoIIt7uHVO4V2NgS1GCUH4gObFrm8LwP3B7uJwCQ4DG9jJr/YAV2yLOI127YKMxZEKIC0CBiSBePtS+wPynEDS4SRAeY6oNETUJ6lb5e1XefojYzYRJ1w/uzup9LJHcLlz4j6FloCOj74osvSc0AybJWymyTVd4jTNAdQIQYW3D2yQpPS60HHsrb9+/pZESOQnbu/t8uZpsT5iJl2jGLumxv+/UyT7JFWJ9A6qPvdU4TI1U8C9tYtD4qDoordAGUb12c6zxKv4kVLWbg4a2o8eeB/DfpigrpbYuzUZ8vgre4DmgxIxQaa/UJiTNUmR54NKixJUGLK24d8HTwrOvM0eaGI5YCkQWkqgk7qc5vZZb7SQRfVKVmBsxxg80U+LsbnIO42274Km/ubFO16Cd8QjM3NDpLyzbqBSzKMU816Ce9S5ClnLazYg+TyRa5ps45gzBg6CsqUvFq0ENx0CpjR1folu4xjY5tjbscM71YtUSkZXLQ9IeTgZbUEpUdLXT1/PjlBADW7OcVlJe3Pfn4lRiJOMqMx9HyQDmKov1JCrW+5oC3NfnAsheJ7vIU/SJFr3EIYdx961YQvH8fhbHoPTtFqWtv4sqEJ/6XR6xcsnr8pjc35azMTnojV+bwNliqZggLwlC7D3ZDudQ4MuV1IFlgOlYTEJl+pFy7nzLAykV4ku4dW+hzsr9KIQjQt2eAXPVUjEE/VZD0/25zcv/cCEN0Z6/hfBkB2iLT1MlWeE6uI1WQLAzL0CZhxcWELMIJtZeXRxYc0Z+m7J0WhasLKP2u/3MQVK0HwTY/qEgUOCOICgUYsJilHq36SAuD4L5rlb5NKK90vlADUbqtZ+Bqi5niybTdaYR8k95QkO+SR7P8+XzRcB0uXeM4ssBZRmZQAYwqWmPOwZGfTAQAlLPjQFhT3557PfYkA2RRS3ZozfC4MIqhrW5bIDW4KL0sXvGds+TwNUKXmGt628vsv3C9hwPinsBe3SdfU88GUG8CBwJop9d1PLXtGfPnpODJDGtSc48/64PFE1O8VLCJBjmjZHWD4gnU5pHq6wr99XRqymMk1glpfCxrPHNA1mKzipVmdfgJtBMJRJzwgv5azP3j568/DJ9AA2Qoz8c9NDeU6oVoMphLLoACDrBKLNeuACHxUmlxupowCN0dJyM5dQ6M/KJooBe8vaUoRd5vqV8mAMhN19zBAVxvG99ZuHj/m8gATJhiehLDZOxtU4+yu5fIKhF0nleP9wOAXBqDyOM8PEiggY6hmEhG7SaviivsvG64sRvcOBw1SnuOCOrs2dqvO7KCopEbf8H4qrafC+RB9gAAAAAElFTkSuQmCCiVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAAFCNJREFUeF5tW0urJVcV3nUet2NA/RMS8046Mf4FB5qQxO7Y6c5DM5AMJANBByI4EB2I4EAyEHGgDiQTdaAiKhlIQJEoIUgc6O9I97nnUfK99l51Olc75946VXVqrfWtb31r7X2m/37wv7m11k6nuW026zZNU5vn1lbrVVtNU+P/Vqs2TU3HVyv+m+e5rddrvk4Nx9dtbnNbr9btNJ94n/zgHrhf/VlNq8YLGz5v5s1xzTSt2ul0bPhA3QHvn/habtlOeGpcx5eZ95pPc5tWE19xMq7j77Tv1PAb7onz8e+Ez/zgvf/M6w0MaW29lmEycm1DYYyNbjB2kmMmGCUH4Hw9Kv6Tx4bj4kA8Hf4/NxrO04qD6NAT790N8jk0Dsf15HIITSl/83jMawyAPIIzZztEQcYxGB7nTe//89+zDIcDhAA8m6LcGpyDe+McvAIN+KlIwBvr9cbo0cPpPvqn6+QMPZei7cDp/BUslAvw0FNTMBhRRxqOV+AVQTqfiIHBRgKijcj7moqg+XQyEnTd4Xhs03vvvj/zo6fJRiQ6w4AVHh4Rp/GKEhzSDfQxoCYG4Fy8j4ejs6aVDRMyEqE8OO8dVPjhCVE7MffBK9xEeC+Syo6xM3ItTjryGiNjbm1/OBDFjMe7f/vXDAMTVcEdxo6cjjGCLSAfpCg6QgNSoxhBp4o7GHtGL5HXq36MErzrexEZfl+RVOoF/ogkAW8HE2G+P2BO5/Bea/JJzmPeH3Ht3I5HpHZr09/f+cccQlOkZLwQoSjigwP5OD2ISF7nHnlwOi0GwsEm1h42fDgctoC58hbXIoKdHI2YEG7SQLhXynTIh9zaxFRIeuS8/f7Q1ry/nDT99e13Znh3s90I4s57sb8Ij3yAvHdExRWD1VE9UiGIpOR+Xgsn4IF69SiEaVvskJE+cSIj6erDaJ9OgnYh0yCjv8aJrbUj8n2aGHlWFaAHKPjLH9+eN5sNHxqvMQz3xd+K/uCDVIRBliMd4rSQ3kir8AYgKQfgQXDfsPwgP6eGDnRuZ04H9p3g4C8YpDLXUyJlz+fB+PpzOBx6uZ3+9Ps/z4gwHgpeATzwmsij1PWyx9RQzcfTiEjE7uGBkdP6SEY7US/lL1pCuauSRuibxII6FHzVeXvExnX9YBedVwJcE8P5GtQ493E+nfa73/5hhtGAlwyFMwDBFUtgCAzRQqkTCUonCH2VK+ScHB9VwnRXS6NLaSJ3RuhieuZ2ioPQEkMlzPT+ogSejkRXfnA+UiX1v6cO0gIO+PVbv5nXmw0jhZwIF0DRIcob1/doAzgK75FloRatDFPjwROKnlQhXWTUqP6L/KIF9L5STM4At1jw+HzpFqUA3unEZgdRGM2tAdr4bLyGFOO0cABqP5yBv3nPX/3iLQqhzWYryFoOJy2SEkQJSNCCphvu8kcxZSlTpbIEj8peFGNXjhZJKY9w3hEyuKhASWNHlMpOdElVZ/FD5Ud0KF1wDzr0eBLbn4ScXA0H4T1ywc9/9ssZ0U+t34DhWcIAbRxXL4D3RZKjJPZSZ+5Qz+CS599jrESgK0ohsUQ/Oj5GxXGmh64FKGNdx6MRQoIhRCFCDtnv951bYDBgj4rSU+knb/5UVcAcAIzibxrviIcjkA5h9iAED4EyGK0AhChFTuwVutxBalhOnyOipsM5Fwy4651EGb8TLagA7iMCfTzDYb/3uSI7GI7Puby87NcwLX78ozdnPHC6tTgDSGBVMDrC6PgbDmElYA8gTYDrE028L13gKm5EhRsGsS65gKTWVV+6PKVQRFHq92B963tCX0YS7rjmNLfDUXDH3/gdRqcCMAV+8P0fzjBmi5rv2p90iGNCbOCH/B5S7GWS5DikcDijyuhI6XR3tTNk3jL5pSBTHVIiQ5CCrzgFBgntcIJyvzrgCDJsjWhAQPYHoGI4aX+5b9N3v/M9coCkrw0EKa6dFmb65D6dAgRwXiD9kMjnmIRTqQTOg1QFsZw6ykhjwFhKUyengendn4UOWTyVwLKXET0e1d35WpQ7/I0o4yfpAQeBF3gcJfZb3/x2J8FuEAlPGiBVIQTIsshmSQ+7RfWwgeQIljm9n1JaS2Te731Ab5JWFEyZvCQVuiMyxGAEpf9jHJkfzO5zcFxMf1Tv3xpzn2kAVBgtRNXX3/gGy2BITR2ciBDCiLB3FSD8ee66iSPKDMFTn0qUans9O0A5Q5SJoFCjKgNJELxBBzj31e7xGGu/1Vzqd4yORgD8a26T+JzvdIaVX0UDe4Gvvf4GOYAqcDV14aNqgIfVA1ejMy2K0wj5yGE7k6TprjJw10zAkxzLbRd91XTDPOdEzIT5OSpzY4NzjgdEWCRYoR6eiBPiiDivkyQc/9XXXmc3GBavxsXwYajbZed/EBBDpRI16yM3ZJ7InFd/oRQoI7TUPc8A0/RkbIVXPDAnOCS1oeK61j8cmNeqEEfyx/EINaguECSpLlCzAlYLpAE445WbX3EzlFGX5GvITcYrLRaOsDLsfURPk9E+i1RdCo0w8UG6y6heQT0DDBKf1R91PP8eLF8bHZEbqgZ6AP3L+0SCHRg+yECE1QIp8OL1W0Rcz/My7dExMXrnCJybZskVQIQXLSBHDsd4MOrOMXO92sePYajyXVNdOYHEBokL+esoEvaWucntwLpGPOmBVNH1xTkundP1527Mg7XdCqc9tmPyfkVBFUYZlLATdG/AEseWWf1DZoK9FDoletNiAdSh74pAweMIRxtgppfjJD8bpmkwYK8UEAf4d/cE0AKiIafAjWu3OBSN6mNNx4TIwqga3adEHnKmXQYiunQ21HsZzEwgA84ulZfTY9Z2RltGJKIxKPpejJ5xtwwE1KUinfMmRTiEaXE6tv3+ktfhXE6SqwM48vZwsnd5FkZygORvdH7t6rpUBvFZJFX+qF3gmDmUMujxuPoBaYiDIatFDfX8aWAE8RHBdI9BgdAhLmDzczy03f6yHRB5LwewX+MiyqpNQMC5ElTZUiOz3W7p3QxJKID68NSRL50iEcThich0zBPGaB33w300mdXITamAmYCjqVroqIXBTYTmBkL8gNIodScEHCh5cfxyv+uRx/GoSK5eubJMN194mVUgRIgHBphgeCRuWuPksgy0UAoRluFIVYHqMkGQtTPMKFw1UMOQMeVP89OHGGha3P1VTUD9T+a30a4CMnzPXiEoGA7WOgUQwMDHAZG2PQUsbJLnPNn5yzrvakFjS5O04IUV5gcyMlUkBqf8p2usDpDgwQQ3k1yoPB2TxhfB9ahDBxz2/Hd5uRMC2BtA9ooH4GTI4YvtFS/DWYu8dOPLVNbJ9S5+XPfZJHFKpFIXFGhinBWlIpetB5Y8oHIqnvFQtSwQ9AUhktuAvjo7sLzKYchRym8vIrPxl/vLdrnbtcMRkRfpMerT1PaYAWShJouxGcW9evO1OQMFjrv6eNwDUhvNkZlXhHsHaETUjjCOGRFXjocP+CAuizAgK0pqZYWLKnRS+qL6VAWk+0F4gP/tO7cZ6Z2jDwRklVEpILks6GMsv2FqEMUvXn+JHJCujoyP+R5yxNAOrLfbC9BSXwLDdRyhGS1ZR1BzlRH6UJHilNHy6m+6pE9tIZQY4QL/7hQQ3qTWFvDe7e6wxO12OxIeKgGQEA6JSMrIDM9L9ec5JT8ZHJC2tUpdsnjZDxCOwAQZD73ggKoIy+9jiW2sJ3AZ/GyhNdDOg8WATHWo4lzD1QBp9L27vENHAO5wAuHv/r92g5ke0fliJEvvlR1QhhopXzGQIzCPx+piCbnBJXGMyER22y1mBl5m4729yuQWN9xBRywWQbVsfx5BnJdpjyB9bPuDjKYTTIBLo5VP6gRFgrg3qxxH7F6ev/HFW3PWAlL2UAJr9BMxlDJ2e14MGdJXmyXWXh2mo+g4jdLVapedJdlQ4VciAALHY3WVLI+5vfDJ8sf6fyLTk/T2l+32nQ/pgNEApVtU3kdRbtbbzgN8/qwz3rz+8pzyFhLscz9PfsYcMOuHYzQOwzoPZN3AzZPSBp0lvJ5hyFhUDQL6woe7RMLYw5AefXeDKXMwDBwABKTsqXRaKs+oFIj8GMdj00W9L4vESzdeVe1xecpgJLK2R7/Xfas8wlflbVQBj9KcayJPlU5VgbIVpwuB/JLx4Ch3AsLY5oKIU/Ts921nlYdjQMCQyFKNrBpOuSz59VacpOvB660vvULERY6i3GkUplzRdHeMxxerwyyDmv0JPR6nnc0GO+lly42h7qLnlVqVqdoEZW0wS1kgPBiMyCOvUfbwD+jCun/6CUrtacVjkvIi7Uqu0STTi9dfnpOjXPg0fLNS3OcEnvBgTIYhhTS+4J1zovgQb43Lx1JaUMINFSX3+yygL4RLCOF4hpzhh+Q+EAAHoPSBCLVAos1PsCWLoev1ttf9qEGVVPUMJOMb116ao84W+VLm/Iwymxs1LekTzuUtRZSjT8hvNoxoJsk4xkh4E0UWNfm3nZKSlRKIZyIqWmO5w4Nf2gHR+2MIgpwfJS7CapRXVYXoCtyvOwAnpSXWPE87wrJCRELzemEiTYNK3Q/UVSI1NU5l6ejI6rGYT+qMrbAGKHU0nhkfJXGf60EB7i16wv4qjX2U5j1D1fBso4F01vqg5gjTtWdvsB2moR7RYZWIkfOOEa3pqX/O4kVgn+FnjI2OyJSYju0DUSm+tNNaA1D0kd9ysnoF1v0y+MiwIwujZHs4JQMSUrrwLdE0tsrhXjiPDj1hTiBdwKUxOACG02hrfdxke3HBfAqMBhfICREzWQ4DzNNTcG9h9hR5g1Rvrb3PKKMwcAVXaLxAQgdx/0D2/nk/gNcLKJM9Ae5tc8ZiHqamiQoXwHBG3hNjGS/0TM8/fX1GTuPkMD5zF6u+ZwpQ1WIsladRWbTQ2XQZsWMRJMO0HSajNTotTYrX9bkLBQNLLf9kGZFRE0LHJkktfU9ke+oFj8BhGBGVvsLrB1xkcTpxQwX6DSBAI2kZRhTUXt85PnJYJREPjgYKUdfWGUlYtdNSiyynSa2y96/ygqCk4WlSsC6OkhQ9wqLx7gmy9ohI4ndtfAJR4m85YyjBMVFCB6kxm4eizz/zQh+Lx8hIWcFY5FhLXVhdBo9tMPAqmyXlh9LAOmKz2rTjjMXLMQ+Ec0SAZTts2UOAazPUTDqSxV0ZcP8siiYlBe0YrHKXtQF8ToajCBRL43NPX++7xOAxNj/eJZoPvbi48MxuGJQPlJx1i2s1yY2IQJUNJNt7kcQzirEjLQOK+MVISTmMv9DGagl9bJYekKeve14z8tw2k7I3tshwo+R61bg0juA8+4VrXhfwii/1sm4YsUMl5ZHYNGtCNByQaY+WvOS0sfWd1cHTGHg9YiWaIvVfZXhseGZlAKw9pMlCiJ7MGx89J8y21wH7I5GZzrFDnoNQ7StApeCiz+c/90wfiuIG91y5RxKYpfDYrlxc8UNrdRd5Tygd9g3I0JRIHAD4cREV4zJvjcU9MUih8poxZb7gypLk7OjWPvHxT2rJe4/Z3qHd+7F72+3d7a7ZL7bbdmd3h4FAnoO4MeOjA5H7l9oLdGd3u0tyMD863Q8//LDvO8A14SAG6r5PfXrGA2U5KjmqjVLK5USQwwz2+Zq1ZavLSHlNeLqw4awx3Z8p/a5Z4OCE8+0xQoWnhN4TkMujIrNuIMXoNjpb6oxErS+qqqR0agg1t+n++x7o8+jAMK9dpdWNz37eEFf2CqW5SGoIzmOT4zg+VoRSRqNCqQ2cMoF6tsMkrQJn6ZPlRkk5cBgZrcGU8Zb5pFla4OnB+x9aOCDGJ/J5kDB2NXDIZx7NUi8vSXeZcxLJqL/ct3+eGMA8IGFU/z7/Pc7tZNl3lo5vg9RvhqSE5lOyGWN64P6HRIKZTXtcnDK20PILghvQrU4Zv+v93DbsTcMM52r8OVoyOwySarlMqmS90GBYwJtzhIzS3Xf06JcdKdPDDz6iRblFY5JN0JGo0QOKdNbwFMUy2XUUo/hGRVCZPDeqT4T7nuD63SDdu0pioUpqUGDJ3uG70bLs/bP6JIWZZ6FTH37okTnlKx4K0aVEpX1dwnZ8i2tEskZdDxVdX8lwlLzccbzGSB0RcYorxCn9uMk5JTDRluEjnXp7HSj5DkmP6dGHH+PpfKj+VbWzv/3pvXw443NdhfLSGcuvyIz+fCBH0I8SzJb5gDKVoxhetEKF9HBAXKQUKPrKnaK/LGGnTo8/erX7lY9lxtc4TaXO7ZrLYRqa0esPhq4pUaOb8ljJrX4PUJ+RyC25YTihRnkgRL+pWpQyV6pQbY3VEutLVHzuxx692r81hhuNAYWVWbq3s+HGeKzCAZ7ACvqeu/u6UZKW5LhMglpJxj0S6XFuOsJyxLk90mV0jQlQym7XArDt6mNP9BQIFIdSKvt9TecDron2WN/vuZ2Rlx+qAziTmmR3LyRyYmp+re93s0TkcvREttMPBFWN0Jdbs+X+TCdMVx9/kkPRRPRcDIXR86y1LOrhBtmlVlcHiifORZE+Le1zdVDnI5PWyM9xzTkiUg713QIto48KMfqLrAl07sCZTzz+JHVAmH4hTOpGpnNJXBARA87JMLU9u0GtrfPSnTCu87gku0WLuDpvm4cTUu9HM1UVYMqoqkEtq0bQZ5546i4p/FFVYUS6a+He248tLpUE/WVJ7/0ZUDZncJ+/xtjDI3mUSooDQUuyFeRjLJy4IDsjrxpetUFPdzigwn60smlrLWK4ZnCu/vT9nkp4SYtx6iC25eXjW6cyot5nDEgS6aEdSlIMYWBH1DRJ9mtDFD4j2+iyJZfheurJz34kCVZYf1Sdzw7wGpVzDRAkpdYPxrCbCgmWzqmv8IQnhvGB8XKKdHd5BDL83WI6yV+6UDtocaUZ4/8BBOJxy9ElMcMAAAAASUVORK5CYIKJUE5HDQoaCgAAAA1JSERSAAAAQAAAAEAIBgAAAKppcd4AAAABc1JHQgCuzhzpAAAXsklEQVR4Xq1ba4yc5XU+38zsfdeXXdtrbAKOY7fYoQIFKkEi4rsNgpCE8KdNI0KhhEJUCpQmqdIipUklpFb9UalRwJeUS4GGpJGqUiVplFspqcKPSgai1sW2fLfxbXftmb3MzFc95znP+73rqD9QPcSZ2W++y3vuz3nOO8W5I9NlURSG//C/Wq1m+BsvHvcP+P9uWZrVCuuWZiWO4pj5IT+m03GsjuNm1on3Gm8UF5Wl/9np4lQe63RxKl9lWZr/h/du1x9cnY/jfpZ1Oh1/KK7Fe7fT4SL9Wt6z2+1a2cXfXV90p912cfR9cfZwy28noaEA/1fUuDI8vAZZ0gurLqGuUARXh7NL6/olvF2N+vLn+vcQyBdadv0ohORi+Q8vCSUl4PlSFM+j0iCYCxfX8p6lK0DHcK7Owfc43u1AEWU6Xpw/OlPqoRAaJ0EBuTdg0TouIVyFRSELUxJ6BHTQcMFDMRJOKvRFJb3QWm6hsGyuDBnBBQ7huN7MW1xJnUoBcW43vArXSmnuFaEEvw8UgBPa7bbVG3UXo1ar+wPcjPCE8NN5oZFWYF0rXHC4vUJDsvolFMgdxD8jsOi2sHjX37tdeEe4PywVi06hkFkzWV2CxXfuQe1O8ixZH4K69bN7YGH1et2Ks4eaUrxBY3B3D+b4597gyy+sgEMjqHHMrUaX1vHwighjRAm+h1dRcFozFCJhEZ8RBgoHWUte4S4LITwi6dbQFtaL+IaAuFaeBWW6wPg+lEkPYj7AOiA8Phcn35ksIQAO4JtOp50ElDJwc0+OUgLuEcrIFZOyhCcx5k6GT7g4VZMSV2jqV9wfAiDDwFVdGcnCEoy5wC3r+aBy/ySklTY3Nxf5g0rCv0a9EWvCsbYVR//7rFcBCIgvoTFlVQnt7zV6hWe4+JyqRyTRKq7pJW4pKAOX5S7ODOjf415VMmMecCv7hyovUAlVEpRbz7Xn/Fn8G0rBNfSSPAQgE5M7knClkGL/3uNlo9HwuK/VGPNYlBJRvVZ3U+I7WVslM/9biTK/Vg+TS0elDRdmOKRYx+I9pqMaeIbv0gtcgVkSTBanF/j9owTmbt+O0FCewRqR6/DCu4f8vv88UrrgUECd5Y+lsO6L43c8LuGkLFeA+3lVRnEMC3eFREzAMxw0wLXjqHsLFOBxSSFltaSwiHkoRkkMnoSFS3HtTjvlB8W5K6UszRUgTIFcEVVBSnAF7P2P/yl7Gg1mRE98VAA+IyQ86UExcUw4YV5SzITNKwW9iDHPWHb/TklP5ShyYxLMsUIXHkHrIlYZ6/QQKapyc7q7K8oFbbtyZ+dmA0wxd+B+UA4VGKH+xk/fLJUYoIRGo4flzxMjcoJZo1Gz3t5eV47yxaVVwitFIEdHbnEPLAqhoNIl4WRxZekEiDLPUOanW1MRuG6ehY2Whhcly5ZdT4AzMzOp5Ep57SiTuDfOL177wRslBJXAcn8oo+5Wp/UHBwe8RCIneD5QVYCgdZRFOjzOTWApMriHRZQ6fdaCcJlQnJ+TgRglRCU8IUEIrFinRVniFNsQ7MLFCx62wgVMjCW9wktnm+v83nd/XMLqEBaKcMEjHFzYUERvX58NDQ4aEqYSHs5zhUVNhWLyl6ytTC8vgfY9sSl5ZcgwQdc4JgzhQnrZYwanS3cd21cgB1bt2PmJs9Zstqyvt38+Duh2DVVDIdBuz1nxj3//alQBJj5BypGRBS5oT6PHNYkFLB4dtaGhQVeQJ8WIfSgPlQLvBCulu72/AvDg+ka97u6aIz4/PyyI43Jjd/MAOx7fbrGqRGLxuPnc3Kw/RrgA9//Rz75va1etixBm/OP8i82L1tvbx3PbHZb75555uYTgjH+EQs3OnD1tgwNDNtA/YI0GrExLDw+N2KpV73fhYFXBZOEE/Y3wSJUgkk0dYRKJMMcEOTyt8gDKWptlMSytzM9+gO6OOGcD1LWZ2Vk3yH/te9v2H9xnK8avsoH+IWu1mtZsNm3qwqQtWzruIawu0XPA3/zVNzwJSgH+Xu9JiBCfoZiZ2Rk/Z+2atX4jxbtifl4HSZOkLjLwU5Q9lCbGPRasOq74TnXdQQ1rtsonkR+syRqOa6AEeRHc+zv/9HIA95qNDC2wvr5+Fxrv6gYF+WehtK8++VQJ14SVe3p6U/xDKVgAksbw4LC39Shbo6OjdsMNNwakZNLDtXgxBIj/Pf7LqADiAYD8PGyI7RkeAXU7RGpz7dnI3F1DjXf8ELyAJ7ySFcE9wl277SEEq7719l57/RevucH6+vp8jQBB+Lu3p9crHGTA+pQwiyce/aJDYY91VwISIkMCSdE7No/fhk1OTVhPo9fuvP0TNjI8EsJHs+RlD6iROcCVgVxQr7uVkSD5zvOhXOECPERxKTiNv6EAmBfCubsGknPvCe7AQyja25deecFa003r7enz69pd5Ak2criHOlEmWpAVNSvuv/eBEouCsJ4DUPbqNettoO6z3EEhuBhKwrEPXX+jrV/3wQo4RcLz6pHKIB9AFFixNqoSLgyU4LDWY8Y9RtxEBWPV0RG84Dy3elQDVYdDRw7ZD3/8fV+T4lxtrlptb/sDHapnKD51192hgLovtOoLau4yXgq9dw60GPD3M799rw0PDQdCRBjQn93NPL6RxGFtEh74nrUfodHxZykBJjdX2xuorer76QGpHfYusfSSJmrrxZefT/kA4SXYzoYsIHe0xhX4MivuuP0OcoIet8L08/kA5Ag8HK4FBa1aucbWr19v1/3G9QkZOoMUYQDBoDiBE3xGGfIePCMm6A1Mlu05fu8JLro5d9uwurwD7q7v3aLttrWmW/bt7/6DhwIbH3IFiWQJLtA5Qc8rNfc+D4mtW7eVquNe3nJCNKPCBGJgwZHhBfbRD2+0Wz68gZggEakqj2yEBI3V+OSACILLDXNwg9hP7W30+i5YxDCVwhiGMMhPBw8esNde/zdrtVqpSYKHeRJ1edA/VDygh5GHglmxccNG56JcCVp0AByBGSlFJW/J2DLr6+2zRz//BKsG20GGgYeIUo8HQFqEvguGLJU5Z21N/XsFahz3twl7cVPB19QoleZhsPfNvbZ//347fuJYauM9fBJzRNwgVOmKFzTftHETWeEgMODu+YtuK2acVNLSJeN28uRxe+rP/9pvpOSoBkmlLlWDKIPiGGAZ8gxsbObBXXWQVthsezZVAWZK5hkyPbQgFPAv33vVPx84eCCSabDPImRCIDJMYpWohGLzpi2leHKnxYK7YxPELo50mZKa2fiy5Xbq3ZP2pcf/1IaHRxIrTnQo3hB8Ai3nxyIuaYmKBtc5juhEggTaY3sbDHKUQ11LMMTQeO75Z23pkmV26PDBsLTaXyZAJWAxSiw6rDqhALothCbOr8gMwlsRiaTMFi1cbBMT5+3hzz1io4tHoxwGrxjaVNssToCsSbBA4vCDEnNcIJbHSRjAVQqo+FdeqJolAaE5271nty1bNm4nThxPISAgRgWKhyHK8KbKFV5asWXzVi+Dcl9ZXJyeeDRakgoaHBi0qQtT9nu/+/u2ZHRJ8hDdh1WAQEh5hZ+ICVyIyA1ifoUaNTSBmwOPqGRVcS96O4jRdsd27t7phpiYnAicQJZYJIpa8MrLuBrnLbZt2eYKUNauOjsyRI7mghQVsBnoH7Rm66Ldd8/nbOnYEoKlCJM87p0TjEQkNlgTGpVA3NsJDX8Ozxfd5S1v9AM5ZJYydN7u3bts0eJRm5w4H9VCswgqXUnXUWX0E1JssW3r9lJ8H05AnVeGdJY4LCV4jBsMDAza9HTL7vn0fXbF8uUOkmhBkicV2ot4D+vPy65xTL09LaJsXVUCkiQx24v85KxOYoBL+7tnv+mgbHJqMnJGRbYqv1HgQJPBP3pkb9+2gwqIISPKmxKVJzVMiaJKqN9Hmwy66Z5P3+sJEXhfVEgeOlUJZPgzHoIO12AjmxngHGR1PV8ZW2WLg03WdxwjlujYnm/usQUjC7zlVcVy3iGeqlBMSogZoYf9jm23BhKMUVFyWyMpGjxfqgS1mvX39VuzedHu/+yDrgAHL9FDVDhAswE2QJza8lXRYZHwwi016VFDlLO3EDiFT0gJMgQKeO7552wIHjA5ES022uiK2hczpQTqgCzmB8WO7VQAXl6bmbW8TIgaY7PEyRFe8ADAz/vuecC5AdJk0QV6KeXwhCVLcajJcMUHyNIpHsEIoWMMb0wJMKoGEiPxCiEyc0fXPWBocMh5QLzUfbJtJrUvL3BEmHWQxfatO5wSS2XLB/4xHb6kPwCrg5ui9k9NTtoD9z1ky8eXh844P3BlZsBJ7bHj7uABHaFhOBF4XKVSNX4uZvg5P6j+X26svAAlQAFLlyy1U++eSmM2Cs4qQiheJUNeGxVKIYAFQRF4IaZzlpfKYSODm46Njdnp06ftwfse9hCQAuk8zOR6OMtR5v6a0yeOn4rh7I4MkBKfyI+KBNUMkJyeQuKZnc/Y+LJxV0Blca6F7TUdG2EEIyqcvDLduv02VomYD7L3J4uiNpbC8Cb4jIcdO37MHnnoMYfFupbnBeujzRAhqMhS1n1Od9EBJoYopj2cAlVzQHoFur4YknTBAHExnjBLs2d2Pe2hCAVImVqrSBgSqhyGeE6K0lvs2HZb6YuO4agaGgnDvQJUoWr88uVX2ImTJ+wPHnzMPcBJiAabIp/1a0YQtBiskiMz8vixfSXt9qhG2SI9wdkBDFFQsbu0qISHQDt37bQrll9hR48djUlUoFci3vDG4CKEM7SVBQqAW4ieEr8HakwvLIjDE05XV1292vYf3G9/+NDjtmL5ypgWq5ushiM+ag9KzPtwUV/B8cuFpQy5q+q8cwABkUWIpH1AMfvD2nYBCY4usdOnT5FwiRyTY5J8bA7Ir50ixdYt28kIhQfgC47EGJvImur5cWN0fgsXLnTY+ejDf2xXrnyf1Qrwh4KtvJ49N4XWbC+1s5EHUMZ8FhCjrWq6M0e2OPhI9v9slpQnkChFp3396a/buIfAyZSnqqob7TiUHxVAW5pc4Tu23xY5CgmO8S/w4wAn4LCaJVSIRYsW2eTkpP3RI1+yK1dclQYigtHam+OgBdOXKGtkcOaC+8uYn1AUOULmgKSUGJpgsX4vMMeeOxiS7bm2Pb3zG9GhIgeQlBEVRi9mKy2lVp4NRmjzNm/10pgrLlYoKMHhhqoSY4uX2LmJs/blJ75iK694nw9PmB84dJCrK1H5VLYN9oZ12/v8GGww4WFKo9keeD6So84KR+6R9UmNc9zOMRdDALno5KkTaUaAtfq+pzra8phIo/uLfWvuUch9Wzdv9xyAF05k9uc7Hpb/rdo5NrrEzp0/a09+4Wu2csWVzhViMdxhwl0fnsCc55dAVIAPMjy22wnIiObyUujKIO1VTXCY+EiTEwBpMAIhd+3Z5es4dvyoZ3f3ZHWbQYU5sQPo3GYVUHgWmzZsKZXw1BL75KQAKxy4IPYOEgfUvQU+e+6MPfnFv7CrrrzaZwmOToMZxhSJI62OZ3E0Trg3hizt9mwCQFTIrMe6h0ZkaAEk94zY2yPcr8Tpx2PUjTIIBRw/fixBd6fnY8+Ae0HsJ+L0HbPLUAIUgEPK8sQAEIhekGdUIb2lY8vs1OmT9pU/ecpWr1pDBIhRXXu2B4rTuLvdmXOLY9oDT9AGLChC7ltZkjSXXHMWSgz3F1MscgPeMD09nUAX+IAd27fZD/71h/NaeA1T8vG8gzXNKfBpy6at7tkVs1sBnooKq3gBfAsFwAP+7Atf9RzgFSCSDSw9PdNKCRWWmpmdtpmZaU54ssoA4d2dS+YIEhg4f4azfXhiZCwoLeEJjLk9lDgkeeHF5+3mm26y13/+8zR9opBd9068ALpI/tb9WlWcYvNGKEAbE0sfImLRuFAoihYOyrtWs0ULFtuZc2fskYceR1T537hhs4WxVK+7NfrzC80LHrsQCOUzsbuO+gIIxR5e7SIR/udckCMzekW1RlLcur60F196yVauXGlHjx4JElWbrdifUHG0vc8GY0znIb/xo2CFq0GIGh6v+T2YFwrgEOYiByxasMia003bvGGLDQ8PuaJQl9El+gxQm6DTlpmuJ8X+/v4UUsIE8DKNwxC32K+EVhve4MmqzX2LUCo2PPiUWtvifJLUtZ/87Cees6ampqjkjJqPOHIFipzFPRHeXk43bthcUvtVGKgrY3Kjc7OcsMlZu/oau/7aD9ndd/7WL8yKqdJsqiy7Z2pFrV2W3ZGisItmtSsxLLKa3Wxm+y9cnLwO/owHg05rzTQNcc7cgFzBSTSGm1NTkzYyMuIehcVKWfiMvUpoxT3b1+ueCw4cfMcOHz5sZ8+dS9ZOvT862/AgykAFKZyKDbdsTHtYOQ3OtsOGFeQN+X47IjwkzAosCTXiIZgiQ6C8Oal6cu7w9FFYNEQYzcNL/Fjm/uwuaQR4CjkKXMuSizXMd3Oy22nCFLPBnN+svKSw4paPbPB9gjA0XKKvv8+1K2XoQi1+YGCAg4nACN4IhRuTqupYf98AZ3BF4Rb2OWGGz9Wmwq1lKYSHmGeEAOb7UIhHbswVkChVmvN5IvcoseGSEnFfjfiRlDXhdq7BgV9s/bvqqqudE3QBnbrXMASx/6ubnqTd1CnFh1xRnlyynWEKqQpWVw0LPU7MUQDXyDUsg9qBXz1RDA+ZMXagZH+IX2RQlVF9X53LmYAr9/2rVnM0Fq6vdz1uHsmZ8Xr5eZxmsekQ+aHxt+5zqRK0OAgv2K02WPdWD8+Vcvqcx6/PGWS8zBChRp8CexXJtu8p9pNyPrB6jZfBfBqUW0rokN3hfI+g4qrt8P59+iUIS5hejGUmoNzielbuUeol+C6Kkl4iK1IANkSqVJd+TmuOm6T1iX7HatasXuN9by4crAcIy7jld1QQSQltfPj3V99+6OK0vTwybOX0eZttLUh4xj52x/ppxXeix7QpUhaJvfsQRpbRpKgyiASsdpUrbLTXpxq6xO8XMgInTYUyDcs7XZlrPrDWc0BO3KPOahcXrvvbp561G9fduHS6bdPtlnVnxqzbbFq31crIvuwBCxdaDQqQldJkNxoUJURdok5T0FXuKYsqAcszsFi3evwuQSHsxlG8JNejl+SerLG5H7/m19b5DyZu3XSnffmxrz1mRe2VWt2mWmdstjNu5cmTxp70PbyggI9/7NppPZQ7Orhxyr0iPAm31Lgt5YSYgl/6OAkxXxkRlspNMb8UXhHcrXSRe3Go6ppfX1f+9J/fXvvujB36vyz6HmT3U10Bd147jVJa7QyL35hlIzApQLvCJVyisyM3qf8XeesJFWUuWvZq57oqQkV7J+/wH2xEkk5bDUor1l2zvvzRy28NH5kzFt3L8IIC7vrkde4BxN6xmTr9DhEj6kiQ2Q+l8uRLd86qilNasb0tQtSFix6FygumM2OwpdxLk63uX6xf98HyW6+82Xe5rI9FjY1Z/eN3Xt+q1zg09YeLGc4YYi6fGSLKR1gpUrxmBKpAWRJNZTvDKjhG2ptzjRzb6DRPthqbAfd8/v7Hy88++Je9l8Hw6RZQwF2fuLGlpIVQSAxMlvFxgeKVrS9BmKzln4PCSsdYZzOuklUqhUmGR0CC5uGUEFPwDA78zh0oV71zxkCoX7YXFHD3Xb/ZqjZFVZlNcwPfGxi7N6rkSLAjip7YofqRpZe9mFmmXaax6hhBxlyg+oGGhrtSrFeggIa+qlNvlcOHWkb65TK9xset8alP3tQU+tOkthqXwYjav8Opk7uu6jdLQupEuSxhFW2AIm1PL4rPwrwJbBGziKVWWUW7LkhX7NtX9k1M+C8//98vWB5z1oGmXX3779z8S8Sij7gdxrIEQgkS9lKraGg6v5/PklsIRrZIGyL5LnQputzzQfwqNfSZZxveCaH0xhtlNQJ6jyq4YcCKg4NWG23Y4FzTlt3xmY/8EkKx/InSJolSNTUUyNvksEQcYSrM4LPGcgkdBtGpZbqHRTznWV7llPcTeg2BU9UJv3qvCkCJGxqyeqNpK771nT37Xvj27sSvVX05LULIOR+FaVF8vPB9henpzoH0MoPkzZULGL9HSNOeyBeeW7JEmj/HKwBa/2jN8d3/AiYe4y8CE9W+AAAAAElFTkSuQmCCiVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAACDJJREFUWEdtV1tvXFcV/vaec85c7bE9M77Ud5umaZyQGEj6EPHOA/yBqqWhKKLiVoQoggekCvEAD0CBF/KAMChVlapSQknUFoKI6rZKHMXEl9okTkR8IYnvdm3PjGfm7I3W2nvPjEVPsrXnnDmZb61vfetbO2Lx/kMdiUQgIxFEZASRiISUEUhJu4QUEsLtQigAGhpCa0itNfiq39xn2rWmv+D37E6fFT1X9J2CuP/veQ6A16cEIITgIFyAdM+YDGDwXRB8WxeAAbZBKAusFYMrpaCUhpiduKsjHgXg2SBqDDCYEKA/vufB83xmhe7B62AA9YERuMues7YZ087gIQUQQvxrbFITuGdZoEwd/QTkaA6CKKJBlIMUVBbLhHmnjgVLg6G4RncVmDMPEYYKYRhCfHjtuvY8yp4yJHACEGYBXC+64rE4YrF4lQXigdgx9Lvd1LuavaXZ0G2WAw7DCiqVCsR7l69yAG6ZAGwpuYSKM0wmUkgmEvCDgLVSz4ILoF5sTLkDtZRTxrQImFa5UoZ4642LBwKIeB5kVWi1bIiBRCKJWCzGwXJ38HsuWpu9MqxVwS3VDE7AYQXlMgVQRqlcgvjD70cOBMDlIAAWGxAqxUoOghjisRiXwfdJjLZUNoCa6Iy6Dd0m47ASMnClbLIul2mVUCqVIH75i9e4DbkErAOz2BukrLY5CZAWiZEZoACJBdd5Gkbp1Vpbupnych14CSUKoER7CeInP3615gPOD3j3EGEQEqREEAScOS36zphUrR1dq5kWOwjuKKesTfZlwwRp4OVvf1+z0Uhh26/OBS3NBOT5fpUlNiV2yIPqp9ozONFv6+3EZoRXZvG50rAPnP3aN7RrJ7Yc14LStaLZTUnqLdo8d+ZH3VJrNVt7ZsICqrD6PevF/kPxwnMv6lrv1vtrzemYaKt644507wKwhlN1OsUMOC1QUMaQSMymaZy98288/+wL1rKNernv/99o6y2/9kN2MnECVPtP260xuR8w5abZIo2fPP/sGR5VB1kA19d4oTOlg+8YGt0zkyUPGS6FScTsdiBxUkZnrpxs62eee7FuiJEc6CVbc/Z9Mw/ox0PycO7pkMXGNWenrAEy5ZYN+uymIWdCWrIBuOEnvn7mrHb1JFpoKPmBj2iUej7gaOki9e7v76NYLKJY3GcTcYqu1rnO8x0b7hxg8E325DfcSREJ8dLZb2oG9jxEowHiiQQaGlJIp9NoampCMpnkDPP5PLa2trCxsYGNjU3sfLKDYrGAUqnMbeXazwXjpqGZZUZVRD+Bm/OH2cV3v/U9TZnGE3Gkm9Jobc2hu7sb/f196OntLQB6UkAQDQMrq6stszOzmJmZweLiIjY3t1DIUxAlLg2ViOpuaDfnAaMiY2YUAJ0ryOrN4ceD+OEPfqRTqSQymQx6+3px7LPHKIBJrdU1AA+klLu2KQKlkBUCX7o5NvbM9es3sLCwgK2tbRQLBZRLpt+rwnOta73FUU+gvmdMjRn46as/05lMC/oH+nHq1Ek0t2QuSInrAFYAFOlIUNeVgVKqSwj5ypXLV9rGx8fx6NEj7HyyW9UEtbu5BDw2LnvU8zwEnrPzoDpzxGu/+o3u7unG8PAJ9PX3/00IvAPgIYACDUMLTlOJfpr2FIBn7t27//KVy5cxN3ePNVEsFHngMO1Et6BjHAH5CPyAhxgNs1g0buYKs+BDjPzxz/rpp5/CyVOn1oTGOUjMAtgBULapUP19e09BRAH0VsqVX4+MjGBycgqrK6vY28ujUglZb2Q2DpgA47EEn6gSiZTZ4wlEozEWpHj7L3/VJ09+Ae3t7W9B4J8Ali31LvsYgABA3jJCwfRorX87MvInTNyewMryCgdAQqTTEdEe+JRtDIl4EqlkAxpSjWhMpdHY0Mj38XiCWRGjox/o06dP72utfiel/BjAFoBSXe0JnMRMz+iKQuHQzu7Ozy+8+Samp6axtrqGfL6ASjlkt/MiPtOdiKcYLN3YhJamDDItOWRbcsg0Z/kZBSHGb43rE8MnFoQWr0PiLoBtAPs2AKOm2kXlSAL4/IMH86+QBu7emcP6+gYbVFhR1O1cXzo5pRINSDc0MXBbrgOd7V3o7uyjIIjlKWgsi1u3xvXw8PCmEDgPYBrARl0J3IGbgiABUv2zWuPLYzdufOX990cx/2Ae29vb2C+WuAW5/pEASaI+1ciZt+Xa0dPZh8G+Q8hl2j6GUNeg5R0NrIqPPvxID39umJR5QUp5E8BjW+8KQigYJyZwKkWTUup4oVD4zrvvvIupqWk8fryMvR1qwzJ3QESaPif6OfvmLDo7ejDY9xkcfvLoHrR6Q2h5AxL/0SHWxdW/X9VHjhxBR0fHTWj8AxLzdV3gutoDkFYKQ1LgpdHRUX9iYhILC4vY2txEgVswZPejAEiAJL6mxmZkW1o5+8NPDqGzo/umVuoihLyNMpYQYFtcunRJDw4O4ujQ0VBDX9Ra3yEhSilJdKYTFBKQOASNr46NjfkzM7NsxWtr69jb3UNpv8T/4SD/J6eL0gk6muAActk29Hb1Y+jwcWSbc1cE8HYITFcUHmuJXXH+/Ou6q6sTAwMD6O7qpv6fhMAalDUiCcr+iWKx+EXq+bm5OTz870Osr6+zA5L4KHszhKgEpgUTsSQaG9JozZr6Hz18nMR4CRoXKxrTEljxSsiLc+fO6Ww2h7bWVuRaczwFySzIq+miozM53dLSEpYWl7CyvMxDaHd3l6k3g8icB8kDaN77fhTxaBwNqTQyzTl0P9GLoaeOoa218z0hcAEKtyshlr0o8v8DvCdEAfmL8b0AAAAASUVORK5CYIKJUE5HDQoaCgAAAA1JSERSAAAAIAAAACAIBgAAAHN6evQAAAABc1JHQgCuzhzpAAAICklEQVRYR21XW2xcVxVd5z7m5bflR/xIUoJCUid1jNQSR44DDXJDa7sJbVqE1AqqfpRKCIGEEB8IEH/8IIGExAd88MEXAgofQJJ+GBelsVoU3KiRH23sGCexYzt2PWN7HnfOQWufc8fjNDO+utczc89ee+211z5XffDeTeN5Hj59KCh+rjwoT8FT/F+Bb/7xpY1GFEUwRiORSCAIAihlvzTGyKG1htEaZa3lmke5XIbWZZTLGuo/Vz8QAL5fBaL6WsApKBWfXXQC0BrFUhHlciQAwjAUwAKAbwfgUYEJgod6d+x9Y4P7FoTvwfd8OT+SFZchQzCDQiGPUlQSADx4D1mqBmAztpnLwewjB2Ds0r+N5zO4D1+YsNcWCAH5VUDIhC0BsytHEXbyOygUC0gmkp8qQ5z5nuACIkLEcxRB/f2tKyYOynNQDUCuq9hhdsKAkZqWSiVsb2+jUMwjKQwkRQdch78TkLoM7TK3QXcBUD/qj3/4i/H9wAYObPbxIgxu2bDsCL0e04fQXiwWkc/viA5iDYRBgCAIBYBlwFIdB4/KkYCw5wjqd7/5vWHAgCAc+kCA2ExiULYctiuIgAuWSkUUCoUKAIIQwJ7HGlnlx8Ed5TH1lRL84ue/NERM5H4FiAMQ7C1JLEpLrxVVsVRCqVhEIunaMBaga72K8AgkinaFGFkdqB/98CeG7RMGoVDH7MmGzdyxEJfCaWC3160PUAthIpTspf+1EY8Q9ZfpAU79cRe4M0ukvv2t74gGpHYhAdhyPCq4aICGFJuNtCIzKwl4lontV63+XR1Um5C9Jlj1jVdeM6yrNSMrQMuAy56eEAvQBY8BUAtciFTyPhoWBcrsHzahGJR8boxoRAB87eLXjVy4xQWImJLzg4cBVKzYtqO1XC1GJgCcDQsIijC2YxeQAOOXxHzh/EXDBSwq+9VeB7QtaK3YuhwELE8uIIz9zvW+9X7rfrK2tkBlbZktzuR4z4XRF4zQI4jFQCXILggCiK3Zl6H0cEmIiQvb+lu1S587CyagmGVr+c53aFjnR75qATi0BMpMxILVrjVTF7EhVTun9Lxjg9myI+gPNCoBEkUVUTIxGzz2nGAvALLAMtDtdnVgf1xtVtK2iRCJMBSx2mmpJBjnQj6flyFFpySguP+JlOtWr6WeH75gGNjObdaJgvScKfHH1qRCen2YQDKVRCadRk1tjRyZTAaJRCiTcWdnB7lsFtlcFrnclp0TDojsG7SR+gsDrtPU6PB5KUFsHmRAOoFBeTDbMIFUKol0OoP6+jq0tLago7MD3V1d6OruQlNTkwRbXFyU497de1hZWcH6+jpyuRzyO5YNgqR6Zep6bmiNPPf8XgCuC4iQwenvqVRKMm1obEBXVxd6e5/AwOkBlupPymAKwCaAlAaOKGD4xo0bDZOTk7g9fxurq2sVECyHFaPzHc+HGn52tEqErlVIUxBYypNJZGoyaGhoQGdnB/o+34ezXz47Ywx+63m4CyC/29lIAmg1Bl+anpq+cPXqu7g9P4+1tQfY2tpCsUAWyqAW7BbPg3ru3Ihh67BXRYQxA0EgMz6VTqO+vh5tba04+vhRjIwMo7au9qee590EsC2isbvE+EwQncaYN8b/9c7x69ev487iXWxsbEgp7B7SdRo94StDz5rqDaMVoRLxJZMJ1NTUoKm5GY89dhCDZwbR39//V6XwZwAPoigqBUHA4JzRRE8QPoA6AE+urKx+/8rly5iemsHy/fvYym1JVzBP3iQMDJ09Zyq7Fl2WGlGEQRhI7evq6tDW1oaeYz24+OKLFOCPAXwIYMcFDQCEAIoAIgcmQRZg8M3x8fGT1yYm8L+FBWysf4JCoSgdp+Cc9ekzZ41sDhicX4gJeSK+tKOfiu/rO4FXX3mV0L8HYA5AwWWcAlADIBtFUcExQlCNAAY+/vjWm29fuYKZ2Vmsrqxie2tbygBjHVUNnBq0GqA6K/X3pe8zmbSIr6OzE30nTuCll1+mk/3A8/CRY4CUM3vWnWIsOT0QQAM0nlq6v/TdS5cuY2pqCsvLy8huZp0YbbKq/wunZBryJQ7oRjIZIID6+gZ0dOzDsePHMDo6yp7/GYAbALZcCaScVRqgHgiqGRpfXFhceG1sbAwzM7MWwCeb2MnnEZVo0Qbq5FP9El2oj/cEYVBVgjq0tbfj6JEjGHpmCAcOHPgVgAnX+6y53B9FEfeWqlwue77vsyz7AJy/+eHNc9cmruHWrTms3F9BNrspjlksluyDCQEIFXz8ok87Buj11EBtbS1aW1tw6NAhnB48jd7e3r8ppf4JYMXRzsaOpzyzJ/0ZrfVnlPJen5i49tnJ/05iYWFB/CCXy1YAyLacJYgfu6wF22HBQZNMpaQNm5ub0N3djRN9fXhmaKisjf6153l0wAdOjNZdbHDqoVFr/USxUHxz/J1xqT/teX1jQ1qRw0qsmQBOnRwwnGbxjK9sy8LAumCG/l+PtvY2YYHd0Nvbu6a1fsuBWHUtyOzTWmuqf7+nvKdnP5o9zuzn5+dlNmxubsrMyOcLMrKpA+mCysOnexyLxy+32vSC2toaNDY1YV97Ow4ePIjDnzuMnp4eMvUPClJrveF5XhIarfBwCAZP3rl7p2V6ehpzc3NYWlrCxvqGzASpf2F3TKvBgTN7S+D2ggTBYUQW0hmrhaamRrS0tKCjowP79+8XRlrbWu/B4DYUamBweG1tLUW1Ly0vSWAKj1Mxm7W1J/2lIjctdp/wfzsfBqUF0WzbAAAAAElFTkSuQmCCiVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAACO5JREFUWEd1V2mPHFcVPe9VVVd1d/U2i2fJrHaIgxOTyA5yHMcYExMRgVgUzG4hIpZ8IgSUCEtAPsR8RCT5AwQFCQSK/IVFRIkRIBEhL5lxHOOZsSfYHs+MZ+uZ6emluqreQ/e+6m7bQMvlru7pqnvuuefee0ocffKoFkJASAFLWrAsCcuidxu2Te8WpJTtg3+bHLjjpemz1tBaQykNpRWUUtBKQWkNaPB9nJSDdDqDUqkI8aUvflkLYf5AwWzbhkOH4/C57diwLbsN5FYAdB3A/0HT3ekfBWcACiqOEcUx4jjmc/qbkBKpVAq+76Onpwfi2FePMQMEgDKmwPQD13X5oHMDxrAhhGwzYAB0XpxkknUcK0RRhDAM0QxDRGGIWCm+lu5ZKBQwMDAA8dQ3nmLmiH7HsTloOp1GJkNHhqnyPBcpx4Fl26YUFJnKwAR0UBjqDe1RGCFoBmg0GqjX62g0AgZDr5TrolgsYnhkGOLp7zzN7EnLUJNJe/D9HIrFAkrFIgrFInI5H57nMROWJAboSOgnLAkJlAkFj6OYg1erVWxsbGJ9fQOVyibq9QazQHFKXSWMjY5BfO+7z2i6SFoW3KQ2XV0l9PX1YXh4CMPDw+jb1kuZ3wSwBQ1KIzZhKSSHV5CJCJSwILQLiN5KpVKYm7uB63PXsbi4hI3NDWbBcVIolUoYGxuDOP7D45q+JFqJ6ny+gP7+PuzYsR179+yhsvwGQryHOC7DkiE0FBQ0JKfdSr71nYDi7y1YIgctxgH1mUtT08MzM5extLTELFApqQSjBODEiyc01Ynax/Vcpp2yfvCBD2FkZOR1QP0WSlwDUGeFmbSN8G9nv6VGAkW96sZS9VpaHqk1Gt8/c/oMrl2fw9bWFncCiXBkZATilZdf1pXNCrcLlYDoHx8fw8P79iGTzbwoIf8EO74JqCZqWiGTxKm1gXTaIAOBGguTAFDvlgDshxQ/PnP23MCVK1dYEyRWP5fD0NAQxKu/eFWvrq6iGQQsMgKwfft2HHz0EdLF84j1m4iiZSgVIqs1q4Be/h1TaCv57PsCqArUBA2VAizxYWjx/OS75++bnp7BWnmd5wJ1GulMnDx5Ui8uLKC6VeVOoBIwgIMHoIX4gYz1W3CiFSAm8WlUtEbujuCtjxWgAiCXy0nUagkA7IWQz01OvvvA1NQ0VlfX0AybcGwHhWIB4tSpU/rqv69iY2MdWmnkC3lsHx/DowcOQDr2c5IYcKJlBlDR6r+DExoKm7zolErgSxtNYgAPQcvj5yYmdk1dmsbK6irPBurjdNqDOHvmrJ6ensbKyjLCMIKfzWB0dASP7N+PTM7/kYz1HxFFS4jjED7R7wOVSkuIt1ORywnqVBZhTRIDRVjiYUCcePvtfw5Oz8xgZWWVBxO1PnWDmLo0pS9cuICFhQU0GnV4rofBwQE8tHcPhoeGXoHGr+HEC6ipJjJaowqN7P8pQRVAllqTR6WNplWCLY8EQfNnf/vr3zE7+z7WymXUanUe06zVy5cv6/OT5zE3N4datcoLqLu7Czt33oP9+/b9C0L/FEpcgtbUhnG7Dd07QATtz9QBEinhIpZDGvrrM9OXP//OxCTmb8xzF9QbdWabulpMvDOhL168iPn5eR6d1MS+n+VFcd+uXdi9e/es0ur3kGJBQjfMFLxtFtyKhC6XgEgphS4pxP4bN+Y/OjF5HteuXsPaWpnnQCMIeFfEKoZ4489v6NnZWSwvL6NWq/Huplmdz+fR29uDuwYH0d/fz7vB89LMEC2k/+ULaBsqFaMZNLFZ2cLS0jKX9ubNJZTL6yZ4vcF7gkpA7Shee+1XemF+HuVymf9IqGgz0ljOZLLMhp/Nct8SMNt22LQQyy0gnYEIqGQNB0HAtSZWt6o11Gs1Vn8QNBGGTYQtAC/9/CW9srKCrcoW6CLa41IKzjTlpJByjTdgX2AbXyDlLS6JN6NhhOczs0BeIDZeIGii2Wxy4GYzMN4gCg0AEuILP3lBszBqNb6ALqaMaO0ah+SwTyBAxqbZzBBtT/oNg2mzYYCwMVGaVy9RTWaEAnLmdE4g4gTAs888q6u1msk+itjLkdXoeESL+9UmMGzNjD1jMPxOQOwEkGGHrqdBwSDiyDgjAkKZMxjDArfit775bR0kboUNJPk2XmainWUrKAFoM5Gc21biHak8CUBihEdBIkoSmwERcjnCKGEiCiG+9pVj7AfoRxTcLFnB/sC44STLJGM2qhaVhQI7rBPHJt+YHCTSRCNUSrpnB0CrBLcAOPrkFzS7Vs7e6Nm0WMeKsxaS7FgTrAsTPJVy4aY8uCkSqgc3AUKsMROJTeOax8ak0hGEAYtSfPbTn2NL1s6+Rb8kFkhs0jwvcOZk2Sl4qh3cS3k8Hzw3zQY27abhuh6zYmaGESlRa0QZ8hxgoxrUIT75xKc4dsvgGAYki5AA8IMKl8HUn25MLZlyyLZ7SHtpZNJZZDM+smmf3zMEhMFk+DfUxgSc+CUtUODK1iYf4hOPP5EAuJ1+sk2E3AAwwZmBJHu6MWXdCp7388jniyjmS3wU8kU+/EyOtsR1CCxrTbYOEgJdAD5QXl9Ni48/9niyWln77RFr/L80nZBooCU6k72LtJehAMjnCigWutDbvQ3bevrQ1zuAfK5ILvoCtHofwCKkXKddSpoUgCu06tUCO8Vjh490APDDhpkBreHSop9K0BIfCc5108ims8j5eQ5OgYcGRzE+soOAndbAOakxq4FFrVEWQEUBDUsiol2tFDLCQp84fOhjrP2O+k0HtLrATMSkBNwBZjRTfbOZLNPc292H4cFR7Lx7F0rF7n8Irf6iIaeVxk2tsS4lqhbQiAWaKkJMz680PlSMrDh08LBuPWJx+7W7oFMCM/EIhGk9Iz5Df1exC4P9Q7h7/F7ce8/9iwB+qWOchsA8gA0ZoRZpBJ6DSHmIVcQPzZpybERwxEcOHNLmOa9T/9aqbQ8hdlcdAOSa0l4WJLye7m0YuWsM93/wQQxsG/wDIH4XCbznxFgLU6gHdTSzHuKI9lxgHltUCC0dCMuF/A/LHk+Q0NwfkAAAAABJRU5ErkJggolQTkcNChoKAAAADUlIRFIAAAAgAAAAIAgGAAAAc3p69AAAAAFzUkdCAK7OHOkAAATDSURBVFhHjVdtbxNNDLT3Ln3+/x9DCFRVlNI2NG1DKQ98p7dGM7Z39y4RItH18qLU4/F47NXLd9dWSpGpTFKmuJdJplKk4DPeh0uLKN7jrira7ipiUgV//cqHmomKSDEz8atKrX7Xq/efDYFawGkd3D93MAhWikZwAMnXKubBHQCeAwARIQhVmTJwBZBqop8+fCEDDiIybiCCBQb2K0HwHgxEYPzPyuAaAJwLxdNEVEUmAxO1kgn8QK8/3hmznDx4A3GuBAEkqQcAEc3MHcCZEhCESGEZeLeC7Ang5nIfGhhBbOo/1N1ZcOpFkZgsZABPVkIqouFFPIiSl0kRlUnABAFU0durr0MJgupgA0GaADfiw3fmwZcQX8veQoTqtcfDGegAIEiKUu8/HQJAF1sXXtY8vqPiXXya1JszgMwb/SHCICEZ6AAABCyAgf3nx96Gm3ZbCy9aD8FBv2fuwU0WBf2uATwcAnA6CtSeLFCICUBM9eHmecNAZ8JLoF39kX0Iz2sfIMbsowQImPT3ErgYXQdmqofb4xrAWPcwnGw/iq9AxLKw/giurfdXHYDaUwMOAkGzEyZqIVpSH+++nTJwVnzN9VL5C6hv5uNspPZZAL7xFmxtOHYCS/J0/3K+BFvzoekgJ03aXf1KDaz7PxUQJcj6M/jQCWBBn/cJYOP7g+k0B4TSeuuts0frry045ehzYGQhNEAGjl+//7UEzXJhQN7Wi3rbnfT/OIQGI+r199rTDdOWNwByEPWJhy4YJp7bbm8/lmAYQOMQYgfEJByNyLvAAghKMOUcSAdMP2juF/V382ntF7bLkROtty0CBZjjOOqfbUg31MPds+3mnczzLAlkbb+D73vmWfsE4wBMjDMgJ0C34NYFYUDNB6iBx/ujXewAYEcAI4g2dIR9/4bg6r2PFnzb0J+Up/l0ExqmYfQ/jUhEZn15fB0Y6CyoKjJl0LBdBITwfovwegsfYK7wKKlSKu5QPPiBFfsegNpReFH/WUR2BgA/jr8M9M+RPRhQLfg5gncA/T0++52MNPOhwk3V8GNUg8tCAxGiIwAVIQARudD/j79sCgBYSnI1WwFwupORN8n3sOSQHXwqMtfqr8dHegHUnwAuAMIBQP0RPDWginZdBWXtGytrG2aw6mbjeW/2QlAy1H8nFgy8Pv8kAGS+7YIYu1kGZJ4gshXpAbmADNMvXTCbAhpATaCDGbWPEvyn359+mK/k3YTGNbzN/hTjdgrGFrwBkQCyDG0pTfVThGazvhxerZ0Hpr75bLfg1Q7QvSBX8Bh8J+t4AzAspmw/sFCXRfT44MMoDyajCbUFNBbRYGM0oO0O4C3Z94BxIaEGvBus1FplWaro094Xkn8D4JbMsezj/mQM+ybWFpG+EQ8nIwTPSw+3T1GC06NYO/kMJ6ABQADJjh86j4Jw/VGh/oeLQx7PGoD9zUMbRs5ETMI8//HeM++TEYEzwU3Xx1sGzkGxCu5nAoDQu+s4mIyTMJeRzPwcA+E8tLqWvL9g9tGA/UCK7EFEdSaiDHpzdbti4PQk3A+gSf+6DF3oIw+r7AEpStHOhQSAs+Gln44z8GkJAgAXk7iYtdt9r3x4XWYeLLBPSX/MbKs8FXORrFX+AKjG5aOnFa7PAAAAAElFTkSuQmCCiVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAABWRJREFUWEd9Vz1vHVUQnbv7Ph3b2I6j4CD710DsYGTFUhQFE2McgYQoEA0FEhUFoqRAVDSIhgYaCoREA6IBGtLAX/H72L3onJm5O/tscHy171kv75yZOXNmbvr7+T+5qmqpqkrquhJ/XaUkqcL7Svg6VZIqPJPwX0oifG0/eI+f7I/M1znna6fNrbRtlrZtJf3153MSqGsnoc9yDBjvCR4P4PlbaDg+kPHbAwdwBjAJtNI2raTff/sjE7yupe4R8egRechEJGIEyCL+ABzJCNEj4uzABt60jaRffv6VBOp6wCzo6UqhrxH9DSQKAaA7CY1cM4Bo7QnQcJqmEZz04w8/5QFAB0qAr3sZCbqgBrQUVao0/V57zwBL7+nXWue2leYGcBL47tvvM8AH9UAGA8sEn3ZYlo4EhAhw1wIV0AV/HTwbeINnw7ovm6U0y0aWy6Wkr7/6JhMYJP6LCLrESqFd0RdkCZ4d4ClXletBulumPIKTwBeff5l7wIFIPeiXZLUzvCVD9lV4rvTGwQHcaNTNkpHzLJaSPv3kMyUQDwQJcNNFLIeTiO1Y2t9FZ5EzakQPMETvwOGZPvrwYy2BaUBBVQ/QBYj0CKAU9AYrg4Vf2s7BITxTOgncQIIifP+9D6wNjQQ7IoJDoF1ndGUwN7T2o/JD6hn5Stobpr/TAX3gnct3jQCsuO8HsT09Cz0d0I7VfrXnO4fT1CuJUneqX8uBv7fIwOX52xltRgBzQpqSpV4F2hFDN+BznAs2E9zxXPXoeQARnICIfCGLhT7x3j+bLp4+yx1wv+7qDSZIJ2UkowgjAYIz9Vr3BYFx5jJfLEiA0eugkHTxxrOggY6AC9BJxI7QiemuyO8pPh/7HcDz+UzPYk4iHr1Prf8nAGu29lS39KnpExMCSGSAiHTCac8jUoDOZlcyI4m5gjcN9eKzI715dskMMGLrALahzQc8Y2sWMdqY9i+C34MASgAgRAvwq9kVM4BSAFxTrzOExwkUEbonBALuC2Vi2niGF/gS4l3gqkfETgD1RwtiMAG9DDR4yfnrb6kGSgcE41npgM6QohHpJIptiPQj7bPZTGbzK4oR2dF1KZVlB99HAtrbOvWuEwl7Aj5nm1PZkFaMSEuwkMUcqteDrGAZYdtimnL90wGYnj65yLBWkjAC3XakH4wr26oR+T7gVkwdUIhoOW1FTENkiL5luyd0NRqNJJ09PtcMBBIEDFkpi2pZzXxBxTzotiH1AxMjvMDmPxzSt1UEiTkzGo9kbTqV9OTRWe7WrbCM+g7gxG4E9y3Zv35l/eIS2uqIlkzvgMMi8unaVDY3NyQ9On2ck2hEvmisbsWsd1jP1YTUA7yddBfpVnBuwJYRqjQJszoYDWU6ncjGxobcvr0j6eT4If9v3Pf52sZtuROsruS2hzmReClway5/ww4J8GEt4/FY1tdvyfbOtuzt7Uk6uv+q3SDIwsh6ZPq3PjkNp7eMxguKLmXecbrAmupHo6FMphPZRPS7u3JwsC/p/suHNEbdpe2SUbZdXTj7t6HwGV/FV64F8YrgBKD6IdOP2m/KnTsgcCDp8JWjrN4c/JlRA9iXT1+/Q2YMPHZBtxuGDJjxoJ1BYDKZUHzIwP7+vqSjwwd2k+hSG8FdcP0d0Ffxm0LXTFpCy92BAhwOZTIey631ddnZ2ZF7L92TdPzguJtNvHBolO50q0+vfdFAvJgYqtXUpp7qCN/rLbi2tiYvbG3Ji3fvSjp57aTrggDuzugGFdu0XEivXUxvuBGbIIsWkIXJmG24u7sr6fThafbVqvR/sWTMhs6coia6q3ksg/uAX0ztahZJ1DCioSALW9vb8i9gvLcUKCDqKwAAAABJRU5ErkJggolQTkcNChoKAAAADUlIRFIAAAAgAAAAIAgGAAAAc3p69AAAAAFzUkdCAK7OHOkAAAeuSURBVFhHbVdLbFxJFT31vv1xtx13bE8+/mXDhg1sRyDECrEC8Us0I7IYAcpICPERIFiMZgUbJJDYsUBiBQt2iN0sQOIb4Qx2xhmc8SQhbbvtbvfrbr/+vG+he6uqX7ex41K9tKW+p84959x64vzlSFrCgmUJiOlOzwL0DwJSAhKgR/qFkJCQ0qwcucwhc8l7npuVTZ+znJ4zZFmGjP7Ou/q7OHs2kMKyoECoRcUVIK4H3vQPFedfBkDF9U5fPAWgvpyLZGrn4lk6fVYgcoijg3NpWfa0uAHBO7FA1WcR0OkvM2BOzQCokN6nhVXx1IDgXS1xuHcsHduGZduwLRs27TYxoUBxK3gpCrgXmn6mfo52feqZwimdmoqnevH/NaA0g9j7xwfScRzwsmm3+dm2aZmWEJD5NnAL5mifL64KZ7pwgiRNkCQJUlozgMRf39mRruNyUdd14boefM/jZwWkYGJWB1MNaPrnhEaFdRFVOEYURYjiCEmcIKXPmJEE4o+/f0eqYi4814Xn+yiXyqiUK/B8T4GwbAgSJZuA2jDjACO2qcrVqYl2OnGcxJhMJhiOhhiPRwyAQHFLshTiN7/6LTMwPb3vo1pZwGJ9EdVqFZ6nQBg9GCUQA7Oqn1W66TedfBJNcBFeoNcLMBwOESeJcgO3J4P42U9+Ien0RD2B8D0fC9UFNBrX0VhuMBP0OYmUXDHbBvY8iVD72iidqKUVxzGf/LzbQbvTxjAMNQCyp3bBD777YxahYUEBqGFlZRU3b9zC0uISfN+famFOB5cAFMJTgqPT9wd9tFonaHfOFANxrO2oQIivv/FAktCUA4gBD9XqAtZW1rC5uY3VlVWUy5VLbSiSkH3PQjTWUnaj3o/HY3S752geN9EhBkZDJUJqQarSULx+76scRAzCceC5BKCKleur2N66g1s3b3NLrtLBbPQqDdAXK3EZ+tvtMzSbTXS6HYxGI/7chBAH0Ve+eI8ZIBCUAQSgUqmyBrY3t3H71gZqtZrSgQ4mZYUihgsGChaoUDgMcXraQvOoiW63ixG5gHKAXaJnwZe/cJcBqEUMuChXKmhca2BzYwvrt68GUMyCYvgwC6nKgDiOEIYhWqctHB0doRt0uSUEwLiAInvKABWnSHY9j5V/7doyNtcJwDpqtToDIwZ0FHAEGyuqoaN6SgCSTDtAA6AWBL1gBoCZjBnEvS+9Jjl2KYKJAc9j0S0TAM1AfaYFRRAVo5cLXxYhMTAM0Wq1WANXAeBx/Prd+7oFZEVHM1DGMrVgcxsb3II6a0CNZzUNSfXFjFe0F0MnQUQaIAZaJ6yBIJhnwIxrcf+1N3gakgU5jj0XlXIVy8sNbG1sYWN9UwNwGIC6A+Rz4zXNjLWUBSlqKffnAHS7GE8mWgPmspJBfO3+AxVEZh54Pmug0WhgixhY30J9oQbbcfguNOt36rUaLGo3zzwDNIATckHz5ZQB44Dpjeib3/jO3Cwo+WVUyAXEAAPYRG2hxlFMxem0PN2SCHES8YmSNObPzMilZwagNWBcQENJuaC4rokffvstSenneyWOXAWAWmBcsEHzYaRvg5UonmA8GWESjUHPVIiAUPIVIGLWAGX/6dkpjk+Or9QAtVL89K2fS6Kc+k7qp0lIybe0dA03XrlJIXQmBPpSwLMEluMkql0MBxiNwykQBSLmxW1gBtQg6px32AlGhPR3dWVTWhK//uXv5GJ9CYu1JdBery2iXqujVCr3hMAhBE4hkEKgagnczmX2kXb3DL1BF+FwwCCICb5s6DYoEAn7nuzXbrcxGPRZhKQBuqgSABK0+PMfduTa9VewtnIjl8AugOcS+akFKwAwkMAEyGFZqMGy7gD4ZPu8tX3U+i86QXsKYjyhlFM6UIJMGRRNQJqIZhLSrKDoNlc6ERzKAAJ/Enn+OBdWU0oEQiC0JMZ5hlhayCh8LIESgA0h8Jl+2Lv7+P138fL4Obq9cwxHFyAAVDBNqQ1qIJmpSNcxHsMkQH2FM+8VIniavZ0La9/KcQKJvu1ikseIMwdpniKTGXJUADuFYwErEPiEsPD23//1l6X/fPAeWmfHGIR9jMZDnv/EAjmFbzzmBqyHz+XiFGoieCo/lWY4oVMnFuLyGGleVS87WYzcXECcEmwAi0Li4xD43t7+o1d39x8xC71+gHAUYjIZKTdQCzLqdfEGZHpevFGpUBfBE7k1BC7KDpJkhCxPILM1yDRVrwD04zgQ/gC2EKi5JXxUSrx5cPjkczu7/8SL5jNuQzi84EunyQbDglF7UZi+li40GsDgiWxMckRRH1l6QxWdLW4AlAewbRd1DeDB0w/f//zO7kO8aH6IbqABsCMiDiZOPD0v6L3RTE8ur6orBs6fynpURRpFyC8XNsWJgdIQjuVgyZL4GCx868nB40/v7u/gRfM5AhZiiNFkiDgiAHo2UBu0369mABBn78mFqM43qf+jnQGcQPiLsH3ASxysCguvWgI/erT38M7+wR6OW00E/S4DoEygUCIA5oaspqa2Hb1N6XcKRYCEaP1bVpPl4vR0WrwEbA/CKcOyPVjjFG7VxwIybEmRfzaO4+8/fPdvOHx2gNNOC/1Bj11AViQNcA5oB7AQ+fVdgzAAGAzwPxy4tYF6RUHTAAAAAElFTkSuQmCCiVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAsdJREFUOE9FU0trE1EU/s6588iria2JD5Rq6oNKFQOu/AWu3bnyX4igooK4E9GF4M6NFqTia1GxKhU3vpBCpYpW26atWmzURpvaZGbOkXsTdeDM4d653+N8w6XJN9Ma+D48W8aH53nwjAcmhn1U7avdVRQi4ipJBEmcgMZejGvgB47A9zwY48PvkDEToLYAUXUEf4FxHMMWjY480SAIHMiYtnoQhAiDEMYYEMipi1XvqEZxjCiKEEUt0NDgzf8EHfuWIBWm3DgEbhNYcJIgjmK0ohaiVst1unTxsjrLFuxG8GBHsiTWDRH9s+5sRxFaTj1qj3Dm1FllY2CYwWzAzJ1RDIjZZaD6N7TYubA5iIoLmY4dPaEWREyd5C3ABiZIbOL2cCd1u28DdSJs4Hk+6OTx0+oHPsKwbdt+tPYajYar1d9Nt7YkNg8L9D17NnBB0/lzF3RNdwGlUgnFYhGZTBqNxgrm5+dRnZlFbbHm1pIomAxCP0QqlUY6lXGdhq7f0HJfGXv27IYf+I9V9QsR9TQaKwdGH41iYuINvtW+I4kEYZBGNp1DPldALtuFbDYHGns1pnsrlV8KGQQwycy/RSRkcGVqevrwwweP8GnuMyQGujIFFHvWYX1pI4o9JeS7CqClH3UtFPI3ReUZM9cAJAB8EdnaXG2euH3rLqrTc2D1UOregHLvduzc1o9MOjcOYIpEtK4qg8z8FkAdgP0/IQQ7lxvLR+4N38fnuQWEJoPeTX2oDOyz4CGIPFXmBVLRRVG5w+D3YEegIlIgov3VmdmDz5++xI9aHdlUHjvKu9C/Y/cEErlCzOOaoGYJ7H0bhso7MP8UEQNgCxMfevH8pf9xcgory03ksz3o7xtA76byiAquETCBGN+pvrSk+XxhBtAPCiwTqAuqlWp1du3HD1P4urCIVjNBPtPtHGzesGVEgauI8VoItT9jkISSQyYojQAAAABJRU5ErkJggolQTkcNChoKAAAADUlIRFIAAAAQAAAAEAgGAAAAH/P/YQAAAAFzUkdCAK7OHOkAAALNSURBVDhPTZJNb1NHFIafmfsVx9c4QQRbsMNSArhYsEhhhRQpbBs2lCTQiKqtkFigLir1B8ACiV/AhgVIrFix6IYFBCEokULFxyqY5Log4SYmxopDkvsxU80Y087VkWYW88x5n3PF4pMX2nVdTDmug+OYkgghAI3WGiElUghzIssy0jS1lSQJYv7+E+0ZgOfiuR6u14MYgNaKTGV2L6VEA1mWkia9y3ESI+7d/UN7nsd/1evEvJgpRZomFmCgtoM0+3o5iWPEzRu3LMD/H8TEkVKgtAGkXzvon83r/RLXrly3DvoduCaGddFrWSmF1WH2Jn+WkaSJjWF8iN9+/V2b16R0rEjjwzHlOLaL/uoLzIzALLNgrTTi4s+XtJHVz2lEer7fi+T7thOzjLw4jonjxO61BmG+H+d+0oaGwE4hGBggzOcpFosUh4rkcjk7jW63S6fTYWNjg+3tHRvHIubOXbAA6UgGggF2FXdRKpWoVA4wdnCMcrlMHO/QiBq8qdd5/+497Xab7a1tlIlwfmZOm3wmfxiGlMslqt9UOXVqksF8eFtCQ6ECIcTx5bfLJ589WyBaifj0qUO8EyNmp89rY9n3A4Z3D1GpVJiYmGDs4OgdKeVjYBOQKEoIphcWFo4+f/4XHz402exuIqa/n9XmL8sN5ti7d4Rqtcrp01PkBvNXpeQNEH+ZRIji2+bqP788mp9nZXmFdruDOHtmRpu5h2GeUrlMrXaE76am8Dz3KlAHdr4A8kBta2vr8sMHD1laWqLV+tgD+IFHoVCw8g4fPsTk5KSReUNK+RLoWt1QRKljm58/X3j69E/q9Tpray3EzNlzOgh8CoWQPSMj1v74+Dijo6OLaB4gWbVjhj1SiBOra2snX796RaPxNx9bLcQPs3PaDwIbYXj3MPv37zOXqdVqDA0VF5XWSxLMn1YGTkRRlI+iiGazyfr6Ov8CTw1UAW+/2pQAAAAASUVORK5CYIKJUE5HDQoaCgAAAA1JSERSAAAAEAAAABAIBgAAAB/z/2EAAAABc1JHQgCuzhzpAAAC/0lEQVQ4T02TzWtcZRTGf+e933PnK5mvpKmTIra0pYWii7pw4UJX4kJwIQiKiCiif4D6F7iQLlxJddGV2OJG3EoFC2ILIYqhGtxYapPYDLmTmcy9M3fue+ROSvGFszzPeZ7feY98efWqBr5PtVqlXq9Tq1WpRBGe7+M4DgKoKvN5wXQ2JU0zZnmO67q0223k2xs3NIoiWq0WJ1ZX6PV6eJ6zg5oEo1MQxeIiGoOsJckwOEgSrCqdTgf58eZNjSsV+v0n6Hbbv6HcsiL3DToB5hw/AxJaa7si5pIgLxyORtQbjUzubm1pFIWs9/v/WrVfGeE2avZRnQH2kYAg4iGyZEUvivKyiDyLmIcy2N9XxwiNev0WVq8Bm3g2IdO8jP9YIBSX3NQw5jzoK4h5CaQQtXY+zTIn8L0fQK9R6Ca+HTKxpX2lspAQUnFwnBoO58B5LZ/PXy2BlgK76WTSi4Lgd4x+QcHPePaA1OZE/3NA6cCpY3gazLs7O3uXk+FwITDe292Na9UqlUr4Neh3qLmPlhugeAxRJECkB7yYTrL37v7xJ0kyRPYf7uu9e3+j1nJybY1up7OF6AYqAwtTc8zBsSI1o5xNJ9Pnt7f/Yndvj/H4CLlz+47uPHhAlmVEYUiz2VxUHFcJ/ADX9TCYxUeaHKUMh4ckySGj0Yg0TZHr31zXwWDANJtixBAEAVEYEYYRUVh5VDGhH+EYD7XKbJYvmo8mY+TKZ1d0NBqT5zmC4LkeQRASRzG1aoOlRovOco92q8dSYxnX8Y8UzDyfRcnwAPn4o0+0nG4Li4jB9/zF1LK5s9xlbXWdp06doVFb2lRlA7U7KiZXtbHBnJIP3v9Qi/kxbMe4BH5IXKmx3GyxttLn3OkLnFxd/0Ut34thG2VghZmxlHCW5e233tEylzEGz/EX2evVJt12jyf7p7n8zHMlxE8t/CQF/+SGsecwlylSOETyxutvqmAWp+t7IZUopllfYqV7gvNnLnLh7KVfgc+1YEMNg5mSVYrjG8nmuP8BY4tRwf7Dt4AAAAAASUVORK5CYIKJUE5HDQoaCgAAAA1JSERSAAAAEAAAABAIBgAAAB/z/2EAAAABc1JHQgCuzhzpAAABx0lEQVQ4T3WT224TQRBEq+e2/v//QkIokkExMXEINvADiXdmClXPeOMXVhrtU5+q6os9fPrKnAtyysg5+z+ljBgjYkgIIcBMzwASXa93tNZQa4XtPx/ohXfFKSWkqOLogGDBa6GPDG0CBLHHh6MDpDrUR3H0F6VOEFWlAIyEaLH1hirA0/50B0jT/iiOIUpzZUeDQSB9kUBi78EBz4+v3JQ3B7KelLtO9cZRLkyEIZFMHuHl+3kAcvIIsp6iABLCymG/TXUjEABkENkBr8fLBNzn9+xNgOmgC0A5ACKIBKBsgFKKT0GNlLpcALiyY4W5+pgAELyJcjAAZr9+XLgsC267oCnAbEXHOwyr7G/5ZV89IDINpfee7HL644BSFuTks1fmNwJvcgHA7Uu9E8Hg9uVg13tf7PLyl0sRYNtAZVfxOzgAXk/PH6geAAXErvVW7Hz6TVf3TdQeaHxBLq6g90DbexvhaCKQCezW6xX283im1D92YSyR1tinMCKMLZxTYGesrWJdV9jz4WXcwlwi38AJGIck0fHRD0lPhzSP6bB/+g8g+CHBzMNTe6AsJFq7v8Yv3+YtjPwfDsYV3hwogwM6sV1jrfgHQR8XLdOjX2oAAAAASUVORK5CYIKJUE5HDQoaCgAAAA1JSERSAAAAEAAAABAIBgAAAB/z/2EAAAABc1JHQgCuzhzpAAACD0lEQVQ4T32TzW4TQRCEq+dnd21iGyQrJs4l+ICfDRQSHCJBDijKFRHEC3BAPAAXxJUD4sQF8Tbs/DSqGa9jLlgaWdrd+bqqult+/fyt3js45+Gcg7MOxhpYYyHGQERQfgqoZuSsSDkhpYQYI+T7tx/a+Abe+3IIsdaWY+QOoAByJiAjxYQQI2IMkC+fv2rTNGgaAipogJg9BaqKnDLitnIIATzy8cMnbQuggee/b+BoiVb2AEU6L6dYLoY+oA895N2b98qqRQUVFCV+l4XAlADSTnqtHEJfIPL66lopecjgHxvGACKo8mto9E4A/dOOXJxdqrUEDJBtoM6XIEsDVO+ks3oMSCmW5/Ls6XNly3xRUS0MXSGAbWTyrE7Pff+nwHjZWgM5fXKu1hhUFdX/fwGhZ0NhnUPXtVUBqxDC5B0hZaiqBb5jNUqm9KwJzlmMxmNMpxPI+elGixdQRR2g3USWNtYuZNUyicYIulGH+w9mOFwsIJuzC00pl7D4cbVjYQyPgeEob8eZLFo8mBxgsTjEyaMTyIvNpTKgqkLKpQrg5e0oF4aUHWnbFrPZFMvjY6zXjyGvXl5pirEoGC7vAHuTyJXiclHBZDrBcrnEer2G3FzfKL0N3jmRNYOqYpBPhTx81nYd5vM5VqsV5PbtrbKfbdNiNOrQdR24G9wH5sDKwybSKveBdsbje3h4dIS/0BwF5rvPEXsAAAAASUVORK5CYIKJUE5HDQoaCgAAAA1JSERSAAAAEAAAABAIBgAAAB/z/2EAAAABc1JHQgCuzhzpAAAC2klEQVQ4TzWTPY8bVRiFnzt3bI/H9mySJd5ElKlAVKnpyA/gH4BIqvwFJCSEQEJEdNCloqCjQnTQ0CC0iqIk2oSsNyK7689dz5fH8z1z0b1mq5nmPe9zznmvmE18ZdsdbFsipcQSFkKAApRqadqGpmmo64q6rqnqkrIsKauSqioRk2fnqtvt0ul06dg20pYIrXAloIeb2gjoobIsyIucoigoygJx+OcL5fQc+o5Dz3HodrpYckfRtjuCq+GiyMnyjCxLSbOMPM8Qv/3yu3L7LoPBkNFohP7vdDqGQlvQ23fYBWmWkiQJ8SYyXy0mHv/4k3JdF2/ksX9jn2vXruM4DtKyaFE0dW3Q8yJju03wA5/1+pJ4E5PnOeLbr75XfaeP5+1xMD5gPD5gOBiYLJRShsD4zjOiOGK1WrK8WBLH/wt8+fk3qtdz8DzPCNy+dZvRyDOt7CxUJiztO4xC5vM5y+WC6Irg6y++MwTav96uBYbDIZYUJkBdlcbX/oPAZzafslgsdgRFjvjh0WM1GAzY8/YY3xwbkb7bp20b8jIjy1OyfEuSbIz/6WzKYqkFIlOl+PXnP5QO7sb1fW6+M8bp9xZC0AiLd4N4TRj7xJuQOInx/bUR0BZ0iEZgfpRqC68QHCnFTAhSYbWeJa0Pqrb4cDo/5dJfEcYBfrA22y8uVmySjblIEUzUo1bxypKshGKLQinYs2zuCsmD12+Obp3N/sUPLwmiwFAEoU+aplRVhQhP1EctrKyGbWNRCYFoa1wpeU9Y6uE/b47uvTx+zvJyThgFJNuNuQfdjK5YhMfqTiFJnIyqdWnFBlF16csud6Tis8np60+fPPub6eKMMPLZZolJX5+3bkksJmrck5RtbYJXdg9ZF7haQCg+eXt+cv/w6V+czU8JozXb9Gp7Ze5EnL9U+26XWr8+/ZKzEtsVeK3kfYG6f/L2+OOnLw6ZLc4INEGaUFa5wW9Vy39iq/2dscTx/AAAAABJRU5ErkJggolQTkcNChoKAAAADUlIRFIAAAAIAAAACAgGAAAAxA++iwAAAAFzUkdCAK7OHOkAAADbSURBVChTJY89SwNBFADn3d5mNzk0GMQIhwj2Fnb+ZcHPlGkEI9iogYCFEg5OtLTSO3K6u0+i1RQzzcji/kmd9zjrMCYHBI1KjIkQInI9vVHnHD3ryHOLkKHpP1hTzk4u1VqLyQwiGSRBFYwYrO0hF6dX2u/7P9k0Lc1ni8GyUQzZGo6Q+cNcy7JkUBS8vb5TLWssnnK8T7m7p7JqV+q8uwU+UuS4eq7Hm24bnw8mSWUhmtILqo+QdSly2H3Fo9iYWQica2IpGsIMkXr9pzE7+GnZ+W64Cx1TVapfIzBnroQuH4IAAAAASUVORK5CYIKJUE5HDQoaCgAAAA1JSERSAAAACAAAAAgIBgAAAMQPvosAAAABc1JHQgCuzhzpAAAA8UlEQVQoUzXKMUvDUBSA0e/6+hJp1QxNIpa6BCqI1rGp4M/wLzkUleIgFEEUxNVBBwcXNwVHTQUHcchWtBDMkJT2ioLzOfJw/6TWsVhbwRgDAqozJpMJRVkiN1e3aq3FcexfEIHZfygK5HRwrr/gug6O62LMHNPplLIsKIoSOez11VQMnucRhgHVWpU8zxl/jfnOc6S3t68LizVaay06cQfPW/ocjUb1l+eENE2R/sGRhssB3e2YKIruUN4RNtI03RkOX5HB8Yk2VxvE3Rjfr1+j+oFIA2U3SRLk4uxSG80V2lubBIH/iOobMA+0syxb/wEPTl9qbsqDDQAAAABJRU5ErkJggolQTkcNChoKAAAADUlIRFIAAAAIAAAACAgGAAAAxA++iwAAAAFzUkdCAK7OHOkAAADTSURBVChTLcpPK0RhGMbh3/OYIcOYOZTY6ExIFFufVCk7FsraSvEBlD9TpsmkxOw0pMzqnPd9biXX+jLl9CHpSWiE9Om4Ai26sYY3uqZIl2T1sRiCvgBBoxOm0vHSlNMJRJ+wAdL3XzBbwrQDMweWczp19IzskYjJfygC33f80JTzEGkS0h34u4sqRFuVlyFt2/htrMhB0SlozbZfcuY2VbxGHbXhy3Z9dSPCWOmustXb+4mKowjuTUwFLTs/u9D83AIb6z02y90H1RxHMDBnmkTzF491eKo7RQUOAAAAAElFTkSuQmCCiVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAAXNSR0IArs4c6QAAALBJREFUKFM9z9tOwzAQhOHZ2I7tdd7/qZAQAgUErVQO7xAfOyhp1ftP/87K69M7NSpCUPjZwxoLQNB7R6kF8vFyoqoiBsV8ByRuoBTIeb1QNT2AMYYkpbeOXDLk8vnLpAtijHuBICqJaYzhcs6Q79Mfl7Rg32Gta8AB7BjDb9u2F36Y0q2wj4TIAGlqbTjA13q+fxHg3IxpmnC9Eq01HCfenlcGHzB7D2ftA/Q+UGvFPzQGZbxxblmcAAAAAElFTkSuQmCCiVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAAXNSR0IArs4c6QAAAMZJREFUKFM9jzFKBEEQRV9VV09rO7guKwPqoQUVDQxkQTTcZDFVMRFvsWDgCYQZZ7qkRzD4FHwer/jy/vbhKSVqzCIqQnFnGieGnwHZbp7+gRgjqkopzjiOf8Dd7dotGLGJxGpQxauhlPnKxfmVe3GCBswM1QACZoG9/YRcX9740A/UNoQwx6LRtgesjlfIw/2j930PDlYBM1JqOFouOT07QV6fX7z+amKcl1SDhkDOma7rkM/dztu2ZbE4nIAv8BE0AxmR718PGEf6tU599wAAAABJRU5ErkJggolQTkcNChoKAAAADUlIRFIAAAAIAAAACAgGAAAAxA++iwAAAAFzUkdCAK7OHOkAAADmSURBVChTJcqxTsJQGIDR779tQ6HF18DE6ODo5svoC7j6Zq6NcSAGEyOQ0lANCCJtb0uLUOg10eFsR6LXuXFbLRzHAYHDoeZnt6Wsyj8yeByajufhui5KCft6T1kW6FyTFxoJHvrG93x838eyFNtdRaZTvtcrsixFBkFoTrpd2p02x6YmzROWX5/MF7P/kE3NAIiUcBSbs1W6OA2jER+zmFQnSBKaW4ElgkI1F7aj7p+eAzV9D8k3GlmH5kqEQjU4jaJn2dy9vPUvJ/GITZUjycScN4raOtBWNj0RczOOh9dRPKaoNL9asXv2BwYdwgAAAABJRU5ErkJggolQTkcNChoKAAAADUlIRFIAAAAEAAAABAgGAAAAqfGefgAAAAFzUkdCAK7OHOkAAABPSURBVBhXAUQAu/8B0MvU/wUFBQAFAgYACQcMAAHLyM3/BAIGAA4JEQAWExv9Ae/s7/8NChD8+fQA1P33ANQB//z+vP77AeX79gDr+vYA60MkHz9bkZBIAAAAAElFTkSuQmCCiVBORw0KGgoAAAANSUhEUgAAAAQAAAAECAYAAACp8Z5+AAAAAXNSR0IArs4c6QAAAE9JREFUGFcBRAC7/wHIw8z/BgYFAAECAQD5+fkAAbu2vv8KDAkABwcGAPf3+AABx8PK/xkbFgAUFBQA8PDwAAHt6PD/EhQO5gAA/tkAAQERhQMaEwQwPTwAAAAASUVORK5CYIKJUE5HDQoaCgAAAA1JSERSAAAABAAAAAQIBgAAAKnxnn4AAAABc1JHQgCuzhzpAAAASUlEQVQYVwXBoRGAQAwEwEtweBRV0wAtfAlfAzPMIJAoNO5zybFrSe6QHgB088UUscH9QmqUptUU1Yp2JPEWMRs/3THQFThTiB8LdCic8D9v3gAAAABJRU5ErkJggolQTkcNChoKAAAADUlIRFIAAAAEAAAABAgGAAAAqfGefgAAAAFzUkdCAK7OHOkAAABJSURBVBhXBcFRCoAgEAXAt6wbFWV6/zv5IwYh1CXWr8xthkq6bN88RCaMb4BqeSweEewEqgqq523BBzA7tNZAORVb5hXMjLd3/J4gGoiF/LhiAAAAAElFTkSuQmCCiVBORw0KGgoAAAANSUhEUgAAAAQAAAAECAYAAACp8Z5+AAAAAXNSR0IArs4c6QAAAEhJREFUGFcFwbkNgDAQRcG3YvE6Mf1XgoRISBAdcDRAC1ji+MzYPC3yxnFvwcCGflS9KhFBKQU71l36RIpE5IzpvTfECfYA3Q8YDxcfbYRVSAAAAABJRU5ErkJggolQTkcNChoKAAAADUlIRFIAAAAEAAAABAgGAAAAqfGefgAAAAFzUkdCAK7OHOkAAABPSURBVBhXAUQAu/8B6d7y//8A/QDz9PEA8PLvAAHz5P/iAQIADOns5hHk6eEAAfHf/ZAAAgIHAQQAXdvg1QsB8eP/bAH//ggBBQI9/wH5Ti4hItmGpWftAAAAAElFTkSuQmCCiVBORw0KGgoAAAANSUhEUgAAAAIAAAACCAYAAABytg0kAAAAAXNSR0IArs4c6QAAABtJREFUGFdjvHjmyn8VOe3XjH++/t/x+xvDYwBjRQtHH6KlsgAAAABJRU5ErkJggolQTkcNChoKAAAADUlIRFIAAAACAAAAAggGAAAAcrYNJAAAAAFzUkdCAK7OHOkAAAAbSURBVBhXY7x45vL//wz/GRj/fP//iZn13w8AaWkLUokwHaMAAAAASUVORK5CYIKJUE5HDQoaCgAAAA1JSERSAAAAAgAAAAIIBgAAAHK2DSQAAAABc1JHQgCuzhzpAAAAG0lEQVQYV2P8/+fPun+/GJ8w/v78v//fH4YPAHnTDOvI5WBVAAAAAElFTkSuQmCCiVBORw0KGgoAAAANSUhEUgAAAAIAAAACCAYAAABytg0kAAAAAXNSR0IArs4c6QAAABtJREFUGFdjvHn53n82FjYGxmsXbv5nYWFlAABOEQcnSF6KnwAAAABJRU5ErkJggolQTkcNChoKAAAADUlIRFIAAAACAAAAAggGAAAAcrYNJAAAAAFzUkdCAK7OHOkAAAAbSURBVBhXYzx64Ph/NnZ2Bsb/v/9eY2BkYAUATMUHNZsudrQAAAAASUVORK5CYIKJUE5HDQoaCgAAAA1JSERSAAAAAgAAAAIIBgAAAHK2DSQAAAABc1JHQgCuzhzpAAAAG0lEQVQYV2P88uz/g9cfnsszfnn+dzkzK5MEAHOdCj6wMvHQAAAAAElFTkSuQmCCiVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAA1JREFUGFdj+P7m/1EACWgDqKg+vB0AAAAASUVORK5CYIKJUE5HDQoaCgAAAA1JSERSAAAAAQAAAAEIBgAAAB8VxIkAAAABc1JHQgCuzhzpAAAADUlEQVQYV2O4c/PufwAIuQOSmzFxBgAAAABJRU5ErkJggolQTkcNChoKAAAADUlIRFIAAAABAAAAAQgGAAAAHxXEiQAAAAFzUkdCAK7OHOkAAAANSURBVBhXY/j95W8HAAlPA3XvQ+ThAAAAAElFTkSuQmCCiVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAA1JREFUGFdjuHXl/n8ACKYDja9TRVYAAAAASUVORK5CYIKJUE5HDQoaCgAAAA1JSERSAAAAAQAAAAEIBgAAAB8VxIkAAAABc1JHQgCuzhzpAAAADUlEQVQYV2P48eX7fwAJrgPjRM1GkAAAAABJRU5ErkJggolQTkcNChoKAAAADUlIRFIAAAABAAAAAQgGAAAAHxXEiQAAAAFzUkdCAK7OHOkAAAANSURBVBhXY/j85P91AAlSA66YTxG1AAAAAElFTkSuQmCCiVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAABYtJREFUWEdlV01vG1cMJLnS//8tPfTSU0891LVTfzQumqIBGhRBgaBFUCCxtLtkMUPy7UqWI2u9kj3D4Qz5oo93z6EqovgmKrwW3sB33qt/eX31GJ9VFVMTVZPJTMwmPie+mpj2K97Lz/HzD3dvg9AEbLAdARJr6EsC/Tt8xR8soGnagyfwVAQGsJlIyKoPt78EAfhHCqzVyDd2dReBUmkQIDAq34Cn6VAKlBokOFXlGhGyiMiq9z89DQINdk3kQoE9eMteFaLyyQ5i9TrkB7FSSERXKfCAAj/fPEYqfyl7C5+ilAqtxq7flLd6japBoIlcEwiRGVWTQMgqKq5vbh7ogdem27ejSFSboFBWlCbjE+DTQQ4ksSnBz6k5wavyIrGGgMCPD1Rg1Lm/LsdvCSmnU3IbUhO0wS9UmKAdgOYImRXVpwJ4BalV39zcxz5ee8/viQ2nVy8vqz6y8iaSrSD4EiFnERoO14sWsIQ4SGwteJXwvpHp2EetJSboAeBHORxKBXrgQHAROaNySQXoeoCWAsEW3N8+IhJXj74xrDiGR4NT8sNBjgRPBdoHJraEyEkKHL0PqBDCvieJcBUNfbjLGOLBiws2OZy6+s55gx27+lKCEdQBDunbeCCwMnapAEikAk/3byORQSCKxbX826DJ3qfkXX0a8AhwgLxAegk5t/MLuOWH+UACqKHPj79m4VX9Jn7vhqvIFRj73h6wAyYcJH6JkFNVjt4v4bKIwvmxRqgrKtdwCUW1ob89v9sKH/LnUhJB5XqxWAbwdEwl0nBnR+U7cEfsGLdYRJSyU/KUHr7jl/7x7n3g1iZDD6VaMCN2W9ZBoqYefvErq87nPDKfWYfpkPvRdxcJI2JC6p/vP+SP43EVO26xnHZdfcbMELEXcTkNx4NAxMx57wWerqfhqu9lthp+Hz983KHXeYB7Hb2vVYpsV75NJ1T24i4vGnKKiJOEwu3MenhUz9VdxC3CQzQFBxPQ2Jf76e9P48Y+cj3rt3l/QN++ttHCabZzeJwDQweDxpH3NFtHDXmvSXsZd+iCFnz+5/N2HmDm+2Axlk24J7CHnLLqihmq9sp6DhlI72H87hRddAt3TSE0JLUO0S//fYmLUbvtbVQEMBoM4GW0HK/d71Bkf/GIVUIpuQhyljmnA/bzDVnI1YseqS6nOfgTzmmiXtUhw2fIDALhXCg5XEJmRMwIWuMV1ddyyXCl7IGmFQFgpeY4BXDNZcdjdvxxGAt5xcZCdQACIKrmNaXGUvFA1PDZzekQG1vO3UMMQoeEEY/4sKNYHj1z+fMJd4LAv0lAMa8p7SCQKpzFM98g6R6zFbhXzx09X4BS4GKXycZbBDbKznnEQ5YZCPzF9Wgyi5MEpXaPs4hCakrOfHOl6hrui4jBZjnf2WtPGOFp93X1Xbkjk+y2ioPA4r/XUWkJ5BmVZs9nCZJg1YhaAW8nGvdcr47KAZvSj7y19E64lH7rvwWMEbM/df/p7AZPIik7eg6RU/LVTFZffKX0BKf8OevqMXrvlqf3Ak93YiWYhTgJ3KLKnuOlwCwesxiqh+y+SFhWHrJ6+CphGHTZ9wTO6A3X1x0azqpyV4wATBjnXkoP/FDntTRgkekzHI9SgZ5n9ei9u8MzBU6di8Te+ZUBN2XVQ4UEhinJLGb/nglwnlo7CTxAsjVcKk2AVa8BA6J67DVGr8zHy50HoMmFAtjLcIOBvoajBWf/jiY0kAjkPIHNUHESsK6eWed6Tcdt8udhNxWANjsz8BS2DSDIv/lA4+TfErxPLwA1X8St9jn7z5PsmHaO8jv3PXKTAJZAH2XYHJoP1s9BBAOCAH2QKYhvcsCU5JSb1Y//ROBMl+DOZUMDkwOSdElgv2o5GQhcrUAi0ALMBEsC/wMt6mbTUGIgcQAAAABJRU5ErkJggolQTkcNChoKAAAADUlIRFIAAAAgAAAAIAgGAAAAc3p69AAAAAFzUkdCAK7OHOkAAARVSURBVFhHjVddbxQxDIxz////8MQTD/0Q116vhYoKVQgQIFHRFgnUqpcgjz2Os+1JVFol3d2LxzNjJyub44suUkopUkT00qkUu7UY7bX9f72Xjqe9dExs7LiPic11ime9yOnROQBocAu4D4SDZPgMJAK/EHxPYA2uSOTkaNsZdIAgIPDiWTuwvfkza8sO2QKPZ42pzQcTCuDwrJPqAICYzohnimfpj/860/4kBX0heA4cEqwPz3rWO4MwX9AfHoOEJDCmu2ebPeDaww/BxPABJFgfKAP6hgXLmTPryH4KrsgidJgP7E8mzIakBMmE64PNWIVmRAFYVXgxmP2X2ScMdD8BvARk3PO3yYApZzenrIORbMbw5BABWVsFmBL/ORaXILuW5jIvjMD0yVSF7kvWfDYpQWRAoz+McpWTw21vvXnZDDWsCEYjGlKYKY2uZV9iI4qimCbDrIMtALD6bNGdpsXZHR1BFCPBzXhGqWQ6klknljSH06OLrsGVBYBg2+RSuQw96GROGjWb1H+TsAVjEy4FsDl+ZwBaAuGdLJhmm3ZPxH6R94pn+8dsXAMzpAsvbd9edgu+A4jBQguwYUgvTZboGEfZsnUve8jSxGRHLtYfYMLWdpAhS+HtInqCLlord00ba63T87GbLrto3ku8vygrl5uPYGDXdsgeTExe6CBOPDADjlEXTiD0PXbVqZmNvSTvK3J1/qkj+wUDKE2rCysKKZZtlVKlYm5s+Oj3l/LMvSSDcF9ev//aqf/I3r2wAEDKNbABsIugbMyMsLMOOeZ+Uop8vvphHui70lMltJKaEzYrZUCKeOarCYCDoUmzL1J7jxNWqkX5dn2DMtT6DyDYzbQxUQaTAFfKPoOYmFhUi2X98llOfn65T52QVaDKW2csAKEr6LmFzncJVkMGyKFmDBl8N42Omfp27vh33//y2FAK27EGx91kRDKgC4IFKau6Mh8okDDjoiwNfgo52gvy+nPzxCNEuJ7b82Chx8Yj1ZuOSzF5QWCWnV+kb+z1Q3tUNpR5uO2PPJEXKdUeaMDMgCVhTYYl6Ya0oE9+MbhSZ/Q9z55mCAC/HEB8GiDWqlQFpM1OrwCJgxw2Cw2mQXRUAIvg3kief0hYgvwCebjrX7n96rvstIkVlH8C4HTYUbMI3LozQNLsfw0OZqyNhgtG4CRBu+JmU/myCWHnEY4mfQV6fe7fPolq1m0rpTn9+mKLk7vVAaKI+gtWfrjtW9HFkDoCG2rNWYdxWAaAruUYByGujSBKSQO/tVL7pfuH/k1fVRPe9WMR/S020q7Z0WwuDYxvIigL+IwwHR2kGoLHwzAeukvcN9XJq3cWAHi8728UvHcq16zbgpBCsBHi91riuib/Vw/GKSNqLDt/PwMsw8f7/trN4l/JhaNJ7X7wbP3bhSxoeFCJnkIIi8wBgrIFE9EHfrdX2nPBZo3gkMLiqzpuR98ODMwzEP59NdXdXgYI5B8W0ukvit6GagAAAABJRU5ErkJggolQTkcNChoKAAAADUlIRFIAAAAgAAAAIAgGAAAAc3p69AAAAAFzUkdCAK7OHOkAAAUpSURBVFhHdVcJkhtHDCPp//9lfaRyOv5TErvinR4yBYB9SN5slVbSjCSCIAiyPcf44mZpZllm93yN930t3azKCu/LzQ3P+Hf+4WZY3ywz9+AH8Ul82PueXu5rXmN8MbP7/wBMIPhOWmZ44NsEkGYVz0hwHWgIyAVCf/O1ngXQAeDPZwBldbs5GdDvZYYFgj48TgCZE8yOebKyAYSnpYVtAJ8tDNfuWYJnAJ1UIvdnMAKBoAXif+ADbKg0CEhIzBz1FgM5PiM4WVhADgbcMitZomYBv9lg+ItkBSAmI7sEonECSNxo6gVGJfjjEJ+A6O4C1Azc0SXZpQEQP8siBoDwOfBiYLJBugQAwQiiGWgQdxIMs7/DgqBwTUCkEcZC/Sf7qz/WFWfmTX1rgcGtDgAz6PNzmo0QKwg+BKYFWiiPynB2g7KX2FZgQVXg+fCIxcAMXGbDO1gHRtAhIK4SVZcJwZFH0iR27gzerUf7OGhP2ArfA/NDCRgYwQACj2DGTgALRNmdAKDMDxGKA4ZblD+IDioFMI8OnplLhCt4B7rCfGTWFbEBWNlA9gAAHbTWugvCEgWRBXXLNd0ILAtlcIAwMrFLMMxilOXlFsOyrjS7Ipj5RQbKRjaAo1PQ5SyBnHwGF/0QX0RA2up9BAYUMpBuKQC/I7hZXnquy5JBrwy7UIbU+xGsfaxWFQPku9jtXXjVGJZ1ik41Z+bvAGoxkL9V2eXOLC+rYnALE5BoAAVNxJ2Wo40LfnowcJignGi6nxPIYqIZaCa8rvy1aVbgCQAMoAwWI8EO6Ef2mWzFc0gtBhAWzfoukCnNYtWdbBz0QwsOEV75CwKX2au/GXxrwFI+8CYASPNJgEnbRa0nAxMAgUWWAPxsZq/K3sUCHikGpA2J8Kj/IwNoSkt2/DYg1LsBsAMkPOkC9YC1pnt+z58c9TYHzVdWvlILDD7FeQDA4ArYc6TdnHXdAYcPSGxzB3DzFiABdAc0IAD45OFXZr6aRetgZg4AEGFeURLgnAnUQNvwnoIow+kBzQAB2VI/mnPqwfN7fZwa2PRDdDt72nADQOZt0RjT3QUMfLbB7oIlPniAmIADqitYgvpAAIuB9oPSswZQDqvuf+4OKSsOmFCvHMuI2oyOEqxu8EcXBAue/9Z7Alh1R0eIgaLqc1jEbfdqvy3AYv2188xh1PN5rlx78rUTHjZ8AKhX+L47gy7l11I+ggenYGbeNFf6HryRfgscXYYewmsctxvWj66oLvhWL7vdQm7Y048AaDyB7Qgs3PAPgWj6xQKD5ywD+1FmRAbWGjZngrwBc8LHt3pR3+dlgUE0Xc9IfTX12o7mGMZAe9yUsw4haib3/ve0DfVI7nnhPr4CQMGEaLmwXpmOMseqVpXDLZCP6g8BaremBgLZ4yqk8DCSeynhYNI2/LgRmfv1NV8cs39SnzbC2fub+rK7ss1He+PyAESUDzD644kp52b0tBWxLL2UXn/Xe0w+KX46nvbArKl8LaRF4yEQBNIY1ikJjnDuBO0Ji/65K2lCdnCuZATQK9gGgJEbt3nXHdmjhTMbRJQqomWE++DSwFum1BsyAj9tyH79Ux961RqFnaAn3swe1jtXsD64JJiAA+k4NLugl5LuiL0gzk3xPBmJGRxYAeBjBx3qe5wR5HzVZwIOnuJpCAXvRQRXSHwfTKjI1sAbLBytiW2c65qb+/e/6pO2X+x8bblYvQLCQ9s1/TqAtPjmFDwPq9l6aFOiOfZ86LZU3vtwip/7DzD202ASUpssAAAAAElFTkSuQmCCiVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAA51JREFUWEd9VwF26jAMS7r7X+xvgxUGHeMuzX+2ZUdOw3hjhdLGsiTbaV3fb63gVUu1T1X+5HMtVT5XOS56XOpSlsXfb/j+1s/JdfI73SNr2Rq+pp6xOJePewCw2A4Cn+RGWoBBCKgjGAluYB20B58CuX4KAARF+vptwoKcTJkhUwERYACqB18OCTgQobdeT1uz8B1E0DPIYJKMb6fbMtbsRwnk3Hivf/8+/agElrVDwTE0cx+4dgDhOiaZuldey+AS1VJvZwFAHHhQxaMOJPQdiLORDAzZktmUFWdtwsTt/GiWOGXPC01M2B3dhWMnh5EPknUAAqqINPevhzKQJEBQy16yJsrYAyRbaaU0+xdHsxYxmABhzfv6m0yo2f2h7WhCl0COrUn0Jn/6WQFRZfnaKaFt/TUGIIMz0S9m1x+ZGAFoYHoHI8RyWntbn+GBCO6A0Ey6icbmkst3DN72XTkwZoIMdFgktl2eIUGw4DoPmi0LuRn+8NJV6hFMgex72Uc2iK6olJ/L0/oA1fyx4QzNRoCoT7iDQvcUdC9tbwZEtYArRHSXXAGMbReLW98n2qPD8WCxtIRl9b9mj6AKZk+esMvInAbAK5em36xkBgDG2gRAa2XfsxnDH8yEMD9lgMcmRrA6d7FxnEcrAQDVEuwAAOxYmfYSHQCwF/LQ4cAybGy4cBV4xhMvTIJ7ZQQA7obW/frA0caBCsgMOGBvPKbvoRwVAH5zn8AHdbtIJ8TuxOfBIAF3vwQgzIta5zKE2bL21qb9nPInAIzIIwgvtQygV4VXDzvb9OVsc+beslWC0krd1odWQYCIAQIZqCQPm5G0k0KzA7WWaQ8eswLn3Yj1LgCIAQaS5zqZklo1zwJrCKgKnozejuOIgSUM3L9+goHMwmRnzGyEZHkeoB11XC7JCxD1JgDwSntDMhi36eQLyHVgIZ2AFN6w0p6hlfp93vqekJ4LEhs8rh3YMIx6S8jzwTVBp7Z2HSYtAsCfC8YbDXLeXuGMD5JhD5GYnCw3A1Gvp/xgMqezw0iblxEId0ar6lcejclYL5/90SyuTs9KtEYMLd/rzcY48fAnCNuk1PXj+xguarkvNmbjk7Bv3XtbjinJgAcuLGgr9evj2veOOBnjeiRQ7hr3jun5gZ8l+EEnlRn1ilLq+f1CAICLOXkph7dv7CGwf4i9BVVJGppDUvX8b/XNDHY0dAU1EZATzuLZETKkBxoCaMUzff0HoSooXRgUZWAAAAAASUVORK5CYIKJUE5HDQoaCgAAAA1JSERSAAAAIAAAACAIBgAAAHN6evQAAAABc1JHQgCuzhzpAAAELElEQVRYR41XaWsUQRCtav//j/KDxmg28SCgoIKIIh4ooohmp1te3d2zHpBJz7E779Wrqle9fHn+cAwiIvunF3ojzuOePyMixh8Ts5zIKode4M/Ocy3fjlM+3Luq+AU4CYxklV9UBgEaBATZCOAcXG09SeACBAzApahrgI+hIknwBl5JuALL+m8CZ5eGZwAAkiPTMCmA+xrYHH2zFPwPAfu+vOPB2cHeb6CFgFAyMifTsIA1XLdm9WBaeY04a71tSoLA3YOIKxEHeKqgasjDLEp/RyXQmBo7eFXDiRiyZi9Y8P27Fyp2jVzOO43uRBRcFYlCiC5AkTVJQSMWIklAClK6RXKm4F6cmYIKZOd9UN+R8DqZ21BBHfwPJAq44isZvriHGrAIR6fuURcCMxEtTqtCyTcibsh9axp9WWt7pjeYIiBxOL8yAip7BxmA9y5pwaqkMiVpBip1gIYSLVKiz0pKLB3uDXz14GEhANlBIEEBLmRckWJK7oQKoKBQItIRHbFv0XDSx5dPFgIGZlGLAkaqFmr4QCk4AQ8y2hFRnJM7lqK8fnRtHZjFJ9IXyddirJaaOa7gFrHXgtvziW7gp9fPpALVBqznd34wt+NpAkXmxRNc7rp6H/DzZy+iucVwSr9PBqVmIdjFjaO3dSrOBhSTsfR+JS+3X718lcO2DJz44IlJGEZaXW0av+l63u+leTUE7+S3r9+MMOe0abtVTNPMI0w0Bko11t0LShyGuCjMH969FwLhTmXSeaX789VGK/GMcNm9GOB+uqr58ZdPn0fkz0fsZJu+0zEv/8vmwqV1Cj5BY7zr2JvmDn//+k0I7I+yzbLnRNStBvVNNltEeK1MrGLxUcA2RdNDFgK/fvxMAjbJDGizFaD1XGfz3AwCakdbznEdxxjE2e5getzwMgA4SF0XEqNLcDmU/dTA2cGb6ePAtyqJfMYNBL4v4BvR2Ii4RI5rwnTqRG0Q9aFBgUknGK4mYKAZGxFWfEAInTiM6CAGgY8zAQcf2xhjY8l7A5lOTZC7NYoUtlmBKtB7KuDAmFIzEf2s1QoIvMkUjI0GIu/Ii4I3Ad8QvYEvKYjc60jUWtColVAjVwjntg+xbZEo8FIkH4gcYH2j1lzyWgOqQhagm0wUINqaq+TMyJffY8lWFqv+qhg329OIuETraXEllujL7yffG0nUEv1CxBXRXkcI9pNGOnnc3Dx2mT3nIb9Wm6jAGrkrEKOp1sAKXKMX1/PosYNBPWMv1bftwFLduzaMex49VqQAIcFhYxbZiye5J6nNnIyEFm+TfuZxPJ4vxhN5/0P0MrSNxNwFO1CASJuyK+Cd4ysI3Fmdr6YAz7BLRJPXAvSfKb65yn1yiVYqHnKHbWrUOcWY+/F4W3tdjz245h8kVH5xgakI8cI1MolYcp3g1jY+yGX9DWJsXoAJtq1HAAAAAElFTkSuQmCCiVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAABW5JREFUWEd1VzGLJWUQ7O5v3rs/L4ggCAaCgYGBgYGBgWAgCIKBYCBcYrC7t08xuX27iU63VHX3zDe7e3M3fPPmbl/XV1Vd/a0+XjxCRCRC+Aefpmd8xu3hEuHi7nzm6qusteI53+W/h/v2ffxOlJBccwkJFdHHS/yrKhYhKhK6gTmAQPEEsRfJguuKFUBW8bUAFYAEjW/MTTSMRJEXADyJiAkAqBje8TPAPAPhji9KECx4KLwSTL4HC6uEN3MFAhD4t5hAsesl3oMJFm4QIVZgAMhQNKWY6Z9AoDCL//dBEDsLe3G808f7+Id7pwQCCQyS1GcAGcmIjCOAonsu/CqI9E5vYJchedDru7gv2gmAflBRDTGCQXGASFaWiLD0Qkmw7R4s7AyAjTZqe4clS9b0fYhe7+Omdz8Dwa7JRO6eDPBWWURiaQNCc9KP4nzutf2wbl1BU3an1QoG/mxDbgB2Q7YpNxmUAOSEmwW7aBlwZwEMTKYEYy0Fizu7Qx9u/S2JB/1txn09mLFYAIAEoXL2eceH3e9MoCO6M7AmC+kLvd7FHzQDDcgnlaALoH+15DMZsjhYOIvEqdvvhQxzq9Yz/cCcQDUXfbiL37NuMlChlW2Z2qNDTE0GTAlDamwynEXlTUQscwsCSNN/yIsXIADgNn6bgymTQlWUQTkFEzsCIOAHyqAKBiRBuI/0xNwJU1jh/RzbFWgA8GuGM6hPJo5dESqh7YWpE3YfqMgbAPFYrbtiZ+BDbGRa6vub+CVDWVQ8vQBArtj+xEDOC7LQDIjJSSK9oCpvwMQ8GzIL9nbsrpm7Awz8XBENwTUxZIcghDxEzdKEACDBLGAe6MGMBAFTnl8WqnZ9Zkr8PwD4aZ4Nr5mQQDoVdwYAArtvIOcQORv8wKB6befZmvMY14eb+BENoYr0DRGHASnHbETsHBE9SoIhEimF6olM5H2GLJAjIsYGIo5gZnBg4IeZAQ6kGkzdgjUHciBlG1bx7IYQWQxs4A45qbEzTs0ECzKM5q4oEz7cxvcwHzuhEhG6byGEUDLNYZSFR2gMDUXxmg2yhMpiaUq0J8GUJ07rPLwYyX16yi74bj8nJf0K+mFITkCGQgLogVR5oDmqF4YTmEhjLgog+R7GZGRHuG0MTIAgwbcNgLXThRlC3Ql5PugWHBJholpsyLCdCQJSY3EwQG80CM6OTkOcqpADD3fxTUpQWdBPNGG1YkawqaMtw8x04FygAKE4qMgw63ENc2rLkEBqcB1kqVTU62183VGM4WCKOgWHUlQSmhgOKWhHgpEwSEOHCCUwpxQxVHQRsJBxfWJggYmMbRoUzzCpXu/Wr3LmHK4MIzQiQbiamrnnlORhpYDwGbsndhkJIj3BwwtOUSKnrUsyNTFD6A29vlu/fAWACA8MqFMHVq4MaBN3VbM8KR1OTfCGDDG0qiaAyO7wkmLzQ3rjjEPpFxEeubHp4vE5QcwHFT6rgwBzABJYos4LadZBJiSGKVuVMiAr2pRlzJTi8X79PBlwjvtXLuz8JRsF4nBowczQMHMdbjFUlW1ZLcnIBhPWyUkAl/hM8BsHGX0OwgXeY3kOKtozZYEULQtYaDmaBWWrQgJIkiAiFjHd2pNMPF3iU0pA9nJ9cUHZRFGecHixDyvpDexg84NnaNGQxqDi9MQdsoAFJibmxtNf8QlSOScuGMD1HERLUAxA9UpLTi8QUJLkD7uZ2nCAoCGREdWedaxX05MDxNPf8bHgoFr0Y18OSaYLNjvKgAh41h0lQygBDYQWigsi2JCWdpgdNcYXfbqsH2EDzQLWZiF5SOXpdUcM1Vpe4AGGjqi2dIcQsARor/h2HK4SALpDFDKwTf8HJrT5DNu0ZrwAAAAASUVORK5CYII="});Ye();je();we();ie();di();rs();Ki();ns();zs();xr();var c_=class{constructor(){this._zoomStopsAnimation=!1,this._idleRotationSpeed=.05,this._idleRotationWaitTime=2e3,this._idleRotationSpinupTime=2e3,this.targetAlpha=null,this._isPointerDown=!1,this._lastFrameTime=null,this._lastInteractionTime=-1/0,this._cameraRotationSpeed=0,this._lastFrameRadius=0}get name(){return"AutoRotation"}set zoomStopsAnimation(e){this._zoomStopsAnimation=e}get zoomStopsAnimation(){return this._zoomStopsAnimation}set idleRotationSpeed(e){this._idleRotationSpeed=e}get idleRotationSpeed(){return this._idleRotationSpeed}set idleRotationWaitTime(e){this._idleRotationWaitTime=e}get idleRotationWaitTime(){return this._idleRotationWaitTime}set idleRotationSpinupTime(e){this._idleRotationSpinupTime=e}get idleRotationSpinupTime(){return this._idleRotationSpinupTime}get rotationInProgress(){return Math.abs(this._cameraRotationSpeed)>0}init(){}attach(e){this._attachedCamera=e;let t=this._attachedCamera.getScene();this._onPrePointerObservableObserver=t.onPrePointerObservable.add(i=>{if(i.type===ce.POINTERDOWN){this._isPointerDown=!0;return}i.type===ce.POINTERUP&&(this._isPointerDown=!1)}),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{if(this._reachTargetAlpha())return;let i=Zt.Now,r=0;this._lastFrameTime!=null&&(r=i-this._lastFrameTime),this._lastFrameTime=i,this._applyUserInteraction();let n=i-this._lastInteractionTime-this._idleRotationWaitTime,a=Math.max(Math.min(n/this._idleRotationSpinupTime,1),0);this._cameraRotationSpeed=this._idleRotationSpeed*a,this._attachedCamera&&(this._attachedCamera.alpha-=this._cameraRotationSpeed*(r/1e3))})}detach(){if(!this._attachedCamera)return;let e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._attachedCamera=null,this._lastFrameTime=null}resetLastInteractionTime(e){this._lastInteractionTime=e??Zt.Now}_reachTargetAlpha(){return this._attachedCamera&&this.targetAlpha?Math.abs(this._attachedCamera.alpha-this.targetAlpha)<We:!1}_userIsZooming(){return this._attachedCamera?this._attachedCamera.inertialRadiusOffset!==0:!1}_shouldAnimationStopForInteraction(){if(!this._attachedCamera)return!1;let e=!1;return this._lastFrameRadius===this._attachedCamera.radius&&this._attachedCamera.inertialRadiusOffset!==0&&(e=!0),this._lastFrameRadius=this._attachedCamera.radius,this._zoomStopsAnimation?e:this._userIsZooming()}_applyUserInteraction(){this._userIsMoving()&&!this._shouldAnimationStopForInteraction()&&(this._lastInteractionTime=Zt.Now)}_userIsMoving(){return this._attachedCamera?this._attachedCamera.inertialAlphaOffset!==0||this._attachedCamera.inertialBetaOffset!==0||this._attachedCamera.inertialRadiusOffset!==0||this._attachedCamera.inertialPanningX!==0||this._attachedCamera.inertialPanningY!==0||this._isPointerDown:!1}};cu();ws();var bf=class s{constructor(){this.transitionDuration=450,this.lowerRadiusTransitionRange=2,this.upperRadiusTransitionRange=-2,this._autoTransitionRange=!1,this._radiusIsAnimating=!1,this._radiusBounceTransition=null,this._animatables=new Array}get name(){return"Bouncing"}get autoTransitionRange(){return this._autoTransitionRange}set autoTransitionRange(e){if(this._autoTransitionRange===e)return;this._autoTransitionRange=e;let t=this._attachedCamera;t&&(e?this._onMeshTargetChangedObserver=t.onMeshTargetChangedObservable.add(i=>{if(i&&(i.computeWorldMatrix(!0),i.getBoundingInfo)){let r=i.getBoundingInfo().diagonalLength;this.lowerRadiusTransitionRange=r*.05,this.upperRadiusTransitionRange=r*.05}}):this._onMeshTargetChangedObserver&&t.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver))}init(){}attach(e){this._attachedCamera=e,this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{this._attachedCamera&&(this._isRadiusAtLimit(this._attachedCamera.lowerRadiusLimit)&&this._applyBoundRadiusAnimation(this.lowerRadiusTransitionRange),this._isRadiusAtLimit(this._attachedCamera.upperRadiusLimit)&&this._applyBoundRadiusAnimation(this.upperRadiusTransitionRange))})}detach(){this._attachedCamera&&(this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null)}_isRadiusAtLimit(e){return this._attachedCamera?this._attachedCamera.radius===e&&!this._radiusIsAnimating:!1}_applyBoundRadiusAnimation(e){if(!this._attachedCamera)return;this._radiusBounceTransition||(s.EasingFunction.setEasingMode(s.EasingMode),this._radiusBounceTransition=q.CreateAnimation("radius",q.ANIMATIONTYPE_FLOAT,60,s.EasingFunction)),this._cachedWheelPrecision=this._attachedCamera.wheelPrecision,this._attachedCamera.wheelPrecision=1/0,this._attachedCamera.inertialRadiusOffset=0,this.stopAllAnimations(),this._radiusIsAnimating=!0;let t=q.TransitionTo("radius",this._attachedCamera.radius+e,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusBounceTransition,this.transitionDuration,()=>this._clearAnimationLocks());t&&this._animatables.push(t)}_clearAnimationLocks(){this._radiusIsAnimating=!1,this._attachedCamera&&(this._attachedCamera.wheelPrecision=this._cachedWheelPrecision)}stopAllAnimations(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0].onAnimationEnd=null,this._animatables[0].stop(),this._animatables.shift()}};bf.EasingFunction=new xf(.3);bf.EasingMode=hr.EASINGMODE_EASEOUT;cu();we();ns();zs();ie();ws();var Ko=class s{constructor(){this.onTargetFramingAnimationEndObservable=new N,this._mode=s.FitFrustumSidesMode,this._radiusScale=1,this._positionScale=.5,this._defaultElevation=.3,this._elevationReturnTime=1500,this._elevationReturnWaitTime=1e3,this._zoomStopsAnimation=!1,this._framingTime=1500,this.autoCorrectCameraLimitsAndSensibility=!0,this._isPointerDown=!1,this._lastInteractionTime=-1/0,this._animatables=new Array,this._betaIsAnimating=!1}get name(){return"Framing"}set mode(e){this._mode=e}get mode(){return this._mode}set radiusScale(e){this._radiusScale=e}get radiusScale(){return this._radiusScale}set positionScale(e){this._positionScale=e}get positionScale(){return this._positionScale}set defaultElevation(e){this._defaultElevation=e}get defaultElevation(){return this._defaultElevation}set elevationReturnTime(e){this._elevationReturnTime=e}get elevationReturnTime(){return this._elevationReturnTime}set elevationReturnWaitTime(e){this._elevationReturnWaitTime=e}get elevationReturnWaitTime(){return this._elevationReturnWaitTime}set zoomStopsAnimation(e){this._zoomStopsAnimation=e}get zoomStopsAnimation(){return this._zoomStopsAnimation}set framingTime(e){this._framingTime=e}get framingTime(){return this._framingTime}init(){}attach(e){this._attachedCamera=e;let t=this._attachedCamera.getScene();s.EasingFunction.setEasingMode(s.EasingMode),this._onPrePointerObservableObserver=t.onPrePointerObservable.add(i=>{if(i.type===ce.POINTERDOWN){this._isPointerDown=!0;return}i.type===ce.POINTERUP&&(this._isPointerDown=!1)}),this._onMeshTargetChangedObserver=e.onMeshTargetChangedObservable.add(i=>{i&&i.getBoundingInfo&&this.zoomOnMesh(i,void 0,()=>{this.onTargetFramingAnimationEndObservable.notifyObservers()})}),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{this._applyUserInteraction(),this._maintainCameraAboveGround()})}detach(){if(!this._attachedCamera)return;let e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null}zoomOnMesh(e,t=!1,i=null){e.computeWorldMatrix(!0);let r=e.getBoundingInfo().boundingBox;this.zoomOnBoundingInfo(r.minimumWorld,r.maximumWorld,t,i)}zoomOnMeshHierarchy(e,t=!1,i=null){e.computeWorldMatrix(!0);let r=e.getHierarchyBoundingVectors(!0);this.zoomOnBoundingInfo(r.min,r.max,t,i)}zoomOnMeshesHierarchy(e,t=!1,i=null){let r=new E(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),n=new E(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(let a=0;a<e.length;a++){let o=e[a].getHierarchyBoundingVectors(!0);E.CheckExtends(o.min,r,n),E.CheckExtends(o.max,r,n)}this.zoomOnBoundingInfo(r,n,t,i)}zoomOnBoundingInfo(e,t,i=!1,r=null){let n;if(!this._attachedCamera)return!1;let a=e.y,o=t.y,l=a+(o-a)*this._positionScale,c=t.subtract(e).scale(.5);if(!isFinite(l))return!1;if(i)n=new E(0,l,0);else{let u=e.add(c);n=new E(u.x,l,u.z)}this._vectorTransition||(this._vectorTransition=q.CreateAnimation("target",q.ANIMATIONTYPE_VECTOR3,60,s.EasingFunction)),this._betaIsAnimating=!0;let f=q.TransitionTo("target",n,this._attachedCamera,this._attachedCamera.getScene(),60,this._vectorTransition,this._framingTime);f&&this._animatables.push(f);let h=0;if(this._mode===s.FitFrustumSidesMode){let u=this._calculateLowerRadiusFromModelBoundingSphere(e,t);this.autoCorrectCameraLimitsAndSensibility&&(this._attachedCamera.lowerRadiusLimit=c.length()+this._attachedCamera.minZ),h=u}else this._mode===s.IgnoreBoundsSizeMode&&(h=this._calculateLowerRadiusFromModelBoundingSphere(e,t),this.autoCorrectCameraLimitsAndSensibility&&this._attachedCamera.lowerRadiusLimit===null&&(this._attachedCamera.lowerRadiusLimit=this._attachedCamera.minZ));if(this.autoCorrectCameraLimitsAndSensibility){let u=t.subtract(e).length();this._attachedCamera.panningSensibility=5e3/u,this._attachedCamera.wheelPrecision=100/h}return this._radiusTransition||(this._radiusTransition=q.CreateAnimation("radius",q.ANIMATIONTYPE_FLOAT,60,s.EasingFunction)),f=q.TransitionTo("radius",h,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusTransition,this._framingTime,()=>{this.stopAllAnimations(),r&&r(),this._attachedCamera&&this._attachedCamera.useInputToRestoreState&&this._attachedCamera.storeState()}),f&&this._animatables.push(f),!0}_calculateLowerRadiusFromModelBoundingSphere(e,t){let i=this._attachedCamera;if(!i)return 0;let r=i._calculateLowerRadiusFromModelBoundingSphere(e,t,this._radiusScale);return i.lowerRadiusLimit&&this._mode===s.IgnoreBoundsSizeMode&&(r=r<i.lowerRadiusLimit?i.lowerRadiusLimit:r),i.upperRadiusLimit&&(r=r>i.upperRadiusLimit?i.upperRadiusLimit:r),r}_maintainCameraAboveGround(){if(this._elevationReturnTime<0)return;let e=Zt.Now-this._lastInteractionTime,t=Math.PI*.5-this._defaultElevation,i=Math.PI*.5;if(this._attachedCamera&&!this._betaIsAnimating&&this._attachedCamera.beta>i&&e>=this._elevationReturnWaitTime){this._betaIsAnimating=!0,this.stopAllAnimations(),this._betaTransition||(this._betaTransition=q.CreateAnimation("beta",q.ANIMATIONTYPE_FLOAT,60,s.EasingFunction));let r=q.TransitionTo("beta",t,this._attachedCamera,this._attachedCamera.getScene(),60,this._betaTransition,this._elevationReturnTime,()=>{this._clearAnimationLocks(),this.stopAllAnimations()});r&&this._animatables.push(r)}}_clearAnimationLocks(){this._betaIsAnimating=!1}_applyUserInteraction(){this.isUserIsMoving&&(this._lastInteractionTime=Zt.Now,this.stopAllAnimations(),this._clearAnimationLocks())}stopAllAnimations(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0]&&(this._animatables[0].onAnimationEnd=null,this._animatables[0].stop()),this._animatables.shift()}get isUserIsMoving(){return this._attachedCamera?this._attachedCamera.inertialAlphaOffset!==0||this._attachedCamera.inertialBetaOffset!==0||this._attachedCamera.inertialRadiusOffset!==0||this._attachedCamera.inertialPanningX!==0||this._attachedCamera.inertialPanningY!==0||this._isPointerDown:!1}};Ko.EasingFunction=new Af;Ko.EasingMode=hr.EASINGMODE_EASEINOUT;Ko.IgnoreBoundsSizeMode=0;Ko.FitFrustumSidesMode=1;Vn();EC();Ye();je();Yn();Ye();je();$e();ns();var fu=class{constructor(){this._currentMousePointerIdDown=-1,this.buttons=[0,1,2]}attachControl(e){e=W.BackCompatCameraNoPreventDefault(arguments);let t=this.camera.getEngine(),i=t.getInputElement(),r=0,n=null;this._pointA=null,this._pointB=null,this._altKey=!1,this._ctrlKey=!1,this._metaKey=!1,this._shiftKey=!1,this._buttonsPressed=0,this._pointerInput=o=>{let l=o.event,c=l.pointerType==="touch";if(o.type!==ce.POINTERMOVE&&this.buttons.indexOf(l.button)===-1)return;let f=l.target;if(this._altKey=l.altKey,this._ctrlKey=l.ctrlKey,this._metaKey=l.metaKey,this._shiftKey=l.shiftKey,this._buttonsPressed=l.buttons,t.isPointerLock){let h=l.movementX,u=l.movementY;this.onTouch(null,h,u),this._pointA=null,this._pointB=null}else{if(o.type!==ce.POINTERDOWN&&o.type!==ce.POINTERDOUBLETAP&&c&&this._pointA?.pointerId!==l.pointerId&&this._pointB?.pointerId!==l.pointerId)return;if(o.type===ce.POINTERDOWN&&(this._currentMousePointerIdDown===-1||c)){try{f?.setPointerCapture(l.pointerId)}catch{}if(this._pointA===null)this._pointA={x:l.clientX,y:l.clientY,pointerId:l.pointerId,type:l.pointerType};else if(this._pointB===null)this._pointB={x:l.clientX,y:l.clientY,pointerId:l.pointerId,type:l.pointerType};else return;this._currentMousePointerIdDown===-1&&!c&&(this._currentMousePointerIdDown=l.pointerId),this.onButtonDown(l),e||(l.preventDefault(),i&&i.focus())}else if(o.type===ce.POINTERDOUBLETAP)this.onDoubleTap(l.pointerType);else if(o.type===ce.POINTERUP&&(this._currentMousePointerIdDown===l.pointerId||c)){try{f?.releasePointerCapture(l.pointerId)}catch{}c||(this._pointB=null),t._badOS?this._pointA=this._pointB=null:this._pointB&&this._pointA&&this._pointA.pointerId==l.pointerId?(this._pointA=this._pointB,this._pointB=null):this._pointA&&this._pointB&&this._pointB.pointerId==l.pointerId?this._pointB=null:this._pointA=this._pointB=null,(r!==0||n)&&(this.onMultiTouch(this._pointA,this._pointB,r,0,n,null),r=0,n=null),this._currentMousePointerIdDown=-1,this.onButtonUp(l),e||l.preventDefault()}else if(o.type===ce.POINTERMOVE){if(e||l.preventDefault(),this._pointA&&this._pointB===null){let h=l.clientX-this._pointA.x,u=l.clientY-this._pointA.y;this._pointA.x=l.clientX,this._pointA.y=l.clientY,this.onTouch(this._pointA,h,u)}else if(this._pointA&&this._pointB){let h=this._pointA.pointerId===l.pointerId?this._pointA:this._pointB;h.x=l.clientX,h.y=l.clientY;let u=this._pointA.x-this._pointB.x,d=this._pointA.y-this._pointB.y,p=u*u+d*d,m={x:(this._pointA.x+this._pointB.x)/2,y:(this._pointA.y+this._pointB.y)/2,pointerId:l.pointerId,type:o.type};this.onMultiTouch(this._pointA,this._pointB,r,p,n,m),n=m,r=p}}}},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,ce.POINTERDOWN|ce.POINTERUP|ce.POINTERMOVE|ce.POINTERDOUBLETAP),this._onLostFocus=()=>{this._pointA=this._pointB=null,r=0,n=null,this.onLostFocus()},this._contextMenuBind=o=>this.onContextMenu(o),i&&i.addEventListener("contextmenu",this._contextMenuBind,!1);let a=this.camera.getScene().getEngine().getHostWindow();a&&W.RegisterTopRootEvents(a,[{name:"blur",handler:this._onLostFocus}])}detachControl(){if(this._onLostFocus){let e=this.camera.getScene().getEngine().getHostWindow();e&&W.UnregisterTopRootEvents(e,[{name:"blur",handler:this._onLostFocus}])}if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._contextMenuBind){let e=this.camera.getScene().getEngine().getInputElement();e&&e.removeEventListener("contextmenu",this._contextMenuBind)}this._onLostFocus=null}this._altKey=!1,this._ctrlKey=!1,this._metaKey=!1,this._shiftKey=!1,this._buttonsPressed=0,this._currentMousePointerIdDown=-1}getClassName(){return"BaseCameraPointersInput"}getSimpleName(){return"pointers"}onDoubleTap(e){}onTouch(e,t,i){}onMultiTouch(e,t,i,r,n,a){}onContextMenu(e){e.preventDefault()}onButtonDown(e){}onButtonUp(e){}onLostFocus(){}};x([y()],fu.prototype,"buttons",void 0);var dr=class s extends fu{constructor(){super(...arguments),this.buttons=[0,1,2],this.angularSensibilityX=1e3,this.angularSensibilityY=1e3,this.pinchPrecision=12,this.pinchDeltaPercentage=0,this.useNaturalPinchZoom=!1,this.pinchZoom=!0,this.panningSensibility=1e3,this.multiTouchPanning=!0,this.multiTouchPanAndZoom=!0,this.pinchInwards=!0,this._isPanClick=!1,this._twoFingerActivityCount=0,this._isPinching=!1}getClassName(){return"ArcRotateCameraPointersInput"}_computeMultiTouchPanning(e,t){if(this.panningSensibility!==0&&e&&t){let i=t.x-e.x,r=t.y-e.y;this.camera.inertialPanningX+=-i/this.panningSensibility,this.camera.inertialPanningY+=r/this.panningSensibility}}_computePinchZoom(e,t){let i=this.camera.radius||s.MinimumRadiusForPinch;this.useNaturalPinchZoom?this.camera.radius=i*Math.sqrt(e)/Math.sqrt(t):this.pinchDeltaPercentage?this.camera.inertialRadiusOffset+=(t-e)*.001*i*this.pinchDeltaPercentage:this.camera.inertialRadiusOffset+=(t-e)/(this.pinchPrecision*(this.pinchInwards?1:-1)*(this.angularSensibilityX+this.angularSensibilityY)/2)}onTouch(e,t,i){this.panningSensibility!==0&&(this._ctrlKey&&this.camera._useCtrlForPanning||this._isPanClick)?(this.camera.inertialPanningX+=-t/this.panningSensibility,this.camera.inertialPanningY+=i/this.panningSensibility):(this.camera.inertialAlphaOffset-=t/this.angularSensibilityX,this.camera.inertialBetaOffset-=i/this.angularSensibilityY)}onDoubleTap(){this.camera.useInputToRestoreState&&this.camera.restoreState()}onMultiTouch(e,t,i,r,n,a){i===0&&n===null||r===0&&a===null||(this.multiTouchPanAndZoom?(this._computePinchZoom(i,r),this._computeMultiTouchPanning(n,a)):this.multiTouchPanning&&this.pinchZoom?(this._twoFingerActivityCount++,this._isPinching||this._twoFingerActivityCount<20&&Math.abs(Math.sqrt(r)-Math.sqrt(i))>this.camera.pinchToPanMaxDistance?(this._computePinchZoom(i,r),this._isPinching=!0):this._computeMultiTouchPanning(n,a)):this.multiTouchPanning?this._computeMultiTouchPanning(n,a):this.pinchZoom&&this._computePinchZoom(i,r))}onButtonDown(e){this._isPanClick=e.button===this.camera._panningMouseButton}onButtonUp(e){this._twoFingerActivityCount=0,this._isPinching=!1}onLostFocus(){this._isPanClick=!1,this._twoFingerActivityCount=0,this._isPinching=!1}};dr.MinimumRadiusForPinch=.001;x([y()],dr.prototype,"buttons",void 0);x([y()],dr.prototype,"angularSensibilityX",void 0);x([y()],dr.prototype,"angularSensibilityY",void 0);x([y()],dr.prototype,"pinchPrecision",void 0);x([y()],dr.prototype,"pinchDeltaPercentage",void 0);x([y()],dr.prototype,"useNaturalPinchZoom",void 0);x([y()],dr.prototype,"pinchZoom",void 0);x([y()],dr.prototype,"panningSensibility",void 0);x([y()],dr.prototype,"multiTouchPanning",void 0);x([y()],dr.prototype,"multiTouchPanAndZoom",void 0);ur.ArcRotateCameraPointersInput=dr;Ye();je();Yn();Tm();$e();var Kr=class{constructor(){this.keysUp=[38],this.keysDown=[40],this.keysLeft=[37],this.keysRight=[39],this.keysReset=[220],this.panningSensibility=50,this.zoomingSensibility=25,this.useAltToZoom=!0,this.angularSpeed=.01,this._keys=new Array}attachControl(e){e=W.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{let i=t.event;if(!i.metaKey){if(t.type===$s.KEYDOWN)this._ctrlPressed=i.ctrlKey,this._altPressed=i.altKey,(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysReset.indexOf(i.keyCode)!==-1)&&(this._keys.indexOf(i.keyCode)===-1&&this._keys.push(i.keyCode),i.preventDefault&&(e||i.preventDefault()));else if(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysReset.indexOf(i.keyCode)!==-1){let r=this._keys.indexOf(i.keyCode);r>=0&&this._keys.splice(r,1),i.preventDefault&&(e||i.preventDefault())}}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){let e=this.camera;for(let t=0;t<this._keys.length;t++){let i=this._keys[t];this.keysLeft.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX-=1/this.panningSensibility:e.inertialAlphaOffset-=this.angularSpeed:this.keysUp.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY+=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset+=1/this.zoomingSensibility:e.inertialBetaOffset-=this.angularSpeed:this.keysRight.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX+=1/this.panningSensibility:e.inertialAlphaOffset+=this.angularSpeed:this.keysDown.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY-=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset-=1/this.zoomingSensibility:e.inertialBetaOffset+=this.angularSpeed:this.keysReset.indexOf(i)!==-1&&e.useInputToRestoreState&&e.restoreState()}}}getClassName(){return"ArcRotateCameraKeyboardMoveInput"}getSimpleName(){return"keyboard"}};x([y()],Kr.prototype,"keysUp",void 0);x([y()],Kr.prototype,"keysDown",void 0);x([y()],Kr.prototype,"keysLeft",void 0);x([y()],Kr.prototype,"keysRight",void 0);x([y()],Kr.prototype,"keysReset",void 0);x([y()],Kr.prototype,"panningSensibility",void 0);x([y()],Kr.prototype,"zoomingSensibility",void 0);x([y()],Kr.prototype,"useAltToZoom",void 0);x([y()],Kr.prototype,"angularSpeed",void 0);ur.ArcRotateCameraKeyboardMoveInput=Kr;Ye();je();Yn();ns();wc();ie();xr();xm();di();$e();var EZ=40,qo=class{constructor(){this.wheelPrecision=3,this.zoomToMouseLocation=!1,this.wheelDeltaPercentage=0,this.customComputeDeltaFromMouseWheel=null,this._viewOffset=new E(0,0,0),this._globalOffset=new E(0,0,0),this._inertialPanning=E.Zero()}_computeDeltaFromMouseWheelLegacyEvent(e,t){let i=0,r=e*.01*this.wheelDeltaPercentage*t;return e>0?i=r/(1+this.wheelDeltaPercentage):i=r*(1+this.wheelDeltaPercentage),i}attachControl(e){e=W.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==ce.POINTERWHEEL)return;let i=t.event,r=0,n=i.deltaMode===en.DOM_DELTA_LINE?EZ:1,a=-(i.deltaY*n);if(this.customComputeDeltaFromMouseWheel)r=this.customComputeDeltaFromMouseWheel(a,this,i);else if(this.wheelDeltaPercentage){if(r=this._computeDeltaFromMouseWheelLegacyEvent(a,this.camera.radius),r>0){let o=this.camera.radius,l=this.camera.inertialRadiusOffset+r;for(let c=0;c<20&&!(o<=l||Math.abs(l*this.camera.inertia)<.001);c++)o-=l,l*=this.camera.inertia;o=Fe(o,0,Number.MAX_VALUE),r=this._computeDeltaFromMouseWheelLegacyEvent(a,o)}}else r=a/(this.wheelPrecision*40);r&&(this.zoomToMouseLocation?(this._hitPlane||this._updateHitPlane(),this._zoomToMouse(r)):this.camera.inertialRadiusOffset+=r),i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,ce.POINTERWHEEL),this.zoomToMouseLocation&&this._inertialPanning.setAll(0)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null)}checkInputs(){if(!this.zoomToMouseLocation)return;let e=this.camera;0+e.inertialAlphaOffset+e.inertialBetaOffset+e.inertialRadiusOffset&&(this._updateHitPlane(),e.target.addInPlace(this._inertialPanning),this._inertialPanning.scaleInPlace(e.inertia),this._zeroIfClose(this._inertialPanning))}getClassName(){return"ArcRotateCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}_updateHitPlane(){let e=this.camera,t=e.target.subtract(e.position);this._hitPlane=Ks.FromPositionAndNormal(e.target,t)}_getPosition(){let e=this.camera,t=e.getScene(),i=t.createPickingRay(t.pointerX,t.pointerY,B.Identity(),e,!1);(e.targetScreenOffset.x!==0||e.targetScreenOffset.y!==0)&&(this._viewOffset.set(e.targetScreenOffset.x,e.targetScreenOffset.y,0),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),this._globalOffset=E.TransformNormal(this._viewOffset,e._cameraTransformMatrix),i.origin.addInPlace(this._globalOffset));let r=0;return this._hitPlane&&(r=i.intersectsPlane(this._hitPlane)??0),i.origin.addInPlace(i.direction.scaleInPlace(r))}_zoomToMouse(e){let t=this.camera,i=1-t.inertia;if(t.lowerRadiusLimit){let l=t.lowerRadiusLimit??0;t.radius-(t.inertialRadiusOffset+e)/i<l&&(e=(t.radius-l)*i-t.inertialRadiusOffset)}if(t.upperRadiusLimit){let l=t.upperRadiusLimit??0;t.radius-(t.inertialRadiusOffset+e)/i>l&&(e=(t.radius-l)*i-t.inertialRadiusOffset)}let n=e/i/t.radius,a=this._getPosition(),o=w.Vector3[6];a.subtractToRef(t.target,o),o.scaleInPlace(n),o.scaleInPlace(i),this._inertialPanning.addInPlace(o),t.inertialRadiusOffset+=e}_zeroIfClose(e){Math.abs(e.x)<We&&(e.x=0),Math.abs(e.y)<We&&(e.y=0),Math.abs(e.z)<We&&(e.z=0)}};x([y()],qo.prototype,"wheelPrecision",void 0);x([y()],qo.prototype,"zoomToMouseLocation",void 0);x([y()],qo.prototype,"wheelDeltaPercentage",void 0);ur.ArcRotateCameraMouseWheelInput=qo;Yn();var m_=class extends Cf{constructor(e){super(e)}addMouseWheel(){return this.add(new qo),this}addPointers(){return this.add(new dr),this}addKeyboard(){return this.add(new Kr),this}};xr();$e();Te();_t.AddNodeConstructor("ArcRotateCamera",(s,e)=>()=>new Mt(s,0,0,1,E.Zero(),e));function TC(s){let e=Math.PI/2;return s.x===0&&s.z===0||(e=Math.acos(s.x/Math.sqrt(Math.pow(s.x,2)+Math.pow(s.z,2)))),s.z<0&&(e=2*Math.PI-e),e}function xC(s,e){return Math.acos(s/e)}function pr(s,e){return isNaN(s)?e:s}var Mt=class s extends Yr{get target(){return this._target}set target(e){this.setTarget(e)}get targetHost(){return this._targetHost}set targetHost(e){e&&this.setTarget(e)}getTarget(){return this.target}get position(){return this._position}set position(e){this.setPosition(e)}set upVector(e){this._upToYMatrix||(this._yToUpMatrix=new B,this._upToYMatrix=new B,this._upVector=E.Zero()),e.normalize(),this._upVector.copyFrom(e),this.setMatUp()}get upVector(){return this._upVector}setMatUp(){B.RotationAlignToRef(E.UpReadOnly,this._upVector,this._yToUpMatrix),B.RotationAlignToRef(this._upVector,E.UpReadOnly,this._upToYMatrix)}get angularSensibilityX(){let e=this.inputs.attached.pointers;return e?e.angularSensibilityX:0}set angularSensibilityX(e){let t=this.inputs.attached.pointers;t&&(t.angularSensibilityX=e)}get angularSensibilityY(){let e=this.inputs.attached.pointers;return e?e.angularSensibilityY:0}set angularSensibilityY(e){let t=this.inputs.attached.pointers;t&&(t.angularSensibilityY=e)}get pinchPrecision(){let e=this.inputs.attached.pointers;return e?e.pinchPrecision:0}set pinchPrecision(e){let t=this.inputs.attached.pointers;t&&(t.pinchPrecision=e)}get pinchDeltaPercentage(){let e=this.inputs.attached.pointers;return e?e.pinchDeltaPercentage:0}set pinchDeltaPercentage(e){let t=this.inputs.attached.pointers;t&&(t.pinchDeltaPercentage=e)}get useNaturalPinchZoom(){let e=this.inputs.attached.pointers;return e?e.useNaturalPinchZoom:!1}set useNaturalPinchZoom(e){let t=this.inputs.attached.pointers;t&&(t.useNaturalPinchZoom=e)}get panningSensibility(){let e=this.inputs.attached.pointers;return e?e.panningSensibility:0}set panningSensibility(e){let t=this.inputs.attached.pointers;t&&(t.panningSensibility=e)}get keysUp(){let e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){let t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysDown(){let e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){let t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysLeft(){let e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){let t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){let e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){let t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}get wheelPrecision(){let e=this.inputs.attached.mousewheel;return e?e.wheelPrecision:0}set wheelPrecision(e){let t=this.inputs.attached.mousewheel;t&&(t.wheelPrecision=e)}get zoomToMouseLocation(){let e=this.inputs.attached.mousewheel;return e?e.zoomToMouseLocation:!1}set zoomToMouseLocation(e){let t=this.inputs.attached.mousewheel;t&&(t.zoomToMouseLocation=e)}get wheelDeltaPercentage(){let e=this.inputs.attached.mousewheel;return e?e.wheelDeltaPercentage:0}set wheelDeltaPercentage(e){let t=this.inputs.attached.mousewheel;t&&(t.wheelDeltaPercentage=e)}get isInterpolating(){return this._isInterpolating}get bouncingBehavior(){return this._bouncingBehavior}get useBouncingBehavior(){return this._bouncingBehavior!=null}set useBouncingBehavior(e){e!==this.useBouncingBehavior&&(e?(this._bouncingBehavior=new bf,this.addBehavior(this._bouncingBehavior)):this._bouncingBehavior&&(this.removeBehavior(this._bouncingBehavior),this._bouncingBehavior=null))}get framingBehavior(){return this._framingBehavior}get useFramingBehavior(){return this._framingBehavior!=null}set useFramingBehavior(e){e!==this.useFramingBehavior&&(e?(this._framingBehavior=new Ko,this.addBehavior(this._framingBehavior)):this._framingBehavior&&(this.removeBehavior(this._framingBehavior),this._framingBehavior=null))}get autoRotationBehavior(){return this._autoRotationBehavior}get useAutoRotationBehavior(){return this._autoRotationBehavior!=null}set useAutoRotationBehavior(e){e!==this.useAutoRotationBehavior&&(e?(this._autoRotationBehavior=new c_,this.addBehavior(this._autoRotationBehavior)):this._autoRotationBehavior&&(this.removeBehavior(this._autoRotationBehavior),this._autoRotationBehavior=null))}constructor(e,t,i,r,n,a,o=!0){super(e,E.Zero(),a,o),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.lowerAlphaLimit=null,this.upperAlphaLimit=null,this.lowerBetaLimit=.01,this.upperBetaLimit=Math.PI-.01,this.lowerRadiusLimit=null,this.upperRadiusLimit=null,this.lowerTargetYLimit=-1/0,this.inertialPanningX=0,this.inertialPanningY=0,this.pinchToPanMaxDistance=20,this.panningDistanceLimit=null,this.panningOriginTarget=E.Zero(),this.panningInertia=.9,this.zoomOnFactor=1,this.targetScreenOffset=he.Zero(),this.allowUpsideDown=!0,this.useInputToRestoreState=!0,this.restoreStateInterpolationFactor=0,this._currentInterpolationFactor=0,this._viewMatrix=new B,this.panningAxis=new E(1,1,0),this._transformedDirection=new E,this.mapPanning=!1,this._isInterpolating=!1,this.onMeshTargetChangedObservable=new N,this.checkCollisions=!1,this.collisionRadius=new E(.5,.5,.5),this._previousPosition=E.Zero(),this._collisionVelocity=E.Zero(),this._newPosition=E.Zero(),this._computationVector=E.Zero(),this._goalAlpha=NaN,this._goalBeta=NaN,this._goalRadius=NaN,this._goalTarget=new E(NaN,NaN,NaN),this._goalTargetScreenOffset=new he(NaN,NaN),this._onCollisionPositionChange=(l,c,f=null)=>{f?(this.setPosition(c),this.onCollide&&this.onCollide(f)):this._previousPosition.copyFrom(this._position);let h=Math.cos(this.alpha),u=Math.sin(this.alpha),d=Math.cos(this.beta),p=Math.sin(this.beta);p===0&&(p=1e-4);let m=this._getTargetPosition();this._computationVector.copyFromFloats(this.radius*h*p,this.radius*d,this.radius*u*p),m.addToRef(this._computationVector,this._newPosition),this._position.copyFrom(this._newPosition);let _=this.upVector;this.allowUpsideDown&&this.beta<0&&(_=_.clone(),_=_.negate()),this._computeViewMatrix(this._position,m,_),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y),this._collisionTriggered=!1},this._target=E.Zero(),n&&this.setTarget(n),this.alpha=t,this.beta=i,this.radius=r,this.getViewMatrix(),this.inputs=new m_(this),this.inputs.addKeyboard().addMouseWheel().addPointers()}_initCache(){super._initCache(),this._cache._target=new E(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.alpha=void 0,this._cache.beta=void 0,this._cache.radius=void 0,this._cache.targetScreenOffset=he.Zero()}_updateCache(e){e||super._updateCache(),this._cache._target.copyFrom(this._getTargetPosition()),this._cache.alpha=this.alpha,this._cache.beta=this.beta,this._cache.radius=this.radius,this._cache.targetScreenOffset.copyFrom(this.targetScreenOffset)}_getTargetPosition(){if(this._targetHost&&this._targetHost.getAbsolutePosition){let t=this._targetHost.getAbsolutePosition();this._targetBoundingCenter?t.addToRef(this._targetBoundingCenter,this._target):this._target.copyFrom(t)}let e=this._getLockedTargetPosition();return e||this._target}storeState(){return this._storedAlpha=this.alpha,this._storedBeta=this.beta,this._storedRadius=this.radius,this._storedTarget=this._getTargetPosition().clone(),this._storedTargetScreenOffset=this.targetScreenOffset.clone(),super.storeState()}_restoreStateValues(){return this.hasStateStored()&&this.restoreStateInterpolationFactor>We&&this.restoreStateInterpolationFactor<1?(this.interpolateTo(this._storedAlpha,this._storedBeta,this._storedRadius,this._storedTarget,this._storedTargetScreenOffset,this.restoreStateInterpolationFactor),!0):super._restoreStateValues()?(this.setTarget(this._storedTarget.clone()),this.alpha=this._storedAlpha,this.beta=this._storedBeta,this.radius=this._storedRadius,this.targetScreenOffset=this._storedTargetScreenOffset.clone(),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0,!0):!1}stopInterpolation(){this._goalAlpha=NaN,this._goalBeta=NaN,this._goalRadius=NaN,this._goalTarget.set(NaN,NaN,NaN),this._goalTargetScreenOffset.set(NaN,NaN)}interpolateTo(e=this.alpha,t=this.beta,i=this.radius,r=this.target,n=this.targetScreenOffset,a){this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0,a!=null?this._currentInterpolationFactor=a:this.restoreStateInterpolationFactor!==0?this._currentInterpolationFactor=this.restoreStateInterpolationFactor:this._currentInterpolationFactor=.1,this._goalAlpha=pr(e,this._goalAlpha),this._goalBeta=pr(t,this._goalBeta),this._goalRadius=pr(i,this._goalRadius),this._goalTarget.set(pr(r.x,this._goalTarget.x),pr(r.y,this._goalTarget.y),pr(r.z,this._goalTarget.z)),this._goalTargetScreenOffset.set(pr(n.x,this._goalTargetScreenOffset.x),pr(n.y,this._goalTargetScreenOffset.y)),this._goalAlpha=Fe(this._goalAlpha,this.lowerAlphaLimit??-1/0,this.upperAlphaLimit??1/0),this._goalBeta=Fe(this._goalBeta,this.lowerBetaLimit??-1/0,this.upperBetaLimit??1/0),this._goalRadius=Fe(this._goalRadius,this.lowerRadiusLimit??-1/0,this.upperRadiusLimit??1/0),this._goalTarget.y=Fe(this._goalTarget.y,this.lowerTargetYLimit??-1/0,1/0),this._isInterpolating=!0}_isSynchronizedViewMatrix(){return super._isSynchronizedViewMatrix()?this._cache._target.equals(this._getTargetPosition())&&this._cache.alpha===this.alpha&&this._cache.beta===this.beta&&this._cache.radius===this.radius&&this._cache.targetScreenOffset.equals(this.targetScreenOffset):!1}attachControl(e,t,i=!0,r=2){let n=arguments;t=W.BackCompatCameraNoPreventDefault(n),this._useCtrlForPanning=i,this._panningMouseButton=r,typeof n[0]=="boolean"&&(n.length>1&&(this._useCtrlForPanning=n[1]),n.length>2&&(this._panningMouseButton=n[2])),this.inputs.attachElement(t),this._reset=()=>{this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0}}detachControl(){this.inputs.detachElement(),this._reset&&this._reset()}_checkInputs(){if(this._collisionTriggered)return;this.inputs.checkInputs();let e=!1;if(this.inertialAlphaOffset!==0||this.inertialBetaOffset!==0||this.inertialRadiusOffset!==0){e=!0;let t=this.invertRotation?-1:1,i=this._calculateHandednessMultiplier(),r=this.inertialAlphaOffset*i;this.beta<0&&(r*=-1),this.alpha+=r*t,this.beta+=this.inertialBetaOffset*t,this.radius-=this.inertialRadiusOffset,this.inertialAlphaOffset*=this.inertia,this.inertialBetaOffset*=this.inertia,this.inertialRadiusOffset*=this.inertia,Math.abs(this.inertialAlphaOffset)<We&&(this.inertialAlphaOffset=0),Math.abs(this.inertialBetaOffset)<We&&(this.inertialBetaOffset=0),Math.abs(this.inertialRadiusOffset)<this.speed*We&&(this.inertialRadiusOffset=0)}if(this.inertialPanningX!==0||this.inertialPanningY!==0){e=!0;let t=new E(this.inertialPanningX,this.inertialPanningY,this.inertialPanningY);if(this._viewMatrix.invertToRef(this._cameraTransformMatrix),t.multiplyInPlace(this.panningAxis),E.TransformNormalToRef(t,this._cameraTransformMatrix,this._transformedDirection),this.mapPanning){let i=this.upVector,r=E.CrossToRef(this._transformedDirection,i,this._transformedDirection);E.CrossToRef(i,r,this._transformedDirection)}else this.panningAxis.y||(this._transformedDirection.y=0);if(!this._targetHost)if(this.panningDistanceLimit)this._transformedDirection.addInPlace(this._target),E.DistanceSquared(this._transformedDirection,this.panningOriginTarget)<=this.panningDistanceLimit*this.panningDistanceLimit&&this._target.copyFrom(this._transformedDirection);else{if(this.parent){let i=w.Matrix[0];this.parent.getWorldMatrix().getRotationMatrixToRef(i),i.transposeToRef(i),E.TransformCoordinatesToRef(this._transformedDirection,i,this._transformedDirection)}this._target.addInPlace(this._transformedDirection)}this.inertialPanningX*=this.panningInertia,this.inertialPanningY*=this.panningInertia,Math.abs(this.inertialPanningX)<this.speed*We&&(this.inertialPanningX=0),Math.abs(this.inertialPanningY)<this.speed*We&&(this.inertialPanningY=0)}if(e)this.stopInterpolation();else if(this._isInterpolating){let t=!1,i=this._scene.getEngine().getDeltaTime()/1e3,r=1-Math.pow(2,-i/this._currentInterpolationFactor),n=pr(this._goalRadius,this.radius);if(!isNaN(this._goalTarget.x)||!isNaN(this._goalTarget.y)||!isNaN(this._goalTarget.z)){let a=w.Vector3[0].set(pr(this._goalTarget.x,this._target.x),pr(this._goalTarget.y,this._target.y),pr(this._goalTarget.z,this._target.z));E.LerpToRef(this.target,a,r,this._target),E.Distance(this.target,a)*10/n<We?(this._goalTarget.set(NaN,NaN,NaN),this.target.copyFrom(a),this.setTarget(this.target,!1,!0,!0)):t=!0}if(!isNaN(this._goalAlpha)||!isNaN(this._goalBeta)){let a=K.RotationAlphaBetaGammaToRef(pr(this._goalAlpha,this.alpha),pr(this._goalBeta,this.beta),0,w.Quaternion[0]),o=K.RotationAlphaBetaGammaToRef(this.alpha,this.beta,0,w.Quaternion[1]),l=K.SlerpToRef(o,a,r,w.Quaternion[2]);l.normalize();let c=l.toAlphaBetaGammaToRef(w.Vector3[0]);if(this.alpha=c.x,this.beta=c.y,l.isApprox(a,We/5)){this._goalAlpha=NaN,this._goalBeta=NaN;let f=a.toAlphaBetaGammaToRef(w.Vector3[0]);this.alpha=f.x,this.beta=f.y}else t=!0}if(isNaN(this._goalRadius)||(this.radius+=(n-this.radius)*r,Math.abs(n/this.radius-1)<We?(this._goalRadius=NaN,this.radius=n):t=!0),!isNaN(this._goalTargetScreenOffset.x)||!isNaN(this._goalTargetScreenOffset.y)){let a=w.Vector2[0].set(pr(this._goalTargetScreenOffset.x,this.targetScreenOffset.x),pr(this._goalTargetScreenOffset.y,this.targetScreenOffset.y));he.LerpToRef(this.targetScreenOffset,a,r,this.targetScreenOffset),he.Distance(this.targetScreenOffset,a)<We?(this._goalTargetScreenOffset.set(NaN,NaN),this.targetScreenOffset.copyFrom(a)):t=!0}this._isInterpolating=t}this._checkLimits(),super._checkInputs()}_checkLimits(){this.lowerBetaLimit===null||this.lowerBetaLimit===void 0?this.allowUpsideDown&&this.beta>Math.PI&&(this.beta=this.beta-2*Math.PI):this.beta<this.lowerBetaLimit&&(this.beta=this.lowerBetaLimit),this.upperBetaLimit===null||this.upperBetaLimit===void 0?this.allowUpsideDown&&this.beta<-Math.PI&&(this.beta=this.beta+2*Math.PI):this.beta>this.upperBetaLimit&&(this.beta=this.upperBetaLimit),this.lowerAlphaLimit!==null&&this.alpha<this.lowerAlphaLimit&&(this.alpha=this.lowerAlphaLimit),this.upperAlphaLimit!==null&&this.alpha>this.upperAlphaLimit&&(this.alpha=this.upperAlphaLimit),this.lowerRadiusLimit!==null&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit,this.inertialRadiusOffset=0),this.upperRadiusLimit!==null&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit,this.inertialRadiusOffset=0),this.target.y=Math.max(this.target.y,this.lowerTargetYLimit)}rebuildAnglesAndRadius(){this._position.subtractToRef(this._getTargetPosition(),this._computationVector),(this._upVector.x!==0||this._upVector.y!==1||this._upVector.z!==0)&&E.TransformCoordinatesToRef(this._computationVector,this._upToYMatrix,this._computationVector),this.radius=this._computationVector.length(),this.radius===0&&(this.radius=1e-4);let e=this.alpha;this.alpha=TC(this._computationVector),this.beta=xC(this._computationVector.y,this.radius);let t=Math.round((e-this.alpha)/(2*Math.PI));this.alpha+=t*2*Math.PI,this._checkLimits()}setPosition(e){this._position.equals(e)||(this._position.copyFrom(e),this.rebuildAnglesAndRadius())}setTarget(e,t=!1,i=!1,r=!1){if(r=this.overrideCloneAlphaBetaRadius??r,e.computeWorldMatrix)t&&e.getBoundingInfo?this._targetBoundingCenter=e.getBoundingInfo().boundingBox.centerWorld.clone():this._targetBoundingCenter=null,e.computeWorldMatrix(),this._targetHost=e,this._target=this._getTargetPosition(),this.onMeshTargetChangedObservable.notifyObservers(this._targetHost);else{let n=e,a=this._getTargetPosition();if(a&&!i&&a.equals(n))return;this._targetHost=null,this._target=n,this._targetBoundingCenter=null,this.onMeshTargetChangedObservable.notifyObservers(null)}r||this.rebuildAnglesAndRadius()}_getViewMatrix(){let e=Math.cos(this.alpha),t=Math.sin(this.alpha),i=Math.cos(this.beta),r=Math.sin(this.beta);r===0&&(r=1e-4),this.radius===0&&(this.radius=1e-4);let n=this._getTargetPosition();if(this._computationVector.copyFromFloats(this.radius*e*r,this.radius*i,this.radius*t*r),(this._upVector.x!==0||this._upVector.y!==1||this._upVector.z!==0)&&E.TransformCoordinatesToRef(this._computationVector,this._yToUpMatrix,this._computationVector),n.addToRef(this._computationVector,this._newPosition),this.getScene().collisionsEnabled&&this.checkCollisions){let a=this.getScene().collisionCoordinator;this._collider||(this._collider=a.createCollider()),this._collider._radius=this.collisionRadius,this._newPosition.subtractToRef(this._position,this._collisionVelocity),this._collisionTriggered=!0,a.getNewPosition(this._position,this._collisionVelocity,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}else{this._position.copyFrom(this._newPosition);let a=this.upVector;this.allowUpsideDown&&r<0&&(a=a.negate()),this._computeViewMatrix(this._position,n,a),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y)}return this._currentTarget.copyFrom(n),this._viewMatrix}zoomOn(e,t=!1){e=e||this.getScene().meshes;let i=fe.MinMax(e),r=this._calculateLowerRadiusFromModelBoundingSphere(i.min,i.max);if(r=Math.max(Math.min(r,this.upperRadiusLimit||Number.MAX_VALUE),this.lowerRadiusLimit||0),this.radius=r*this.zoomOnFactor,this.mode===ye.ORTHOGRAPHIC_CAMERA){let n=this.getScene().getEngine().getAspectRatio(this),a=r*this.zoomOnFactor/2;this.orthoLeft=-a*n,this.orthoRight=a*n,this.orthoBottom=-a,this.orthoTop=a}this.focusOn({min:i.min,max:i.max,distance:r},t)}focusOn(e,t=!1){let i,r;if(e.min===void 0){let n=e||this.getScene().meshes;i=fe.MinMax(n),r=E.Distance(i.min,i.max)}else{let n=e;i=n,r=n.distance}this._target=fe.Center(i),t||(this.maxZ=r*2)}createRigCamera(e,t){let i=0;switch(this.cameraRigMode){case ye.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case ye.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case ye.RIG_MODE_STEREOSCOPIC_OVERUNDER:case ye.RIG_MODE_STEREOSCOPIC_INTERLACED:case ye.RIG_MODE_VR:i=this._cameraRigParams.stereoHalfAngle*(t===0?1:-1);break;case ye.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:i=this._cameraRigParams.stereoHalfAngle*(t===0?-1:1);break}let r=new s(e,this.alpha+i,this.beta,this.radius,this._target,this.getScene());return r._cameraRigParams={},r.isRigCamera=!0,r.rigParent=this,r.upVector=this.upVector,r.mode=this.mode,r.orthoLeft=this.orthoLeft,r.orthoRight=this.orthoRight,r.orthoBottom=this.orthoBottom,r.orthoTop=this.orthoTop,r}_updateRigCameras(){let e=this._rigCameras[0],t=this._rigCameras[1];switch(e.beta=t.beta=this.beta,this.cameraRigMode){case ye.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case ye.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case ye.RIG_MODE_STEREOSCOPIC_OVERUNDER:case ye.RIG_MODE_STEREOSCOPIC_INTERLACED:case ye.RIG_MODE_VR:e.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle,t.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle;break;case ye.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:e.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle,t.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle;break}super._updateRigCameras()}_calculateLowerRadiusFromModelBoundingSphere(e,t,i=1){let r=E.Distance(e,t),a=this.getScene().getEngine().getAspectRatio(this),o=Math.tan(this.fov/2),l=o*a,f=r*.5*i,h=f*Math.sqrt(1+1/(l*l)),u=f*Math.sqrt(1+1/(o*o));return Math.max(h,u)}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"ArcRotateCamera"}};x([y()],Mt.prototype,"alpha",void 0);x([y()],Mt.prototype,"beta",void 0);x([y()],Mt.prototype,"radius",void 0);x([y()],Mt.prototype,"overrideCloneAlphaBetaRadius",void 0);x([oi("target")],Mt.prototype,"_target",void 0);x([sp("targetHost")],Mt.prototype,"_targetHost",void 0);x([y()],Mt.prototype,"inertialAlphaOffset",void 0);x([y()],Mt.prototype,"inertialBetaOffset",void 0);x([y()],Mt.prototype,"inertialRadiusOffset",void 0);x([y()],Mt.prototype,"lowerAlphaLimit",void 0);x([y()],Mt.prototype,"upperAlphaLimit",void 0);x([y()],Mt.prototype,"lowerBetaLimit",void 0);x([y()],Mt.prototype,"upperBetaLimit",void 0);x([y()],Mt.prototype,"lowerRadiusLimit",void 0);x([y()],Mt.prototype,"upperRadiusLimit",void 0);x([y()],Mt.prototype,"lowerTargetYLimit",void 0);x([y()],Mt.prototype,"inertialPanningX",void 0);x([y()],Mt.prototype,"inertialPanningY",void 0);x([y()],Mt.prototype,"pinchToPanMaxDistance",void 0);x([y()],Mt.prototype,"panningDistanceLimit",void 0);x([oi()],Mt.prototype,"panningOriginTarget",void 0);x([y()],Mt.prototype,"panningInertia",void 0);x([y()],Mt.prototype,"zoomToMouseLocation",null);x([y()],Mt.prototype,"zoomOnFactor",void 0);x([vc()],Mt.prototype,"targetScreenOffset",void 0);x([y()],Mt.prototype,"allowUpsideDown",void 0);x([y()],Mt.prototype,"useInputToRestoreState",void 0);x([y()],Mt.prototype,"restoreStateInterpolationFactor",void 0);G("BABYLON.ArcRotateCamera",Mt);If();ns();Ye();je();ie();it();rs();Dn();Te();_t.AddNodeConstructor("Light_Type_3",(s,e)=>()=>new Kn(s,E.Zero(),e));var Kn=class extends Ke{constructor(e,t,i){super(e,i),this.groundColor=new j(0,0,0),this.direction=t||E.Up()}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightGround",3),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}getClassName(){return"HemisphericLight"}setDirectionToTarget(e){return this.direction=E.Normalize(e.subtract(E.Zero())),this.direction}getShadowGenerator(){return null}transferToEffect(e,t){let i=E.Normalize(this.direction);return this._uniformBuffer.updateFloat4("vLightData",i.x,i.y,i.z,0,t),this._uniformBuffer.updateColor3("vLightGround",this.groundColor.scale(this.intensity),t),this}transferToNodeMaterialEffect(e,t){let i=E.Normalize(this.direction);return e.setFloat3(t,i.x,i.y,i.z),this}computeWorldMatrix(){return this._worldMatrix||(this._worldMatrix=B.Identity()),this._worldMatrix}getTypeID(){return Ke.LIGHTTYPEID_HEMISPHERICLIGHT}prepareLightSpecificDefines(e,t){e["HEMILIGHT"+t]=!0}};x([zt()],Kn.prototype,"groundColor",void 0);x([oi()],Kn.prototype,"direction",void 0);G("BABYLON.HemisphericLight",Kn);Vm();Qo();Ye();je();bn();Ee();ie();yt();fs();yf();Xc();Ut();Te();fn();it();bo();rn();Xi();ei();var WC=class extends ri{constructor(){super(),this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.GAMMADIFFUSE=!1,this.DIFFUSEHASALPHA=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONBLUR=!1,this.REFLECTIONFRESNEL=!1,this.REFLECTIONFALLOFF=!1,this.TEXTURELODSUPPORT=!1,this.PREMULTIPLYALPHA=!1,this.USERGBCOLOR=!1,this.USEHIGHLIGHTANDSHADOWCOLORS=!1,this.BACKMAT_SHADOWONLY=!1,this.NOISE=!1,this.REFLECTIONBGR=!1,this.PROJECTED_GROUND=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=0,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.EXPOSURE=!1,this.MULTIVIEW=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.EQUIRECTANGULAR_RELFECTION_FOV=!1,this.MAINUV1=!1,this.MAINUV2=!1,this.UV1=!1,this.UV2=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.NORMAL=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.INSTANCES=!1,this.SHADOWFLOAT=!1,this.LOGARITHMICDEPTH=!1,this.NONUNIFORMSCALING=!1,this.ALPHATEST=!1,this.rebuild()}},et=class s extends Fs{get _perceptualColor(){return this.__perceptualColor}set _perceptualColor(e){this.__perceptualColor=e,this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsLightsDirty()}get primaryColorShadowLevel(){return this._primaryColorShadowLevel}set primaryColorShadowLevel(e){this._primaryColorShadowLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()}get primaryColorHighlightLevel(){return this._primaryColorHighlightLevel}set primaryColorHighlightLevel(e){this._primaryColorHighlightLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()}set reflectionStandardFresnelWeight(e){let t=e;t<.5?(t=t*2,this.reflectionReflectance0=s.StandardReflectance0*t,this.reflectionReflectance90=s.StandardReflectance90*t):(t=t*2-1,this.reflectionReflectance0=s.StandardReflectance0+(1-s.StandardReflectance0)*t,this.reflectionReflectance90=s.StandardReflectance90+(1-s.StandardReflectance90)*t)}get fovMultiplier(){return this._fovMultiplier}set fovMultiplier(e){isNaN(e)&&(e=1),this._fovMultiplier=Math.max(0,Math.min(2,e))}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsImageProcessingDirty()})))}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this.imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this.imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this.imageProcessingConfiguration.colorCurves=e}constructor(e,t,i=!1){super(e,t,void 0,i),this.primaryColor=j.White(),this._primaryColorShadowLevel=0,this._primaryColorHighlightLevel=0,this.reflectionTexture=null,this.reflectionBlur=0,this.diffuseTexture=null,this._shadowLights=null,this.shadowLights=null,this.shadowLevel=0,this.sceneCenter=E.Zero(),this.opacityFresnel=!0,this.reflectionFresnel=!1,this.reflectionFalloffDistance=0,this.reflectionAmount=1,this.reflectionReflectance0=.05,this.reflectionReflectance90=.5,this.useRGBColor=!0,this.enableNoise=!1,this._fovMultiplier=1,this.useEquirectangularFOV=!1,this._maxSimultaneousLights=4,this.maxSimultaneousLights=4,this._shadowOnly=!1,this.shadowOnly=!1,this._imageProcessingObserver=null,this.switchToBGR=!1,this._enableGroundProjection=!1,this.enableGroundProjection=!1,this.projectedGroundRadius=1e3,this.projectedGroundHeight=10,this._renderTargets=new wt(16),this._reflectionControls=Oe.Zero(),this._white=j.White(),this._primaryShadowColor=j.Black(),this._primaryHighlightColor=j.Black(),this._shadersLoaded=!1,this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._renderTargets.push(this._diffuseTexture),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._renderTargets)}get hasRenderTargetTextures(){return!!(this._diffuseTexture&&this._diffuseTexture.isRenderTarget||this._reflectionTexture&&this._reflectionTexture.isRenderTarget)}needAlphaTesting(){return!0}needAlphaBlending(){return this.alpha<1||this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha||this._shadowOnly}isReadyForSubMesh(e,t,i=!1){let r=t._drawWrapper;if(r.effect&&this.isFrozen&&r._wasPreviouslyReady&&r._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(t.materialDefines=new WC);let n=this.getScene(),a=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;let o=n.getEngine();if(ef(n,e,a,!1,this._maxSimultaneousLights),a._needNormals=!0,tf(n,a),a._areTexturesDirty){if(a._needUVs=!1,n.texturesEnabled){if(n.getEngine().getCaps().textureLOD&&(a.TEXTURELODSUPPORT=!0),this._diffuseTexture&&X.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking())return!1;lt(this._diffuseTexture,a,"DIFFUSE"),a.DIFFUSEHASALPHA=this._diffuseTexture.hasAlpha,a.GAMMADIFFUSE=this._diffuseTexture.gammaSpace,a.OPACITYFRESNEL=this._opacityFresnel}else a.DIFFUSE=!1,a.DIFFUSEDIRECTUV=0,a.DIFFUSEHASALPHA=!1,a.GAMMADIFFUSE=!1,a.OPACITYFRESNEL=!1;let l=this._reflectionTexture;if(l&&X.ReflectionTextureEnabled){if(!l.isReadyOrNotBlocking())return!1;switch(a.REFLECTION=!0,a.GAMMAREFLECTION=l.gammaSpace,a.RGBDREFLECTION=l.isRGBD,a.REFLECTIONBLUR=this._reflectionBlur>0,a.LODINREFLECTIONALPHA=l.lodLevelInAlpha,a.EQUIRECTANGULAR_RELFECTION_FOV=this.useEquirectangularFOV,a.REFLECTIONBGR=this.switchToBGR,l.coordinatesMode===H.INVCUBIC_MODE&&(a.INVERTCUBICMAP=!0),a.REFLECTIONMAP_3D=l.isCube,a.REFLECTIONMAP_OPPOSITEZ=a.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!l.invertZ:l.invertZ,l.coordinatesMode){case H.EXPLICIT_MODE:a.REFLECTIONMAP_EXPLICIT=!0;break;case H.PLANAR_MODE:a.REFLECTIONMAP_PLANAR=!0;break;case H.PROJECTION_MODE:a.REFLECTIONMAP_PROJECTION=!0;break;case H.SKYBOX_MODE:a.REFLECTIONMAP_SKYBOX=!0;break;case H.SPHERICAL_MODE:a.REFLECTIONMAP_SPHERICAL=!0;break;case H.EQUIRECTANGULAR_MODE:a.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case H.FIXED_EQUIRECTANGULAR_MODE:a.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case H.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:a.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case H.CUBIC_MODE:case H.INVCUBIC_MODE:default:a.REFLECTIONMAP_CUBIC=!0;break}this.reflectionFresnel?(a.REFLECTIONFRESNEL=!0,a.REFLECTIONFALLOFF=this.reflectionFalloffDistance>0,this._reflectionControls.x=this.reflectionAmount,this._reflectionControls.y=this.reflectionReflectance0,this._reflectionControls.z=this.reflectionReflectance90,this._reflectionControls.w=1/this.reflectionFalloffDistance):(a.REFLECTIONFRESNEL=!1,a.REFLECTIONFALLOFF=!1)}else a.REFLECTION=!1,a.REFLECTIONFRESNEL=!1,a.REFLECTIONFALLOFF=!1,a.REFLECTIONBLUR=!1,a.REFLECTIONMAP_3D=!1,a.REFLECTIONMAP_SPHERICAL=!1,a.REFLECTIONMAP_PLANAR=!1,a.REFLECTIONMAP_CUBIC=!1,a.REFLECTIONMAP_PROJECTION=!1,a.REFLECTIONMAP_SKYBOX=!1,a.REFLECTIONMAP_EXPLICIT=!1,a.REFLECTIONMAP_EQUIRECTANGULAR=!1,a.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,a.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,a.INVERTCUBICMAP=!1,a.REFLECTIONMAP_OPPOSITEZ=!1,a.LODINREFLECTIONALPHA=!1,a.GAMMAREFLECTION=!1,a.RGBDREFLECTION=!1}a.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,a.USERGBCOLOR=this._useRGBColor,a.NOISE=this._enableNoise}if(a._areLightsDirty&&(a.USEHIGHLIGHTANDSHADOWCOLORS=!this._useRGBColor&&(this._primaryColorShadowLevel!==0||this._primaryColorHighlightLevel!==0),a.BACKMAT_SHADOWONLY=this._shadowOnly),a._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(a)}if(a._areMiscDirty&&(a.REFLECTIONMAP_3D&&this._enableGroundProjection?(a.PROJECTED_GROUND=!0,a.REFLECTIONMAP_SKYBOX=!0):a.PROJECTED_GROUND=!1),yo(e,n,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this.needAlphaTestingForMesh(e),a,void 0,void 0,void 0,this._setVertexOutputInvariant),Mo(n,o,this,a,i,null,t.getRenderingMesh().hasThinInstances),Po(e,a,!1,!0,!1)&&e&&!n.getEngine().getCaps().standardDerivatives&&!e.isVerticesDataPresent(A.NormalKind)&&(e.createNormals(!0),P.Warn("BackgroundMaterial: Normals have been created for the mesh: "+e.name)),a.isDirty){a.markAsProcessed(),n.resetCachedMaterial();let l=new or;a.FOG&&l.addFallback(0,"FOG"),a.POINTSIZE&&l.addFallback(1,"POINTSIZE"),a.MULTIVIEW&&l.addFallback(0,"MULTIVIEW"),$c(a,l,this._maxSimultaneousLights);let c=[A.PositionKind];a.NORMAL&&c.push(A.NormalKind),a.UV1&&c.push(A.UVKind),a.UV2&&c.push(A.UV2Kind),Jc(c,e,a,l),Io(c,a);let f=["world","view","viewProjection","vEyePosition","vLightsType","vFogInfos","vFogColor","pointSize","mBones","vPrimaryColor","vPrimaryColorShadow","vReflectionInfos","reflectionMatrix","vReflectionMicrosurfaceInfos","fFovMultiplier","shadowLevel","alpha","vBackgroundCenter","vReflectionControl","vDiffuseInfos","diffuseMatrix","projectedGroundInfos","logarithmicDepthConstant"];Hi(f);let h=["diffuseSampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh"],u=["Material","Scene"];Ve&&(Ve.PrepareUniforms(f,a),Ve.PrepareSamplers(h,a)),Do({uniformsNames:f,uniformBuffersNames:u,samplers:h,defines:a,maxSimultaneousLights:this._maxSimultaneousLights});let d=a.toString(),p=n.getEngine().createEffect("background",{attributes:c,uniformsNames:f,uniformBuffersNames:u,samplers:h,defines:d,fallbacks:l,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights},shaderLanguage:this._shaderLanguage,extraInitializationsAsync:this._shadersLoaded?void 0:async()=>{this.shaderLanguage===1?await Promise.all([Promise.resolve().then(()=>(wB(),LB)),Promise.resolve().then(()=>(ZB(),jB))]):await Promise.all([Promise.resolve().then(()=>(f2(),c2)),Promise.resolve().then(()=>(P2(),M2))]),this._shadersLoaded=!0}},o);t.setEffect(p,a,this._materialContext),this.buildUniformLayout()}return!t.effect||!t.effect.isReady()?!1:(a._renderId=n.getRenderId(),r._wasPreviouslyReady=!0,r._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),!0)}_computePrimaryColorFromPerceptualColor(){this.__perceptualColor&&(this._primaryColor.copyFrom(this.__perceptualColor),this._primaryColor.toLinearSpaceToRef(this._primaryColor,this.getScene().getEngine().useExactSrgbConversions),this._imageProcessingConfiguration&&this._primaryColor.scaleToRef(1/this._imageProcessingConfiguration.exposure,this._primaryColor),this._computePrimaryColors())}_computePrimaryColors(){this._primaryColorShadowLevel===0&&this._primaryColorHighlightLevel===0||(this._primaryColor.scaleToRef(this._primaryColorShadowLevel,this._primaryShadowColor),this._primaryColor.subtractToRef(this._primaryShadowColor,this._primaryShadowColor),this._white.subtractToRef(this._primaryColor,this._primaryHighlightColor),this._primaryHighlightColor.scaleToRef(this._primaryColorHighlightLevel,this._primaryHighlightColor),this._primaryColor.addToRef(this._primaryHighlightColor,this._primaryHighlightColor))}buildUniformLayout(){this._uniformBuffer.addUniform("vPrimaryColor",4),this._uniformBuffer.addUniform("vPrimaryColorShadow",4),this._uniformBuffer.addUniform("vDiffuseInfos",2),this._uniformBuffer.addUniform("vReflectionInfos",2),this._uniformBuffer.addUniform("diffuseMatrix",16),this._uniformBuffer.addUniform("reflectionMatrix",16),this._uniformBuffer.addUniform("vReflectionMicrosurfaceInfos",3),this._uniformBuffer.addUniform("fFovMultiplier",1),this._uniformBuffer.addUniform("pointSize",1),this._uniformBuffer.addUniform("shadowLevel",1),this._uniformBuffer.addUniform("alpha",1),this._uniformBuffer.addUniform("vBackgroundCenter",3),this._uniformBuffer.addUniform("vReflectionControl",4),this._uniformBuffer.addUniform("projectedGroundInfos",2),this._uniformBuffer.create()}unbind(){this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._uniformBuffer.setTexture("diffuseSampler",null),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._uniformBuffer.setTexture("reflectionSampler",null),super.unbind()}bindOnlyWorldMatrix(e){this._activeEffect.setMatrix("world",e)}bindForSubMesh(e,t,i){let r=this.getScene(),n=i.materialDefines;if(!n)return;let a=i.effect;if(!a)return;this._activeEffect=a,this.bindOnlyWorldMatrix(e),Nn(t,this._activeEffect);let o=this._mustRebind(r,a,i,t.visibility);if(o){this._uniformBuffer.bindToEffect(a,"Material"),this.bindViewProjection(a);let l=this._reflectionTexture;(!this._uniformBuffer.useUbo||!this.isFrozen||!this._uniformBuffer.isSync||i._drawWrapper._forceRebindOnNextCall)&&(r.texturesEnabled&&(this._diffuseTexture&&X.DiffuseTextureEnabled&&(this._uniformBuffer.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),ct(this._diffuseTexture,this._uniformBuffer,"diffuse")),l&&X.ReflectionTextureEnabled&&(this._uniformBuffer.updateMatrix("reflectionMatrix",l.getReflectionTextureMatrix()),this._uniformBuffer.updateFloat2("vReflectionInfos",l.level,this._reflectionBlur),this._uniformBuffer.updateFloat3("vReflectionMicrosurfaceInfos",l.getSize().width,l.lodGenerationScale,l.lodGenerationOffset))),this.shadowLevel>0&&this._uniformBuffer.updateFloat("shadowLevel",this.shadowLevel),this._uniformBuffer.updateFloat("alpha",this.alpha),this.pointsCloud&&this._uniformBuffer.updateFloat("pointSize",this.pointSize),n.USEHIGHLIGHTANDSHADOWCOLORS?(this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryHighlightColor,1),this._uniformBuffer.updateColor4("vPrimaryColorShadow",this._primaryShadowColor,1)):this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryColor,1)),this._uniformBuffer.updateFloat("fFovMultiplier",this._fovMultiplier),r.texturesEnabled&&(this._diffuseTexture&&X.DiffuseTextureEnabled&&this._uniformBuffer.setTexture("diffuseSampler",this._diffuseTexture),l&&X.ReflectionTextureEnabled&&(n.REFLECTIONBLUR&&n.TEXTURELODSUPPORT?this._uniformBuffer.setTexture("reflectionSampler",l):n.REFLECTIONBLUR?(this._uniformBuffer.setTexture("reflectionSampler",l._lodTextureMid||l),this._uniformBuffer.setTexture("reflectionSamplerLow",l._lodTextureLow||l),this._uniformBuffer.setTexture("reflectionSamplerHigh",l._lodTextureHigh||l)):this._uniformBuffer.setTexture("reflectionSampler",l),n.REFLECTIONFRESNEL&&(this._uniformBuffer.updateFloat3("vBackgroundCenter",this.sceneCenter.x,this.sceneCenter.y,this.sceneCenter.z),this._uniformBuffer.updateFloat4("vReflectionControl",this._reflectionControls.x,this._reflectionControls.y,this._reflectionControls.z,this._reflectionControls.w))),n.PROJECTED_GROUND&&this._uniformBuffer.updateFloat2("projectedGroundInfos",this.projectedGroundRadius,this.projectedGroundHeight)),zi(this._activeEffect,this,r),r.bindEyePosition(a)}else r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._uniformBuffer.bindToEffect(a,"Material"),this._needToBindSceneUbo=!0);(o||!this.isFrozen)&&(r.lightsEnabled&&Zc(r,t,this._activeEffect,n,this._maxSimultaneousLights),this.bindView(a),wn(r,t,this._activeEffect,!0),this._useLogarithmicDepth&&Ln(n,a,r),this._imageProcessingConfiguration&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect,i),this._uniformBuffer.update()}hasTexture(e){return!!(super.hasTexture(e)||this._reflectionTexture===e||this._diffuseTexture===e)}dispose(e=!1,t=!1){t&&(this.diffuseTexture&&this.diffuseTexture.dispose(),this.reflectionTexture&&this.reflectionTexture.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e)}clone(e){return _e.Clone(()=>new s(e,this.getScene()),this)}serialize(){let e=super.serialize();return e.customType="BABYLON.BackgroundMaterial",e}getClassName(){return"BackgroundMaterial"}static Parse(e,t,i){return _e.Parse(()=>new s(e.name,t),e,t,i)}};et.StandardReflectance0=.05;et.StandardReflectance90=.5;x([zt()],et.prototype,"_primaryColor",void 0);x([z("_markAllSubMeshesAsLightsDirty")],et.prototype,"primaryColor",void 0);x([zt()],et.prototype,"__perceptualColor",void 0);x([y()],et.prototype,"_primaryColorShadowLevel",void 0);x([y()],et.prototype,"_primaryColorHighlightLevel",void 0);x([z("_markAllSubMeshesAsLightsDirty")],et.prototype,"primaryColorHighlightLevel",null);x([He()],et.prototype,"_reflectionTexture",void 0);x([z("_markAllSubMeshesAsTexturesDirty")],et.prototype,"reflectionTexture",void 0);x([y()],et.prototype,"_reflectionBlur",void 0);x([z("_markAllSubMeshesAsTexturesDirty")],et.prototype,"reflectionBlur",void 0);x([He()],et.prototype,"_diffuseTexture",void 0);x([z("_markAllSubMeshesAsTexturesDirty")],et.prototype,"diffuseTexture",void 0);x([z("_markAllSubMeshesAsTexturesDirty")],et.prototype,"shadowLights",void 0);x([y()],et.prototype,"_shadowLevel",void 0);x([z("_markAllSubMeshesAsTexturesDirty")],et.prototype,"shadowLevel",void 0);x([oi()],et.prototype,"_sceneCenter",void 0);x([z("_markAllSubMeshesAsTexturesDirty")],et.prototype,"sceneCenter",void 0);x([y()],et.prototype,"_opacityFresnel",void 0);x([z("_markAllSubMeshesAsTexturesDirty")],et.prototype,"opacityFresnel",void 0);x([y()],et.prototype,"_reflectionFresnel",void 0);x([z("_markAllSubMeshesAsTexturesDirty")],et.prototype,"reflectionFresnel",void 0);x([y()],et.prototype,"_reflectionFalloffDistance",void 0);x([z("_markAllSubMeshesAsTexturesDirty")],et.prototype,"reflectionFalloffDistance",void 0);x([y()],et.prototype,"_reflectionAmount",void 0);x([z("_markAllSubMeshesAsTexturesDirty")],et.prototype,"reflectionAmount",void 0);x([y()],et.prototype,"_reflectionReflectance0",void 0);x([z("_markAllSubMeshesAsTexturesDirty")],et.prototype,"reflectionReflectance0",void 0);x([y()],et.prototype,"_reflectionReflectance90",void 0);x([z("_markAllSubMeshesAsTexturesDirty")],et.prototype,"reflectionReflectance90",void 0);x([y()],et.prototype,"_useRGBColor",void 0);x([z("_markAllSubMeshesAsTexturesDirty")],et.prototype,"useRGBColor",void 0);x([y()],et.prototype,"_enableNoise",void 0);x([z("_markAllSubMeshesAsTexturesDirty")],et.prototype,"enableNoise",void 0);x([y()],et.prototype,"_maxSimultaneousLights",void 0);x([z("_markAllSubMeshesAsTexturesDirty")],et.prototype,"maxSimultaneousLights",void 0);x([y()],et.prototype,"_shadowOnly",void 0);x([z("_markAllSubMeshesAsLightsDirty")],et.prototype,"shadowOnly",void 0);x([ap()],et.prototype,"_imageProcessingConfiguration",void 0);x([y(),z("_markAllSubMeshesAsMiscDirty")],et.prototype,"enableGroundProjection",void 0);x([y()],et.prototype,"projectedGroundRadius",void 0);x([y()],et.prototype,"projectedGroundHeight",void 0);G("BABYLON.BackgroundMaterial",et);Xc();Li();Ut();it();di();ie();Dh();ie();yt();Nc();function Mu(s,e,t){let i=s.getVertexBuffer(t);if(!i)return null;let r=i.getData();if(!r)return null;let n;return vl(r,i.byteStride*e,i.byteStride,i.getSize(),i.type,1,i.normalized,a=>n=a),n}function Xee(s,e,t){let i=Mu(s,e,A.PositionKind);if(!i||i.some(r=>isNaN(r??Number.NaN)))return!1;if(s.morphTargetManager){let r=e*3;for(let n=0;n<i.length;n++){let a=i[n];for(let o=0;o<s.morphTargetManager.numTargets;o++){let l=s.morphTargetManager.getTarget(o),c=l.influence;if(c!==0){let f=l.getPositions();f&&(a+=(f[r+n]-i[n])*c)}}i[n]=a}}if(t.fromArray(i),s.skeleton){let r=Mu(s,e,A.MatricesIndicesKind),n=Mu(s,e,A.MatricesWeightsKind);if(r&&n){let a=s.numBoneInfluencers>4,o=a?Mu(s,e,A.MatricesIndicesExtraKind):null,l=a?Mu(s,e,A.MatricesWeightsExtraKind):null,c=s.skeleton.getTransformMatrices(s),f=w.Matrix[0],h=w.Matrix[1];f.reset();for(let u=0;u<n.length;u++){let d=n[u];d>0&&(B.FromFloat32ArrayToRefScaled(c,Math.floor(r[u]*16),d,h),f.addToSelf(h))}if(o&&l)for(let u=0;u<l.length;u++){let d=l[u];d>0&&(B.FromFloat32ArrayToRefScaled(c,Math.floor(o[u]*16),d,h),f.addToSelf(h))}E.TransformCoordinatesFromFloatsToRef(i[0],i[1],i[2],f,t)}}return!0}function vV(s,e,t,i){t.set(0,0,0);for(let r=0;r<3;r++){let n=e.pointIndex[r];if(!Xee(s,n,w.Vector3[r]))return!1;w.Vector3[r].scaleAndAddToRef(e.barycentric[r],t)}if(E.TransformCoordinatesToRef(t,s.getWorldMatrix(),t),i){let r=w.Vector3[0],n=w.Vector3[1],a=w.Vector3[2],o=w.Vector3[3],l=w.Vector3[4];o.copyFrom(n),o.subtractInPlace(r),l.copyFrom(a),l.subtractInPlace(r),o.normalize(),l.normalize(),E.CrossToRef(o,l,i),s.material&&s.material.sideOrientation===(s.getScene().useRightHandedSystem?0:1)&&i.scaleInPlace(-1),E.TransformNormalToRef(i,s.getWorldMatrix(),i),i.normalize()}return!0}ie();it();Ki();ln();Fc();ie();it();Ki();ln();ie();yt();Ki();fe._GroundMeshParser=(s,e)=>Lf.Parse(s,e);var Lf=class s extends fe{constructor(e,t){super(e,t),this.generateOctree=!1}getClassName(){return"GroundMesh"}get subdivisions(){return Math.min(this._subdivisionsX,this._subdivisionsY)}get subdivisionsX(){return this._subdivisionsX}get subdivisionsY(){return this._subdivisionsY}optimize(e,t=32){this._subdivisionsX=e,this._subdivisionsY=e,this.subdivide(e);let i=this;i.createOrUpdateSubmeshesOctree&&i.createOrUpdateSubmeshesOctree(t)}getHeightAtCoordinates(e,t){let i=this.getWorldMatrix(),r=w.Matrix[5];i.invertToRef(r);let n=w.Vector3[8];if(E.TransformCoordinatesFromFloatsToRef(e,0,t,r,n),e=n.x,t=n.z,e<this._minX||e>=this._maxX||t<=this._minZ||t>this._maxZ)return this.position.y;(!this._heightQuads||this._heightQuads.length==0)&&(this._initHeightQuads(),this._computeHeightQuads());let a=this._getFacetAt(e,t),o=-(a.x*e+a.z*t+a.w)/a.y;return E.TransformCoordinatesFromFloatsToRef(0,o,0,i,n),n.y}getNormalAtCoordinates(e,t){let i=new E(0,1,0);return this.getNormalAtCoordinatesToRef(e,t,i),i}getNormalAtCoordinatesToRef(e,t,i){let r=this.getWorldMatrix(),n=w.Matrix[5];r.invertToRef(n);let a=w.Vector3[8];if(E.TransformCoordinatesFromFloatsToRef(e,0,t,n,a),e=a.x,t=a.z,e<this._minX||e>this._maxX||t<this._minZ||t>this._maxZ)return this;(!this._heightQuads||this._heightQuads.length==0)&&(this._initHeightQuads(),this._computeHeightQuads());let o=this._getFacetAt(e,t);return E.TransformNormalFromFloatsToRef(o.x,o.y,o.z,r,i),this}updateCoordinateHeights(){return(!this._heightQuads||this._heightQuads.length==0)&&this._initHeightQuads(),this._computeHeightQuads(),this}_getFacetAt(e,t){let i=Math.floor((e+this._maxX)*this._subdivisionsX/this._width),r=Math.floor(-(t+this._maxZ)*this._subdivisionsY/this._height+this._subdivisionsY),n=this._heightQuads[r*this._subdivisionsX+i],a;return t<n.slope.x*e+n.slope.y?a=n.facet1:a=n.facet2,a}_initHeightQuads(){let e=this._subdivisionsX,t=this._subdivisionsY;this._heightQuads=[];for(let i=0;i<t;i++)for(let r=0;r<e;r++){let n={slope:he.Zero(),facet1:new Oe(0,0,0,0),facet2:new Oe(0,0,0,0)};this._heightQuads[i*e+r]=n}return this}_computeHeightQuads(){let e=this.getVerticesData(A.PositionKind);if(!e)return this;let t=w.Vector3[3],i=w.Vector3[2],r=w.Vector3[1],n=w.Vector3[0],a=w.Vector3[4],o=w.Vector3[5],l=w.Vector3[6],c=w.Vector3[7],f=w.Vector3[8],h=0,u=0,d=0,p=0,m=0,_=0,v=0,T=this._subdivisionsX,C=this._subdivisionsY;for(let I=0;I<C;I++)for(let R=0;R<T;R++){h=R*3,u=I*(T+1)*3,d=(I+1)*(T+1)*3,t.x=e[u+h],t.y=e[u+h+1],t.z=e[u+h+2],i.x=e[u+h+3],i.y=e[u+h+4],i.z=e[u+h+5],r.x=e[d+h],r.y=e[d+h+1],r.z=e[d+h+2],n.x=e[d+h+3],n.y=e[d+h+4],n.z=e[d+h+5],p=(n.z-t.z)/(n.x-t.x),m=t.z-p*t.x,i.subtractToRef(t,a),r.subtractToRef(t,o),n.subtractToRef(t,l),E.CrossToRef(l,o,c),E.CrossToRef(a,l,f),c.normalize(),f.normalize(),_=-(c.x*t.x+c.y*t.y+c.z*t.z),v=-(f.x*i.x+f.y*i.y+f.z*i.z);let b=this._heightQuads[I*T+R];b.slope.copyFromFloats(p,m),b.facet1.copyFromFloats(c.x,c.y,c.z,_),b.facet2.copyFromFloats(f.x,f.y,f.z,v)}return this}serialize(e){super.serialize(e),e.subdivisionsX=this._subdivisionsX,e.subdivisionsY=this._subdivisionsY,e.minX=this._minX,e.maxX=this._maxX,e.minZ=this._minZ,e.maxZ=this._maxZ,e.width=this._width,e.height=this._height}static Parse(e,t){let i=new s(e.name,t);return i._subdivisionsX=e.subdivisionsX||1,i._subdivisionsY=e.subdivisionsY||1,i._minX=e.minX,i._maxX=e.maxX,i._minZ=e.minZ,i._maxZ=e.maxZ,i._width=e.width,i._height=e.height,i}};$e();gt();xr();Fc();function NI(s){let e=[],t=[],i=[],r=[],n,a,o=s.width||s.size||1,l=s.height||s.size||1,c=(s.subdivisionsX||s.subdivisions||1)|0,f=(s.subdivisionsY||s.subdivisions||1)|0;for(n=0;n<=f;n++)for(a=0;a<=c;a++){let u=new E(a*o/c-o/2,0,(f-n)*l/f-l/2),d=new E(0,1,0);t.push(u.x,u.y,u.z),i.push(d.x,d.y,d.z),r.push(a/c,Si?n/f:1-n/f)}for(n=0;n<f;n++)for(a=0;a<c;a++)e.push(a+1+(n+1)*(c+1)),e.push(a+1+n*(c+1)),e.push(a+n*(c+1)),e.push(a+(n+1)*(c+1)),e.push(a+1+(n+1)*(c+1)),e.push(a+n*(c+1));let h=new Ge;return h.indices=e,h.positions=t,h.normals=i,h.uvs=r,h}function SV(s){let e=s.xmin!==void 0&&s.xmin!==null?s.xmin:-1,t=s.zmin!==void 0&&s.zmin!==null?s.zmin:-1,i=s.xmax!==void 0&&s.xmax!==null?s.xmax:1,r=s.zmax!==void 0&&s.zmax!==null?s.zmax:1,n=s.subdivisions||{w:1,h:1},a=s.precision||{w:1,h:1},o=[],l=[],c=[],f=[],h,u,d,p;n.h=n.h<1?1:n.h,n.w=n.w<1?1:n.w,a.w=a.w<1?1:a.w,a.h=a.h<1?1:a.h;let m={w:(i-e)/n.w,h:(r-t)/n.h};function _(T,C,I,R){let b=l.length/3,M=a.w+1;for(h=0;h<a.h;h++)for(u=0;u<a.w;u++){let D=[b+u+h*M,b+(u+1)+h*M,b+(u+1)+(h+1)*M,b+u+(h+1)*M];o.push(D[1]),o.push(D[2]),o.push(D[3]),o.push(D[0]),o.push(D[1]),o.push(D[3])}let F=E.Zero(),U=new E(0,1,0);for(h=0;h<=a.h;h++)for(F.z=h*(R-C)/a.h+C,u=0;u<=a.w;u++)F.x=u*(I-T)/a.w+T,F.y=0,l.push(F.x,F.y,F.z),c.push(U.x,U.y,U.z),f.push(u/a.w,h/a.h)}for(d=0;d<n.h;d++)for(p=0;p<n.w;p++)_(e+p*m.w,t+d*m.h,e+(p+1)*m.w,t+(d+1)*m.h);let v=new Ge;return v.indices=o,v.positions=l,v.normals=c,v.uvs=f,v}function EV(s){let e=[],t=[],i=[],r=[],n,a,o=s.colorFilter||new j(.3,.59,.11),l=s.alphaFilter||0,c=!1;if(s.minHeight>s.maxHeight){c=!0;let h=s.maxHeight;s.maxHeight=s.minHeight,s.minHeight=h}for(n=0;n<=s.subdivisions;n++)for(a=0;a<=s.subdivisions;a++){let h=new E(a*s.width/s.subdivisions-s.width/2,0,(s.subdivisions-n)*s.height/s.subdivisions-s.height/2),u=(h.x+s.width/2)/s.width*(s.bufferWidth-1)|0,d=(1-(h.z+s.height/2)/s.height)*(s.bufferHeight-1)|0,p=(u+d*s.bufferWidth)*4,m=s.buffer[p]/255,_=s.buffer[p+1]/255,v=s.buffer[p+2]/255,T=s.buffer[p+3]/255;c&&(m=1-m,_=1-_,v=1-v);let C=m*o.r+_*o.g+v*o.b;T>=l?h.y=s.minHeight+(s.maxHeight-s.minHeight)*C:h.y=s.minHeight-We,s.heightBuffer&&(s.heightBuffer[n*(s.subdivisions+1)+a]=h.y),t.push(h.x,h.y,h.z),i.push(0,0,0),r.push(a/s.subdivisions,1-n/s.subdivisions)}for(n=0;n<s.subdivisions;n++)for(a=0;a<s.subdivisions;a++){let h=a+1+(n+1)*(s.subdivisions+1),u=a+1+n*(s.subdivisions+1),d=a+n*(s.subdivisions+1),p=a+(n+1)*(s.subdivisions+1),m=t[h*3+1]>=s.minHeight,_=t[u*3+1]>=s.minHeight,v=t[d*3+1]>=s.minHeight;m&&_&&v&&(e.push(h),e.push(u),e.push(d)),t[p*3+1]>=s.minHeight&&m&&v&&(e.push(p),e.push(h),e.push(d))}Ge.ComputeNormals(t,e,i);let f=new Ge;return f.indices=e,f.positions=t,f.normals=i,f.uvs=r,f}function Yee(s,e={},t){let i=new Lf(s,t);return i._setReady(!1),i._subdivisionsX=e.subdivisionsX||e.subdivisions||1,i._subdivisionsY=e.subdivisionsY||e.subdivisions||1,i._width=e.width||1,i._height=e.height||1,i._maxX=i._width/2,i._maxZ=i._height/2,i._minX=-i._maxX,i._minZ=-i._maxZ,NI(e).applyToMesh(i,e.updatable),i._setReady(!0),i}function Kee(s,e,t=null){let i=new fe(s,t);return SV(e).applyToMesh(i,e.updatable),i}function qee(s,e,t={},i=null){let r=t.width||10,n=t.height||10,a=t.subdivisions||1,o=t.minHeight||0,l=t.maxHeight||1,c=t.colorFilter||new j(.3,.59,.11),f=t.alphaFilter||0,h=t.updatable,u=t.onReady;i=i||Z.LastCreatedScene;let d=new Lf(s,i);d._subdivisionsX=a,d._subdivisionsY=a,d._width=r,d._height=n,d._maxX=d._width/2,d._maxZ=d._height/2,d._minX=-d._maxX,d._minZ=-d._maxZ,d._setReady(!1);let p;t.passHeightBufferInCallback&&(p=new Float32Array((a+1)*(a+1)));let m=(_,v,T)=>{EV({width:r,height:n,subdivisions:a,minHeight:o,maxHeight:l,colorFilter:c,buffer:_,bufferWidth:v,bufferHeight:T,alphaFilter:f,heightBuffer:p}).applyToMesh(d,h),u&&u(d,p),d._setReady(!0)};if(typeof e=="string"){let _=v=>{let T=v.width,C=v.height;if(i.isDisposed)return;let I=i?.getEngine().resizeImageBitmap(v,T,C);m(I,T,C)};W.LoadImage(e,_,t.onError?t.onError:()=>{},i.offlineProvider)}else m(e.data,e.width,e.height);return d}Ge.CreateGround=NI;Ge.CreateTiledGround=SV;Ge.CreateGroundFromHeightMap=EV;fe.CreateGround=(s,e,t,i,r,n)=>Yee(s,{width:e,height:t,subdivisions:i,updatable:n},r);fe.CreateTiledGround=(s,e,t,i,r,n,a,o,l)=>Kee(s,{xmin:e,zmin:t,xmax:i,zmax:r,subdivisions:n,precision:a,updatable:l},o);fe.CreateGroundFromHeightMap=(s,e,t,i,r,n,a,o,l,c,f)=>qee(s,e,{width:t,height:i,subdivisions:r,minHeight:n,maxHeight:a,updatable:l,onReady:c,alphaFilter:f},o);function TV(s){let t=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23],i=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0],r=[],n=[],a=s.width||s.size||1,o=s.height||s.size||1,l=s.depth||s.size||1,c=s.wrap||!1,f=s.topBaseAt===void 0?1:s.topBaseAt,h=s.bottomBaseAt===void 0?0:s.bottomBaseAt;f=(f+4)%4,h=(h+4)%4;let u=[2,0,3,1],d=[2,0,1,3],p=u[f],m=d[h],_=[1,-1,1,-1,-1,1,-1,1,1,1,1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,-1,-1,-1,1];if(c){t=[2,3,0,2,0,1,4,5,6,4,6,7,9,10,11,9,11,8,12,14,15,12,13,14],_=[-1,1,1,1,1,1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,1,1,1,-1,1,-1,-1,1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1];let M=[[1,1,1],[-1,1,1],[-1,1,-1],[1,1,-1]],F=[[-1,-1,1],[1,-1,1],[1,-1,-1],[-1,-1,-1]],U=[17,18,19,16],D=[22,23,20,21];for(;p>0;)M.unshift(M.pop()),U.unshift(U.pop()),p--;for(;m>0;)F.unshift(F.pop()),D.unshift(D.pop()),m--;M=M.flat(),F=F.flat(),_=_.concat(M).concat(F),t.push(U[0],U[2],U[3],U[0],U[1],U[2]),t.push(D[0],D[2],D[3],D[0],D[1],D[2])}let v=[a/2,o/2,l/2];n=_.reduce((M,F,U)=>M.concat(F*v[U%3]),[]);let T=s.sideOrientation===0?0:s.sideOrientation||Ge.DEFAULTSIDE,C=s.faceUV||new Array(6),I=s.faceColors,R=[];for(let M=0;M<6;M++)C[M]===void 0&&(C[M]=new Oe(0,0,1,1)),I&&I[M]===void 0&&(I[M]=new me(1,1,1,1));for(let M=0;M<6;M++)if(r.push(C[M].z,Si?1-C[M].w:C[M].w),r.push(C[M].x,Si?1-C[M].w:C[M].w),r.push(C[M].x,Si?1-C[M].y:C[M].y),r.push(C[M].z,Si?1-C[M].y:C[M].y),I)for(let F=0;F<4;F++)R.push(I[M].r,I[M].g,I[M].b,I[M].a);Ge._ComputeSides(T,n,t,i,r,s.frontUVs,s.backUVs);let b=new Ge;if(b.indices=t,b.positions=n,b.normals=i,b.uvs=r,I){let M=T===Ge.DOUBLESIDE?R.concat(R):R;b.colors=M}return b}function BI(s,e={},t=null){let i=new fe(s,t);return e.sideOrientation=fe._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,TV(e).applyToMesh(i,e.updatable),i}Ge.CreateBox=TV;fe.CreateBox=(s,e,t=null,i,r)=>BI(s,{size:e,sideOrientation:r,updatable:i},t);Ki();yt();ie();function xV(s){let e=s.minimum.x,t=s.minimum.y,i=s.minimum.z,r=s.maximum.x,n=s.maximum.y,a=s.maximum.z;return[new E(e,t,i),new E(r,n,a),new E(r,t,i),new E(e,n,i),new E(e,t,a),new E(r,n,i),new E(e,n,a),new E(r,t,a)]}function AV(s,e=null,t=1/6){let i=w.Vector3[0],r=new Map,n=new Map,a=s.reduce((d,p)=>Math.max(d,p.getTotalVertices()),0),o=Array.from({length:a},()=>new E),l=Array.from({length:a},()=>new E);for(let d of s){let p=d.getVerticesData(A.PositionKind);if(!p)continue;let m=d.getTotalVertices();o.length=Math.max(o.length,m),l.length=Math.max(o.length,m);for(let I=0,R=0;I<m;I++,R+=3)i.set(p[R],p[R+1],p[R+2]),o[I].copyFrom(i),l[I].copyFrom(i);let _=d.morphTargetManager;if(_)for(let I=0;I<_.numTargets;++I){let b=_.getTarget(I).getPositions();if(b)for(let M=0,F=0;M<m;M++,F+=3)i.set(b[F],b[F+1],b[F+2]),o[M].minimizeInPlace(i),l[M].maximizeInPlace(i)}let v=d.skeleton,T=v?d.getVerticesData(A.MatricesWeightsKind):null,C=v?d.getVerticesData(A.MatricesIndicesKind):null;if(T&&C){let I=d.numBoneInfluencers>4,R=I?d.getVerticesData(A.MatricesWeightsExtraKind):null,b=I?d.getVerticesData(A.MatricesIndicesExtraKind):null,M=n.get(d.uniqueId)||new Map;n.set(d.uniqueId,M);let F=(U,D,$,oe)=>{for(let re=D;re<D+4;re++)if($[re]>0){let se=oe[re],be=M.get(se);be?(be.minimum.minimizeInPlace(o[U]),be.maximum.maximizeInPlace(l[U])):M.set(se,{minimum:o[U].clone(),maximum:l[U].clone()})}};for(let U=0,D=0;U<m;U++,D+=4)F(U,D,T,C),R&&b&&F(U,D,R,b)}else{let I=r.get(d.uniqueId)||{minimum:new E().setAll(Number.POSITIVE_INFINITY),maximum:new E().setAll(Number.NEGATIVE_INFINITY)};r.set(d.uniqueId,I);for(let R=0;R<m;R++)I.minimum.minimizeInPlace(o[R]),I.maximum.maximizeInPlace(l[R])}}let c=new Map,f=new Map;for(let d of s){let p=r.get(d.uniqueId);if(p)c.set(d.uniqueId,xV(p));else{let m=n.get(d.uniqueId);if(m){let _=d.skeleton.bones,v=new Map;f.set(d.uniqueId,v),m.forEach((T,C)=>{let I=xV(T),R=_[C].getAbsoluteInverseBindMatrix();for(let b of I)E.TransformCoordinatesToRef(b,R,b);v.set(C,I)})}}}let h=Array.from({length:s.length},()=>({minimum:new E().setAll(Number.POSITIVE_INFINITY),maximum:new E().setAll(Number.NEGATIVE_INFINITY)})),u=()=>{for(let d=0;d<s.length;d++){let p=s[d];if(!p.getVerticesData(A.PositionKind))continue;let _=p.computeWorldMatrix(!0),v=p.skeleton;if(v){v.prepare(!0);let T=v.bones;f.get(p.uniqueId).forEach((I,R)=>{for(let b of I){let M=T[R].getFinalMatrix().multiplyToRef(_,w.Matrix[0]);E.TransformCoordinatesToRef(b,M,i),h[d].minimum.minimizeInPlace(i),h[d].maximum.maximizeInPlace(i)}})}else for(let T of c.get(p.uniqueId))E.TransformCoordinatesToRef(T,_,i),h[d].minimum.minimizeInPlace(i),h[d].maximum.maximizeInPlace(i)}};if(e&&e.isStarted){let d=e.getCurrentFrame(),p=t/e.getLength(0,1);for(let m=e.from;m<=e.to;m+=p)e.goToFrame(m),u();e.goToFrame(d)}else u();return h}function RV(s){let e=[A.UVKind,A.UV2Kind,A.UV3Kind,A.UV4Kind,A.UV5Kind,A.UV6Kind];for(let t of s){let i=new Set(e),r=t.material?.getActiveTextures();if(r)for(let n of r)i.delete(e[n.coordinatesIndex]);i.forEach(n=>{t.isVerticesDataPresent(n)&&t.removeVerticesData(n)})}}Hs();Pu();var Ul=class{constructor(){this._currentOperation=Promise.resolve()}lockAsync(e,t){t?.throwIfAborted();let i=t?()=>(t.throwIfAborted(),e()):e,r=this._currentOperation.then(i);return this._currentOperation=new Promise(n=>{r.then(()=>n(),n)}),r}static async LockAsync(e,t,i){if(i?.throwIfAborted(),t.length===0)return await e();let r=new Qr,n=0;for(let a of t)a.lockAsync(async()=>(n++,n===t.length&&r.resolve(await e()),await r.promise),i).catch(o=>r.reject(o));return await r.promise}};UI();Cc();Ee();we();gt();Ki();we();var hn=class{getDescription(){return""}apply(e,t){return!0}constructor(e=0){this.priority=e}},Ou=class extends hn{getDescription(){return"Reducing render target texture size to "+this.maximumSize}constructor(e=0,t=1024,i=.5){super(e),this.priority=e,this.maximumSize=t,this.step=i}apply(e,t){let i=!0;for(let r=0;r<e.textures.length;r++){let n=e.textures[r];if(!n.canRescale||n.getContext)continue;let a=n.getSize();Math.max(a.width,a.height)>this.maximumSize&&(n.scale(this.step),i=!1)}return i}},Ff=class extends hn{getDescription(){return"Setting hardware scaling level to "+this._currentScale}constructor(e=0,t=2,i=.25){super(e),this.priority=e,this.maximumScale=t,this.step=i,this._currentScale=-1,this._directionOffset=1}apply(e,t){return this._currentScale===-1&&(this._currentScale=e.getEngine().getHardwareScalingLevel(),this._currentScale>this.maximumScale&&(this._directionOffset=-1)),this._currentScale+=this._directionOffset*this.step,this._currentScale=Math.min(this.maximumScale,this._currentScale),e.getEngine().setHardwareScalingLevel(this._currentScale),this._directionOffset===1?this._currentScale>=this.maximumScale:this._currentScale<=this.maximumScale}},Lu=class extends hn{getDescription(){return"Turning shadows on/off"}apply(e,t){return e.shadowsEnabled=t.isInImprovementMode,!0}},wu=class extends hn{getDescription(){return"Turning post-processes on/off"}apply(e,t){return e.postProcessesEnabled=t.isInImprovementMode,!0}},Fu=class extends hn{getDescription(){return"Turning lens flares on/off"}apply(e,t){return e.lensFlaresEnabled=t.isInImprovementMode,!0}},GI=class extends hn{getDescription(){return this.onGetDescription?this.onGetDescription():"Running user defined callback"}apply(e,t){return this.onApply?this.onApply(e,t):!0}},Nu=class extends hn{getDescription(){return"Turning particles on/off"}apply(e,t){return e.particlesEnabled=t.isInImprovementMode,!0}},j_=class extends hn{getDescription(){return"Turning render targets off"}apply(e,t){return e.renderTargetsEnabled=t.isInImprovementMode,!0}},wf=class s extends hn{constructor(){super(...arguments),this._canBeMerged=e=>{if(!(e instanceof fe))return!1;let t=e;return!(t.isDisposed()||!t.isVisible||!t.isEnabled()||t.instances.length>0||t.skeleton||t.hasLODLevels||t.getTotalVertices()===0)}}static get UpdateSelectionTree(){return s._UpdateSelectionTree}static set UpdateSelectionTree(e){s._UpdateSelectionTree=e}getDescription(){return"Merging similar meshes together"}apply(e,t,i){let r=e.meshes.slice(0),n=r.length;for(let o=0;o<n;o++){let l=[],c=r[o];if(this._canBeMerged(c)){l.push(c);for(let f=o+1;f<n;f++){let h=r[f];this._canBeMerged(h)&&h.material===c.material&&h.checkCollisions===c.checkCollisions&&(l.push(h),n--,r.splice(f,1),f--)}l.length<2||fe.MergeMeshes(l,void 0,!0)}}let a=e;return a.createOrUpdateSelectionOctree&&(i!=null?i&&a.createOrUpdateSelectionOctree():s.UpdateSelectionTree&&a.createOrUpdateSelectionOctree()),!0}};wf._UpdateSelectionTree=!1;var Nf=class s{constructor(e=60,t=2e3){this.targetFrameRate=e,this.trackerDuration=t,this.optimizations=[]}addOptimization(e){return this.optimizations.push(e),this}addCustomOptimization(e,t,i=0){let r=new GI(i);return r.onApply=e,r.onGetDescription=t,this.optimizations.push(r),this}static LowDegradationAllowed(e){let t=new s(e),i=0;return t.addOptimization(new wf(i)),t.addOptimization(new Lu(i)),t.addOptimization(new Fu(i)),i++,t.addOptimization(new wu(i)),t.addOptimization(new Nu(i)),i++,t.addOptimization(new Ou(i,1024)),t}static ModerateDegradationAllowed(e){let t=new s(e),i=0;return t.addOptimization(new wf(i)),t.addOptimization(new Lu(i)),t.addOptimization(new Fu(i)),i++,t.addOptimization(new wu(i)),t.addOptimization(new Nu(i)),i++,t.addOptimization(new Ou(i,512)),i++,t.addOptimization(new j_(i)),i++,t.addOptimization(new Ff(i,2)),t}static HighDegradationAllowed(e){let t=new s(e),i=0;return t.addOptimization(new wf(i)),t.addOptimization(new Lu(i)),t.addOptimization(new Fu(i)),i++,t.addOptimization(new wu(i)),t.addOptimization(new Nu(i)),i++,t.addOptimization(new Ou(i,256)),i++,t.addOptimization(new j_(i)),i++,t.addOptimization(new Ff(i,4)),t}},Z_=class s{get isInImprovementMode(){return this._improvementMode}set isInImprovementMode(e){this._improvementMode=e}get currentPriorityLevel(){return this._currentPriorityLevel}get currentFrameRate(){return this._currentFrameRate}get targetFrameRate(){return this._targetFrameRate}set targetFrameRate(e){this._targetFrameRate=e}get trackerDuration(){return this._trackerDuration}set trackerDuration(e){this._trackerDuration=e}get optimizations(){return this._options.optimizations}constructor(e,t,i=!0,r=!1){if(this._isRunning=!1,this._currentPriorityLevel=0,this._targetFrameRate=60,this._trackerDuration=2e3,this._currentFrameRate=0,this._improvementMode=!1,this.onSuccessObservable=new N,this.onNewOptimizationAppliedObservable=new N,this.onFailureObservable=new N,t?this._options=t:this._options=new Nf,this._options.targetFrameRate&&(this._targetFrameRate=this._options.targetFrameRate),this._options.trackerDuration&&(this._trackerDuration=this._options.trackerDuration),i){let n=0;for(let a of this._options.optimizations)a.priority=n++}this._improvementMode=r,this._scene=e||Z.LastCreatedScene,this._sceneDisposeObserver=this._scene.onDisposeObservable.add(()=>{this._sceneDisposeObserver=null,this.dispose()})}stop(){this._isRunning=!1}reset(){this._currentPriorityLevel=0}start(){this._isRunning||(this._isRunning=!0,this._scene.executeWhenReady(()=>{setTimeout(()=>{this._checkCurrentState()},this._trackerDuration)}))}_checkCurrentState(){if(!this._isRunning)return;let e=this._scene,t=this._options;if(this._currentFrameRate=Math.round(e.getEngine().getFps()),this._improvementMode&&this._currentFrameRate<=this._targetFrameRate||!this._improvementMode&&this._currentFrameRate>=this._targetFrameRate){this._isRunning=!1,this.onSuccessObservable.notifyObservers(this);return}let i=!0,r=!0;for(let n=0;n<t.optimizations.length;n++){let a=t.optimizations[n];a.priority===this._currentPriorityLevel&&(r=!1,i=i&&a.apply(e,this),this.onNewOptimizationAppliedObservable.notifyObservers(a))}if(r){this._isRunning=!1,this.onFailureObservable.notifyObservers(this);return}i&&this._currentPriorityLevel++,e.executeWhenReady(()=>{setTimeout(()=>{this._checkCurrentState()},this._trackerDuration)})}dispose(){this.stop(),this.onSuccessObservable.clear(),this.onFailureObservable.clear(),this.onNewOptimizationAppliedObservable.clear(),this._sceneDisposeObserver&&this._scene.onDisposeObservable.remove(this._sceneDisposeObserver)}static OptimizeAsync(e,t,i,r){let n=new s(e,t||Nf.ModerateDegradationAllowed(),!1);return i&&n.onSuccessObservable.add(()=>{i()}),r&&n.onFailureObservable.add(()=>{r()}),n.start(),n}};Xi();Ee();Aa();Hm();it();Aa();Xh();var J_=class extends Wi{constructor(e,t){super(e,t),this.color=new me(.2,.2,.3,1),this.clearColor=!0,this.convertColorToLinearSpace=!1,this.clearDepth=!1,this.clearStencil=!1,this.stencilValue=0,this.outputTexture=this._frameGraph.textureManager.createDanglingHandle(),this.outputDepthTexture=this._frameGraph.textureManager.createDanglingHandle()}record(){if(this.targetTexture===void 0&&this.depthTexture===void 0)throw new Error(`FrameGraphClearTextureTask ${this.name}: targetTexture and depthTexture can't both be undefined.`);let e=this.targetTexture!==void 0?Array.isArray(this.targetTexture)?this.targetTexture:[this.targetTexture]:void 0,t=0,i=0;if(this.targetTexture!==void 0&&(t=this._frameGraph.textureManager.getTextureDescription(e[0]).options.samples||1,this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,e[0])),this.depthTexture!==void 0&&(i=this._frameGraph.textureManager.getTextureDescription(this.depthTexture).options.samples||1,this._frameGraph.textureManager.resolveDanglingHandle(this.outputDepthTexture,this.depthTexture)),t!==i&&t!==0&&i!==0)throw new Error(`FrameGraphClearTextureTask ${this.name}: the depth texture and the target texture must have the same number of samples.`);let r=this._frameGraph.engine.buildTextureLayout(e?Array(e.length).fill(!0):[],this.targetTexture===0),n=Qi.Color4[0],a=this._frameGraph.addRenderPass(this.name);a.setRenderTarget(e),a.setRenderTargetDepth(this.depthTexture),a.setExecuteFunc(l=>{n.copyFrom(this.color),this.convertColorToLinearSpace&&n.toLinearSpaceToRef(n),l.clearAttachments(n,r,!!this.clearColor,!!this.clearDepth,!!this.clearStencil,this.stencilValue)});let o=this._frameGraph.addRenderPass(this.name+"_disabled",!0);return o.setRenderTarget(e),o.setRenderTargetDepth(this.depthTexture),o.setExecuteFunc(l=>{}),a}};qR();km();ie();var Bu=class extends Ho{constructor(e,t,i){super(e,t,i||new Hr(e,t.engine,new he(1,0),10))}record(e=!1,t,i){let r=super.record(e,t,i);return this.postProcess.textureWidth=this._outputWidth,this.postProcess.textureHeight=this._outputHeight,r}};jh();Ut();Xh();var $_=class{constructor(e,t,i,r){this._isBackBuffer=!1,this.name=e,this._textureManager=t,this._renderTargets=i===void 0?void 0:Array.isArray(i)?i:[i],this._renderTargetDepth=r}get renderTargetWrapper(){if(!this._isBackBuffer){if(!this._renderTargetWrapper){let e=this._textureManager.engine,t=this._renderTargets===void 0||this._renderTargets.length===0?this._renderTargetDepth:this._renderTargets[0];if(this._textureManager.isBackbuffer(t)){this._isBackBuffer=!0;return}let i=this._textureManager.getTextureDescription(t),r={textureCount:this._renderTargets?.length??0,generateDepthBuffer:!1,label:this.name,samples:i.options.samples??1,dontCreateTextures:!0};this._renderTargetWrapper=e.createMultipleRenderTarget(i.size,r,!0);for(let n=0;n<r.textureCount;n++){let a=this._renderTargets[n],o=this._textureManager.getTextureFromHandle(a);if(!o)throw new Error(`FrameGraphRenderTarget.renderTargetWrapper: Failed to get texture from handle. handle: ${a}, name: ${this.name}, index: ${n}, renderTargets: ${this._renderTargets}`);this._renderTargetWrapper.setTexture(o,n,!1)}this._renderTargetDepth!==void 0&&this._renderTargetWrapper.setDepthStencilTexture(this._textureManager.getTextureFromHandle(this._renderTargetDepth),!1)}return this._renderTargetWrapper}}equals(e){let t=this._renderTargets,i=e._renderTargets;if(t!==void 0&&i!==void 0){if(t.length!==i.length)return!1;for(let r=0;r<t.length;r++)if(t[r]!==i[r])return!1}else if(t===void 0&&i!==void 0||t!==void 0&&i===void 0)return!1;return this._renderTargetDepth===e._renderTargetDepth}};kR();Ee();Tl();var Ir;(function(s){s[s.Task=0]="Task",s[s.Graph=1]="Graph",s[s.External=2]="External"})(Ir||(Ir={}));var Uu=class s{constructor(e,t=!1,i){this.engine=e,this._debugTextures=t,this._scene=i,this._textures=new Map,this._historyTextures=new Map,this._isRecordingTask=!1,this.showDebugLogsForTextureAllcationOptimization=!1,this._addSystemTextures()}isBackbuffer(e){if(e===0||e===1)return!0;let t=this._textures.get(e);return t?t.refHandle===0||t.refHandle===1:!1}isBackbufferColor(e){if(e===0)return!0;let t=this._textures.get(e);return t?t.refHandle===0:!1}isBackbufferDepthStencil(e){if(e===1)return!0;let t=this._textures.get(e);return t?t.refHandle===1:!1}isHistoryTexture(e){let t=this._textures.get(e);return t?(e=t.refHandle??e,this._historyTextures.has(e)):!1}getTextureCreationOptions(e){let t=this._textures.get(e),i=t.creationOptions;return{size:Os(i.size)?{...i.size}:i.size,sizeIsPercentage:i.sizeIsPercentage,options:s.CloneTextureOptions(i.options,t.textureIndex),isHistoryTexture:i.isHistoryTexture}}getTextureDescription(e){let t=this.getTextureCreationOptions(e);return{size:t.sizeIsPercentage?this.getAbsoluteDimensions(t.size):Os(t.size)?t.size:{width:t.size,height:t.size},options:t.options}}getTextureHandleOrCreateTexture(e,t,i){if(e===void 0){if(t===void 0||i===void 0)throw new Error("getTextureHandleOrCreateTexture: Either handle or newTextureName and creationOptions must be provided.");return this.createRenderTargetTexture(t,i)}return e}getTextureFromHandle(e){let t=this._historyTextures.get(e);return t?t.textures[t.index^1]:this._textures.get(e).texture}importTexture(e,t,i){i!==void 0&&this._freeEntry(i);let r={size:{width:t.width,height:t.height},sizeIsPercentage:!1,isHistoryTexture:!1,options:{createMipMaps:t.generateMipMaps,samples:t.samples,types:[t.type],formats:[t.format],useSRGBBuffers:[t._useSRGBBuffer],creationFlags:[t._creationFlags],labels:t.label?[t.label]:["imported"]}};return this._createHandleForTexture(e,t,r,Ir.External,i)}createRenderTargetTexture(e,t,i){return this._createHandleForTexture(e,null,{size:Os(t.size)?{...t.size}:t.size,sizeIsPercentage:t.sizeIsPercentage,isHistoryTexture:t.isHistoryTexture,options:s.CloneTextureOptions(t.options,void 0,!0)},this._isRecordingTask?Ir.Task:Ir.Graph,i)}createRenderTarget(e,t,i,r,n){let a=new $_(e,this,t,i),o=a.renderTargetWrapper;if(o!==void 0&&(o.depthReadOnly=!!r,o.stencilReadOnly=!!n,t)){let l=Array.isArray(t)?t:[t];for(let c=0;c<l.length;c++){let f=l[c];f=this._textures.get(f)?.refHandle??f;let h=this._historyTextures.get(f);h&&(h.references.push({renderTargetWrapper:o,textureIndex:c}),o.setTexture(h.textures[h.index],c,!1))}}return a}createDanglingHandle(){return s._Counter++}resolveDanglingHandle(e,t,i,r){if(t===void 0){if(i===void 0||r===void 0)throw new Error("resolveDanglingHandle: Either handle or newTextureName and creationOptions must be provided.");this.createRenderTargetTexture(i,r,e);return}let n=this._textures.get(t);if(n===void 0)throw new Error(`resolveDanglingHandle: Handle ${t} does not exist!`);this._textures.set(e,{texture:n.texture,refHandle:t,name:n.name,creationOptions:{size:{...n.creationOptions.size},options:s.CloneTextureOptions(n.creationOptions.options),sizeIsPercentage:n.creationOptions.sizeIsPercentage,isHistoryTexture:!1},namespace:n.namespace,textureIndex:n.textureIndex})}getAbsoluteDimensions(e,t=this.engine.getRenderWidth(!0),i=this.engine.getRenderHeight(!0)){let{width:r,height:n}=cf(e);return{width:Math.floor(r*t/100),height:Math.floor(n*i/100)}}computeTotalTextureSize(e,t,i){let r=0;return this._textures.forEach((n,a)=>{if(a===0||a===1||n.refHandle!==void 0||e&&n.aliasHandle!==void 0)return;let o=n.creationOptions,l=n.textureIndex||0,c=o.sizeIsPercentage?this.getAbsoluteDimensions(o.size,t,i):cf(o.size),f=s._GetTextureBlockInformation(o.options.types?.[l]??0,o.options.formats[l]),h=Math.ceil(c.width/f.width)*Math.ceil(c.height/f.height)*f.length,u=h;o.options.createMipMaps&&(u=Math.floor(u*4/3)),(o.options.samples||1)>1&&(u+=h),r+=u}),r}_dispose(){this._releaseTextures()}_allocateTextures(e){e&&this._optimizeTextureAllocation(e),this._textures.forEach(t=>{if(!t.texture){if(t.refHandle!==void 0){let i=this._textures.get(t.refHandle);t.texture=i.texture,t.texture?.incrementReferences(),i.refHandle===0&&(t.refHandle=0),i.refHandle===1&&(t.refHandle=1)}else if(t.namespace!==Ir.External)if(t.aliasHandle!==void 0){let i=this._textures.get(t.aliasHandle);t.texture=i.texture,t.texture.incrementReferences()}else{let i=t.creationOptions,r=i.sizeIsPercentage?this.getAbsoluteDimensions(i.size):i.size,n=t.textureIndex||0,a={createMipMaps:i.options.createMipMaps,samples:i.options.samples,type:i.options.types?.[n],format:i.options.formats?.[n],useSRGBBuffer:i.options.useSRGBBuffers?.[n],creationFlags:i.options.creationFlags?.[n],label:i.options.labels?.[n]??`${t.name}${n>0?"#"+n:""}`,samplingMode:1,createMSAATexture:i.options.samples>1},o=Fh(a.format),l=ss(a.format),c=o&&l?12:o||l?14:5,f=this.engine._createInternalTexture(r,a,!1,c);o&&(f.type=jp(f.format)),t.texture=f}}t.texture&&t.refHandle===void 0&&(t.debug?.dispose(),t.debug=this._createDebugTexture(t.name,t.texture))}),this._historyTextures.forEach(t=>{for(let i=0;i<t.handles.length;i++)t.textures[i]=this._textures.get(t.handles[i]).texture})}_releaseTextures(e=!0){this._textures.forEach((t,i)=>{t.lifespan&&(t.lifespan.firstTask=Number.MAX_VALUE,t.lifespan.lastTask=0),t.aliasHandle=void 0,(e||t.namespace!==Ir.External)&&(t.debug?.dispose(),t.debug=void 0),t.namespace!==Ir.External&&(t.texture?.dispose(),t.texture=null,(e||t.namespace===Ir.Task)&&this._textures.delete(i))}),this._historyTextures.forEach(t=>{for(let i=0;i<t.handles.length;i++)t.textures[i]=null}),e&&(this._textures.clear(),this._historyTextures.clear(),this._addSystemTextures())}_updateHistoryTextures(){this._historyTextures.forEach(e=>{e.index=e.index^1;let t=e.textures[e.index];if(t)for(let{renderTargetWrapper:i,textureIndex:r}of e.references)i.setTexture(t,r,!1)})}_addSystemTextures(){let e={width:this.engine.getRenderWidth(!0),height:this.engine.getRenderHeight(!0)};this._textures.set(0,{name:"backbuffer color",texture:null,creationOptions:{size:e,options:{createMipMaps:!1,samples:this.engine.getCreationOptions().antialias?4:1,types:[0],formats:[5],useSRGBBuffers:[!1],creationFlags:[0],labels:["backbuffer color"]},sizeIsPercentage:!1},namespace:Ir.External}),this._textures.set(1,{name:"backbuffer depth/stencil",texture:null,creationOptions:{size:e,options:{createMipMaps:!1,samples:this.engine.getCreationOptions().antialias?4:1,types:[0],formats:[16],useSRGBBuffers:[!1],creationFlags:[0],labels:["backbuffer depth/stencil"]},sizeIsPercentage:!1},namespace:Ir.External})}_createDebugTexture(e,t){if(!this._debugTextures)return;let i=new H(null,this._scene);return i.name=e,i._texture=t,i._texture.incrementReferences(),i}_freeEntry(e){let t=this._textures.get(e);t&&(t.debug?.dispose(),this._textures.delete(e))}_createHandleForTexture(e,t,i,r,n,a){n=n??s._Counter++,a=a||0;let o=i.isHistoryTexture?`${e} ping`:e,l=i.options.labels?.[a]??"";l===o&&(l="");let c={texture:t,name:`${o}${l?" "+l:""}`,creationOptions:{size:Os(i.size)?i.size:{width:i.size,height:i.size},options:i.options,sizeIsPercentage:i.sizeIsPercentage,isHistoryTexture:i.isHistoryTexture},namespace:r,textureIndex:a,textureDescriptionHash:this._createTextureDescriptionHash(i),lifespan:{firstTask:Number.MAX_VALUE,lastTask:0}};if(this._textures.set(n,c),r===Ir.External)return n;if(i.isHistoryTexture){let f={size:{...c.creationOptions.size},options:{...c.creationOptions.options},sizeIsPercentage:c.creationOptions.sizeIsPercentage,isHistoryTexture:!1},h=this._createHandleForTexture(`${e} pong`,null,f,r);return this._historyTextures.set(n,{textures:[null,null],handles:[n,h],index:0,references:[]}),n}if(i.options.types&&i.options.types.length>1&&a===0){let f=i.options.types.length,h={size:Os(i.size)?i.size:{width:i.size,height:i.size},options:i.options,sizeIsPercentage:i.sizeIsPercentage};for(let u=1;u<f;u++)this._createHandleForTexture(o,null,h,r,n+u,u);s._Counter+=f-1}return n}_createTextureDescriptionHash(e){let t=[];return t.push(Os(e.size)?`${e.size.width}_${e.size.height}`:`${e.size}`),t.push(e.sizeIsPercentage?"%":"A"),t.push(e.options.createMipMaps?"M":"N"),t.push(e.options.samples?`${e.options.samples}`:"S1"),t.push(e.options.types?e.options.types.join("_"):"0"),t.push(e.options.formats?e.options.formats.join("_"):"5"),t.push(e.options.useSRGBBuffers?e.options.useSRGBBuffers.join("_"):"false"),t.push(e.options.creationFlags?e.options.creationFlags.join("_"):"0"),t.join("_")}_optimizeTextureAllocation(e){this._computeTextureLifespan(e),this.showDebugLogsForTextureAllcationOptimization&&P.Log("================== Optimization of texture allocation ==================");let t=new Map,i=this._textures.keys();for(let r=i.next();r.done!==!0;r=i.next()){let n=r.value,a=this._textures.get(n);if(a.refHandle!==void 0||a.namespace===Ir.External||this._historyTextures.has(n))continue;let o=a.textureDescriptionHash,l=a.lifespan,c=t.get(o);if(c){let f=!1;for(let h of c){let[u,d]=h,p=!1;for(let m of d)if(m.firstTask<=l.lastTask&&m.lastTask>=l.firstTask){p=!0;break}if(!p){this.showDebugLogsForTextureAllcationOptimization&&P.Log(`Texture ${n} (${a.name}) reuses cache entry ${u}`),d.push(l),a.aliasHandle=u,f=!0;break}}f||c.push([n,[l]])}else t.set(o,[[n,[l]]])}}_computeTextureLifespan(e){this.showDebugLogsForTextureAllcationOptimization&&P.Log("================== Dump of texture dependencies for all tasks/passes ==================");for(let t=0;t<e.length;++t){let i=e[t];i.passes.length>0&&this._computeTextureLifespanForPasses(i,t,i.passes),i.passesDisabled.length>0&&this._computeTextureLifespanForPasses(i,t,i.passesDisabled),i.dependencies&&(this.showDebugLogsForTextureAllcationOptimization&&P.Log(`task#${t} (${i.name}), global dependencies`),this._updateLifespan(t*100+99,i.dependencies))}if(this.showDebugLogsForTextureAllcationOptimization){P.Log("================== Texture lifespans ==================");let t=this._textures.keys();for(let i=t.next();i.done!==!0;i=t.next()){let r=i.value,n=this._textures.get(r);n.refHandle!==void 0||n.namespace===Ir.External||this._historyTextures.has(r)||P.Log(`${r} (${n.name}): ${n.lifespan.firstTask} - ${n.lifespan.lastTask}`)}}}_computeTextureLifespanForPasses(e,t,i){for(let r=0;r<i.length;++r){let n=new Set,a=i[r];Il.IsRenderPass(a)&&(a.collectDependencies(n),this.showDebugLogsForTextureAllcationOptimization&&P.Log(`task#${t} (${e.name}), pass#${r} (${a.name})`),this._updateLifespan(t*100+r,n))}}_updateLifespan(e,t){let i=t.keys();for(let r=i.next();r.done!==!0;r=i.next()){let n=r.value,a=this._textures.get(n);if(!a)throw new Error(`FrameGraph._computeTextureLifespan: Texture handle "${n}" not found in the texture manager.`);let o=n;for(;a.refHandle!==void 0;)if(o=a.refHandle,a=this._textures.get(o),!a)throw new Error(`FrameGraph._computeTextureLifespan: Texture handle "${o}" not found in the texture manager (source handle="${n}").`);a.namespace===Ir.External||this._historyTextures.has(o)||(this.showDebugLogsForTextureAllcationOptimization&&P.Log(`    ${o} (${a.name})`),a.lifespan.firstTask=Math.min(a.lifespan.firstTask,e),a.lifespan.lastTask=Math.max(a.lifespan.lastTask,e))}}static CloneTextureOptions(e,t,i){return t!==void 0?{createMipMaps:e.createMipMaps,samples:e.samples,types:e.types?[e.types[t]]:void 0,formats:e.formats?[e.formats[t]]:void 0,useSRGBBuffers:e.useSRGBBuffers?[e.useSRGBBuffers[t]]:void 0,creationFlags:e.creationFlags?[e.creationFlags[t]]:void 0,labels:e.labels?[e.labels[t]]:void 0}:{createMipMaps:e.createMipMaps,samples:e.samples,types:e.types?[...e.types]:void 0,formats:e.formats?[...e.formats]:void 0,useSRGBBuffers:e.useSRGBBuffers?[...e.useSRGBBuffers]:void 0,creationFlags:e.creationFlags?[...e.creationFlags]:void 0,labels:e.labels&&i?[...e.labels]:void 0}}static _GetTextureBlockInformation(e,t){switch(t){case 15:return{width:1,height:1,length:2};case 16:return{width:1,height:1,length:3};case 13:return{width:1,height:1,length:4};case 14:return{width:1,height:1,length:4};case 18:return{width:1,height:1,length:5};case 19:return{width:1,height:1,length:1};case 36492:return{width:4,height:4,length:16};case 36495:return{width:4,height:4,length:16};case 36494:return{width:4,height:4,length:16};case 33779:return{width:4,height:4,length:16};case 33778:return{width:4,height:4,length:16};case 33777:case 33776:return{width:4,height:4,length:8};case 37808:return{width:4,height:4,length:16};case 36196:case 37492:return{width:4,height:4,length:8};case 37496:return{width:4,height:4,length:16}}switch(e){case 3:case 0:switch(t){case 6:case 8:case 0:case 1:case 2:return{width:1,height:1,length:1};case 7:case 9:return{width:1,height:1,length:2};case 4:case 10:return{width:1,height:1,length:3};case 11:return{width:1,height:1,length:4};default:return{width:1,height:1,length:4}}case 4:case 5:switch(t){case 8:return{width:1,height:1,length:2};case 9:return{width:1,height:1,length:4};case 10:return{width:1,height:1,length:6};case 11:return{width:1,height:1,length:8};default:return{width:1,height:1,length:8}}case 6:case 7:switch(t){case 8:return{width:1,height:1,length:4};case 9:return{width:1,height:1,length:8};case 10:return{width:1,height:1,length:12};case 11:return{width:1,height:1,length:16};default:return{width:1,height:1,length:16}}case 1:switch(t){case 6:return{width:1,height:1,length:4};case 7:return{width:1,height:1,length:8};case 4:return{width:1,height:1,length:12};case 5:return{width:1,height:1,length:16};default:return{width:1,height:1,length:16}}case 2:switch(t){case 6:return{width:1,height:1,length:2};case 7:return{width:1,height:1,length:4};case 4:return{width:1,height:1,length:6};case 5:return{width:1,height:1,length:8};default:return{width:1,height:1,length:8}}case 10:return{width:1,height:1,length:2};case 13:switch(t){case 5:case 11:return{width:1,height:1,length:4};default:return{width:1,height:1,length:4}}case 14:switch(t){case 5:case 11:return{width:1,height:1,length:4};default:return{width:1,height:1,length:4}}case 8:return{width:1,height:1,length:2};case 9:return{width:1,height:1,length:2};case 11:switch(t){case 5:return{width:1,height:1,length:4};case 11:return{width:1,height:1,length:4};default:return{width:1,height:1,length:4}}}return{width:1,height:1,length:4}}};Uu._Counter=2;jh();km();ie();we();it();gt();yt();In();cs();bo();El();rn();Xi();wh();Sa();var Bf=class s extends ti{constructor(e,t=null,i,r,n){super({...n,name:e,engine:t||ee.LastCreatedEngine,useShaderStore:!0,useAsPostProcess:!0,fragmentShader:s.FragmentUrl,uniforms:s.Uniforms}),this.direction=i,this.kernel=r,this.textureWidth=0,this.textureHeight=0}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(()=>(IV(),CV)))):t.push(Promise.resolve().then(()=>(PV(),MV))),super._gatherImports(e,t)}bind(){super.bind(),this._drawWrapper.effect.setFloat2("screenSize",this.textureWidth,this.textureHeight),this._drawWrapper.effect.setVector2("direction",this.direction),this._drawWrapper.effect.setFloat("blurWidth",this.kernel)}};Bf.FragmentUrl="glowBlurPostProcess";Bf.Uniforms=["screenSize","direction","blurWidth"];var YI=class s{get camera(){return this._options.camera}set camera(e){this._options.camera=e}get renderingGroupId(){return this._options.renderingGroupId}set renderingGroupId(e){this._options.renderingGroupId=e}get objectRenderer(){return this._objectRenderer}get shaderLanguage(){return this._shaderLanguage}setMaterialForRendering(e,t){if(this._objectRenderer.setMaterialForRendering(e,t),Array.isArray(e))for(let i=0;i<e.length;++i){let r=e[i];t?this._materialForRendering[r.uniqueId]=[r,t]:delete this._materialForRendering[r.uniqueId]}else t?this._materialForRendering[e.uniqueId]=[e,t]:delete this._materialForRendering[e.uniqueId]}getEffectIntensity(e){return this._effectIntensity[e.uniqueId]??1}setEffectIntensity(e,t){this._effectIntensity[e.uniqueId]=t}constructor(e,t,i=!1,r=!1,n){this._additionalImportShadersAsync=n,this._vertexBuffers={},this._dontCheckIfReady=!1,this._shouldRender=!0,this._emissiveTextureAndColor={texture:null,color:new me},this._effectIntensity={},this._postProcesses=[],this.neutralColor=new me,this.isEnabled=!0,this.disableBoundingBoxesFromEffectLayer=!1,this.onDisposeObservable=new N,this.onBeforeRenderLayerObservable=new N,this.onBeforeComposeObservable=new N,this.onBeforeRenderMeshToEffect=new N,this.onAfterRenderMeshToEffect=new N,this.onAfterComposeObservable=new N,this.onBeforeBlurObservable=new N,this.onAfterBlurObservable=new N,this._shaderLanguage=0,this._materialForRendering={},this._shadersLoaded=!1,this.name=e,this._scene=t||Z.LastCreatedScene,this._dontCheckIfReady=r,this._scene.getEngine().isWebGPU&&!i&&!s.ForceGLSL&&(this._shaderLanguage=1),this._engine=this._scene.getEngine(),this._mergeDrawWrapper=[],this._generateIndexBuffer(),this._generateVertexBuffer()}getEffectName(){return""}isReady(e,t){return!0}needStencil(){return!1}_createMergeEffect(){throw new Error("Effect Layer: no merge effect defined")}_createTextureAndPostProcesses(){}_internalCompose(e,t){}_setEmissiveTextureAndColor(e,t,i){}_numInternalDraws(){return 1}_init(e){this._options={mainTextureRatio:.5,mainTextureFixedSize:0,mainTextureType:0,alphaBlendingMode:2,camera:null,renderingGroupId:-1,...e},this._createObjectRenderer()}_generateIndexBuffer(){let e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._engine.createIndexBuffer(e)}_generateVertexBuffer(){let e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1);let t=new A(this._engine,e,A.PositionKind,!1,!1,2);this._vertexBuffers[A.PositionKind]=t}_createObjectRenderer(){this._objectRenderer=new rr(`ObjectRenderer for thin effect layer ${this.name}`,this._scene,{doNotChangeAspectRatio:!0}),this._objectRenderer.activeCamera=this._options.camera,this._objectRenderer.renderParticles=!1,this._objectRenderer.renderList=null;let e=!!this._scene.getBoundingBoxRenderer,t=!1;e&&(this._objectRenderer.onBeforeRenderObservable.add(()=>{t=this._scene.getBoundingBoxRenderer().enabled,this._scene.getBoundingBoxRenderer().enabled=!this.disableBoundingBoxesFromEffectLayer&&t}),this._objectRenderer.onAfterRenderObservable.add(()=>{this._scene.getBoundingBoxRenderer().enabled=t})),this._objectRenderer.customIsReadyFunction=(i,r,n)=>{if((n||r===0)&&i.subMeshes)for(let a=0;a<i.subMeshes.length;++a){let o=i.subMeshes[a],l=o.getMaterial(),c=o.getRenderingMesh();if(!l)continue;let h=c._getInstancesRenderList(o._id,!!o.getReplacementMesh()).hardwareInstancedRendering[o._id]||c.hasThinInstances;if(this._setEmissiveTextureAndColor(c,o,l),!this._isSubMeshReady(o,h,this._emissiveTextureAndColor.texture))return!1}return!0},this._objectRenderer.customRenderFunction=(i,r,n,a)=>{this.onBeforeRenderLayerObservable.notifyObservers(this);let o,l=this._scene.getEngine();if(a.length){for(l.setColorWrite(!1),o=0;o<a.length;o++)this._renderSubMesh(a.data[o]);l.setColorWrite(!0)}for(o=0;o<i.length;o++)this._renderSubMesh(i.data[o]);for(o=0;o<r.length;o++)this._renderSubMesh(r.data[o]);let c=l.getAlphaMode();for(o=0;o<n.length;o++){let f=n.data[o],h=f.getMaterial();if(h&&h.needDepthPrePass){let u=h.getScene().getEngine();u.setColorWrite(!1),this._renderSubMesh(f),u.setColorWrite(!0)}this._renderSubMesh(f,!0)}l.setAlphaMode(c)}}_addCustomEffectDefines(e){}_internalIsSubMeshReady(e,t,i){let r=this._scene.getEngine(),n=e.getMesh(),a=n._internalAbstractMeshDataInfo._materialForRenderPass?.[r.currentRenderPassId];if(a)return a.isReadyForSubMesh(n,e,t);let o=e.getMaterial();if(!o)return!1;if(this._useMeshMaterial(e.getRenderingMesh()))return o.isReadyForSubMesh(e.getMesh(),e,t);let l=[],c=[A.PositionKind],f=!1,h=!1,u=!1;if(o){let C=o.needAlphaTestingForMesh(n),I=o.getAlphaTestTexture(),R=I&&I.hasAlpha&&(o.useAlphaFromDiffuseTexture||o._useAlphaFromAlbedoTexture);I&&(C||R)&&(l.push("#define DIFFUSE"),n.isVerticesDataPresent(A.UV2Kind)&&I.coordinatesIndex===1?(l.push("#define DIFFUSEUV2"),h=!0):n.isVerticesDataPresent(A.UVKind)&&(l.push("#define DIFFUSEUV1"),f=!0),C&&(l.push("#define ALPHATEST"),l.push("#define ALPHATESTVALUE 0.4")),I.gammaSpace||l.push("#define DIFFUSE_ISLINEAR"));let b=o.opacityTexture;b&&(l.push("#define OPACITY"),n.isVerticesDataPresent(A.UV2Kind)&&b.coordinatesIndex===1?(l.push("#define OPACITYUV2"),h=!0):n.isVerticesDataPresent(A.UVKind)&&(l.push("#define OPACITYUV1"),f=!0))}i&&(l.push("#define EMISSIVE"),n.isVerticesDataPresent(A.UV2Kind)&&i.coordinatesIndex===1?(l.push("#define EMISSIVEUV2"),h=!0):n.isVerticesDataPresent(A.UVKind)&&(l.push("#define EMISSIVEUV1"),f=!0),i.gammaSpace||l.push("#define EMISSIVE_ISLINEAR")),n.useVertexColors&&n.isVerticesDataPresent(A.ColorKind)&&n.hasVertexAlpha&&o.transparencyMode!==Q.MATERIAL_OPAQUE&&(c.push(A.ColorKind),l.push("#define VERTEXALPHA")),f&&(c.push(A.UVKind),l.push("#define UV1")),h&&(c.push(A.UV2Kind),l.push("#define UV2"));let d=new or;if(n.useBones&&n.computeBonesUsingShaders){c.push(A.MatricesIndicesKind),c.push(A.MatricesWeightsKind),n.numBoneInfluencers>4&&(c.push(A.MatricesIndicesExtraKind),c.push(A.MatricesWeightsExtraKind)),l.push("#define NUM_BONE_INFLUENCERS "+n.numBoneInfluencers);let C=n.skeleton;C&&C.isUsingTextureForMatrices?l.push("#define BONETEXTURE"):l.push("#define BonesPerMesh "+(C?C.bones.length+1:0)),n.numBoneInfluencers>0&&d.addCPUSkinningFallback(0,n)}else l.push("#define NUM_BONE_INFLUENCERS 0");let p=n.morphTargetManager?Fn(n.morphTargetManager,l,c,n,!0,!1,!1,f,h,u):0;t&&(l.push("#define INSTANCES"),sn(c),e.getRenderingMesh().hasThinInstances&&l.push("#define THIN_INSTANCES")),On(o,this._scene,l),this._addCustomEffectDefines(l);let m=e._getDrawWrapper(void 0,!0),_=m.defines,v=l.join(`
`);if(_!==v){let C=["world","mBones","viewProjection","glowColor","morphTargetInfluences","morphTargetCount","boneTextureWidth","diffuseMatrix","emissiveMatrix","opacityMatrix","opacityIntensity","morphTargetTextureInfo","morphTargetTextureIndices","glowIntensity"];Hi(C),m.setEffect(this._engine.createEffect("glowMapGeneration",c,C,["diffuseSampler","emissiveSampler","opacitySampler","boneSampler","morphTargets"],v,d,void 0,void 0,{maxSimultaneousMorphTargets:p},this._shaderLanguage,this._shadersLoaded?void 0:async()=>{await this._importShadersAsync(),this._shadersLoaded=!0}),v)}return m.effect.isReady()&&(this._dontCheckIfReady||!this._dontCheckIfReady&&this.isLayerReady())}_isSubMeshReady(e,t,i){return this._internalIsSubMeshReady(e,t,i)}async _importShadersAsync(){this._shaderLanguage===1?await Promise.all([Promise.resolve().then(()=>(LV(),OV)),Promise.resolve().then(()=>(NV(),FV))]):await Promise.all([Promise.resolve().then(()=>(GV(),UV)),Promise.resolve().then(()=>(WV(),kV))]),this._additionalImportShadersAsync?.()}_internalIsLayerReady(){let e=!0;for(let i=0;i<this._postProcesses.length;i++)e=this._postProcesses[i].isReady()&&e;let t=this._numInternalDraws();for(let i=0;i<t;++i){let r=this._mergeDrawWrapper[i];r||(r=this._mergeDrawWrapper[i]=new Vr(this._engine),r.setEffect(this._createMergeEffect())),e=r.effect.isReady()&&e}return e}isLayerReady(){return this._internalIsLayerReady()}compose(){if(!this._dontCheckIfReady&&!this.isLayerReady())return!1;let e=this._scene.getEngine(),t=this._numInternalDraws();this.onBeforeComposeObservable.notifyObservers(this);let i=e.getAlphaMode();for(let r=0;r<t;++r){let n=this._mergeDrawWrapper[r];e.enableEffect(n),e.setState(!1),e.bindBuffers(this._vertexBuffers,this._indexBuffer,n.effect),e.setAlphaMode(this._options.alphaBlendingMode),this._internalCompose(n.effect,r)}return e.setAlphaMode(i),this.onAfterComposeObservable.notifyObservers(this),!0}_internalHasMesh(e){return this.renderingGroupId===-1||e.renderingGroupId===this.renderingGroupId}hasMesh(e){return this._internalHasMesh(e)}_internalShouldRender(){return this.isEnabled&&this._shouldRender}shouldRender(){return this._internalShouldRender()}_shouldRenderMesh(e){return!0}_internalCanRenderMesh(e,t){return!t.needAlphaBlendingForMesh(e)}_canRenderMesh(e,t){return this._internalCanRenderMesh(e,t)}_renderSubMesh(e,t=!1){if(!this._internalShouldRender())return;let i=e.getMaterial(),r=e.getMesh(),n=e.getReplacementMesh(),a=e.getRenderingMesh(),o=e.getEffectiveMesh(),l=this._scene,c=l.getEngine();if(o._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!i||!this._canRenderMesh(a,i))return;let f=i._getEffectiveOrientation(a);o._getWorldMatrixDeterminant()<0&&(f=f===Q.ClockWiseSideOrientation?Q.CounterClockWiseSideOrientation:Q.ClockWiseSideOrientation);let u=f===Q.ClockWiseSideOrientation;c.setState(i.backFaceCulling,i.zOffset,void 0,u,i.cullBackFaces,void 0,i.zOffsetUnits);let d=a._getInstancesRenderList(e._id,!!n);if(d.mustReturn||!this._shouldRenderMesh(a))return;let p=d.hardwareInstancedRendering[e._id]||a.hasThinInstances;if(this._setEmissiveTextureAndColor(a,e,i),this.onBeforeRenderMeshToEffect.notifyObservers(r),this._useMeshMaterial(a))e.getMaterial()._glowModeEnabled=!0,a.render(e,t,n||void 0),e.getMaterial()._glowModeEnabled=!1;else if(this._isSubMeshReady(e,p,this._emissiveTextureAndColor.texture)){let m=o._internalAbstractMeshDataInfo._materialForRenderPass?.[c.currentRenderPassId],_=e._getDrawWrapper();if(!_&&m&&(_=m._getDrawWrapper()),!_)return;let v=_.effect;if(c.enableEffect(_),p||a._bind(e,v,i.fillMode),m?m.bindForSubMesh(o.getWorldMatrix(),o,e):(v.setMatrix("viewProjection",l.getTransformMatrix()),v.setMatrix("world",o.getWorldMatrix()),v.setFloat4("glowColor",this._emissiveTextureAndColor.color.r,this._emissiveTextureAndColor.color.g,this._emissiveTextureAndColor.color.b,this._emissiveTextureAndColor.color.a)),!m){let T=i.needAlphaTestingForMesh(o),C=i.getAlphaTestTexture(),I=C&&C.hasAlpha&&(i.useAlphaFromDiffuseTexture||i._useAlphaFromAlbedoTexture);if(C&&(T||I)){v.setTexture("diffuseSampler",C);let b=C.getTextureMatrix();b&&v.setMatrix("diffuseMatrix",b)}let R=i.opacityTexture;if(R){v.setTexture("opacitySampler",R),v.setFloat("opacityIntensity",R.level);let b=R.getTextureMatrix();b&&v.setMatrix("opacityMatrix",b)}if(this._emissiveTextureAndColor.texture&&(v.setTexture("emissiveSampler",this._emissiveTextureAndColor.texture),v.setMatrix("emissiveMatrix",this._emissiveTextureAndColor.texture.getTextureMatrix())),a.useBones&&a.computeBonesUsingShaders&&a.skeleton){let b=a.skeleton;if(b.isUsingTextureForMatrices){let M=b.getTransformMatrixTexture(a);if(!M)return;v.setTexture("boneSampler",M),v.setFloat("boneTextureWidth",4*(b.bones.length+1))}else v.setMatrices("mBones",b.getTransformMatrices(a))}lr(a,v),a.morphTargetManager&&a.morphTargetManager.isUsingTextureForTargets&&a.morphTargetManager._bind(v),t&&c.setAlphaMode(i.alphaMode),v.setFloat("glowIntensity",this.getEffectIntensity(a)),zi(v,i,l)}a._processRendering(o,e,v,i.fillMode,d,p,(T,C)=>v.setMatrix("world",C))}else this._objectRenderer.resetRefreshCounter();this.onAfterRenderMeshToEffect.notifyObservers(r)}_useMeshMaterial(e){return!1}_rebuild(){let e=this._vertexBuffers[A.PositionKind];e&&e._rebuild(),this._generateIndexBuffer()}dispose(){let e=this._vertexBuffers[A.PositionKind];e&&(e.dispose(),this._vertexBuffers[A.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);for(let t of this._mergeDrawWrapper)t.dispose();this._mergeDrawWrapper=[],this._objectRenderer.dispose(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onBeforeRenderLayerObservable.clear(),this.onBeforeComposeObservable.clear(),this.onBeforeRenderMeshToEffect.clear(),this.onAfterRenderMeshToEffect.clear(),this.onAfterComposeObservable.clear()}};YI.ForceGLSL=!1;Aa();var Gu=class extends Wi{constructor(e,t){super(e,t)}record(){if(!this.func)throw new Error("FrameGraphExecuteTask: Execute task must have a function.");let e=this._frameGraph.addPass(this.name);return e.setExecuteFunc(i=>{this.func(i)}),this._frameGraph.addPass(this.name+"_disabled",!0).setExecuteFunc(i=>{this.funcDisabled?.(i)}),e}};var eg=class extends Ho{constructor(e,t,i){super(e,t,i||new Bf(e,t.engine,new he(1,0),1))}record(e=!1,t,i){let r=super.record(e,t,i);return this.postProcess.textureWidth=this._outputWidth,this.postProcess.textureHeight=this._outputHeight,r}},tg=class extends Wi{get name(){return this._name}set name(e){if(this._name=e,this._blurX)for(let t=0;t<this._blurX.length;t++)this._blurX[t].name=`${e} Blur X${t}`,this._blurY[t].name=`${e} Blur Y${t}`;this._clearLayerTextures&&(this._clearLayerTextures.name=e+" Clear Layer"),this._objectRendererForLayer&&(this._objectRendererForLayer.name=e+" Render to Layer")}get objectRendererForLayer(){return this._objectRendererForLayer}constructor(e,t,i,r,n,a=!1,o=!1,l=!1){super(e,t),this._setRenderTargetDepth=o,this._notifyBlurObservable=l,this._blurX=[],this._blurY=[],this._onBeforeBlurTask=null,this._onAfterBlurTask=null,this._onBeforeObservableObserver=null,this._onAfterObservableObserver=null,this._onAfterRenderingGroupObserver=null,this._scene=i,this._engine=i.getEngine(),this.layer=r;for(let c=0;c<n;c++)a?(this._blurX.push(new eg(`${e} Blur X${c}`,this._frameGraph,this.layer._postProcesses[1+c*2+0])),this._blurY.push(new eg(`${e} Blur Y${c}`,this._frameGraph,this.layer._postProcesses[1+c*2+1]))):(this._blurX.push(new Bu(`${e} Blur X${c}`,this._frameGraph,this.layer._postProcesses[c*2+0])),this._blurY.push(new Bu(`${e} Blur Y${c}`,this._frameGraph,this.layer._postProcesses[c*2+1])));this._clearLayerTextures=new J_(e+" Clear Layer",t),this._clearLayerTextures.clearColor=!0,this._clearLayerTextures.clearDepth=!0,this._objectRendererForLayer=new ka(e+" Render to Layer",t,i,void 0,this.layer.objectRenderer),this._notifyBlurObservable&&(this._onBeforeBlurTask=new Gu(e+" On Before Blur",t),this._onAfterBlurTask=new Gu(e+" On After Blur",t),this._onBeforeBlurTask.func=()=>{this.layer.onBeforeBlurObservable.hasObservers()&&this.layer.onBeforeBlurObservable.notifyObservers(this.layer)},this._onAfterBlurTask.func=()=>{this.layer.onAfterBlurObservable.hasObservers()&&this.layer.onAfterBlurObservable.notifyObservers(this.layer)}),this.outputTexture=this._frameGraph.textureManager.createDanglingHandle(),this.onTexturesAllocatedObservable.add(c=>{for(let f=0;f<this._blurX.length;f++)this._blurX[f].onTexturesAllocatedObservable.notifyObservers(c),this._blurY[f].onTexturesAllocatedObservable.notifyObservers(c);c.setTextureSamplingMode(this._blurY[this._blurY.length-1].targetTexture,2)})}isReady(){return this._objectRendererForLayer.isReady()&&this.layer.isLayerReady()}record(){if(this.targetTexture===void 0||this.objectRendererTask===void 0)throw new Error(`${this.constructor.name} "${this.name}": targetTexture and objectRendererTask are required`);this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,this.targetTexture);let e,t,i;if(this.layerTexture)i=this.layerTexture,t=this._frameGraph.textureManager.getTextureCreationOptions(this.layerTexture),e=cf(t.size),t.size=e;else{let m=this._frameGraph.textureManager.getTextureCreationOptions(this.targetTexture),_=this.layer._options.mainTextureFixedSize?Math.max(2,this.layer._options.mainTextureFixedSize):0;e=cf(m.size),e.width=_||Math.floor(e.width*(this.layer._options.mainTextureRatio||.1))||1,e.height=_||Math.floor(e.height*(this.layer._options.mainTextureRatio||.1))||1,t={size:e,options:{createMipMaps:!1,types:[this.layer._options.mainTextureType],formats:[5],samples:1,useSRGBBuffers:[!1],creationFlags:[0]},sizeIsPercentage:this.layer._options.mainTextureFixedSize?!1:m.sizeIsPercentage},i=this._frameGraph.textureManager.createRenderTargetTexture(`${this.name} Color`,t)}let r={size:e,options:Uu.CloneTextureOptions(t.options),sizeIsPercentage:t.sizeIsPercentage};r.options.formats[0]=14;let n=this._frameGraph.textureManager.createRenderTargetTexture(`${this.name} Depth`,r);this._clearLayerTextures.targetTexture=i,this._clearLayerTextures.depthTexture=n,this._clearLayerTextures.color=this.layer.neutralColor,this._clearLayerTextures.clearDepth=!0;let a=this._clearLayerTextures.record();this._objectRendererForLayer.targetTexture=this._clearLayerTextures.outputTexture,this._objectRendererForLayer.depthTexture=this._clearLayerTextures.outputDepthTexture,this._objectRendererForLayer.camera=this.objectRendererTask.camera,this._objectRendererForLayer.objectList=this.objectRendererTask.objectList,this._objectRendererForLayer.disableShadows=!0;let o=this._objectRendererForLayer.record(),l=0;this._engine.getCaps().textureHalfFloatRender?l=2:l=0,t.options.types[0]=l;let c=this.layer._options.blurTextureSizeRatio!==void 0?this.layer._options.blurTextureSizeRatio||.1:void 0;c!==void 0&&(e.width=Math.floor(e.width*c)||1,e.height=Math.floor(e.height*c)||1);let f=this._onBeforeBlurTask?.record(),h=[];for(let m=0;m<this._blurX.length;m++){let _=this._frameGraph.textureManager.createRenderTargetTexture(this._blurX[m].name,t);this._blurX[m].sourceTexture=m===0?this._objectRendererForLayer.outputTexture:this._blurY[m-1].outputTexture,this._blurX[m].sourceSamplingMode=2,this._blurX[m].targetTexture=_,h.push(this._blurX[m].record(!0));let v=this._frameGraph.textureManager.createRenderTargetTexture(this._blurY[m].name,t);this._blurY[m].sourceTexture=this._blurX[m].outputTexture,this._blurY[m].sourceSamplingMode=2,this._blurY[m].targetTexture=v,h.push(this._blurY[m].record(!0)),e.width=e.width>>1,e.height=e.height>>1}let u=this._onAfterBlurTask?.record();this.objectRendererTask.objectRenderer.onBeforeRenderObservable.remove(this._onBeforeObservableObserver),this._onBeforeObservableObserver=this.objectRendererTask.objectRenderer.onBeforeRenderObservable.add(()=>{let m=this.layer.shouldRender();a.disabled=!m,o.disabled=!m,f&&(f.disabled=!m);for(let _=0;_<h.length;_++)h[_].disabled=!m;u&&(u.disabled=!m),m&&this.layer.needStencil()&&(this._engine.setStencilBuffer(!0),this._engine.setStencilFunctionReference(1))}),this.objectRendererTask.objectRenderer.onAfterRenderObservable.remove(this._onAfterObservableObserver),this._onAfterObservableObserver=this.objectRendererTask.objectRenderer.onAfterRenderObservable.add(()=>{this.layer.shouldRender()&&this.layer.needStencil()&&this._engine.setStencilBuffer(!1)}),this.layer.bindTexturesForCompose=void 0,this._clearAfterRenderingGroupObserver();let d=this._frameGraph.addRenderPass(this.name);for(let m=0;m<this._blurY.length;m++)d.addDependencies(this._blurY[m].outputTexture);d.setRenderTarget(this.outputTexture),this._setRenderTargetDepth&&d.setRenderTargetDepth(this.objectRendererTask.depthTexture),d.setExecuteFunc(m=>{this.layer.bindTexturesForCompose||(this.layer.bindTexturesForCompose=_=>{for(let v=0;v<this._blurY.length;v++)m.bindTextureHandle(_,`textureSampler${v>0?v+1:""}`,this._blurY[v].outputTexture)}),this.layer._options.renderingGroupId!==-1?this._onAfterRenderingGroupObserver||(this._onAfterRenderingGroupObserver=this._scene.onAfterRenderingGroupObservable.add(_=>{!this.layer.shouldRender()||_.renderingGroupId!==this.layer._options.renderingGroupId||_.renderingManager!==this.objectRendererTask.objectRenderer.renderingManager||(this._objectRendererForLayer.objectList=this.objectRendererTask.objectList,m.saveDepthStates(),m.setDepthStates(!1,!1),m._applyRenderTarget(),this.layer.compose(),m.restoreDepthStates())})):(this._clearAfterRenderingGroupObserver(),this.layer.shouldRender()&&(this._objectRendererForLayer.objectList=this.objectRendererTask.objectList,m.setDepthStates(!1,!1),m._applyRenderTarget(),this.layer.compose()))});let p=this._frameGraph.addRenderPass(this.name+"_disabled",!0);p.setRenderTarget(this.outputTexture),this._setRenderTargetDepth&&p.setRenderTargetDepth(this.objectRendererTask.depthTexture),p.setExecuteFunc(m=>{})}_clearAfterRenderingGroupObserver(){this._scene.onAfterRenderingGroupObservable.remove(this._onAfterRenderingGroupObserver),this._onAfterRenderingGroupObserver=null}dispose(){this._clearAfterRenderingGroupObserver(),this._clearLayerTextures.dispose(),this._objectRendererForLayer.dispose(),this._onBeforeBlurTask?.dispose(),this._onAfterBlurTask?.dispose(),this.layer.dispose();for(let e=0;e<this._blurX.length;e++)this._blurX[e].dispose(),this._blurY[e].dispose();super.dispose()}};Hm();Xh();it();N_();Aa();wh();var tte=[new me(0,0,0,0),new me(1,1,1,1),new me(0,0,0,0)],ig=class extends Wi{get camera(){return this._camera}set camera(e){this._camera=e,this._renderer.activeCamera=this.camera}get reverseCulling(){return this._reverseCulling}set reverseCulling(e){this._reverseCulling=e;let t=si.GetConfiguration(this._renderer.renderPassId);t&&(t.reverseCulling=e)}get objectRenderer(){return this._renderer}get name(){return this._name}set name(e){this._name=e,this._renderer&&(this._renderer.name=e)}get forceLayerMaskCheck(){return this._forceLayerMaskCheck}set forceLayerMaskCheck(e){e!==this._forceLayerMaskCheck&&(this._forceLayerMaskCheck=e,this._renderer.forceLayerMaskCheck=e)}constructor(e,t,i,r){super(e,t),this.depthTest=!0,this.depthWrite=!0,this.size={width:100,height:100},this.sizeIsPercentage=!0,this.samples=1,this._reverseCulling=!1,this.dontRenderWhenMaterialDepthWriteIsDisabled=!0,this.textureDescriptions=[],this._forceLayerMaskCheck=!0,this._scene=i,this._engine=this._scene.getEngine(),this._renderer=new rr(e,i,r),this._renderer.renderSprites=!1,this._renderer.renderParticles=!1,this._renderer.enableBoundingBoxRendering=!1,this._renderer.enableOutlineRendering=!1,this._renderer.disableDepthPrePass=!0,this._renderer.customIsReadyFunction=(n,a,o)=>this.dontRenderWhenMaterialDepthWriteIsDisabled&&n.material&&n.material.disableDepthWrite?!!o:n.isReady(a===0),this._renderer.onBeforeRenderingManagerRenderObservable.add(()=>{this._renderer.options.doNotChangeAspectRatio||i.updateTransformMatrix(!0)}),this.name=e,this._clearAttachmentsLayout=new Map,this._allAttachmentsLayout=[],this.outputDepthTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryViewDepthTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryNormViewDepthTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryScreenDepthTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryViewNormalTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryWorldNormalTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryLocalPositionTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryWorldPositionTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryAlbedoTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryReflectivityTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryVelocityTexture=this._frameGraph.textureManager.createDanglingHandle(),this.geometryLinearVelocityTexture=this._frameGraph.textureManager.createDanglingHandle()}get excludedSkinnedMeshFromVelocityTexture(){return si.GetConfiguration(this._renderer.renderPassId).excludedSkinnedMesh}excludeSkinnedMeshFromVelocityTexture(e){if(e.skeleton){let t=this.excludedSkinnedMeshFromVelocityTexture;t.indexOf(e)===-1&&t.push(e)}}removeExcludedSkinnedMeshFromVelocityTexture(e){let t=this.excludedSkinnedMeshFromVelocityTexture,i=t.indexOf(e);i!==-1&&t.splice(i,1)}isReady(){return this._renderer.isReadyForRendering(this._textureWidth,this._textureHeight)}record(){if(this.objectList===void 0)throw new Error(`FrameGraphGeometryRendererTask ${this.name}: object list must be provided`);this._renderer.renderList=this.objectList.meshes,this._renderer.particleSystemList=this.objectList.particleSystems;let e=this._createMultiRenderTargetTexture(),t=this._checkDepthTextureCompatibility();this._buildClearAttachmentsLayout(),this._registerForRenderPassId(this._renderer.renderPassId);let i=e.length>0?this._frameGraph.textureManager.getTextureDescription(e[0]):null;this._textureWidth=i?.size.width??0,this._textureHeight=i?.size.height??0,si.MarkAsDirty(this._renderer.renderPassId,this.objectList.meshes||this._scene.meshes);let r=this._frameGraph.addRenderPass(this.name);r.setRenderTarget(e);let n=!1;for(let o=0;o<this.textureDescriptions.length;o++){let l=this.textureDescriptions[o],c=e[o],f=si.GeometryTextureDescriptions.findIndex(u=>u.type===l.type);switch(si.GeometryTextureDescriptions[f].type){case 5:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryViewDepthTexture,c);break;case 13:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryNormViewDepthTexture,c);break;case 10:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryScreenDepthTexture,c);break;case 6:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryViewNormalTexture,c);break;case 8:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryWorldNormalTexture,c);break;case 9:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryLocalPositionTexture,c);break;case 1:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryWorldPositionTexture,c);break;case 12:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryAlbedoTexture,c);break;case 3:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryReflectivityTexture,c);break;case 2:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryVelocityTexture,c),n=!0;break;case 11:this._frameGraph.textureManager.resolveDanglingHandle(this.geometryLinearVelocityTexture,c),n=!0;break}}this._scene.needsPreviousWorldMatrices=n,r.setRenderTargetDepth(this.depthTexture),r.setExecuteFunc(o=>{this._renderer.renderList=this.objectList.meshes,this._renderer.particleSystemList=this.objectList.particleSystems,o.setDepthStates(this.depthTest&&t,this.depthWrite&&t),this._clearAttachmentsLayout.forEach((l,c)=>{o.clearColorAttachments(tte[c],l)}),o.bindAttachments(this._allAttachmentsLayout),o.render(this._renderer,this._textureWidth,this._textureHeight)});let a=this._frameGraph.addRenderPass(this.name+"_disabled",!0);a.setRenderTarget(e),a.setRenderTargetDepth(this.depthTexture),a.setExecuteFunc(o=>{})}dispose(){si.DeleteConfiguration(this._renderer.renderPassId),this._renderer.dispose(),super.dispose()}_createMultiRenderTargetTexture(){let e=[],t=[],i=[],r=[];for(let o=0;o<this.textureDescriptions.length;o++){let l=this.textureDescriptions[o],c=si.GeometryTextureDescriptions.findIndex(f=>f.type===l.type);if(c===-1)throw new Error(`FrameGraphGeometryRendererTask ${this.name}: unknown texture type ${l.type}`);e[o]=l.textureType,t[o]=l.textureFormat,i[o]=si.GeometryTextureDescriptions[c].name,r[o]=!1}let n=this._frameGraph.textureManager.createRenderTargetTexture(this.name,{size:this.size,sizeIsPercentage:this.sizeIsPercentage,options:{createMipMaps:!1,samples:this.samples,types:e,formats:t,useSRGBBuffers:r,labels:i}}),a=[];for(let o=0;o<this.textureDescriptions.length;o++)a.push(n+o);return a}_checkDepthTextureCompatibility(){let e=!1;if(this.depthTexture!==void 0){if(this.depthTexture===1)throw new Error(`FrameGraphGeometryRendererTask ${this.name}: the depth/stencil back buffer is not allowed as a depth texture`);if(this._frameGraph.textureManager.getTextureDescription(this.depthTexture).options.samples!==this.samples&&this.textureDescriptions.length>0)throw new Error(`FrameGraphGeometryRendererTask ${this.name}: the depth texture and the output texture must have the same number of samples`);this._frameGraph.textureManager.resolveDanglingHandle(this.outputDepthTexture,this.depthTexture),e=!0}return e}_buildClearAttachmentsLayout(){let e=new Map,t=[];for(let i=0;i<this.textureDescriptions.length;i++){let r=this.textureDescriptions[i],n=si.GeometryTextureDescriptions.findIndex(l=>l.type===r.type),a=si.GeometryTextureDescriptions[n],o=e.get(a.clearType);if(o===void 0){o=[],e.set(a.clearType,o);for(let l=0;l<i;l++)o[l]=!1}e.forEach((l,c)=>{l.push(c===a.clearType)}),t.push(!0)}this._clearAttachmentsLayout=new Map,e.forEach((i,r)=>{this._clearAttachmentsLayout.set(r,this._engine.buildTextureLayout(i))}),this._allAttachmentsLayout=this._engine.buildTextureLayout(t)}_registerForRenderPassId(e){let t=si.CreateConfiguration(e);for(let i=0;i<this.textureDescriptions.length;i++){let r=this.textureDescriptions[i],n=si.GeometryTextureDescriptions.findIndex(o=>o.type===r.type),a=si.GeometryTextureDescriptions[n];t.defines[a.defineIndex]=i}t.reverseCulling=this.reverseCulling}};Aa();Xr();we();ns();Yc();gt();ie();it();var jo=class s{getRenderCamera(e){if(this._renderCamera)return this._renderCamera;{let t;return this.originalScene.activeCameras&&this.originalScene.activeCameras.length>1?t=this.originalScene.activeCameras[this.originalScene.activeCameras.length-1]:t=this.originalScene.activeCamera,e&&t&&t.isRigCamera?t.rigParent:t}}setRenderCamera(e){this._renderCamera=e}_getSharedGizmoLight(){return this._sharedGizmoLight||(this._sharedGizmoLight=new Kn("shared gizmo light",new E(0,1,0),this.utilityLayerScene),this._sharedGizmoLight.intensity=2,this._sharedGizmoLight.groundColor=j.Gray()),this._sharedGizmoLight}static get DefaultUtilityLayer(){return s._DefaultUtilityLayer==null?s._CreateDefaultUtilityLayerFromScene(Z.LastCreatedScene):s._DefaultUtilityLayer}static _CreateDefaultUtilityLayerFromScene(e){return s._DefaultUtilityLayer=new s(e),s._DefaultUtilityLayer.originalScene.onDisposeObservable.addOnce(()=>{s._DefaultUtilityLayer=null}),s._DefaultUtilityLayer}static get DefaultKeepDepthUtilityLayer(){return s._DefaultKeepDepthUtilityLayer==null&&(s._DefaultKeepDepthUtilityLayer=new s(Z.LastCreatedScene),s._DefaultKeepDepthUtilityLayer.utilityLayerScene.autoClearDepthAndStencil=!1,s._DefaultKeepDepthUtilityLayer.originalScene.onDisposeObservable.addOnce(()=>{s._DefaultKeepDepthUtilityLayer=null})),s._DefaultKeepDepthUtilityLayer}constructor(e,t=!0,i=!1){this.originalScene=e,this.handleEvents=t,this._pointerCaptures={},this._lastPointerEvents={},this._sharedGizmoLight=null,this._renderCamera=null,this.pickUtilitySceneFirst=!0,this.shouldRender=!0,this.onlyCheckPointerDownEvents=!0,this.processAllEvents=!1,this.pickingEnabled=!0,this.onPointerOutObservable=new N,this.utilityLayerScene=new ze(e.getEngine(),{virtual:!0}),this.utilityLayerScene.useRightHandedSystem=e.useRightHandedSystem,this.utilityLayerScene._allowPostProcessClearColor=!1,this.utilityLayerScene.postProcessesEnabled=!1,this.utilityLayerScene.detachControl(),t&&(this._originalPointerObserver=e.onPrePointerObservable.add(r=>{if(!this.utilityLayerScene.activeCamera||!this.pickingEnabled||!this.processAllEvents&&r.type!==ce.POINTERMOVE&&r.type!==ce.POINTERUP&&r.type!==ce.POINTERDOWN&&r.type!==ce.POINTERDOUBLETAP)return;this.utilityLayerScene.pointerX=e.pointerX,this.utilityLayerScene.pointerY=e.pointerY;let n=r.event;if(e.isPointerCaptured(n.pointerId)){this._pointerCaptures[n.pointerId]=!1;return}let a=l=>{let c=null;if(r.nearInteractionPickingInfo)r.nearInteractionPickingInfo.pickedMesh.getScene()==l?c=r.nearInteractionPickingInfo:c=new Zi;else if(l!==this.utilityLayerScene&&r.originalPickingInfo)c=r.originalPickingInfo;else{let f=null;this._renderCamera&&(f=l._activeCamera,l._activeCamera=this._renderCamera,r.ray=null),c=r.ray?l.pickWithRay(r.ray):l.pick(e.pointerX,e.pointerY),f&&(l._activeCamera=f)}return c},o=a(this.utilityLayerScene);if(!r.ray&&o&&(r.ray=o.ray),r.originalPickingInfo?.aimTransform&&o&&(o.aimTransform=r.originalPickingInfo.aimTransform,o.gripTransform=r.originalPickingInfo.gripTransform),this.utilityLayerScene.onPrePointerObservable.notifyObservers(r),this.onlyCheckPointerDownEvents&&r.type!=ce.POINTERDOWN){r.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new nr(r.type,r.event,o),r.type),r.type===ce.POINTERUP&&this._pointerCaptures[n.pointerId]&&(this._pointerCaptures[n.pointerId]=!1);return}if(this.utilityLayerScene.autoClearDepthAndStencil||this.pickUtilitySceneFirst)o&&o.hit&&(r.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new nr(r.type,r.event,o),r.type),r.skipOnPointerObservable=!0);else{let l=a(e),c=r.event;l&&o&&(o.distance===0&&l.pickedMesh?this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(l.pickedMesh)?(this._notifyObservers(r,l,c),r.skipOnPointerObservable=!0):r.type===ce.POINTERDOWN?(this._pointerCaptures[c.pointerId]=!0,this._notifyObservers(r,l,c)):(r.type===ce.POINTERMOVE||r.type===ce.POINTERUP)&&(this._lastPointerEvents[c.pointerId]&&(this.onPointerOutObservable.notifyObservers(c.pointerId),delete this._lastPointerEvents[c.pointerId]),this._notifyObservers(r,l,c)):!this._pointerCaptures[c.pointerId]&&(o.distance<l.distance||l.distance===0)?(this._notifyObservers(r,o,c),r.skipOnPointerObservable||(r.skipOnPointerObservable=o.distance>0)):!this._pointerCaptures[c.pointerId]&&o.distance>=l.distance&&(this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(l.pickedMesh)?(this._notifyObservers(r,l,c),r.skipOnPointerObservable=!0):((r.type===ce.POINTERMOVE||r.type===ce.POINTERUP)&&this._lastPointerEvents[c.pointerId]&&(this.onPointerOutObservable.notifyObservers(c.pointerId),delete this._lastPointerEvents[c.pointerId]),this._notifyObservers(r,o,c))),r.type===ce.POINTERUP&&this._pointerCaptures[c.pointerId]&&(this._pointerCaptures[c.pointerId]=!1))}}),this._originalPointerObserver&&e.onPrePointerObservable.makeObserverTopPriority(this._originalPointerObserver)),this.utilityLayerScene.autoClear=!1,i||(this._afterRenderObserver=this.originalScene.onAfterRenderCameraObservable.add(r=>{this.shouldRender&&r==this.getRenderCamera()&&this.render()})),this._sceneDisposeObserver=this.originalScene.onDisposeObservable.add(()=>{this.dispose()}),this._updateCamera()}_notifyObservers(e,t,i){e.skipOnPointerObservable||(this.utilityLayerScene.onPointerObservable.notifyObservers(new nr(e.type,e.event,t),e.type),this._lastPointerEvents[i.pointerId]=!0)}render(){if(this._updateCamera(),this.utilityLayerScene.activeCamera){let e=this.utilityLayerScene.activeCamera.getScene(),t=this.utilityLayerScene.activeCamera;t._scene=this.utilityLayerScene,t.leftCamera&&(t.leftCamera._scene=this.utilityLayerScene),t.rightCamera&&(t.rightCamera._scene=this.utilityLayerScene),this.utilityLayerScene.render(!1),t._scene=e,t.leftCamera&&(t.leftCamera._scene=e),t.rightCamera&&(t.rightCamera._scene=e)}}dispose(){this.onPointerOutObservable.clear(),this._afterRenderObserver&&this.originalScene.onAfterCameraRenderObservable.remove(this._afterRenderObserver),this._sceneDisposeObserver&&this.originalScene.onDisposeObservable.remove(this._sceneDisposeObserver),this._originalPointerObserver&&this.originalScene.onPrePointerObservable.remove(this._originalPointerObserver),this.utilityLayerScene.dispose()}_updateCamera(){this.utilityLayerScene.cameraToUseForPointers=this.getRenderCamera(),this.utilityLayerScene.activeCamera=this.getRenderCamera()}};jo._DefaultUtilityLayer=null;jo._DefaultKeepDepthUtilityLayer=null;var rg=class extends Wi{constructor(e,t,i,r=!0){super(e,t),this.layer=new jo(i,r,!0),this.layer.utilityLayerScene._useCurrentFrameBuffer=!0,this.outputTexture=this._frameGraph.textureManager.createDanglingHandle()}record(){if(!this.targetTexture||!this.camera)throw new Error("FrameGraphUtilityLayerRendererTask: targetTexture and camera are required");this._frameGraph.textureManager.resolveDanglingHandle(this.outputTexture,this.targetTexture);let e=this._frameGraph.addRenderPass(this.name);e.setRenderTarget(this.outputTexture),e.setExecuteFunc(i=>{this.layer.setRenderCamera(this.camera),i.render(this.layer)});let t=this._frameGraph.addRenderPass(this.name+"_disabled",!0);t.setRenderTarget(this.outputTexture),t.setExecuteFunc(i=>{})}dispose(){this.layer.dispose(),super.dispose()}};function ite(s){let e=sg.FindMainObjectRenderer(s);if(e)return e.camera;let t=s.tasks;for(let i=t.length-1;i>=0;i--){let r=t[i];if(r instanceof ig||r instanceof rg)return r.camera}return null}function rte(s){let e=s.getTasksByType(ka),t=null;for(let i=e.length-1;i>=0;--i){if(e[i].isMainObjectRenderer)return e[i];e[i].objectList.meshes&&!t&&(t=e[i])}return t}function ste(s,e=!0){let t=s.scene,i=new jo(t,e,!0);i.utilityLayerScene.activeCamera=t.activeCamera;let r=sg.FindMainCamera(t.frameGraph);!r&&t.cameras.length>0&&(r=t.cameras[0]),r&&(i.setRenderCamera(r),i.utilityLayerScene.activeCamera=r);let n=t.onAfterRenderObservable.add(()=>{i.render()});return i.utilityLayerScene.onDisposeObservable.addOnce(()=>{t.onAfterRenderObservable.remove(n)}),i}var sg={FindMainCamera:ite,FindMainObjectRenderer:rte,CreateUtilityLayerRenderer:ste};var ng=class{constructor(e,t){this._disableRenderingRefCount=0,this._currentPerformancePriorityMode=0,this._isEnabling=!1,this._enableCancelFunctions=new Map,this._disableCancelFunctions=new Map,this.showDebugLogs=!1,this._scene=e,this._engine=e.getEngine(),this._engine.isWebGPU&&(this._options={morphTargetsNumMaxInfluences:20,...t},this._engine.snapshotRenderingMode=1,this.fixMeshes(),this._onResizeObserver=this._engine.onResizeObservable.add(()=>{this._log("onResize","start"),this._fastSnapshotRenderingEnabled&&(this.disableSnapshotRendering(),this.enableSnapshotRendering()),this._log("onResize","end")}),this._scene.onBeforeRenderObservable.add(()=>{if(!this._fastSnapshotRenderingEnabled)return;for(let r of e.skeletons)r.prepare(!0);for(let r of e.meshes)if(r.infiniteDistance&&r.transferToEffect(r.computeWorldMatrix(!0)),r.skeleton&&r.transferToEffect(r.computeWorldMatrix(!0)),r.getClassName()==="GaussianSplattingMesh"&&r._postToWorker(),r.morphTargetManager&&r.subMeshes)for(let n of r.subMeshes){let a=n._drawWrapper,o=a.effect;if(o){let l=a.drawContext.buffers.LeftOver,c=o._pipelineContext?.uniformBuffer;l&&c&&c.setDataBuffer(l)&&(r.morphTargetManager._bind(o),lr(r,o),c.update())}}let i=e.activeCamera;if(e.frameGraph&&(i=sg.FindMainCamera(e.frameGraph)||i),e.spriteManagers&&i)for(let r of e.spriteManagers){let a=r.spriteRenderer;this._spriteRendererUpdateEffects(a._drawWrapperBase,a._drawWrapperDepth,i)}}))}get isReady(){return!this._isEnabling}enableSnapshotRendering(){if(!this._engine.isWebGPU||--this._disableRenderingRefCount>0)return;this._log("enableSnapshotRendering","called"),this._disableCancelFunctions.size>0&&this._log("enableSnapshotRendering",`cancelling ${this._disableCancelFunctions.size} "disable" callbacks`),this._disableCancelFunctions.forEach(t=>t()),this._disableCancelFunctions.clear(),this._isEnabling=!0,this._disableRenderingRefCount=0,this._currentPerformancePriorityMode=this._pendingCurrentPerformancePriorityMode??this._scene.performancePriority,this._pendingCurrentPerformancePriorityMode=void 0,this._scene.performancePriority=0;let e=()=>{this._enableCancelFunctions.delete(e);let t=this._engine.frameId+2;this._log("enableSnapshotRendering",`scene ready, add callbacks for frames ${t} and ${t+1}`),this._executeAtFrame(t,()=>{this._log("enableSnapshotRendering","callback #1, enable snapshot rendering at the engine level"),this._engine.snapshotRendering=!0}),this._executeAtFrame(t+1,()=>{this._log("enableSnapshotRendering","callback #2, signals that snapshot rendering helper is ready"),this._isEnabling=!1})};this._enableCancelFunctions.set(e,()=>this._scene.onReadyObservable.removeCallback(e)),this._scene.executeWhenReady(e)}disableSnapshotRendering(){if(this._engine.isWebGPU){if(this._log("disableSnapshotRendering","called"),this._disableRenderingRefCount===0&&(this._enableCancelFunctions.size>0&&this._log("disableSnapshotRendering",`cancelling ${this._enableCancelFunctions.size} "enable" callbacks`),this._enableCancelFunctions.forEach(e=>e()),this._enableCancelFunctions.clear(),this._isEnabling=!1,this._scene.performancePriority=0,this._currentPerformancePriorityMode!==0)){this._log("disableSnapshotRendering",`makes sure that the scene is rendered once in BackwardCompatible mode (code: 0) before switching to mode ${this._currentPerformancePriorityMode}`),this._pendingCurrentPerformancePriorityMode=this._currentPerformancePriorityMode;let e=()=>{this._log("disableSnapshotRendering",`scene ready, add callback for frame ${this._engine.frameId+2}`),this._executeAtFrame(this._engine.frameId+2,()=>{this._log("disableSnapshotRendering",`switching to performance priority mode ${this._pendingCurrentPerformancePriorityMode}`),this._scene.performancePriority=this._pendingCurrentPerformancePriorityMode,this._pendingCurrentPerformancePriorityMode=void 0},"whenDisabled")};this._disableCancelFunctions.set(e,()=>this._scene.onReadyObservable.removeCallback(e)),this._scene.executeWhenReady(e)}this._engine.snapshotRendering=!1,this._disableRenderingRefCount++}}fixMeshes(e){if(this._engine.isWebGPU){e=e||this._scene.meshes;for(let t of e)t.ignoreCameraMaxZ=!1,t.morphTargetManager&&(t.morphTargetManager.numMaxInfluencers=Math.min(t.morphTargetManager.numTargets,this._options.morphTargetsNumMaxInfluences))}}updateMesh(e,t=!0){if(this._fastSnapshotRenderingEnabled){if(Array.isArray(e)){for(let i of e)(!t||!this._updateInstancedMesh(i))&&i.transferToEffect(i.computeWorldMatrix());return}(!t||!this._updateInstancedMesh(e))&&e.transferToEffect(e.computeWorldMatrix())}}_updateInstancedMesh(e){if(e.hasInstances){if(e.subMeshes){let t=e;for(let i of t.subMeshes){let r=t._getInstancesRenderList(i._id);t._updateInstancedBuffers(i,r,r.parent.instancesBufferSize,this._engine)}}return!0}else if(e.isAnInstance)return!0;return!1}updateMeshesForEffectLayer(e,t=!0){if(!this._engine.isWebGPU)return;let i=e instanceof tg?e.objectRendererForLayer.objectRenderer.renderPassId:e.mainTexture.renderPassId;t?this._onBeforeRenderObserverUpdateLayer=this._scene.onBeforeRenderObservable.add(()=>{this._updateMeshMatricesForRenderPassId(i)}):this._updateMeshMatricesForRenderPassId(i)}dispose(){this._engine.isWebGPU&&(this._scene.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._scene.onBeforeRenderObservable.remove(this._onBeforeRenderObserverUpdateLayer),this._engine.onResizeObservable.remove(this._onResizeObserver))}get _fastSnapshotRenderingEnabled(){return this._engine.snapshotRendering&&this._engine.snapshotRenderingMode===1}_updateMeshMatricesForRenderPassId(e){if(!this._fastSnapshotRenderingEnabled)return;let t=this._scene.objectRenderers.find(i=>i.renderPassId===e)?.activeCamera?.getTransformationMatrix()??this._scene.getTransformMatrix();for(let i=0;i<this._scene.meshes.length;++i){let r=this._scene.meshes[i];if(r.subMeshes)for(let n=0;n<r.subMeshes.length;++n){let a=r.subMeshes[n]._getDrawWrapper(e),o=a?.effect;if(o){let l=a.drawContext.buffers.LeftOver,c=o._pipelineContext?.uniformBuffer;l&&c&&c.setDataBuffer(l)&&(o.setMatrix("viewProjection",t),o.setMatrix("world",r.computeWorldMatrix()),c.update())}}}}_spriteRendererDirectMatrixUpdate(e,t){let i=e?.effect;if(i){let r=e.drawContext.buffers.LeftOver,n=i._pipelineContext?.uniformBuffer;r&&n&&n.setDataBuffer(r)&&(i.setMatrix("view",t.getViewMatrix()),i.setMatrix("projection",t.getProjectionMatrix()),n.update())}}_spriteRendererUpdateEffects(e,t,i){this._spriteRendererDirectMatrixUpdate(e,i),this._spriteRendererDirectMatrixUpdate(t,i)}_executeAtFrame(e,t,i="whenEnabled"){let r=()=>{this._engine.frameId>=e&&(this._engine.onEndFrameObservable.remove(n),i==="whenEnabled"?this._enableCancelFunctions.delete(r):this._disableCancelFunctions.delete(r),t())},n=this._engine.onEndFrameObservable.add(r);i==="whenEnabled"?this._enableCancelFunctions.set(r,()=>this._engine.onEndFrameObservable.remove(n)):this._disableCancelFunctions.set(r,()=>this._engine.onEndFrameObservable.remove(n))}_log(e,t){this.showDebugLogs&&P.Log(`[Frame: ${this._engine.frameId}] SnapshotRenderingHelper:${e} - ${t}`)}};bR();Xr();Qo();KI();qI();QI();jI();ZI();mt();function fX(){te("EXT_lights_image_based",!0,async s=>{let{EXT_lights_image_based:e}=await Promise.resolve().then(()=>(vk(),gk));return new e(s)}),te("EXT_mesh_gpu_instancing",!0,async s=>{let{EXT_mesh_gpu_instancing:e}=await Promise.resolve().then(()=>(Ek(),Sk));return new e(s)}),te("EXT_meshopt_compression",!0,async s=>{let{EXT_meshopt_compression:e}=await Promise.resolve().then(()=>(Ak(),xk));return new e(s)}),te("EXT_texture_avif",!0,async s=>{let{EXT_texture_avif:e}=await Promise.resolve().then(()=>(bk(),Rk));return new e(s)}),te("EXT_texture_webp",!0,async s=>{let{EXT_texture_webp:e}=await Promise.resolve().then(()=>(Ik(),Ck));return new e(s)}),te("ExtrasAsMetadata",!1,async s=>{let{ExtrasAsMetadata:e}=await Promise.resolve().then(()=>(Mk(),yk));return new e(s)}),te("KHR_animation_pointer",!0,async s=>{let{KHR_animation_pointer:e}=await Promise.resolve().then(()=>(Lk(),Ok));return new e(s)}),te("KHR_draco_mesh_compression",!0,async s=>{let{KHR_draco_mesh_compression:e}=await Promise.resolve().then(()=>(Vk(),Gk));return new e(s)}),te("KHR_interactivity",!0,async s=>{let{KHR_interactivity:e}=await Promise.resolve().then(()=>(oH(),aH));return new e(s)}),te("KHR_lights_punctual",!0,async s=>{let{KHR_lights:e}=await Promise.resolve().then(()=>(fH(),cH));return new e(s)}),te("EXT_lights_ies",!0,async s=>{let{EXT_lights_ies:e}=await Promise.resolve().then(()=>(uH(),hH));return new e(s)}),te("KHR_materials_anisotropy",!0,async s=>{let{KHR_materials_anisotropy:e}=await Promise.resolve().then(()=>(pH(),dH));return new e(s)}),te("KHR_materials_clearcoat",!0,async s=>{let{KHR_materials_clearcoat:e}=await Promise.resolve().then(()=>(_H(),mH));return new e(s)}),te("EXT_materials_diffuse_roughness",!0,async s=>{let{EXT_materials_diffuse_roughness:e}=await Promise.resolve().then(()=>(vH(),gH));return new e(s)}),te("KHR_materials_diffuse_transmission",!0,async s=>{let{KHR_materials_diffuse_transmission:e}=await Promise.resolve().then(()=>(EH(),SH));return new e(s)}),te("KHR_materials_dispersion",!0,async s=>{let{KHR_materials_dispersion:e}=await Promise.resolve().then(()=>(xH(),TH));return new e(s)}),te("KHR_materials_emissive_strength",!0,async s=>{let{KHR_materials_emissive_strength:e}=await Promise.resolve().then(()=>(RH(),AH));return new e(s)}),te("KHR_materials_ior",!0,async s=>{let{KHR_materials_ior:e}=await Promise.resolve().then(()=>(CH(),bH));return new e(s)}),te("KHR_materials_iridescence",!0,async s=>{let{KHR_materials_iridescence:e}=await Promise.resolve().then(()=>(yH(),IH));return new e(s)}),te("KHR_materials_pbrSpecularGlossiness",!0,async s=>{let{KHR_materials_pbrSpecularGlossiness:e}=await Promise.resolve().then(()=>(PH(),MH));return new e(s)}),te("KHR_materials_sheen",!0,async s=>{let{KHR_materials_sheen:e}=await Promise.resolve().then(()=>(OH(),DH));return new e(s)}),te("KHR_materials_specular",!0,async s=>{let{KHR_materials_specular:e}=await Promise.resolve().then(()=>(wH(),LH));return new e(s)}),te("KHR_materials_transmission",!0,async s=>{let{KHR_materials_transmission:e}=await Promise.resolve().then(()=>(NH(),FH));return new e(s)}),te("KHR_materials_unlit",!0,async s=>{let{KHR_materials_unlit:e}=await Promise.resolve().then(()=>(UH(),BH));return new e(s)}),te("KHR_materials_variants",!0,async s=>{let{KHR_materials_variants:e}=await Promise.resolve().then(()=>(VH(),GH));return new e(s)}),te("KHR_materials_volume",!0,async s=>{let{KHR_materials_volume:e}=await Promise.resolve().then(()=>(WH(),kH));return new e(s)}),te("KHR_mesh_quantization",!0,async s=>{let{KHR_mesh_quantization:e}=await Promise.resolve().then(()=>(zH(),HH));return new e(s)}),te("KHR_texture_basisu",!0,async s=>{let{KHR_texture_basisu:e}=await Promise.resolve().then(()=>(YH(),XH));return new e(s)}),te("KHR_texture_transform",!0,async s=>{let{KHR_texture_transform:e}=await Promise.resolve().then(()=>(qH(),KH));return new e(s)}),te("KHR_xmp_json_ld",!0,async s=>{let{KHR_xmp_json_ld:e}=await Promise.resolve().then(()=>(jH(),QH));return new e(s)}),te("MSFT_audio_emitter",!0,async s=>{let{MSFT_audio_emitter:e}=await Promise.resolve().then(()=>(Qz(),qz));return new e(s)}),te("MSFT_lod",!0,async s=>{let{MSFT_lod:e}=await Promise.resolve().then(()=>(Zz(),jz));return new e(s)}),te("MSFT_minecraftMesh",!0,async s=>{let{MSFT_minecraftMesh:e}=await Promise.resolve().then(()=>($z(),Jz));return new e(s)}),te("MSFT_sRGBFactors",!0,async s=>{let{MSFT_sRGBFactors:e}=await Promise.resolve().then(()=>(tX(),eX));return new e(s)}),te("KHR_node_visibility",!0,async s=>{let{KHR_node_visibility:e}=await Promise.resolve().then(()=>(rX(),iX));return new e(s)}),te("KHR_node_hoverability",!0,async s=>{let{KHR_node_hoverability:e}=await Promise.resolve().then(()=>(oX(),aX));return new e(s)}),te("KHR_node_selectability",!0,async s=>{let{KHR_node_selectability:e}=await Promise.resolve().then(()=>(cX(),lX));return new e(s)})}function O5(){$i({...Gl,createPlugin:async s=>{let{BVHFileLoader:e}=await Promise.resolve().then(()=>(AX(),xX));return new e(s[Gl.name])}}),$i({...Zo,createPlugin:async s=>{let{GLTFFileLoader:e}=await Promise.resolve().then(()=>(Nt(),_k));return new e(s[Zo.name])}}),fX(),$i({...Vl,createPlugin:async s=>{let{OBJFileLoader:e}=await Promise.resolve().then(()=>(jX(),QX));return new e(s[Vl.name])}}),$i({...kl,createPlugin:async s=>{let{SPLATFileLoader:e}=await Promise.resolve().then(()=>(M5(),y5));return new e(s[kl.name])}}),$i({...Vu,createPlugin:async()=>{let{STLFileLoader:s}=await Promise.resolve().then(()=>(D5(),P5));return new s}})}ys();Ye();Pu();var nse=["none","normal","high"],ase=["none","standard","aces","neutral"];function l9(s){return ase.includes(s)}function ose(s){return nse.includes(s)}function HP(...s){for(let e of s)e?.throwIfAborted()}async function Q7(s,e,t){t=t??um(s);let i=await(async()=>{if(t===".hdr"){let{HDRCubeTexture:n}=await Promise.resolve().then(()=>(K6(),Y6));return()=>new n(s,e,256,!1,!0,!1,!0,void 0,void 0,void 0,!0,!0)}else{let{CubeTexture:n}=await Promise.resolve().then(()=>($I(),XV));return()=>new n(s,e,null,!1,null,null,null,void 0,!0,t,!0)}})(),r=e.useDelayedTextureLoading;try{return e.useDelayedTextureLoading=!1,i()}finally{e.useDelayedTextureLoading=r}}function lse(s,e,t,i){let r=s.blockMaterialDirtyMechanism;s.blockMaterialDirtyMechanism=!0;try{let n=BI("hdrSkyBox",{sideOrientation:fe.BACKSIDE},s),a=new et("skyBox",s);return a.imageProcessingConfiguration=new Ve,a.reflectionTexture=t,t.coordinatesMode=H.SKYBOX_MODE,a.reflectionBlur=i,n.material=a,n.isPickable=!1,n.infiniteDistance=!0,n.applyFog=!1,c9(n,e),n}finally{s.blockMaterialDirtyMechanism=r}}function c9(s,e){s?.scaling.setAll((e.maxZ-e.minZ)/2)}function cse(s){return s.flatMap(e=>AV(e.assetContainer.meshes,e.assetContainer.animationGroups[e.selectedAnimation]))}function fse(s){if(s.length===0)return null;let e=new E(Math.min(...s.map(n=>n.minimum.x)),Math.min(...s.map(n=>n.minimum.y)),Math.min(...s.map(n=>n.minimum.z))),t=new E(Math.max(...s.map(n=>n.maximum.x)),Math.max(...s.map(n=>n.maximum.y)),Math.max(...s.map(n=>n.maximum.z))),i=t.subtract(e),r=e.add(i.scale(.5));return{extents:{min:e.asArray(),max:t.asArray()},size:i.asArray(),center:r.asArray()}}function hse(s){let r=s.clone();return r.y>0&&(r.y*=-1),r.y>-.01&&(r.y=Math.min(r.y*10,-.05)),r}function aA(s){let e=cse(s);return fse(e)}function la(s){(async()=>{try{await s}catch(e){e instanceof Br||P.Error(e)}})()}async function use(s,e){await Promise.resolve().then(()=>(px(),lM));let t=s.assetContainer.scene,i=e.getForwardRay(100,e.getWorldMatrix(),e.globalPosition),r=e.globalPosition.clone(),n=1e-4,a=E.Zero(),o=t.pickWithRay(i,u=>s.assetContainer.meshes.includes(u));if(o&&o.hit)a.copyFrom(o.pickedPoint);else{let u=s.getWorldBounds(),d=u?u.center:[0,0,0],p=E.FromArray(d),m=i.direction.clone();a.copyFrom(r),n=E.Distance(r,p),m.scaleAndAddToRef(n,a)}let l=E.Zero();r.subtractToRef(a,l),o&&o.hit&&(n=l.length());let c=TC(l),f=xC(l.y,n),h=a.asArray();return{type:"world",position:h,normal:h,cameraOrbit:[c,f,n]}}var Ui={clearColor:[0,0,0,0],autoSuspendRendering:!0,environmentConfig:{intensity:1,blur:.3,rotation:0},environmentLighting:"auto",environmentSkybox:"none",cameraAutoOrbit:{enabled:!1,delay:2e3,speed:.05},animationAutoPlay:!1,animationSpeed:1,shadowConfig:{quality:"none"},postProcessing:{toneMapping:"neutral",contrast:1,exposure:1},useRightHandedSystem:!1},dse={lighting:!0,skybox:!0},fA=class{constructor(){this.screenPosition=[NaN,NaN],this.worldPosition=[NaN,NaN,NaN],this.visibility=NaN}},hA=class{constructor(e,t){this._engine=e,this._options=t,this.showDebugLogs=!1,this.onEnvironmentChanged=new N,this.onEnvironmentConfigurationChanged=new N,this.onEnvironmentError=new N,this.onShadowsConfigurationChanged=new N,this.onPostProcessingChanged=new N,this.onModelChanged=new N,this.onModelError=new N,this.onLoadingProgressChanged=new N,this.onCameraAutoOrbitChanged=new N,this.onSelectedAnimationChanged=new N,this.onAnimationSpeedChanged=new N,this.onIsAnimationPlayingChanged=new N,this.onAnimationProgressChanged=new N,this.onSelectedMaterialVariantChanged=new N,this.onHotSpotsChanged=new N,this.onCamerasAsHotSpotsChanged=new N,this._renderedLastFrame=null,this._sceneOptimizer=null,this._tempVectors=Ws(4,E.Zero),this._meshDataCache=new Map,this._renderLoopController=null,this._loadedModelsBacking=[],this._activeModelBacking=null,this._environmentSkyboxMode="none",this._environmentLightingMode="none",this._skybox=null,this._skyboxBlur=this._options?.environmentConfig?.blur??Ui.environmentConfig.blur,this._skyboxTexture=null,this._reflectionTexture=null,this._reflectionsIntensity=this._options?.environmentConfig?.intensity??Ui.environmentConfig.intensity,this._reflectionsRotation=this._options?.environmentConfig?.rotation??Ui.environmentConfig.rotation,this._light=null,this._autoSuspendRendering=this._options?.autoSuspendRendering??Ui.autoSuspendRendering,this._sceneMutated=!1,this._suspendRenderCount=0,this._isDisposed=!1,this._loadModelLock=new Ul,this._loadModelAbortController=null,this._loadEnvironmentLock=new Ul,this._loadEnvironmentAbortController=null,this._camerasAsHotSpotsAbortController=null,this._updateShadowsLock=new Ul,this._shadowsAbortController=null,this._loadOperations=new Set,this._activeAnimationObservers=[],this._animationSpeed=this._options?.animationSpeed??Ui.animationSpeed,this._camerasAsHotSpots=!1,this._hotSpots=this._options?.hotSpots??{},this._shadowQuality=this._options?.shadowConfig?.quality??Ui.shadowConfig.quality,this._shadowState={},this._defaultHardwareScalingLevel=this._lastHardwareScalingLevel=this._engine.getHardwareScalingLevel();{let r=new ze(this._engine);r.useRightHandedSystem=this._options?.useRightHandedSystem??Ui.useRightHandedSystem,this._toneMappingEnabled=r.imageProcessingConfiguration.toneMappingEnabled,this._toneMappingType=r.imageProcessingConfiguration.toneMappingType,this._contrast=r.imageProcessingConfiguration.contrast,this._exposure=r.imageProcessingConfiguration.exposure,this._imageProcessingConfigurationObserver=r.imageProcessingConfiguration.onUpdateParameters.add(()=>{let a=!1;this._toneMappingEnabled!==r.imageProcessingConfiguration.toneMappingEnabled&&(this._toneMappingEnabled=r.imageProcessingConfiguration.toneMappingEnabled,a=!0),this._toneMappingType!==r.imageProcessingConfiguration.toneMappingType&&(this._toneMappingType=r.imageProcessingConfiguration.toneMappingType,a=!0),this._contrast!==r.imageProcessingConfiguration.contrast&&(this._contrast=r.imageProcessingConfiguration.contrast,a=!0),this._exposure!==r.imageProcessingConfiguration.exposure&&(this._exposure=r.imageProcessingConfiguration.exposure,a=!0),a&&this.onPostProcessingChanged.notifyObservers()});let n=new Mt("Viewer Default Camera",0,0,1,E.Zero(),r);n.useInputToRestoreState=!1,n.useAutoRotationBehavior=!0,n.onViewMatrixChangedObservable.add(()=>{this._markSceneMutated()}),r.onClearColorChangedObservable.add(()=>{this._markSceneMutated()}),r.onPointerObservable.add(async a=>{let o=await this._pick(a.event.offsetX,a.event.offsetY);if(o?.pickedPoint){let l=o.pickedPoint.subtract(n.position).dot(n.getForwardRay().direction);n.target=n.position.add(n.getForwardRay().direction.scale(l)),n.radius=l,n.interpolateTo(void 0,void 0,void 0,o.pickedPoint)}else this.resetCamera(!0)},ce.POINTERDOUBLETAP),r.onNewCameraAddedObservable.add(a=>{this.camerasAsHotSpots&&la(this._addCameraHotSpot(a,this._camerasAsHotSpotsAbortController?.signal))}),r.onCameraRemovedObservable.add(a=>{this._removeCameraHotSpot(a)}),this._scene=r,this._camera=n}this._scene.skipFrustumClipping=!0,this._scene.skipPointerDownPicking=!0,this._scene.skipPointerUpPicking=!0,this._scene.skipPointerMovePicking=!0,this._snapshotHelper=new ng(this._scene,{morphTargetsNumMaxInfluences:30}),this._beforeRenderObserver=this._scene.onBeforeRenderObservable.add(()=>{this._snapshotHelper.updateMesh(this._scene.meshes)}),this._camera.attachControl(),this._autoRotationBehavior=this._camera.getBehaviorByName("AutoRotation"),this._reset(!1,"camera"),la(this.resetEnvironment()),this._beginRendering();let i=this;this._options?.onInitialized?.({scene:i._scene,camera:i._camera,get model(){return i._activeModel??null},suspendRendering:()=>this._suspendRendering(),markSceneMutated:()=>this._markSceneMutated(),pick:async(r,n)=>await this._pick(r,n)}),this._reset(!1,"source","environment","post-processing")}get cameraAutoOrbit(){return{enabled:this._camera.behaviors.includes(this._autoRotationBehavior),speed:this._autoRotationBehavior.idleRotationSpeed,delay:this._autoRotationBehavior.idleRotationWaitTime}}set cameraAutoOrbit(e){e.enabled!==void 0&&e.enabled!==this.cameraAutoOrbit.enabled&&(e.enabled?this._camera.addBehavior(this._autoRotationBehavior):this._camera.removeBehavior(this._autoRotationBehavior)),e.delay!==void 0&&(this._autoRotationBehavior.idleRotationWaitTime=e.delay),e.speed!==void 0&&(this._autoRotationBehavior.idleRotationSpeed=e.speed),this.onCameraAutoOrbitChanged.notifyObservers()}get environmentConfig(){return{intensity:this._reflectionsIntensity,blur:this._skyboxBlur,rotation:this._reflectionsRotation}}set environmentConfig(e){e.blur!==void 0&&this._changeSkyboxBlur(e.blur),e.intensity!==void 0&&(this._changeEnvironmentIntensity(e.intensity),this._changeShadowLightIntensity()),e.rotation!==void 0&&(this._changeEnvironmentRotation(e.rotation),this._rotateShadowLightWithEnvironment()),this.onEnvironmentConfigurationChanged.notifyObservers()}get shadowConfig(){return{quality:this._shadowQuality}}async updateShadows(e){e.quality&&this._shadowQuality!==e.quality&&(this._shadowQuality=e.quality,await this._updateShadows(),this.onShadowsConfigurationChanged.notifyObservers())}_changeSkyboxBlur(e){if(e!==this._skyboxBlur&&(this._skyboxBlur=e,this._skybox)){let t=this._skybox.material;t instanceof et&&(this._snapshotHelper.disableSnapshotRendering(),t.reflectionBlur=this._skyboxBlur,this._snapshotHelper.enableSnapshotRendering(),this._markSceneMutated())}}_changeEnvironmentRotation(e){e!==this._reflectionsRotation&&(this._reflectionsRotation=e,this._snapshotHelper.disableSnapshotRendering(),this._skyboxTexture&&(this._skyboxTexture.rotationY=this._reflectionsRotation),this._reflectionTexture&&(this._reflectionTexture.rotationY=this._reflectionsRotation),this._snapshotHelper.enableSnapshotRendering(),this._markSceneMutated())}_changeEnvironmentIntensity(e){e!==this._reflectionsIntensity&&(this._reflectionsIntensity=e,this._snapshotHelper.disableSnapshotRendering(),this._skyboxTexture&&(this._skyboxTexture.level=this._reflectionsIntensity),this._reflectionTexture&&(this._reflectionTexture.level=this._reflectionsIntensity),this._snapshotHelper.enableSnapshotRendering(),this._markSceneMutated())}_updateAutoClear(){this._scene.autoClear=!0,this._markSceneMutated()}get postProcessing(){let e="none";if(this._toneMappingEnabled)switch(this._toneMappingType){case Ve.TONEMAPPING_STANDARD:e="standard";break;case Ve.TONEMAPPING_ACES:e="aces";break;case Ve.TONEMAPPING_KHR_PBR_NEUTRAL:e="neutral";break}return{toneMapping:e,contrast:this._contrast,exposure:this._exposure}}set postProcessing(e){if(this._snapshotHelper.disableSnapshotRendering(),e.toneMapping!==void 0)if(e.toneMapping==="none")this._scene.imageProcessingConfiguration.toneMappingEnabled=!1;else{switch(e.toneMapping){case"standard":this._scene.imageProcessingConfiguration.toneMappingType=Ve.TONEMAPPING_STANDARD;break;case"aces":this._scene.imageProcessingConfiguration.toneMappingType=Ve.TONEMAPPING_ACES;break;case"neutral":this._scene.imageProcessingConfiguration.toneMappingType=Ve.TONEMAPPING_KHR_PBR_NEUTRAL;break}this._scene.imageProcessingConfiguration.toneMappingEnabled=!0}e.contrast!==void 0&&(this._scene.imageProcessingConfiguration.contrast=e.contrast),e.exposure!==void 0&&(this._scene.imageProcessingConfiguration.exposure=e.exposure),this._scene.imageProcessingConfiguration.isEnabled=this._toneMappingEnabled||this._contrast!==1||this._exposure!==1,this._snapshotHelper.enableSnapshotRendering(),this._markSceneMutated()}get loadingProgress(){if(this._loadOperations.size>0){let e=0;for(let t of this._loadOperations){if(t.progress==null)return!0;e+=t.progress}return e/this._loadOperations.size}return!1}get _loadedModels(){return this._loadedModelsBacking}get _activeModel(){return this._activeModelBacking}_setActiveModel(...e){let[t,i]=e;t!==this._activeModelBacking&&(this._activeModelBacking=t,this._updateLight(),la(this._updateShadows()),this._applyAnimationSpeed(),this._selectAnimation(0,!1),this.onSelectedMaterialVariantChanged.notifyObservers(),this._reframeCamera(!0,t?[t]:void 0),this.onModelChanged.notifyObservers(i?.source??null))}get animations(){return this._activeModel?.assetContainer.animationGroups.map(e=>e.name)??[]}get selectedAnimation(){return this._activeModel?.selectedAnimation??-1}set selectedAnimation(e){this._selectAnimation(e,this._loadOperations.size===0)}_selectAnimation(e,t=!0){e=Math.round(Fe(e,-1,this.animations.length-1)),this._activeModel&&e!==this._activeModel.selectedAnimation&&(this._activeAnimationObservers.forEach(i=>i.remove()),this._activeAnimationObservers=[],this._activeModel.selectedAnimation=e,this._activeAnimation&&(this._activeAnimationObservers=[this._activeAnimation.onAnimationGroupPlayObservable.add(()=>{this.onIsAnimationPlayingChanged.notifyObservers()}),this._activeAnimation.onAnimationGroupPauseObservable.add(()=>{this.onIsAnimationPlayingChanged.notifyObservers()}),this._activeAnimation.onAnimationGroupEndObservable.add(()=>{this.onIsAnimationPlayingChanged.notifyObservers(),this.onAnimationProgressChanged.notifyObservers()})],this._reframeCamera(t)),this.onSelectedAnimationChanged.notifyObservers(),this.onAnimationProgressChanged.notifyObservers())}get isAnimationPlaying(){return this._activeModelBacking?._animationPlaying()??!1}get animationSpeed(){return this._animationSpeed}set animationSpeed(e){this._animationSpeed=e,this._applyAnimationSpeed(),this.onAnimationSpeedChanged.notifyObservers()}get animationProgress(){return this._activeAnimation?this._activeAnimation.getCurrentFrame()/(this._activeAnimation.to-this._activeAnimation.from):0}set animationProgress(e){this._activeAnimation&&(this._activeAnimation.goToFrame(e*(this._activeAnimation.to-this._activeAnimation.from)),this.onAnimationProgressChanged.notifyObservers(),this._autoRotationBehavior.resetLastInteractionTime(),this._markSceneMutated())}get _activeAnimation(){return this._activeModel?.assetContainer.animationGroups[this._activeModel?.selectedAnimation]??null}get materialVariants(){return this._activeModel?.materialVariantsController?.variants??[]}get selectedMaterialVariant(){return this._activeModel?.materialVariantsController?.selectedVariant??null}set selectedMaterialVariant(e){this._activeModel?.materialVariantsController&&(e||(e=this._activeModel.materialVariantsController.variants[0]),e!==this.selectedMaterialVariant&&this._activeModel.materialVariantsController.variants.includes(e)&&(this._snapshotHelper.disableSnapshotRendering(),this._activeModel.materialVariantsController.selectedVariant=e,this._snapshotHelper.enableSnapshotRendering(),this._markSceneMutated(),this.onSelectedMaterialVariantChanged.notifyObservers()))}get hotSpots(){return this._hotSpots}set hotSpots(e){this._hotSpots=e,this.onHotSpotsChanged.notifyObservers()}get camerasAsHotSpots(){return this._camerasAsHotSpots}set camerasAsHotSpots(e){this._camerasAsHotSpots!==e&&(this._camerasAsHotSpots=e,this._toggleCamerasAsHotSpots(),this.onCamerasAsHotSpotsChanged.notifyObservers())}_beginLoadOperation(){let e=this,t=null,i={get progress(){return t},set progress(r){t=r,e.onLoadingProgressChanged.notifyObservers()},dispose:()=>{e._loadOperations.delete(i),e.onLoadingProgressChanged.notifyObservers()}};return this._loadOperations.add(i),this.onLoadingProgressChanged.notifyObservers(),i}async loadModel(e,t,i){await this._updateModel(e,t,i)}async resetModel(e){await this._updateModel(void 0,void 0,e)}async _loadModel(e,t,i){this._throwIfDisposedOrAborted(i);let r=this._beginLoadOperation(),n=t?.onProgress,a=h=>{n?.(h),r.progress=h.lengthComputable?h.loaded/h.total:null};delete t?.onProgress;let o=null,l=t?.pluginOptions?.gltf?.extensionOptions?.KHR_materials_variants?.onLoaded,c=h=>{l?.(h),o=h};delete t?.pluginOptions?.gltf?.extensionOptions?.KHR_materials_variants?.onLoaded,t=Du({onProgress:a,pluginOptions:{gltf:{transparencyAsCoverage:!0,extensionOptions:{KHR_materials_variants:{onLoaded:c}}}}},t??{}),this._snapshotHelper.disableSnapshotRendering();try{let h=await xB(e,this._scene,t);RV(h.meshes.filter(_=>_ instanceof fe)),h.animationGroups.forEach(_=>{_.start(!0,this.animationSpeed),_.pause()}),h.addAllToScene(),this._snapshotHelper.fixMeshes(h.meshes);let u=-1,d=[],p=this,m={assetContainer:h,materialVariantsController:o,_animationPlaying:()=>h.animationGroups[u]?.isPlaying??!1,_shouldRender:()=>{let _=m?.assetContainer.animationGroups.some(v=>v.animatables.some(T=>T.animationStarted));return m._animationPlaying()||_},getHotSpotToRef:(_,v)=>this._getHotSpotToRef(h,_,v),dispose:()=>{this._snapshotHelper.disableSnapshotRendering(),h.meshes.forEach(v=>this._meshDataCache.delete(v)),h.dispose();let _=this._loadedModelsBacking.indexOf(m);_!==-1&&(this._loadedModelsBacking.splice(_,1),m===this._activeModel&&this._setActiveModel(null)),this._snapshotHelper.enableSnapshotRendering(),this._markSceneMutated()},getWorldBounds:(_=u)=>{let v=d[_];return v||(v=aA([m]),v&&(d[_]=v)),v},resetWorldBounds:()=>{d.length=0},get selectedAnimation(){return u},set selectedAnimation(_){let v=h.animationGroups[u],T=v?.isPlaying??!1;v&&(v.pause(),v.goToFrame(0)),u=_,v=h.animationGroups[u],la(p._updateShadows()),v&&(v.goToFrame(0),v.play(!0),T||v.pause())},makeActive:_=>{this._setActiveModel(m,_)}};return this._loadedModelsBacking.push(m),m}catch(h){throw this.onModelError.notifyObservers(h),h}finally{r.dispose(),this._snapshotHelper.enableSnapshotRendering(),this._markSceneMutated()}}async _updateModel(e,t,i){this._throwIfDisposedOrAborted(i),this._loadModelAbortController?.abort(new Br("New model is being loaded before previous model finished loading."));let r=this._loadModelAbortController=new AbortController;await this._loadModelLock.lockAsync(async()=>{HP(i,r.signal),this._activeModel?.dispose(),this._activeModelBacking=null,this.selectedAnimation=-1,e&&((await this._loadModel(e,t,r.signal)).makeActive(Object.assign({source:e,interpolateCamera:!1},t)),this._reset(!1,"camera","animation","material-variant"))}),!this._scene.environmentTexture&&this._scene.materials.some(n=>n instanceof J)&&await this.resetEnvironment({lighting:!0},i),this._startSceneOptimizer(!0)}async _updateShadows(){this._shadowsAbortController?.abort(new Br("Shadows quality is being change before previous shadows finished initializing."));let e=this._shadowsAbortController=new AbortController;await this._updateShadowsLock.lockAsync(async()=>{this._shadowQuality==="none"?this._disposeShadows():(this._reflectionTexture||await this.loadEnvironment("auto",{lighting:!0,skybox:!1}),this._shadowQuality==="normal"?await this._updateShadowMap(e.signal):this._shadowQuality==="high"&&await this._updateEnvShadow(e.signal))})}_changeShadowLightIntensity(){this._shadowState.high&&(this._shadowState.high.pipeline.resetAccumulation(),this._startIblShadowsRenderTime())}_rotateShadowLightWithEnvironment(){this._shadowQuality==="normal"&&this._shadowState.normal?this._shadowState.normal.light&&this._shadowState.normal.refreshLightPositionDirection(this._reflectionsRotation):this._shadowQuality==="high"&&this._shadowState.high&&(this._shadowState.high.pipeline?.resetAccumulation(),this._startIblShadowsRenderTime())}_startIblShadowsRenderTime(){if(this._shadowState.high){this._shadowState.high.renderTimer!=null?clearTimeout(this._shadowState.high.renderTimer):this._snapshotHelper.disableSnapshotRendering(),this._shadowState.high.shouldRender=!0;let e=()=>{this._shadowState.high&&(this._shadowState.high.shouldRender=!1,this._shadowState.high.renderTimer=null),this._snapshotHelper.enableSnapshotRendering()};this._shadowState.high.renderTimer=setTimeout(e,this._shadowState.high.pipeline.shadowRemanence*4e3)}}async _updateEnvShadow(e){let[{ShaderMaterial:t},{ShaderLanguage:i},{CreateDisc:r},{IblShadowsRenderPipeline:n}]=await Promise.all([Promise.resolve().then(()=>(NM(),q6)),Promise.resolve().then(()=>(j6(),Q6)),Promise.resolve().then(()=>(kM(),VM)),Promise.resolve().then(()=>(Z8(),j8)),Promise.resolve().then(()=>(Tx(),qie)),Promise.resolve().then(()=>(M7(),$re)),Promise.resolve().then(()=>(O7(),D7))]);this._throwIfDisposedOrAborted(e,this._loadModelAbortController?.signal,this._loadEnvironmentAbortController?.signal);let a=this._shadowState.high,o=aA(this._loadedModelsBacking);if(!o){a?.ground.setEnabled(!1),this._log("No models loaded, cannot create shadows.");return}let l=4,c=E.FromArray(o.size).length(),f=l*c,h=()=>{if(this._shadowState.high){this._snapshotHelper.disableSnapshotRendering();let{pipeline:u,groundMaterial:d,ground:p}=this._shadowState.high;d?.setVector2("renderTargetSize",new he(this._scene.getEngine().getRenderWidth(),this._scene.getEngine().getRenderHeight())),d?.setFloat("shadowOpacity",u.shadowOpacity),d?.setTexture("shadowTexture",u._getAccumulatedTexture());let m=l*u?.voxelGridSize;p?.scaling.set(m,m,m),this._snapshotHelper.enableSnapshotRendering(),this._markSceneMutated()}};if(this._snapshotHelper.disableSnapshotRendering(),!a){let u=new n("ibl shadows",this._scene,{resolutionExp:6,sampleDirections:3,ssShadowsEnabled:!0,shadowRemanence:.7,triPlanarVoxelization:!0},[this._camera]);u.toggleShadow(!1);let p=this._scene.getEngine().isWebGPU?1:0,m={attributes:["position","uv"],uniforms:["world","worldView","worldViewProjection","view","projection","renderTargetSize","shadowOpacity"],samplers:["shadowTexture"],shaderLanguage:p,extraInitializationsAsync:async()=>{p===1?await Promise.all([Promise.resolve().then(()=>(F7(),w7)),Promise.resolve().then(()=>(U7(),B7))]):await Promise.all([Promise.resolve().then(()=>(k7(),V7)),Promise.resolve().then(()=>(z7(),H7))])}},_=new t("envShadowGroundMaterial",this._scene,"envShadowGround",m);_.alphaMode=L.ALPHA_MULTIPLY,_.alpha=.99,h(),u.onShadowTextureReadyObservable.addOnce(h);let v=this._engine.onResizeObservable.add(()=>{h(),u?.resetAccumulation(),this._startIblShadowsRenderTime()});this._camera.onViewMatrixChangedObservable.add(()=>{this._startIblShadowsRenderTime()});let T=r("envShadowGround",{radius:f,tessellation:64},this._scene);T.setEnabled(!1),T.rotation.x=Math.PI/2,T.position.y=o.extents.min[1],T.material=_,a={pipeline:u,groundMaterial:_,resizeObserver:v,shouldRender:!0,ground:T}}a.pipeline.clearShadowCastingMeshes(),a.pipeline.clearShadowReceivingMaterials();for(let u of this._loadedModelsBacking){let d=u.assetContainer.meshes;for(let p of d)p instanceof fe&&(a.pipeline.addShadowCastingMesh(p),p.material&&a.pipeline.addShadowReceivingMaterial(p.material))}a.pipeline.onVoxelizationCompleteObservable.addOnce(()=>{this._snapshotHelper.disableSnapshotRendering(),h(),a.pipeline.toggleShadow(!0),a.ground.setEnabled(!0),this._snapshotHelper.enableSnapshotRendering(),this._markSceneMutated()}),a.ground.position.y=o.extents.min[1],a.pipeline.updateSceneBounds(),a.pipeline.updateVoxelization(),a.pipeline.resetAccumulation(),this._shadowState.normal?.ground.setEnabled(!1),this._startIblShadowsRenderTime(),this._shadowState.high=a,this._snapshotHelper.enableSnapshotRendering(),this._markSceneMutated()}async _findIblDominantDirection(e){return this._reflectionTexture&&e.iblSource!==this._reflectionTexture&&(e.iblSource=this._reflectionTexture,await e.renderWhenReady()),await e.findDominantDirection()}async _updateShadowMap(e){let[{CreateDisc:t},{RenderTargetTexture:i},{ShadowGenerator:r},{IblCdfGenerator:n}]=await Promise.all([Promise.resolve().then(()=>(kM(),VM)),Promise.resolve().then(()=>(Mn(),OO)),Promise.resolve().then(()=>(Qh(),cN)),Promise.resolve().then(()=>(vx(),D6)),Promise.resolve().then(()=>(AP(),H8)),Promise.resolve().then(()=>(Y7(),X7))]);this._throwIfDisposedOrAborted(e,this._loadModelAbortController?.signal,this._loadEnvironmentAbortController?.signal);let a=this._shadowState.normal,o=aA(this._loadedModelsBacking);if(!o){a?.ground.setEnabled(!1),this._log("No models loaded, cannot create shadows.");return}let l=E.FromArray(o.size).length();if(this._shadowQuality!=="normal")return;let c=a?.iblDirection.iblCdfGenerator?a?.iblDirection.iblCdfGenerator:new n(this._engine),f=await this._findIblDominantDirection(c);this._throwIfDisposedOrAborted(e,this._loadModelAbortController?.signal,this._loadEnvironmentAbortController?.signal),this._snapshotHelper.disableSnapshotRendering();let h=4096,d=l*20,p=l*3,m=f?Fe(f.length(),0,1):.5;if(!a){let _=new Yi("shadowMapDirectionalLight",E.Zero(),this._scene);_.autoUpdateExtends=!1;let v=new r(h,_);v.setDarkness(As(.8,.2,m)),v.setTransparencyShadow(!0),v.filteringQuality=r.QUALITY_HIGH,v.useBlurExponentialShadowMap=!0,v.enableSoftTransparentShadow=!0,v.bias=l/1e3,v.useKernelBlur=!0,v.blurKernel=Math.floor(As(64,8,m));let T=v.getShadowMap();T&&(T.refreshRate=i.REFRESHRATE_RENDER_ONEVERYFRAME,T.renderList=this._scene.meshes.slice());let C=new et("shadowMapGroundMaterial",this._scene);C.shadowOnly=!0,C.primaryColor=j.Black();let I=t("shadowMapGround",{radius:d,tessellation:64},this._scene);I.rotation.x=Math.PI/2,I.receiveShadows=!0,I.position.y=o.extents.min[1],I.material=C,_.includedOnlyMeshes=[I];let R=a={light:_,generator:v,ground:I,shouldRender:!0,iblDirection:{iblCdfGenerator:c,positionFactor:p,direction:f},refreshLightPositionDirection(b){let M=this.iblDirection.direction.normalizeToNew();this.light.getScene().useRightHandedSystem&&(M.z*=-1);let F=B.RotationY(b*-1);M=E.TransformCoordinates(M,F),this.light.position=M.scale(this.iblDirection.positionFactor),this.light.direction=hse(M.negate())}};await new Promise((b,M)=>{br(()=>T.isReadyForRendering(),()=>b(void 0),()=>M(new Error("Failed to get shadow map generator ready")))}),v.onAfterShadowMapRenderObservable.addOnce(()=>{R.shouldRender=!1})}a.iblDirection.direction=f,a.iblDirection.positionFactor=p,a.refreshLightPositionDirection(this._reflectionsRotation),a.light.shadowFrustumSize=l*4;for(let _ of this._loadedModelsBacking)for(let v of _.assetContainer.meshes)a.generator.addShadowCaster(v,!1),v.receiveShadows=!0;a.ground.position.y=o.extents.min[1],a.ground.scaling.set(d,d,d),this._shadowState.high?.ground.setEnabled(!1),this._shadowState.high?.pipeline.toggleShadow(!1),a.ground.setEnabled(!0),this._shadowState.normal=a,this._snapshotHelper.enableSnapshotRendering(),this._markSceneMutated()}_disposeShadows(){if(this._snapshotHelper.disableSnapshotRendering(),!this._shadowState)return;for(let i of this._loadedModelsBacking){let r=i.assetContainer.meshes,n=i.assetContainer.meshes[0];this._shadowState.normal?.generator.removeShadowCaster(n,!0),n.receiveShadows=!1;for(let a of r)a instanceof fe&&(this._shadowState.high?.pipeline.removeShadowCastingMesh(a),a.material&&this._shadowState.high?.pipeline.removeShadowReceivingMaterial(a.material))}let e=this._shadowState.high,t=this._shadowState.normal;t&&(t.generator.dispose(),t.light.dispose(),t.ground.dispose(!0,!0),t.iblDirection.iblCdfGenerator.dispose(),this._scene.removeMesh(t.ground)),e&&(e.resizeObserver.remove(),e.pipeline.dispose(),e.ground.dispose(!0,!0),this._scene.removeMesh(e.ground),e.renderTimer&&clearTimeout(e.renderTimer)),delete this._shadowState.normal,delete this._shadowState.high,this.onShadowsConfigurationChanged.clear(),this._snapshotHelper.enableSnapshotRendering(),this._markSceneMutated()}async loadEnvironment(e,t,i){await this._updateEnvironment(e,t,i)}async resetEnvironment(e,t){let i=[];if(e?.lighting&&this._scene.materials.some(r=>r instanceof J)){let r={...e,skybox:!1};e={...e,lighting:!1},i.push(this._updateEnvironment("auto",r,t))}i.push(this._updateEnvironment(void 0,e,t)),await Promise.all(i)}_setEnvironmentLighting(e){this._reflectionTexture=e,this._scene.environmentTexture=this._reflectionTexture,this._reflectionTexture.level=this.environmentConfig.intensity,this._reflectionTexture.rotationY=this.environmentConfig.rotation}_setEnvironmentSkybox(e){this._skyboxTexture=e,this._skyboxTexture.level=this.environmentConfig.intensity,this._skyboxTexture.rotationY=this.environmentConfig.rotation,this._skybox=lse(this._scene,this._camera,this._skyboxTexture,this.environmentConfig.blur),this._skybox.setEnabled(!0),this._snapshotHelper.fixMeshes([this._skybox]),this._updateAutoClear()}async _updateEnvironment(e,t=dse,i){if(this._throwIfDisposedOrAborted(i),!t.lighting&&!t.skybox)return;e=e?.trim(),e==="auto"&&(t={...t,extension:".env"}),this._loadEnvironmentAbortController?.abort(new Br("New environment is being loaded before previous environment finished loading."));let r=this._loadEnvironmentAbortController=new AbortController;await this._loadEnvironmentLock.lockAsync(async()=>{HP(i,r.signal);let n=async()=>(await Promise.resolve().then(()=>(q7(),K7))).default,a=async f=>{await new Promise((h,u)=>{let d=f.onLoadObservable.addOnce(()=>{p.remove(),h()}),p=H.OnTextureLoadErrorObservable.add(m=>{m===f&&(d.remove(),p.remove(),u(new Error("Failed to load environment texture.")))})})},o=e?e==="auto"?"auto":"url":"none";this._environmentLightingMode=t.lighting?o:this._environmentLightingMode,this._environmentSkyboxMode=t.skybox?o:this._environmentSkyboxMode;let l=this._reflectionTexture?.url,c=this._skyboxTexture?.url;this._snapshotHelper.disableSnapshotRendering();try{this._environmentLightingMode==="auto"&&this._environmentSkyboxMode==="auto"?l=c=await n():(this._environmentLightingMode!=="auto"&&t.lighting&&(l=e),this._environmentSkyboxMode!=="auto"&&t.skybox&&(c=e),this._environmentLightingMode==="auto"&&(l=c??await n()),this._environmentSkyboxMode==="auto"&&(c=l??await n()));let f=[];if(l!==this._reflectionTexture?.url&&(this._reflectionTexture?.dispose(),this._reflectionTexture=null,this._scene.environmentTexture=null,l))if(l===this._skyboxTexture?.url)this._setEnvironmentLighting(this._skyboxTexture.clone());else{let h=await Q7(l,this._scene,t.extension);f.push(a(h)),this._setEnvironmentLighting(h)}if(c!==this._skyboxTexture?.url&&(this._skybox?.dispose(void 0,!0),this._skyboxTexture=null,this._skybox=null,this._updateAutoClear(),c))if(c===this._reflectionTexture?.url)this._setEnvironmentSkybox(this._reflectionTexture.clone());else{let h=await Q7(c,this._scene,t.extension);f.push(a(h)),this._setEnvironmentSkybox(h)}await Promise.all(f),this._updateLight(),la(this._updateShadows()),this.onEnvironmentChanged.notifyObservers()}catch(f){throw this.onEnvironmentError.notifyObservers(f),f}finally{this._snapshotHelper.enableSnapshotRendering(),this._markSceneMutated()}})}toggleAnimation(){this.isAnimationPlaying?this.pauseAnimation():this.playAnimation()}playAnimation(){this._activeAnimation?.play(!0)}async pauseAnimation(){this._activeAnimation?.pause()}resetCamera(e){e==null&&(e=this.selectedAnimation!==(this._options?.selectedAnimation??0)),e?this._reframeCamera(!0):this._reset(!0,"camera")}updateCamera(e){this._reframeCameraFromBounds(!0,this._loadedModels,e.alpha??NaN,e.beta??NaN,e.radius??NaN,e.targetX??NaN,e.targetY??NaN,e.targetZ??NaN)}reset(...e){this._reset(!0,...e)}_reset(e,...t){if((t.length===0||t.includes("source"))&&la(this._updateModel(this._options?.source)),(t.length===0||t.includes("environment"))&&(this._scene.clearColor=new me(...this._options?.clearColor??Ui.clearColor),this.environmentConfig={intensity:this._options?.environmentConfig?.intensity??Ui.environmentConfig.intensity,blur:this._options?.environmentConfig?.blur??Ui.environmentConfig.blur,rotation:this._options?.environmentConfig?.rotation??Ui.environmentConfig.rotation},this._options?.environmentLighting===this._options?.environmentSkybox?la(this._updateEnvironment(this._options?.environmentLighting,{lighting:!0,skybox:!0})):(la(this._updateEnvironment(this._options?.environmentLighting,{lighting:!0})),la(this._updateEnvironment(this._options?.environmentSkybox,{skybox:!0})))),(t.length===0||t.includes("shadow"))&&(this._shadowQuality=this._options?.shadowConfig?.quality??Ui.shadowConfig.quality,la(this.updateShadows({quality:this._shadowQuality}))),(t.length===0||t.includes("animation"))&&(this.animationSpeed=this._options?.animationSpeed??Ui.animationSpeed,this.selectedAnimation=this._options?.selectedAnimation??0,this._options?.animationAutoPlay?this.playAnimation():this.pauseAnimation()),t.length===0||t.includes("camera")){let i=Number(this._options?.cameraOrbit?.[0]),r=Number(this._options?.cameraOrbit?.[1]),n=Number(this._options?.cameraOrbit?.[2]),a=Number(this._options?.cameraTarget?.[0]),o=Number(this._options?.cameraTarget?.[1]),l=Number(this._options?.cameraTarget?.[2]);this._reframeCameraFromBounds(e,this._loadedModels,isNaN(i)?void 0:i,isNaN(r)?void 0:r,isNaN(n)?void 0:n,isNaN(a)?void 0:a,isNaN(o)?void 0:o,isNaN(l)?void 0:l),this.cameraAutoOrbit={enabled:this._options?.cameraAutoOrbit?.enabled??Ui.cameraAutoOrbit.enabled,speed:this._options?.cameraAutoOrbit?.speed??Ui.cameraAutoOrbit.speed,delay:this._options?.cameraAutoOrbit?.delay??Ui.cameraAutoOrbit.delay}}(t.length===0||t.includes("post-processing"))&&(this.postProcessing={toneMapping:this._options?.postProcessing?.toneMapping??Ui.postProcessing.toneMapping,contrast:this._options?.postProcessing?.contrast??Ui.postProcessing.contrast,exposure:this._options?.postProcessing?.exposure??Ui.postProcessing.exposure}),(t.length===0||t.includes("material-variant"))&&(this.selectedMaterialVariant=this._options?.selectedMaterialVariant??null)}dispose(){this.selectedAnimation=-1,this.animationProgress=0,this._loadEnvironmentAbortController?.abort(new Br("Thew viewer is being disposed.")),this._loadModelAbortController?.abort(new Br("Thew viewer is being disposed.")),this._camerasAsHotSpotsAbortController?.abort(new Br("Thew viewer is being disposed.")),this._shadowsAbortController?.abort(new Br("Thew viewer is being disposed.")),this._renderLoopController?.dispose(),this._activeModel?.dispose(),this._loadedModelsBacking.forEach(e=>e.dispose()),this._disposeShadows(),this._scene.dispose(),this.onEnvironmentChanged.clear(),this.onEnvironmentError.clear(),this.onEnvironmentConfigurationChanged.clear(),this.onPostProcessingChanged.clear(),this.onModelChanged.clear(),this.onModelError.clear(),this.onCameraAutoOrbitChanged.clear(),this.onSelectedAnimationChanged.clear(),this.onAnimationSpeedChanged.clear(),this.onIsAnimationPlayingChanged.clear(),this.onAnimationProgressChanged.clear(),this.onSelectedMaterialVariantChanged.clear(),this.onHotSpotsChanged.clear(),this.onCamerasAsHotSpotsChanged.clear(),this.onLoadingProgressChanged.clear(),this._imageProcessingConfigurationObserver.remove(),this._beforeRenderObserver.remove(),this._isDisposed=!0}getHotSpotToRef(e,t){return this._activeModel?.getHotSpotToRef(e,t)??!1}_getHotSpotToRef(e,t,i){let r=this._tempVectors[2],n=this._tempVectors[1],a=this._tempVectors[0];if(t.type==="surface"){let h=e?.meshes[t.meshIndex];if(!h||!vV(h,t,n,r))return!1}else n.copyFromFloats(t.position[0],t.position[1],t.position[2]),r.copyFromFloats(t.normal[0],t.normal[1],t.normal[2]);let o=this._camera.viewport.width*this._engine.getRenderWidth()*this._engine.getHardwareScalingLevel(),l=this._camera.viewport.height*this._engine.getRenderHeight()*this._engine.getHardwareScalingLevel(),c=this._scene;E.ProjectToRef(n,B.IdentityReadOnly,c.getTransformMatrix(),new So(0,0,o,l),a),i.screenPosition[0]=a.x,i.screenPosition[1]=a.y,i.worldPosition[0]=n.x,i.worldPosition[1]=n.y,i.worldPosition[2]=n.z;let f=this._tempVectors[3];return f.copyFrom(this._camera.globalPosition),f.subtractInPlace(n),f.normalize(),i.visibility=E.Dot(f,r),!0}queryHotSpot(e,t){return this._queryHotSpot(e,t)!=null}focusHotSpot(e){let t=new fA,i=this._queryHotSpot(e,t);if(i){this.pauseAnimation();let r=i.cameraOrbit??[void 0,void 0,void 0];return this._camera.interpolateTo(r[0],r[1],r[2],new E(t.worldPosition[0],t.worldPosition[1],t.worldPosition[2])),!0}return!1}_queryHotSpot(e,t){let i=this.hotSpots?.[e];return i&&this.getHotSpotToRef(i,t)?i:null}async _addCameraHotSpot(e,t){if(e!==this._camera){let i=await this._createHotSpotFromCamera(e);i&&!t?.aborted&&(this.hotSpots={...this.hotSpots,[`camera-${e.name}`]:i})}}_removeCameraHotSpot(e){delete this.hotSpots[`camera-${e.name}`],this.hotSpots={...this.hotSpots}}_toggleCamerasAsHotSpots(){if(!this.camerasAsHotSpots)this._camerasAsHotSpotsAbortController?.abort(),this._camerasAsHotSpotsAbortController=null,this._scene.cameras.forEach(e=>this._removeCameraHotSpot(e));else{let e=this._camerasAsHotSpotsAbortController=new AbortController;this._scene.cameras.forEach(async t=>await this._addCameraHotSpot(t,e.signal))}}async _createHotSpotFromCamera(e){if(e instanceof Mt){let t=e.target.asArray();return{type:"world",position:t,normal:t,cameraOrbit:[e.alpha,e.beta,e.radius]}}return this._activeModel?await use(this._activeModel,e):null}get _shouldRender(){return!this._autoSuspendRendering||this._sceneMutated||!this._snapshotHelper.isReady||this._shadowState.normal?.shouldRender||this._shadowState.high?.shouldRender||this._loadedModelsBacking.some(e=>e._shouldRender())}_markSceneMutated(){this._sceneMutated=!0}_suspendRendering(){this._renderLoopController?.dispose(),this._suspendRenderCount++;let e=!1;return{dispose:()=>{e||(e=!0,this._suspendRenderCount--,this._suspendRenderCount===0&&this._beginRendering())}}}_beginRendering(){if(!this._renderLoopController){let e=!1,t=()=>{this._log("Viewer Resumed Rendering"),this._engine.setHardwareScalingLevel(this._lastHardwareScalingLevel),this._engine.performanceMonitor.enable(),this._snapshotHelper.enableSnapshotRendering(),this._startSceneOptimizer()},i=()=>{this._log("Viewer Suspended Rendering"),this._renderedLastFrame=!1,e=!1,this._lastHardwareScalingLevel=this._engine.getHardwareScalingLevel(),this._stopSceneOptimizer(),this._snapshotHelper.disableSnapshotRendering(),this._engine.performanceMonitor.disable(),this._engine.setHardwareScalingLevel(this._defaultHardwareScalingLevel),this._engine.beginFrame(),this._scene.render(),this._engine.endFrame()},r=()=>{let a=this._shouldRender;!a&&this._renderedLastFrame&&!e&&(e=this._scene.isReady(!0),a=!0),a?(this._renderedLastFrame||(this._renderedLastFrame!==null&&t(),this._renderedLastFrame=!0),this._sceneMutated=!1,this._scene.render(),this._camera.panningSensibility=5e3/this._camera.radius,this._camera.speed=this._camera.radius*.2,this.isAnimationPlaying&&(this.onAnimationProgressChanged.notifyObservers(),this._autoRotationBehavior.resetLastInteractionTime())):(this._camera.update(),this._renderedLastFrame&&i())};this._engine.runRenderLoop(r);let n=!1;this._renderLoopController={dispose:()=>{n||(n=!0,this._engine.stopRenderLoop(r),this._renderLoopController=null,this._renderedLastFrame&&i())}}}}_reframeCamera(e=!1,t=this._loadedModelsBacking){this._reframeCameraFromBounds(e,t)}_getWorldBounds(e){return aA(e)}_getCameraConfig(e){let t=1,i=E.Zero(),r=this._getWorldBounds(e);r&&(this._camera.lowerRadiusLimit=null,t=E.FromArray(r.size).length()*1.1,i=E.FromArray(r.center),isFinite(t)||(t=1,i.copyFromFloats(0,0,0)));let n=t*.001,a=t*5,o=t*.001,l=t*1e3;return{radius:t,target:i,lowerRadiusLimit:n,upperRadiusLimit:a,minZ:o,maxZ:l}}_reframeCameraFromBounds(e,t,i,r,n,a,o,l){let c=1,f=E.Zero(),h=Math.PI/2,u=Math.PI/2.4,{radius:d,target:p,lowerRadiusLimit:m,upperRadiusLimit:_,minZ:v,maxZ:T}=this._getCameraConfig(t);this._camera.lowerRadiusLimit=m,this._camera.upperRadiusLimit=_,this._camera.minZ=v,this._camera.maxZ=T,h=i??h,u=r??u,c=n??d,f.x=a??p.x,f.y=o??p.y,f.z=l??p.z,e?this._camera.interpolateTo(h,u,c,f,void 0,.1):(this._camera.stopInterpolation(),isNaN(h)||(this._camera.alpha=h),isNaN(u)||(this._camera.beta=u),isNaN(c)||(this._camera.radius=c),this._camera.setTarget(new E(isNaN(f.x)?this._camera.target.x:f.x,isNaN(f.y)?this._camera.target.y:f.y,isNaN(f.z)?this._camera.target.z:f.z),void 0,void 0,!0)),this._camera.wheelDeltaPercentage=.01,this._camera.useNaturalPinchZoom=!0,c9(this._skybox,this._camera)}_updateLight(){let e;if(this._loadedModels.length===0)e=!1;else{let t=this._loadedModels.some(a=>a.assetContainer.lights.length>0),i=!!this._reflectionTexture,r=this._loadedModels.some(a=>a.assetContainer.materials.length>0),n=this._loadedModels.some(a=>a.assetContainer.materials.some(o=>!(o instanceof J)));t?e=!1:e=!i||!r||n}e?this._light||(this._light=new Kn("defaultLight",E.Up(),this._scene)):(this._light?.dispose(),this._light=null)}_applyAnimationSpeed(){this._activeModel?.assetContainer.animationGroups.forEach(e=>e.speedRatio=this._animationSpeed)}async _pick(e,t){if(await Promise.resolve().then(()=>(px(),lM)),this._loadedModels.length>0){let i=this._loadedModelsBacking.flatMap(n=>n.assetContainer.meshes);i.forEach(n=>{let a=this._meshDataCache.get(n);a||(a={},this._meshDataCache.set(n,a)),n.refreshBoundingInfo({applyMorph:!0,applySkeleton:!0,cache:a})});let r=this._scene.pick(e,t,n=>i.includes(n));if(r.hit)return r}return null}_startSceneOptimizer(e=!1){this._stopSceneOptimizer(),e&&this._engine.setHardwareScalingLevel(this._defaultHardwareScalingLevel);let t=new Nf(60,1e3),i=new Ff(void 0,1);t.addOptimization(i),this._sceneOptimizer=new Z_(this._scene,t),this._sceneOptimizer.start()}_stopSceneOptimizer(){this._sceneOptimizer?.dispose(),this._sceneOptimizer=null}_log(e){this.showDebugLogs&&P.Log(e)}_throwIfDisposedOrAborted(...e){if(this._isDisposed)throw new Error("Viewer is disposed.");HP(...e)}};O5();var cA=globalThis,$P=cA.ShadowRoot&&(cA.ShadyCSS===void 0||cA.ShadyCSS.nativeShadow)&&"adoptedStyleSheets"in Document.prototype&&"replace"in CSSStyleSheet.prototype,eD=Symbol(),j7=new WeakMap,f9=class{constructor(e,t,i){if(this._$cssResult$=!0,i!==eD)throw Error("CSSResult is not constructable. Use `unsafeCSS` or `css` instead.");this.cssText=e,this.t=t}get styleSheet(){let e=this.o,t=this.t;if($P&&e===void 0){let i=t!==void 0&&t.length===1;i&&(e=j7.get(t)),e===void 0&&((this.o=e=new CSSStyleSheet).replaceSync(this.cssText),i&&j7.set(t,e))}return e}toString(){return this.cssText}},pse=s=>new f9(typeof s=="string"?s:s+"",void 0,eD),h9=(s,...e)=>{let t=s.length===1?s[0]:e.reduce(((i,r,n)=>i+(a=>{if(a._$cssResult$===!0)return a.cssText;if(typeof a=="number")return a;throw Error("Value passed to 'css' function must be a 'css' function result: "+a+". Use 'unsafeCSS' to pass non-literal values, but take care to ensure page security.")})(r)+s[n+1]),s[0]);return new f9(t,s,eD)},mse=(s,e)=>{if($P)s.adoptedStyleSheets=e.map((t=>t instanceof CSSStyleSheet?t:t.styleSheet));else for(let t of e){let i=document.createElement("style"),r=cA.litNonce;r!==void 0&&i.setAttribute("nonce",r),i.textContent=t.cssText,s.appendChild(i)}},Z7=$P?s=>s:s=>s instanceof CSSStyleSheet?(e=>{let t="";for(let i of e.cssRules)t+=i.cssText;return pse(t)})(s):s;var{is:_se,defineProperty:gse,getOwnPropertyDescriptor:vse,getOwnPropertyNames:Sse,getOwnPropertySymbols:Ese,getPrototypeOf:Tse}=Object,_A=globalThis,J7=_A.trustedTypes,xse=J7?J7.emptyScript:"",Ase=_A.reactiveElementPolyfillSupport,Vd=(s,e)=>s,uA={toAttribute(s,e){switch(e){case Boolean:s=s?xse:null;break;case Object:case Array:s=s==null?s:JSON.stringify(s)}return s},fromAttribute(s,e){let t=s;switch(e){case Boolean:t=s!==null;break;case Number:t=s===null?null:Number(s);break;case Object:case Array:try{t=JSON.parse(s)}catch{t=null}}return t}},tD=(s,e)=>!_se(s,e),$7={attribute:!0,type:String,converter:uA,reflect:!1,useDefault:!1,hasChanged:tD};Symbol.metadata??=Symbol("metadata"),_A.litPropertyMetadata??=new WeakMap;var vh=class extends HTMLElement{static addInitializer(e){this._$Ei(),(this.l??=[]).push(e)}static get observedAttributes(){return this.finalize(),this._$Eh&&[...this._$Eh.keys()]}static createProperty(e,t=$7){if(t.state&&(t.attribute=!1),this._$Ei(),this.prototype.hasOwnProperty(e)&&((t=Object.create(t)).wrapped=!0),this.elementProperties.set(e,t),!t.noAccessor){let i=Symbol(),r=this.getPropertyDescriptor(e,i,t);r!==void 0&&gse(this.prototype,e,r)}}static getPropertyDescriptor(e,t,i){let{get:r,set:n}=vse(this.prototype,e)??{get(){return this[t]},set(a){this[t]=a}};return{get:r,set(a){let o=r?.call(this);n?.call(this,a),this.requestUpdate(e,o,i)},configurable:!0,enumerable:!0}}static getPropertyOptions(e){return this.elementProperties.get(e)??$7}static _$Ei(){if(this.hasOwnProperty(Vd("elementProperties")))return;let e=Tse(this);e.finalize(),e.l!==void 0&&(this.l=[...e.l]),this.elementProperties=new Map(e.elementProperties)}static finalize(){if(this.hasOwnProperty(Vd("finalized")))return;if(this.finalized=!0,this._$Ei(),this.hasOwnProperty(Vd("properties"))){let t=this.properties,i=[...Sse(t),...Ese(t)];for(let r of i)this.createProperty(r,t[r])}let e=this[Symbol.metadata];if(e!==null){let t=litPropertyMetadata.get(e);if(t!==void 0)for(let[i,r]of t)this.elementProperties.set(i,r)}this._$Eh=new Map;for(let[t,i]of this.elementProperties){let r=this._$Eu(t,i);r!==void 0&&this._$Eh.set(r,t)}this.elementStyles=this.finalizeStyles(this.styles)}static finalizeStyles(e){let t=[];if(Array.isArray(e)){let i=new Set(e.flat(1/0).reverse());for(let r of i)t.unshift(Z7(r))}else e!==void 0&&t.push(Z7(e));return t}static _$Eu(e,t){let i=t.attribute;return i===!1?void 0:typeof i=="string"?i:typeof e=="string"?e.toLowerCase():void 0}constructor(){super(),this._$Ep=void 0,this.isUpdatePending=!1,this.hasUpdated=!1,this._$Em=null,this._$Ev()}_$Ev(){this._$ES=new Promise((e=>this.enableUpdating=e)),this._$AL=new Map,this._$E_(),this.requestUpdate(),this.constructor.l?.forEach((e=>e(this)))}addController(e){(this._$EO??=new Set).add(e),this.renderRoot!==void 0&&this.isConnected&&e.hostConnected?.()}removeController(e){this._$EO?.delete(e)}_$E_(){let e=new Map,t=this.constructor.elementProperties;for(let i of t.keys())this.hasOwnProperty(i)&&(e.set(i,this[i]),delete this[i]);e.size>0&&(this._$Ep=e)}createRenderRoot(){let e=this.shadowRoot??this.attachShadow(this.constructor.shadowRootOptions);return mse(e,this.constructor.elementStyles),e}connectedCallback(){this.renderRoot??=this.createRenderRoot(),this.enableUpdating(!0),this._$EO?.forEach((e=>e.hostConnected?.()))}enableUpdating(e){}disconnectedCallback(){this._$EO?.forEach((e=>e.hostDisconnected?.()))}attributeChangedCallback(e,t,i){this._$AK(e,i)}_$ET(e,t){let i=this.constructor.elementProperties.get(e),r=this.constructor._$Eu(e,i);if(r!==void 0&&i.reflect===!0){let n=(i.converter?.toAttribute!==void 0?i.converter:uA).toAttribute(t,i.type);this._$Em=e,n==null?this.removeAttribute(r):this.setAttribute(r,n),this._$Em=null}}_$AK(e,t){let i=this.constructor,r=i._$Eh.get(e);if(r!==void 0&&this._$Em!==r){let n=i.getPropertyOptions(r),a=typeof n.converter=="function"?{fromAttribute:n.converter}:n.converter?.fromAttribute!==void 0?n.converter:uA;this._$Em=r,this[r]=a.fromAttribute(t,n.type)??this._$Ej?.get(r)??null,this._$Em=null}}requestUpdate(e,t,i){if(e!==void 0){let r=this.constructor,n=this[e];if(i??=r.getPropertyOptions(e),!((i.hasChanged??tD)(n,t)||i.useDefault&&i.reflect&&n===this._$Ej?.get(e)&&!this.hasAttribute(r._$Eu(e,i))))return;this.C(e,t,i)}this.isUpdatePending===!1&&(this._$ES=this._$EP())}C(e,t,{useDefault:i,reflect:r,wrapped:n},a){i&&!(this._$Ej??=new Map).has(e)&&(this._$Ej.set(e,a??t??this[e]),n!==!0||a!==void 0)||(this._$AL.has(e)||(this.hasUpdated||i||(t=void 0),this._$AL.set(e,t)),r===!0&&this._$Em!==e&&(this._$Eq??=new Set).add(e))}async _$EP(){this.isUpdatePending=!0;try{await this._$ES}catch(t){Promise.reject(t)}let e=this.scheduleUpdate();return e!=null&&await e,!this.isUpdatePending}scheduleUpdate(){return this.performUpdate()}performUpdate(){if(!this.isUpdatePending)return;if(!this.hasUpdated){if(this.renderRoot??=this.createRenderRoot(),this._$Ep){for(let[r,n]of this._$Ep)this[r]=n;this._$Ep=void 0}let i=this.constructor.elementProperties;if(i.size>0)for(let[r,n]of i){let{wrapped:a}=n,o=this[r];a!==!0||this._$AL.has(r)||o===void 0||this.C(r,void 0,n,o)}}let e=!1,t=this._$AL;try{e=this.shouldUpdate(t),e?(this.willUpdate(t),this._$EO?.forEach((i=>i.hostUpdate?.())),this.update(t)):this._$EM()}catch(i){throw e=!1,this._$EM(),i}e&&this._$AE(t)}willUpdate(e){}_$AE(e){this._$EO?.forEach((t=>t.hostUpdated?.())),this.hasUpdated||(this.hasUpdated=!0,this.firstUpdated(e)),this.updated(e)}_$EM(){this._$AL=new Map,this.isUpdatePending=!1}get updateComplete(){return this.getUpdateComplete()}getUpdateComplete(){return this._$ES}shouldUpdate(e){return!0}update(e){this._$Eq&&=this._$Eq.forEach((t=>this._$ET(t,this[t]))),this._$EM()}updated(e){}firstUpdated(e){}};vh.elementStyles=[],vh.shadowRootOptions={mode:"open"},vh[Vd("elementProperties")]=new Map,vh[Vd("finalized")]=new Map,Ase?.({ReactiveElement:vh}),(_A.reactiveElementVersions??=[]).push("2.1.0");var iD=globalThis,dA=iD.trustedTypes,e9=dA?dA.createPolicy("lit-html",{createHTML:s=>s}):void 0,u9="$lit$",cl=`lit$${Math.random().toFixed(9).slice(2)}$`,d9="?"+cl,Rse=`<${d9}>`,uc=document,Wd=()=>uc.createComment(""),Hd=s=>s===null||typeof s!="object"&&typeof s!="function",rD=Array.isArray,bse=s=>rD(s)||typeof s?.[Symbol.iterator]=="function",zP=`[ 	
\f\r]`,Gd=/<(?:(!--|\/[^a-zA-Z])|(\/?[a-zA-Z][^>\s]*)|(\/?$))/g,t9=/-->/g,i9=/>/g,fc=RegExp(`>|${zP}(?:([^\\s"'>=/]+)(${zP}*=${zP}*(?:[^ 	
\f\r"'\`<>=]|("|')|))|$)`,"g"),r9=/'/g,s9=/"/g,p9=/^(?:script|style|textarea|title)$/i,Cse=s=>(e,...t)=>({_$litType$:s,strings:e,values:t}),Ri=Cse(1),Eh=Symbol.for("lit-noChange"),bi=Symbol.for("lit-nothing"),n9=new WeakMap,hc=uc.createTreeWalker(uc,129);function m9(s,e){if(!rD(s)||!s.hasOwnProperty("raw"))throw Error("invalid template strings array");return e9!==void 0?e9.createHTML(e):e}var Ise=(s,e)=>{let t=s.length-1,i=[],r,n=e===2?"<svg>":e===3?"<math>":"",a=Gd;for(let o=0;o<t;o++){let l=s[o],c,f,h=-1,u=0;for(;u<l.length&&(a.lastIndex=u,f=a.exec(l),f!==null);)u=a.lastIndex,a===Gd?f[1]==="!--"?a=t9:f[1]!==void 0?a=i9:f[2]!==void 0?(p9.test(f[2])&&(r=RegExp("</"+f[2],"g")),a=fc):f[3]!==void 0&&(a=fc):a===fc?f[0]===">"?(a=r??Gd,h=-1):f[1]===void 0?h=-2:(h=a.lastIndex-f[2].length,c=f[1],a=f[3]===void 0?fc:f[3]==='"'?s9:r9):a===s9||a===r9?a=fc:a===t9||a===i9?a=Gd:(a=fc,r=void 0);let d=a===fc&&s[o+1].startsWith("/>")?" ":"";n+=a===Gd?l+Rse:h>=0?(i.push(c),l.slice(0,h)+u9+l.slice(h)+cl+d):l+cl+(h===-2?o:d)}return[m9(s,n+(s[t]||"<?>")+(e===2?"</svg>":e===3?"</math>":"")),i]},zd=class s{constructor({strings:e,_$litType$:t},i){let r;this.parts=[];let n=0,a=0,o=e.length-1,l=this.parts,[c,f]=Ise(e,t);if(this.el=s.createElement(c,i),hc.currentNode=this.el.content,t===2||t===3){let h=this.el.content.firstChild;h.replaceWith(...h.childNodes)}for(;(r=hc.nextNode())!==null&&l.length<o;){if(r.nodeType===1){if(r.hasAttributes())for(let h of r.getAttributeNames())if(h.endsWith(u9)){let u=f[a++],d=r.getAttribute(h).split(cl),p=/([.?@])?(.*)/.exec(u);l.push({type:1,index:n,name:p[2],strings:d,ctor:p[1]==="."?KP:p[1]==="?"?qP:p[1]==="@"?QP:xh}),r.removeAttribute(h)}else h.startsWith(cl)&&(l.push({type:6,index:n}),r.removeAttribute(h));if(p9.test(r.tagName)){let h=r.textContent.split(cl),u=h.length-1;if(u>0){r.textContent=dA?dA.emptyScript:"";for(let d=0;d<u;d++)r.append(h[d],Wd()),hc.nextNode(),l.push({type:2,index:++n});r.append(h[u],Wd())}}}else if(r.nodeType===8)if(r.data===d9)l.push({type:2,index:n});else{let h=-1;for(;(h=r.data.indexOf(cl,h+1))!==-1;)l.push({type:7,index:n}),h+=cl.length-1}n++}}static createElement(e,t){let i=uc.createElement("template");return i.innerHTML=e,i}};function Th(s,e,t=s,i){if(e===Eh)return e;let r=i!==void 0?t._$Co?.[i]:t._$Cl,n=Hd(e)?void 0:e._$litDirective$;return r?.constructor!==n&&(r?._$AO?.(!1),n===void 0?r=void 0:(r=new n(s),r._$AT(s,t,i)),i!==void 0?(t._$Co??=[])[i]=r:t._$Cl=r),r!==void 0&&(e=Th(s,r._$AS(s,e.values),r,i)),e}var YP=class{constructor(e,t){this._$AV=[],this._$AN=void 0,this._$AD=e,this._$AM=t}get parentNode(){return this._$AM.parentNode}get _$AU(){return this._$AM._$AU}u(e){let{el:{content:t},parts:i}=this._$AD,r=(e?.creationScope??uc).importNode(t,!0);hc.currentNode=r;let n=hc.nextNode(),a=0,o=0,l=i[0];for(;l!==void 0;){if(a===l.index){let c;l.type===2?c=new Xd(n,n.nextSibling,this,e):l.type===1?c=new l.ctor(n,l.name,l.strings,this,e):l.type===6&&(c=new jP(n,this,e)),this._$AV.push(c),l=i[++o]}a!==l?.index&&(n=hc.nextNode(),a++)}return hc.currentNode=uc,r}p(e){let t=0;for(let i of this._$AV)i!==void 0&&(i.strings!==void 0?(i._$AI(e,i,t),t+=i.strings.length-2):i._$AI(e[t])),t++}},Xd=class s{get _$AU(){return this._$AM?._$AU??this._$Cv}constructor(e,t,i,r){this.type=2,this._$AH=bi,this._$AN=void 0,this._$AA=e,this._$AB=t,this._$AM=i,this.options=r,this._$Cv=r?.isConnected??!0}get parentNode(){let e=this._$AA.parentNode,t=this._$AM;return t!==void 0&&e?.nodeType===11&&(e=t.parentNode),e}get startNode(){return this._$AA}get endNode(){return this._$AB}_$AI(e,t=this){e=Th(this,e,t),Hd(e)?e===bi||e==null||e===""?(this._$AH!==bi&&this._$AR(),this._$AH=bi):e!==this._$AH&&e!==Eh&&this._(e):e._$litType$!==void 0?this.$(e):e.nodeType!==void 0?this.T(e):bse(e)?this.k(e):this._(e)}O(e){return this._$AA.parentNode.insertBefore(e,this._$AB)}T(e){this._$AH!==e&&(this._$AR(),this._$AH=this.O(e))}_(e){this._$AH!==bi&&Hd(this._$AH)?this._$AA.nextSibling.data=e:this.T(uc.createTextNode(e)),this._$AH=e}$(e){let{values:t,_$litType$:i}=e,r=typeof i=="number"?this._$AC(e):(i.el===void 0&&(i.el=zd.createElement(m9(i.h,i.h[0]),this.options)),i);if(this._$AH?._$AD===r)this._$AH.p(t);else{let n=new YP(r,this),a=n.u(this.options);n.p(t),this.T(a),this._$AH=n}}_$AC(e){let t=n9.get(e.strings);return t===void 0&&n9.set(e.strings,t=new zd(e)),t}k(e){rD(this._$AH)||(this._$AH=[],this._$AR());let t=this._$AH,i,r=0;for(let n of e)r===t.length?t.push(i=new s(this.O(Wd()),this.O(Wd()),this,this.options)):i=t[r],i._$AI(n),r++;r<t.length&&(this._$AR(i&&i._$AB.nextSibling,r),t.length=r)}_$AR(e=this._$AA.nextSibling,t){for(this._$AP?.(!1,!0,t);e&&e!==this._$AB;){let i=e.nextSibling;e.remove(),e=i}}setConnected(e){this._$AM===void 0&&(this._$Cv=e,this._$AP?.(e))}},xh=class{get tagName(){return this.element.tagName}get _$AU(){return this._$AM._$AU}constructor(e,t,i,r,n){this.type=1,this._$AH=bi,this._$AN=void 0,this.element=e,this.name=t,this._$AM=r,this.options=n,i.length>2||i[0]!==""||i[1]!==""?(this._$AH=Array(i.length-1).fill(new String),this.strings=i):this._$AH=bi}_$AI(e,t=this,i,r){let n=this.strings,a=!1;if(n===void 0)e=Th(this,e,t,0),a=!Hd(e)||e!==this._$AH&&e!==Eh,a&&(this._$AH=e);else{let o=e,l,c;for(e=n[0],l=0;l<n.length-1;l++)c=Th(this,o[i+l],t,l),c===Eh&&(c=this._$AH[l]),a||=!Hd(c)||c!==this._$AH[l],c===bi?e=bi:e!==bi&&(e+=(c??"")+n[l+1]),this._$AH[l]=c}a&&!r&&this.j(e)}j(e){e===bi?this.element.removeAttribute(this.name):this.element.setAttribute(this.name,e??"")}},KP=class extends xh{constructor(){super(...arguments),this.type=3}j(e){this.element[this.name]=e===bi?void 0:e}},qP=class extends xh{constructor(){super(...arguments),this.type=4}j(e){this.element.toggleAttribute(this.name,!!e&&e!==bi)}},QP=class extends xh{constructor(e,t,i,r,n){super(e,t,i,r,n),this.type=5}_$AI(e,t=this){if((e=Th(this,e,t,0)??bi)===Eh)return;let i=this._$AH,r=e===bi&&i!==bi||e.capture!==i.capture||e.once!==i.once||e.passive!==i.passive,n=e!==bi&&(i===bi||r);r&&this.element.removeEventListener(this.name,this,i),n&&this.element.addEventListener(this.name,this,e),this._$AH=e}handleEvent(e){typeof this._$AH=="function"?this._$AH.call(this.options?.host??this.element,e):this._$AH.handleEvent(e)}},jP=class{constructor(e,t,i){this.element=e,this.type=6,this._$AN=void 0,this._$AM=t,this.options=i}get _$AU(){return this._$AM._$AU}_$AI(e){Th(this,e)}},yse=iD.litHtmlPolyfillSupport;yse?.(zd,Xd),(iD.litHtmlVersions??=[]).push("3.3.0");var Mse=(s,e,t)=>{let i=t?.renderBefore??e,r=i._$litPart$;if(r===void 0){let n=t?.renderBefore??null;i._$litPart$=r=new Xd(e.insertBefore(Wd(),n),n,void 0,t??{})}return r._$AI(s),r};var sD=globalThis,Sh=class extends vh{constructor(){super(...arguments),this.renderOptions={host:this},this._$Do=void 0}createRenderRoot(){let e=super.createRenderRoot();return this.renderOptions.renderBefore??=e.firstChild,e}update(e){let t=this.render();this.hasUpdated||(this.renderOptions.isConnected=this.isConnected),super.update(e),this._$Do=Mse(t,this.renderRoot,this.renderOptions)}connectedCallback(){super.connectedCallback(),this._$Do?.setConnected(!0)}disconnectedCallback(){super.disconnectedCallback(),this._$Do?.setConnected(!1)}render(){return Eh}};Sh._$litElement$=!0,Sh.finalized=!0,sD.litElementHydrateSupport?.({LitElement:Sh});var Pse=sD.litElementPolyfillSupport;Pse?.({LitElement:Sh});(sD.litElementVersions??=[]).push("4.2.0");var _9=s=>(e,t)=>{t!==void 0?t.addInitializer((()=>{customElements.define(s,e)})):customElements.define(s,e)};var Dse={attribute:!0,type:String,converter:uA,reflect:!1,hasChanged:tD},Ose=(s=Dse,e,t)=>{let{kind:i,metadata:r}=t,n=globalThis.litPropertyMetadata.get(r);if(n===void 0&&globalThis.litPropertyMetadata.set(r,n=new Map),i==="setter"&&((s=Object.create(s)).wrapped=!0),n.set(t.name,s),i==="accessor"){let{name:a}=t;return{set(o){let l=e.get.call(this);e.set.call(this,o),this.requestUpdate(a,l,s)},init(o){return o!==void 0&&this.C(a,void 0,s,o),o}}}if(i==="setter"){let{name:a}=t;return function(o){let l=this[a];e.call(this,o),this.requestUpdate(a,l,s)}}throw Error("Unsupported decorator location: "+i)};function qt(s){return(e,t)=>typeof t=="object"?Ose(s,e,t):((i,r,n)=>{let a=r.hasOwnProperty(n);return r.constructor.createProperty(n,i),a?Object.getOwnPropertyDescriptor(r,n):void 0})(s,e,t)}function Yd(s){return qt({...s,state:!0,attribute:!1})}var Lse=(s,e,t)=>(t.configurable=!0,t.enumerable=!0,Reflect.decorate&&typeof e!="object"&&Object.defineProperty(s,e,t),t);function g9(s,e){return(t,i,r)=>{let n=a=>a.renderRoot?.querySelector(s)??null;return Lse(t,i,{get(){return n(this)}})}}var wse=s=>s.strings===void 0;var Fse={CHILD:2},Nse=s=>(...e)=>({_$litDirective$:s,values:e}),ZP=class{constructor(e){}get _$AU(){return this._$AM._$AU}_$AT(e,t,i){this._$Ct=e,this._$AM=t,this._$Ci=i}_$AS(e,t){return this.update(e,t)}update(e,t){return this.render(...t)}};var kd=(s,e)=>{let t=s._$AN;if(t===void 0)return!1;for(let i of t)i._$AO?.(e,!1),kd(i,e);return!0},pA=s=>{let e,t;do{if((e=s._$AM)===void 0)break;t=e._$AN,t.delete(s),s=e}while(t?.size===0)},v9=s=>{for(let e;e=s._$AM;s=e){let t=e._$AN;if(t===void 0)e._$AN=t=new Set;else if(t.has(s))break;t.add(s),Gse(e)}};function Bse(s){this._$AN!==void 0?(pA(this),this._$AM=s,v9(this)):this._$AM=s}function Use(s,e=!1,t=0){let i=this._$AH,r=this._$AN;if(r!==void 0&&r.size!==0)if(e)if(Array.isArray(i))for(let n=t;n<i.length;n++)kd(i[n],!1),pA(i[n]);else i!=null&&(kd(i,!1),pA(i));else kd(this,s)}var Gse=s=>{s.type==Fse.CHILD&&(s._$AP??=Use,s._$AQ??=Bse)},JP=class extends ZP{constructor(){super(...arguments),this._$AN=void 0}_$AT(e,t,i){super._$AT(e,t,i),v9(this),this.isConnected=e._$AU}_$AO(e,t=!0){e!==this.isConnected&&(this.isConnected=e,e?this.reconnected?.():this.disconnected?.()),t&&(kd(this,e),pA(this))}setValue(e){if(wse(this._$Ct))this._$Ct._$AI(e,this);else{let t=[...this._$Ct._$AH];t[this._$Ci]=e,this._$Ct._$AI(t,this,0)}}disconnected(){}reconnected(){}},XP=new WeakMap,Vse=Nse(class extends JP{render(s){return bi}update(s,[e]){let t=e!==this.G;return t&&this.G!==void 0&&this.rt(void 0),(t||this.lt!==this.ct)&&(this.G=e,this.ht=s.options?.host,this.rt(this.ct=s.element)),bi}rt(s){if(this.isConnected||(s=void 0),typeof this.G=="function"){let e=this.ht??globalThis,t=XP.get(e);t===void 0&&(t=new WeakMap,XP.set(e,t)),t.get(this.G)!==void 0&&this.G.call(this.ht,void 0),t.set(this.G,s),s!==void 0&&this.G.call(this.ht,s)}else this.G.value=s}get lt(){return typeof this.G=="function"?XP.get(this.ht??globalThis)?.get(this.G):this.G?.value}disconnected(){this.lt===this.ct&&this.rt(void 0)}reconnected(){this.rt(this.ct)}}),oA={antialias:!0,adaptToDeviceRatio:!0,enableAllFeatures:!0,setMaximumLimits:!0};function kse(){return"WebGL"}async function Wse(s,e={}){let t=new Qr;e=new Proxy(e,{get(o,l){switch(l){case"antialias":return o.antialias??oA.antialias;case"adaptToDeviceRatio":return o.adaptToDeviceRatio??oA.adaptToDeviceRatio;case"enableAllFeatures":return o.enableAllFeatures??oA.enableAllFeatures;case"setMaximumLimits":return o.setMaximumLimits??oA.setMaximumLimits;case"onInitialized":return c=>{o.onInitialized?.(c),t.resolve(c)};default:return o[l]}}});let i=[],r;switch(e.engine??kse()){case"WebGL":{let{Engine:o}=await Promise.resolve().then(()=>(Sa(),qO));r=new o(s,void 0,e);break}case"WebGPU":{let{WebGPUEngine:o}=await Promise.resolve().then(()=>(UP(),y7)),l=new o(s,e);await l.initAsync(),r=l;break}}if(e.onFaulted){let o=e.onFaulted,l=r.onContextLostObservable.addOnce(()=>{o(new Error("The engine context was lost."))});i.push(()=>l.remove())}let n=e?.viewerClass??hA,a=new n(r,e);{let o=await t.promise,l=!1,c=new ResizeObserver(()=>{l=!0,o.markSceneMutated()});c.observe(s),i.push(()=>c.disconnect());let f=o.scene.onBeforeRenderObservable.add(()=>{l&&(r.resize(),l=!1)});i.push(()=>f.remove());let h=null,u=new IntersectionObserver(d=>{d.length>0&&(d[d.length-1].isIntersecting?(h?.dispose(),h=null):h=o.suspendRendering())});u.observe(s),i.push(()=>u.disconnect())}return i.push(a.dispose.bind(a)),i.push(()=>r.dispose()),a.dispose=()=>i.forEach(o=>o()),a}var Hse="M5 5.27368C5 3.56682 6.82609 2.48151 8.32538 3.2973L20.687 10.0235C22.2531 10.8756 22.2531 13.124 20.687 13.9762L8.32538 20.7024C6.82609 21.5181 5 20.4328 5 18.726V5.27368Z",zse="M5.74609 3C4.7796 3 3.99609 3.7835 3.99609 4.75V19.25C3.99609 20.2165 4.7796 21 5.74609 21H9.24609C10.2126 21 10.9961 20.2165 10.9961 19.25V4.75C10.9961 3.7835 10.2126 3 9.24609 3H5.74609ZM14.7461 3C13.7796 3 12.9961 3.7835 12.9961 4.75V19.25C12.9961 20.2165 13.7796 21 14.7461 21H18.2461C19.2126 21 19.9961 20.2165 19.9961 19.25V4.75C19.9961 3.7835 19.2126 3 18.2461 3H14.7461Z",Xse="M7.20711 2.54289C7.59763 2.93342 7.59763 3.56658 7.20711 3.95711L5.41421 5.75H13.25C17.6683 5.75 21.25 9.33172 21.25 13.75C21.25 18.1683 17.6683 21.75 13.25 21.75C8.83172 21.75 5.25 18.1683 5.25 13.75C5.25 13.1977 5.69772 12.75 6.25 12.75C6.80228 12.75 7.25 13.1977 7.25 13.75C7.25 17.0637 9.93629 19.75 13.25 19.75C16.5637 19.75 19.25 17.0637 19.25 13.75C19.25 10.4363 16.5637 7.75 13.25 7.75H5.41421L7.20711 9.54289C7.59763 9.93342 7.59763 10.5666 7.20711 10.9571C6.81658 11.3476 6.18342 11.3476 5.79289 10.9571L2.29289 7.45711C1.90237 7.06658 1.90237 6.43342 2.29289 6.04289L5.79289 2.54289C6.18342 2.15237 6.81658 2.15237 7.20711 2.54289Z",Yse="M12 14C13.1046 14 14 13.1046 14 12C14 10.8954 13.1046 10 12 10C10.8954 10 10 10.8954 10 12C10 13.1046 10.8954 14 12 14ZM6 12C6 8.68629 8.68629 6 12 6C15.3137 6 18 8.68629 18 12C18 15.3137 15.3137 18 12 18C8.68629 18 6 15.3137 6 12ZM12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8ZM2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12ZM12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4Z",Kse="M5 12C5 8.13401 8.13401 5 12 5C13.32 5 14.5542 5.36484 15.608 6H15C14.4477 6 14 6.44772 14 7C14 7.55228 14.4477 8 15 8H18C18.5523 8 19 7.55228 19 7C19 6 19 5 19 4C19 3.44772 18.5523 3 18 3C17.4477 3 17 3.44772 17 4V4.51575C15.5702 3.5588 13.85 3 12 3C7.02944 3 3 7.02944 3 12C3 16.9706 7.02944 21 12 21C16.9706 21 21 16.9706 21 12C21 11.6199 20.9764 11.2448 20.9304 10.8763C20.8621 10.3282 20.3624 9.93935 19.8144 10.0077C19.2663 10.076 18.8775 10.5757 18.9458 11.1237C18.9815 11.4104 19 11.7028 19 12C19 15.866 15.866 19 12 19C8.13401 19 5 15.866 5 12Z",a9=[.5,1,1.5,2];function qse(s){if(!s)return null;let e=document.createElement("canvas");e.width=e.height=1;let t=e.getContext("2d");if(!t)throw new Error("Unable to get 2d context for parseColor");t.clearRect(0,0,1,1),t.fillStyle=s,t.fillRect(0,0,1,1);let i=t.getImageData(0,0,1,1).data;return new me(i[0]/255,i[1]/255,i[2]/255,i[3]/255)}function Qse(s){if(s==="WebGL"||s==="WebGPU")return s}function ho(s){return s==null?null:Number(s)}function lA(s){if(!s)return null;let e=s.trim().split(/\s+/);if(e.length!==3)throw new Error(`Camera orbit and target should be defined as three space separated numbers, but was specified as "${s}".`);return e.map(t=>Number(t))}function jse(s){return!s||!l9(s)?null:s}function Zse(s){return!s||!ose(s)?null:s}function Jse(s){return!s||s==="auto"?"auto":s==="reframe"?"reframe":s.trim().split(/\s+/)}var St=class extends Sh{constructor(e,t={}){super(),this._viewerClass=e,this._options=t,this._viewerLock=new Ul,this._animationSliderResizeObserver=null,this._propertyBindings=[this._createPropertyBinding("clearColor",i=>i.scene.onClearColorChangedObservable,i=>i.scene.clearColor=this.clearColor??new me(0,0,0,0),i=>this.clearColor=i.scene.clearColor),this._createPropertyBinding("skyboxBlur",i=>i.viewer.onEnvironmentConfigurationChanged,i=>i.viewer.environmentConfig={blur:this.skyboxBlur??i.viewer.environmentConfig.blur},i=>this.skyboxBlur=i.viewer.environmentConfig.blur),this._createPropertyBinding("environmentIntensity",i=>i.viewer.onEnvironmentConfigurationChanged,i=>i.viewer.environmentConfig={intensity:this.environmentIntensity??i.viewer.environmentConfig.intensity},i=>this.environmentIntensity=i.viewer.environmentConfig.intensity),this._createPropertyBinding("environmentRotation",i=>i.viewer.onEnvironmentConfigurationChanged,i=>i.viewer.environmentConfig={rotation:this.environmentRotation??i.viewer.environmentConfig.rotation},i=>this.environmentRotation=i.viewer.environmentConfig.rotation),this._createPropertyBinding("toneMapping",i=>i.viewer.onPostProcessingChanged,i=>{this.toneMapping&&(i.viewer.postProcessing={toneMapping:this.toneMapping})},i=>this.toneMapping=i.viewer.postProcessing?.toneMapping),this._createPropertyBinding("contrast",i=>i.viewer.onPostProcessingChanged,i=>i.viewer.postProcessing={contrast:this.contrast??void 0},i=>this.contrast=i.viewer.postProcessing.contrast),this._createPropertyBinding("exposure",i=>i.viewer.onPostProcessingChanged,i=>i.viewer.postProcessing={exposure:this.exposure??void 0},i=>this.exposure=i.viewer.postProcessing.exposure),this._createPropertyBinding("cameraAutoOrbit",i=>i.viewer.onCameraAutoOrbitChanged,i=>i.viewer.cameraAutoOrbit={enabled:this.cameraAutoOrbit},i=>this.cameraAutoOrbit=i.viewer.cameraAutoOrbit.enabled),this._createPropertyBinding("cameraAutoOrbitSpeed",i=>i.viewer.onCameraAutoOrbitChanged,i=>i.viewer.cameraAutoOrbit={speed:this.cameraAutoOrbitSpeed??void 0},i=>this.cameraAutoOrbitSpeed=i.viewer.cameraAutoOrbit.speed),this._createPropertyBinding("cameraAutoOrbitDelay",i=>i.viewer.onCameraAutoOrbitChanged,i=>i.viewer.cameraAutoOrbit={delay:this.cameraAutoOrbitDelay??void 0},i=>this.cameraAutoOrbitDelay=i.viewer.cameraAutoOrbit.delay),this._createPropertyBinding("animationSpeed",i=>i.viewer.onAnimationSpeedChanged,i=>i.viewer.animationSpeed=this.animationSpeed,i=>{let r=i.viewer.animationSpeed;r=a9.reduce((n,a)=>Math.abs(a-r)<Math.abs(n-r)?a:n),this.animationSpeed=r,this._dispatchCustomEvent("animationspeedchange",n=>new Event(n))}),this._createPropertyBinding("selectedAnimation",i=>i.viewer.onSelectedAnimationChanged,i=>i.viewer.selectedAnimation=this.selectedAnimation??i.viewer.selectedAnimation,i=>this.selectedAnimation=i.viewer.selectedAnimation),this._createPropertyBinding("selectedMaterialVariant",i=>i.viewer.onSelectedMaterialVariantChanged,i=>i.viewer.selectedMaterialVariant=this.selectedMaterialVariant??i.viewer.selectedMaterialVariant??"",i=>this.selectedMaterialVariant=i.viewer.selectedMaterialVariant),this._createPropertyBinding("hotSpots",i=>i.viewer.onHotSpotsChanged,i=>i.viewer.hotSpots=this.hotSpots??i.viewer.hotSpots,i=>this.hotSpots=i.viewer.hotSpots),this._createPropertyBinding("camerasAsHotSpots",i=>i.viewer.onCamerasAsHotSpotsChanged,i=>i.viewer.camerasAsHotSpots=this.camerasAsHotSpots??i.viewer.camerasAsHotSpots,i=>this.camerasAsHotSpots=i.viewer.camerasAsHotSpots)],this._isFaultedBacking=!1,this.engine=this._options.engine,this.renderWhenIdle=this._options.autoSuspendRendering===!1,this.source=this._options.source??null,this.extension=null,this.environmentLighting=this._options.environmentLighting??null,this.environmentSkybox=this._options.environmentSkybox??null,this.environmentIntensity=this._options.environmentConfig?.intensity??null,this.environmentRotation=this._options.environmentConfig?.rotation??null,this.shadowQuality=null,this._loadingProgress=!1,this.skyboxBlur=this._options.environmentConfig?.blur??null,this.toneMapping=this._options.postProcessing?.toneMapping??null,this.contrast=this._options.postProcessing?.contrast??null,this.exposure=this._options.postProcessing?.exposure??null,this.clearColor=this._options.clearColor?new me(this._options.clearColor[0],this._options.clearColor[1],this._options.clearColor[2],this._options.clearColor[3]??1):null,this.cameraAutoOrbit=this._options.cameraAutoOrbit?.enabled??!1,this.cameraAutoOrbitSpeed=this._options.cameraAutoOrbit?.speed??null,this.cameraAutoOrbitDelay=this._options.cameraAutoOrbit?.delay??null,this.hotSpots=this._options.hotSpots??{},this.animationAutoPlay=!!this._options.animationAutoPlay,this.selectedAnimation=this._options.selectedAnimation??null,this.animationSpeed=this._options.animationSpeed??1,this.animationProgress=0,this._animations=[],this._isAnimationPlaying=!1,this._showAnimationSlider=!0,this.selectedMaterialVariant=this._options.selectedMaterialVariant??null,this.camerasAsHotSpots=!1,this.resetMode="auto"}static get observedAttributes(){return[...super.observedAttributes,"camera-orbit","camera-target"]}get viewerDetails(){return this._viewerDetails}queryHotSpot(e,t){return this._viewerDetails?this._viewerDetails.viewer.queryHotSpot(e,t):!1}focusHotSpot(e){return this._viewerDetails?this._viewerDetails.viewer.focusHotSpot(e):!1}get _isFaulted(){return this._isFaultedBacking}get environment(){return{lighting:this.environmentLighting,skybox:this.environmentSkybox}}set environment(e){this.environmentLighting=e||null,this.environmentSkybox=e||null}get loadingProgress(){return this._loadingProgress}get _hasHotSpots(){return Object.keys(this.hotSpots).length>0}get animations(){return this._animations}get _hasAnimations(){return this._animations.length>0}get isAnimationPlaying(){return this._isAnimationPlaying}get materialVariants(){return this._viewerDetails?.viewer.materialVariants??[]}toggleAnimation(){this._viewerDetails?.viewer.toggleAnimation()}reset(){this._reset(this.resetMode)}_reset(e){switch(e){case"auto":this._viewerDetails?.viewer.resetCamera(void 0);break;case"reframe":this._viewerDetails?.viewer.resetCamera(!0);break;default:this._viewerDetails?.viewer.reset(...e);break}}resetCamera(){this._reset("reframe")}reload(){this._tearDownViewer(),this._setupViewer()}connectedCallback(){super.connectedCallback(),this._setupViewer()}disconnectedCallback(){super.disconnectedCallback(),this._tearDownViewer()}attributeChangedCallback(e,t,i){if(super.attributeChangedCallback(e,t,i),this.hasUpdated){if(e=="camera-orbit"){let r=lA(i);r?this._viewerDetails?.viewer.updateCamera({alpha:r[0],beta:r[1],radius:r[2]}):this._viewerDetails?.viewer.resetCamera(!1)}else if(e=="camera-target"){let r=lA(i);r?this._viewerDetails?.viewer.updateCamera({targetX:r[0],targetY:r[1],targetZ:r[2]}):this._viewerDetails?.viewer.resetCamera(!1)}}}update(e){super.update(e),this._hotSpotSelect&&(this._hotSpotSelect.value="");let t=!1;if(e.get("renderWhenIdle")!=null)t=!0;else if(e.has("engine")){let i=e.get("engine");i&&this.engine!==i&&(t=!0)}t?(this._tearDownViewer(),this._setupViewer()):(this._propertyBindings.filter(i=>e.has(i.property)).forEach(i=>i.updateViewer()),e.has("source")&&this._updateModel(),(e.has("environmentLighting")||e.has("environmentSkybox"))&&this._updateEnv({lighting:e.has("environmentLighting"),skybox:e.has("environmentSkybox")}),e.has("shadowQuality")&&this._updateShadows(this.shadowQuality))}render(){return Ri`
            <div class="full-size">
                <div id="canvasContainer" class="full-size"></div>
                ${this._renderOverlay()}
            </div>
        `}_renderProgressBar(){let e=this.loadingProgress!==!1,t=typeof this.loadingProgress=="boolean"?0:this.loadingProgress*100,i=this.loadingProgress===!0;return Ri`
            <div part="progress-bar" class="bar loading-progress-outer ${e?"":"loading-progress-outer-inactive"}" aria-label="Loading Progress">
                <div
                    class="loading-progress-inner ${i?"loading-progress-inner-indeterminate":""}"
                    style="${i?"":`width: ${t}%`}"
                ></div>
            </div>
        `}_renderToolbar(){let e=[];if(this._viewerDetails?.model!=null){this._hasAnimations&&e.push(Ri`
                    <div class="animation-timeline">
                        <button aria-label="${this.isAnimationPlaying?"Pause":"Play"}" @click="${this.toggleAnimation}">
                            ${this.isAnimationPlaying?Ri`
                                      <svg viewBox="0 0 24 24">
                                          <path d="${zse}" fill="currentColor"></path>
                                      </svg>
                                  `:Ri`
                                      <svg viewBox="0 0 24 24">
                                          <path d="${Hse}" fill="currentColor"></path>
                                      </svg>
                                  `}
                        </button>
                        <input
                            ${Vse(this._onAnimationSliderChanged)}
                            aria-label="Animation Progress"
                            class="animation-timeline-input"
                            style="${this._showAnimationSlider?"":"visibility: hidden"}"
                            type="range"
                            min="0"
                            max="1"
                            step="0.0001"
                            .value="${this.animationProgress}"
                            @input="${this._onAnimationTimelineChanged}"
                            @pointerdown="${this._onAnimationTimelinePointerDown}"
                        />
                    </div>
                    <select aria-label="Select Animation Speed" @change="${this._onAnimationSpeedChanged}">
                        ${a9.map(r=>Ri`<option value="${r}" .selected="${this.animationSpeed===r}">${r}x</option> `)}
                    </select>
                    ${this.animations.length>1?Ri`<select aria-label="Select Animation" @change="${this._onSelectedAnimationChanged}">
                              ${this.animations.map((r,n)=>Ri`<option value="${n}" .selected="${this.selectedAnimation===n}">${r}</option>`)}
                          </select>`:""}
                `),this.materialVariants.length>1&&e.push(Ri`
                    <select aria-label="Select Material Variant" @change="${this._onMaterialVariantChanged}">
                        ${this.materialVariants.map(r=>Ri`<option value="${r}" .selected="${this.selectedMaterialVariant===r}">${r}</option>`)}
                    </select>
                `),e.push(Ri`
                <button aria-label="Reset Camera Pose" @click="${this.reset}">
                    <svg viewBox="0 0 24 24">
                        <path d="${Xse}" fill="currentColor"></path>
                    </svg>
                </button>
            `),this._hasHotSpots&&e.push(Ri`
                    <div class="select-container">
                        <select id="hotSpotSelect" aria-label="Select HotSpot" @change="${this._onHotSpotsChanged}">
                            <!-- When the select is forced to be less wide than the options, padding on the right is lost. Pad with white space. -->
                            ${Object.keys(this.hotSpots).map(r=>Ri`<option value="${r}">${r}&nbsp;&nbsp;</option>`)}
                        </select>
                        <!-- This button is not actually interactive, we want input to pass through to the select below. -->
                        <button style="pointer-events: none">
                            <svg viewBox="0 0 24 24">
                                <path d="${Yse}" fill="currentColor"></path>
                            </svg>
                        </button>
                    </div>
                `);let t=e.length,i=Ri`<div class="divider"></div>`;e=e.reduce((r,n,a)=>a<t-1?[...r,n,i]:[...r,n],new Array)}return e.length>0?Ri` <div part="tool-bar" class="bar ${this._hasAnimations?"":"bar-min"} tool-bar">${e}</div>`:Ri``}_renderReloadButton(){return Ri`${this._isFaulted?Ri`
                  <button aria-label="Reload" part="reload-button" class="reload-button" @click="${this.reload}">
                      <svg viewBox="0 0 24 24">
                          <path d="${Kse}" fill="currentColor"></path>
                      </svg>
                  </button>
              `:""}`}_renderOverlay(){return Ri`
            <slot class="full-size children-slot"></slot>
            <slot name="progress-bar">${this._renderProgressBar()}</slot>
            <slot name="tool-bar">${this._renderToolbar()}</slot>
            <slot name="reload-button">${this._renderReloadButton()}</slot>
        `}_dispatchCustomEvent(e,t){this.dispatchEvent(t(e))}_onSelectedAnimationChanged(e){let t=e.target;this.selectedAnimation=Number(t.value)}_onAnimationSpeedChanged(e){let t=e.target;this.animationSpeed=Number(t.value)}_onAnimationTimelineChanged(e){if(this._viewerDetails){let t=e.target,i=Number(t.value);i!==this.animationProgress&&(this._viewerDetails.viewer.animationProgress=i)}}_onAnimationTimelinePointerDown(e){this._viewerDetails?.viewer.isAnimationPlaying&&(this._viewerDetails.viewer.pauseAnimation(),e.target.addEventListener("pointerup",()=>this._viewerDetails?.viewer.playAnimation(),{once:!0}))}_onMaterialVariantChanged(e){let t=e.target;this.selectedMaterialVariant=t.value}_onHotSpotsChanged(e){let t=e.target,i=t.value;t.value="",this.focusHotSpot(i)}_onAnimationSliderChanged(e){this._animationSliderResizeObserver?.disconnect(),e&&(this._animationSliderResizeObserver=new ResizeObserver(()=>{this._showAnimationSlider=e.clientWidth>=80}),this._animationSliderResizeObserver.observe(e))}_createPropertyBinding(e,t,i,r){return{property:e,onInitialized:n=>{t(n).add(()=>{r(n)}),i(n)},updateViewer:()=>{this._viewerDetails&&i(this._viewerDetails)}}}async _setupViewer(){await this._viewerLock.lockAsync(async()=>{if(this._canvasContainer||await this.updateComplete,this._canvasContainer&&!this._viewerDetails){let e=document.createElement("canvas");e.className="full-size canvas",e.setAttribute("touch-action","none"),this._canvasContainer.appendChild(e);{let i=new Qr,r=this,n=await this._createViewer(e,new Proxy(this._options,{get(o,l){switch(l){case"engine":return r.engine??o.engine;case"autoSuspendRendering":return!(r.hasAttribute("render-when-idle")||o.autoSuspendRendering===!1);case"source":return r.getAttribute("source")??o.source;case"environmentLighting":return r.getAttribute("environment-lighting")??r.getAttribute("environment")??o.environmentLighting;case"environmentSkybox":return r.getAttribute("environment-skybox")??r.getAttribute("environment")??o.environmentSkybox;case"environmentConfig":return{intensity:ho(r.getAttribute("environment-intensity"))??o.environmentConfig?.intensity,blur:ho(r.getAttribute("skybox-blur"))??o.environmentConfig?.blur,rotation:ho(r.getAttribute("environment-rotation"))??o.environmentConfig?.rotation};case"shadowConfig":return{quality:Zse(r.getAttribute("shadow-quality"))??o.shadowConfig?.quality};case"cameraOrbit":return lA(r.getAttribute("camera-orbit"))??o.cameraOrbit;case"cameraTarget":return lA(r.getAttribute("camera-target"))??o.cameraTarget;case"cameraAutoOrbit":return{enabled:r.hasAttribute("camera-auto-orbit")||o.cameraAutoOrbit?.enabled,speed:ho(r.getAttribute("camera-auto-orbit-speed"))??o.cameraAutoOrbit?.speed,delay:ho(r.getAttribute("camera-auto-orbit-delay"))??o.cameraAutoOrbit?.delay};case"animationAutoPlay":return r.hasAttribute("animation-auto-play")||o.animationAutoPlay;case"animationSpeed":return ho(r.getAttribute("animation-speed"))??o.animationSpeed;case"selectedAnimation":return ho(r.getAttribute("selected-animation"))??o.selectedAnimation;case"postProcessing":return{toneMapping:jse(r.getAttribute("tone-mapping"))??o.postProcessing?.toneMapping,contrast:ho(r.getAttribute("contrast"))??o.postProcessing?.contrast,exposure:ho(r.getAttribute("exposure"))??o.postProcessing?.exposure};case"selectedMaterialVariant":return r.getAttribute("material-variant")??o.selectedMaterialVariant;case"onInitialized":return c=>{o.onInitialized?.(c),i.resolve(c)};case"onFaulted":return c=>{r._isFaultedBacking=!0,o.onFaulted?.(c),r._tearDownViewer()};default:return o[l]}}})),a=await i.promise;this._viewerDetails=Object.assign(a,{viewer:n})}let t=this._viewerDetails;t.viewer.onEnvironmentChanged.add(()=>{this._dispatchCustomEvent("environmentchange",i=>new Event(i))}),t.viewer.onEnvironmentConfigurationChanged.add(()=>{this._dispatchCustomEvent("environmentconfigurationchange",i=>new Event(i))}),t.viewer.onEnvironmentError.add(i=>{this._dispatchCustomEvent("environmenterror",r=>new ErrorEvent(r,{error:i}))}),t.viewer.onShadowsConfigurationChanged.add(()=>{this._dispatchCustomEvent("shadowsconfigurationchange",i=>new Event(i))}),t.viewer.onModelChanged.add(i=>{this._animations=[...t.viewer.animations],this._dispatchCustomEvent("modelchange",r=>new CustomEvent(r,{detail:i}))}),t.viewer.onModelError.add(i=>{this._animations=[...t.viewer.animations],this._dispatchCustomEvent("modelerror",r=>new ErrorEvent(r,{error:i}))}),t.viewer.onLoadingProgressChanged.add(()=>{this._loadingProgress=t.viewer.loadingProgress,this._dispatchCustomEvent("loadingprogresschange",i=>new Event(i))}),t.viewer.onSelectedAnimationChanged.add(()=>{this._dispatchCustomEvent("selectedanimationchange",i=>new Event(i))}),t.viewer.onIsAnimationPlayingChanged.add(()=>{this._isAnimationPlaying=t.viewer.isAnimationPlaying??!1,this._dispatchCustomEvent("animationplayingchange",i=>new Event(i))}),t.viewer.onAnimationProgressChanged.add(()=>{this.animationProgress=t.viewer.animationProgress??0,this._dispatchCustomEvent("animationprogresschange",i=>new Event(i))}),t.viewer.onSelectedMaterialVariantChanged.add(()=>{this._dispatchCustomEvent("selectedmaterialvariantchange",i=>new Event(i))}),t.scene.onAfterRenderCameraObservable.add(()=>{this._dispatchCustomEvent("viewerrender",i=>new Event(i))}),this._propertyBindings.forEach(i=>i.onInitialized(t)),this._dispatchCustomEvent("viewerready",i=>new Event(i))}this._isFaultedBacking=!1})}async _createViewer(e,t){return await Wse(e,Object.assign(t,{viewerClass:this._viewerClass}))}async _tearDownViewer(){await this._viewerLock.lockAsync(async()=>{this._viewerDetails&&(this._viewerDetails.viewer.dispose(),this._viewerDetails=void 0),this._loadingProgress=!1,this._canvasContainer&&this._canvasContainer.firstElementChild&&this._canvasContainer.removeChild(this._canvasContainer.firstElementChild)})}async _updateModel(){if(this._viewerDetails)try{this.source?await this._viewerDetails.viewer.loadModel(this.source,{pluginExtension:this.extension??void 0}):await this._viewerDetails.viewer.resetModel()}catch(e){e instanceof Br||P.Error(e)}}async _updateEnv(e){if(this._viewerDetails)try{let t=[];e.lighting&&e.skybox&&this.environmentLighting===this.environmentSkybox?t.push([this.environmentLighting,{lighting:!0,skybox:!0}]):(e.lighting&&t.push([this.environmentLighting,{lighting:!0}]),e.skybox&&t.push([this.environmentSkybox,{skybox:!0}]));let i=t.map(async([r,n])=>{r?await this._viewerDetails?.viewer.loadEnvironment(r,n):await this._viewerDetails?.viewer.resetEnvironment(n)});await Promise.all(i)}catch(t){t instanceof Br||P.Error(t)}}async _updateShadows(e){if(e)try{let t={quality:e};await this._viewerDetails?.viewer.updateShadows(t)}catch(t){t instanceof Br||P.Error(t)}}};St.styles=h9`
        :host {
            --ui-foreground-color: white;
            --ui-background-hue: 233;
            --ui-background-saturation: 8%;
            --ui-background-lightness: 39%;
            --ui-background-opacity: 0.75;
            --ui-background-color: hsla(var(--ui-background-hue), var(--ui-background-saturation), var(--ui-background-lightness), var(--ui-background-opacity));
            --ui-background-color-hover: hsla(
                var(--ui-background-hue),
                var(--ui-background-saturation),
                calc(var(--ui-background-lightness) - 10%),
                calc(var(--ui-background-opacity) - 0.1)
            );
            all: inherit;
            overflow: hidden;
        }

        .full-size {
            display: block;
            position: relative;
            width: 100%;
            height: 100%;
        }

        .canvas {
            outline: none;
        }

        .children-slot {
            position: absolute;
            top: 0;
            background: transparent;
            pointer-events: none;
        }

        .reload-button {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 25%;
            transform: translate(-50%, -50%);
            color: var(--ui-foreground-color);
            background-color: var(--ui-background-color);
            border: 1px solid transparent;
            border-radius: 24px;
            padding: 0;
            cursor: pointer;
            outline: none;
        }

        .reload-button:hover {
            background-color: var(--ui-background-color-hover);
        }

        .bar {
            position: absolute;
            width: calc(100% - 24px);
            min-width: 370px;
            max-width: 1280px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--ui-background-color);
        }

        .bar-min {
            width: unset;
            min-width: unset;
            max-width: unset;
        }

        .loading-progress-outer {
            height: 4px;
            border-radius: 4px;
            border: 1px solid var(--ui-background-color);
            outline: none;
            top: 12px;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }

        .loading-progress-outer-inactive {
            opacity: 0;
            /* Set the background color to the foreground color while in the inactive state so that the color seen is correct while fading out the opacity. */
            background-color: var(--ui-foreground-color);
        }

        .loading-progress-inner {
            width: 0;
            height: 100%;
            border-radius: inherit;
            background-color: var(--ui-foreground-color);
            transition: width 0.3s linear;
        }

        /* The right side of the inner progress bar starts aligned with the left side of the outer progress bar (container).
           So, if the width is 30%, then the left side of the inner progress bar moves a total of 130% of the width of the container.
           This is why the first keyframe is at 23% ((100/130)*30).
         */
        @keyframes indeterminate {
            0% {
                left: 0%;
                width: 0%;
            }
            23% {
                left: 0%;
                width: 30%;
            }
            77% {
                left: 70%;
                width: 30%;
            }
            100% {
                left: 100%;
                width: 0%;
            }
        }

        .loading-progress-inner-indeterminate {
            position: absolute;
            animation: indeterminate 1.5s infinite;
            animation-timing-function: linear;
        }

        .tool-bar {
            display: flex;
            flex-direction: row;
            align-items: center;
            border-radius: 12px;
            border-color: var(--ui-foreground-color);
            height: 48px;
            bottom: 12px;
            color: var(--ui-foreground-color);
            -webkit-tap-highlight-color: transparent;
        }

        .tool-bar * {
            height: 100%;
            min-width: 48px;
        }

        .tool-bar .divider {
            min-width: 1px;
            margin: 0px 6px;
            height: 66%;
            background-color: var(--ui-foreground-color);
        }

        .tool-bar select {
            background: none;
            min-width: 52px;
            max-width: 128px;
            border: 1px solid transparent;
            border-radius: inherit;
            color: inherit;
            font-size: 14px;
            padding: 0px 12px;
            cursor: pointer;
            outline: none;
            appearance: none; /* Remove default styling */
            -webkit-appearance: none; /* Remove default styling for Safari */
        }

        .tool-bar .select-container {
            position: relative;
            display: flex;
            border-radius: inherit;
            border-width: 0;
            padding: 0;
        }

        .tool-bar .select-container select {
            position: absolute;
            min-width: 0;
            width: 100%;
        }

        .tool-bar .select-container button {
            position: absolute;
            border-width: 0;
        }

        .tool-bar select:hover,
        .tool-bar select:focus {
            background-color: var(--ui-background-color-hover);
        }

        .tool-bar select option {
            background-color: var(--ui-background-color);
            color: var(--ui-foreground-color);
        }

        .tool-bar select:focus-visible {
            border-color: inherit;
        }

        .tool-bar button {
            background: none;
            border: 1px solid transparent;
            border-radius: inherit;
            color: inherit;
            padding: 0;
            cursor: pointer;
            outline: none;
        }

        .tool-bar button:hover {
            background-color: var(--ui-background-color-hover);
        }

        .tool-bar button:focus-visible {
            border-color: inherit;
        }

        .tool-bar button svg {
            width: 32px;
            height: 32px;
        }

        .animation-timeline {
            display: flex;
            flex: 1;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            align-items: center;
            border-radius: inherit;
            border-color: inherit;
        }

        .animation-timeline-input {
            -webkit-appearance: none;
            cursor: pointer;
            width: 100%;
            height: 100%;
            outline: none;
            border: 1px solid transparent;
            border-radius: inherit;
            padding: 0 12px;
            background-color: transparent;
        }

        .animation-timeline-input:focus-visible {
            border-color: inherit;
        }

        /*Chrome -webkit */

        .animation-timeline-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid;
            color: var(--ui-foreground-color);
            border-radius: 50%;
            background: hsla(var(--ui-background-hue), var(--ui-background-saturation), var(--ui-background-lightness), 1);
            margin-top: -10px;
        }

        .animation-timeline-input::-webkit-slider-runnable-track {
            height: 2px;
            -webkit-appearance: none;
            background-color: var(--ui-foreground-color);
        }

        /** FireFox -moz */

        .animation-timeline-input::-moz-range-progress {
            height: 2px;
            background-color: var(--ui-foreground-color);
        }

        .animation-timeline-input::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border: 2px solid var(--ui-foreground-color);
            border-radius: 50%;
            background: hsla(var(--ui-background-hue), var(--ui-background-saturation), var(--ui-background-lightness), 1);
        }

        .animation-timeline-input::-moz-range-track {
            height: 2px;
            background: var(--ui-foreground-color);
        }
    `;x([Yd()],St.prototype,"_isFaultedBacking",void 0);x([qt({converter:Qse})],St.prototype,"engine",void 0);x([qt({attribute:"render-when-idle",type:Boolean})],St.prototype,"renderWhenIdle",void 0);x([qt()],St.prototype,"source",void 0);x([qt()],St.prototype,"extension",void 0);x([qt({hasChanged:(s,e)=>s.lighting!==e.lighting||s.skybox!==e.skybox})],St.prototype,"environment",null);x([qt({attribute:"environment-lighting"})],St.prototype,"environmentLighting",void 0);x([qt({attribute:"environment-skybox"})],St.prototype,"environmentSkybox",void 0);x([qt({type:Number,attribute:"environment-intensity"})],St.prototype,"environmentIntensity",void 0);x([qt({type:Number,attribute:"environment-rotation"})],St.prototype,"environmentRotation",void 0);x([qt({attribute:"shadow-quality"})],St.prototype,"shadowQuality",void 0);x([Yd()],St.prototype,"_loadingProgress",void 0);x([qt({attribute:"skybox-blur"})],St.prototype,"skyboxBlur",void 0);x([qt({attribute:"tone-mapping",converter:s=>!s||!l9(s)?"neutral":s})],St.prototype,"toneMapping",void 0);x([qt()],St.prototype,"contrast",void 0);x([qt()],St.prototype,"exposure",void 0);x([qt({attribute:"clear-color",converter:{fromAttribute:qse,toAttribute:s=>s?s.toHexString():null}})],St.prototype,"clearColor",void 0);x([qt({attribute:"camera-auto-orbit",type:Boolean})],St.prototype,"cameraAutoOrbit",void 0);x([qt({attribute:"camera-auto-orbit-speed",type:Number})],St.prototype,"cameraAutoOrbitSpeed",void 0);x([qt({attribute:"camera-auto-orbit-delay",type:Number})],St.prototype,"cameraAutoOrbitDelay",void 0);x([qt({attribute:"hotspots",converter:s=>s?JSON.parse(s):{}})],St.prototype,"hotSpots",void 0);x([qt({attribute:"animation-auto-play",type:Boolean})],St.prototype,"animationAutoPlay",void 0);x([qt({attribute:"selected-animation",type:Number})],St.prototype,"selectedAnimation",void 0);x([qt({attribute:"animation-speed"})],St.prototype,"animationSpeed",void 0);x([qt({attribute:!1})],St.prototype,"animationProgress",void 0);x([Yd()],St.prototype,"_animations",void 0);x([Yd()],St.prototype,"_isAnimationPlaying",void 0);x([Yd()],St.prototype,"_showAnimationSlider",void 0);x([qt({attribute:"material-variant"})],St.prototype,"selectedMaterialVariant",void 0);x([qt({attribute:"cameras-as-hotspots",type:Boolean})],St.prototype,"camerasAsHotSpots",void 0);x([qt({attribute:"reset-mode",converter:Jse})],St.prototype,"resetMode",void 0);x([g9("#canvasContainer")],St.prototype,"_canvasContainer",void 0);x([g9("#hotSpotSelect")],St.prototype,"_hotSpotSelect",void 0);var o9=class extends St{constructor(e){super(hA,e)}};o9=x([_9("babylon-viewer")],o9);var mA=class extends Sh{constructor(){super(...arguments),this._internals=this.attachInternals(),this._mutationObserver=new MutationObserver(e=>{e.some(t=>t.type==="childList")&&this._sanitizeInnerHTML()}),this._viewerAttachment=null,this._connectingAbortController=null,this._updateAnnotation=null,this.hotSpot=""}connectedCallback(){super.connectedCallback(),this._internals.states?.add("invalid"),this._connectingAbortController?.abort(),this._connectingAbortController=new AbortController;let e=this._connectingAbortController.signal;(async()=>{if(this.parentElement?.matches(":not(:defined)")&&(await customElements.whenDefined(this.parentElement?.tagName.toLowerCase()),e.aborted))return;if(!(this.parentElement instanceof St)){console.warn("The babylon-viewer-annotation element must be a child of a babylon-viewer element.");return}this._mutationObserver.observe(this,{childList:!0,characterData:!0}),this._sanitizeInnerHTML();let t=this.parentElement,i=new fA,r=this._updateAnnotation=()=>{if(this.hotSpot)if(t.queryHotSpot(this.hotSpot,i)){let[n,a]=i.screenPosition;this.style.transform=`translate(${n}px, ${a}px)`,this._internals.states?.delete("invalid"),i.visibility<=0?this._internals.states?.add("back-facing"):this._internals.states?.delete("back-facing")}else this._internals.states?.add("invalid")};this._updateAnnotation(),t.addEventListener("viewerrender",r),this._viewerAttachment={dispose(){t.removeEventListener("viewerrender",r)}}})()}disconnectedCallback(){super.disconnectedCallback(),this._connectingAbortController?.abort(),this._connectingAbortController=null,this._viewerAttachment?.dispose(),this._viewerAttachment=null,this._internals.states?.add("invalid"),this._updateAnnotation=null}render(){return Ri` <slot><div aria-label="${this.hotSpot} annotation" part="annotation" class="annotation">${this.hotSpot}</div></slot> `}update(e){super.update(e),e.has("hotSpot")&&this._updateAnnotation?.()}_sanitizeInnerHTML(){this.innerHTML.trim().length===0&&(this.innerHTML="")}};mA.styles=h9`
        :host {
            --annotation-foreground-color: black;
            --annotation-background-color: white;
            display: inline-block;
            position: absolute;
            transition: opacity 0.25s;
        }

        :host([hidden]) {
            display: none;
        }

        :host(:state(back-facing)) {
            opacity: 0.2;
        }

        :host(:state(invalid)) {
            display: none;
        }

        .annotation {
            transform: translate(-50%, -135%);
            font-size: 14px;
            padding: 0px 6px;
            border-radius: 6px;
            color: var(--annotation-foreground-color);
            background-color: var(--annotation-background-color);
        }

        .annotation::after {
            content: "";
            position: absolute;
            left: 50%;
            height: 60%;
            aspect-ratio: 1;
            transform: translate(-50%, 110%) rotate(-45deg);
            background-color: inherit;
            clip-path: polygon(0 0, 100% 100%, 0 100%, 0 0);
        }
    `;x([qt({attribute:"hotspot"})],mA.prototype,"hotSpot",void 0);mA=x([_9("babylon-viewer-annotation")],mA);
/*! Bundled license information:

@babylonjs/viewer/lib/index.js:
  (**
   * @license
   * Copyright 2019 Google LLC
   * SPDX-License-Identifier: BSD-3-Clause
   *)
  (**
   * @license
   * Copyright 2017 Google LLC
   * SPDX-License-Identifier: BSD-3-Clause
   *)
  (**
   * @license
   * Copyright 2020 Google LLC
   * SPDX-License-Identifier: BSD-3-Clause
   *)
*/
